<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEVANT 自动化推演 v1.05</title>
    <link rel="icon" href="logo.png" type="image/png"> 
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* --- 核心配色 (CSS Variables) --- */
        :root {
            /* 默认 (Terminal / Dark) */
            --bg-deep: #020408;
            --bg-panel: #0a0f18;
            --bg-sidebar: #080b12;
            --bg-header: #05080c;
            --bg-input: #05080c;
            --bg-input-focus: #0f172a;
            --bg-glass: rgba(13, 19, 30, 0.95);
            --bg-card: rgba(20, 30, 45, 0.6);
            --bg-badge: rgba(0,0,0,0.3);
            --bg-hover: rgba(255,255,255,0.05);
            
            --text-main: #e2e8f0;       
            --text-dim: #64748b;        
            --text-accent: #6366f1;     
            --text-danger: #ef4444;     
            --text-inverse: #000000;    
            
            --border-highlight: rgba(255,255,255,0.08);
            --border-dim: #1e293b;      
            
            --shadow-color: rgba(0, 0, 0, 0.6);
            --font-main: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            --font-mono: 'JetBrains Mono', 'Consolas', monospace;

            /* 边框圆角 - Terminal 默认为圆润 */
            --radius-panel: 0.75rem;
            --radius-btn: 0.25rem;
            
            /* 纹理覆盖层 (Terminal 无) */
            --texture-overlay: none;
        }

        /* 主题：报社 (Newspaper / Light) */
        [data-theme="newspaper"] {
            /* 纸张纹理背景色 */
            --bg-deep: #f2f0e9;       
            --bg-panel: #fdfbf7;      
            --bg-sidebar: #e8e6e1;    
            --bg-header: #dedcd5;     
            --bg-input: #ffffff;      
            --bg-input-focus: #fffef0;
            --bg-glass: rgba(253, 251, 247, 0.98);
            --bg-card: #ffffff;
            --bg-badge: rgba(0,0,0,0.05);
            --bg-hover: rgba(0,0,0,0.05);

            --text-main: #1a1a1a;     /* 墨色 */
            --text-dim: #555555;      
            --text-accent: #8b0000;   /* 印泥红 */
            --text-danger: #dc2626;
            --text-inverse: #ffffff;

            --border-highlight: rgba(0,0,0,0.1);
            --border-dim: #a3a3a3;    
            
            --shadow-color: rgba(0, 0, 0, 0.15);
            /* 衬线字体组合 */
            --font-main: 'Georgia', 'Songti SC', 'STSong', serif; 
            --font-mono: 'Courier New', monospace;      

            /* 边框圆角 - 报社风格为直角 */
            --radius-panel: 0px;
            --radius-btn: 0px;

            /* 纸张噪点纹理 */
            --texture-overlay: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.08'/%3E%3C/svg%3E");
        }

        body { 
            background-color: var(--bg-deep); 
            color: var(--text-main); 
            font-family: var(--font-main); 
            font-size: 16px; 
            overflow: hidden; 
            line-height: 1.6; 
            transition: background-color 0.3s, color 0.3s;
        }

        /* 纹理层 */
        .app-texture {
            position: absolute; inset: 0; pointer-events: none; z-index: 1;
            background-image: var(--texture-overlay);
            opacity: 0.6; mix-blend-mode: multiply;
        }

        /* --- 通用圆角类 (适配不同主题) --- */
        .theme-rounded { border-radius: var(--radius-panel); }
        .theme-rounded-sm { border-radius: var(--radius-btn); }
        
        /* 报社模式下的特殊边框风格 */
        [data-theme="newspaper"] header { border-bottom: 3px double var(--border-dim); }
        [data-theme="newspaper"] aside { border-right: 1px solid var(--border-dim); }
        [data-theme="newspaper"] .info-card { border: 1px solid var(--border-dim); box-shadow: 2px 2px 0px rgba(0,0,0,0.1); }
        [data-theme="newspaper"] .modal-mask .glass-panel { border: 4px double #444; box-shadow: 10px 10px 0px rgba(0,0,0,0.2); }

        /* --- 滚动条 --- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: var(--border-dim); border-radius: var(--radius-btn); }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

        /* --- 组件风格 --- */
        .glass-panel { 
            background: var(--bg-glass); 
            backdrop-filter: blur(24px); 
            border: 1px solid var(--border-highlight); 
            box-shadow: 0 12px 40px var(--shadow-color); 
        }

        .info-card {
            background: var(--bg-card);
            border: 1px solid var(--border-highlight);
            transition: all 0.2s ease;
        }
        .info-card:hover {
            border-color: var(--text-dim);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .font-mono-tech { font-family: var(--font-mono); letter-spacing: -0.03em; }
        
        .input-tech {
            background: var(--bg-input); 
            border: 1px solid var(--border-dim); 
            color: var(--text-main); 
            transition: all 0.2s;
        }
        .input-tech:focus { 
            border-color: var(--text-accent); 
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1); 
            background: var(--bg-input-focus);
        }
        
        [data-theme="newspaper"] .input-tech {
            border: 1px solid #999;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.05);
            font-family: 'Courier New', monospace;
        }

        /* --- 模态框 --- */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.75); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
        }

        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        /* 状态变更框 */
        .impact-badge {
            display: inline-flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem;
            border-width: 1px; font-size: 0.9rem;
            box-shadow: 0 2px 5px var(--shadow-color); backdrop-filter: blur(4px);
            white-space: nowrap; color: var(--text-main);
            border-radius: var(--radius-btn);
        }

        /* Markdown */
        .md-content h1, .md-content h2 { 
            color: var(--text-main); font-weight: 800; margin-top: 1em; margin-bottom: 0.5em; 
            border-bottom: 2px solid var(--border-dim); padding-bottom: 0.2em; font-size: 1.4rem;
        }
        .md-content p { margin-bottom: 1em; text-align: justify; color: var(--text-main); opacity: 0.9; }
        .md-content strong { color: var(--text-accent); font-weight: 700; }
        .md-content ul { list-style: disc; padding-left: 1.5em; margin-bottom: 1em; }
        
        [data-theme="newspaper"] .md-content strong { color: #8b0000; font-weight: 900; background: rgba(0,0,0,0.05); padding: 0 4px; }
        [data-theme="newspaper"] .md-content h1 { text-transform: uppercase; border-bottom: 3px double #000; text-align: center; font-size: 2em; letter-spacing: 0.05em; margin-bottom: 1em; }

        /* 背景LOGO */
        .event-card-bg-logo { 
            position: absolute; top: -10px; right: -20px; font-size: 220px; opacity: 0.04; 
            transform: rotate(-10deg); transition: all 0.5s ease; z-index: 0; pointer-events: none;
        }
        .group\/event:hover .event-card-bg-logo { opacity: 0.08; transform: rotate(0deg) scale(1.05); }

        /* --- 上下文拖拽列表样式 --- */
        .context-item {
            display: flex; align-items: center; gap: 10px; padding: 8px;
            background: var(--bg-badge); border: 1px solid var(--border-highlight);
            margin-bottom: 4px; transition: all 0.2s; cursor: grab;
            color: var(--text-main);
            border-radius: var(--radius-btn);
        }
        .context-item:hover { background: var(--bg-hover); }
        .context-item:active { cursor: grabbing; }
        .context-item.active { border-left: 3px solid #10b981; }
        .context-item.disabled { opacity: 0.5; }

        /* --- 海报生成专用样式 --- */
        #poster-canvas {
            position: fixed; left: -9999px; top: 0; width: 1080px; padding: 0; margin: 0;
            box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden;
        }
        
        /* Style 1: Cyberpunk Terminal (暗色终端风格修正) */
        /* Style 1: Cyberpunk Terminal (完全还原 v1.3.1 样式) */
        .poster-terminal {
            width: 100%; height: 100%; min-height: 1200px;
            background: linear-gradient(to bottom, #0f1623, #05080c);
            color: white; font-family: 'PingFang SC', sans-serif;
            border-left-width: 24px; position: relative; display: flex; flex-direction: column;
        }
        .poster-terminal .bg-texture {
            position: absolute; inset: 0; z-index: 0; opacity: 0.05; pointer-events: none;
            background-image: radial-gradient(#94a3b8 1px, transparent 1px); background-size: 40px 40px;
        }
        .poster-terminal .poster-header {
            padding: 60px 70px; background: rgba(0,0,0,0.2); border-bottom: 2px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 10;
        }
        .poster-terminal .poster-body { padding: 50px 70px; position: relative; z-index: 10; flex: 1; }
        .poster-terminal h1 {
            font-size: 64px; line-height: 1.2; font-weight: 900; color: #fff; margin-bottom: 50px; letter-spacing: -0.02em;
            border-bottom: 2px solid #334155; padding-bottom: 20px;
        }
        .poster-terminal .md-body { font-size: 28px; line-height: 1.8; color: #cbd5e1; }
        .poster-terminal .md-body strong { color: #f59e0b; font-weight: bold; }

        /* 关键修复：徽章容器 */
        .poster-terminal .poster-badge-container {
            margin-bottom: 50px; display: flex; flex-direction: column; gap: 20px; position: relative; z-index: 10;
        }
        /* 关键修复：徽章本体（Flex布局） */
        .poster-terminal .poster-badge {
            display: flex; height: 64px; 
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; overflow: hidden; backdrop-filter: blur(10px);
        }
        /* 关键修复：徽章左侧 */
        .poster-terminal .poster-badge-left {
            display: flex; align-items: center; justify-content: center; 
            padding: 0 30px; padding-bottom: 4px; /* 微调对齐 */
            min-width: 200px; 
            background: rgba(0,0,0,0.2); border-right: 1px solid rgba(255,255,255,0.1);
            font-weight: 800; font-size: 22px; gap: 14px; height: 100%; color: inherit;
        }
        /* 关键修复：徽章右侧 */
        .poster-terminal .poster-badge-right {
            display: flex; align-items: center; 
            padding: 0 30px; padding-bottom: 4px; /* 微调对齐 */
            flex: 1;
            font-family: 'JetBrains Mono', monospace; font-size: 22px; height: 100%; line-height: 1;
        }

        .poster-terminal .poster-footer {
            padding: 40px 70px; background: rgba(0,0,0,0.4); border-top: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center; font-family: 'JetBrains Mono', monospace;
            color: #64748b; font-size: 18px; text-transform: uppercase; letter-spacing: 0.1em; position: relative; z-index: 10;
        }
        /* Style 2: Vintage Newspaper */
        .poster-newspaper {
            width: 100%; height: 100%; min-height: 1200px;
            background-color: #f4f1ea; color: #1a1a1a;
            font-family: 'Georgia', 'Songti SC', serif;
            position: relative; display: flex; flex-direction: column;
            padding: 60px;
        }
        .poster-newspaper .paper-grain {
            position: absolute; inset: 0; opacity: 0.15; z-index: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }
        .poster-newspaper .news-header {
            border-bottom: 4px double #1a1a1a; 
            padding-bottom: 15px; 
            
            /* --- 关键修改 --- */
            /* 原来可能是 40px，现在改为 15px */
            /* 作用：减少刊头和标题之间的空白，让标题往上走 */
            margin-bottom: 15px; 
            
            text-align: center; 
            position: relative; 
            z-index: 10;
        }
        .poster-newspaper .brand { font-size: 80px; font-weight: 900; letter-spacing: -0.02em; text-transform: uppercase; line-height: 1; margin-bottom: 50px; }
        .poster-newspaper .meta { display: flex; justify-content: space-between; border-top: 1px solid #1a1a1a; border-bottom: 1px solid #1a1a1a; padding: 10px 0; font-family: 'Courier New', monospace; font-size: 20px; text-transform: uppercase; font-weight: bold; }
        
        .poster-newspaper .headline { 
            font-size: 72px; 
            line-height: 1.1; 
            font-weight: 900; 
            
            /* --- 关键修改 --- */
            margin-top: 0;       /* 确保标题顶部没有多余间隙 */
            /* 原来可能是 20px，现在改为 50px */
            /* 作用：给下方的红色倾斜印章留出足够的旋转空间，防止重叠 */
            margin-bottom: 50px; 
            
            text-align: center; 
            font-family: 'Times New Roman', serif; 
            position: relative; 
            z-index: 10; 
        }
        
        .poster-newspaper .content-cols {
            column-count: 2; 
            column-gap: 60px; 
            font-size: 26px; 
            line-height: 1.6; 
            text-align: justify; 
            position: relative; 
            z-index: 10;
            
            /* --- 核心修复代码 --- */
            /* 1. 增加底部边距，强制把底部的双线栏顶下去，防止重叠 */
            margin-bottom: 80px; 
            
            /* 2. 自动占据剩余空间，但配合上面的margin确保不压线 */
            flex: 1; 
        }
        
        /* 1. 徽章容器：调整间距，防止正文过高 */
        .poster-newspaper .badges-row { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 30px; /* 增加水平间距，防止印章挤在一起 */
            margin-bottom: 30px; /* 减小下方外边距，让正文上移 */
            justify-content: center; 
            position: relative; 
            z-index: 10; 
            border-bottom: 2px solid #1a1a1a; 
            padding-bottom: 25px; /* 稍微留一点呼吸空间给旋转的印章 */
        }

        /* 2. 红色倾斜印章：核心样式找回 */
        .poster-newspaper .stamp-badge {
            border: 3px solid #8b0000; /* 加粗边框，更有印章感 */
            color: #8b0000; 
            padding: 8px 18px; 
            
            /* --- 关键：倾斜效果 --- */
            transform: rotate(-3deg); 
            
            font-family: 'Courier New', monospace; 
            font-weight: 900; 
            font-size: 22px;
            display: flex; 
            align-items: center; 
            gap: 10px; 
            text-transform: uppercase;
            background: transparent; 
            /* 增加一点粗糙的阴影，模拟印泥未干 */
            text-shadow: 1px 1px 0px rgba(139, 0, 0, 0.1);
            box-shadow: 2px 2px 0px rgba(139, 0, 0, 0.1);
        }
    </style>
</head>
<body>

<div id="app" class="h-screen flex flex-col relative text-[var(--text-main)]" :class="ui.theme === 'newspaper' ? 'font-serif' : 'font-sans'">
    <canvas id="map-analysis-canvas" style="display: none;"></canvas>
    <!-- 纸张纹理层 -->
    <div class="app-texture"></div>

    <!-- 顶部导航 -->
    <header class="h-24 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex items-center px-8 justify-between shrink-0 z-50 shadow-sm relative w-full transition-colors duration-300">
        <!-- 左侧区域 -->
        <div class="flex items-center gap-6 shrink-0">
            <div class="w-14 h-14 theme-rounded bg-[var(--bg-panel)] border border-[var(--border-dim)] flex items-center justify-center text-indigo-500 text-3xl shadow-sm shrink-0">
                <img src="logo.png" class="w-15 h-15 object-contain">
            </div>
            
            <div class="flex flex-col justify-center">
                <div class="flex items-center">
                    <h1 class="font-black text-2xl text-[var(--text-main)] tracking-tight leading-none mr-2">{{ t('app_title') }}</h1>
                    <span class="text-[var(--text-dim)] font-light text-sm font-mono-tech mr-4">v1.05</span>
                    <div class="h-4 w-px bg-[var(--border-dim)] mr-4"></div>
                    <div class="flex items-center gap-2 px-3 py-1 theme-rounded-sm bg-[var(--bg-badge)] border border-[var(--border-dim)] text-indigo-400 font-mono-tech text-xs font-bold tracking-wide backdrop-blur-sm mr-4 shrink-0">
                        <span>POWERED BY 絜矩 (QQ 2124223354)</span>
                    </div>

                    <!-- 语录展示区 -->
                    <div class="relative h-8 w-[500px] overflow-hidden flex items-center hidden 2xl:flex">
                        <transition-group name="quote">
                            <div :key="quoteIdx" class="absolute left-0 text-[var(--text-dim)] text-sm font-serif italic tracking-widest whitespace-nowrap">
                                <i class="fa-solid fa-quote-left text-xs opacity-50 mr-2 transform -translate-y-1"></i>
                                {{ quotes[quoteIdx] }}
                                <i class="fa-solid fa-quote-right text-xs opacity-50 ml-1 transform -translate-y-1"></i>
                            </div>
                        </transition-group>
                    </div>
                </div>

                <!-- 状态信息 -->
                <div class="flex items-center gap-3 mt-1.5 text-[10px] font-mono-tech uppercase tracking-widest text-[var(--text-dim)]">
                    <span :class="serverConnected ? 'text-emerald-500' : 'text-red-500'" class="flex items-center gap-2 font-bold">
                        <i class="fa-solid fa-wifi"></i> {{ serverConnected ? t('status_online') : t('status_offline') }}
                    </span>
                    <span v-if="currentSaveFile" class="text-indigo-400 ml-2 border-l border-[var(--border-dim)] pl-2">
                        <i class="fa-solid fa-floppy-disk mr-1"></i> {{ currentSaveFile }}
                    </span>
                </div>
            </div>
        </div>

        <!-- 右侧区域 -->
        <div class="flex items-center gap-4 ml-auto shrink-0">
            <div class="text-right mr-4 border-r border-[var(--border-dim)] pr-6">
                <div class="text-[10px] text-[var(--text-dim)] uppercase font-bold tracking-widest mb-1">{{ t('next_turn_label') }}</div>
                <div class="text-emerald-500 font-mono-tech font-bold text-2xl leading-none tracking-tight">{{ pendingTurnRange || t('auto') }}</div>
            </div>
            <button @click="openScriptGenModal" class="h-11 px-5 theme-rounded-sm bg-[var(--bg-panel)] hover:bg-[var(--bg-hover)] text-[var(--text-accent)] border border-[var(--border-dim)] transition font-bold text-sm flex items-center gap-2">
                <i class="fa-solid fa-wand-sparkles"></i> {{ t('btn_script_gen') }}
            </button>
            <button @click="showSettings = true" class="h-11 w-11 theme-rounded-sm bg-[var(--bg-panel)] hover:bg-[var(--bg-hover)] text-[var(--text-dim)] border border-[var(--border-dim)] transition flex items-center justify-center">
                <i class="fa-solid fa-gear text-lg"></i>
            </button>
            <button @click="openSaveLoadModal" class="h-11 px-6 theme-rounded-sm bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-900/40 transition font-bold text-sm border-t border-indigo-400/30 flex items-center gap-2">
                <i class="fa-solid fa-folder-open"></i> {{ t('btn_files') }}
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden z-10">
        
        <!-- 左侧：资料库 -->
        <aside class="w-1/5 min-w-[380px] bg-[var(--bg-sidebar)] border-r border-[var(--border-dim)] flex flex-col shrink-0 z-30 relative shadow-lg transition-colors duration-300">
            <div class="grid grid-cols-4 p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] gap-1">
                <button @click="tabs.left = 'world'" :class="tabs.left==='world' ? 'bg-[var(--bg-panel)] text-[var(--text-main)] border-[var(--border-dim)]' : 'text-[var(--text-dim)] border-transparent hover:text-[var(--text-main)]'" class="py-2 theme-rounded-sm border transition text-xs font-bold tracking-wide"><i class="fa-solid fa-globe mr-1"></i>{{ t('tab_world') }}</button>
                <button @click="tabs.left = 'players'" :class="tabs.left==='players' ? 'bg-[var(--bg-panel)] text-indigo-400 border-[var(--border-dim)]' : 'text-[var(--text-dim)] border-transparent hover:text-[var(--text-main)]'" class="py-2 theme-rounded-sm border transition text-xs font-bold tracking-wide"><i class="fa-solid fa-users mr-1"></i>{{ t('tab_entity') }}</button>
                <button @click="tabs.left = 'lore'" :class="tabs.left==='lore' ? 'bg-[var(--bg-panel)] text-emerald-400 border-[var(--border-dim)]' : 'text-[var(--text-dim)] border-transparent hover:text-[var(--text-main)]'" class="py-2 theme-rounded-sm border transition text-xs font-bold tracking-wide"><i class="fa-solid fa-book mr-1"></i>{{ t('tab_lore') }}</button>
                <button @click="tabs.left = 'stat_schema'" :class="tabs.left==='stat_schema' ? 'bg-[var(--bg-panel)] text-amber-400 border-[var(--border-dim)]' : 'text-[var(--text-dim)] border-transparent hover:text-[var(--text-main)]'" class="py-2 theme-rounded-sm border transition text-xs font-bold tracking-wide"><i class="fa-solid fa-sliders mr-1"></i>{{ t('tab_rules') }}</button>
            </div>

            <!-- 1. 全局变量 -->
            <div v-if="tabs.left === 'world'" class="flex-1 overflow-y-auto p-5 space-y-3">
                <div class="text-xs text-[var(--text-dim)] font-bold uppercase tracking-widest mb-2 px-1">Global Variables</div>
                <div v-for="(gVar, idx) in global_vars" :key="idx" class="bg-[var(--bg-panel)] p-3 theme-rounded-sm border border-[var(--border-dim)] flex flex-col gap-2 group">
                    <div class="flex gap-2">
                        <input v-model="gVar.key" @change="saveGame('autosave.json')" class="w-1/3 bg-[var(--bg-badge)] text-sm text-indigo-400 p-2 theme-rounded-sm border border-[var(--border-dim)] outline-none font-bold font-mono-tech" placeholder="变量名">
                        <input v-model="gVar.value" @change="saveGame('autosave.json')" class="flex-1 bg-[var(--bg-badge)] text-sm text-[var(--text-main)] p-2 theme-rounded-sm border border-[var(--border-dim)] outline-none" placeholder="当前状态">
                        <button @click="global_vars.splice(idx,1); saveGame('autosave.json')" class="text-[var(--text-dim)] hover:text-red-400 px-2 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
                <button @click="addGlobalVar" class="w-full py-3 bg-[var(--bg-panel)] text-[var(--text-dim)] theme-rounded-sm border border-[var(--border-dim)] font-bold text-sm hover:bg-[var(--bg-header)] transition hover:text-[var(--text-main)]"><i class="fa-solid fa-plus mr-2"></i> {{ t('btn_add_global') }}</button>
            </div>

            <!-- 2. 实体列表 -->
            <div v-if="tabs.left === 'players'" class="flex-1 overflow-y-auto p-5 space-y-4">
                 <div v-for="player in players" :key="player.id" @click="openFactionModal(player)" class="info-card cursor-pointer theme-rounded p-5 relative group">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 theme-rounded-sm bg-[var(--bg-badge)] border border-[var(--border-dim)] flex items-center justify-center text-xl shadow-inner" :style="{ color: player.color, borderColor: player.color + '40' }">
                                <i :class="player.logo || 'fa-solid fa-users'"></i>
                            </div>
                            <div>
                                <div class="font-black text-base text-[var(--text-main)] leading-tight mb-1">{{ player.name }}</div>
                                <div class="text-[10px] font-mono-tech text-[var(--text-dim)] uppercase tracking-widest">ID: {{ player.id }}</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                             <button @click.stop="exportAsImage('faction', player)" class="text-[var(--text-dim)] hover:text-emerald-400 transition" title="生成战术海报"><i class="fa-solid fa-camera"></i></button>
                             <i class="fa-solid fa-ellipsis-vertical text-[var(--text-dim)] group-hover:text-[var(--text-main)] transition px-2"></i>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div v-for="(val, key) in player.stats" :key="key" class="bg-[var(--bg-badge)] px-2 py-1.5 theme-rounded-sm border border-[var(--border-dim)] flex flex-col">
                            <span class="text-[9px] text-[var(--text-dim)] font-bold uppercase tracking-wider">{{ getSchemaLabel(key) }}</span>
                            <span class="text-xs font-mono-tech font-bold truncate" :style="{ color: player.color }">{{val}}</span>
                        </div>
                    </div>
                </div>
                <button @click="openFactionModal(null)" class="w-full py-4 border-2 border-dashed border-[var(--border-dim)] text-[var(--text-dim)] theme-rounded hover:text-indigo-400 hover:border-indigo-500/50 transition text-sm font-bold bg-[var(--bg-badge)] hover:bg-[var(--bg-panel)] uppercase tracking-widest flex items-center justify-center gap-2"><i class="fa-solid fa-plus-circle"></i> {{ t('btn_new_entity') }}</button>
            </div>

            <!-- 3. 资料设定 -->
            <div v-if="tabs.left === 'lore'" class="flex-1 overflow-y-auto p-5 space-y-4">
                <div v-for="(entry, idx) in lorebook" :key="idx" class="info-card theme-rounded p-4">
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-[var(--border-highlight)]">
                        <input v-model="entry.keys" @change="saveGame('autosave.json')" class="bg-transparent text-sm font-bold text-emerald-400 w-full outline-none placeholder-[var(--text-dim)]" placeholder="关键词...">
                        <div class="flex items-center gap-2">
                            <button @click="exportAsImage('lore', entry)" class="text-[var(--text-dim)] hover:text-emerald-400 transition text-xs" title="导出资料卡"><i class="fa-solid fa-camera"></i></button>
                            <button @click="cycleLoreMode(entry)" class="px-2 py-1 theme-rounded-sm text-[10px] font-bold uppercase tracking-wider min-w-[50px] transition-all border" :class="{'bg-emerald-900/40 text-emerald-400 border-emerald-500/40': entry.mode==='on', 'bg-indigo-900/40 text-indigo-400 border-indigo-500/40': entry.mode==='auto', 'bg-[var(--bg-badge)] text-[var(--text-dim)] border-[var(--border-dim)]': entry.mode==='off'}">{{ entry.mode === 'on' ? '常驻' : (entry.mode === 'auto' ? '自动' : '禁用') }}</button>
                        </div>
                    </div>
                    <textarea v-model="entry.content" @change="saveGame('autosave.json')" class="w-full bg-[var(--bg-badge)] theme-rounded-sm p-3 text-xs text-[var(--text-main)] resize-none h-20 border border-[var(--border-dim)] focus:border-emerald-500/50 outline-none leading-relaxed" placeholder="设定内容..."></textarea>
                    <div class="flex justify-end mt-1"><button @click="lorebook.splice(idx,1); saveGame('autosave.json')" class="text-xs text-[var(--text-dim)] hover:text-red-400"><i class="fa-solid fa-trash"></i></button></div>
                </div>
                <button @click="addLoreEntry" class="w-full py-3 bg-[var(--bg-panel)] hover:bg-[var(--bg-header)] text-emerald-500 theme-rounded-sm border border-[var(--border-dim)] transition font-bold text-sm"><i class="fa-solid fa-database mr-2"></i> {{ t('btn_add_lore') }}</button>
            </div>

            <!-- 4. 规则列表 -->
            <div v-if="tabs.left === 'stat_schema'" class="flex-1 overflow-y-auto p-5 space-y-3">
                <div v-for="(field, idx) in stat_schema" :key="idx" class="bg-[var(--bg-panel)] p-3 theme-rounded-sm border border-[var(--border-dim)] flex gap-3 items-center">
                    <input v-model="field.label" @change="saveGame('autosave.json')" class="flex-1 bg-[var(--bg-badge)] text-sm text-[var(--text-main)] p-2 theme-rounded-sm border border-[var(--border-dim)] outline-none" placeholder="名称">
                    <input v-model="field.key" @change="saveGame('autosave.json')" class="w-24 bg-[var(--bg-badge)] text-sm text-[var(--text-dim)] p-2 theme-rounded-sm border border-[var(--border-dim)] font-mono-tech text-center" placeholder="Key">
                    <button @click="stat_schema.splice(idx,1); saveGame('autosave.json')" class="text-[var(--text-dim)] hover:text-red-400 px-2"><i class="fa-solid fa-times"></i></button>
                </div>
                <button @click="exportAsImage('rules', stat_schema)" class="w-full py-3 bg-[var(--bg-panel)] text-indigo-400 theme-rounded-sm border border-[var(--border-dim)] font-bold text-sm hover:bg-[var(--bg-header)] transition mb-2"><i class="fa-solid fa-camera mr-2"></i> {{ t('btn_export_rules') }}</button>
                <button @click="addSchemaField" class="w-full py-3 bg-[var(--bg-panel)] text-amber-500 theme-rounded-sm border border-[var(--border-dim)] font-bold text-sm hover:bg-[var(--bg-header)] transition"><i class="fa-solid fa-plus mr-2"></i> {{ t('btn_add_rule') }}</button>
            </div>
        </aside>

        <!-- 中间：情报流 / 地图 -->
<!-- 中间：情报流 / 地图 -->
        <section class="w-2/5 bg-[var(--bg-deep)] flex flex-col relative border-r border-[var(--border-dim)] transition-colors duration-300">
            
            <!-- [新增 1] 视图切换栏 (这是关键，没有它你无法进入地图模式) -->
            <div class="h-12 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex shrink-0 z-20">
                <button @click="showMap = false" :class="!showMap ? 'text-[var(--text-main)] border-indigo-500 bg-[var(--bg-panel)]' : 'text-[var(--text-dim)] border-transparent'" class="flex-1 font-bold text-xs uppercase tracking-widest border-b-2 transition hover:bg-[var(--bg-panel)] flex items-center justify-center gap-2">
                    <i class="fa-solid fa-stream"></i> Timeline
                </button>
                <button @click="showMap = true" :class="showMap ? 'text-[var(--text-main)] border-emerald-500 bg-[var(--bg-panel)]' : 'text-[var(--text-dim)] border-transparent'" class="flex-1 font-bold text-xs uppercase tracking-widest border-b-2 transition hover:bg-[var(--bg-panel)] flex items-center justify-center gap-2">
                    <i class="fa-solid fa-map"></i> Tactical Map
                </button>
            </div>

            <!-- 背景纹理 -->
            <div class="absolute inset-0 pointer-events-none opacity-[0.03] top-12" style="background-image: radial-gradient(#94a3b8 1px, transparent 1px); background-size: 30px 30px;"></div>
            
            <!-- [修改 2] 原 Timeline 容器 (增加了 v-show="!showMap") -->
            <div v-show="!showMap" id="timeline-scroll" class="flex-1 overflow-y-auto p-10 pr-4 scroll-smooth z-10">
                <div v-if="timeline.length === 0" class="h-full flex flex-col items-center justify-center text-[var(--text-dim)] opacity-50">
                    <i class="fa-regular fa-file-lines text-6xl mb-6"></i>
                    <p class="text-lg font-mono-tech font-bold uppercase tracking-widest">{{ t('msg_no_events') }}</p>
                </div>

                <div v-for="(turn, tIdx) in timeline" :key="tIdx" class="mb-20">
                    <div class="flex items-center gap-6 mb-8 group/turn">
                        <div class="h-px bg-[var(--border-dim)] flex-1"></div>
                        <div class="text-center cursor-pointer group/edit" @click="editingTurnId = turn.id">
                            <div v-if="editingTurnId === turn.id" class="flex flex-col items-center gap-2">
                                <input v-model="turn.id" class="bg-black text-white text-3xl font-black text-center w-24 border border-indigo-500 theme-rounded-sm p-1">
                                <input v-model="turn.timeRange" class="bg-black text-emerald-400 text-lg font-mono-tech text-center w-48 border border-emerald-500 theme-rounded-sm p-1" @blur="saveTurnEdit" @keyup.enter="saveTurnEdit">
                            </div>
                            <div v-else>
                                <h2 class="text-5xl font-black text-[var(--text-main)] group-hover/edit:text-[var(--text-dim)] transition">TURN {{ turn.id }}</h2>
                                <div class="text-emerald-700 font-mono-tech font-bold uppercase tracking-[0.2em] mt-1 group-hover/edit:text-emerald-500 transition">{{ turn.timeRange }}</div>
                            </div>
                        </div>
                        <div class="h-px bg-[var(--border-dim)] flex-1 flex justify-end"><button @click="deleteTurn(tIdx)" class="opacity-0 group-hover/turn:opacity-100 text-[var(--text-dim)] hover:text-red-500 transition px-4 text-xl"><i class="fa-solid fa-trash"></i></button></div>
                    </div>

                    <div class="space-y-12 pl-6 border-l-2 border-[var(--border-dim)] ml-10">
                        <div v-for="(event, eIdx) in turn.events" :key="eIdx" class="relative group/event">
                            <div class="absolute -left-[34px] top-10 w-6 h-0.5 bg-[var(--border-dim)] group-hover/event:bg-indigo-500 group-hover/event:w-8 transition-all"></div>
                            
                            <!-- 新闻卡片本体 -->
                            <div class="glass-panel theme-rounded border-0 border-l-[6px] transition-all duration-300 relative overflow-hidden hover:shadow-[0_10px_50px_var(--shadow-color)]" :style="{ borderLeftColor: getFactionColor(event.factionId) }">
                                <i :class="getFactionLogo(event.factionId)" class="event-card-bg-logo" :style="{ color: getFactionColor(event.factionId) }"></i>
                                
                                <div class="bg-[var(--bg-header)] px-6 py-3 border-b border-[var(--border-highlight)] flex justify-between items-center relative z-10 backdrop-blur-sm">
                                    <div class="flex items-center gap-4 font-mono-tech text-sm font-bold tracking-wider text-[var(--text-dim)]">
                                        <span class="text-[var(--text-dim)]"><i class="fa-regular fa-clock mr-2"></i>{{ formatTimeSpan(event) }}</span>
                                        <span class="w-px h-4 bg-[var(--border-dim)]"></span>
                                        <span class="uppercase flex items-center gap-2" :style="{ color: getFactionColor(event.factionId) }">
                                            <i class="fa-solid fa-tower-broadcast text-xs opacity-60"></i> {{ getFactionName(event.factionId) }}
                                        </span>
                                    </div>
                                    <div class="flex gap-4 items-center">
                                        <button @click.stop="exportAsImage('event', event)" class="text-[var(--text-dim)] hover:text-emerald-400 transition" title="生成情报简报海报"><i class="fa-solid fa-camera"></i></button>
                                        <button v-if="!isEditingEvent(tIdx, eIdx)" @click.stop="enableEventEdit(tIdx, eIdx)" class="text-[var(--text-dim)] hover:text-[var(--text-main)] transition"><i class="fa-solid fa-pen-to-square"></i></button>
                                        <button v-else @click.stop="saveEventEdit()" class="text-emerald-500 hover:text-[var(--text-main)] transition"><i class="fa-solid fa-floppy-disk"></i></button>
                                    </div>
                                </div>

                                <div class="p-8 cursor-pointer relative z-10" @click="toggleEventOpen(event)">
                                    <!-- 编辑模式 -->
                                    <div v-if="isEditingEvent(tIdx, eIdx)" @click.stop class="mb-6 space-y-4">
                                        <div class="flex gap-2"><input v-model="event.timeStart" class="input-tech p-2 w-1/2 theme-rounded-sm font-bold text-center" placeholder="Time Start"><input v-model="event.timeEnd" class="input-tech p-2 w-1/2 theme-rounded-sm font-bold text-center" placeholder="Time End"></div>
                                        <textarea v-model="event.summary" class="w-full h-24 input-tech p-3 theme-rounded-sm text-lg font-bold resize-none" placeholder="Summary..."></textarea>
                                        
                                        <div class="bg-[var(--bg-badge)] p-3 theme-rounded-sm border border-[var(--border-dim)]">
                                            <div class="text-[10px] font-bold text-[var(--text-dim)] uppercase mb-2">Manage Impacts</div>
                                            <div class="flex flex-wrap gap-2 mb-3">
                                                <div v-for="(imp, i) in event.impacts" :key="i" class="impact-badge pr-1" :style="{ borderColor: getFactionColor(imp.targetId), backgroundColor: getFactionColor(imp.targetId) + '15' }">
                                                    <span class="text-xs" :style="{ color: getFactionColor(imp.targetId) }">{{ imp.targetName }}.{{ imp.attrLabel }} [{{ imp.newValue }}]</span>
                                                    <button @click="removeEventImpact(event, i)" class="ml-2 w-5 h-5 flex items-center justify-center theme-rounded-sm hover:bg-red-500/20 hover:text-red-500 text-[var(--text-dim)] transition"><i class="fa-solid fa-times"></i></button>
                                                </div>
                                            </div>
                                            <div class="flex gap-2 items-center">
                                                <select v-model="editImpactForm.targetId" class="input-tech h-8 text-xs font-bold theme-rounded-sm outline-none w-1/3"><option value="" disabled selected>Target</option><option v-for="p in players" :value="p.id">{{ p.name }}</option></select>
                                                <select v-model="editImpactForm.attrKey" class="input-tech h-8 text-xs font-bold theme-rounded-sm outline-none w-1/4"><option value="" disabled selected>Attr</option><option v-for="field in stat_schema" :value="field.key">{{ field.label }}</option></select>
                                                <input v-model="editImpactForm.newValue" @keyup.enter="addEventImpact(event)" placeholder="Val" class="input-tech h-8 flex-1 text-xs font-bold theme-rounded-sm outline-none px-2">
                                                <button @click="addEventImpact(event)" class="h-8 w-8 theme-rounded-sm bg-emerald-600 hover:bg-emerald-500 text-white flex items-center justify-center"><i class="fa-solid fa-plus"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 浏览模式 -->
                                    <h3 v-else class="text-2xl font-black text-[var(--text-main)] mb-6 leading-tight tracking-tight">{{ event.summary }}</h3>
                                    <div v-if="!isEditingEvent(tIdx, eIdx) && event.impacts?.length" class="flex flex-wrap gap-3 mb-4">
                                        <div v-for="(imp, i) in event.impacts" :key="i" class="impact-badge" :style="{ borderColor: getFactionColor(imp.targetId), backgroundColor: getFactionColor(imp.targetId) + '15' }">
                                            <div class="flex items-center gap-2 pr-2 border-r" :style="{ borderColor: getFactionColor(imp.targetId) + '40' }">
                                                <i :class="getFactionLogo(imp.targetId)" :style="{ color: getFactionColor(imp.targetId) }"></i>
                                                <span class="font-bold text-xs" :style="{ color: getFactionColor(imp.targetId) }">{{ imp.targetName }}</span>
                                            </div>
                                            <div class="font-mono-tech text-xs pl-2 text-[var(--text-main)]">
                                                <span class="text-[var(--text-dim)] mr-1">{{ imp.attrLabel }}</span>
                                                <span class="font-bold">{{ imp.oldValue }} <i class="fa-solid fa-arrow-right text-[10px] mx-1 opacity-50"></i> {{ imp.newValue }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4 flex justify-center"><i class="fa-solid text-xl transition-transform duration-300" :class="event.isOpen ? 'fa-chevron-up text-indigo-500' : 'fa-chevron-down text-[var(--text-dim)]'"></i></div>
                                </div>

                                <transition name="slide-up">
                                    <div v-if="event.isOpen" class="bg-[var(--bg-glass)] border-t border-[var(--border-highlight)] p-8 relative z-10">
                                        <div v-if="isEditingEvent(tIdx, eIdx)" @click.stop><textarea v-model="event.content" class="w-full h-96 input-tech p-4 font-mono-tech rounded"></textarea></div>
                                        <div v-else class="md-content text-lg" v-html="renderMarkdown(event.content)"></div>
                                        <div class="pt-6 border-t border-[var(--border-dim)] flex justify-end gap-4 mt-8">
                                            <button @click.stop="copyToClipboard(event.content)" class="px-5 py-2 theme-rounded-sm border border-[var(--border-dim)] text-[var(--text-dim)] hover:text-[var(--text-main)] hover:bg-[var(--bg-panel)] transition font-bold text-xs uppercase tracking-widest"><i class="fa-regular fa-copy mr-2"></i> {{ t('btn_copy') }}</button>
                                            <button @click.stop="deleteEvent(tIdx, eIdx)" class="px-5 py-2 theme-rounded-sm border border-[var(--border-dim)] text-[var(--text-dim)] hover:text-red-400 hover:bg-red-900/20 transition font-bold text-xs uppercase tracking-widest"><i class="fa-solid fa-trash mr-2"></i> {{ t('btn_delete') }}</button>
                                        </div>
                                    </div>
                                </transition>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="h-40"></div>
            </div>

<!-- [修改后] 地图界面容器 -->
            <div v-show="showMap" class="flex-1 overflow-hidden relative flex flex-col bg-[var(--bg-deep)] z-10 select-none">
                
                <!-- 地图工具栏 -->
                <div class="p-2 border-b border-[var(--border-dim)] bg-[var(--bg-sidebar)] flex justify-between items-center shrink-0 z-20">
                    <div class="flex gap-2">
                        <label class="cursor-pointer px-3 py-1 theme-rounded-sm bg-[var(--bg-panel)] border border-[var(--border-dim)] text-[10px] font-bold hover:text-[var(--text-main)] text-[var(--text-dim)] transition flex items-center gap-2 hover:border-indigo-500">
                            <i class="fa-solid fa-upload"></i> Upload Map
                            <input type="file" @change="handleMapUpload" class="hidden" accept="image/*">
                        </label>
                        
                        <!-- [新增] 模式切换 -->
                        <div class="h-6 w-px bg-[var(--border-dim)] mx-1"></div>
                        <div class="flex bg-[var(--bg-badge)] theme-rounded-sm border border-[var(--border-dim)] overflow-hidden">
                            <!-- 1. 浏览/拖拽模式 -->
                            <button @click="mapToolMode = 'view'" 
                                    :class="mapToolMode === 'view' ? 'bg-amber-600 text-white shadow-inner' : 'text-[var(--text-dim)] hover:text-[var(--text-main)]'" 
                                    class="px-3 py-1 text-[10px] font-bold transition flex items-center gap-1" title="View/Drag Mode (No Edits)">
                                <i class="fa-solid fa-hand"></i> View
                            </button>
                            
                            <!-- 2. 点编辑模式 -->
                            <button @click="mapToolMode = 'pin'" 
                                    :class="mapToolMode === 'pin' ? 'bg-indigo-600 text-white shadow-inner' : 'text-[var(--text-dim)] hover:text-[var(--text-main)]'" 
                                    class="px-3 py-1 text-[10px] font-bold transition flex items-center gap-1" title="Pin Mode (Ignore Regions)">
                                <i class="fa-solid fa-location-dot"></i> Pin
                            </button>
                            
                            <!-- 3. 区域编辑模式 -->
                            <button @click="mapToolMode = 'region'" 
                                    :class="mapToolMode === 'region' ? 'bg-emerald-600 text-white shadow-inner' : 'text-[var(--text-dim)] hover:text-[var(--text-main)]'" 
                                    class="px-3 py-1 text-[10px] font-bold transition flex items-center gap-1" title="Region Mode (Ignore Pins)">
                                <i class="fa-solid fa-draw-polygon"></i> Region
                            </button>
                        </div>
                        
                        <!-- [修改] 视图控制按钮 -->
                        <button @click="resetMapView" class="px-3 py-1 theme-rounded-sm bg-[var(--bg-panel)] border border-[var(--border-dim)] text-[10px] font-bold text-[var(--text-dim)] hover:text-[var(--text-main)]" title="Reset View (Fit Width)"><i class="fa-solid fa-compress"></i> Fit</button>
<!-- [新增] 导入导出功能 -->
                        <div class="h-6 w-px bg-[var(--border-dim)] mx-1"></div>
                        
                        <!-- 导出按钮 -->
                        <button @click="exportMapConfig" class="px-3 py-1 theme-rounded-sm bg-[var(--bg-panel)] border border-[var(--border-dim)] text-[10px] font-bold text-[var(--text-dim)] hover:text-emerald-500 transition" title="Export Map Data (.json)">
                            <i class="fa-solid fa-file-export"></i> Export
                        </button>
                        
                        <button @click="exportMapImage" class="px-3 py-1 theme-rounded-sm bg-[var(--bg-panel)] border border-[var(--border-dim)] text-[10px] font-bold text-[var(--text-dim)] hover:text-pink-500 transition" title="Save as PNG Image">
                            <i class="fa-solid fa-camera"></i> IMG
                        </button>
                        
                        <!-- 导入按钮 (触发隐藏的 input) -->
                        <label class="cursor-pointer px-3 py-1 theme-rounded-sm bg-[var(--bg-panel)] border border-[var(--border-dim)] text-[10px] font-bold text-[var(--text-dim)] hover:text-indigo-500 transition" title="Import Map Data (.json)">
                            <i class="fa-solid fa-file-import"></i> Import
                            <input type="file" @change="handleMapConfigImport" class="hidden" accept=".json">
                        </label>
                    </div>

                    <div class="text-[10px] text-[var(--text-dim)] font-mono-tech flex gap-4">
                        <span><i class="fa-solid fa-mouse-pointer mr-1"></i> CLICK: ADD PIN</span>
                        <span><i class="fa-solid fa-hand mr-1"></i> DRAG: PAN</span>
                        <span><i class="fa-solid fa-magnifying-glass mr-1"></i> WHEEL: ZOOM</span>
                    </div>
                    
                    <div class="text-[10px] font-mono font-bold text-emerald-500">
                        {{ (mapView.scale * 100).toFixed(0) }}%
                    </div>
                </div>

                <!-- 地图画布容器 -->
                <!-- 关键样式: overflow-hidden (隐藏超出部分), cursor-move (提示可拖拽) -->
                <div class="flex-1 overflow-hidden relative bg-[#050505] cursor-move"
                     @wheel.prevent="onMapWheel"
                     @mousedown="onMapMouseDown"
                     @mousemove="onMapMouseMove"
                     @mouseup="onMapMouseUp"
                     @mouseleave="onMapMouseUp">
                    
                    <!-- 空状态 -->
                    <div v-if="!map_data.image" class="absolute inset-0 flex flex-col items-center justify-center text-[var(--text-dim)] opacity-30 pointer-events-none gap-4">
                        <i class="fa-solid fa-map-location-dot text-6xl"></i>
                        <span class="text-xs uppercase font-bold tracking-widest">No Tactical Map Loaded</span>
                    </div>
                    
                    <!-- 
                        变换层 (Transform Layer) 
                        style: 应用动态的 scale 和 translate
                        transform-origin: 0 0 (从左上角开始变换，便于计算)
                    -->
                    <div v-else 
                        id="map-capture-target"
                        class="relative inline-block origin-top-left transition-transform duration-75 ease-out will-change-transform"
                        :style="{ transform: `translate(${mapView.x}px, ${mapView.y}px) scale(${mapView.scale})`, width: '100%' }"
                        @click="onMapBackgroundClick">
                        
                        <!-- 1. 底图层 -->
                        <img :src="map_data.image" class="block w-full pointer-events-none opacity-80 select-none" draggable="false">
                        
                        <!-- 2. Regions 地块遮罩层 (最底层交互 z-0) -->
                        <div v-for="(reg, idx) in map_data.regions" :key="reg.id"
                             class="absolute z-0"
                             :class="mapToolMode === 'region' ? 'pointer-events-auto cursor-pointer' : 'pointer-events-none'"
                             :style="{ left: reg.x + '%', top: reg.y + '%', width: reg.w + '%', height: reg.h + '%' }"
                             @click.stop="onRegionClick(reg, idx)">
                             
                             <!-- [修改后] 使用 SVG 实现遮罩 (html2canvas 可以完美导出 SVG) -->
                             <svg class="w-full h-full overflow-visible" viewBox="0 0 100 100" preserveAspectRatio="none">
                                <defs>
                                    <!-- 定义遮罩：引入我们的 Base64 图片 -->
                                    <mask :id="'mask-' + reg.id">
                                        <!-- width/height="100%" 强制拉伸图片填满区域 -->
                                        <image :href="reg.maskData" x="0" y="0" width="100" height="100" preserveAspectRatio="none" />
                                    </mask>
                                </defs>
                                
                                <!-- 绘制矩形，填入颜色，并应用遮罩 -->
                                <rect x="0" y="0" width="100" height="100" 
                                      :fill="getFinalPinColor(reg)" 
                                      fill-opacity="0.5"
                                      :mask="'url(#mask-' + reg.id + ')'" 
                                      class="transition-opacity duration-200 hover:opacity-80" />
                             </svg>

                        </div>

                        <!-- 3. Regions 地块徽章层 (中间层 z-20) -->
                        <div v-for="(reg, idx) in map_data.regions" :key="'label-'+reg.id"
                             class="absolute w-0 h-0 z-20 pointer-events-none flex items-center justify-center"
                             :style="{ left: reg.centerX + '%', top: reg.centerY + '%' }">
                             
                             <!-- 徽章样式 (已修复居中问题) -->
                             <div class="flex items-center gap-1.5 bg-black/70 backdrop-blur-[2px] border border-white/10 px-2 py-1 theme-rounded-sm shadow-[0_4px_6px_rgba(0,0,0,0.5)] group-hover:scale-110 transition-transform duration-200">
                                 <i :class="getFinalPinIcon(reg)" 
                                    class="text-sm drop-shadow-[0_1px_2px_rgba(0,0,0,1)]" 
                                    :style="{ color: getFinalPinColor(reg) }"></i>
                                 <span class="text-[10px] font-bold text-white leading-none tracking-wide shadow-black drop-shadow-md whitespace-nowrap">
                                     {{ reg.label }}
                                 </span>
                             </div>
                        </div>

                        <!-- 4. Pins 普通点层 (最顶层 z-30) -->
                        <!-- 这就是刚才丢失的部分！ -->
                        <div v-for="(pin, idx) in map_data.pins" :key="pin.id" 
                             class="absolute w-8 h-8 -ml-4 -mt-4 transform transition hover:scale-125 group z-30 flex items-center justify-center"
                             :class="mapToolMode === 'pin' ? 'pointer-events-auto cursor-pointer' : 'pointer-events-none'"
                             :style="{ left: pin.x + '%', top: pin.y + '%' }"
                             @mousedown.stop 
                             @click.stop="onPinClick(pin, idx)">
                             
                            <i :class="getFinalPinIcon(pin)" 
                               class="text-2xl drop-shadow-[0_2px_4px_rgba(0,0,0,0.9)] transition-colors duration-200"
                               :style="{ color: getFinalPinColor(pin) }"></i>
                            
                            <div class="absolute left-1/2 -translate-x-1/2 bottom-full mb-1.5 bg-black/80 text-white text-[10px] px-2 py-0.5 theme-rounded-sm border border-white/20 whitespace-nowrap pointer-events-none font-bold shadow-lg opacity-0 group-hover:opacity-100 transition-opacity">
                                {{ pin.label || getPinName(pin.linkId) }}
                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </section>

        <!-- 右侧：指挥台 -->
        <aside class="w-2/5 bg-[var(--bg-panel)] flex flex-col shrink-0 shadow-[0_0_50px_var(--shadow-color)] z-40 border-l border-[var(--border-dim)] transition-colors duration-300">
            <div class="flex border-b border-[var(--border-dim)] bg-[var(--bg-sidebar)]">
                <button @click="tabs.right = 'staging'" :class="tabs.right === 'staging' ? 'border-indigo-500 text-[var(--text-main)] bg-[var(--bg-panel)]' : 'border-transparent text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="flex-1 py-4 border-b-4 font-bold transition text-sm tracking-wide"><i class="fa-solid fa-layer-group mr-2"></i> {{ t('tab_pending') }} <span v-if="pendingEvents.length" class="ml-2 bg-indigo-600 text-white text-[10px] px-2 py-0.5 rounded-full align-middle">{{pendingEvents.length}}</span></button>
                <button @click="tabs.right = 'input'" :class="tabs.right === 'input' ? 'border-indigo-500 text-[var(--text-main)] bg-[var(--bg-panel)]' : 'border-transparent text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="flex-1 py-4 border-b-4 font-bold transition text-sm tracking-wide"><i class="fa-solid fa-terminal mr-2"></i> {{ t('tab_console') }}</button>
                <button @click="tabs.right = 'godmode'" :class="tabs.right === 'godmode' ? 'border-amber-500 text-[var(--text-main)] bg-[var(--bg-panel)]' : 'border-transparent text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="flex-1 py-4 border-b-4 font-bold transition text-sm tracking-wide"><i class="fa-solid fa-hand-sparkles mr-2"></i> {{ t('tab_godmode') }}</button>
            </div>

            <div class="h-[30%] min-h-[250px] border-b border-[var(--border-dim)] bg-[var(--bg-header)] overflow-y-auto p-5 relative">
                <div v-if="tabs.right === 'staging'" class="space-y-3">
                    <div v-for="(evt, idx) in pendingEvents" :key="'p-'+idx" class="bg-[var(--bg-badge)] border border-[var(--border-highlight)] theme-rounded p-4 cursor-pointer group hover:bg-[var(--bg-panel)] hover:border-indigo-500/50 transition relative overflow-hidden" @click="loadFromStaging(idx)">
                        <div class="absolute left-0 top-0 bottom-0 w-1" :style="{ backgroundColor: getFactionColor(evt.factionId) }"></div>
                        <div class="pl-3">
                            <div class="flex justify-between text-[10px] text-[var(--text-dim)] font-bold uppercase mb-1 font-mono-tech">
                                <span>{{ evt.timeStart }} - {{ evt.timeEnd }}</span>
                                <span :style="{ color: getFactionColor(evt.factionId) }">{{ getFactionName(evt.factionId) }}</span>
                            </div>
                            <div class="text-base font-bold text-[var(--text-main)] mb-2 truncate">{{ evt.summary }}</div>
                            <div class="flex flex-wrap gap-2">
                                <span v-for="imp in evt.impacts" class="text-[10px] px-2 py-0.5 theme-rounded-sm border font-mono-tech" :style="{ borderColor: getFactionColor(imp.targetId), color: getFactionColor(imp.targetId), backgroundColor: getFactionColor(imp.targetId)+'10' }">
                                    {{ imp.targetName }}: {{ imp.attrLabel }} [{{ imp.oldValue }} → {{ imp.newValue }}]
                                </span>
                            </div>
                        </div>
                        <button @click.stop="pendingEvents.splice(idx, 1); saveGame('autosave.json')" class="absolute top-2 right-2 text-[var(--text-dim)] hover:text-red-400 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-times text-lg"></i></button>
                    </div>
                    <div v-if="pendingEvents.length === 0" class="h-full flex flex-col items-center justify-center text-[var(--text-dim)] opacity-50">
                        <i class="fa-solid fa-inbox text-5xl mb-3"></i>
                        <span class="font-mono-tech uppercase font-bold tracking-widest text-sm">{{ t('msg_empty_queue') }}</span>
                    </div>
                </div>
                <div v-if="tabs.right === 'input'" class="h-full">
                    <textarea v-model="rawInput" class="w-full h-full bg-transparent border-none outline-none text-[var(--text-main)] font-mono-tech p-2 resize-none text-base leading-relaxed" :placeholder="t('placeholder_input')"></textarea>
                </div>
                <div v-if="tabs.right === 'godmode'" class="h-full flex flex-col p-5 relative">
                    <div class="absolute inset-0 bg-amber-900/5 pointer-events-none"></div>
                    <div class="text-[10px] text-amber-500 font-bold uppercase tracking-widest mb-2"><i class="fa-solid fa-database mr-1"></i> GLOBAL STATE MANIPULATION</div>
                    <p class="text-xs text-[var(--text-dim)] mb-4 leading-relaxed">用自然语言直接修改世界状态。例如：“把所有名为‘帝国’的势力的兵力设为0”，“给所有人增加一个‘理智值’属性，默认为100”。</p>
                    <textarea v-model="godModeInput" class="flex-1 bg-[var(--bg-input)] border border-amber-500/30 theme-rounded-sm p-3 text-sm font-mono text-[var(--text-main)] resize-none outline-none focus:border-amber-500 transition" placeholder="Enter divine command..."></textarea>
                    <div class="mt-4 flex justify-end">
                        <button @click="executeGodMode" :disabled="isThinking || !godModeInput.trim()" class="px-6 py-2 bg-amber-600 hover:bg-amber-500 text-white font-bold text-xs uppercase tracking-widest theme-rounded-sm shadow-lg flex items-center gap-2 disabled:opacity-50">
                            <i :class="isThinking ? 'fa-solid fa-circle-notch fa-spin' : 'fa-solid fa-bolt'"></i> Execute
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex-1 flex flex-col bg-[var(--bg-panel)] relative overflow-hidden">
                
                <!-- 1. 顶部：AI 按钮栏 -->
                <div class="p-4 bg-[var(--bg-sidebar)] border-b border-[var(--border-dim)] shadow-xl z-20 shrink-0">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest"><i class="fa-solid fa-microchip mr-1"></i> {{ t('ai_core_label') }}</span>
                        <span class="text-[10px] font-mono-tech text-[var(--text-dim)]">{{ settings.api.model }}</span>
                    </div>
                    <button @click="openContextModal" :disabled="isThinking" class="w-full py-4 theme-rounded-sm bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-500 hover:to-indigo-600 text-white font-bold text-sm tracking-widest shadow-lg shadow-indigo-900/30 transition disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-3">
                        <i :class="isThinking ? 'fa-solid fa-circle-notch fa-spin' : 'fa-solid fa-bolt'"></i>
                        {{ isThinking ? t('status_thinking') : t('btn_ai_deduce') }}
                    </button>
                </div>

                <!-- 2. 中间：滚动输入区域 (关键：flex-1 overflow-y-auto) -->
                <div class="flex-1 overflow-y-auto p-0 min-h-0">
                    
                    <!-- 行动方 & 时间 -->
                    <div class="p-5 border-b border-[var(--border-dim)] flex gap-4 bg-[var(--bg-header)]">
                        <div class="flex-1">
                            <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-1 tracking-wider">{{ t('label_actor') }}</label>
                            <select v-model="editor.factionId" class="w-full input-tech theme-rounded-sm p-3 text-sm font-bold outline-none">
                                <option value="" disabled selected>{{ t('option_ai_auto') }}</option>
                                <option value="global">{{ t('option_global') }}</option>
                                <option v-for="p in players" :value="p.id">{{ p.name }}</option>
                            </select>
                        </div>
                        <div class="w-1/4">
                            <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-1 tracking-wider">{{ t('label_start') }}</label>
                            <input v-model="editor.timeStart" class="w-full input-tech theme-rounded-sm p-3 text-sm font-mono-tech text-center outline-none">
                        </div>
                        <div class="w-1/4">
                            <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-1 tracking-wider">{{ t('label_end') }}</label>
                            <input v-model="editor.timeEnd" class="w-full input-tech theme-rounded-sm p-3 text-sm font-mono-tech text-center outline-none">
                        </div>
                    </div>

                    <!-- 摘要 -->
                    <div class="p-5 border-b border-[var(--border-dim)]">
                        <label class="block text-[10px] font-bold text-emerald-500 uppercase mb-2 tracking-widest">{{ t('label_summary') }}</label>
                        <textarea v-model="editor.summary" class="w-full h-24 input-tech theme-rounded-sm p-3 text-lg font-bold text-[var(--text-main)] resize-none outline-none leading-normal" placeholder="..."></textarea>
                    </div>

                    <!-- 状态变更 -->
                    <div class="p-5 border-b border-[var(--border-dim)] bg-[var(--bg-badge)]">
                        <label class="block text-[10px] font-bold text-amber-500 uppercase mb-3 tracking-widest">{{ t('label_impact') }}</label>
                        <div class="flex flex-wrap gap-3 mb-4">
                            <div v-for="(imp, idx) in editor.impacts" :key="idx" class="impact-badge" :style="{ borderColor: getFactionColor(imp.targetId), backgroundColor: getFactionColor(imp.targetId) + '15' }">
                                <div class="flex items-center gap-2 pr-2 border-r" :style="{ borderColor: getFactionColor(imp.targetId) + '40' }">
                                    <i :class="getFactionLogo(imp.targetId)" :style="{ color: getFactionColor(imp.targetId) }"></i>
                                    <span class="font-bold text-xs" :style="{ color: getFactionColor(imp.targetId) }">{{ imp.targetName }}</span>
                                </div>
                                <div class="font-mono-tech text-xs text-[var(--text-main)]">
                                    <span class="text-[var(--text-dim)] mr-1">{{ imp.attrLabel }}</span>
                                    <span class="font-bold">
                                        {{ imp.oldValue }} <i class="fa-solid fa-arrow-right mx-1"></i> {{ imp.newValue }}
                                    </span>
                                </div>
                                <button @click="removeImpact(idx)" class="ml-1 text-[var(--text-dim)] hover:text-red-400"><i class="fa-solid fa-times"></i></button>
                            </div>
                        </div>
                        <div class="flex gap-3 items-center bg-[var(--bg-badge)] p-2 theme-rounded-sm border border-[var(--border-dim)]">
                            <select v-model="impactForm.targetId" class="bg-transparent text-xs font-bold text-[var(--text-dim)] p-2 w-32 outline-none"><option value="" disabled selected>Target</option><option v-for="p in players" :value="p.id">{{ p.name }}</option></select>
                            <div class="w-px h-6 bg-[var(--border-dim)]"></div>
                            <select v-model="impactForm.attrKey" class="bg-transparent text-xs font-bold text-[var(--text-dim)] p-2 w-28 outline-none"><option value="" disabled selected>Attr</option><option v-for="field in stat_schema" :value="field.key">{{ field.label }}</option></select>
                            <div class="px-2 text-[10px] text-[var(--text-dim)] font-mono-tech bg-[var(--bg-badge)] theme-rounded-sm h-8 flex items-center justify-center min-w-[40px]">{{ currentAttrValue }} <i class="fa-solid fa-arrow-right ml-1"></i></div>
                            <input v-model="impactForm.newValue" @keyup.enter="addImpact" placeholder="Val" class="input-tech text-emerald-400 font-bold font-mono-tech theme-rounded-sm p-2 w-24 outline-none text-center">
                            <button @click="addImpact" class="text-emerald-500 hover:text-[var(--text-main)] px-2 text-xl"><i class="fa-solid fa-circle-plus"></i></button>
                        </div>
                    </div>

                    <!-- 详细内容 (设置 min-h 防止挤压) -->
                    <div class="p-5 flex flex-col min-h-[400px] relative">
                         <label class="block text-[10px] font-bold text-indigo-400 uppercase mb-2 tracking-widest">{{ t('label_details') }}</label>
                         <textarea v-model="editor.content" class="flex-1 input-tech theme-rounded-sm p-4 text-base font-mono-tech text-[var(--text-main)] resize-none outline-none leading-relaxed h-full" placeholder="// ..."></textarea>
                         <div class="absolute bottom-8 right-8 z-20">
                            <button @click="addToStaging" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 theme-rounded-sm shadow-xl font-bold text-sm transition transform active:scale-95 hover:-translate-y-1 flex items-center gap-2"><i class="fa-solid fa-plus"></i> {{ t('btn_add_pending') }}</button>
                         </div>
                    </div>
                </div>

                <!-- 3. 底部：Commit 按钮 (关键：shrink-0 z-50) -->
                <div class="bg-[var(--bg-sidebar)] p-5 border-t border-[var(--border-dim)] flex justify-between items-center shadow-[0_-10px_40px_var(--shadow-color)] z-50 shrink-0 relative">
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] text-[var(--text-dim)] font-bold uppercase tracking-widest">Next Turn:</span>
                        <input v-model="pendingTurnRange" class="bg-[var(--bg-input)] border border-[var(--border-dim)] text-emerald-500 font-mono-tech text-sm font-bold theme-rounded-sm px-2 py-0.5 w-24 outline-none text-center" :placeholder="t('auto')">
                    </div>
                    <button @click="commitTurn" :disabled="pendingEvents.length === 0" class="px-8 py-3 bg-indigo-600 hover:bg-indigo-500 disabled:bg-[var(--bg-input)] disabled:text-[var(--text-dim)] text-white font-bold text-sm tracking-widest uppercase theme-rounded-sm shadow-lg transition transform active:scale-[0.98] flex items-center gap-3">
                        <i class="fa-solid fa-play"></i> {{ t('btn_commit') }}
                    </button>
                </div>

            </div>
        </aside>

    </main>

<!-- HIDDEN POSTER CANVAS -->
    <div id="poster-canvas">
        
        <!-- TEMPLATE 1: TERMINAL (完全修复版) -->
        <div v-if="ui.theme !== 'newspaper'" class="poster-terminal" :style="{ borderLeftColor: posterData.color }">
            <div class="bg-texture"></div>
            <i :class="posterData.icon" class="poster-watermark-logo" :style="{ color: posterData.color }"></i>
            
            <div class="poster-header">
                <div class="text-slate-400 font-mono-tech text-3xl font-bold tracking-wider flex items-center">
                    <i class="fa-regular fa-clock mr-4"></i>{{ posterData.timeDisplay }}
                </div>
                <div class="uppercase flex items-center gap-4 text-3xl font-bold tracking-wider whitespace-nowrap" :style="{ color: posterData.color }">
                    <i class="fa-solid fa-tower-broadcast opacity-80"></i> {{ posterData.factionName }}
                </div>
            </div>

            <div class="poster-body">
                <h1 class="leading-tight">{{ posterData.title }}</h1>
                
                <!-- 属性徽章：恢复左右分栏结构 -->
                <div v-if="posterData.badges && posterData.badges.length > 0" class="poster-badge-container">
                    <div v-for="(badge, i) in posterData.badges" :key="i" class="poster-badge" :style="{ borderColor: badge.color }">
                        <div class="poster-badge-left">
                            <i :class="badge.icon" :style="{ color: badge.color }"></i>
                            <span :style="{ color: badge.color }">{{ badge.name }}</span>
                        </div>
                        <div class="poster-badge-right">
                            <span class="text-slate-400 uppercase mr-4 tracking-wider">{{ badge.label }}</span>
                            <i class="fa-solid fa-arrow-right text-slate-600 mr-4 text-sm"></i>
                            <span class="font-bold text-white tracking-wide">{{ badge.val }}</span>
                        </div>
                    </div>
                </div>

                <div class="poster-md md-body" v-html="posterData.content"></div>
            </div>

            <div class="poster-footer">
                <div class="flex items-center gap-4"><i class="fa-solid fa-layer-group text-indigo-500"></i><span>LEVANT 自动化推演</span></div>
                <div class="flex flex-col items-end"><span class="text-slate-500 text-sm mb-1 font-bold">POWERED BY 絜矩 (QQ 2124223354)</span><span class="text-emerald-500 font-bold">LEVANT v1.05</span></div>
            </div>
        </div>

        <!-- TEMPLATE 2: NEWSPAPER (保留所有优化) -->
        <div v-else class="poster-newspaper">
            <div class="paper-grain"></div>
            
            <div class="news-header">
                <div class="brand">NEWS</div>
                <div class="meta">
                    <span>Vol. {{ timeline.length + 1 }}</span>
                    <span>{{ posterData.timeDisplay }}</span>
                    <span>{{ posterData.factionName }}</span>
                </div>
            </div>

            <h1 class="headline">{{ posterData.title }}</h1>

            <div v-if="posterData.badges && posterData.badges.length > 0" class="badges-row">
                 <div v-for="(badge, i) in posterData.badges" :key="i" class="stamp-badge">
                     <i :class="badge.icon"></i>
                     <span>{{ badge.label }}: {{ badge.val }}</span>
                 </div>
            </div>

            <div class="poster-md content-cols" v-html="posterData.content"></div>

            <div style="margin-top: auto; border-top: 1px solid #333; padding-top: 20px; text-align: center; font-family: monospace; font-size: 14px; color: #555;">
                LEVANT 自动化推演 | AUTOMATED REPORT | POWERED BY 絜矩 (QQ 2124223354)
            </div>
        </div>

    </div>

    <!-- Context Assembler Modal -->
    <transition name="fade">
        <div v-if="showContextModal" class="modal-mask" @click.self="showContextModal = false">
            <div class="glass-panel theme-rounded w-[900px] h-[90vh] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-5 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center shrink-0">
                    <div>
                        <h3 class="text-xl font-bold text-[var(--text-main)]"><i class="fa-solid fa-layer-group mr-2 text-indigo-400"></i>{{ t('modal_context_title') }}</h3>
                        <p class="text-xs text-[var(--text-dim)] mt-1">{{ t('modal_context_subtitle') }}</p>
                    </div>
                    <button @click="showContextModal = false" class="text-[var(--text-dim)] hover:text-[var(--text-main)] text-xl"><i class="fa-solid fa-times"></i></button>
                </div>

                <div class="flex-1 flex overflow-hidden">
                    <!-- 左侧：组装流水线 -->
                    <div class="w-1/2 p-5 bg-[var(--bg-panel)] overflow-y-auto border-r border-[var(--border-dim)]">
                        <!-- System Prompt -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-[var(--text-dim)] uppercase tracking-widest">System Prompt (Temp)</label>
                            </div>
                            <textarea v-model="tempSystemPrompt" class="w-full h-24 bg-[var(--bg-badge)] border border-[var(--border-dim)] theme-rounded-sm p-2 text-xs text-[var(--text-main)] font-mono resize-none"></textarea>
                        </div>
                        <!-- 模块列表 (拖拽排序) -->
                        <div class="space-y-4">
                            <div v-for="type in contextConfig.order" :key="type">
                                <!-- 🔴 当前指令 -->
                                <div v-if="type === 'current'" class="border border-red-500/30 theme-rounded-sm bg-red-900/10">
                                    <div class="p-2 bg-red-900/20 border-b border-red-500/20 flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" v-model="contextConfig.includeCurrent" class="accent-red-500">
                                            <span class="text-xs font-bold text-red-400 uppercase">🔴 {{ t('ctx_current') }}</span>
                                        </div>
                                        <div class="flex gap-1 text-[var(--text-dim)] text-[10px]">
                                            <button @click="moveContextItem('current', -1)"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('current', 1)"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                    <div v-if="contextConfig.includeCurrent" class="p-2 text-[10px] text-[var(--text-dim)] font-mono space-y-1">
                                        <div v-if="rawInput" class="truncate">CMD: {{ rawInput }}</div>
                                        <div v-if="editor.summary" class="truncate text-[var(--text-main)]">Summary: {{ editor.summary }}</div>
                                    </div>
                                </div>
                                <!-- 全局变量 -->
                                <div v-if="type === 'global'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" v-model="contextConfig.includeGlobal" class="accent-indigo-500">
                                            <span class="text-xs font-bold text-indigo-400 uppercase">{{ t('ctx_global') }}</span>
                                        </div>
                                        <div class="flex gap-1 text-[var(--text-dim)] text-[10px]">
                                            <button @click="moveContextItem('global', -1)"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('global', 1)"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <!-- 规则 -->
                                <div v-if="type === 'rules'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" v-model="contextConfig.includeRules" class="accent-indigo-500">
                                            <span class="text-xs font-bold text-amber-400 uppercase">{{ t('ctx_rules') }}</span>
                                        </div>
                                        <div class="flex gap-1 text-[var(--text-dim)] text-[10px]">
                                            <button @click="moveContextItem('rules', -1)"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('rules', 1)"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Lore -->
                                <div v-if="type === 'lore'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs font-bold text-emerald-400 uppercase">{{ t('ctx_lore') }}</span>
                                        </div>
                                        <div class="flex gap-1 text-[var(--text-dim)] text-[10px]">
                                            <button @click="moveContextItem('lore', -1)"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('lore', 1)"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                    <div class="p-2 space-y-1 max-h-40 overflow-y-auto">
                                        <div v-for="(entry, i) in contextConfig.loreList" :key="i" class="flex items-center gap-2 context-item" :class="{'active': entry.active, 'disabled': !entry.active}">
                                            <input type="checkbox" v-model="entry.active" class="accent-emerald-500">
                                            <span class="text-xs text-[var(--text-main)] truncate flex-1">{{ entry.keys }}</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Players -->
                                <div v-if="type === 'players'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs font-bold text-blue-400 uppercase">{{ t('ctx_entities') }}</span>
                                        </div>
                                        <div class="flex gap-1 text-[var(--text-dim)] text-[10px]">
                                            <button @click="moveContextItem('players', -1)"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('players', 1)"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                    <div class="p-2 space-y-1 max-h-40 overflow-y-auto">
                                        <div v-for="(p, i) in contextConfig.playerList" :key="i" class="flex items-center gap-2 context-item" :class="{'active': p.active, 'disabled': !p.active}">
                                            <input type="checkbox" v-model="p.active" class="accent-blue-500">
                                            <span class="text-xs text-[var(--text-main)] truncate flex-1">{{ p.name }}</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- History -->
                                <div v-if="type === 'history'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" v-model="contextConfig.includeHistory" class="accent-indigo-500">
                                            <span class="text-xs font-bold text-[var(--text-main)] uppercase">{{ t('ctx_history') }}</span>
                                        </div>
                                        <div class="flex gap-1 text-[var(--text-dim)] text-[10px]">
                                            <button @click="moveContextItem('history', -1)"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('history', 1)"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                    <div v-if="contextConfig.includeHistory" class="p-4 space-y-4">
                                        <!-- 深记忆控制 -->
                                        <div>
                                            <div class="flex justify-between text-[10px] font-bold text-emerald-500 mb-1 uppercase tracking-wider">
                                                <span>{{ t('ctx_hist_deep') }}</span>
                                                <span>{{ contextConfig.historyDeepDepth }} Turns</span>
                                            </div>
                                            <input type="range" v-model.number="contextConfig.historyDeepDepth" min="0" max="5" class="w-full h-1 bg-[var(--border-dim)] theme-rounded-sm appearance-none cursor-pointer accent-emerald-500">
                                        </div>
                                        <!-- 浅记忆控制 -->
                                        <div>
                                            <div class="flex justify-between text-[10px] font-bold text-[var(--text-dim)] mb-1 uppercase tracking-wider">
                                                <span>{{ t('ctx_hist_shallow') }}</span>
                                                <span>{{ contextConfig.historyShallowDepth }} Turns</span>
                                            </div>
                                            <input type="range" v-model.number="contextConfig.historyShallowDepth" min="0" max="20" class="w-full h-1 bg-[var(--border-dim)] theme-rounded-sm appearance-none cursor-pointer">
                                        </div>
                                        <div class="text-[10px] text-[var(--text-dim)] italic border-t border-[var(--border-dim)] pt-2 mt-2">
                                            Total Context: Past {{ contextConfig.historyShallowDepth + contextConfig.historyDeepDepth }} Turns <i class="fa-solid fa-arrow-right mx-1"></i> Present
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧：实时预览 -->
                    <div class="w-1/2 p-5 bg-[var(--bg-header)] flex flex-col">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-[var(--text-dim)] uppercase tracking-widest">Payload Preview (What AI Sees)</label>
                            <span class="text-xs font-mono text-indigo-400">{{ finalContextPreview.length }} chars</span>
                        </div>
                        <textarea readonly :value="finalContextPreview" class="flex-1 w-full bg-[var(--bg-deep)] border border-[var(--border-dim)] theme-rounded-sm p-4 text-xs font-mono text-[var(--text-dim)] resize-none outline-none leading-relaxed"></textarea>
                    </div>
                </div>

                <div class="p-5 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center shrink-0">
                    <div class="text-xs text-[var(--text-dim)]">AI will generate based on the preview content.</div>
                    <button @click="runAiInference" :disabled="isThinking" class="px-8 py-3 theme-rounded-sm bg-emerald-600 hover:bg-emerald-500 text-white font-bold text-sm shadow-lg transition flex items-center gap-2">
                        <i v-if="isThinking" class="fa-solid fa-circle-notch fa-spin"></i>
                        <i v-else class="fa-solid fa-bolt"></i>
                        EXECUTE
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <!-- Modals (Settings) -->
    <transition name="fade">
        <div v-if="showSettings" class="modal-mask" @click.self="showSettings=false">
            <div class="glass-panel theme-rounded w-[600px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-6 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center">
                    <h2 class="text-xl font-bold"><i class="fa-solid fa-sliders mr-2 text-[var(--text-dim)]"></i> {{ t('settings_title') }}</h2>
                    <button @click="showSettings = false" class="text-[var(--text-dim)] hover:text-[var(--text-main)] text-xl"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-8 space-y-8 bg-[var(--bg-panel)] max-h-[70vh] overflow-y-auto">
                    <!-- UI 设置 -->
                    <section>
                        <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-4 pb-2 border-b border-[var(--border-dim)]">{{ t('settings_ui') }}</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-[var(--text-dim)] mb-2">{{ t('settings_theme') }}</label>
                                <select v-model="ui.theme" class="w-full input-tech theme-rounded-sm p-3 text-sm outline-none">
                                    <option value="terminal">Terminal (Dark)</option>
                                    <option value="newspaper">Newspaper (Light)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-[var(--text-dim)] mb-2">{{ t('settings_lang') }}</label>
                                <select v-model="ui.lang" class="w-full input-tech theme-rounded-sm p-3 text-sm outline-none">
                                    <option value="zh">中文 (Chinese)</option>
                                    <option value="en">English</option>
                                    <option value="ja">日本語 (Japanese)</option>
                                </select>
                            </div>
                        </div>
                    </section>
                    
                    <section>
                        <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-4 pb-2 border-b border-[var(--border-dim)]">LLM API Configuration</h3>
                        
                        <!-- 快速预设按钮 -->
                        <div class="mb-4 flex gap-2 overflow-x-auto pb-2">
                            <button @click="applyPreset('Gemini')" class="px-3 py-1 theme-rounded-sm border border-[var(--border-dim)] text-[10px] font-bold hover:bg-emerald-600 hover:text-white transition">Gemini</button>
                            <button @click="applyPreset('Claude')" class="px-3 py-1 theme-rounded-sm border border-[var(--border-dim)] text-[10px] font-bold hover:bg-orange-700 hover:text-white transition">Claude</button>
                            <button @click="applyPreset('DeepSeek')" class="px-3 py-1 theme-rounded-sm border border-[var(--border-dim)] text-[10px] font-bold hover:bg-blue-600 hover:text-white transition">DeepSeek</button>
                            <button @click="applyPreset('Qwen')" class="px-3 py-1 theme-rounded-sm border border-[var(--border-dim)] text-[10px] font-bold hover:bg-purple-600 hover:text-white transition">Qwen</button>
                            <button @click="applyPreset('OpenAI')" class="px-3 py-1 theme-rounded-sm border border-[var(--border-dim)] text-[10px] font-bold hover:bg-gray-600 hover:text-white transition">OpenAI</button>
                            <button @click="applyPreset('SiliconFlow')" class="px-3 py-1 theme-rounded-sm border border-[var(--border-dim)] text-[10px] font-bold hover:bg-orange-600 hover:text-white transition">SiliconFlow</button>
                            <button @click="applyPreset('Others')" class="px-3 py-1 theme-rounded-sm border border-[var(--border-dim)] text-[10px] font-bold hover:bg-indigo-600 hover:text-white transition">Others</button>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-[var(--text-dim)] mb-2">Provider Type</label>
                                <select v-model="settings.api.provider" class="w-full input-tech theme-rounded-sm p-3 text-sm outline-none">
                                    <option value="Gemini">Gemini (Google)</option>
                                    <option value="Claude">Claude (Anthropic)</option>
                                    <option value="OpenAI">OpenAI Compatible (General)</option>
                                    <option value="Others">Others (Custom BaseURL)</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2">
                                    <label class="block text-xs font-bold text-[var(--text-dim)] mb-2">Base URL <span class="text-[10px] opacity-50">(Required for DeepSeek/Qwen)</span></label>
                                    <input v-model="settings.api.baseUrl" placeholder="e.g. https://api.deepseek.com" class="w-full input-tech theme-rounded-sm p-3 text-sm outline-none font-mono">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-xs font-bold text-[var(--text-dim)] mb-2">Model Name</label>
                                    <input v-model="settings.api.model" placeholder="e.g. deepseek-chat" class="w-full input-tech theme-rounded-sm p-3 text-sm outline-none font-mono">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-[var(--text-dim)] mb-2">API Key</label>
                                <input v-model="settings.api.key" type="password" class="w-full input-tech theme-rounded-sm p-3 text-sm outline-none">
                            </div>
                        </div>
                    </section>
                    
                    <!-- 新增代理设置区块 -->
                    <section>
                        <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-4 pb-2 border-b border-[var(--border-dim)]">Network Proxy</h3>
                        <div class="flex items-center gap-4 bg-[var(--bg-badge)] p-3 theme-rounded-sm border border-[var(--border-dim)]">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" v-model="settings.proxy.enabled" id="useProxy" class="accent-indigo-500 w-4 h-4">
                                <label for="useProxy" class="text-sm font-bold cursor-pointer select-none">Enable Local Proxy</label>
                            </div>
                            <div class="h-6 w-px bg-[var(--border-dim)] mx-2"></div>
                            <div class="flex-1 flex items-center gap-2" :class="{'opacity-50 pointer-events-none': !settings.proxy.enabled}">
                                <label class="text-xs font-mono text-[var(--text-dim)]">127.0.0.1:</label>
                                <input v-model="settings.proxy.port" placeholder="7890" class="w-20 input-tech theme-rounded-sm p-1.5 text-center text-sm font-mono outline-none">
                            </div>
                        </div>
                    </section>

                    <section>
                         <h3 class="text-xs font-bold text-emerald-400 uppercase tracking-widest mb-4 pb-2 border-b border-[var(--border-dim)]">System Prompt</h3>
                         <textarea v-model="settings.prompts.system" class="w-full h-32 input-tech theme-rounded-sm p-3 text-xs font-mono resize-none outline-none text-[var(--text-dim)]"></textarea>
                    </section>
                </div>
                <div class="p-6 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-end gap-4"><button @click="showSettings = false" class="px-5 py-2 theme-rounded-sm bg-[var(--bg-badge)] text-[var(--text-dim)] font-bold text-sm hover:text-[var(--text-main)]">{{ t('btn_cancel') }}</button><button @click="saveSettings" class="px-6 py-2 theme-rounded-sm bg-emerald-600 text-white font-bold text-sm shadow-lg hover:bg-emerald-500">{{ t('btn_save') }}</button></div>
            </div>
        </div>
    </transition>

    <!-- Modals (Faction) -->
    <transition name="fade">
        <div v-if="showFactionModal" class="modal-mask" @click.self="closeFactionModal">
            <div class="glass-panel theme-rounded w-[550px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-6 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center">
                    <h3 class="text-xl font-bold">{{ editingFaction.id ? t('modal_edit_entity') : t('modal_new_entity') }}</h3>
                    <button @click="closeFactionModal" class="text-[var(--text-dim)] hover:text-[var(--text-main)] text-xl"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-8 overflow-y-auto max-h-[70vh] space-y-6 bg-[var(--bg-panel)]">
                    <div><label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('label_name') }}</label><input v-model="editingFaction.name" class="w-full input-tech p-3 theme-rounded-sm text-lg font-bold outline-none"></div>
                    
                    <!-- [新增] 父级实体选择 -->
                    <div>
                        <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">Parent Entity (Hierarchy)</label>
                        <select v-model="editingFaction.parentId" class="w-full input-tech p-3 theme-rounded-sm text-sm font-mono outline-none">
                            <option value="">-- No Parent (Top Level) --</option>
                            <option v-for="p in players" :key="p.id" :value="p.id" v-show="p.id !== editingFaction.id">
                                {{ p.name }} ({{ p.id }})
                            </option>
                        </select>
                    </div>
                    <!-- [新增结束] -->

                    <div>
                        <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('label_icon_color') }}</label>
                        <div class="flex gap-4">
                            <input v-model="editingFaction.logo" placeholder="fa-solid fa-..." class="flex-1 input-tech p-3 theme-rounded-sm text-sm font-mono outline-none">
                            <div class="flex items-center gap-2 bg-[var(--bg-badge)] p-1 theme-rounded-sm border border-[var(--border-dim)]">
                                <input type="color" v-model="editingFaction.color" class="h-8 w-8 bg-transparent border-none cursor-pointer">
                                <input v-model="editingFaction.color" class="w-20 bg-transparent text-xs font-mono uppercase outline-none text-[var(--text-dim)]">
                            </div>
                        </div>
                    </div>
                    <div><label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('label_desc') }}</label><textarea v-model="editingFaction.desc" class="w-full h-28 input-tech p-3 theme-rounded-sm text-sm resize-none outline-none"></textarea></div>
                    <div class="pt-4 border-t border-[var(--border-dim)]">
                        <label class="block text-xs font-bold text-amber-500 uppercase mb-4">{{ t('label_stats') }}</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div v-for="field in stat_schema" :key="field.key"><label class="block text-[10px] text-[var(--text-dim)] font-bold mb-1">{{ field.label }}</label><input v-model="editingFaction.stats[field.key]" class="w-full input-tech p-2 theme-rounded-sm text-emerald-400 font-mono-tech font-bold text-sm outline-none"></div>
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center">
                    <button v-if="editingFaction.id" @click="deleteFaction" class="text-red-500 font-bold text-sm hover:text-red-400"><i class="fa-solid fa-trash mr-2"></i>{{ t('btn_destroy') }}</button><div v-else></div>
                    <div class="flex gap-4"><button @click="closeFactionModal" class="px-5 py-2 theme-rounded-sm bg-[var(--bg-badge)] text-[var(--text-dim)] font-bold text-sm hover:text-[var(--text-main)]">{{ t('btn_cancel') }}</button><button @click="saveFaction" class="px-6 py-2 theme-rounded-sm bg-indigo-600 text-white font-bold text-sm shadow-lg hover:bg-indigo-500">{{ t('btn_confirm') }}</button></div>
                </div>
            </div>
        </div>
    </transition>

    <!-- Modals (Save/Load) -->
    <transition name="fade">
        <div v-if="showSaveLoadModal" class="modal-mask" @click.self="showSaveLoadModal = false">
            <div class="glass-panel theme-rounded w-[550px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-6 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center">
                    <h3 class="text-xl font-bold"><i class="fa-solid fa-hard-drive mr-2 text-indigo-400"></i>{{ t('modal_files') }}</h3>
                    <button @click="showSaveLoadModal = false" class="text-[var(--text-dim)] hover:text-[var(--text-main)] text-xl"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-8 bg-[var(--bg-panel)]">
                    <div class="mb-6"><label class="block text-sm font-bold text-[var(--text-dim)] mb-3">{{ t('label_save_as') }}</label><div class="flex gap-3"><input v-model="newSaveFilename" @keyup.enter="saveGame(newSaveFilename)" placeholder="Filename..." class="flex-1 input-tech p-3 theme-rounded-sm text-sm font-mono outline-none"><button @click="saveGame(newSaveFilename)" :disabled="!newSaveFilename.trim()" class="px-6 py-2 bg-indigo-600 text-white theme-rounded-sm font-bold text-sm hover:bg-indigo-500 disabled:opacity-50">{{ t('btn_save') }}</button></div></div>
                    <div class="border-t border-[var(--border-dim)] pt-6">
                        <label class="block text-sm font-bold text-[var(--text-dim)] mb-3">{{ t('label_local_files') }}</label>
                        <div class="max-h-[40vh] overflow-y-auto space-y-2 pr-2">
                            <div v-for="file in saveFiles" :key="file" class="flex justify-between items-center bg-[var(--bg-badge)] p-3 theme-rounded-sm border border-[var(--border-dim)] hover:border-[var(--text-dim)] group">
                                <span class="font-mono text-sm text-emerald-400 font-bold"><i class="fa-solid fa-file-code mr-3 opacity-50"></i>{{ file }}</span>
                                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition"><button @click="loadGame(file)" class="px-3 py-1 bg-emerald-700 text-white theme-rounded-sm text-xs font-bold hover:bg-emerald-600">{{ t('btn_load') }}</button><button @click="saveGame(file)" class="px-3 py-1 bg-amber-700 text-white theme-rounded-sm text-xs font-bold hover:bg-amber-600">{{ t('btn_overwrite') }}</button><button @click="deleteSave(file)" class="px-3 py-1 bg-red-800 text-white theme-rounded-sm text-xs hover:bg-red-700"><i class="fa-solid fa-trash"></i></button></div>
                            </div>
                            <div v-if="saveFiles.length===0" class="text-center text-[var(--text-dim)] italic p-4">{{ t('msg_no_files') }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <!-- Modals (Script Gen) -->
<!-- Modals (Map Pin Editor) -->
    <transition name="fade">
        <div v-if="showPinModal" class="modal-mask" @click.self="showPinModal = false">
            <div class="glass-panel theme-rounded w-[400px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-4 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center">
                    <h3 class="text-lg font-bold"><i class="fa-solid fa-map-pin mr-2 text-emerald-500"></i>{{ editingPinIndex === -1 ? 'Add Map Marker' : 'Edit Marker' }}</h3>
                    <button @click="showPinModal = false" class="text-[var(--text-dim)] hover:text-[var(--text-main)]"><i class="fa-solid fa-times"></i></button>
                </div>
                
                <div class="p-6 bg-[var(--bg-panel)] space-y-4">
                    
                    <!-- 模式选择 -->
                    <div>
                        <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">Marker Type</label>
                        <div class="flex bg-[var(--bg-badge)] theme-rounded-sm p-1 border border-[var(--border-dim)]">
                            <button @click="pinForm.mode = 'entity'" :class="pinForm.mode === 'entity' ? 'bg-indigo-600 text-white shadow' : 'text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="flex-1 py-1.5 text-xs font-bold theme-rounded-sm transition">Entity</button>
                            <button @click="pinForm.mode = 'lore'" :class="pinForm.mode === 'lore' ? 'bg-emerald-600 text-white shadow' : 'text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="flex-1 py-1.5 text-xs font-bold theme-rounded-sm transition">Lore</button>
                            <button @click="pinForm.mode = 'custom'" :class="pinForm.mode === 'custom' ? 'bg-amber-600 text-white shadow' : 'text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="flex-1 py-1.5 text-xs font-bold theme-rounded-sm transition">Custom</button>
                        </div>
                    </div>

                    <!-- 选项 A: 实体选择 -->
                    <div v-if="pinForm.mode === 'entity'">
                        <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">Select Faction/Player</label>
                        <select v-model="pinForm.selectedId" class="w-full input-tech p-2 theme-rounded-sm text-sm font-bold outline-none">
                            <option value="" disabled>-- Choose Entity --</option>
                            <option v-for="p in players" :key="p.id" :value="p.id">{{ p.name }}</option>
                        </select>
                    </div>

                    <!-- 选项 B: 资料选择 -->
                    <div v-if="pinForm.mode === 'lore'">
                        <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">Select Lore Entry</label>
                        <select v-model="pinForm.selectedId" class="w-full input-tech p-2 theme-rounded-sm text-sm font-bold outline-none">
                            <option value="" disabled>-- Choose Lore --</option>
                            <option v-for="(entry, idx) in lorebook" :key="idx" :value="entry.keys">{{ entry.keys }}</option>
                        </select>
                        <p class="text-[10px] text-[var(--text-dim)] mt-1">Uses Lore keywords as link.</p>
                    </div>

                    <!-- 选项 C: 自定义 -->
                    <div v-if="pinForm.mode === 'custom'">
                        <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">Label Name</label>
                        <input v-model="pinForm.customLabel" placeholder="e.g. Ruined Tower" class="w-full input-tech p-2 theme-rounded-sm text-sm font-bold outline-none" @keyup.enter="saveMapPin">
                    </div>

                </div>
                    <!-- [新增] 通用外观设置 (所有模式都显示) -->
<!-- ▼▼▼▼▼▼ 找到这一块（原有的图标/颜色设置） ▼▼▼▼▼▼ -->
                    <div class="pt-4 border-t border-[var(--border-dim)] grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">Icon Class</label>
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 flex items-center justify-center bg-[var(--bg-badge)] theme-rounded-sm border border-[var(--border-dim)]">
                                    <i :class="pinForm.icon || 'fa-solid fa-question'" :style="{color: pinForm.color}"></i>
                                </div>
                                <input v-model="pinForm.icon" placeholder="fa-solid fa-..." class="flex-1 input-tech p-2 theme-rounded-sm text-xs font-mono outline-none">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">Color</label>
                            <div class="flex items-center gap-2">
                                <input type="color" v-model="pinForm.color" class="h-8 w-8 bg-transparent border-none cursor-pointer">
                                <input v-model="pinForm.color" class="flex-1 input-tech p-2 theme-rounded-sm text-xs font-mono outline-none uppercase">
                            </div>
                        </div>
                    </div>
                    <!-- ▲▲▲▲▲▲ 原有的图标/颜色设置结束 ▲▲▲▲▲▲ -->

                    <!-- ▼▼▼▼▼▼ 在这里插入新代码：坐标微调面板 ▼▼▼▼▼▼ -->
<!-- [修改后] 坐标微调面板 (同时支持 Pin 和 Region) -->
                    <!-- 移除了最外层的 v-if，现在总是显示 -->
                    <div class="pt-4 border-t border-[var(--border-dim)]">
                        <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">
                            <!-- 标题动态变化 -->
                            {{ editingRegionIndex !== -2 ? 'Label Position (Region)' : 'Pin Position' }}
                        </label>
                        
                        <div class="flex gap-4">
                            <!-- X轴微调 -->
                            <div class="flex-1">
                                <label class="text-[9px] text-[var(--text-dim)] font-mono">POS X (%)</label>
                                <div class="flex items-center gap-1">
                                    <!-- 分支 A: 如果是地块，绑定 centerX -->
                                    <input v-if="editingRegionIndex !== -2" type="number" step="0.5" v-model="pinForm.centerX" class="w-full input-tech p-2 theme-rounded-sm text-xs font-mono outline-none">
                                    <!-- 分支 B: 如果是点，绑定 x -->
                                    <input v-else type="number" step="0.5" v-model="pinForm.x" class="w-full input-tech p-2 theme-rounded-sm text-xs font-mono outline-none">
                                </div>
                            </div>
                            
                            <!-- Y轴微调 -->
                            <div class="flex-1">
                                <label class="text-[9px] text-[var(--text-dim)] font-mono">POS Y (%)</label>
                                <div class="flex items-center gap-1">
                                    <!-- 分支 A: 如果是地块，绑定 centerY -->
                                    <input v-if="editingRegionIndex !== -2" type="number" step="0.5" v-model="pinForm.centerY" class="w-full input-tech p-2 theme-rounded-sm text-xs font-mono outline-none">
                                    <!-- 分支 B: 如果是点，绑定 y -->
                                    <input v-else type="number" step="0.5" v-model="pinForm.y" class="w-full input-tech p-2 theme-rounded-sm text-xs font-mono outline-none">
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-[9px] text-emerald-500 mt-2 opacity-70">
                            <i class="fa-solid fa-circle-info mr-1"></i>
                            {{ editingRegionIndex !== -2 ? 'Fine-tune label center.' : 'Fine-tune pin location.' }}
                        </p>
                    </div>
                    <!-- ▲▲▲▲▲▲ 插入结束 ▲▲▲▲▲▲ -->
                <div class="p-4 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between">
                    <!-- 删除按钮 (仅编辑时显示) -->
                    <button v-if="editingPinIndex !== -1" @click="deleteMapPin" class="text-red-500 hover:text-red-400 text-xs font-bold px-3 py-2 border border-red-900/30 theme-rounded-sm bg-red-900/10"><i class="fa-solid fa-trash mr-1"></i> Remove</button>
                    <div v-else></div> <!-- 占位 -->

                    <div class="flex gap-2">
                        <button @click="showPinModal = false" class="px-4 py-2 theme-rounded-sm border border-[var(--border-dim)] text-xs font-bold hover:bg-[var(--bg-panel)]">Cancel</button>
                        <button @click="saveMapPin" class="px-4 py-2 theme-rounded-sm bg-emerald-600 text-white text-xs font-bold shadow-lg hover:bg-emerald-500">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    </transition>
    <transition name="fade">
        <div v-if="showScriptGenModal" class="modal-mask" @click.self="showScriptGenModal = false">
            <div class="glass-panel theme-rounded w-[600px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-6 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center"><h3 class="text-xl font-bold">{{ t('modal_script_gen') }}</h3><button @click="showScriptGenModal = false" class="text-[var(--text-dim)] hover:text-[var(--text-main)]"><i class="fa-solid fa-times"></i></button></div>
                <div class="p-8 bg-[var(--bg-panel)] gap-4 flex flex-col max-h-[70vh] overflow-y-auto">
                    <p class="text-sm text-[var(--text-dim)] bg-[var(--bg-badge)] p-4 theme-rounded-sm border border-[var(--border-dim)]">{{ t('msg_script_gen_hint') }}</p>
                    
                    <!-- 文件上传区域 -->
                    <div class="border-2 border-dashed border-[var(--border-dim)] theme-rounded-sm p-4 hover:border-indigo-500/50 transition bg-[var(--bg-badge)]">
                        <label class="cursor-pointer flex flex-col items-center justify-center gap-2">
                            <i class="fa-solid fa-cloud-arrow-up text-2xl text-[var(--text-dim)]"></i>
                            <span class="text-xs font-bold text-[var(--text-dim)] uppercase tracking-wide">Upload Reference Docs / Images</span>
                            <input type="file" multiple @change="handleScriptFiles" class="hidden" accept=".txt,.md,.json,.png,.jpg,.jpeg">
                        </label>
                        <div v-if="scriptAttachments.length > 0" class="mt-3 grid grid-cols-2 gap-2">
                            <div v-for="(file, idx) in scriptAttachments" :key="idx" class="text-[10px] bg-[var(--bg-deep)] p-2 border border-[var(--border-dim)] truncate flex justify-between items-center text-[var(--text-main)]">
                                <span><i :class="file.type.includes('image') ? 'fa-regular fa-image' : 'fa-regular fa-file-lines'" class="mr-1"></i>{{ file.name }}</span>
                                <button @click="scriptAttachments.splice(idx,1)" class="text-red-400 hover:text-red-300"><i class="fa-solid fa-times"></i></button>
                            </div>
                        </div>
                    </div>

                    <textarea v-model="scriptGenPrompt" class="w-full h-32 input-tech p-4 theme-rounded-sm text-base resize-none outline-none" placeholder="Prompt (e.g., 'A grimdark fantasy world where magic consumes the soul...')"></textarea>
                </div>
                <div class="p-6 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-end">
                    <button @click="generateScript" :disabled="isThinking || !scriptGenPrompt.trim()" class="w-full py-4 theme-rounded-sm bg-gradient-to-r from-indigo-600 to-indigo-700 text-white font-bold text-lg tracking-widest shadow-lg hover:from-indigo-500 hover:to-indigo-600 flex justify-center items-center gap-3 disabled:opacity-50"><i :class="isThinking ? 'fa-solid fa-circle-notch fa-spin' : 'fa-solid fa-meteor'"></i> {{ isThinking ? t('status_generating') : t('btn_start_gen') }}</button>
                </div>
            </div>
        </div>
    </transition>
</div>

<script>
    const { createApp } = Vue;
    const API_BASE = "http://127.0.0.1:8000";

    createApp({
        data() {
            return {
                serverConnected: false, isThinking: false, currentSaveFile: 'savegame.json',
                showSettings: false, showFactionModal: false, showSaveLoadModal: false, showScriptGenModal: false, showContextModal: false,
                saveFiles: [], newSaveFilename: '', 
                mapToolMode: 'view',
                // --- 输入相关 ---
                scriptGenPrompt: '', 
                rawInput: '',
                godModeInput: '', // [新增] 上帝模式输入
                scriptAttachments: [], // [新增] 剧本生成附件列表
                
                editingFaction: { id: '', name: '', logo: '', stats: {} },
                editingTurnId: null, editingEventId: null,
                tabs: { left: 'players', right: 'input' },
                // [新增] 地图打点模态框状态
                showPinModal: false,
                editingPinIndex: -1, // -1 表示新建，>=0 表示编辑索引
                pinForm: {
                    x: 0, y: 0,
                    mode: 'entity', // entity | lore | custom
                    selectedId: '', // 用于 entity id 或 lore keys
                    customLabel: ''
                },
                
                // --- UI Settings ---
                ui: { theme: 'terminal', lang: 'zh' },

                settings: {
                    api: { provider: 'Gemini', baseUrl: '', model: 'gemini-2.5-flash', key: '' },
                    proxy: { enabled: true, port: '7890' }, 
                    prompts: {
                        // --- 1. 日常推演 (Daily Deduction) - v2 优化版 ---
                        system: `你是一个辅助世界推演的 AI 引擎。
                    【任务】
                    根据提供的“世界上下文”和“用户指令”，推演下一个时间段发生的事件。

                    【输出规则】
                    1. **只输出纯 JSON**：不要包含 \`\`\`json 或 markdown 标记。
                    2. **语言与篇幅**：内容描述请使用中文。**"content" 字段的详细描述必须超过 100 字**，以保证剧情的丰富性。
                    3. **属性值多样性（关键）**：实体的属性值 (stats) 不必是纯数值。**请优先使用8个字以内的描述性文本**来表达状态，例如 "政策": "重铸荣光", "稳定度": "暴乱(D)", "外交立场": "孤立主义"。
                    4. **状态变更逻辑**：impacts 中的 "oldValue" 必须等于当前状态，"newValue" 是推演后的新状态（可以是数值也可以是文本）。
                    5. **属性键名**：attrKey 必须严格对应 stat_schema 中定义的 key。

                    【JSON 结构模板】
                    {
                    "factionId": "行动方ID (如 'p1' 或 'global')",
                    "timeStart": "开始时间",
                    "timeEnd": "结束时间",
                    "summary": "事件简短标题",
                    "content": "详细剧情描述 (支持 Markdown, 必须超过 100 字)",
                    "impacts": [
                        {
                        "targetId": "受影响实体ID",
                        "targetName": "实体名称",
                        "attrKey": "属性Key (如 'stab')",
                        "oldValue": "戒严(C)",
                        "newValue": "暴乱(D)"
                        }
                    ]
                    }`,

                        // --- 2. 剧本生成 (Script Generator) - v4 优化版 ---
                        script_generator: `你是一个世界设定生成器，严格按照指定的 JSON 结构输出。

                    【输出规则】
                    1. **只输出纯 JSON**：你的整个回应必须是一个单一、合法的 JSON 对象，不要包含任何解释或 markdown 标记。
                    2. **严格遵守结构**：必须严格按照下面【JSON 结构详解】中定义的字段名和数据类型进行输出。
                    3. **语言与篇幅**：所有描述性内容请使用中文。**timeline 中每个 event 的 "content" 字段必须超过 100 字**。
                    4. **属性值多样性（关键）**：为 players 的 stats 赋值时，**请大胆使用8个字以内的描述性文本而非纯数值**，以创造一个更生动、非量化的世界。

                    【JSON 结构与范例】

                    {
                    "stat_schema": [
                        { "key": "leader", "label": "领袖" },
                        { "key": "policy", "label": "当前国策" },
                        { "key": "stab", "label": "稳定度" },
                        { "key": "dip_stance", "label": "外交立场" }
                    ],
                    "global_vars": [
                        { "key": "当前年份", "value": "1096" }
                    ],
                    "lorebook": [
                        {
                        "keys": "碎片大厦,OS", 
                        "content": "一座耸入云端的巨型建筑，其操作系统连接着整个城市...",
                        "mode": "auto"
                        }
                    ],
                    "players": [
                        {
                        "id": "p_kazdel",
                        "name": "卡兹戴尔",
                        "logo": "fa-solid fa-chess-rook",
                        "color": "#881c1c",
                        "desc": "一个历经战火、寻求复兴的移动城邦。",
                        "stats": {
                            "leader": "摄政王特雷西斯",
                            "policy": "重铸荣光",
                            "stab": "暴乱(D)",
                            "dip_stance": "孤立主义"
                        }
                        }
                    ],
                    "timeline": [
                        {
                        "id": 1,
                        "timeRange": "1096年 冬",
                        "events": [
                            {
                            "factionId": "p_kazdel",
                            "timeStart": "冬初",
                            "timeEnd": "冬末",
                            "summary": "摄政王颁布《荣光法典》",
                            "content": "（此处应有超过 100 字的详细描述）在凛冬的寒风中，摄政王特雷西斯于王庭之内正式颁布了《荣光法典》。该法典旨在重塑卡兹戴尔的军事与社会结构，强调纪律与集体主义，要求所有公民为即将到来的“最终胜利”贡献一切。此举在军队中获得了广泛支持，但也激化了与主张维持传统的萨卡兹部族长老之间的矛盾。",
                            "impacts": [
                                {
                                "targetId": "p_kazdel",
                                "targetName": "卡兹戴尔",
                                "attrKey": "stab",
                                "attrLabel": "稳定度",
                                "newValue": "紧张(C-)"
                                }
                            ]
                            }
                        ]
                        }
                    ]
                    }`,

                        // --- 3. 上帝模式 (God Mode) - 保持不变 ---
                        god_mode: `你是一个智能数据库管理员，能够理解并执行对 JSON 数据的关联修改。

                        【核心指令】
                        根据用户的自然语言指令，修改当前的 JSON 状态。你必须返回一个包含所有被修改的顶层字段的 JSON 对象。

                        【关键规则：关联修改】
                        **当用户的指令涉及到添加一个新的实体属性时，你必须同时执行以下两个操作：**
                        1.  在 \`stat_schema\` 数组中，为这个新属性添加一个新的定义对象，格式为 \`{ "key": "英文ID", "label": "中文名" }\`。
                        2.  在 \`players\` 数组中，为每一个实体对象的 \`stats\` 添加这个新的属性键值对。

                        【严重警告：数组完整性】
                        当你修改任何数组（如 \`players\`, \`stat_schema\`）时，**必须返回该数组的完整内容**（包括未修改的项），否则数据会丢失。

                        【输出规则】
                        1. **只输出纯 JSON**。
                        2. 返回一个包含**所有**被修改的顶层字段的 JSON 对象。例如，如果同时修改了 \`stat_schema\` 和 \`players\`，你的输出就必须是 \`{ "stat_schema": [...], "players": [...] }\`。

                        【示例】
                        用户指令: "给所有实体增加一个'忠诚度(loyalty)'属性，默认为'普通'"
                        正确输出:
                        {
                        "stat_schema": [
                            { "key": "leader", "label": "领袖" }, 
                            // ... 其他旧属性 ...
                            { "key": "loyalty", "label": "忠诚度" } // ★ 新增的属性定义
                        ],
                        "players": [
                            { 
                            "id": "p1", 
                            "stats": { 
                                "leader": "...", 
                                "loyalty": "普通" // ★ 为 p1 新增的属性
                            } 
                            },
                            { 
                            "id": "p2", 
                            "stats": { 
                                "leader": "...", 
                                "loyalty": "普通" // ★ 为 p2 新增的属性
                            }
                            }
                        ]
                        }`
                    }
                },
                
                // --- i18n Dictionary ---
                translations: {
                    app_title: { zh: "LEVANT 自动化推演", en: "LEVANT Auto-Deduction", ja: "LEVANT 自動演繹" },
                    status_online: { zh: "系统联机", en: "SYSTEM ONLINE", ja: "システム稼働中" },
                    status_offline: { zh: "离线模式", en: "OFFLINE MODE", ja: "オフライン" },
                    next_turn_label: { zh: "下一回合 / 序列", en: "NEXT TURN / SEQ", ja: "次のターン / シーケンス" },
                    auto: { zh: "自动", en: "AUTO", ja: "自動" },
                    btn_script_gen: { zh: "剧本生成", en: "Script Gen", ja: "シナリオ生成" },
                    btn_files: { zh: "档案管理", en: "Files", ja: "ファイル管理" },
                    tab_world: { zh: "世界", en: "World", ja: "世界" },
                    tab_entity: { zh: "实体", en: "Entities", ja: "実体" },
                    tab_lore: { zh: "资料", en: "Lore", ja: "資料" },
                    tab_rules: { zh: "规则", en: "Rules", ja: "ルール" },
                    btn_add_global: { zh: "添加全局状态", en: "Add Global Var", ja: "グローバル変数を追加" },
                    btn_new_entity: { zh: "注册新实体", en: "New Entity", ja: "新規実体登録" },
                    btn_add_lore: { zh: "新增资料条目", en: "Add Lore Entry", ja: "資料エントリ追加" },
                    btn_export_rules: { zh: "导出规则海报", en: "Export Rules", ja: "ルール出力" },
                    btn_add_rule: { zh: "添加属性字段", en: "Add Attribute", ja: "属性フィールド追加" },
                    msg_no_events: { zh: "等待情报输入...", en: "Awaiting Intelligence...", ja: "情報入力待ち..." },
                    btn_copy: { zh: "复制", en: "Copy", ja: "コピー" },
                    btn_delete: { zh: "删除", en: "Delete", ja: "削除" },
                    tab_pending: { zh: "待决", en: "Pending", ja: "保留中" },
                    tab_console: { zh: "指令台", en: "Console", ja: "コンソール" },
                    tab_godmode: { zh: "上帝模式", en: "God Mode", ja: "神モード" }, // [新增]
                    msg_empty_queue: { zh: "队列为空", en: "Queue Empty", ja: "キューが空です" },
                    placeholder_input: { zh: "// 输入原始指令...\n例如: #Cortex 试图入侵 #NeoTokyo", en: "// Input raw command...\ne.g., #Cortex attempts to hack #NeoTokyo", ja: "// コマンドを入力...\n例: #Cortex が #NeoTokyo に侵入を試みる" },
                    ai_core_label: { zh: "AI 智能核心 (Active)", en: "AI CORE (Active)", ja: "AI コア (稼働中)" },
                    btn_ai_deduce: { zh: "AI 智能补全 / 推演", en: "AI DEDUCTION / AUTO-COMPLETE", ja: "AI 自動補完 / 演繹" },
                    status_thinking: { zh: "正在进行战术推演...", en: "Calculating Strategy...", ja: "戦術演算中..." },
                    label_actor: { zh: "行动实体", en: "Actor", ja: "行動主体" },
                    label_start: { zh: "开始", en: "Start", ja: "開始" },
                    label_end: { zh: "结束", en: "End", ja: "終了" },
                    option_ai_auto: { zh: "AI 自动判断", en: "AI Auto-Detect", ja: "AI 自動判定" },
                    option_global: { zh: "全局事件", en: "Global Event", ja: "グローバルイベント" },
                    label_summary: { zh: "标题摘要", en: "Summary", ja: "要約" },
                    label_impact: { zh: "状态变更计算", en: "State Impact Calc", ja: "状態変化計算" },
                    label_details: { zh: "详细情报档案", en: "Detailed Intelligence", ja: "詳細情報アーカイブ" },
                    btn_add_pending: { zh: "加入待决序列", en: "Add to Pending", ja: "保留リストに追加" },
                    btn_commit: { zh: "执行推演 (Commit)", en: "COMMIT TURN", ja: "ターン実行 (Commit)" },
                    modal_context_title: { zh: "上下文装配与推演", en: "Context Assembler", ja: "コンテキストアセンブラ" },
                    modal_context_subtitle: { zh: "确认 AI 将接收到的“世界切片”以及“当前指令”。", en: "Confirm the 'World Slice' and 'Action' sent to AI.", ja: "AIに送信する「世界スライス」と「現在指令」を確認してください。" },
                    ctx_current: { zh: "当前指令与草稿", en: "Current Action", ja: "現在の指令" },
                    ctx_global: { zh: "世界全局变量", en: "Global Vars", ja: "グローバル変数" },
                    ctx_rules: { zh: "属性规则定义", en: "Stat Rules", ja: "属性ルール" },
                    ctx_lore: { zh: "资料设定 (Lore)", en: "Lore Entries", ja: "資料設定" },
                    ctx_entities: { zh: "参与实体", en: "Active Entities", ja: "参加実体" },
                    ctx_hist_deep: { zh: "深层记忆 (近 - 含详情)", en: "Deep Mem (Recent - Full)", ja: "深層記憶 (詳細)" },
                    ctx_hist_shallow: { zh: "浅层记忆 (远 - 仅摘要)", en: "Shallow Mem (Older - Summary)", ja: "浅層記憶 (要約)" },
                    settings_title: { zh: "系统配置", en: "System Settings", ja: "システム設定" },
                    settings_ui: { zh: "界面与语言", en: "Interface & Language", ja: "UIと言語" },
                    settings_theme: { zh: "界面风格", en: "Theme", ja: "テーマ" },
                    settings_lang: { zh: "系统语言", en: "Language", ja: "言語" },
                    btn_cancel: { zh: "取消", en: "Cancel", ja: "キャンセル" },
                    btn_save: { zh: "保存配置", en: "Save Config", ja: "設定保存" },
                    modal_edit_entity: { zh: "编辑实体档案", en: "Edit Entity", ja: "実体編集" },
                    modal_new_entity: { zh: "注册新实体", en: "Register Entity", ja: "新規実体登録" },
                    label_name: { zh: "名称", en: "Name", ja: "名称" },
                    label_icon_color: { zh: "图标 & 颜色", en: "Icon & Color", ja: "アイコン & 色" },
                    label_desc: { zh: "描述", en: "Description", ja: "説明" },
                    label_stats: { zh: "属性面板", en: "Stats", ja: "ステータス" },
                    btn_destroy: { zh: "销毁数据", en: "Destroy Data", ja: "データ破棄" },
                    btn_confirm: { zh: "确认", en: "Confirm", ja: "確認" },
                    modal_files: { zh: "档案管理", en: "File Management", ja: "ファイル管理" },
                    label_save_as: { zh: "另存为", en: "Save As", ja: "名前を付けて保存" },
                    label_local_files: { zh: "本地档案", en: "Local Files", ja: "ローカルファイル" },
                    btn_load: { zh: "读取", en: "Load", ja: "読込" },
                    btn_overwrite: { zh: "覆盖", en: "Overwrite", ja: "上書" },
                    msg_no_files: { zh: "无存档", en: "No Files", ja: "ファイルなし" },
                    modal_script_gen: { zh: "AI 剧本生成", en: "AI Script Generation", ja: "AI シナリオ生成" },
                    msg_script_gen_hint: { zh: "上传设定集、地图图片或描述您想要的世界观。AI 将自动生成实体、属性规则和开场。", en: "Upload lore, maps, or describe your world. AI will generate entities, rules, and intro.", ja: "設定資料、地図をアップロード、または世界観を記述。AIが実体、ルール、オープニングを生成します。" },
                    status_generating: { zh: "正在构建世界...", en: "Constructing World...", ja: "世界構築中..." },
                    btn_start_gen: { zh: "初始化剧本生成", en: "Initialize Generation", ja: "生成開始" }
                },

                stat_schema: [], lorebook: [], players: [], timeline: [], global_vars: [],
                map_data: { image: '', pins: [], regions: [] },

                // [新增] 地图交互模式状态
                mapToolMode: 'pin', // 'pin' | 'region'
                isProcessingRegion: false,
                editingRegionIndex: -2, // -2:无, -1:新增, >=0:编辑
                
                // [新增] 地图视图控制状态
                mapView: {
                    scale: 1,      // 缩放比例，1 = 100% 宽度
                    x: 0,          // X轴偏移 (px)
                    y: 0,          // Y轴偏移 (px)
                    isDragging: false,
                    startX: 0,
                    startY: 0
                },
                showMap: false, // <--- [新增] 控制中心区域显示地图还是情报流
                pendingTurnRange: "", pendingEvents: [],
                editor: { factionId: '', timeStart: '', timeEnd: '', summary: '', content: '', impacts: [] },
                impactForm: { targetId: '', attrKey: '', newValue: '' },
                editImpactForm: { targetId: '', attrKey: '', newValue: '' }, // 新增：用于历史事件编辑的临时表单
                
                posterData: { title: '', factionName: '', color: '', icon: '', content: '', badges: [], timeDisplay: '' },
                quoteIdx: 0,
                quotes: [ "岁寒，然后知松柏之后凋也", "看看演员 王公 游民 盗贼的心电图", "人生若只如初见，何事秋风悲画扇", "我还想和你谈论宇宙和天空", "西郊有密林，助君出重围", "我一无所有 只有一颗赤子之心", "高树多悲风，海水扬其波", "你方唱罢我登场，反认他乡是故乡", "空山新林归鹧鸪，世间繁华梦一出", "昨夜西风凋碧树，独上高楼，望尽天涯路", "我听见那声音向我严正发问 我为明天尽些什么义务", "六朝何事？只成门户私计！" ],
                
                tempSystemPrompt: "",
                contextConfig: {
                    includeGlobal: true, includeRules: true, includeHistory: true, includeCurrent: true,
                    historyDeepDepth: 1, historyShallowDepth: 3, 
                    loreList: [], playerList: [],
                    order: ['global', 'rules', 'lore', 'players', 'history', 'current']
                }
            }
        },
        watch: {
            // 1. 监听 UI 主题变化，实时切换 CSS 变量
            'ui.theme': {
                handler(newTheme) {
                    document.body.setAttribute('data-theme', newTheme);
                },
                immediate: true
            },

            // 2. [新增] 监听地图打点表单中的 selectedId 变化
            // 当用户在下拉框选择了一个实体或资料时，自动填充图标和颜色
            'pinForm.selectedId': function(newVal) {
                // 如果是“实体(Entity)”模式
                if (this.pinForm.mode === 'entity' && newVal) {
                    const p = this.players.find(x => x.id === newVal);
                    if (p) {
                        // 自动填入该实体的 Logo 和 颜色
                        this.pinForm.icon = p.logo || 'fa-solid fa-users';
                        this.pinForm.color = p.color || '#ffffff';
                    }
                }
                // 如果是“资料(Lore)”模式
                else if (this.pinForm.mode === 'lore' && newVal) {
                    // 如果当前还是默认图标，或者是空的，就自动填入“书签”图标和绿色
                    // 这样设计是为了防止覆盖用户刚刚手动修改过的自定义图标
                    const currentIcon = this.pinForm.icon;
                    if (!currentIcon || currentIcon === 'fa-solid fa-map-pin' || currentIcon === 'fa-solid fa-users') {
                        this.pinForm.icon = 'fa-solid fa-book-bookmark';
                        this.pinForm.color = '#10b981'; // 资料默认给个翡翠绿
                    }
                }
            },
            
            // 3. [新增] 监听模式切换，重置一下默认值，避免图标残留
            'pinForm.mode': function(newMode) {
                if (newMode === 'custom') {
                    // 切换到自定义模式时，如果当前没有图标，给一个默认的
                    if (!this.pinForm.icon) {
                        this.pinForm.icon = 'fa-solid fa-map-pin';
                        this.pinForm.color = '#f59e0b'; // 琥珀色
                    }
                }
                // 切换到实体模式时，清空 selectedId 以便触发下一次选择监听
                if (newMode === 'entity') {
                   // 这里不需要强制清空 selectedId，保留上次的选择体验可能更好
                   // 但如果想重置，可以在这里写 this.pinForm.selectedId = '';
                }
            }
        },
        async mounted() {
            const savedSettings = localStorage.getItem('levant_settings');
            if (savedSettings) {
                try {
                    const parsed = JSON.parse(savedSettings);
                    if(parsed.api) this.settings.api = { ...this.settings.api, ...parsed.api };
                    if(parsed.proxy) this.settings.proxy = { ...this.settings.proxy, ...parsed.proxy }; 
                    if(parsed.prompts) this.settings.prompts = { ...this.settings.prompts, ...parsed.prompts };
                    if(parsed.ui) this.ui = { ...this.ui, ...parsed.ui }; 
                } catch(e) { console.error("Failed to load settings", e); }
            }

            document.body.setAttribute('data-theme', this.ui.theme);

            await this.loadGame(this.currentSaveFile);
            if (this.map_data.image) {
                // 使用 $nextTick 确保 DOM 里的 Canvas 已经渲染出来
                this.$nextTick(() => this.initMapCanvas(this.map_data.image));
            }
            window.addEventListener('beforeunload', () => { if(this.serverConnected) this.saveGame('autosave.json'); });
            
            setInterval(() => {
                let nextIdx; do { nextIdx = Math.floor(Math.random() * this.quotes.length); } while (nextIdx === this.quoteIdx); 
                this.quoteIdx = nextIdx;
            }, 6000);
        },
        computed: {

            currentAttrValue() {
                if (!this.impactForm.targetId || !this.impactForm.attrKey) return '---';
                const p = this.players.find(x => x.id === this.impactForm.targetId);
                return p ? (p.stats[this.impactForm.attrKey] || 'N/A') : '???';
            },
            finalContextPreview() {
                let preview = "";
                this.contextConfig.order.forEach(type => {
                    if (type === 'global' && this.contextConfig.includeGlobal) {
                        preview += `【${this.t('ctx_global')}】\n${this.global_vars.map(g => `${g.key}: ${g.value}`).join('\n')}\n\n`;
                    }
                    if (type === 'rules' && this.contextConfig.includeRules) {
                        preview += `【${this.t('ctx_rules')}】\n${this.stat_schema.map(s => `${s.key}=${s.label}`).join(', ')}\n\n`;
                    }
                    if (type === 'lore') {
                        const activeLore = this.contextConfig.loreList.filter(l => l.active);
                        if (activeLore.length > 0) preview += `【${this.t('ctx_lore')}】\n${activeLore.map(l => `> [${l.keys}]: ${l.content}`).join('\n')}\n\n`;
                    }
                    if (type === 'players') {
                        // 使用新的层级构建方法
                        preview += `【${this.t('ctx_entities')} & HIERARCHY】\n`;
                        preview += `Rule: Parent entity status changes imply effects on children. Child actions aggregate to affect parents.\n`;
                        preview += this.buildHierarchyString();
                        preview += `\n\n`;
                    }
                    
                    // [新增] 注入地图信息 (假设我们把它加到 players 后面或者 global 里面，这里直接追加)
                    if (this.map_data.pins.length > 0) {
                        preview += `【TACTICAL MAP DATA】\n`;
                        preview += this.buildMapString();
                        preview += `\n`;
                    }
                    if (type === 'history' && this.contextConfig.includeHistory) {
                        let historyContext = `【${this.t('ctx_history')}】\n`;
                        const deepCount = this.contextConfig.historyDeepDepth;
                        const shallowCount = this.contextConfig.historyShallowDepth;
                        const totalNeeded = deepCount + shallowCount;
                        const startIndex = Math.max(0, this.timeline.length - totalNeeded);
                        const relevantTurns = this.timeline.slice(startIndex);
                        
                        relevantTurns.forEach((turn, idx) => {
                            const thresholdIndex = relevantTurns.length - deepCount;
                            const isDeep = idx >= thresholdIndex;

                            historyContext += `=== Turn ${turn.id} (${turn.timeRange}) ===\n`;
                            
                            turn.events.forEach(e => {
                                historyContext += `• [${e.timeStart}-${e.timeEnd}] ${e.summary}\n`;
                                if (e.impacts && e.impacts.length) { 
                                    historyContext += `  -> Impact: ${e.impacts.map(i => `${i.targetName}.${i.attrLabel}: ${i.oldValue} -> ${i.newValue}`).join('; ')}\n`; 
                                }
                                if (isDeep && e.content) {
                                    historyContext += `  -> DETAILS:\n${e.content.replace(/^/gm, '    ')}\n`; 
                                }
                            });
                            historyContext += `\n`; 
                        });
                        preview += historyContext;
                    }
                    if (type === 'current' && this.contextConfig.includeCurrent) {
                        preview += `【${this.t('ctx_current')}】\n`;
                        if (this.rawInput) preview += `> CMD: ${this.rawInput}\n`;
                        if (this.editor.factionId) preview += `> ActorID: ${this.editor.factionId}\n`;
                        if (this.editor.timeStart) preview += `> Time: ${this.editor.timeStart} - ${this.editor.timeEnd}\n`;
                        if (this.editor.summary) preview += `> Title Draft: ${this.editor.summary}\n`;
                        if (this.editor.content) preview += `> Content Draft: ${this.editor.content}\n`;
                        if (this.editor.impacts.length) {
                            preview += `> Planned Impacts: ${this.editor.impacts.map(i => `${i.targetName}.${i.attrLabel}: ${i.oldValue} -> ${i.newValue}`).join('; ')}\n`;
                        }
                        preview += `\n`;
                    }
                });
                return preview;
            }
        },
        methods: {

            getFinalPinIcon(pin) {
                // 1. 如果 Pin 本身有自定义图标，优先使用
                if (pin.icon) return pin.icon;
                
                // 2. 如果没有自定义，且关联了实体，使用实体的 Logo
                if (pin.type === 'entity' || (!pin.type && pin.linkId)) {
                    const p = this.players.find(x => x.id === pin.linkId);
                    if (p && p.logo) return p.logo;
                }
                
                // 3. 默认图标 (区分资料点和普通点)
                if (pin.type === 'lore') return 'fa-solid fa-book-bookmark';
                return 'fa-solid fa-map-pin';
            },

            getFinalPinColor(pin) {
                // 1. 优先使用 Pin 自定义颜色
                if (pin.color) return pin.color;
                
                // 2. 使用实体颜色
                if (pin.type === 'entity' || (!pin.type && pin.linkId)) {
                    const p = this.players.find(x => x.id === pin.linkId);
                    if (p && p.color) return p.color;
                }
                
                // 3. 默认颜色
                if (pin.type === 'lore') return '#10b981'; // Emerald
                return '#f59e0b'; // Amber
            },


            // 1. 上传图片 (上传后自动重置视图)
// 1. 上传图片 (上传后自动重置视图，并初始化 Canvas)
            handleMapUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.map_data.image = e.target.result;
                    this.map_data.regions = []; // 换新地图时清空地块
                    this.resetMapView();
                    
                    this.saveGame('autosave.json');
                    
                    // [新增] 初始化分析用 Canvas
                    this.$nextTick(() => this.initMapCanvas(this.map_data.image));
                };
                reader.readAsDataURL(file);
            },
            
            // [新增] Canvas 初始化辅助函数
            initMapCanvas(imgSrc) {
                const canvas = document.getElementById('map-analysis-canvas');
                if(!canvas) return;
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                };
                img.src = imgSrc;
            },

            // 2. 重置视图 (Fit Width)
            resetMapView() {
                this.mapView = { scale: 1, x: 0, y: 0, isDragging: false, startX: 0, startY: 0 };
            },

            // 3. 鼠标滚轮 (缩放)
            onMapWheel(e) {
                if (!this.map_data.image) return;
                const zoomIntensity = 0.1;
                const direction = e.deltaY > 0 ? -1 : 1;
                let newScale = this.mapView.scale + (direction * zoomIntensity);

                // 限制缩放范围 (0.5x ~ 5x)
                newScale = Math.min(Math.max(0.5, newScale), 5);
                
                // 简单的居中缩放逻辑 (为了代码简洁，暂时不做跟随鼠标位置的复杂矩阵计算)
                // 如果需要更高级的“跟随鼠标缩放”，代码量会增加很多
                this.mapView.scale = newScale;
            },
            exportMapConfig() {
                if (!this.map_data.image) return alert("No map data to export.");
                
                // 将 map_data 对象转为 JSON 字符串
                const dataStr = JSON.stringify(this.map_data, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                
                // 创建临时链接下载
                const link = document.createElement('a');
                link.href = url;
                link.download = `MapConfig_${Date.now()}.json`;
                link.click();
                
                // 清理
                URL.revokeObjectURL(url);
            },

            // 导入地图配置
            handleMapConfigImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // 简单校验数据结构
                        if (!importedData.image || !Array.isArray(importedData.pins)) {
                            throw new Error("Invalid map configuration file.");
                        }

                        if (confirm("Importing map will overwrite current map data. Continue?")) {
                            // 覆盖数据
                            this.map_data = importedData;
                            
                            // 兼容性处理：如果导入的是旧版数据没有 regions，补上
                            if (!this.map_data.regions) this.map_data.regions = [];

                            // 重置视图并保存
                            this.resetMapView();
                            this.saveGame('autosave.json');
                            
                            // 【关键】重新初始化 Canvas，否则导入后无法使用 Region 泛洪工具
                            this.$nextTick(() => {
                                this.initMapCanvas(this.map_data.image);
                            });
                            
                            alert("Map imported successfully!");
                        }
                    } catch (err) {
                        console.error(err);
                        alert("Failed to import map: " + err.message);
                    }
                    // 清空 input value，允许重复导入同一个文件
                    event.target.value = '';
                };
                reader.readAsText(file);
            },
// [新增] 导出为 PNG 图片
            async exportMapImage() {
                if (!this.map_data.image) return alert("No map loaded.");

                // 1. 获取地图的核心变换层
                // 【修改】改为通过 ID 获取，更加稳健
                const element = document.getElementById('map-capture-target');
                
                // 【修改】如果找不到元素，弹出提示，而不是静默失败
                if (!element) {
                    alert("Error: Map element not found (ID: map-capture-target missing).");
                    return;
                }

                // 2. 保存当前视图状态 (为了截图后恢复)
                const oldView = { ...this.mapView };
                const oldCursor = document.body.style.cursor;

                // 3. 提示用户并在后台调整视图
                document.body.style.cursor = 'wait';
                
                // 【关键步骤】重置视图以截取全图
                this.mapView = { scale: 1, x: 0, y: 0, isDragging: false };
                
                // 等待 Vue 更新 DOM
                await this.$nextTick();
                // 增加一点等待时间，确保图片渲染就绪
                await new Promise(resolve => setTimeout(resolve, 300));

                try {
                    // 4. 执行截图
                    const canvas = await html2canvas(element, {
                        backgroundColor: null, // 透明背景
                        scale: 2,              // 2倍采样
                        useCORS: true,         
                        logging: false,
                        // 忽略隐藏的辅助元素
                        ignoreElements: (el) => el.classList.contains('pointer-events-none') && el.tagName === 'DIV' && el.innerHTML === '' 
                    });

                    // 5. 触发下载
                    const link = document.createElement('a');
                    link.download = `Tactical_Map_${Date.now()}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    
                } catch (e) {
                    console.error(e);
                    alert("Image export failed: " + e.message);
                } finally {
                    // 6. 恢复视图
                    this.mapView = oldView;
                    document.body.style.cursor = oldCursor;
                }
            },
            // 4. 鼠标按下 (开始拖拽)
            onMapMouseDown(e) {
                if (!this.map_data.image) return;
                this.mapView.isDragging = true;
                this.mapView.startX = e.clientX - this.mapView.x;
                this.mapView.startY = e.clientY - this.mapView.y;
                
                // 记录点击初始位置，用于在 MouseUp 判断是点击还是拖拽
                this.dragOrigin = { x: e.clientX, y: e.clientY };
            },

            // 5. 鼠标移动 (拖拽中)
            onMapMouseMove(e) {
                if (!this.mapView.isDragging) return;
                e.preventDefault();
                this.mapView.x = e.clientX - this.mapView.startX;
                this.mapView.y = e.clientY - this.mapView.startY;
            },

            // 6. 鼠标抬起 (结束拖拽 OR 触发点击)
            onMapMouseUp(e) {
                if (!this.mapView.isDragging) return;
                this.mapView.isDragging = false;

                // 计算移动距离
                const dist = Math.sqrt(
                    Math.pow(e.clientX - this.dragOrigin.x, 2) + 
                    Math.pow(e.clientY - this.dragOrigin.y, 2)
                );

                // 如果移动距离小于 5px，则视为“点击添加点”
                if (dist < 5) {
                    this.handleAddPinClick(e);
                }
            },

            // 7. 处理添加点的逻辑 (也就是之前的 onMapBackgroundClick)
            // 注意：这里需要根据当前的 scale 和 translate 反推回 % 坐标
// 7. 处理点击逻辑：根据模式分流 (添加点 OR 添加区域)
            handleAddPinClick(e) {
                if (this.mapToolMode === 'view') return;

                const transformLayer = e.currentTarget.querySelector('.origin-top-left');
                if (!transformLayer) return;

                const rect = transformLayer.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;

                // 计算百分比
                const xPct = (clickX / rect.width) * 100;
                const yPct = (clickY / rect.height) * 100;
                if (xPct < 0 || xPct > 100 || yPct < 0 || yPct > 100) return;

                if (this.mapToolMode === 'pin') {
                    // --- 原有点模式 ---
                    this.editingPinIndex = -1;
                    this.editingRegionIndex = -2; // 确保不冲突
                    this.pinForm = {
                        x: xPct, y: yPct,
                        mode: 'entity', selectedId: '', customLabel: '', 
                        icon: 'fa-solid fa-map-pin', color: '#ffffff'
                    };
                    this.showPinModal = true;
                } else if (this.mapToolMode === 'region') {
                    // --- [新增] 区域泛洪模式 ---
                    const canvas = document.getElementById('map-analysis-canvas');
                    if(!canvas) return alert("Canvas not ready. Re-upload image.");
                    
                    // 换算回原图像素坐标
                    const rawX = Math.floor((clickX / rect.width) * canvas.width);
                    const rawY = Math.floor((clickY / rect.height) * canvas.height);
                    
                    this.createRegionFromPoint(rawX, rawY);
                }
            },
// [新增] 泛洪算法生成地块
            createRegionFromPoint(startX, startY) {
                if (this.isProcessingRegion) return;
                this.isProcessingRegion = true;
                document.body.style.cursor = 'wait';

                try {
                    const canvas = document.getElementById('map-analysis-canvas');
                    const ctx = canvas.getContext('2d');
                    const width = canvas.width;
                    const height = canvas.height;
                    
                    // 获取全图像素数据
                    const imageData = ctx.getImageData(0, 0, width, height);
                    const data = imageData.data;

                    // 获取点击点的颜色
                    const startPos = (startY * width + startX) * 4;
                    const startColor = [data[startPos], data[startPos+1], data[startPos+2], data[startPos+3]];

                    // 颜色容差 (40)
                    const tolerance = 40; 
                    const match = (pos) => {
                        const r = data[pos], g = data[pos+1], b = data[pos+2];
                        return Math.abs(r - startColor[0]) < tolerance &&
                               Math.abs(g - startColor[1]) < tolerance &&
                               Math.abs(b - startColor[2]) < tolerance; 
                    };

                    // BFS 泛洪
                    const stack = [[startX, startY]];
                    const visited = new Uint8Array(width * height);
                    const regionPixels = []; 
                    
                    let minX = width, maxX = 0, minY = height, maxY = 0;
                    
                    visited[startY * width + startX] = 1;

                    while (stack.length) {
                        const [x, y] = stack.pop();
                        
                        regionPixels.push(x, y);
                        if (x < minX) minX = x;
                        if (x > maxX) maxX = x;
                        if (y < minY) minY = y;
                        if (y > maxY) maxY = y;

                        const neighbors = [[x+1, y], [x-1, y], [x, y+1], [x, y-1]];
                        for (let n of neighbors) {
                            const nx = n[0], ny = n[1];
                            if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                                const nIdx = ny * width + nx;
                                if (!visited[nIdx]) {
                                    if (match(nIdx * 4)) {
                                        visited[nIdx] = 1;
                                        stack.push([nx, ny]);
                                    }
                                }
                            }
                        }
                    }

                    if (regionPixels.length < 50) {
                        alert("Area too small!");
                        return;
                    }

                    // 生成掩码图片
                    const regionW = maxX - minX + 1;
                    const regionH = maxY - minY + 1;
                    const maskCanvas = document.createElement('canvas');
                    maskCanvas.width = regionW;
                    maskCanvas.height = regionH;
                    const maskCtx = maskCanvas.getContext('2d');
                    const maskImgData = maskCtx.createImageData(regionW, regionH);
                    
                    for (let i = 0; i < regionPixels.length; i += 2) {
                        const px = regionPixels[i] - minX;
                        const py = regionPixels[i+1] - minY;
                        const idx = (py * regionW + px) * 4;
                        
                        // 改为白色 (255, 255, 255)，为了兼容 SVG Mask
                        maskImgData.data[idx] = 255;   // R
                        maskImgData.data[idx+1] = 255; // G
                        maskImgData.data[idx+2] = 255; // B
                        maskImgData.data[idx+3] = 255; // A (完全不透明)
                    }
                    maskCtx.putImageData(maskImgData, 0, 0);

                    // 计算重心
                    let sumX = 0, sumY = 0;
                    let pixelCount = 0;
                    
                    for (let i = 0; i < regionPixels.length; i += 2) {
                        sumX += regionPixels[i];
                        sumY += regionPixels[i+1];
                        pixelCount++;
                    }
                    
                    // 计算相对于原图宽高的百分比
                    const centerX = (sumX / pixelCount / width) * 100;
                    const centerY = (sumY / pixelCount / height) * 100;

                    // 打开编辑框
                    this.editingRegionIndex = -1; // 标记新增 Region
                    this.editingPinIndex = -2;    // 关闭 Pin 模式
                    this.pinForm = {
                        // Region 特有
                        x: (minX / width) * 100,
                        y: (minY / height) * 100,
                        w: (regionW / width) * 100,
                        h: (regionH / height) * 100,
                        maskData: maskCanvas.toDataURL(),
                        centerX: centerX,
                        centerY: centerY,
                        
                        // 通用
                        mode: 'entity', selectedId: '', customLabel: 'New Region',
                        icon: 'fa-solid fa-flag', color: '#ffffff'
                    };
                    this.showPinModal = true;

                } catch (e) {
                    console.error(e);
                    alert("Region detection failed.");
                } finally {
                    this.isProcessingRegion = false;
                    document.body.style.cursor = 'default';
                }
            },

            // [新增] 点击已存在的地块
            onRegionClick(reg, idx) {
                this.editingRegionIndex = idx;
                this.editingPinIndex = -2; // 确保不冲突
                
                this.pinForm = {
                    ...reg, // 加载所有数据 (包括 x, y, maskData 等)
                    mode: reg.type || 'entity',
                    selectedId: reg.linkId || '',
                    customLabel: reg.label || '',
                    icon: reg.icon || this.getFinalPinIcon(reg),
                    color: reg.color || this.getFinalPinColor(reg)
                };
                this.showPinModal = true;
            },
            onPinClick(pin, idx) {
                // 【关键修复】明确告诉系统：我现在是在编辑点，不是在编辑区域
                this.editingPinIndex = idx;
                this.editingRegionIndex = -2; // -2 代表不处于区域编辑模式
                
                let mode = pin.type || 'custom';
                if (!pin.type) {
                     if (this.players.some(p => p.id === pin.linkId)) mode = 'entity';
                     else if (pin.linkId) mode = 'lore';
                     else mode = 'custom';
                }

                this.pinForm = {
                    x: pin.x, y: pin.y,
                    mode: mode,
                    selectedId: pin.linkId || '',
                    customLabel: pin.label || '',
                    icon: pin.icon || this.getFinalPinIcon(pin),
                    color: pin.color || this.getFinalPinColor(pin)
                };
                this.showPinModal = true;
            },
            // 3. 保存 (新增或修改)
            saveMapPin() {
                // 校验
                if (this.pinForm.mode === 'entity' && !this.pinForm.selectedId) return alert("Please select an entity.");
                if (this.pinForm.mode === 'lore' && !this.pinForm.selectedId) return alert("Please select a lore entry.");
                if (this.pinForm.mode === 'custom' && !this.pinForm.customLabel) return alert("Please enter a label.");

                // 构建数据
                let label = "";
                let linkId = "";
                if (this.pinForm.mode === 'entity') {
                    const p = this.players.find(x => x.id === this.pinForm.selectedId);
                    label = p ? p.name : "Unknown";
                    linkId = this.pinForm.selectedId;
                } else if (this.pinForm.mode === 'lore') {
                    label = this.pinForm.selectedId;
                    linkId = this.pinForm.selectedId;
                } else {
                    label = this.pinForm.customLabel;
                    linkId = "";
                }

                const baseData = {
                    type: this.pinForm.mode,
                    label: label,
                    linkId: linkId,
                    icon: this.pinForm.icon,
                    color: this.pinForm.color
                };

                // --- 保存分支 ---
                if (this.editingRegionIndex !== -2) {
                    // 保存地块
                    const regionData = {
                        ...baseData,
                        id: this.editingRegionIndex === -1 ? 'reg_' + Date.now() : this.map_data.regions[this.editingRegionIndex].id,
                        x: this.pinForm.x, y: this.pinForm.y,
                        w: this.pinForm.w, h: this.pinForm.h,
                        maskData: this.pinForm.maskData,
                        centerX: this.pinForm.centerX, centerY: this.pinForm.centerY
                    };

                    if (!this.map_data.regions) this.map_data.regions = [];
                    if (this.editingRegionIndex === -1) this.map_data.regions.push(regionData);
                    else this.map_data.regions[this.editingRegionIndex] = regionData;
                    
                    this.editingRegionIndex = -2; // Reset
                } else {
                    // 保存 Pin
                    const pinData = {
                        ...baseData,
                        id: this.editingPinIndex === -1 ? 'pin_' + Date.now() : this.map_data.pins[this.editingPinIndex].id,
                        x: this.pinForm.x,
                        y: this.pinForm.y
                    };
                    if (this.editingPinIndex === -1) this.map_data.pins.push(pinData);
                    else this.map_data.pins[this.editingPinIndex] = pinData;
                }

                this.saveGame('autosave.json');
                this.showPinModal = false;
            },

            deleteMapPin() {
                if(confirm("Remove this item?")) {
                    if (this.editingRegionIndex !== -2 && this.editingRegionIndex !== -1) {
                        this.map_data.regions.splice(this.editingRegionIndex, 1);
                    } else if (this.editingPinIndex !== -1) {
                        this.map_data.pins.splice(this.editingPinIndex, 1);
                    }
                    this.saveGame('autosave.json');
                    this.showPinModal = false;
                    this.editingRegionIndex = -2;
                }
            },

            getPinColor(linkId) {
                if (!linkId) return '#fbbf24'; // default amber
                return this.getFactionColor(linkId);
            },
            
            getPinName(linkId) {
                if (!linkId) return 'Marker';
                return this.getFactionName(linkId);
            },

            // 构建层级树字符串，供 AI 使用
            buildHierarchyString() {
                const roots = this.players.filter(p => !p.parentId);
                let output = "";
                
                const printNode = (p, depth) => {
                    const indent = "  ".repeat(depth);
                    const statsStr = JSON.stringify(p.stats);
                    output += `${indent}- [${p.name}] (ID: ${p.id}) ${statsStr}\n`;
                    
                    // 查找子节点
                    const children = this.players.filter(child => child.parentId === p.id);
                    children.forEach(c => printNode(c, depth + 1));
                };

                roots.forEach(r => printNode(r, 0));
                return output;
            },

            // 构建地图描述字符串，供 AI 使用
            buildMapString() {
                if (!this.map_data.pins.length) return "No map data.";
                let output = "Known Locations:\n";
                this.map_data.pins.forEach(pin => {
                    const name = pin.label || this.getPinName(pin.linkId);
                    output += `- Location "${name}" is at coordinates [${pin.x.toFixed(1)}, ${pin.y.toFixed(1)}]. Linked Entity: ${pin.linkId || 'None'}\n`;
                });
                output += "Note: Map coordinates are 0-100% relative. Calculate distance to judge movement feasibility.\n";
                return output;
            },
            applyPreset(type) {
                if (type === 'Gemini') {
                    this.settings.api.provider = 'Gemini';
                    this.settings.api.baseUrl = ''; 
                    this.settings.api.model = 'gemini-2.5-flash';
                } else if (type === 'Claude') {
                    this.settings.api.provider = 'Claude';
                    this.settings.api.baseUrl = ''; // Claude 不需要 BaseURL (除非用代理，但通常直接连)
                    this.settings.api.model = 'claude-sonnet-4-5-20250929';
                } else if (type === 'DeepSeek') {
                    this.settings.api.provider = 'OpenAI';
                    this.settings.api.baseUrl = 'https://api.deepseek.com';
                    this.settings.api.model = 'deepseek-chat';
                } else if (type === 'Qwen') {
                    this.settings.api.provider = 'OpenAI';
                    this.settings.api.baseUrl = 'https://dashscope.aliyuncs.com/compatible-mode/v1';
                    this.settings.api.model = 'qwen-plus';
                } else if (type === 'OpenAI') {
                    this.settings.api.provider = 'OpenAI';
                    this.settings.api.baseUrl = 'https://api.openai.com/v1';
                    this.settings.api.model = 'gpt-4o';
                } else if (type === 'SiliconFlow') {
                    this.settings.api.provider = 'OpenAI';
                    this.settings.api.baseUrl = 'https://api.siliconflow.cn/v1';
                    this.settings.api.model = 'deepseek-ai/DeepSeek-V3';
                } else if (type === 'Others') {
                    this.settings.api.provider = 'Others';
                    this.settings.api.baseUrl = ''; // 用户自填
                    this.settings.api.model = ''; // 用户自填
                }
            },
            t(key) {
                if (!this.translations[key]) return key;
                return this.translations[key][this.ui.lang] || this.translations[key]['zh'];
            },
            renderMarkdown(text) { return marked.parse(text || ''); },
            getFactionColor(id) { if(id === 'global') return '#94a3b8'; const p = this.players.find(x => x.id === id); return p ? p.color : '#6366f1'; },
            getFactionName(id) { if (id === 'global') return this.t('option_global'); const p = this.players.find(x => x.id === id); return p ? p.name : 'Unknown'; },
            getFactionLogo(id) { if (id === 'global') return 'fa-solid fa-globe'; const p = this.players.find(x => x.id === id); return p && p.logo ? p.logo : 'fa-solid fa-users'; },
            getSchemaLabel(key) { const s = this.stat_schema.find(x => x.key === key); return s ? s.label : key; },
            formatTimeSpan(event) { if (!event.timeStart) return "Time ?"; if (!event.timeEnd || event.timeStart === event.timeEnd) return event.timeStart; return `${event.timeStart} - ${event.timeEnd}`; },
            
            async exportAsImage(type, data) {
                this.posterData = { title: '', factionName: '', color: '', icon: '', content: '', badges: [], timeDisplay: '' };
                const currentTurnTime = this.timeline.length > 0 ? this.timeline[this.timeline.length-1].timeRange : 'Current';
                if (type === 'faction') {
                    this.posterData.title = data.name;
                    this.posterData.factionName = "ENTITY FILE";
                    this.posterData.color = data.color;
                    this.posterData.icon = data.logo;
                    this.posterData.content = this.renderMarkdown(data.desc);
                    this.posterData.timeDisplay = currentTurnTime;
                    for(let key in data.stats) {
                        this.posterData.badges.push({ name: data.name, icon: data.logo, color: data.color, label: this.getSchemaLabel(key), val: data.stats[key] });
                    }
                } else if (type === 'event') {
                    this.posterData.title = data.summary;
                    this.posterData.factionName = this.getFactionName(data.factionId);
                    this.posterData.color = this.getFactionColor(data.factionId);
                    this.posterData.icon = this.getFactionLogo(data.factionId);
                    this.posterData.content = this.renderMarkdown(data.content);
                    this.posterData.timeDisplay = this.formatTimeSpan(data);
                    if(data.impacts) {
                        data.impacts.forEach(imp => {
                            // ★ 核心修复：手动拼接数值变化字符串
                            const changeString = `${imp.oldValue} → ${imp.newValue}`;
                            
                            this.posterData.badges.push({
                                name: imp.targetName,
                                icon: this.getFactionLogo(imp.targetId),
                                color: this.getFactionColor(imp.targetId),
                                label: imp.attrLabel,
                                val: changeString // ★ 使用拼接好的字符串
                            });
                        });
                    }
                } else if (type === 'lore') {
                    this.posterData.title = data.keys;
                    this.posterData.factionName = "LORE DATABASE";
                    this.posterData.color = "#10b981";
                    this.posterData.icon = "fa-solid fa-database";
                    this.posterData.content = this.renderMarkdown(data.content);
                    this.posterData.timeDisplay = currentTurnTime;
                } else if (type === 'rules') {
                    this.posterData.title = "SYSTEM RULES";
                    this.posterData.factionName = "CORE";
                    this.posterData.color = "#f59e0b";
                    this.posterData.icon = "fa-solid fa-sliders";
                    this.posterData.timeDisplay = currentTurnTime;
                    let content = "Current Rules:\n\n";
                    data.forEach(d => content += `- **${d.label}** [${d.key}]\n`);
                    this.posterData.content = this.renderMarkdown(content);
                }
                await this.$nextTick();
                const element = document.getElementById('poster-canvas');
                await new Promise(resolve => setTimeout(resolve, 100));
                try {
                    const canvas = await html2canvas(element, { backgroundColor: null, scale: 2, useCORS: true, logging: false });
                    const link = document.createElement('a');
                    link.download = `Levant_${type}_${Date.now()}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                } catch (e) { alert("Error generating image"); }
            },

            async openSaveLoadModal() {
                try {
                    const res = await axios.get(`${API_BASE}/api/saves`);
                    this.saveFiles = res.data.files;
                    this.showSaveLoadModal = true;
                } catch (e) { alert("Failed to fetch saves"); }
            },
            async loadGame(filename) {
                if (!filename) return;
                try {
                    const res = await axios.get(`${API_BASE}/api/state?filename=${filename}`);
                    this.applyState(res.data);
                    this.currentSaveFile = filename;
                    this.showSaveLoadModal = false;
                } catch (e) { this.serverConnected = false; }
            },
            async saveGame(filename) {
                if (!filename || !filename.trim()) return;
                if (!filename.endsWith('.json')) filename += '.json';
                
                try {
                    const stateData = { 
                        stat_schema: this.stat_schema, 
                        lorebook: this.lorebook, 
                        players: this.players, 
                        timeline: this.timeline, 
                        global_vars: this.global_vars, 
                        currentTurnPending: this.pendingEvents 
                    };
                    
                    await axios.post(`${API_BASE}/api/state?filename=${filename}`, stateData);
                    this.currentSaveFile = filename;
                    this.serverConnected = true;
                    if (this.showSaveLoadModal) { this.showSaveLoadModal = false; this.newSaveFilename = ''; }
                } catch (e) { 
                    console.error(e);
                    // 修复报错显示，把对象转成字符串
                    let errorMsg = e.message;
                    if (e.response && e.response.data) {
                        errorMsg = JSON.stringify(e.response.data, null, 2);
                    }
                    alert("Save Failed:\n" + errorMsg);
                }
            },
            async deleteSave(filename) {
                if (!confirm(`Delete "${filename}"?`)) return;
                try { await axios.delete(`${API_BASE}/api/saves/${filename}`); this.openSaveLoadModal(); } catch (e) { alert("Delete failed"); }
            },
            applyState(data) {
                const sanitizedData = JSON.parse(JSON.stringify(data));
                this.stat_schema = sanitizedData.stat_schema || []; 
                this.lorebook = sanitizedData.lorebook || []; 
                this.players = sanitizedData.players || []; 
                this.timeline = sanitizedData.timeline || []; 
                this.global_vars = sanitizedData.global_vars || [];
                this.map_data = sanitizedData.map_data || { image: '', pins: [] }; // <--- [新增]
                this.pendingEvents = sanitizedData.currentTurnPending || [];
                this.serverConnected = true;
            },
            
            addGlobalVar() {
                this.global_vars.push({ key: 'New Var', value: 'Value' });
                this.saveGame('autosave.json');
            },

            openContextModal() {
                if (!this.settings.api.key) return alert("Please set API Key in settings.");
                const rawInputText = this.rawInput.trim(); 
                const editorDraft = this.editor.summary;
                if (!rawInputText && !editorDraft) return alert("Please input command or summary!");

                this.tempSystemPrompt = this.settings.prompts.system;
                const inputText = (rawInputText + " " + editorDraft).toLowerCase();
                this.contextConfig.loreList = this.lorebook.map(entry => {
                    let isActive = false;
                    if (entry.mode === 'on') isActive = true;
                    else if (entry.mode === 'auto') {
                        const keywords = entry.keys.split(/[,，]/).map(k => k.trim().toLowerCase()).filter(k => k);
                        isActive = keywords.some(k => inputText.includes(k));
                    }
                    return { ...entry, active: isActive, originalMode: entry.mode };
                });
                this.contextConfig.playerList = this.players.map(p => ({ id: p.id, name: p.name, logo: p.logo, active: true }));
                this.showContextModal = true;
            },

            moveContextItem(type, direction) {
                const idx = this.contextConfig.order.indexOf(type);
                if (idx < 0) return;
                const newIdx = idx + direction;
                if (newIdx >= 0 && newIdx < this.contextConfig.order.length) {
                    const temp = this.contextConfig.order[newIdx];
                    this.contextConfig.order[newIdx] = this.contextConfig.order[idx];
                    this.contextConfig.order[idx] = temp;
                }
            },

            // --- 新增: 处理文件上传 ---
            async handleScriptFiles(event) {
                const files = event.target.files;
                if (!files.length) return;
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const rawData = e.target.result; 
                        let payload = { name: file.name, type: file.type, data: '' };
                        if (file.type.startsWith('image')) {
                            payload.data = rawData.split(',')[1]; // 去除 data:image/png;base64, 前缀
                        } else {
                            payload.data = rawData; // 文本内容
                        }
                        this.scriptAttachments.push(payload);
                    };
                    if (file.type.startsWith('image')) {
                        reader.readAsDataURL(file);
                    } else {
                        reader.readAsText(file);
                    }
                }
            },

            // --- 核心推演 (修改后支持 baseUrl 和 Attachments 接口) ---
            async runAiInference() {
                this.isThinking = true;
                const finalContext = this.finalContextPreview;
                
                const payload = { 
                    provider: this.settings.api.provider, 
                    apiKey: this.settings.api.key, 
                    baseUrl: this.settings.api.baseUrl, 
                    model: this.settings.api.model, 
                    useProxy: this.settings.proxy.enabled, 
                    proxyPort: this.settings.proxy.port, 
                    systemPrompt: this.settings.prompts.system, 
                    context: finalContext, 
                    userPrompt: `Generate next turn JSON.` 
                };

                try {
                    const res = await axios.post(`${API_BASE}/api/ai/generate`, payload);
                    const match = res.data.result.match(/\{[\s\S]*\}/);
                    if (!match) throw new Error("AI output invalid JSON");
                    
                    const parsed = JSON.parse(match[0]);
                    this.editor.content = parsed.content || ""; 
                    this.editor.summary = parsed.summary || ""; 
                    this.editor.factionId = parsed.factionId || ""; 
                    this.editor.timeStart = parsed.timeStart || ""; 
                    this.editor.timeEnd = parsed.timeEnd || "";
                    
                    if(parsed.impacts && Array.isArray(parsed.impacts)) {
                        this.editor.impacts = []; 
                        parsed.impacts.forEach(imp => {
                            let target = this.players.find(p => p.id === imp.targetId) || this.players.find(p => p.name === imp.targetName);
                            if (target) {
                                let oldV = imp.oldValue;
                                if (oldV === undefined || oldV === null) oldV = target.stats[imp.attrKey] || "?";

                                // --- 核心修正 ---
                                const schemaDef = this.stat_schema.find(s => s.key === imp.attrKey);
                                const finalLabel = schemaDef ? schemaDef.label : imp.attrKey; // 如果找不到规则，就用Key作为Label

                                this.editor.impacts.push({ 
                                    targetId: target.id, 
                                    targetName: target.name, 
                                    attrKey: imp.attrKey, 
                                    attrLabel: finalLabel, // ★ 总是使用我们自己查表得到的结果
                                    oldValue: oldV, 
                                    newValue: imp.newValue 
                                }); 
                            }
                        });
                    }
                    this.showContextModal = false;
                } catch (e) { alert("AI Error: " + e.message); } 
                finally { this.isThinking = false; }
            },

            addImpact() { 
                if(!this.impactForm.targetId || !this.impactForm.attrKey || this.impactForm.newValue === '') return; 
                
                const t = this.players.find(p => p.id === this.impactForm.targetId); 
                const s = this.stat_schema.find(k => k.key === this.impactForm.attrKey); 
                const currentVal = t.stats[this.impactForm.attrKey] || '-'; 
                
                this.editor.impacts.push({ 
                    targetId: this.impactForm.targetId, 
                    targetName: t.name, 
                    attrKey: this.impactForm.attrKey, 
                    attrLabel: s ? s.label : this.impactForm.attrKey, 
                    oldValue: currentVal,     // 直接存
                    newValue: this.impactForm.newValue // 直接存
                }); 
                
                this.impactForm.targetId = ''; 
                this.impactForm.attrKey = ''; 
                this.impactForm.newValue = ""; 
            },
            removeImpact(idx) { this.editor.impacts.splice(idx, 1); },
            addToStaging() { if (!this.editor.summary) return; this.pendingEvents.push(JSON.parse(JSON.stringify({ ...this.editor, factionId: this.editor.factionId || 'global', timeStart: this.editor.timeStart || '?', timeEnd: this.editor.timeEnd || '?', content: this.editor.content || this.editor.summary, isOpen: false }))); this.editor.summary = ""; this.editor.content = ""; this.editor.impacts = []; this.editor.factionId = ""; this.editor.timeStart = ""; this.editor.timeEnd = ""; this.tabs.right = 'staging'; this.saveGame('autosave.json'); },
            loadFromStaging(i) { Object.assign(this.editor, JSON.parse(JSON.stringify(this.pendingEvents[i]))); this.pendingEvents.splice(i,1); this.tabs.right = 'input'; this.saveGame('autosave.json'); },
            commitTurn() {
                if(this.pendingEvents.length === 0) return;
                
                const numericIds = this.timeline.map(t => parseInt(t.id, 10)).filter(id => !isNaN(id));
                const maxId = numericIds.length > 0 ? Math.max(...numericIds) : 0;
                const range = this.pendingTurnRange || `Turn ${maxId + 1}`;
                
                // 深拷贝，断开引用
                const newEvents = JSON.parse(JSON.stringify(this.pendingEvents));
                
                // 更新玩家状态
                newEvents.forEach(evt => {
                    if (evt.impacts) evt.impacts.forEach(imp => {
                        const player = this.players.find(p => p.id === imp.targetId);
                        if (player && imp.newValue !== undefined) { 
                            // 直接赋值新值
                            player.stats[imp.attrKey] = imp.newValue; 
                        }
                    });
                });

                this.timeline.push({ id: maxId + 1, timeRange: range, events: newEvents });
                this.pendingEvents = []; 
                this.pendingTurnRange = ""; 
                this.saveGame('autosave.json');
                this.$nextTick(() => { const el = document.getElementById('timeline-scroll'); if(el) el.scrollTop = el.scrollHeight; });
            },
            deleteTurn(tIdx) { if (confirm(`Delete Turn?`)) { this.timeline.splice(tIdx, 1); this.saveGame('autosave.json'); } },
            toggleEventOpen(event) { if(!this.editingEventId && !this.editingTurnId) event.isOpen = !event.isOpen; },
            isEditingEvent(t, e) { return this.editingEventId === `${t}-${e}`; },
            
            enableEventEdit(t, e) { 
                this.editingEventId = `${t}-${e}`; 
                this.editingTurnId = null;
                // 重置编辑用的临时表单
                this.editImpactForm = { targetId: '', attrKey: '', newValue: '' };
            },
            
            // 新增：向历史事件添加 Impact
            addEventImpact(event) {
                if(!this.editImpactForm.targetId || !this.editImpactForm.attrKey || this.editImpactForm.newValue === '') return;
                
                const t = this.players.find(p => p.id === this.editImpactForm.targetId);
                const s = this.stat_schema.find(k => k.key === this.editImpactForm.attrKey);
                // 这里我们尝试获取玩家当前属性作为 oldValue，虽然在历史事件中这可能不完全准确（因为时间线变了），但作为编辑参考足够
                const currentVal = t.stats[this.editImpactForm.attrKey] || '?';
                
                if (!event.impacts) event.impacts = [];
                
                event.impacts.push({
                    targetId: this.editImpactForm.targetId,
                    targetName: t.name,
                    attrKey: this.editImpactForm.attrKey,
                    attrLabel: s ? s.label : this.editImpactForm.attrKey,
                    oldValue: currentVal,
                    newValue: this.editImpactForm.newValue
                });
                
                this.editImpactForm.targetId = '';
                this.editImpactForm.attrKey = '';
                this.editImpactForm.newValue = '';
            },
            
            // 新增：从历史事件移除 Impact
            removeEventImpact(event, idx) {
                event.impacts.splice(idx, 1);
            },

            saveTurnEdit() { this.editingTurnId = null; this.saveGame('autosave.json'); },
            saveEventEdit() { this.editingEventId = null; this.saveGame('autosave.json'); },
            deleteEvent(t,e) { if(confirm("Delete Event?")) { this.timeline[t].events.splice(e,1); this.saveGame('autosave.json'); } },
            saveSettings() { 
                const toSave = { api: this.settings.api, proxy: this.settings.proxy, prompts: this.settings.prompts, ui: this.ui }; // 新增 proxy
                localStorage.setItem('levant_settings', JSON.stringify(toSave));
                this.showSettings = false; 
                alert("Settings Saved!"); 
            },
            addLoreEntry() { this.lorebook.unshift({ keys: '', content: '', mode: 'auto' }); },
            cycleLoreMode(e) { const m=['on','auto','off']; e.mode = m[(m.indexOf(e.mode)+1)%3]; this.saveGame('autosave.json') },
            addSchemaField() { const l=prompt("Label Name"); if(l) { const k=prompt("Key (English)"); if(k) { this.stat_schema.push({label:l, key:k}); this.players.forEach(p => { if(!p.stats[k]) p.stats[k] = '-'; }); this.saveGame('autosave.json'); } } },
            copyToClipboard(t) { navigator.clipboard.writeText(t); },
            openFactionModal(p) { if(p) { this.editingFaction = JSON.parse(JSON.stringify(p)); } else { this.editingFaction = {id:'', name:'', logo: 'fa-solid fa-users', color:'#ffffff', desc:'', stats:{}}; this.stat_schema.forEach(s => this.editingFaction.stats[s.key]='-'); } this.showFactionModal = true; },
            closeFactionModal() { this.showFactionModal = false; },
            saveFaction() { if(!this.editingFaction.name) return; if(this.editingFaction.id) { const i = this.players.findIndex(p => p.id === this.editingFaction.id); if(i !== -1) this.players[i] = JSON.parse(JSON.stringify(this.editingFaction)); } else { this.editingFaction.id = 'p'+Date.now(); this.players.push(JSON.parse(JSON.stringify(this.editingFaction))); } this.closeFactionModal(); this.saveGame('autosave.json'); },
            deleteFaction() { const i = this.players.findIndex(p => p.id === this.editingFaction.id); if(i !== -1 && confirm("Destroy Entity?")) { this.players.splice(i,1); this.closeFactionModal(); this.saveGame('autosave.json'); } },
            openScriptGenModal() { this.scriptGenPrompt = ''; this.scriptAttachments = []; this.showScriptGenModal = true; },
            
            // --- 查找并替换 methods 中的 generateScript ---

            async generateScript() {
                if (!this.settings.api.key) return alert("API Key missing");
                if (!confirm("确定覆盖当前进度？")) return;
                this.isThinking = true;
                
                const payload = { 
                    provider: this.settings.api.provider, 
                    apiKey: this.settings.api.key, 
                    baseUrl: this.settings.api.baseUrl, 
                    model: this.settings.api.model, 
                    useProxy: this.settings.proxy.enabled, 
                    proxyPort: this.settings.proxy.port, 
                    systemPrompt: this.settings.prompts.script_generator, 
                    context: `Req: "${this.scriptGenPrompt}"`, 
                    userPrompt: "Generate JSON.",
                    attachments: this.scriptAttachments 
                };

                try {
                    const res = await axios.post(`${API_BASE}/api/ai/generate`, payload);
                    const match = res.data.result.match(/\{[\s\S]*\}/);
                    if (!match) throw new Error("JSON Error");
                    
                    let newState = JSON.parse(match[0]);

                    // --- ★★★ 核心后处理逻辑开始 ★★★ ---
                    if (newState.timeline && newState.players) {
                        // 1. 创建一个玩家初始状态的快速查找表 (Map)
                        const playerStatsMap = new Map();
                        newState.players.forEach(p => playerStatsMap.set(p.id, p.stats));

                        // 2. 遍历 timeline 中的所有事件和 impact
                        newState.timeline.forEach(turn => {
                            turn.events?.forEach(event => {
                                event.impacts?.forEach(impact => {
                                    const initialStats = playerStatsMap.get(impact.targetId);
                                    
                                    // 3. 如果找到了对应的玩家和初始状态
                                    if (initialStats) {
                                        // 4. 将初始状态值赋给 oldValue
                                        impact.oldValue = initialStats[impact.attrKey] ?? "?";
                                    } else {
                                        // 如果没找到，则设为 '?'
                                        impact.oldValue = "?";
                                    }

                                    // 5. 确保 newValue 存在，防止 AI 遗漏
                                    if (impact.newValue === undefined) {
                                        impact.newValue = "?";
                                    }
                                });
                            });
                        });
                    }
                    // --- ★★★ 核心后处理逻辑结束 ★★★ ---


                    // (保留之前的 lorebook 容错处理)
                    if (newState.lorebook) {
                        newState.lorebook.forEach(entry => {
                            if (!entry.keys) {
                                entry.keys = entry.title || entry.key || entry.name || "未命名条目";
                            }
                            delete entry.title;
                        });
                    }

                    // (保留之前的 attrLabel 容错处理)
                    if(newState.timeline) {
                        const labelMap = {};
                        if(newState.stat_schema) newState.stat_schema.forEach(s => labelMap[s.key] = s.label);
                        
                        newState.timeline.forEach(t => {
                            if(t.events) t.events.forEach(e => {
                                if(e.impacts) e.impacts.forEach(i => {
                                    if(!i.attrLabel && labelMap[i.attrKey]) i.attrLabel = labelMap[i.attrKey];
                                });
                            });
                        });
                    }

                    this.applyState(newState);
                    this.showScriptGenModal = false;
                    this.scriptAttachments = []; 
                    this.scriptGenPrompt = '';
                } catch(e) { 
                    alert("Gen Failed: " + e.message); 
                } finally { this.isThinking = false; }
            },
            // --- 新增: 上帝模式执行逻辑 ---
            async executeGodMode() {
                if (!this.settings.api.key) return alert("API Key missing");
                this.isThinking = true;

                const currentStateSlice = {
                    stat_schema: this.stat_schema,
                    global_vars: this.global_vars,
                    players: this.players,
                    lorebook: this.lorebook
                };

                const payload = {
                    provider: this.settings.api.provider,
                    apiKey: this.settings.api.key,
                    baseUrl: this.settings.api.baseUrl,
                    model: this.settings.api.model,
                    useProxy: this.settings.proxy.enabled,
                    proxyPort: this.settings.proxy.port,
                    systemPrompt: this.settings.prompts.god_mode,
                    context: JSON.stringify(currentStateSlice),
                    userPrompt: `INSTRUCTION: ${this.godModeInput}`
                };

                try {
                    const res = await axios.post(`${API_BASE}/api/ai/generate`, payload);
                    const match = res.data.result.match(/\{[\s\S]*\}/);
                    if (!match) throw new Error("Invalid JSON returned by AI");
                    
                    const changes = JSON.parse(match[0]);
                    
                    // --- ★★★ 核心升级：智能合并所有返回的变更 ★★★ ---
                    // 遍历 AI 返回的所有 key
                    for (const key in changes) {
                        // 检查当前 Vue 实例中是否存在这个 key
                        if (Object.prototype.hasOwnProperty.call(this, key)) {
                            // 如果存在，就用 AI 返回的数据覆盖它
                            this[key] = changes[key];
                            console.log(`[God Mode] Updated '${key}' successfully.`);
                        }
                    }
                    // --- 核心升级结束 ---

                    this.godModeInput = '';
                    this.saveGame('autosave.json');
                    alert("World Reality Rewritten.");
                } catch(e) {
                    alert("God Mode Failed: " + e.message);
                } finally {
                    this.isThinking = false;
                }
            }
        }
    }).mount('#app');
</script>
</body>
</html>