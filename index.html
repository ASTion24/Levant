<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEVANT 自动化推演 v1.0</title>
    <link rel="icon" href="logo.png" type="image/png"> 
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* --- 核心配色 (CSS Variables) --- */
        :root {
            /* 默认 (Terminal / Dark) */
            --bg-deep: #020408;
            --bg-panel: #0a0f18;
            --bg-sidebar: #080b12;
            --bg-header: #05080c;
            --bg-input: #05080c;
            --bg-input-focus: #0f172a;
            --bg-glass: rgba(13, 19, 30, 0.95);
            --bg-card: rgba(20, 30, 45, 0.6);
            --bg-badge: rgba(0,0,0,0.3);
            --bg-hover: rgba(255,255,255,0.05);
            
            --text-main: #e2e8f0;       
            --text-dim: #64748b;        
            --text-accent: #6366f1;     
            --text-danger: #ef4444;     
            --text-inverse: #000000;    
            
            --border-highlight: rgba(255,255,255,0.08);
            --border-dim: #1e293b;      
            
            --shadow-color: rgba(0, 0, 0, 0.6);
            --font-main: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            --font-mono: 'JetBrains Mono', 'Consolas', monospace;

            /* 边框圆角 - Terminal 默认为圆润 */
            --radius-panel: 0.75rem;
            --radius-btn: 0.25rem;
            
            /* 纹理覆盖层 (Terminal 无) */
            --texture-overlay: none;
        }

        /* 主题：报社 (Newspaper / Light) */
        [data-theme="newspaper"] {
            /* 纸张纹理背景色 */
            --bg-deep: #f2f0e9;       
            --bg-panel: #fdfbf7;      
            --bg-sidebar: #e8e6e1;    
            --bg-header: #dedcd5;     
            --bg-input: #ffffff;      
            --bg-input-focus: #fffef0;
            --bg-glass: rgba(253, 251, 247, 0.98);
            --bg-card: #ffffff;
            --bg-badge: rgba(0,0,0,0.05);
            --bg-hover: rgba(0,0,0,0.05);

            --text-main: #1a1a1a;     /* 墨色 */
            --text-dim: #555555;      
            --text-accent: #8b0000;   /* 印泥红 */
            --text-danger: #dc2626;
            --text-inverse: #ffffff;

            --border-highlight: rgba(0,0,0,0.1);
            --border-dim: #a3a3a3;    
            
            --shadow-color: rgba(0, 0, 0, 0.15);
            /* 衬线字体组合 */
            --font-main: 'Georgia', 'Songti SC', 'STSong', serif; 
            --font-mono: 'Courier New', monospace;      

            /* 边框圆角 - 报社风格为直角 */
            --radius-panel: 0px;
            --radius-btn: 0px;

            /* 纸张噪点纹理 */
            --texture-overlay: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.08'/%3E%3C/svg%3E");
        }

        body { 
            background-color: var(--bg-deep); 
            color: var(--text-main); 
            font-family: var(--font-main); 
            font-size: 16px; 
            overflow: hidden; 
            line-height: 1.6; 
            transition: background-color 0.3s, color 0.3s;
        }

        /* 纹理层 */
        .app-texture {
            position: absolute; inset: 0; pointer-events: none; z-index: 1;
            background-image: var(--texture-overlay);
            opacity: 0.6; mix-blend-mode: multiply;
        }

        /* --- 通用圆角类 (适配不同主题) --- */
        .theme-rounded { border-radius: var(--radius-panel); }
        .theme-rounded-sm { border-radius: var(--radius-btn); }
        
        /* 报社模式下的特殊边框风格 */
        [data-theme="newspaper"] header { border-bottom: 3px double var(--border-dim); }
        [data-theme="newspaper"] aside { border-right: 1px solid var(--border-dim); }
        [data-theme="newspaper"] .info-card { border: 1px solid var(--border-dim); box-shadow: 2px 2px 0px rgba(0,0,0,0.1); }
        [data-theme="newspaper"] .modal-mask .glass-panel { border: 4px double #444; box-shadow: 10px 10px 0px rgba(0,0,0,0.2); }

        /* --- 滚动条 --- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: var(--border-dim); border-radius: var(--radius-btn); }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

        /* --- 组件风格 --- */
        .glass-panel { 
            background: var(--bg-glass); 
            backdrop-filter: blur(24px); 
            border: 1px solid var(--border-highlight); 
            box-shadow: 0 12px 40px var(--shadow-color); 
        }

        .info-card {
            background: var(--bg-card);
            border: 1px solid var(--border-highlight);
            transition: all 0.2s ease;
        }
        .info-card:hover {
            border-color: var(--text-dim);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .font-mono-tech { font-family: var(--font-mono); letter-spacing: -0.03em; }
        
        .input-tech {
            background: var(--bg-input); 
            border: 1px solid var(--border-dim); 
            color: var(--text-main); 
            transition: all 0.2s;
        }
        .input-tech:focus { 
            border-color: var(--text-accent); 
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1); 
            background: var(--bg-input-focus);
        }
        
        [data-theme="newspaper"] .input-tech {
            border: 1px solid #999;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.05);
            font-family: 'Courier New', monospace;
        }

        /* --- 模态框 --- */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.75); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
        }

        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        /* 状态变更框 */
        .impact-badge {
            display: inline-flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem;
            border-width: 1px; font-size: 0.9rem;
            box-shadow: 0 2px 5px var(--shadow-color); backdrop-filter: blur(4px);
            white-space: nowrap; color: var(--text-main);
            border-radius: var(--radius-btn);
        }

        /* Markdown */
        .md-content h1, .md-content h2 { 
            color: var(--text-main); font-weight: 800; margin-top: 1em; margin-bottom: 0.5em; 
            border-bottom: 2px solid var(--border-dim); padding-bottom: 0.2em; font-size: 1.4rem;
        }
        .md-content p { margin-bottom: 1em; text-align: justify; color: var(--text-main); opacity: 0.9; }
        .md-content strong { color: var(--text-accent); font-weight: 700; }
        .md-content ul { list-style: disc; padding-left: 1.5em; margin-bottom: 1em; }
        
        [data-theme="newspaper"] .md-content strong { color: #8b0000; font-weight: 900; background: rgba(0,0,0,0.05); padding: 0 4px; }
        [data-theme="newspaper"] .md-content h1 { text-transform: uppercase; border-bottom: 3px double #000; text-align: center; font-size: 2em; letter-spacing: 0.05em; margin-bottom: 1em; }

        /* 背景LOGO */
        .event-card-bg-logo { 
            position: absolute; top: -10px; right: -20px; font-size: 220px; opacity: 0.04; 
            transform: rotate(-10deg); transition: all 0.5s ease; z-index: 0; pointer-events: none;
        }
        .group\/event:hover .event-card-bg-logo { opacity: 0.08; transform: rotate(0deg) scale(1.05); }

        /* --- 上下文拖拽列表样式 --- */
        .context-item {
            display: flex; align-items: center; gap: 10px; padding: 8px;
            background: var(--bg-badge); border: 1px solid var(--border-highlight);
            margin-bottom: 4px; transition: all 0.2s; cursor: grab;
            color: var(--text-main);
            border-radius: var(--radius-btn);
        }
        .context-item:hover { background: var(--bg-hover); }
        .context-item:active { cursor: grabbing; }
        .context-item.active { border-left: 3px solid #10b981; }
        .context-item.disabled { opacity: 0.5; }

        /* --- 海报生成专用样式 --- */
        #poster-canvas {
            position: fixed; left: -9999px; top: 0; width: 1080px; padding: 0; margin: 0;
            box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden;
        }
        
        /* Style 1: Cyberpunk Terminal (暗色终端风格修正) */
        /* Style 1: Cyberpunk Terminal (完全还原 v1.3.1 样式) */
        .poster-terminal {
            width: 100%; height: 100%; min-height: 1200px;
            background: linear-gradient(to bottom, #0f1623, #05080c);
            color: white; font-family: 'PingFang SC', sans-serif;
            border-left-width: 24px; position: relative; display: flex; flex-direction: column;
        }
        .poster-terminal .bg-texture {
            position: absolute; inset: 0; z-index: 0; opacity: 0.05; pointer-events: none;
            background-image: radial-gradient(#94a3b8 1px, transparent 1px); background-size: 40px 40px;
        }
        .poster-terminal .poster-header {
            padding: 60px 70px; background: rgba(0,0,0,0.2); border-bottom: 2px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 10;
        }
        .poster-terminal .poster-body { padding: 50px 70px; position: relative; z-index: 10; flex: 1; }
        .poster-terminal h1 {
            font-size: 64px; line-height: 1.2; font-weight: 900; color: #fff; margin-bottom: 50px; letter-spacing: -0.02em;
            border-bottom: 2px solid #334155; padding-bottom: 20px;
        }
        .poster-terminal .md-body { font-size: 28px; line-height: 1.8; color: #cbd5e1; }
        .poster-terminal .md-body strong { color: #f59e0b; font-weight: bold; }

        /* 关键修复：徽章容器 */
        .poster-terminal .poster-badge-container {
            margin-bottom: 50px; display: flex; flex-direction: column; gap: 20px; position: relative; z-index: 10;
        }
        /* 关键修复：徽章本体（Flex布局） */
        .poster-terminal .poster-badge {
            display: flex; height: 64px; 
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; overflow: hidden; backdrop-filter: blur(10px);
        }
        /* 关键修复：徽章左侧 */
        .poster-terminal .poster-badge-left {
            display: flex; align-items: center; justify-content: center; 
            padding: 0 30px; padding-bottom: 4px; /* 微调对齐 */
            min-width: 200px; 
            background: rgba(0,0,0,0.2); border-right: 1px solid rgba(255,255,255,0.1);
            font-weight: 800; font-size: 22px; gap: 14px; height: 100%; color: inherit;
        }
        /* 关键修复：徽章右侧 */
        .poster-terminal .poster-badge-right {
            display: flex; align-items: center; 
            padding: 0 30px; padding-bottom: 4px; /* 微调对齐 */
            flex: 1;
            font-family: 'JetBrains Mono', monospace; font-size: 22px; height: 100%; line-height: 1;
        }

        .poster-terminal .poster-footer {
            padding: 40px 70px; background: rgba(0,0,0,0.4); border-top: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center; font-family: 'JetBrains Mono', monospace;
            color: #64748b; font-size: 18px; text-transform: uppercase; letter-spacing: 0.1em; position: relative; z-index: 10;
        }
        /* Style 2: Vintage Newspaper */
        .poster-newspaper {
            width: 100%; height: 100%; min-height: 1200px;
            background-color: #f4f1ea; color: #1a1a1a;
            font-family: 'Georgia', 'Songti SC', serif;
            position: relative; display: flex; flex-direction: column;
            padding: 60px;
        }
        .poster-newspaper .paper-grain {
            position: absolute; inset: 0; opacity: 0.15; z-index: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }
        .poster-newspaper .news-header {
            border-bottom: 4px double #1a1a1a; 
            padding-bottom: 15px; 
            
            /* --- 关键修改 --- */
            /* 原来可能是 40px，现在改为 15px */
            /* 作用：减少刊头和标题之间的空白，让标题往上走 */
            margin-bottom: 15px; 
            
            text-align: center; 
            position: relative; 
            z-index: 10;
        }
        .poster-newspaper .brand { font-size: 80px; font-weight: 900; letter-spacing: -0.02em; text-transform: uppercase; line-height: 1; margin-bottom: 50px; }
        .poster-newspaper .meta { display: flex; justify-content: space-between; border-top: 1px solid #1a1a1a; border-bottom: 1px solid #1a1a1a; padding: 10px 0; font-family: 'Courier New', monospace; font-size: 20px; text-transform: uppercase; font-weight: bold; }
        
        .poster-newspaper .headline { 
            font-size: 72px; 
            line-height: 1.1; 
            font-weight: 900; 
            
            /* --- 关键修改 --- */
            margin-top: 0;       /* 确保标题顶部没有多余间隙 */
            /* 原来可能是 20px，现在改为 50px */
            /* 作用：给下方的红色倾斜印章留出足够的旋转空间，防止重叠 */
            margin-bottom: 50px; 
            
            text-align: center; 
            font-family: 'Times New Roman', serif; 
            position: relative; 
            z-index: 10; 
        }
        
        .poster-newspaper .content-cols {
            column-count: 2; 
            column-gap: 60px; 
            font-size: 26px; 
            line-height: 1.6; 
            text-align: justify; 
            position: relative; 
            z-index: 10;
            
            /* --- 核心修复代码 --- */
            /* 1. 增加底部边距，强制把底部的双线栏顶下去，防止重叠 */
            margin-bottom: 80px; 
            
            /* 2. 自动占据剩余空间，但配合上面的margin确保不压线 */
            flex: 1; 
        }
        
        /* 1. 徽章容器：调整间距，防止正文过高 */
        .poster-newspaper .badges-row { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 30px; /* 增加水平间距，防止印章挤在一起 */
            margin-bottom: 30px; /* 减小下方外边距，让正文上移 */
            justify-content: center; 
            position: relative; 
            z-index: 10; 
            border-bottom: 2px solid #1a1a1a; 
            padding-bottom: 25px; /* 稍微留一点呼吸空间给旋转的印章 */
        }

        /* 2. 红色倾斜印章：核心样式找回 */
        .poster-newspaper .stamp-badge {
            border: 3px solid #8b0000; /* 加粗边框，更有印章感 */
            color: #8b0000; 
            padding: 8px 18px; 
            
            /* --- 关键：倾斜效果 --- */
            transform: rotate(-3deg); 
            
            font-family: 'Courier New', monospace; 
            font-weight: 900; 
            font-size: 22px;
            display: flex; 
            align-items: center; 
            gap: 10px; 
            text-transform: uppercase;
            background: transparent; 
            /* 增加一点粗糙的阴影，模拟印泥未干 */
            text-shadow: 1px 1px 0px rgba(139, 0, 0, 0.1);
            box-shadow: 2px 2px 0px rgba(139, 0, 0, 0.1);
        }
    </style>
</head>
<body>

<div id="app" class="h-screen flex flex-col relative text-[var(--text-main)]" :class="ui.theme === 'newspaper' ? 'font-serif' : 'font-sans'">
    
    <!-- 纸张纹理层 -->
    <div class="app-texture"></div>

    <!-- 顶部导航 -->
    <header class="h-24 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex items-center px-8 justify-between shrink-0 z-50 shadow-sm relative w-full transition-colors duration-300">
        <!-- 左侧区域 -->
        <div class="flex items-center gap-6 shrink-0">
            <div class="w-14 h-14 theme-rounded bg-[var(--bg-panel)] border border-[var(--border-dim)] flex items-center justify-center text-indigo-500 text-3xl shadow-sm shrink-0">
                <i class="fa-solid fa-chess-rook"></i>
            </div>
            
            <div class="flex flex-col justify-center">
                <div class="flex items-center">
                    <h1 class="font-black text-2xl text-[var(--text-main)] tracking-tight leading-none mr-2">{{ t('app_title') }}</h1>
                    <span class="text-[var(--text-dim)] font-light text-sm font-mono-tech mr-4">v1.0</span>
                    <div class="h-4 w-px bg-[var(--border-dim)] mr-4"></div>
                    <div class="flex items-center gap-2 px-3 py-1 theme-rounded-sm bg-[var(--bg-badge)] border border-[var(--border-dim)] text-indigo-400 font-mono-tech text-xs font-bold tracking-wide backdrop-blur-sm mr-4 shrink-0">
                        <span>POWERED BY 絜矩 (QQ 2124223354)</span>
                    </div>

                    <!-- 语录展示区 -->
                    <div class="relative h-8 w-[500px] overflow-hidden flex items-center hidden 2xl:flex">
                        <transition-group name="quote">
                            <div :key="quoteIdx" class="absolute left-0 text-[var(--text-dim)] text-sm font-serif italic tracking-widest whitespace-nowrap">
                                <i class="fa-solid fa-quote-left text-xs opacity-50 mr-2 transform -translate-y-1"></i>
                                {{ quotes[quoteIdx] }}
                                <i class="fa-solid fa-quote-right text-xs opacity-50 ml-1 transform -translate-y-1"></i>
                            </div>
                        </transition-group>
                    </div>
                </div>

                <!-- 状态信息 -->
                <div class="flex items-center gap-3 mt-1.5 text-[10px] font-mono-tech uppercase tracking-widest text-[var(--text-dim)]">
                    <span :class="serverConnected ? 'text-emerald-500' : 'text-red-500'" class="flex items-center gap-2 font-bold">
                        <i class="fa-solid fa-wifi"></i> {{ serverConnected ? t('status_online') : t('status_offline') }}
                    </span>
                    <span v-if="currentSaveFile" class="text-indigo-400 ml-2 border-l border-[var(--border-dim)] pl-2">
                        <i class="fa-solid fa-floppy-disk mr-1"></i> {{ currentSaveFile }}
                    </span>
                </div>
            </div>
        </div>

        <!-- 右侧区域 -->
        <div class="flex items-center gap-4 ml-auto shrink-0">
            <div class="text-right mr-4 border-r border-[var(--border-dim)] pr-6">
                <div class="text-[10px] text-[var(--text-dim)] uppercase font-bold tracking-widest mb-1">{{ t('next_turn_label') }}</div>
                <div class="text-emerald-500 font-mono-tech font-bold text-2xl leading-none tracking-tight">{{ pendingTurnRange || t('auto') }}</div>
            </div>
            <button @click="openScriptGenModal" class="h-11 px-5 theme-rounded-sm bg-[var(--bg-panel)] hover:bg-[var(--bg-hover)] text-[var(--text-accent)] border border-[var(--border-dim)] transition font-bold text-sm flex items-center gap-2">
                <i class="fa-solid fa-wand-sparkles"></i> {{ t('btn_script_gen') }}
            </button>
            <button @click="showSettings = true" class="h-11 w-11 theme-rounded-sm bg-[var(--bg-panel)] hover:bg-[var(--bg-hover)] text-[var(--text-dim)] border border-[var(--border-dim)] transition flex items-center justify-center">
                <i class="fa-solid fa-gear text-lg"></i>
            </button>
            <button @click="openSaveLoadModal" class="h-11 px-6 theme-rounded-sm bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-900/40 transition font-bold text-sm border-t border-indigo-400/30 flex items-center gap-2">
                <i class="fa-solid fa-folder-open"></i> {{ t('btn_files') }}
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden z-10">
        
        <!-- 左侧：资料库 -->
        <aside class="w-1/5 min-w-[380px] bg-[var(--bg-sidebar)] border-r border-[var(--border-dim)] flex flex-col shrink-0 z-30 relative shadow-lg transition-colors duration-300">
            <div class="grid grid-cols-4 p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] gap-1">
                <button @click="tabs.left = 'world'" :class="tabs.left==='world' ? 'bg-[var(--bg-panel)] text-[var(--text-main)] border-[var(--border-dim)]' : 'text-[var(--text-dim)] border-transparent hover:text-[var(--text-main)]'" class="py-2 theme-rounded-sm border transition text-xs font-bold tracking-wide"><i class="fa-solid fa-globe mr-1"></i>{{ t('tab_world') }}</button>
                <button @click="tabs.left = 'players'" :class="tabs.left==='players' ? 'bg-[var(--bg-panel)] text-indigo-400 border-[var(--border-dim)]' : 'text-[var(--text-dim)] border-transparent hover:text-[var(--text-main)]'" class="py-2 theme-rounded-sm border transition text-xs font-bold tracking-wide"><i class="fa-solid fa-users mr-1"></i>{{ t('tab_entity') }}</button>
                <button @click="tabs.left = 'lore'" :class="tabs.left==='lore' ? 'bg-[var(--bg-panel)] text-emerald-400 border-[var(--border-dim)]' : 'text-[var(--text-dim)] border-transparent hover:text-[var(--text-main)]'" class="py-2 theme-rounded-sm border transition text-xs font-bold tracking-wide"><i class="fa-solid fa-book mr-1"></i>{{ t('tab_lore') }}</button>
                <button @click="tabs.left = 'stat_schema'" :class="tabs.left==='stat_schema' ? 'bg-[var(--bg-panel)] text-amber-400 border-[var(--border-dim)]' : 'text-[var(--text-dim)] border-transparent hover:text-[var(--text-main)]'" class="py-2 theme-rounded-sm border transition text-xs font-bold tracking-wide"><i class="fa-solid fa-sliders mr-1"></i>{{ t('tab_rules') }}</button>
            </div>

            <!-- 1. 全局变量 -->
            <div v-if="tabs.left === 'world'" class="flex-1 overflow-y-auto p-5 space-y-3">
                <div class="text-xs text-[var(--text-dim)] font-bold uppercase tracking-widest mb-2 px-1">Global Variables</div>
                <div v-for="(gVar, idx) in global_vars" :key="idx" class="bg-[var(--bg-panel)] p-3 theme-rounded-sm border border-[var(--border-dim)] flex flex-col gap-2 group">
                    <div class="flex gap-2">
                        <input v-model="gVar.key" @change="saveGame('autosave.json')" class="w-1/3 bg-[var(--bg-badge)] text-sm text-indigo-400 p-2 theme-rounded-sm border border-[var(--border-dim)] outline-none font-bold font-mono-tech" placeholder="变量名">
                        <input v-model="gVar.value" @change="saveGame('autosave.json')" class="flex-1 bg-[var(--bg-badge)] text-sm text-[var(--text-main)] p-2 theme-rounded-sm border border-[var(--border-dim)] outline-none" placeholder="当前状态">
                        <button @click="global_vars.splice(idx,1); saveGame('autosave.json')" class="text-[var(--text-dim)] hover:text-red-400 px-2 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
                <button @click="addGlobalVar" class="w-full py-3 bg-[var(--bg-panel)] text-[var(--text-dim)] theme-rounded-sm border border-[var(--border-dim)] font-bold text-sm hover:bg-[var(--bg-header)] transition hover:text-[var(--text-main)]"><i class="fa-solid fa-plus mr-2"></i> {{ t('btn_add_global') }}</button>
            </div>

            <!-- 2. 实体列表 -->
            <div v-if="tabs.left === 'players'" class="flex-1 overflow-y-auto p-5 space-y-4">
                 <div v-for="player in players" :key="player.id" @click="openFactionModal(player)" class="info-card cursor-pointer theme-rounded p-5 relative group">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 theme-rounded-sm bg-[var(--bg-badge)] border border-[var(--border-dim)] flex items-center justify-center text-xl shadow-inner" :style="{ color: player.color, borderColor: player.color + '40' }">
                                <i :class="player.logo || 'fa-solid fa-users'"></i>
                            </div>
                            <div>
                                <div class="font-black text-base text-[var(--text-main)] leading-tight mb-1">{{ player.name }}</div>
                                <div class="text-[10px] font-mono-tech text-[var(--text-dim)] uppercase tracking-widest">ID: {{ player.id }}</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                             <button @click.stop="exportAsImage('faction', player)" class="text-[var(--text-dim)] hover:text-emerald-400 transition" title="生成战术海报"><i class="fa-solid fa-camera"></i></button>
                             <i class="fa-solid fa-ellipsis-vertical text-[var(--text-dim)] group-hover:text-[var(--text-main)] transition px-2"></i>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div v-for="(val, key) in player.stats" :key="key" class="bg-[var(--bg-badge)] px-2 py-1.5 theme-rounded-sm border border-[var(--border-dim)] flex flex-col">
                            <span class="text-[9px] text-[var(--text-dim)] font-bold uppercase tracking-wider">{{ getSchemaLabel(key) }}</span>
                            <span class="text-xs font-mono-tech font-bold truncate" :style="{ color: player.color }">{{val}}</span>
                        </div>
                    </div>
                </div>
                <button @click="openFactionModal(null)" class="w-full py-4 border-2 border-dashed border-[var(--border-dim)] text-[var(--text-dim)] theme-rounded hover:text-indigo-400 hover:border-indigo-500/50 transition text-sm font-bold bg-[var(--bg-badge)] hover:bg-[var(--bg-panel)] uppercase tracking-widest flex items-center justify-center gap-2"><i class="fa-solid fa-plus-circle"></i> {{ t('btn_new_entity') }}</button>
            </div>

            <!-- 3. 资料设定 -->
            <div v-if="tabs.left === 'lore'" class="flex-1 overflow-y-auto p-5 space-y-4">
                <div v-for="(entry, idx) in lorebook" :key="idx" class="info-card theme-rounded p-4">
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-[var(--border-highlight)]">
                        <input v-model="entry.keys" @change="saveGame('autosave.json')" class="bg-transparent text-sm font-bold text-emerald-400 w-full outline-none placeholder-[var(--text-dim)]" placeholder="关键词...">
                        <div class="flex items-center gap-2">
                            <button @click="exportAsImage('lore', entry)" class="text-[var(--text-dim)] hover:text-emerald-400 transition text-xs" title="导出资料卡"><i class="fa-solid fa-camera"></i></button>
                            <button @click="cycleLoreMode(entry)" class="px-2 py-1 theme-rounded-sm text-[10px] font-bold uppercase tracking-wider min-w-[50px] transition-all border" :class="{'bg-emerald-900/40 text-emerald-400 border-emerald-500/40': entry.mode==='on', 'bg-indigo-900/40 text-indigo-400 border-indigo-500/40': entry.mode==='auto', 'bg-[var(--bg-badge)] text-[var(--text-dim)] border-[var(--border-dim)]': entry.mode==='off'}">{{ entry.mode === 'on' ? '常驻' : (entry.mode === 'auto' ? '自动' : '禁用') }}</button>
                        </div>
                    </div>
                    <textarea v-model="entry.content" @change="saveGame('autosave.json')" class="w-full bg-[var(--bg-badge)] theme-rounded-sm p-3 text-xs text-[var(--text-main)] resize-none h-20 border border-[var(--border-dim)] focus:border-emerald-500/50 outline-none leading-relaxed" placeholder="设定内容..."></textarea>
                    <div class="flex justify-end mt-1"><button @click="lorebook.splice(idx,1); saveGame('autosave.json')" class="text-xs text-[var(--text-dim)] hover:text-red-400"><i class="fa-solid fa-trash"></i></button></div>
                </div>
                <button @click="addLoreEntry" class="w-full py-3 bg-[var(--bg-panel)] hover:bg-[var(--bg-header)] text-emerald-500 theme-rounded-sm border border-[var(--border-dim)] transition font-bold text-sm"><i class="fa-solid fa-database mr-2"></i> {{ t('btn_add_lore') }}</button>
            </div>

            <!-- 4. 规则列表 -->
            <div v-if="tabs.left === 'stat_schema'" class="flex-1 overflow-y-auto p-5 space-y-3">
                <div v-for="(field, idx) in stat_schema" :key="idx" class="bg-[var(--bg-panel)] p-3 theme-rounded-sm border border-[var(--border-dim)] flex gap-3 items-center">
                    <input v-model="field.label" @change="saveGame('autosave.json')" class="flex-1 bg-[var(--bg-badge)] text-sm text-[var(--text-main)] p-2 theme-rounded-sm border border-[var(--border-dim)] outline-none" placeholder="名称">
                    <input v-model="field.key" @change="saveGame('autosave.json')" class="w-24 bg-[var(--bg-badge)] text-sm text-[var(--text-dim)] p-2 theme-rounded-sm border border-[var(--border-dim)] font-mono-tech text-center" placeholder="Key">
                    <button @click="stat_schema.splice(idx,1); saveGame('autosave.json')" class="text-[var(--text-dim)] hover:text-red-400 px-2"><i class="fa-solid fa-times"></i></button>
                </div>
                <button @click="exportAsImage('rules', stat_schema)" class="w-full py-3 bg-[var(--bg-panel)] text-indigo-400 theme-rounded-sm border border-[var(--border-dim)] font-bold text-sm hover:bg-[var(--bg-header)] transition mb-2"><i class="fa-solid fa-camera mr-2"></i> {{ t('btn_export_rules') }}</button>
                <button @click="addSchemaField" class="w-full py-3 bg-[var(--bg-panel)] text-amber-500 theme-rounded-sm border border-[var(--border-dim)] font-bold text-sm hover:bg-[var(--bg-header)] transition"><i class="fa-solid fa-plus mr-2"></i> {{ t('btn_add_rule') }}</button>
            </div>
        </aside>

        <!-- 中间：情报流 -->
        <section class="w-2/5 bg-[var(--bg-deep)] flex flex-col relative border-r border-[var(--border-dim)] transition-colors duration-300">
            <div class="absolute inset-0 pointer-events-none opacity-[0.03]" style="background-image: radial-gradient(#94a3b8 1px, transparent 1px); background-size: 30px 30px;"></div>
            
            <div id="timeline-scroll" class="flex-1 overflow-y-auto p-10 pr-4 scroll-smooth z-10">
                <div v-if="timeline.length === 0" class="h-full flex flex-col items-center justify-center text-[var(--text-dim)] opacity-50">
                    <i class="fa-regular fa-file-lines text-6xl mb-6"></i>
                    <p class="text-lg font-mono-tech font-bold uppercase tracking-widest">{{ t('msg_no_events') }}</p>
                </div>

                <div v-for="(turn, tIdx) in timeline" :key="tIdx" class="mb-20">
                    <div class="flex items-center gap-6 mb-8 group/turn">
                        <div class="h-px bg-[var(--border-dim)] flex-1"></div>
                        <div class="text-center cursor-pointer group/edit" @click="editingTurnId = turn.id">
                            <div v-if="editingTurnId === turn.id" class="flex flex-col items-center gap-2">
                                <input v-model="turn.id" class="bg-black text-white text-3xl font-black text-center w-24 border border-indigo-500 theme-rounded-sm p-1">
                                <input v-model="turn.timeRange" class="bg-black text-emerald-400 text-lg font-mono-tech text-center w-48 border border-emerald-500 theme-rounded-sm p-1" @blur="saveTurnEdit" @keyup.enter="saveTurnEdit">
                            </div>
                            <div v-else>
                                <h2 class="text-5xl font-black text-[var(--text-main)] group-hover/edit:text-[var(--text-dim)] transition">TURN {{ turn.id }}</h2>
                                <div class="text-emerald-700 font-mono-tech font-bold uppercase tracking-[0.2em] mt-1 group-hover/edit:text-emerald-500 transition">{{ turn.timeRange }}</div>
                            </div>
                        </div>
                        <div class="h-px bg-[var(--border-dim)] flex-1 flex justify-end"><button @click="deleteTurn(tIdx)" class="opacity-0 group-hover/turn:opacity-100 text-[var(--text-dim)] hover:text-red-500 transition px-4 text-xl"><i class="fa-solid fa-trash"></i></button></div>
                    </div>

                    <div class="space-y-12 pl-6 border-l-2 border-[var(--border-dim)] ml-10">
                        <div v-for="(event, eIdx) in turn.events" :key="eIdx" class="relative group/event">
                            <div class="absolute -left-[34px] top-10 w-6 h-0.5 bg-[var(--border-dim)] group-hover/event:bg-indigo-500 group-hover/event:w-8 transition-all"></div>
                            
                            <!-- 新闻卡片本体 -->
                            <div class="glass-panel theme-rounded border-0 border-l-[6px] transition-all duration-300 relative overflow-hidden hover:shadow-[0_10px_50px_var(--shadow-color)]" :style="{ borderLeftColor: getFactionColor(event.factionId) }">
                                <i :class="getFactionLogo(event.factionId)" class="event-card-bg-logo" :style="{ color: getFactionColor(event.factionId) }"></i>
                                
                                <div class="bg-[var(--bg-header)] px-6 py-3 border-b border-[var(--border-highlight)] flex justify-between items-center relative z-10 backdrop-blur-sm">
                                    <div class="flex items-center gap-4 font-mono-tech text-sm font-bold tracking-wider text-[var(--text-dim)]">
                                        <span class="text-[var(--text-dim)]"><i class="fa-regular fa-clock mr-2"></i>{{ formatTimeSpan(event) }}</span>
                                        <span class="w-px h-4 bg-[var(--border-dim)]"></span>
                                        <span class="uppercase flex items-center gap-2" :style="{ color: getFactionColor(event.factionId) }">
                                            <i class="fa-solid fa-tower-broadcast text-xs opacity-60"></i> {{ getFactionName(event.factionId) }}
                                        </span>
                                    </div>
                                    <div class="flex gap-4 items-center">
                                        <button @click.stop="exportAsImage('event', event)" class="text-[var(--text-dim)] hover:text-emerald-400 transition" title="生成情报简报海报"><i class="fa-solid fa-camera"></i></button>
                                        <button v-if="!isEditingEvent(tIdx, eIdx)" @click.stop="enableEventEdit(tIdx, eIdx)" class="text-[var(--text-dim)] hover:text-[var(--text-main)] transition"><i class="fa-solid fa-pen-to-square"></i></button>
                                        <button v-else @click.stop="saveEventEdit()" class="text-emerald-500 hover:text-[var(--text-main)] transition"><i class="fa-solid fa-floppy-disk"></i></button>
                                    </div>
                                </div>

                                <div class="p-8 cursor-pointer relative z-10" @click="toggleEventOpen(event)">
                                    <div v-if="isEditingEvent(tIdx, eIdx)" @click.stop class="mb-4">
                                        <div class="flex gap-2 mb-2"><input v-model="event.timeStart" class="input-tech p-2 w-1/4 rounded"><input v-model="event.timeEnd" class="input-tech p-2 w-1/4 rounded"></div>
                                        <textarea v-model="event.summary" class="w-full h-24 input-tech p-3 text-lg font-bold rounded"></textarea>
                                    </div>
                                    <h3 v-else class="text-2xl font-black text-[var(--text-main)] mb-6 leading-tight tracking-tight">{{ event.summary }}</h3>
                                    
                                    <div v-if="event.impacts?.length" class="flex flex-wrap gap-3 mb-4">
                                        <div v-for="(imp, i) in event.impacts" :key="i" class="impact-badge" :style="{ borderColor: getFactionColor(imp.targetId), backgroundColor: getFactionColor(imp.targetId) + '15' }">
                                            <div class="flex items-center gap-2 pr-2 border-r" :style="{ borderColor: getFactionColor(imp.targetId) + '40' }">
                                                <i :class="getFactionLogo(imp.targetId)" :style="{ color: getFactionColor(imp.targetId) }"></i>
                                                <span class="font-bold text-xs" :style="{ color: getFactionColor(imp.targetId) }">{{ imp.targetName }}</span>
                                            </div>
                                            <div class="font-mono-tech text-xs pl-2 text-[var(--text-main)]">
                                                <span class="text-[var(--text-dim)] mr-1">{{ imp.attrLabel }}</span>
                                                <span class="font-bold">{{ imp.change }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4 flex justify-center"><i class="fa-solid text-xl transition-transform duration-300" :class="event.isOpen ? 'fa-chevron-up text-indigo-500' : 'fa-chevron-down text-[var(--text-dim)]'"></i></div>
                                </div>

                                <transition name="slide-up">
                                    <div v-if="event.isOpen" class="bg-[var(--bg-glass)] border-t border-[var(--border-highlight)] p-8 relative z-10">
                                        <div v-if="isEditingEvent(tIdx, eIdx)" @click.stop><textarea v-model="event.content" class="w-full h-96 input-tech p-4 font-mono-tech rounded"></textarea></div>
                                        <div v-else class="md-content text-lg" v-html="renderMarkdown(event.content)"></div>
                                        <div class="pt-6 border-t border-[var(--border-dim)] flex justify-end gap-4 mt-8">
                                            <button @click.stop="copyToClipboard(event.content)" class="px-5 py-2 theme-rounded-sm border border-[var(--border-dim)] text-[var(--text-dim)] hover:text-[var(--text-main)] hover:bg-[var(--bg-panel)] transition font-bold text-xs uppercase tracking-widest"><i class="fa-regular fa-copy mr-2"></i> {{ t('btn_copy') }}</button>
                                            <button @click.stop="deleteEvent(tIdx, eIdx)" class="px-5 py-2 theme-rounded-sm border border-[var(--border-dim)] text-[var(--text-dim)] hover:text-red-400 hover:bg-red-900/20 transition font-bold text-xs uppercase tracking-widest"><i class="fa-solid fa-trash mr-2"></i> {{ t('btn_delete') }}</button>
                                        </div>
                                    </div>
                                </transition>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="h-40"></div>
            </div>
        </section>

        <!-- 右侧：指挥台 -->
        <aside class="w-2/5 bg-[var(--bg-panel)] flex flex-col shrink-0 shadow-[0_0_50px_var(--shadow-color)] z-40 border-l border-[var(--border-dim)] transition-colors duration-300">
            <div class="flex border-b border-[var(--border-dim)] bg-[var(--bg-sidebar)]">
                <button @click="tabs.right = 'staging'" :class="tabs.right === 'staging' ? 'border-indigo-500 text-[var(--text-main)] bg-[var(--bg-panel)]' : 'border-transparent text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="flex-1 py-4 border-b-4 font-bold transition text-sm tracking-wide"><i class="fa-solid fa-layer-group mr-2"></i> {{ t('tab_pending') }} <span v-if="pendingEvents.length" class="ml-2 bg-indigo-600 text-white text-[10px] px-2 py-0.5 rounded-full align-middle">{{pendingEvents.length}}</span></button>
                <button @click="tabs.right = 'input'" :class="tabs.right === 'input' ? 'border-indigo-500 text-[var(--text-main)] bg-[var(--bg-panel)]' : 'border-transparent text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="flex-1 py-4 border-b-4 font-bold transition text-sm tracking-wide"><i class="fa-solid fa-terminal mr-2"></i> {{ t('tab_console') }}</button>
            </div>

            <div class="h-[30%] min-h-[250px] border-b border-[var(--border-dim)] bg-[var(--bg-header)] overflow-y-auto p-5 relative">
                <div v-if="tabs.right === 'staging'" class="space-y-3">
                    <div v-for="(evt, idx) in pendingEvents" :key="'p-'+idx" class="bg-[var(--bg-badge)] border border-[var(--border-highlight)] theme-rounded p-4 cursor-pointer group hover:bg-[var(--bg-panel)] hover:border-indigo-500/50 transition relative overflow-hidden" @click="loadFromStaging(idx)">
                        <div class="absolute left-0 top-0 bottom-0 w-1" :style="{ backgroundColor: getFactionColor(evt.factionId) }"></div>
                        <div class="pl-3">
                            <div class="flex justify-between text-[10px] text-[var(--text-dim)] font-bold uppercase mb-1 font-mono-tech">
                                <span>{{ evt.timeStart }} - {{ evt.timeEnd }}</span>
                                <span :style="{ color: getFactionColor(evt.factionId) }">{{ getFactionName(evt.factionId) }}</span>
                            </div>
                            <div class="text-base font-bold text-[var(--text-main)] mb-2 truncate">{{ evt.summary }}</div>
                            <div class="flex flex-wrap gap-2">
                                <span v-for="imp in evt.impacts" class="text-[10px] px-2 py-0.5 theme-rounded-sm border font-mono-tech" :style="{ borderColor: getFactionColor(imp.targetId), color: getFactionColor(imp.targetId), backgroundColor: getFactionColor(imp.targetId)+'10' }">
                                    {{ imp.targetName }}: {{ imp.attrLabel }} {{ imp.change }}
                                </span>
                            </div>
                        </div>
                        <button @click.stop="pendingEvents.splice(idx, 1); saveGame('autosave.json')" class="absolute top-2 right-2 text-[var(--text-dim)] hover:text-red-400 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-times text-lg"></i></button>
                    </div>
                    <div v-if="pendingEvents.length === 0" class="h-full flex flex-col items-center justify-center text-[var(--text-dim)] opacity-50">
                        <i class="fa-solid fa-inbox text-5xl mb-3"></i>
                        <span class="font-mono-tech uppercase font-bold tracking-widest text-sm">{{ t('msg_empty_queue') }}</span>
                    </div>
                </div>
                <div v-if="tabs.right === 'input'" class="h-full">
                    <textarea v-model="rawInput" class="w-full h-full bg-transparent border-none outline-none text-[var(--text-main)] font-mono-tech p-2 resize-none text-base leading-relaxed" :placeholder="t('placeholder_input')"></textarea>
                </div>
            </div>

            <div class="flex-1 flex flex-col bg-[var(--bg-panel)] relative overflow-hidden">
                
                <!-- 1. 顶部：AI 按钮栏 -->
                <div class="p-4 bg-[var(--bg-sidebar)] border-b border-[var(--border-dim)] shadow-xl z-20 shrink-0">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest"><i class="fa-solid fa-microchip mr-1"></i> {{ t('ai_core_label') }}</span>
                        <span class="text-[10px] font-mono-tech text-[var(--text-dim)]">{{ settings.api.model }}</span>
                    </div>
                    <button @click="openContextModal" :disabled="isThinking" class="w-full py-4 theme-rounded-sm bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-500 hover:to-indigo-600 text-white font-bold text-sm tracking-widest shadow-lg shadow-indigo-900/30 transition disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-3">
                        <i :class="isThinking ? 'fa-solid fa-circle-notch fa-spin' : 'fa-solid fa-bolt'"></i>
                        {{ isThinking ? t('status_thinking') : t('btn_ai_deduce') }}
                    </button>
                </div>

                <!-- 2. 中间：滚动输入区域 (关键：flex-1 overflow-y-auto) -->
                <div class="flex-1 overflow-y-auto p-0 min-h-0">
                    
                    <!-- 行动方 & 时间 -->
                    <div class="p-5 border-b border-[var(--border-dim)] flex gap-4 bg-[var(--bg-header)]">
                        <div class="flex-1">
                            <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-1 tracking-wider">{{ t('label_actor') }}</label>
                            <select v-model="editor.factionId" class="w-full input-tech theme-rounded-sm p-3 text-sm font-bold outline-none">
                                <option value="" disabled selected>{{ t('option_ai_auto') }}</option>
                                <option value="global">{{ t('option_global') }}</option>
                                <option v-for="p in players" :value="p.id">{{ p.name }}</option>
                            </select>
                        </div>
                        <div class="w-1/4">
                            <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-1 tracking-wider">{{ t('label_start') }}</label>
                            <input v-model="editor.timeStart" class="w-full input-tech theme-rounded-sm p-3 text-sm font-mono-tech text-center outline-none">
                        </div>
                        <div class="w-1/4">
                            <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-1 tracking-wider">{{ t('label_end') }}</label>
                            <input v-model="editor.timeEnd" class="w-full input-tech theme-rounded-sm p-3 text-sm font-mono-tech text-center outline-none">
                        </div>
                    </div>

                    <!-- 摘要 -->
                    <div class="p-5 border-b border-[var(--border-dim)]">
                        <label class="block text-[10px] font-bold text-emerald-500 uppercase mb-2 tracking-widest">{{ t('label_summary') }}</label>
                        <textarea v-model="editor.summary" class="w-full h-24 input-tech theme-rounded-sm p-3 text-lg font-bold text-[var(--text-main)] resize-none outline-none leading-normal" placeholder="..."></textarea>
                    </div>

                    <!-- 状态变更 -->
                    <div class="p-5 border-b border-[var(--border-dim)] bg-[var(--bg-badge)]">
                        <label class="block text-[10px] font-bold text-amber-500 uppercase mb-3 tracking-widest">{{ t('label_impact') }}</label>
                        <div class="flex flex-wrap gap-3 mb-4">
                            <div v-for="(imp, idx) in editor.impacts" :key="idx" class="impact-badge" :style="{ borderColor: getFactionColor(imp.targetId), backgroundColor: getFactionColor(imp.targetId) + '15' }">
                                <div class="flex items-center gap-2 pr-2 border-r" :style="{ borderColor: getFactionColor(imp.targetId) + '40' }">
                                    <i :class="getFactionLogo(imp.targetId)" :style="{ color: getFactionColor(imp.targetId) }"></i>
                                    <span class="font-bold text-xs" :style="{ color: getFactionColor(imp.targetId) }">{{ imp.targetName }}</span>
                                </div>
                                <div class="font-mono-tech text-xs text-[var(--text-main)]">
                                    <span class="text-[var(--text-dim)] mr-1">{{ imp.attrLabel }}</span>
                                    <span class="font-bold">{{ imp.change }}</span>
                                </div>
                                <button @click="removeImpact(idx)" class="ml-1 text-[var(--text-dim)] hover:text-red-400"><i class="fa-solid fa-times"></i></button>
                            </div>
                        </div>
                        <div class="flex gap-3 items-center bg-[var(--bg-badge)] p-2 theme-rounded-sm border border-[var(--border-dim)]">
                            <select v-model="impactForm.targetId" class="bg-transparent text-xs font-bold text-[var(--text-dim)] p-2 w-32 outline-none"><option value="" disabled selected>Target</option><option v-for="p in players" :value="p.id">{{ p.name }}</option></select>
                            <div class="w-px h-6 bg-[var(--border-dim)]"></div>
                            <select v-model="impactForm.attrKey" class="bg-transparent text-xs font-bold text-[var(--text-dim)] p-2 w-28 outline-none"><option value="" disabled selected>Attr</option><option v-for="field in stat_schema" :value="field.key">{{ field.label }}</option></select>
                            <div class="px-2 text-[10px] text-[var(--text-dim)] font-mono-tech bg-[var(--bg-badge)] theme-rounded-sm h-8 flex items-center justify-center min-w-[40px]">{{ currentAttrValue }} <i class="fa-solid fa-arrow-right ml-1"></i></div>
                            <input v-model="impactForm.newValue" @keyup.enter="addImpact" placeholder="Val" class="input-tech text-emerald-400 font-bold font-mono-tech theme-rounded-sm p-2 w-24 outline-none text-center">
                            <button @click="addImpact" class="text-emerald-500 hover:text-[var(--text-main)] px-2 text-xl"><i class="fa-solid fa-circle-plus"></i></button>
                        </div>
                    </div>

                    <!-- 详细内容 (设置 min-h 防止挤压) -->
                    <div class="p-5 flex flex-col min-h-[400px] relative">
                         <label class="block text-[10px] font-bold text-indigo-400 uppercase mb-2 tracking-widest">{{ t('label_details') }}</label>
                         <textarea v-model="editor.content" class="flex-1 input-tech theme-rounded-sm p-4 text-base font-mono-tech text-[var(--text-main)] resize-none outline-none leading-relaxed h-full" placeholder="// ..."></textarea>
                         <div class="absolute bottom-8 right-8 z-20">
                            <button @click="addToStaging" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 theme-rounded-sm shadow-xl font-bold text-sm transition transform active:scale-95 hover:-translate-y-1 flex items-center gap-2"><i class="fa-solid fa-plus"></i> {{ t('btn_add_pending') }}</button>
                         </div>
                    </div>
                </div>

                <!-- 3. 底部：Commit 按钮 (关键：shrink-0 z-50) -->
                <div class="bg-[var(--bg-sidebar)] p-5 border-t border-[var(--border-dim)] flex justify-between items-center shadow-[0_-10px_40px_var(--shadow-color)] z-50 shrink-0 relative">
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] text-[var(--text-dim)] font-bold uppercase tracking-widest">Next Turn:</span>
                        <input v-model="pendingTurnRange" class="bg-[var(--bg-input)] border border-[var(--border-dim)] text-emerald-500 font-mono-tech text-sm font-bold theme-rounded-sm px-2 py-0.5 w-24 outline-none text-center" :placeholder="t('auto')">
                    </div>
                    <button @click="commitTurn" :disabled="pendingEvents.length === 0" class="px-8 py-3 bg-indigo-600 hover:bg-indigo-500 disabled:bg-[var(--bg-input)] disabled:text-[var(--text-dim)] text-white font-bold text-sm tracking-widest uppercase theme-rounded-sm shadow-lg transition transform active:scale-[0.98] flex items-center gap-3">
                        <i class="fa-solid fa-play"></i> {{ t('btn_commit') }}
                    </button>
                </div>

            </div>
        </aside>

    </main>


<!-- HIDDEN POSTER CANVAS -->
    <div id="poster-canvas">
        
        <!-- TEMPLATE 1: TERMINAL (完全修复版) -->
        <div v-if="ui.theme !== 'newspaper'" class="poster-terminal" :style="{ borderLeftColor: posterData.color }">
            <div class="bg-texture"></div>
            <i :class="posterData.icon" class="poster-watermark-logo" :style="{ color: posterData.color }"></i>
            
            <div class="poster-header">
                <div class="text-slate-400 font-mono-tech text-3xl font-bold tracking-wider flex items-center">
                    <i class="fa-regular fa-clock mr-4"></i>{{ posterData.timeDisplay }}
                </div>
                <div class="uppercase flex items-center gap-4 text-3xl font-bold tracking-wider whitespace-nowrap" :style="{ color: posterData.color }">
                    <i class="fa-solid fa-tower-broadcast opacity-80"></i> {{ posterData.factionName }}
                </div>
            </div>

            <div class="poster-body">
                <h1 class="leading-tight">{{ posterData.title }}</h1>
                
                <!-- 属性徽章：恢复左右分栏结构 -->
                <div v-if="posterData.badges && posterData.badges.length > 0" class="poster-badge-container">
                    <div v-for="(badge, i) in posterData.badges" :key="i" class="poster-badge" :style="{ borderColor: badge.color }">
                        <div class="poster-badge-left">
                            <i :class="badge.icon" :style="{ color: badge.color }"></i>
                            <span :style="{ color: badge.color }">{{ badge.name }}</span>
                        </div>
                        <div class="poster-badge-right">
                            <span class="text-slate-400 uppercase mr-4 tracking-wider">{{ badge.label }}</span>
                            <i class="fa-solid fa-arrow-right text-slate-600 mr-4 text-sm"></i>
                            <span class="font-bold text-white tracking-wide">{{ badge.val }}</span>
                        </div>
                    </div>
                </div>

                <div class="poster-md md-body" v-html="posterData.content"></div>
            </div>

            <div class="poster-footer">
                <div class="flex items-center gap-4"><i class="fa-solid fa-layer-group text-indigo-500"></i><span>LEVANT 自动化推演</span></div>
                <div class="flex flex-col items-end"><span class="text-slate-500 text-sm mb-1 font-bold">POWERED BY 絜矩 (QQ 2124223354)</span><span class="text-emerald-500 font-bold">LEVANT v1.0</span></div>
            </div>
        </div>

        <!-- TEMPLATE 2: NEWSPAPER (保留所有优化) -->
        <div v-else class="poster-newspaper">
            <div class="paper-grain"></div>
            
            <div class="news-header">
                <div class="brand">THE CHRONICLE</div>
                <div class="meta">
                    <span>Vol. {{ timeline.length + 1 }}</span>
                    <span>{{ posterData.timeDisplay }}</span>
                    <span>{{ posterData.factionName }}</span>
                </div>
            </div>

            <h1 class="headline">{{ posterData.title }}</h1>

            <div v-if="posterData.badges && posterData.badges.length > 0" class="badges-row">
                 <div v-for="(badge, i) in posterData.badges" :key="i" class="stamp-badge">
                     <i :class="badge.icon"></i>
                     <span>{{ badge.label }}: {{ badge.val }}</span>
                 </div>
            </div>

            <div class="poster-md content-cols" v-html="posterData.content"></div>

            <div style="margin-top: auto; border-top: 1px solid #333; padding-top: 20px; text-align: center; font-family: monospace; font-size: 14px; color: #555;">
                LEVANT 自动化推演 | AUTOMATED REPORT | POWERED BY 絜矩 (QQ 2124223354)
            </div>
        </div>

    </div>

    <!-- Context Assembler Modal -->
    <transition name="fade">
        <div v-if="showContextModal" class="modal-mask" @click.self="showContextModal = false">
            <div class="glass-panel theme-rounded w-[900px] h-[90vh] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-5 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center shrink-0">
                    <div>
                        <h3 class="text-xl font-bold text-[var(--text-main)]"><i class="fa-solid fa-layer-group mr-2 text-indigo-400"></i>{{ t('modal_context_title') }}</h3>
                        <p class="text-xs text-[var(--text-dim)] mt-1">{{ t('modal_context_subtitle') }}</p>
                    </div>
                    <button @click="showContextModal = false" class="text-[var(--text-dim)] hover:text-[var(--text-main)] text-xl"><i class="fa-solid fa-times"></i></button>
                </div>

                <div class="flex-1 flex overflow-hidden">
                    <!-- 左侧：组装流水线 -->
                    <div class="w-1/2 p-5 bg-[var(--bg-panel)] overflow-y-auto border-r border-[var(--border-dim)]">
                        <!-- System Prompt -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-[var(--text-dim)] uppercase tracking-widest">System Prompt (Temp)</label>
                            </div>
                            <textarea v-model="tempSystemPrompt" class="w-full h-24 bg-[var(--bg-badge)] border border-[var(--border-dim)] theme-rounded-sm p-2 text-xs text-[var(--text-main)] font-mono resize-none"></textarea>
                        </div>
                        <!-- 模块列表 (拖拽排序) -->
                        <div class="space-y-4">
                            <div v-for="type in contextConfig.order" :key="type">
                                <!-- 🔴 当前指令 -->
                                <div v-if="type === 'current'" class="border border-red-500/30 theme-rounded-sm bg-red-900/10">
                                    <div class="p-2 bg-red-900/20 border-b border-red-500/20 flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" v-model="contextConfig.includeCurrent" class="accent-red-500">
                                            <span class="text-xs font-bold text-red-400 uppercase">🔴 {{ t('ctx_current') }}</span>
                                        </div>
                                        <div class="flex gap-1 text-[var(--text-dim)] text-[10px]">
                                            <button @click="moveContextItem('current', -1)"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('current', 1)"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                    <div v-if="contextConfig.includeCurrent" class="p-2 text-[10px] text-[var(--text-dim)] font-mono space-y-1">
                                        <div v-if="rawInput" class="truncate">CMD: {{ rawInput }}</div>
                                        <div v-if="editor.summary" class="truncate text-[var(--text-main)]">Summary: {{ editor.summary }}</div>
                                    </div>
                                </div>
                                <!-- 全局变量 -->
                                <div v-if="type === 'global'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" v-model="contextConfig.includeGlobal" class="accent-indigo-500">
                                            <span class="text-xs font-bold text-indigo-400 uppercase">{{ t('ctx_global') }}</span>
                                        </div>
                                        <div class="flex gap-1 text-[var(--text-dim)] text-[10px]">
                                            <button @click="moveContextItem('global', -1)"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('global', 1)"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <!-- 规则 -->
                                <div v-if="type === 'rules'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" v-model="contextConfig.includeRules" class="accent-indigo-500">
                                            <span class="text-xs font-bold text-amber-400 uppercase">{{ t('ctx_rules') }}</span>
                                        </div>
                                        <div class="flex gap-1 text-[var(--text-dim)] text-[10px]">
                                            <button @click="moveContextItem('rules', -1)"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('rules', 1)"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Lore -->
                                <div v-if="type === 'lore'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs font-bold text-emerald-400 uppercase">{{ t('ctx_lore') }}</span>
                                        </div>
                                        <div class="flex gap-1 text-[var(--text-dim)] text-[10px]">
                                            <button @click="moveContextItem('lore', -1)"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('lore', 1)"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                    <div class="p-2 space-y-1 max-h-40 overflow-y-auto">
                                        <div v-for="(entry, i) in contextConfig.loreList" :key="i" class="flex items-center gap-2 context-item" :class="{'active': entry.active, 'disabled': !entry.active}">
                                            <input type="checkbox" v-model="entry.active" class="accent-emerald-500">
                                            <span class="text-xs text-[var(--text-main)] truncate flex-1">{{ entry.keys }}</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Players -->
                                <div v-if="type === 'players'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs font-bold text-blue-400 uppercase">{{ t('ctx_entities') }}</span>
                                        </div>
                                        <div class="flex gap-1 text-[var(--text-dim)] text-[10px]">
                                            <button @click="moveContextItem('players', -1)"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('players', 1)"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                    <div class="p-2 space-y-1 max-h-40 overflow-y-auto">
                                        <div v-for="(p, i) in contextConfig.playerList" :key="i" class="flex items-center gap-2 context-item" :class="{'active': p.active, 'disabled': !p.active}">
                                            <input type="checkbox" v-model="p.active" class="accent-blue-500">
                                            <span class="text-xs text-[var(--text-main)] truncate flex-1">{{ p.name }}</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- History -->
                                <div v-if="type === 'history'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" v-model="contextConfig.includeHistory" class="accent-indigo-500">
                                            <span class="text-xs font-bold text-[var(--text-main)] uppercase">{{ t('ctx_history') }}</span>
                                        </div>
                                        <div class="flex gap-1 text-[var(--text-dim)] text-[10px]">
                                            <button @click="moveContextItem('history', -1)"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('history', 1)"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                    <div v-if="contextConfig.includeHistory" class="p-4">
                                        <div class="flex justify-between text-xs text-[var(--text-dim)] mb-2">
                                            <span>Depth: {{ contextConfig.historyDepth }} Turns</span>
                                        </div>
                                        <input type="range" v-model.number="contextConfig.historyDepth" min="0" max="20" class="w-full h-1 bg-[var(--border-dim)] theme-rounded-sm appearance-none cursor-pointer">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧：实时预览 -->
                    <div class="w-1/2 p-5 bg-[var(--bg-header)] flex flex-col">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-[var(--text-dim)] uppercase tracking-widest">Payload Preview (What AI Sees)</label>
                            <span class="text-xs font-mono text-indigo-400">{{ finalContextPreview.length }} chars</span>
                        </div>
                        <textarea readonly :value="finalContextPreview" class="flex-1 w-full bg-[var(--bg-deep)] border border-[var(--border-dim)] theme-rounded-sm p-4 text-xs font-mono text-[var(--text-dim)] resize-none outline-none leading-relaxed"></textarea>
                    </div>
                </div>

                <div class="p-5 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center shrink-0">
                    <div class="text-xs text-[var(--text-dim)]">AI will generate based on the preview content.</div>
                    <button @click="runAiInference" :disabled="isThinking" class="px-8 py-3 theme-rounded-sm bg-emerald-600 hover:bg-emerald-500 text-white font-bold text-sm shadow-lg transition flex items-center gap-2">
                        <i v-if="isThinking" class="fa-solid fa-circle-notch fa-spin"></i>
                        <i v-else class="fa-solid fa-bolt"></i>
                        EXECUTE
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <!-- Modals (Settings) -->
    <transition name="fade">
        <div v-if="showSettings" class="modal-mask" @click.self="showSettings=false">
            <div class="glass-panel theme-rounded w-[600px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-6 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center">
                    <h2 class="text-xl font-bold"><i class="fa-solid fa-sliders mr-2 text-[var(--text-dim)]"></i> {{ t('settings_title') }}</h2>
                    <button @click="showSettings = false" class="text-[var(--text-dim)] hover:text-[var(--text-main)] text-xl"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-8 space-y-8 bg-[var(--bg-panel)] max-h-[70vh] overflow-y-auto">
                    <!-- UI 设置 -->
                    <section>
                        <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-4 pb-2 border-b border-[var(--border-dim)]">{{ t('settings_ui') }}</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-[var(--text-dim)] mb-2">{{ t('settings_theme') }}</label>
                                <select v-model="ui.theme" class="w-full input-tech theme-rounded-sm p-3 text-sm outline-none">
                                    <option value="terminal">Terminal (Dark)</option>
                                    <option value="newspaper">Newspaper (Light)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-[var(--text-dim)] mb-2">{{ t('settings_lang') }}</label>
                                <select v-model="ui.lang" class="w-full input-tech theme-rounded-sm p-3 text-sm outline-none">
                                    <option value="zh">中文 (Chinese)</option>
                                    <option value="en">English</option>
                                    <option value="ja">日本語 (Japanese)</option>
                                </select>
                            </div>
                        </div>
                    </section>
                    
                    <section>
                        <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-4 pb-2 border-b border-[var(--border-dim)]">LLM API</h3>
                        <div class="space-y-4">
                            <div><label class="block text-xs font-bold text-[var(--text-dim)] mb-2">Provider</label><select v-model="settings.api.provider" class="w-full input-tech theme-rounded-sm p-3 text-sm outline-none"><option value="Gemini">Gemini (Google)</option><option value="OpenAI">OpenAI Compatible</option></select></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-[var(--text-dim)] mb-2">Base URL</label><input v-model="settings.api.baseUrl" class="w-full input-tech theme-rounded-sm p-3 text-sm outline-none"></div>
                                <div><label class="block text-xs font-bold text-[var(--text-dim)] mb-2">Model</label><input v-model="settings.api.model" class="w-full input-tech theme-rounded-sm p-3 text-sm outline-none"></div>
                            </div>
                            <div><label class="block text-xs font-bold text-[var(--text-dim)] mb-2">API Key</label><input v-model="settings.api.key" type="password" class="w-full input-tech theme-rounded-sm p-3 text-sm outline-none"></div>
                        </div>
                    </section>
                    
                    <!-- 新增代理设置区块 -->
                    <section>
                        <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-4 pb-2 border-b border-[var(--border-dim)]">Network Proxy</h3>
                        <div class="flex items-center gap-4 bg-[var(--bg-badge)] p-3 theme-rounded-sm border border-[var(--border-dim)]">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" v-model="settings.proxy.enabled" id="useProxy" class="accent-indigo-500 w-4 h-4">
                                <label for="useProxy" class="text-sm font-bold cursor-pointer select-none">Enable Local Proxy</label>
                            </div>
                            <div class="h-6 w-px bg-[var(--border-dim)] mx-2"></div>
                            <div class="flex-1 flex items-center gap-2" :class="{'opacity-50 pointer-events-none': !settings.proxy.enabled}">
                                <label class="text-xs font-mono text-[var(--text-dim)]">127.0.0.1:</label>
                                <input v-model="settings.proxy.port" placeholder="7890" class="w-20 input-tech theme-rounded-sm p-1.5 text-center text-sm font-mono outline-none">
                            </div>
                        </div>
                    </section>

                    <section>
                         <h3 class="text-xs font-bold text-emerald-400 uppercase tracking-widest mb-4 pb-2 border-b border-[var(--border-dim)]">System Prompt</h3>
                         <textarea v-model="settings.prompts.system" class="w-full h-32 input-tech theme-rounded-sm p-3 text-xs font-mono resize-none outline-none text-[var(--text-dim)]"></textarea>
                    </section>
                </div>
                <div class="p-6 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-end gap-4"><button @click="showSettings = false" class="px-5 py-2 theme-rounded-sm bg-[var(--bg-badge)] text-[var(--text-dim)] font-bold text-sm hover:text-[var(--text-main)]">{{ t('btn_cancel') }}</button><button @click="saveSettings" class="px-6 py-2 theme-rounded-sm bg-emerald-600 text-white font-bold text-sm shadow-lg hover:bg-emerald-500">{{ t('btn_save') }}</button></div>
            </div>
        </div>
    </transition>

    <!-- Modals (Faction) -->
    <transition name="fade">
        <div v-if="showFactionModal" class="modal-mask" @click.self="closeFactionModal">
            <div class="glass-panel theme-rounded w-[550px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-6 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center">
                    <h3 class="text-xl font-bold">{{ editingFaction.id ? t('modal_edit_entity') : t('modal_new_entity') }}</h3>
                    <button @click="closeFactionModal" class="text-[var(--text-dim)] hover:text-[var(--text-main)] text-xl"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-8 overflow-y-auto max-h-[70vh] space-y-6 bg-[var(--bg-panel)]">
                    <div><label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('label_name') }}</label><input v-model="editingFaction.name" class="w-full input-tech p-3 theme-rounded-sm text-lg font-bold outline-none"></div>
                    <div>
                        <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('label_icon_color') }}</label>
                        <div class="flex gap-4">
                            <input v-model="editingFaction.logo" placeholder="fa-solid fa-..." class="flex-1 input-tech p-3 theme-rounded-sm text-sm font-mono outline-none">
                            <div class="flex items-center gap-2 bg-[var(--bg-badge)] p-1 theme-rounded-sm border border-[var(--border-dim)]">
                                <input type="color" v-model="editingFaction.color" class="h-8 w-8 bg-transparent border-none cursor-pointer">
                                <input v-model="editingFaction.color" class="w-20 bg-transparent text-xs font-mono uppercase outline-none text-[var(--text-dim)]">
                            </div>
                        </div>
                    </div>
                    <div><label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('label_desc') }}</label><textarea v-model="editingFaction.desc" class="w-full h-28 input-tech p-3 theme-rounded-sm text-sm resize-none outline-none"></textarea></div>
                    <div class="pt-4 border-t border-[var(--border-dim)]">
                        <label class="block text-xs font-bold text-amber-500 uppercase mb-4">{{ t('label_stats') }}</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div v-for="field in stat_schema" :key="field.key"><label class="block text-[10px] text-[var(--text-dim)] font-bold mb-1">{{ field.label }}</label><input v-model="editingFaction.stats[field.key]" class="w-full input-tech p-2 theme-rounded-sm text-emerald-400 font-mono-tech font-bold text-sm outline-none"></div>
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center">
                    <button v-if="editingFaction.id" @click="deleteFaction" class="text-red-500 font-bold text-sm hover:text-red-400"><i class="fa-solid fa-trash mr-2"></i>{{ t('btn_destroy') }}</button><div v-else></div>
                    <div class="flex gap-4"><button @click="closeFactionModal" class="px-5 py-2 theme-rounded-sm bg-[var(--bg-badge)] text-[var(--text-dim)] font-bold text-sm hover:text-[var(--text-main)]">{{ t('btn_cancel') }}</button><button @click="saveFaction" class="px-6 py-2 theme-rounded-sm bg-indigo-600 text-white font-bold text-sm shadow-lg hover:bg-indigo-500">{{ t('btn_confirm') }}</button></div>
                </div>
            </div>
        </div>
    </transition>

    <!-- Modals (Save/Load) -->
    <transition name="fade">
        <div v-if="showSaveLoadModal" class="modal-mask" @click.self="showSaveLoadModal = false">
            <div class="glass-panel theme-rounded w-[550px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-6 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center">
                    <h3 class="text-xl font-bold"><i class="fa-solid fa-hard-drive mr-2 text-indigo-400"></i>{{ t('modal_files') }}</h3>
                    <button @click="showSaveLoadModal = false" class="text-[var(--text-dim)] hover:text-[var(--text-main)] text-xl"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-8 bg-[var(--bg-panel)]">
                    <div class="mb-6"><label class="block text-sm font-bold text-[var(--text-dim)] mb-3">{{ t('label_save_as') }}</label><div class="flex gap-3"><input v-model="newSaveFilename" @keyup.enter="saveGame(newSaveFilename)" placeholder="Filename..." class="flex-1 input-tech p-3 theme-rounded-sm text-sm font-mono outline-none"><button @click="saveGame(newSaveFilename)" :disabled="!newSaveFilename.trim()" class="px-6 py-2 bg-indigo-600 text-white theme-rounded-sm font-bold text-sm hover:bg-indigo-500 disabled:opacity-50">{{ t('btn_save') }}</button></div></div>
                    <div class="border-t border-[var(--border-dim)] pt-6">
                        <label class="block text-sm font-bold text-[var(--text-dim)] mb-3">{{ t('label_local_files') }}</label>
                        <div class="max-h-[40vh] overflow-y-auto space-y-2 pr-2">
                            <div v-for="file in saveFiles" :key="file" class="flex justify-between items-center bg-[var(--bg-badge)] p-3 theme-rounded-sm border border-[var(--border-dim)] hover:border-[var(--text-dim)] group">
                                <span class="font-mono text-sm text-emerald-400 font-bold"><i class="fa-solid fa-file-code mr-3 opacity-50"></i>{{ file }}</span>
                                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition"><button @click="loadGame(file)" class="px-3 py-1 bg-emerald-700 text-white theme-rounded-sm text-xs font-bold hover:bg-emerald-600">{{ t('btn_load') }}</button><button @click="saveGame(file)" class="px-3 py-1 bg-amber-700 text-white theme-rounded-sm text-xs font-bold hover:bg-amber-600">{{ t('btn_overwrite') }}</button><button @click="deleteSave(file)" class="px-3 py-1 bg-red-800 text-white theme-rounded-sm text-xs hover:bg-red-700"><i class="fa-solid fa-trash"></i></button></div>
                            </div>
                            <div v-if="saveFiles.length===0" class="text-center text-[var(--text-dim)] italic p-4">{{ t('msg_no_files') }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <!-- Modals (Script Gen) -->
    <transition name="fade">
        <div v-if="showScriptGenModal" class="modal-mask" @click.self="showScriptGenModal = false">
            <div class="glass-panel theme-rounded w-[600px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-6 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center"><h3 class="text-xl font-bold">{{ t('modal_script_gen') }}</h3><button @click="showScriptGenModal = false" class="text-[var(--text-dim)] hover:text-[var(--text-main)]"><i class="fa-solid fa-times"></i></button></div>
                <div class="p-8 bg-[var(--bg-panel)] gap-6 flex flex-col">
                    <p class="text-sm text-[var(--text-dim)] leading-relaxed bg-[var(--bg-badge)] p-4 theme-rounded-sm border border-[var(--border-dim)]">{{ t('msg_script_gen_hint') }}</p>
                    <textarea v-model="scriptGenPrompt" class="w-full h-40 input-tech p-4 theme-rounded-sm text-base resize-none outline-none" placeholder="Cyberpunk... Magic..."></textarea>
                </div>
                <div class="p-6 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-end">
                    <button @click="generateScript" :disabled="isThinking || !scriptGenPrompt.trim()" class="w-full py-4 theme-rounded-sm bg-gradient-to-r from-indigo-600 to-indigo-700 text-white font-bold text-lg tracking-widest shadow-lg hover:from-indigo-500 hover:to-indigo-600 flex justify-center items-center gap-3 disabled:opacity-50"><i :class="isThinking ? 'fa-solid fa-circle-notch fa-spin' : 'fa-solid fa-meteor'"></i> {{ isThinking ? t('status_generating') : t('btn_start_gen') }}</button>
                </div>
            </div>
        </div>
    </transition>
</div>

<script>
    const { createApp } = Vue;
    const API_BASE = "http://127.0.0.1:8000";

    createApp({
        data() {
            return {
                serverConnected: false, isThinking: false, currentSaveFile: 'savegame.json',
                showSettings: false, showFactionModal: false, showSaveLoadModal: false, showScriptGenModal: false, showContextModal: false,
                saveFiles: [], newSaveFilename: '', scriptGenPrompt: '', rawInput: '',
                editingFaction: { id: '', name: '', logo: '', stats: {} },
                editingTurnId: null, editingEventId: null,
                tabs: { left: 'players', right: 'input' },
                
                // --- New UI Settings ---
                ui: { theme: 'terminal', lang: 'zh' },

                settings: {
                    api: { provider: 'Gemini', baseUrl: '', model: 'gemini-2.5-flash', key: '' },
                    // 新增 proxy 设置
                    proxy: { enabled: true, port: '7890' }, 
                    prompts: { 
                        system: `你是一个高智能的战略推演引擎核心。任务：根据【世界设定】、【历史脉络】、【势力状态】和用户的【原始指令】，推演下一步事件。【核心原则】1. **连续性**：你拥有完整的历史记忆。2. **状态机**：根据【势力状态】中的当前值(Old Value)，结合剧情力度，计算出新值(New Value)。3. **数据化**：你的输出不仅仅是小说，更是数据库的更新指令。【输出格式】严格 JSON 对象（无Markdown）：{"factionId": "行动方ID (或 global)","timeStart": "推演开始时间","timeEnd": "推演结束时间","summary": "简报标题 (新闻标题风格)","content": "史实风格的详细正文 (Markdown格式)","impacts": [{ "targetId": "目标ID", "attrKey": "属性Key", "newValue": "新值" }]}`, 
                        script_generator: `You are a JSON generation machine. Your ONLY task is to create a valid JSON object based on the user's request. DO NOT output ANY text, explanations, or markdown before or after the JSON object. Your entire response MUST be a single, valid JSON object. The JSON object MUST have these five top-level keys: "stat_schema", "lorebook", "players", "timeline", "global_vars". - "stat_schema": MUST be an array of objects. - "players": Each player object MUST have a "logo" property containing a Font Awesome 6 free icon class name (e.g., 'fa-solid fa-dragon'). - "global_vars": MUST be an array of objects like {"key": "Year", "value": "2024"}. - "timeline": MUST be an array containing at least one turn object. EXAMPLE RESPONSE STRUCTURE: { "stat_schema": [ { "key": "type", "label": "Type" } ], "global_vars": [{"key":"Era", "value":"Cyberpunk"}], "lorebook": [], "players": [ { "id": "p_1", "name": "Corp", "logo": "fa-solid fa-building", "color": "#00aaff", "desc": "Desc", "stats": { "type": "Corp" } } ], "timeline": [ { "id": 1, "timeRange": "Start", "events": [ { "factionId": "global", "timeStart": "Day 1", "timeEnd": "Day 1", "summary": "Start", "content": "Text", "impacts": [], "isOpen": false } ] } ] }`
                    }
                },
                
                // --- i18n Dictionary ---
                translations: {
                    app_title: { zh: "LEVANT 自动化推演", en: "LEVANT Auto-Deduction", ja: "LEVANT 自動演繹" },
                    status_online: { zh: "系统联机", en: "SYSTEM ONLINE", ja: "システム稼働中" },
                    status_offline: { zh: "离线模式", en: "OFFLINE MODE", ja: "オフライン" },
                    next_turn_label: { zh: "下一回合 / 序列", en: "NEXT TURN / SEQ", ja: "次のターン / シーケンス" },
                    auto: { zh: "自动", en: "AUTO", ja: "自動" },
                    btn_script_gen: { zh: "剧本生成", en: "Script Gen", ja: "シナリオ生成" },
                    btn_files: { zh: "档案管理", en: "Files", ja: "ファイル管理" },
                    tab_world: { zh: "世界", en: "World", ja: "世界" },
                    tab_entity: { zh: "实体", en: "Entities", ja: "実体" },
                    tab_lore: { zh: "资料", en: "Lore", ja: "資料" },
                    tab_rules: { zh: "规则", en: "Rules", ja: "ルール" },
                    btn_add_global: { zh: "添加全局状态", en: "Add Global Var", ja: "グローバル変数を追加" },
                    btn_new_entity: { zh: "注册新实体", en: "New Entity", ja: "新規実体登録" },
                    btn_add_lore: { zh: "新增资料条目", en: "Add Lore Entry", ja: "資料エントリ追加" },
                    btn_export_rules: { zh: "导出规则海报", en: "Export Rules", ja: "ルール出力" },
                    btn_add_rule: { zh: "添加属性字段", en: "Add Attribute", ja: "属性フィールド追加" },
                    msg_no_events: { zh: "等待情报输入...", en: "Awaiting Intelligence...", ja: "情報入力待ち..." },
                    btn_copy: { zh: "复制", en: "Copy", ja: "コピー" },
                    btn_delete: { zh: "删除", en: "Delete", ja: "削除" },
                    tab_pending: { zh: "待决", en: "Pending", ja: "保留中" },
                    tab_console: { zh: "指令台", en: "Console", ja: "コンソール" },
                    msg_empty_queue: { zh: "队列为空", en: "Queue Empty", ja: "キューが空です" },
                    placeholder_input: { zh: "// 输入原始指令...\n例如: #Cortex 试图入侵 #NeoTokyo", en: "// Input raw command...\ne.g., #Cortex attempts to hack #NeoTokyo", ja: "// コマンドを入力...\n例: #Cortex が #NeoTokyo に侵入を試みる" },
                    ai_core_label: { zh: "AI 智能核心 (Active)", en: "AI CORE (Active)", ja: "AI コア (稼働中)" },
                    btn_ai_deduce: { zh: "AI 智能补全 / 推演", en: "AI DEDUCTION / AUTO-COMPLETE", ja: "AI 自動補完 / 演繹" },
                    status_thinking: { zh: "正在进行战术推演...", en: "Calculating Strategy...", ja: "戦術演算中..." },
                    label_actor: { zh: "行动实体", en: "Actor", ja: "行動主体" },
                    label_start: { zh: "开始", en: "Start", ja: "開始" },
                    label_end: { zh: "结束", en: "End", ja: "終了" },
                    option_ai_auto: { zh: "AI 自动判断", en: "AI Auto-Detect", ja: "AI 自動判定" },
                    option_global: { zh: "全局事件", en: "Global Event", ja: "グローバルイベント" },
                    label_summary: { zh: "标题摘要", en: "Summary", ja: "要約" },
                    label_impact: { zh: "状态变更计算", en: "State Impact Calc", ja: "状態変化計算" },
                    label_details: { zh: "详细情报档案", en: "Detailed Intelligence", ja: "詳細情報アーカイブ" },
                    btn_add_pending: { zh: "加入待决序列", en: "Add to Pending", ja: "保留リストに追加" },
                    btn_commit: { zh: "执行推演 (Commit)", en: "COMMIT TURN", ja: "ターン実行 (Commit)" },
                    modal_context_title: { zh: "上下文装配与推演", en: "Context Assembler", ja: "コンテキストアセンブラ" },
                    modal_context_subtitle: { zh: "确认 AI 将接收到的“世界切片”以及“当前指令”。", en: "Confirm the 'World Slice' and 'Action' sent to AI.", ja: "AIに送信する「世界スライス」と「現在指令」を確認してください。" },
                    ctx_current: { zh: "当前指令与草稿", en: "Current Action", ja: "現在の指令" },
                    ctx_global: { zh: "世界全局变量", en: "Global Vars", ja: "グローバル変数" },
                    ctx_rules: { zh: "属性规则定义", en: "Stat Rules", ja: "属性ルール" },
                    ctx_lore: { zh: "资料设定 (Lore)", en: "Lore Entries", ja: "資料設定" },
                    ctx_entities: { zh: "参与实体", en: "Active Entities", ja: "参加実体" },
                    ctx_history: { zh: "历史回溯 (Turns)", en: "History", ja: "履歴" },
                    settings_title: { zh: "系统配置", en: "System Settings", ja: "システム設定" },
                    settings_ui: { zh: "界面与语言", en: "Interface & Language", ja: "UIと言語" },
                    settings_theme: { zh: "界面风格", en: "Theme", ja: "テーマ" },
                    settings_lang: { zh: "系统语言", en: "Language", ja: "言語" },
                    btn_cancel: { zh: "取消", en: "Cancel", ja: "キャンセル" },
                    btn_save: { zh: "保存配置", en: "Save Config", ja: "設定保存" },
                    modal_edit_entity: { zh: "编辑实体档案", en: "Edit Entity", ja: "実体編集" },
                    modal_new_entity: { zh: "注册新实体", en: "Register Entity", ja: "新規実体登録" },
                    label_name: { zh: "名称", en: "Name", ja: "名称" },
                    label_icon_color: { zh: "图标 & 颜色", en: "Icon & Color", ja: "アイコン & 色" },
                    label_desc: { zh: "描述", en: "Description", ja: "説明" },
                    label_stats: { zh: "属性面板", en: "Stats", ja: "ステータス" },
                    btn_destroy: { zh: "销毁数据", en: "Destroy Data", ja: "データ破棄" },
                    btn_confirm: { zh: "确认", en: "Confirm", ja: "確認" },
                    modal_files: { zh: "档案管理", en: "File Management", ja: "ファイル管理" },
                    label_save_as: { zh: "另存为", en: "Save As", ja: "名前を付けて保存" },
                    label_local_files: { zh: "本地档案", en: "Local Files", ja: "ローカルファイル" },
                    btn_load: { zh: "读取", en: "Load", ja: "読込" },
                    btn_overwrite: { zh: "覆盖", en: "Overwrite", ja: "上書" },
                    msg_no_files: { zh: "无存档", en: "No Files", ja: "ファイルなし" },
                    modal_script_gen: { zh: "AI 剧本生成", en: "AI Script Generation", ja: "AI シナリオ生成" },
                    msg_script_gen_hint: { zh: "描述您想要的世界观。AI 将自动生成实体、设定和开场。", en: "Describe your world. AI will generate entities, lore, and intro.", ja: "世界観を記述してください。AIが実体、設定、オープニングを自動生成します。" },
                    status_generating: { zh: "正在构建世界...", en: "Constructing World...", ja: "世界構築中..." },
                    btn_start_gen: { zh: "初始化剧本生成", en: "Initialize Generation", ja: "生成開始" }
                },

                stat_schema: [], lorebook: [], players: [], timeline: [], global_vars: [],
                pendingTurnRange: "", pendingEvents: [],
                editor: { factionId: '', timeStart: '', timeEnd: '', summary: '', content: '', impacts: [] },
                impactForm: { targetId: '', attrKey: '', newValue: '' },
                
                posterData: { title: '', factionName: '', color: '', icon: '', content: '', badges: [], timeDisplay: '' },
                quoteIdx: 0,
                quotes: [ "岁寒，然后知松柏之后凋也", "看看演员 王公 游民 盗贼的心电图", "人生若只如初见，何事秋风悲画扇", "我还想和你谈论宇宙和天空", "西郊有密林，助君出重围", "我一无所有 只有一颗赤子之心", "高树多悲风，海水扬其波", "你方唱罢我登场，反认他乡是故乡", "空山新林归鹧鸪，世间繁华梦一出", "昨夜西风凋碧树，独上高楼，望尽天涯路", "我听见那声音向我严正发问 我为明天尽些什么义务", "六朝何事？只成门户私计！" ],
                
                tempSystemPrompt: "",
                contextConfig: {
                    includeGlobal: true, includeRules: true, includeHistory: true, includeCurrent: true,
                    historyDepth: 3, loreList: [], playerList: [],
                    order: ['global', 'rules', 'lore', 'players', 'history', 'current']
                }
            }
        },
        watch: {
            'ui.theme': {
                handler(newTheme) {
                    document.body.setAttribute('data-theme', newTheme);
                },
                immediate: true
            }
        },
        async mounted() {
            const savedSettings = localStorage.getItem('levant_settings');
            if (savedSettings) {
                try {
                    const parsed = JSON.parse(savedSettings);
                    if(parsed.api) this.settings.api = { ...this.settings.api, ...parsed.api };
                    if(parsed.proxy) this.settings.proxy = { ...this.settings.proxy, ...parsed.proxy }; // 新增
                    if(parsed.prompts) this.settings.prompts = { ...this.settings.prompts, ...parsed.prompts };
                    if(parsed.ui) this.ui = { ...this.ui, ...parsed.ui }; 
                } catch(e) { console.error("Failed to load settings", e); }
            }

            document.body.setAttribute('data-theme', this.ui.theme);

            await this.loadGame(this.currentSaveFile);
            window.addEventListener('beforeunload', () => { if(this.serverConnected) this.saveGame('autosave.json'); });
            
            setInterval(() => {
                let nextIdx; do { nextIdx = Math.floor(Math.random() * this.quotes.length); } while (nextIdx === this.quoteIdx); 
                this.quoteIdx = nextIdx;
            }, 6000);
        },
        computed: {
            currentAttrValue() {
                if (!this.impactForm.targetId || !this.impactForm.attrKey) return '---';
                const p = this.players.find(x => x.id === this.impactForm.targetId);
                return p ? (p.stats[this.impactForm.attrKey] || 'N/A') : '???';
            },
            finalContextPreview() {
                let preview = "";
                this.contextConfig.order.forEach(type => {
                    if (type === 'global' && this.contextConfig.includeGlobal) {
                        preview += `【${this.t('ctx_global')}】\n${this.global_vars.map(g => `${g.key}: ${g.value}`).join('\n')}\n\n`;
                    }
                    if (type === 'rules' && this.contextConfig.includeRules) {
                        preview += `【${this.t('ctx_rules')}】\n${this.stat_schema.map(s => `${s.key}=${s.label}`).join(', ')}\n\n`;
                    }
                    if (type === 'lore') {
                        const activeLore = this.contextConfig.loreList.filter(l => l.active);
                        if (activeLore.length > 0) preview += `【${this.t('ctx_lore')}】\n${activeLore.map(l => `> [${l.keys}]: ${l.content}`).join('\n')}\n\n`;
                    }
                    if (type === 'players') {
                        const activePlayers = this.contextConfig.playerList.filter(p => p.active);
                        if (activePlayers.length > 0) {
                            preview += `【${this.t('ctx_entities')}】\n${activePlayers.map(p => {
                                const realP = this.players.find(x => x.id === p.id);
                                return `ID:${realP.id} | ${realP.name}\n  Desc: ${realP.desc}\n  Stats: ${JSON.stringify(realP.stats)}`;
                            }).join('\n\n')}\n\n`;
                        }
                    }
                    if (type === 'history' && this.contextConfig.includeHistory) {
                        let historyContext = `【${this.t('ctx_history')}】\n`;
                        const reversedTimeline = this.timeline.slice().reverse().slice(0, this.contextConfig.historyDepth);
                        reversedTimeline.forEach((turn) => {
                            historyContext += `=== Turn ${turn.id} (${turn.timeRange}) ===\n`;
                            turn.events.forEach(e => {
                                historyContext += `• [${e.timeStart}-${e.timeEnd}] ${e.summary}\n`;
                                if (e.impacts.length) { historyContext += `  -> Impact: ${e.impacts.map(i => `${i.targetName}.${i.attrLabel}: ${i.change}`).join('; ')}\n`; }
                            });
                        });
                        preview += historyContext + "\n";
                    }
                    if (type === 'current' && this.contextConfig.includeCurrent) {
                        preview += `【${this.t('ctx_current')}】\n`;
                        if (this.rawInput) preview += `> CMD: ${this.rawInput}\n`;
                        if (this.editor.factionId) preview += `> ActorID: ${this.editor.factionId}\n`;
                        if (this.editor.timeStart) preview += `> Time: ${this.editor.timeStart} - ${this.editor.timeEnd}\n`;
                        if (this.editor.summary) preview += `> Title Draft: ${this.editor.summary}\n`;
                        if (this.editor.content) preview += `> Content Draft: ${this.editor.content}\n`;
                        if (this.editor.impacts.length) {
                            preview += `> Planned Impacts: ${JSON.stringify(this.editor.impacts)}\n`;
                        }
                        preview += `\n`;
                    }
                });
                return preview;
            }
        },
        methods: {
            t(key) {
                if (!this.translations[key]) return key;
                return this.translations[key][this.ui.lang] || this.translations[key]['zh'];
            },
            renderMarkdown(text) { return marked.parse(text || ''); },
            getFactionColor(id) { if(id === 'global') return '#94a3b8'; const p = this.players.find(x => x.id === id); return p ? p.color : '#6366f1'; },
            getFactionName(id) { if (id === 'global') return this.t('option_global'); const p = this.players.find(x => x.id === id); return p ? p.name : 'Unknown'; },
            getFactionLogo(id) { if (id === 'global') return 'fa-solid fa-globe'; const p = this.players.find(x => x.id === id); return p && p.logo ? p.logo : 'fa-solid fa-users'; },
            getSchemaLabel(key) { const s = this.stat_schema.find(x => x.key === key); return s ? s.label : key; },
            formatTimeSpan(event) { if (!event.timeStart) return "Time ?"; if (!event.timeEnd || event.timeStart === event.timeEnd) return event.timeStart; return `${event.timeStart} - ${event.timeEnd}`; },
            
            async exportAsImage(type, data) {
                this.posterData = { title: '', factionName: '', color: '', icon: '', content: '', badges: [], timeDisplay: '' };
                const currentTurnTime = this.timeline.length > 0 ? this.timeline[this.timeline.length-1].timeRange : 'Current';
                if (type === 'faction') {
                    this.posterData.title = data.name;
                    this.posterData.factionName = "ENTITY FILE";
                    this.posterData.color = data.color;
                    this.posterData.icon = data.logo;
                    this.posterData.content = this.renderMarkdown(data.desc);
                    this.posterData.timeDisplay = currentTurnTime;
                    for(let key in data.stats) {
                        this.posterData.badges.push({ name: data.name, icon: data.logo, color: data.color, label: this.getSchemaLabel(key), val: data.stats[key] });
                    }
                } else if (type === 'event') {
                    this.posterData.title = data.summary;
                    this.posterData.factionName = this.getFactionName(data.factionId);
                    this.posterData.color = this.getFactionColor(data.factionId);
                    this.posterData.icon = this.getFactionLogo(data.factionId);
                    this.posterData.content = this.renderMarkdown(data.content);
                    this.posterData.timeDisplay = this.formatTimeSpan(data);
                    if(data.impacts) {
                        data.impacts.forEach(imp => { this.posterData.badges.push({ name: imp.targetName, icon: this.getFactionLogo(imp.targetId), color: this.getFactionColor(imp.targetId), label: imp.attrLabel, val: imp.change }); });
                    }
                } else if (type === 'lore') {
                    this.posterData.title = data.keys;
                    this.posterData.factionName = "LORE DATABASE";
                    this.posterData.color = "#10b981";
                    this.posterData.icon = "fa-solid fa-database";
                    this.posterData.content = this.renderMarkdown(data.content);
                    this.posterData.timeDisplay = currentTurnTime;
                } else if (type === 'rules') {
                    this.posterData.title = "SYSTEM RULES";
                    this.posterData.factionName = "CORE";
                    this.posterData.color = "#f59e0b";
                    this.posterData.icon = "fa-solid fa-sliders";
                    this.posterData.timeDisplay = currentTurnTime;
                    let content = "Current Rules:\n\n";
                    data.forEach(d => content += `- **${d.label}** [${d.key}]\n`);
                    this.posterData.content = this.renderMarkdown(content);
                }
                await this.$nextTick();
                const element = document.getElementById('poster-canvas');
                await new Promise(resolve => setTimeout(resolve, 100));
                try {
                    const canvas = await html2canvas(element, { backgroundColor: null, scale: 2, useCORS: true, logging: false });
                    const link = document.createElement('a');
                    link.download = `Levant_${type}_${Date.now()}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                } catch (e) { alert("Error generating image"); }
            },

            async openSaveLoadModal() {
                try {
                    const res = await axios.get(`${API_BASE}/api/saves`);
                    this.saveFiles = res.data.files;
                    this.showSaveLoadModal = true;
                } catch (e) { alert("Failed to fetch saves"); }
            },
            async loadGame(filename) {
                if (!filename) return;
                try {
                    const res = await axios.get(`${API_BASE}/api/state?filename=${filename}`);
                    this.applyState(res.data);
                    this.currentSaveFile = filename;
                    this.showSaveLoadModal = false;
                } catch (e) { this.serverConnected = false; }
            },
            async saveGame(filename) {
                if (!filename || !filename.trim()) return;
                if (!filename.endsWith('.json')) filename += '.json';
                try {
                    const stateData = { 
                        stat_schema: this.stat_schema, lorebook: this.lorebook, players: this.players, 
                        timeline: this.timeline, global_vars: this.global_vars, currentTurnPending: this.pendingEvents 
                    };
                    await axios.post(`${API_BASE}/api/state?filename=${filename}`, stateData);
                    this.currentSaveFile = filename;
                    this.serverConnected = true;
                    if (this.showSaveLoadModal) { this.openSaveLoadModal(); this.newSaveFilename = ''; }
                } catch (e) { console.error(e); }
            },
            async deleteSave(filename) {
                if (!confirm(`Delete "${filename}"?`)) return;
                try { await axios.delete(`${API_BASE}/api/saves/${filename}`); this.openSaveLoadModal(); } catch (e) { alert("Delete failed"); }
            },
            applyState(data) {
                const sanitizedData = JSON.parse(JSON.stringify(data));
                this.stat_schema = sanitizedData.stat_schema || []; 
                this.lorebook = sanitizedData.lorebook || []; 
                this.players = sanitizedData.players || []; 
                this.timeline = sanitizedData.timeline || []; 
                this.global_vars = sanitizedData.global_vars || [];
                this.pendingEvents = sanitizedData.currentTurnPending || [];
                this.serverConnected = true;
            },
            
            addGlobalVar() {
                this.global_vars.push({ key: 'New Var', value: 'Value' });
                this.saveGame('autosave.json');
            },

            openContextModal() {
                if (!this.settings.api.key) return alert("Please set API Key in settings.");
                const rawInputText = this.rawInput.trim(); 
                const editorDraft = this.editor.summary;
                if (!rawInputText && !editorDraft) return alert("Please input command or summary!");

                this.tempSystemPrompt = this.settings.prompts.system;
                const inputText = (rawInputText + " " + editorDraft).toLowerCase();
                this.contextConfig.loreList = this.lorebook.map(entry => {
                    let isActive = false;
                    if (entry.mode === 'on') isActive = true;
                    else if (entry.mode === 'auto') {
                        const keywords = entry.keys.split(/[,，]/).map(k => k.trim().toLowerCase()).filter(k => k);
                        isActive = keywords.some(k => inputText.includes(k));
                    }
                    return { ...entry, active: isActive, originalMode: entry.mode };
                });
                this.contextConfig.playerList = this.players.map(p => ({ id: p.id, name: p.name, logo: p.logo, active: true }));
                this.showContextModal = true;
            },

            moveContextItem(type, direction) {
                const idx = this.contextConfig.order.indexOf(type);
                if (idx < 0) return;
                const newIdx = idx + direction;
                if (newIdx >= 0 && newIdx < this.contextConfig.order.length) {
                    const temp = this.contextConfig.order[newIdx];
                    this.contextConfig.order[newIdx] = this.contextConfig.order[idx];
                    this.contextConfig.order[idx] = temp;
                }
            },

            async runAiInference() {
                this.isThinking = true;
                const finalContext = this.finalContextPreview;
                const payload = { 
                    provider: this.settings.api.provider, apiKey: this.settings.api.key, model: this.settings.api.model, 
                    useProxy: this.settings.proxy.enabled, proxyPort: this.settings.proxy.port, // 新增参数
                    systemPrompt: this.tempSystemPrompt, context: finalContext, userPrompt: `Generate next turn JSON based on Context and Action.` 
                };

                try {
                    const res = await axios.post(`${API_BASE}/api/ai/generate`, payload);
                    const match = res.data.result.match(/\{[\s\S]*\}/);
                    if (!match) throw new Error("AI did not return a valid JSON object.");
                    
                    const parsed = JSON.parse(match[0]);
                    this.editor.content = parsed.content || ""; 
                    this.editor.summary = parsed.summary || ""; 
                    this.editor.factionId = parsed.factionId || ""; 
                    this.editor.timeStart = parsed.timeStart || ""; 
                    this.editor.timeEnd = parsed.timeEnd || "";
                    
                    if(parsed.impacts && Array.isArray(parsed.impacts)) {
                        this.editor.impacts = []; 
                        parsed.impacts.forEach(imp => {
                            let target = this.players.find(p => p.id === imp.targetId) || this.players.find(p => p.name.includes(imp.targetId));
                            if (target) {
                                let schema = this.stat_schema.find(s => s.key === imp.attrKey) || this.stat_schema.find(s => s.label === imp.attrKey);
                                if (schema) {
                                    const oldVal = target.stats[schema.key] || '?'; 
                                    this.editor.impacts.push({ targetId: target.id, targetName: target.name, attrKey: schema.key, attrLabel: schema.label, change: `${oldVal} → ${imp.newValue}` }); 
                                }
                            }
                        });
                    }
                    this.showContextModal = false;
                } catch (e) { alert("AI Error: " + e.message); } 
                finally { this.isThinking = false; }
            },

            addImpact() { if(!this.impactForm.targetId || !this.impactForm.attrKey || this.impactForm.newValue === '') return; const t = this.players.find(p => p.id === this.impactForm.targetId); const s = this.stat_schema.find(k => k.key === this.impactForm.attrKey); const oldValue = t.stats[this.impactForm.attrKey] || '-'; this.editor.impacts.push({ targetId: this.impactForm.targetId, targetName: t.name, attrKey: this.impactForm.attrKey, attrLabel: s ? s.label : this.impactForm.attrKey, change: `${oldValue} → ${this.impactForm.newValue}` }); this.impactForm.targetId = ''; this.impactForm.attrKey = ''; this.impactForm.newValue = ""; },
            removeImpact(idx) { this.editor.impacts.splice(idx, 1); },
            addToStaging() { if (!this.editor.summary) return; this.pendingEvents.push(JSON.parse(JSON.stringify({ ...this.editor, factionId: this.editor.factionId || 'global', timeStart: this.editor.timeStart || '?', timeEnd: this.editor.timeEnd || '?', content: this.editor.content || this.editor.summary, isOpen: false }))); this.editor.summary = ""; this.editor.content = ""; this.editor.impacts = []; this.editor.factionId = ""; this.editor.timeStart = ""; this.editor.timeEnd = ""; this.tabs.right = 'staging'; this.saveGame('autosave.json'); },
            loadFromStaging(i) { Object.assign(this.editor, JSON.parse(JSON.stringify(this.pendingEvents[i]))); this.pendingEvents.splice(i,1); this.tabs.right = 'input'; this.saveGame('autosave.json'); },
            commitTurn() {
                if(this.pendingEvents.length === 0) return;
                const range = this.pendingTurnRange || "New Turn";
                const numericIds = this.timeline.map(t => parseInt(t.id, 10)).filter(id => !isNaN(id));
                const maxId = numericIds.length > 0 ? Math.max(...numericIds) : 0;
                const newEvents = JSON.parse(JSON.stringify(this.pendingEvents));
                this.timeline.push({ id: maxId + 1, timeRange: range, events: newEvents });
                newEvents.forEach(evt => {
                    if (evt.impacts) evt.impacts.forEach(imp => {
                        if (imp.change && imp.change.includes('→')) {
                            const newVal = imp.change.split('→')[1].trim();
                            const player = this.players.find(p => p.id === imp.targetId);
                            if (player && player.stats.hasOwnProperty(imp.attrKey)) { player.stats[imp.attrKey] = newVal; }
                        }
                    });
                });
                this.pendingEvents = []; this.pendingTurnRange = ""; this.saveGame('autosave.json');
                this.$nextTick(() => { const el = document.getElementById('timeline-scroll'); if(el) el.scrollTop = el.scrollHeight; });
            },
            deleteTurn(tIdx) { if (confirm(`Delete Turn?`)) { this.timeline.splice(tIdx, 1); this.saveGame('autosave.json'); } },
            toggleEventOpen(event) { if(!this.editingEventId && !this.editingTurnId) event.isOpen = !event.isOpen; },
            isEditingEvent(t, e) { return this.editingEventId === `${t}-${e}`; },
            enableEventEdit(t, e) { this.editingEventId = `${t}-${e}`; this.editingTurnId = null; },
            saveTurnEdit() { this.editingTurnId = null; this.saveGame('autosave.json'); },
            saveEventEdit() { this.editingEventId = null; this.saveGame('autosave.json'); },
            deleteEvent(t,e) { if(confirm("Delete Event?")) { this.timeline[t].events.splice(e,1); this.saveGame('autosave.json'); } },
            saveSettings() { 
                const toSave = { api: this.settings.api, proxy: this.settings.proxy, prompts: this.settings.prompts, ui: this.ui }; // 新增 proxy
                localStorage.setItem('levant_settings', JSON.stringify(toSave));
                this.showSettings = false; 
                alert("Settings Saved!"); 
            },
            addLoreEntry() { this.lorebook.unshift({ keys: '', content: '', mode: 'auto' }); },
            cycleLoreMode(e) { const m=['on','auto','off']; e.mode = m[(m.indexOf(e.mode)+1)%3]; this.saveGame('autosave.json') },
            addSchemaField() { const l=prompt("Label Name"); if(l) { const k=prompt("Key (English)"); if(k) { this.stat_schema.push({label:l, key:k}); this.players.forEach(p => { if(!p.stats[k]) p.stats[k] = '-'; }); this.saveGame('autosave.json'); } } },
            copyToClipboard(t) { navigator.clipboard.writeText(t); },
            openFactionModal(p) { if(p) { this.editingFaction = JSON.parse(JSON.stringify(p)); } else { this.editingFaction = {id:'', name:'', logo: 'fa-solid fa-users', color:'#ffffff', desc:'', stats:{}}; this.stat_schema.forEach(s => this.editingFaction.stats[s.key]='-'); } this.showFactionModal = true; },
            closeFactionModal() { this.showFactionModal = false; },
            saveFaction() { if(!this.editingFaction.name) return; if(this.editingFaction.id) { const i = this.players.findIndex(p => p.id === this.editingFaction.id); if(i !== -1) this.players[i] = JSON.parse(JSON.stringify(this.editingFaction)); } else { this.editingFaction.id = 'p'+Date.now(); this.players.push(JSON.parse(JSON.stringify(this.editingFaction))); } this.closeFactionModal(); this.saveGame('autosave.json'); },
            deleteFaction() { const i = this.players.findIndex(p => p.id === this.editingFaction.id); if(i !== -1 && confirm("Destroy Entity?")) { this.players.splice(i,1); this.closeFactionModal(); this.saveGame('autosave.json'); } },
            openScriptGenModal() { this.scriptGenPrompt = ''; this.showScriptGenModal = true; },
            async generateScript() {
                if (!this.settings.api.key) return alert("API Key missing");
                if (!confirm("This will overwrite current progress. Continue?")) return;
                this.isThinking = true;
                const payload = { 
                    provider: this.settings.api.provider, apiKey: this.settings.api.key, model: this.settings.api.model, 
                    useProxy: this.settings.proxy.enabled, proxyPort: this.settings.proxy.port, // 新增参数
                    systemPrompt: this.settings.prompts.script_generator, context: `Req: "${this.scriptGenPrompt}"`, userPrompt: "Generate JSON." 
                };
                try {
                    const res = await axios.post(`${API_BASE}/api/ai/generate`, payload);
                    const match = res.data.result.match(/\{[\s\S]*\}/);
                    if (!match) throw new Error("Invalid JSON");
                    this.applyState(JSON.parse(match[0]));
                    this.showScriptGenModal = false;
                } catch(e) { alert("Generation failed: " + e.message); } 
                finally { this.isThinking = false; }
            }
        }
    }).mount('#app');
</script>
</body>
</html>