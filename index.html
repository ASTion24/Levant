<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEVANT 自动化推演 v1.08</title>
    <link rel="icon" href="logo.png" type="image/png"> 
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
/* --- 截图模式专用样式 --- */
        .screenshot-overlay {
            position: fixed;
            pointer-events: none; /* 让鼠标事件穿透，以便 JS 计算下方的元素 */
            z-index: 99999;
            border: 2px solid #00ff00; /* 亮绿色边框 */
            background-color: rgba(0, 255, 0, 0.1); /* 淡淡的绿色遮罩 */
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5), inset 0 0 10px rgba(0, 255, 0, 0.2);
            transition: all 0.1s ease-out; /* 平滑跟随 */
            border-radius: 4px;
        }

        /* 截图时的提示文字 */
        .screenshot-label {
            position: absolute;
            top: -24px;
            left: 0;
            background: #00ff00;
            color: #000;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 2px;
            font-family: monospace;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* 截图时的全屏遮罩，防止误触其他按钮 */
        .screenshot-backdrop {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            cursor: crosshair; /* 十字准星光标 */
            z-index: 99998;
            background: rgba(0,0,0,0.01); /* 几乎透明，用于捕获点击 */
        }
        /* --- 核心配色 (CSS Variables) --- */
        :root {
            /* 默认 (Terminal / Dark) */
            --bg-deep: #020408;
            --bg-panel: #0a0f18;
            --bg-sidebar: #080b12;
            --bg-header: #05080c;
            --bg-input: #05080c;
            --bg-input-focus: #0f172a;
            --bg-glass: rgba(13, 19, 30, 0.95);
            --bg-card: rgba(20, 30, 45, 0.6);
            --bg-badge: rgba(0,0,0,0.3);
            --bg-hover: rgba(255,255,255,0.05);
            
            --text-main: #e2e8f0;       
            --text-dim: #64748b;        
            --text-accent: #6366f1;     
            --text-danger: #ef4444;     
            --text-inverse: #000000;    
            
            --border-highlight: rgba(255,255,255,0.08);
            --border-dim: #1e293b;      
            
            --shadow-color: rgba(0, 0, 0, 0.6);
            --font-main: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            --font-mono: 'JetBrains Mono', 'Consolas', monospace;

            /* 边框圆角 - Terminal 默认为圆润 */
            --radius-panel: 0.75rem;
            --radius-btn: 0.25rem;
            
            /* 纹理覆盖层 (Terminal 无) */
            --texture-overlay: none;
        }

        /* 主题：报社 (Newspaper / Light) */
        [data-theme="newspaper"] {
            /* 纸张纹理背景色 */
            --bg-deep: #f2f0e9;       
            --bg-panel: #fdfbf7;      
            --bg-sidebar: #e8e6e1;    
            --bg-header: #dedcd5;     
            --bg-input: #ffffff;      
            --bg-input-focus: #fffef0;
            --bg-glass: rgba(253, 251, 247, 0.98);
            --bg-card: #ffffff;
            --bg-badge: rgba(0,0,0,0.05);
            --bg-hover: rgba(0,0,0,0.05);

            --text-main: #1a1a1a;     /* 墨色 */
            --text-dim: #555555;      
            --text-accent: #8b0000;   /* 印泥红 */
            --text-danger: #dc2626;
            --text-inverse: #ffffff;

            --border-highlight: rgba(0,0,0,0.1);
            --border-dim: #a3a3a3;    
            
            --shadow-color: rgba(0, 0, 0, 0.15);
            /* 衬线字体组合 */
            --font-main: 'Georgia', 'Songti SC', 'STSong', serif; 
            --font-mono: 'Courier New', monospace;      

            /* 边框圆角 - 报社风格为直角 */
            --radius-panel: 0px;
            --radius-btn: 0px;

            /* 纸张噪点纹理 */
            --texture-overlay: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.08'/%3E%3C/svg%3E");
        }

        body { 
            background-color: var(--bg-deep); 
            color: var(--text-main); 
            font-family: var(--font-main); 
            font-size: 16px; 
            overflow: hidden; 
            line-height: 1.6; 
            transition: background-color 0.3s, color 0.3s;
        }

        /* 纹理层 */
        .app-texture {
            position: absolute; inset: 0; pointer-events: none; z-index: 1;
            background-image: var(--texture-overlay);
            opacity: 0.6; mix-blend-mode: multiply;
        }

        /* --- 通用圆角类 (适配不同主题) --- */
        .theme-rounded { border-radius: var(--radius-panel); }
        .theme-rounded-sm { border-radius: var(--radius-btn); }
        
        /* 报社模式下的特殊边框风格 */
        [data-theme="newspaper"] header { border-bottom: 3px double var(--border-dim); }
        [data-theme="newspaper"] aside { border-right: 1px solid var(--border-dim); }
        [data-theme="newspaper"] .info-card { border: 1px solid var(--border-dim); box-shadow: 2px 2px 0px rgba(0,0,0,0.1); }
        [data-theme="newspaper"] .modal-mask .glass-panel { border: 4px double #444; box-shadow: 10px 10px 0px rgba(0,0,0,0.2); }

        /* --- 滚动条 --- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: var(--border-dim); border-radius: var(--radius-btn); }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

        /* --- 组件风格 --- */
        .glass-panel { 
            background: var(--bg-glass); 
            backdrop-filter: blur(24px); 
            border: 1px solid var(--border-highlight); 
            box-shadow: 0 12px 40px var(--shadow-color); 
        }

        .info-card {
            background: var(--bg-card);
            border: 1px solid var(--border-highlight);
            transition: all 0.2s ease;
        }
        .info-card:hover {
            border-color: var(--text-dim);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .font-mono-tech { font-family: var(--font-mono); letter-spacing: -0.03em; }
        
        .input-tech {
            background: var(--bg-input); 
            border: 1px solid var(--border-dim); 
            color: var(--text-main); 
            transition: all 0.2s;
        }
        .input-tech:focus { 
            border-color: var(--text-accent); 
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1); 
            background: var(--bg-input-focus);
        }
        
        [data-theme="newspaper"] .input-tech {
            border: 1px solid #999;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.05);
            font-family: 'Courier New', monospace;
        }

        /* --- 模态框 --- */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.75); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
        }

        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        /* 状态变更框 */
        .impact-badge {
            display: inline-flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem;
            border-width: 1px; font-size: 0.9rem;
            box-shadow: 0 2px 5px var(--shadow-color); backdrop-filter: blur(4px);
            white-space: nowrap; color: var(--text-main);
            border-radius: var(--radius-btn);
        }

        /* Markdown */
        .md-content h1, .md-content h2 { 
            color: var(--text-main); font-weight: 800; margin-top: 1em; margin-bottom: 0.5em; 
            border-bottom: 2px solid var(--border-dim); padding-bottom: 0.2em; font-size: 1.4rem;
        }
        .md-content p { margin-bottom: 1em; text-align: justify; color: var(--text-main); opacity: 0.9; }
        .md-content strong { color: var(--text-accent); font-weight: 700; }
        .md-content ul { list-style: disc; padding-left: 1.5em; margin-bottom: 1em; }
        
        [data-theme="newspaper"] .md-content strong { color: #8b0000; font-weight: 900; background: rgba(0,0,0,0.05); padding: 0 4px; }
        [data-theme="newspaper"] .md-content h1 { text-transform: uppercase; border-bottom: 3px double #000; text-align: center; font-size: 2em; letter-spacing: 0.05em; margin-bottom: 1em; }

        /* 背景LOGO */
        .event-card-bg-logo { 
            position: absolute; top: -10px; right: -20px; font-size: 220px; opacity: 0.04; 
            transform: rotate(-10deg); transition: all 0.5s ease; z-index: 0; pointer-events: none;
        }
        .group\/event:hover .event-card-bg-logo { opacity: 0.08; transform: rotate(0deg) scale(1.05); }

        /* --- 上下文拖拽列表样式 --- */
        .context-item {
            display: flex; align-items: center; gap: 10px; padding: 8px;
            background: var(--bg-badge); border: 1px solid var(--border-highlight);
            margin-bottom: 4px; transition: all 0.2s; cursor: grab;
            color: var(--text-main);
            border-radius: var(--radius-btn);
        }
        .context-item:hover { background: var(--bg-hover); }
        .context-item:active { cursor: grabbing; }
        .context-item.active { border-left: 3px solid #10b981; }
        .context-item.disabled { opacity: 0.5; }

        /* --- 海报生成专用样式 --- */
        #poster-canvas {
            position: fixed; left: -9999px; top: 0; width: 1080px; padding: 0; margin: 0;
            box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden;
        }
        
        /* Style 1: Cyberpunk Terminal (暗色终端风格修正) */
        /* Style 1: Cyberpunk Terminal (完全还原 v1.3.1 样式) */
        .poster-terminal {
            width: 100%; height: 100%; min-height: 1200px;
            background: linear-gradient(to bottom, #0f1623, #05080c);
            color: white; font-family: 'PingFang SC', sans-serif;
            border-left-width: 24px; position: relative; display: flex; flex-direction: column;
        }
        .poster-terminal .bg-texture {
            position: absolute; inset: 0; z-index: 0; opacity: 0.05; pointer-events: none;
            background-image: radial-gradient(#94a3b8 1px, transparent 1px); background-size: 40px 40px;
        }
        .poster-terminal .poster-header {
            padding: 60px 70px; background: rgba(0,0,0,0.2); border-bottom: 2px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 10;
        }
        .poster-terminal .poster-body { padding: 50px 70px; position: relative; z-index: 10; flex: 1; }
        .poster-terminal h1 {
            font-size: 64px; line-height: 1.2; font-weight: 900; color: #fff; margin-bottom: 50px; letter-spacing: -0.02em;
            border-bottom: 2px solid #334155; padding-bottom: 20px;
        }
        .poster-terminal .md-body { font-size: 28px; line-height: 1.8; color: #cbd5e1; }
        .poster-terminal .md-body strong { color: #f59e0b; font-weight: bold; }

        /* 关键修复：徽章容器 */
        .poster-terminal .poster-badge-container {
            margin-bottom: 50px; display: flex; flex-direction: column; gap: 20px; position: relative; z-index: 10;
        }
        /* 关键修复：徽章本体（Flex布局） */
        .poster-terminal .poster-badge {
            display: flex; height: 64px; 
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; overflow: hidden; backdrop-filter: blur(10px);
        }
        /* 关键修复：徽章左侧 */
        .poster-terminal .poster-badge-left {
            display: flex; align-items: center; justify-content: center; 
            padding: 0 30px; padding-bottom: 4px; /* 微调对齐 */
            min-width: 200px; 
            background: rgba(0,0,0,0.2); border-right: 1px solid rgba(255,255,255,0.1);
            font-weight: 800; font-size: 22px; gap: 14px; height: 100%; color: inherit;
        }
        /* 关键修复：徽章右侧 */
        .poster-terminal .poster-badge-right {
            display: flex; align-items: center; 
            padding: 0 30px; padding-bottom: 4px; /* 微调对齐 */
            flex: 1;
            font-family: 'JetBrains Mono', monospace; font-size: 22px; height: 100%; line-height: 1;
        }

        .poster-terminal .poster-footer {
            padding: 40px 70px; background: rgba(0,0,0,0.4); border-top: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center; font-family: 'JetBrains Mono', monospace;
            color: #64748b; font-size: 18px; text-transform: uppercase; letter-spacing: 0.1em; position: relative; z-index: 10;
        }
        /* Style 2: Vintage Newspaper */
        .poster-newspaper {
            width: 100%; height: 100%; min-height: 1200px;
            background-color: #f4f1ea; color: #1a1a1a;
            font-family: 'Georgia', 'Songti SC', serif;
            position: relative; display: flex; flex-direction: column;
            padding: 60px;
        }
        .poster-newspaper .paper-grain {
            position: absolute; inset: 0; opacity: 0.15; z-index: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }
        .poster-newspaper .news-header {
            border-bottom: 4px double #1a1a1a; 
            padding-bottom: 15px; 
            
            /* --- 关键修改 --- */
            /* 原来可能是 40px，现在改为 15px */
            /* 作用：减少刊头和标题之间的空白，让标题往上走 */
            margin-bottom: 15px; 
            
            text-align: center; 
            position: relative; 
            z-index: 10;
        }
        .poster-newspaper .brand { font-size: 80px; font-weight: 900; letter-spacing: -0.02em; text-transform: uppercase; line-height: 1; margin-bottom: 50px; }
        .poster-newspaper .meta { display: flex; justify-content: space-between; border-top: 1px solid #1a1a1a; border-bottom: 1px solid #1a1a1a; padding: 10px 0; font-family: 'Courier New', monospace; font-size: 20px; text-transform: uppercase; font-weight: bold; }
        
        .poster-newspaper .headline { 
            font-size: 72px; 
            line-height: 1.1; 
            font-weight: 900; 
            
            /* --- 关键修改 --- */
            margin-top: 0;       /* 确保标题顶部没有多余间隙 */
            /* 原来可能是 20px，现在改为 50px */
            /* 作用：给下方的红色倾斜印章留出足够的旋转空间，防止重叠 */
            margin-bottom: 50px; 
            
            text-align: center; 
            font-family: 'Times New Roman', serif; 
            position: relative; 
            z-index: 10; 
        }
        
        .poster-newspaper .content-cols {
            column-count: 2; 
            column-gap: 60px; 
            font-size: 26px; 
            line-height: 1.6; 
            text-align: justify; 
            position: relative; 
            z-index: 10;
            
            /* --- 核心修复代码 --- */
            /* 1. 增加底部边距，强制把底部的双线栏顶下去，防止重叠 */
            margin-bottom: 80px; 
            
            /* 2. 自动占据剩余空间，但配合上面的margin确保不压线 */
            flex: 1; 
        }
        
        /* 1. 徽章容器：调整间距，防止正文过高 */
        .poster-newspaper .badges-row { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 30px; /* 增加水平间距，防止印章挤在一起 */
            margin-bottom: 30px; /* 减小下方外边距，让正文上移 */
            justify-content: center; 
            position: relative; 
            z-index: 10; 
            border-bottom: 2px solid #1a1a1a; 
            padding-bottom: 25px; /* 稍微留一点呼吸空间给旋转的印章 */
        }

        /* 2. 红色倾斜印章：核心样式找回 */
        .poster-newspaper .stamp-badge {
            border: 3px solid #8b0000; /* 加粗边框，更有印章感 */
            color: #8b0000; 
            padding: 8px 18px; 
            
            /* --- 关键：倾斜效果 --- */
            transform: rotate(-3deg); 
            
            font-family: 'Courier New', monospace; 
            font-weight: 900; 
            font-size: 22px;
            display: flex; 
            align-items: center; 
            gap: 10px; 
            text-transform: uppercase;
            background: transparent; 
            /* 增加一点粗糙的阴影，模拟印泥未干 */
            text-shadow: 1px 1px 0px rgba(139, 0, 0, 0.1);
            box-shadow: 2px 2px 0px rgba(139, 0, 0, 0.1);
        }
        /* [升级] 骰子滚动动画 - 幅度更大 */
        @keyframes dice-shake {
            0%, 100% { transform: rotate(0deg) scale(1); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(-8deg) scale(1.2); } /* 幅度更大 */
            20%, 40%, 60%, 80% { transform: rotate(8deg) scale(1.2); }  /* 幅度更大 */
        }
        .dice-rolling-animation {
            animation: dice-shake 0.8s cubic-bezier(.36,.07,.19,.97) both;
            color: var(--text-accent) !important;
        }
    </style>
</head>
<body>

<div id="app" class="h-screen flex flex-col relative text-[var(--text-main)]" :class="ui.theme === 'newspaper' ? 'font-serif' : 'font-sans'">
    <canvas id="map-analysis-canvas" style="display: none;"></canvas>
    <!-- 纸张纹理层 -->
    <div class="app-texture"></div>

    <!-- 顶部导航 -->
    <header role="banner" aria-label="Top Navigation" class="h-24 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex items-center px-8 justify-between shrink-0 z-50 shadow-sm relative w-full transition-colors duration-300">
        <!-- 左侧区域 -->
        <div class="flex items-center gap-6 shrink-0">
            <div class="w-14 h-14 theme-rounded bg-[var(--bg-panel)] border border-[var(--border-dim)] flex items-center justify-center text-indigo-500 text-3xl shadow-sm shrink-0">
                <img src="logo.png" class="w-15 h-15 object-contain">
            </div>
            
            <div class="flex flex-col justify-center">
                <div class="flex items-center">
                    <h1 class="font-black text-2xl text-[var(--text-main)] tracking-tight leading-none mr-2">{{ t('app_title') }}</h1>
                    <span class="text-[var(--text-dim)] font-light text-sm font-mono-tech mr-4">v1.08</span>
                    <div class="h-4 w-px bg-[var(--border-dim)] mr-4"></div>
                    <div class="flex items-center gap-2 px-3 py-1 theme-rounded-sm bg-[var(--bg-badge)] border border-[var(--border-dim)] text-indigo-400 font-mono-tech text-xs font-bold tracking-wide backdrop-blur-sm mr-4 shrink-0">
                        <span>POWERED BY 絜矩 (QQ 2124223354)</span>
                    </div>

                    <!-- 语录展示区 -->
                    <div class="relative h-8 w-[500px] overflow-hidden flex items-center hidden 2xl:flex">
                        <transition-group name="quote">
                            <div :key="quoteIdx" class="absolute left-0 text-[var(--text-dim)] text-sm font-serif italic tracking-widest whitespace-nowrap">
                                <i class="fa-solid fa-quote-left text-xs opacity-50 mr-2 transform -translate-y-1"></i>
                                {{ quotes[quoteIdx] }}
                                <i class="fa-solid fa-quote-right text-xs opacity-50 ml-1 transform -translate-y-1"></i>
                            </div>
                        </transition-group>
                    </div>
                </div>

                <!-- 状态信息 -->
                <div class="flex items-center gap-3 mt-1.5 text-[10px] font-mono-tech uppercase tracking-widest text-[var(--text-dim)]">
                    <span :class="serverConnected ? 'text-emerald-500' : 'text-red-500'" class="flex items-center gap-2 font-bold">
                        <i class="fa-solid fa-wifi"></i> {{ serverConnected ? t('status_online') : t('status_offline') }}
                    </span>
                    <span v-if="currentSaveFile" class="text-indigo-400 ml-2 border-l border-[var(--border-dim)] pl-2">
                        <i class="fa-solid fa-floppy-disk mr-1"></i> {{ currentSaveFile }}
                    </span>
                </div>
            </div>
        </div>

        <!-- 右侧区域 -->
        <div class="flex items-center gap-4 ml-auto shrink-0">
            <div class="text-right mr-4 border-r border-[var(--border-dim)] pr-6">
                <div class="text-[10px] text-[var(--text-dim)] uppercase font-bold tracking-widest mb-1">{{ t('next_turn_label') }}</div>
                <div class="text-emerald-500 font-mono-tech font-bold text-2xl leading-none tracking-tight">{{ pendingTurnRange || t('auto') }}</div>
            </div>
            <button @click="openScriptGenModal" class="h-11 px-5 theme-rounded-sm bg-[var(--bg-panel)] hover:bg-[var(--bg-hover)] text-[var(--text-accent)] border border-[var(--border-dim)] transition font-bold text-sm flex items-center gap-2">
                <i class="fa-solid fa-wand-sparkles"></i> {{ t('btn_script_gen') }}
            </button>
            <button @click="showSettings = true" class="h-11 w-11 theme-rounded-sm bg-[var(--bg-panel)] hover:bg-[var(--bg-hover)] text-[var(--text-dim)] border border-[var(--border-dim)] transition flex items-center justify-center">
                <i class="fa-solid fa-gear text-lg"></i>
            </button>
            <!-- [新增] 截图模式按钮 -->
            <button @click="toggleScreenshotMode" :class="isScreenshotMode ? 'bg-emerald-600 text-white border-emerald-500' : 'bg-[var(--bg-panel)] text-[var(--text-dim)]'" class="h-11 w-11 theme-rounded-sm hover:bg-[var(--bg-hover)] border border-[var(--border-dim)] transition flex items-center justify-center ml-2" title="截图模式">
                <i class="fa-solid fa-crop-simple text-lg"></i>
            </button>
            <button @click="openSaveLoadModal" class="h-11 px-6 theme-rounded-sm bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-900/40 transition font-bold text-sm border-t border-indigo-400/30 flex items-center gap-2">
                <i class="fa-solid fa-folder-open"></i> {{ t('btn_files') }}
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden z-10">
        
        <!-- 左侧：资料库 -->
        <aside role="region" aria-label="Library Panel" class="w-1/5 min-w-[380px] bg-[var(--bg-sidebar)] border-r border-[var(--border-dim)] flex flex-col shrink-0 z-30 relative shadow-lg transition-colors duration-300">
            <div class="grid grid-cols-4 p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] gap-1">
                <button @click="tabs.left = 'world'" :class="tabs.left==='world' ? 'bg-[var(--bg-panel)] text-[var(--text-main)] border-[var(--border-dim)]' : 'text-[var(--text-dim)] border-transparent hover:text-[var(--text-main)]'" class="py-2 theme-rounded-sm border transition text-xs font-bold tracking-wide"><i class="fa-solid fa-globe mr-1"></i>{{ t('tab_world') }}</button>
                <button @click="tabs.left = 'players'" :class="tabs.left==='players' ? 'bg-[var(--bg-panel)] text-indigo-400 border-[var(--border-dim)]' : 'text-[var(--text-dim)] border-transparent hover:text-[var(--text-main)]'" class="py-2 theme-rounded-sm border transition text-xs font-bold tracking-wide"><i class="fa-solid fa-users mr-1"></i>{{ t('tab_entity') }}</button>
                <button @click="tabs.left = 'lore'" :class="tabs.left==='lore' ? 'bg-[var(--bg-panel)] text-emerald-400 border-[var(--border-dim)]' : 'text-[var(--text-dim)] border-transparent hover:text-[var(--text-main)]'" class="py-2 theme-rounded-sm border transition text-xs font-bold tracking-wide"><i class="fa-solid fa-book mr-1"></i>{{ t('tab_lore') }}</button>
                <button @click="tabs.left = 'stat_schema'" :class="tabs.left==='stat_schema' ? 'bg-[var(--bg-panel)] text-amber-400 border-[var(--border-dim)]' : 'text-[var(--text-dim)] border-transparent hover:text-[var(--text-main)]'" class="py-2 theme-rounded-sm border transition text-xs font-bold tracking-wide"><i class="fa-solid fa-sliders mr-1"></i>{{ t('tab_rules') }}</button>
            </div>

            <!-- 1. 全局变量 -->
            <div v-if="tabs.left === 'world'" class="flex-1 overflow-y-auto p-5 space-y-3">
                <div class="text-xs text-[var(--text-dim)] font-bold uppercase tracking-widest mb-2 px-1">{{ t('header_global_vars') }}</div>
                <div v-for="(gVar, idx) in global_vars" :key="idx" class="bg-[var(--bg-panel)] p-3 theme-rounded-sm border border-[var(--border-dim)] flex flex-col gap-2 group">
                    <div class="flex gap-2">
                        <input v-model="gVar.key" @change="debouncedSave('autosave.json')" class="w-1/3 bg-[var(--bg-badge)] text-sm text-indigo-400 p-2 theme-rounded-sm border border-[var(--border-dim)] outline-none font-bold font-mono-tech" placeholder="变量名">
                        <input v-model="gVar.value" @change="debouncedSave('autosave.json')" class="flex-1 bg-[var(--bg-badge)] text-sm text-[var(--text-main)] p-2 theme-rounded-sm border border-[var(--border-dim)] outline-none" placeholder="当前状态">
                        <button @click="global_vars.splice(idx,1); saveGame('autosave.json')" class="text-[var(--text-dim)] hover:text-red-400 px-2 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
                <button @click="addGlobalVar" class="w-full py-3 bg-[var(--bg-panel)] text-[var(--text-dim)] theme-rounded-sm border border-[var(--border-dim)] font-bold text-sm hover:bg-[var(--bg-header)] transition hover:text-[var(--text-main)]"><i class="fa-solid fa-plus mr-2"></i> {{ t('btn_add_global') }}</button>
            </div>

            <!-- 2. 实体列表 (已优化层级显示) -->
            <div v-if="tabs.left === 'players'" class="flex-1 overflow-y-auto p-5 space-y-4">
                 <!-- [修改] 遍历 sortedPlayers 而不是 players -->
                 <div role="group" :aria-label="player.name" v-for="player in sortedPlayers" :key="player.id" @click="openFactionModal(player)" 
                      class="info-card cursor-pointer theme-rounded p-5 relative group transition-all duration-300"
                      :style="{ marginLeft: (player._depth * 24) + 'px', borderLeft: player._depth > 0 ? '4px solid ' + player.color : '' }">
                    
                    <!-- [新增] 子实体连接线指示器 -->
                    <div v-if="player._depth > 0" class="absolute -left-4 top-1/2 -translate-y-1/2 text-[var(--border-dim)]">
                        <i class="fa-solid fa-turn-up rotate-90 text-lg"></i>
                    </div>

                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-4">
                            <!-- Logo 容器 -->
                            <div class="w-12 h-12 theme-rounded-sm bg-[var(--bg-badge)] border border-[var(--border-dim)] flex items-center justify-center text-xl shadow-inner overflow-hidden p-0.5 shrink-0" :style="{ color: player.color, borderColor: player.color + '40' }">
                                <img v-if="isImage(player.logo)" :src="player.logo" class="w-full h-full object-contain">
                                <i v-else :class="player.logo || 'fa-solid fa-users'"></i>
                            </div>
                            <div>
                                <div class="font-black text-base leading-tight mb-1 flex items-center gap-2" 
                                    :style="{ color: player.color }">
                                    {{ player.name }}
                                    <!-- [新增] 如果是父级实体，显示一个小标记 -->
                                    <i v-if="players.some(p => p.parentId === player.id)" class="fa-solid fa-sitemap text-[10px] text-[var(--text-dim)]" title="拥有下属实体"></i>
                                </div>
                                <div class="text-[10px] font-mono-tech text-[var(--text-dim)] uppercase tracking-widest">ID: {{ player.id }}</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                             <button @click.stop="exportAsImage('faction', player)" class="text-[var(--text-dim)] hover:text-emerald-400 transition" title="生成战术海报"><i class="fa-solid fa-camera"></i></button>
                             <i class="fa-solid fa-ellipsis-vertical text-[var(--text-dim)] group-hover:text-[var(--text-main)] transition px-2"></i>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <!-- 只遍历该实体规则集中定义的 key，而不是遍历 stats 中的所有 key (防止显示过时数据) -->
                        <div v-for="field in getFieldsBySchemaId(player.schemaId)" :key="field.key" class="bg-[var(--bg-badge)] px-2 py-1.5 theme-rounded-sm border border-[var(--border-dim)] flex flex-col">
                            <span class="text-[9px] text-[var(--text-dim)] font-bold uppercase tracking-wider">{{ field.label }}</span>
                            <!-- 获取 stats 中的值，如果不存在则显示 '-' -->
                            <span class="text-xs font-mono-tech font-bold truncate" :style="{ color: player.color }">{{ player.stats[field.key] || '-' }}</span>
                        </div>
                    </div>
                </div>
                <button @click="openFactionModal(null)" class="w-full py-4 border-2 border-dashed border-[var(--border-dim)] text-[var(--text-dim)] theme-rounded hover:text-indigo-400 hover:border-indigo-500/50 transition text-sm font-bold bg-[var(--bg-badge)] hover:bg-[var(--bg-panel)] uppercase tracking-widest flex items-center justify-center gap-2"><i class="fa-solid fa-plus-circle"></i> {{ t('btn_new_entity') }}</button>
            </div>

            <!-- 3. 资料设定 -->
            <div v-if="tabs.left === 'lore'" class="flex-1 overflow-y-auto p-5 space-y-4">
                <div v-for="(entry, idx) in lorebook" :key="idx" class="info-card theme-rounded p-4">
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-[var(--border-highlight)]">
                        <input v-model="entry.keys" @change="debouncedSave('autosave.json')" class="bg-transparent text-sm font-bold text-emerald-400 w-full outline-none placeholder-[var(--text-dim)]" placeholder="关键词...">
                        <div class="flex items-center gap-2">
                            <button @click="exportAsImage('lore', entry)" class="text-[var(--text-dim)] hover:text-emerald-400 transition text-xs" title="导出资料卡"><i class="fa-solid fa-camera"></i></button>
                            <button @click="cycleLoreMode(entry)" class="px-2 py-1 theme-rounded-sm text-[10px] font-bold uppercase tracking-wider min-w-[50px] transition-all border" :class="{'bg-emerald-900/40 text-emerald-400 border-emerald-500/40': entry.mode==='on', 'bg-indigo-900/40 text-indigo-400 border-indigo-500/40': entry.mode==='auto', 'bg-[var(--bg-badge)] text-[var(--text-dim)] border-[var(--border-dim)]': entry.mode==='off'}">{{ entry.mode === 'on' ? '常驻' : (entry.mode === 'auto' ? '自动' : '禁用') }}</button>
                        </div>
                    </div>
                    <textarea v-model="entry.content" @change="debouncedSave('autosave.json')" class="w-full bg-[var(--bg-badge)] theme-rounded-sm p-3 text-xs text-[var(--text-main)] resize-none h-20 border border-[var(--border-dim)] focus:border-emerald-500/50 outline-none leading-relaxed" placeholder="设定内容..."></textarea>
                    <div class="flex justify-end mt-1"><button @click="lorebook.splice(idx,1); saveGame('autosave.json')" class="text-xs text-[var(--text-dim)] hover:text-red-400"><i class="fa-solid fa-trash"></i></button></div>
                </div>
                <button @click="addLoreEntry" class="w-full py-3 bg-[var(--bg-panel)] hover:bg-[var(--bg-header)] text-emerald-500 theme-rounded-sm border border-[var(--border-dim)] transition font-bold text-sm"><i class="fa-solid fa-database mr-2"></i> {{ t('btn_add_lore') }}</button>
            </div>

            <!-- 4. 规则列表 (升级版) -->
            <div v-if="tabs.left === 'stat_schema'" class="flex-1 flex flex-col overflow-hidden">
                <!-- A. 规则集切换器 -->
                <div class="p-4 border-b border-[var(--border-dim)] bg-[var(--bg-header)] space-y-2 shrink-0">
                    <div class="flex justify-between items-center">
                         <span class="text-[10px] font-bold text-[var(--text-dim)] uppercase tracking-widest">TYPE DEFINITIONS</span>
                         <div class="flex gap-1">
                             <button @click="addNewRuleSet" class="text-[var(--text-dim)] hover:text-[var(--text-main)]"><i class="fa-solid fa-plus-square"></i></button>
                             <button @click="deleteActiveRuleSet" class="text-[var(--text-dim)] hover:text-red-400"><i class="fa-solid fa-trash"></i></button>
                         </div>
                    </div>
                    <select v-model="activeSchemaId" @change="debouncedSave('autosave.json')" class="w-full input-tech p-2 theme-rounded-sm text-xs font-bold outline-none border-l-4 border-amber-500">
                        <option v-for="rs in rule_sets" :key="rs.id" :value="rs.id">{{ rs.name }}</option>
                    </select>
                </div>

                <!-- B. 字段列表 (绑定到当前选中的规则集) -->
                <div class="flex-1 overflow-y-auto p-5 space-y-3">
                    <div v-if="getActiveSchemaFields().length === 0" class="text-center text-[var(--text-dim)] text-xs italic py-4">
                        (No fields defined for this type)
                    </div>
                    <div v-for="(field, idx) in getActiveSchemaFields()" :key="idx" class="bg-[var(--bg-panel)] p-3 theme-rounded-sm border border-[var(--border-dim)] flex gap-3 items-center group">
                        <div class="flex-1">
                             <div class="text-[9px] text-[var(--text-dim)] uppercase mb-0.5">Label</div>
                             <input v-model="field.label" @change="debouncedSave('autosave.json')" class="w-full bg-[var(--bg-badge)] text-sm text-[var(--text-main)] p-1 theme-rounded-sm outline-none border border-transparent focus:border-[var(--border-dim)]">
                        </div>
                        <div class="w-20">
                             <div class="text-[9px] text-[var(--text-dim)] uppercase mb-0.5">Key</div>
                             <input v-model="field.key" @change="debouncedSave('autosave.json')" class="w-full bg-[var(--bg-badge)] text-sm text-amber-500 font-mono p-1 theme-rounded-sm outline-none text-center border border-transparent focus:border-[var(--border-dim)]">
                        </div>
                        <button @click="getActiveSchemaFields().splice(idx,1); saveGame('autosave.json')" class="text-[var(--text-dim)] hover:text-red-400 px-1 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-times"></i></button>
                    </div>
                    
                    <button @click="addSchemaField" class="w-full py-3 bg-[var(--bg-panel)] text-amber-500 theme-rounded-sm border border-[var(--border-dim)] font-bold text-sm hover:bg-[var(--bg-header)] transition mt-4"><i class="fa-solid fa-plus mr-2"></i> {{ t('btn_add_rule') }}</button>
                </div>
            </div>
        </aside>

        <!-- 中间：情报流 / 地图 -->
<!-- 中间：情报流 / 地图 -->
        <section role="main" aria-label="Main View" class="w-2/5 bg-[var(--bg-deep)] flex flex-col relative border-r border-[var(--border-dim)] transition-colors duration-300">
            
            <!-- [新增 1] 视图切换栏 (这是关键，没有它你无法进入地图模式) -->
            <div class="h-12 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex shrink-0 z-20">
                <button @click="showMap = false" :class="!showMap ? 'text-[var(--text-main)] border-indigo-500 bg-[var(--bg-panel)]' : 'text-[var(--text-dim)] border-transparent'" class="flex-1 font-bold text-xs uppercase tracking-widest border-b-2 transition hover:bg-[var(--bg-panel)] flex items-center justify-center gap-2">
                    <i class="fa-solid fa-stream"></i> {{ t('view_timeline') }}
                </button>
                <button @click="showMap = true" :class="showMap ? 'text-[var(--text-main)] border-emerald-500 bg-[var(--bg-panel)]' : 'text-[var(--text-dim)] border-transparent'" class="flex-1 font-bold text-xs uppercase tracking-widest border-b-2 transition hover:bg-[var(--bg-panel)] flex items-center justify-center gap-2">
                    <i class="fa-solid fa-map"></i> {{ t('view_map') }}
                </button>
            </div>

            <!-- 背景纹理 -->
            <div class="absolute inset-0 pointer-events-none opacity-[0.03] top-12" style="background-image: radial-gradient(#94a3b8 1px, transparent 1px); background-size: 30px 30px;"></div>
            
            <!-- [修改 2] 原 Timeline 容器 (增加了 v-show="!showMap") -->
            <div v-show="!showMap" id="timeline-scroll" class="flex-1 overflow-y-auto p-10 pr-4 scroll-smooth z-10">
                
                <!-- [优化] 加载更多按钮 -->
                <div v-if="timeline.length > timelinePageSize && !showAllTimeline" class="flex justify-center mb-10">
                    <button @click="showAllTimeline = true" class="px-6 py-2 bg-[var(--bg-panel)] border border-[var(--border-dim)] text-[var(--text-dim)] hover:text-[var(--text-main)] theme-rounded-sm text-xs font-bold uppercase tracking-widest transition">
                        <i class="fa-solid fa-clock-rotate-left mr-2"></i> Show All History ({{ timeline.length }} Turns)
                    </button>
                </div>

                <div v-if="timeline.length === 0" class="h-full flex flex-col items-center justify-center text-[var(--text-dim)] opacity-50">
                    <i class="fa-regular fa-file-lines text-6xl mb-6"></i>
                    <p class="text-lg font-mono-tech font-bold uppercase tracking-widest">{{ t('msg_no_events') }}</p>
                </div>

                <!-- [优化] 遍历 visibleTimeline 而不是 timeline -->
                <!-- 注意：key 必须保持唯一，这里假设 turn.id 是唯一的 -->
                <div v-for="(turn, tIdx) in visibleTimeline" :key="turn.id" class="mb-20">
                    <div class="flex items-center gap-6 mb-8 group/turn">
                        <div class="h-px bg-[var(--border-dim)] flex-1"></div>
                        <div class="text-center cursor-pointer group/edit" @click="editingTurnId = turn.id">
                            <div v-if="editingTurnId === turn.id" class="flex flex-col items-center gap-2">
                                <input v-model="turn.id" class="bg-black text-white text-3xl font-black text-center w-24 border border-indigo-500 theme-rounded-sm p-1">
                                <input v-model="turn.timeRange" class="bg-black text-emerald-400 text-lg font-mono-tech text-center w-48 border border-emerald-500 theme-rounded-sm p-1" @blur="saveTurnEdit" @keyup.enter="saveTurnEdit">
                            </div>
                            <div v-else>
                                <h2 class="text-5xl font-black text-[var(--text-main)] group-hover/edit:text-[var(--text-dim)] transition">TURN {{ turn.id }}</h2>
                                <div class="text-emerald-700 font-mono-tech font-bold uppercase tracking-[0.2em] mt-1 group-hover/edit:text-emerald-500 transition">{{ turn.timeRange }}</div>
                            </div>
                        </div>
                        <div class="h-px bg-[var(--border-dim)] flex-1 flex justify-end"><button @click="deleteTurn(tIdx)" class="opacity-0 group-hover/turn:opacity-100 text-[var(--text-dim)] hover:text-red-500 transition px-4 text-xl"><i class="fa-solid fa-trash"></i></button></div>
                    </div>

                    <div class="space-y-12 pl-6 border-l-2 border-[var(--border-dim)] ml-10">
                        <div v-for="(event, eIdx) in turn.events" :key="eIdx" class="relative group/event">
                            <div class="absolute -left-[34px] top-10 w-6 h-0.5 bg-[var(--border-dim)] group-hover/event:bg-indigo-500 group-hover/event:w-8 transition-all"></div>
                            
                            <!-- 新闻卡片本体 -->
                            <div role="article" aria-label="News Event" class="glass-panel theme-rounded border-0 border-l-[6px] transition-all duration-300 relative overflow-hidden hover:shadow-[0_10px_50px_var(--shadow-color)]" :style="{ borderLeftColor: getFactionColor(event.factionId) }">
                                <!-- [修改] 背景 Logo: 支持图片 -->
                                <img v-if="isImage(getFactionLogo(event.factionId))" :src="getFactionLogo(event.factionId)" class="event-card-bg-logo opacity-[0.05] grayscale" style="object-fit: contain;">
                                <i v-else :class="getFactionLogo(event.factionId)" class="event-card-bg-logo" :style="{ color: getFactionColor(event.factionId) }"></i>
                                
                                <div class="bg-[var(--bg-header)] px-6 py-3 border-b border-[var(--border-highlight)] flex justify-between items-center relative z-10 backdrop-blur-sm">
                                    <div class="flex items-center gap-4 font-mono-tech text-sm font-bold tracking-wider text-[var(--text-dim)]">
                                        <span class="text-[var(--text-dim)]"><i class="fa-regular fa-clock mr-2"></i>{{ formatTimeSpan(event) }}</span>
                                        <span class="w-px h-4 bg-[var(--border-dim)]"></span>
                                        <span class="uppercase flex items-center gap-2" :style="{ color: getFactionColor(event.factionId) }">
                                            <!-- [修改] Header Logo -->
                                            <img v-if="isImage(getFactionLogo(event.factionId))" 
                                                 :src="getFactionLogo(event.factionId)" 
                                                 class="h-4 w-auto max-w-[30px] object-contain border border-white/20 rounded-[1px] shadow-sm">
                                            <i v-else class="fa-solid fa-tower-broadcast text-xs opacity-60"></i>
                                            {{ getFactionName(event.factionId) }}
                                        </span>
                                    </div>
                                    <div class="flex gap-4 items-center">
                                        <button @click.stop="exportAsImage('event', event)" class="text-[var(--text-dim)] hover:text-emerald-400 transition" title="生成情报简报海报"><i class="fa-solid fa-camera"></i></button>
                                        <button v-if="!isEditingEvent(tIdx, eIdx)" @click.stop="enableEventEdit(tIdx, eIdx)" class="text-[var(--text-dim)] hover:text-[var(--text-main)] transition"><i class="fa-solid fa-pen-to-square"></i></button>
                                        <button v-else @click.stop="saveEventEdit()" class="text-emerald-500 hover:text-[var(--text-main)] transition"><i class="fa-solid fa-floppy-disk"></i></button>
                                    </div>
                                </div>

                                <div class="p-8 cursor-pointer relative z-10" @click="toggleEventOpen(event)">
                                    <!-- 编辑模式 -->
                                    <div v-if="isEditingEvent(tIdx, eIdx)" @click.stop class="mb-6 space-y-4">
                                        <div class="flex gap-2"><input v-model="event.timeStart" class="input-tech p-2 w-1/2 theme-rounded-sm font-bold text-center" placeholder="t('label_start')"><input v-model="event.timeEnd" class="input-tech p-2 w-1/2 theme-rounded-sm font-bold text-center" placeholder="t('label_end')"></div>
                                        <textarea v-model="event.summary" class="w-full h-24 input-tech p-3 theme-rounded-sm text-lg font-bold resize-none" placeholder="t('label_summary') + '...'"></textarea>
                                        
                                        <div class="bg-[var(--bg-badge)] p-3 theme-rounded-sm border border-[var(--border-dim)]">
                                            <div class="text-[10px] font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('header_manage_impacts') }}</div>
                                            <div class="flex flex-wrap gap-2 mb-3">
                                                <div v-for="(imp, i) in event.impacts" :key="i" class="impact-badge pr-1" 
                                                    :style="{ borderColor: getImpactColor(imp), backgroundColor: getImpactColor(imp) + '15' }">
                                                    
                                                    <!-- A. 属性变更 -->
                                                    <template v-if="!imp.type || imp.type === 'STAT_CHANGE'">
                                                        <span class="text-xs" :style="{ color: getFactionColor(imp.targetId) }">{{ imp.targetName }}.{{ imp.attrLabel }} [{{ imp.newValue }}]</span>
                                                    </template>
                                                    
                                                    <!-- B. 地块转移 -->
                                                    <template v-else-if="imp.type === 'REGION_TRANSFER'">
                                                        <i class="fa-solid fa-map-location-dot text-indigo-400 text-xs"></i>
                                                        <span class="text-[var(--text-dim)] text-xs">{{ imp.targetName }}</span>
                                                        <i class="fa-solid fa-arrow-right text-[10px] mx-1 opacity-50"></i>
                                                        <span class="font-bold text-xs" :style="{color: getFactionColor(imp.newValue)}">{{ getFactionName(imp.newValue) }}</span>
                                                    </template>
                                                    
                                                    <!-- C. 创建实体 -->
                                                    <template v-else-if="imp.type === 'ENTITY_CREATE'">
                                                        <i class="fa-solid fa-user-plus text-emerald-400 text-xs"></i>
                                                        <span class="font-bold text-xs text-emerald-400 ml-1">{{ imp.data?.name }}</span>
                                                    </template>

                                                    <!-- D. 移除实体 -->
                                                    <template v-else-if="imp.type === 'ENTITY_REMOVE'">
                                                        <i class="fa-solid fa-user-minus text-red-400 text-xs"></i>
                                                        <span class="font-bold text-xs text-red-400 decoration-line-through ml-1">{{ getFactionName(imp.targetId) }}</span>
                                                    </template>

                                                    <!-- 删除按钮 -->
                                                    <button @click="removeEventImpact(event, i)" class="ml-2 w-5 h-5 flex items-center justify-center theme-rounded-sm hover:bg-red-500/20 hover:text-red-500 text-[var(--text-dim)] transition"><i class="fa-solid fa-times"></i></button>
                                                </div>
                                            </div>
                                            <!-- [新增] 时间轴内的安科选项编辑器 -->
                                            <div class="bg-[var(--bg-badge)] p-3 theme-rounded-sm border border-[var(--border-dim)] mt-4">
                                                <!-- 标题行：左对齐 -->
                                                <div class="flex items-center gap-3 mb-3">
                                                    <div class="text-[10px] font-bold text-pink-500 uppercase tracking-widest">ANKO OPTIONS (DECISIONS)</div>
                                                    <button @click="addOptionToEvent(event)" class="text-[10px] bg-pink-900/20 text-pink-400 border border-pink-500/30 px-2 py-0.5 theme-rounded-sm hover:bg-pink-600 hover:text-white transition flex items-center gap-1">
                                                        <i class="fa-solid fa-plus"></i> Add
                                                    </button>
                                                </div>
                                                
                                                <div class="space-y-2">
                                                    <div v-for="(opt, oi) in event.options" :key="oi" class="bg-[var(--bg-deep)] p-2 theme-rounded-sm border border-[var(--border-dim)] flex gap-2 items-start">
                                                        <div class="flex-1 space-y-1">
                                                            <div class="flex items-center gap-2">
                                                                <span class="text-[9px] text-pink-500 font-bold uppercase w-8 text-right">Label</span>
                                                                <input v-model="opt.label" placeholder="Option Label" class="flex-1 bg-transparent text-xs font-bold text-pink-400 px-1 border-b border-[var(--border-dim)] outline-none focus:border-pink-500">
                                                            </div>
                                                            <div class="flex items-center gap-2">
                                                                <span class="text-[9px] text-[var(--text-dim)] font-bold uppercase w-8 text-right">Desc</span>
                                                                <textarea v-model="opt.desc" placeholder="Consequence..." class="flex-1 bg-transparent text-[10px] text-[var(--text-dim)] px-1 h-6 resize-none outline-none focus:text-[var(--text-main)] border-b border-transparent focus:border-[var(--border-dim)]"></textarea>
                                                            </div>
                                                        </div>
                                                        <button @click="event.options.splice(oi,1)" class="text-[var(--text-dim)] hover:text-red-400 mt-1"><i class="fa-solid fa-times"></i></button>
                                                    </div>
                                                    <div v-if="!event.options || event.options.length === 0" class="text-center text-[10px] text-[var(--text-dim)] italic opacity-50">No options available.</div>
                                                </div>
                                            </div>
                                            <!-- [修改 2] 新的添加表单 -->
                                            <div class="flex flex-col gap-2">
                                                <!-- 类型切换按钮 -->
                                                <div class="flex p-1 gap-1 bg-[var(--bg-deep)] theme-rounded-sm border border-[var(--border-dim)]">
                                                    <button @click="editImpactForm.type = 'STAT_CHANGE'" :class="editImpactForm.type === 'STAT_CHANGE' ? 'bg-indigo-600 text-white' : 'text-[var(--text-dim)] hover:bg-[var(--bg-panel)]'" class="flex-1 py-1 text-[10px] font-bold theme-rounded-sm transition">{{ t('btn_type_stat') }}</button>
                                                    <button @click="editImpactForm.type = 'REGION_TRANSFER'" :class="editImpactForm.type === 'REGION_TRANSFER' ? 'bg-indigo-600 text-white' : 'text-[var(--text-dim)] hover:bg-[var(--bg-panel)]'" class="flex-1 py-1 text-[10px] font-bold theme-rounded-sm transition">{{ t('btn_type_region') }}</button>
                                                    <button @click="editImpactForm.type = 'ENTITY_CREATE'" :class="editImpactForm.type === 'ENTITY_CREATE' ? 'bg-emerald-600 text-white' : 'text-[var(--text-dim)] hover:bg-[var(--bg-panel)]'" class="flex-1 py-1 text-[10px] font-bold theme-rounded-sm transition">{{ t('btn_type_create') }}</button>
                                                    <button @click="editImpactForm.type = 'ENTITY_REMOVE'" :class="editImpactForm.type === 'ENTITY_REMOVE' ? 'bg-red-600 text-white' : 'text-[var(--text-dim)] hover:bg-[var(--bg-panel)]'" class="flex-1 py-1 text-[10px] font-bold theme-rounded-sm transition">{{ t('btn_type_remove') }}</button>
                                                </div>

                                                <!-- 条件输入框 -->
                                                <div class="flex gap-2 items-center">
                                                    <!-- 1. 属性变更 -->
                                                    <template v-if="editImpactForm.type === 'STAT_CHANGE'">
                                                        <select v-model="editImpactForm.targetId" class="input-tech h-8 text-xs font-bold theme-rounded-sm outline-none w-1/3"><option value="" disabled selected>Target</option><option v-for="p in players" :value="p.id">{{ p.name }}</option></select>
                                                        <select v-model="editImpactForm.attrKey" class="input-tech h-8 text-xs font-bold theme-rounded-sm outline-none w-1/4"><option value="" disabled selected>Attr</option><option v-for="field in getFieldsForImpactTarget(editImpactForm.targetId)" :value="field.key">{{ field.label }}</option></select>
                                                        <input v-model="editImpactForm.newValue" placeholder="Val" class="input-tech h-8 flex-1 text-xs font-bold theme-rounded-sm outline-none px-2 text-center" @keyup.enter="addEventImpact(event)">
                                                    </template>

                                                    <!-- 2. 地块转移 -->
                                                    <template v-if="editImpactForm.type === 'REGION_TRANSFER'">
                                                        <select v-model="editImpactForm.targetName" class="input-tech h-8 text-xs font-bold theme-rounded-sm outline-none w-1/2"><option value="" disabled selected>Region</option><option v-for="reg in map_data.regions" :value="reg.name">{{ reg.name }}</option></select>
                                                        <select v-model="editImpactForm.newValue" class="input-tech h-8 text-xs font-bold theme-rounded-sm outline-none flex-1"><option value="" disabled selected>New Controller</option><option v-for="p in players" :value="p.id">{{ p.name }}</option></select>
                                                    </template>

                                                    <!-- 3. 创建实体 -->
                                                    <template v-if="editImpactForm.type === 'ENTITY_CREATE'">
                                                        <input v-model="editImpactForm.newValue" placeholder="New Entity Name" class="input-tech h-8 flex-1 text-xs font-bold theme-rounded-sm outline-none px-2" @keyup.enter="addEventImpact(event)">
                                                    </template>

                                                    <!-- 4. 移除实体 -->
                                                    <template v-if="editImpactForm.type === 'ENTITY_REMOVE'">
                                                        <select v-model="editImpactForm.targetId" class="input-tech h-8 text-xs font-bold theme-rounded-sm outline-none w-full"><option value="" disabled selected>Remove Entity</option><option v-for="p in players" :value="p.id">{{ p.name }}</option></select>
                                                    </template>

                                                    <button @click="addEventImpact(event)" class="h-8 w-8 theme-rounded-sm bg-emerald-600 hover:bg-emerald-500 text-white flex items-center justify-center shrink-0"><i class="fa-solid fa-plus"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 浏览模式 -->
                                    <h3 v-else class="text-2xl font-black text-[var(--text-main)] mb-6 leading-tight tracking-tight">{{ event.summary }}</h3>
                                    
                                    <!-- [修复开始] 添加 Flex 容器 wrapper -->
                                    <div class="flex flex-wrap gap-2 items-center">
                                        <div v-for="(imp, i) in event.impacts" :key="i" class="impact-badge" 
                                            :style="{ borderColor: getImpactColor(imp), backgroundColor: getImpactColor(imp) + '15' }">
                                            
                                            <!-- 1. 属性变更 (默认) -->
                                            <template v-if="!imp.type || imp.type === 'STAT_CHANGE'">
                                                <!-- ... (内容保持不变) ... -->
                                                <div class="flex items-center gap-2 pr-2 border-r" :style="{ borderColor: getFactionColor(imp.targetId) + '40' }">
                                                    <img v-if="isImage(getFactionLogo(imp.targetId))" :src="getFactionLogo(imp.targetId)" class="h-4 w-auto max-w-[24px] object-contain rounded-[1px] border border-white/10">
                                                    <i v-else :class="getFactionLogo(imp.targetId)" :style="{ color: getFactionColor(imp.targetId) }"></i>
                                                    <span class="font-bold text-xs" :style="{ color: getFactionColor(imp.targetId) }">{{ imp.targetName }}</span>
                                                </div>
                                                <div class="font-mono-tech text-xs pl-2 text-[var(--text-main)]">
                                                    <span class="text-[var(--text-dim)] mr-1">{{ imp.attrLabel }}</span>
                                                    <span class="font-bold">{{ resolveVal(imp.oldValue) }} <i class="fa-solid fa-arrow-right text-[10px] mx-1 opacity-50"></i> {{ resolveVal(imp.newValue) }}</span>
                                                </div>
                                            </template>

                                            <!-- 2. 地块转移 -->
                                            <template v-else-if="imp.type === 'REGION_TRANSFER'">
                                                <!-- ... (内容保持不变) ... -->
                                                <div class="flex items-center gap-2">
                                                    <i class="fa-solid fa-map-location-dot text-indigo-400"></i>
                                                    <span class="text-[var(--text-dim)] text-xs">{{ imp.targetName }}</span>
                                                    <i class="fa-solid fa-arrow-right text-[10px] mx-1 opacity-50"></i>
                                                    <div class="flex items-center gap-1">
                                                        <i :class="getFactionLogo(imp.newValue)" :style="{color: getFactionColor(imp.newValue)}"></i>
                                                        <span class="font-bold text-xs" :style="{color: getFactionColor(imp.newValue)}">{{ getFactionName(imp.newValue) }}</span>
                                                    </div>
                                                </div>
                                            </template>

                                            <!-- 3. 创建实体 -->
                                            <template v-else-if="imp.type === 'ENTITY_CREATE'">
                                                <!-- ... (内容保持不变) ... -->
                                                <div class="flex items-center gap-2">
                                                    <i class="fa-solid fa-user-plus text-emerald-400"></i>
                                                    <span class="text-xs opacity-70">New:</span>
                                                    <span class="font-bold text-xs text-emerald-400">{{ imp.data?.name || 'New Entity' }}</span>
                                                </div>
                                            </template>

                                            <!-- 4. 移除实体 -->
                                            <template v-else-if="imp.type === 'ENTITY_REMOVE'">
                                                <!-- ... (内容保持不变) ... -->
                                                <div class="flex items-center gap-2">
                                                    <i class="fa-solid fa-user-minus text-red-400"></i>
                                                    <span class="text-xs opacity-70">Removed:</span>
                                                    <span class="font-bold text-xs text-red-400 decoration-line-through">{{ getFactionName(imp.targetId) }}</span>
                                                </div>
                                            </template>
                                            
                                            <!-- 5. 移动标记 -->
                                            <template v-else-if="imp.type === 'PIN_MOVE'">
                                                <!-- ... (内容保持不变) ... -->
                                                <div class="flex items-center gap-2">
                                                    <i class="fa-solid fa-arrows-up-down-left-right text-pink-400"></i>
                                                    <span class="text-xs opacity-70">Move:</span>
                                                    <span class="font-bold text-xs text-pink-400">{{ imp.targetName }}</span>
                                                    <span class="font-mono text-[10px] bg-black/20 px-1 rounded">{{ imp.oldValue }} <i class="fa-solid fa-arrow-right opacity-50"></i> {{ imp.newValue }}</span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                    <!-- [修复结束] -->

                                    <div class="mt-4 flex justify-center"><i class="fa-solid text-xl transition-transform duration-300" :class="event.isOpen ? 'fa-chevron-up text-indigo-500' : 'fa-chevron-down text-[var(--text-dim)]'"></i></div>
                                </div>

                                <transition name="slide-up">
                                    <div v-if="event.isOpen" class="bg-[var(--bg-glass)] border-t border-[var(--border-highlight)] p-8 relative z-10">
                                        <div v-if="isEditingEvent(tIdx, eIdx)" @click.stop><textarea v-model="event.content" class="w-full h-96 input-tech p-4 font-mono-tech rounded"></textarea></div>
                                        <div v-else class="md-content text-lg" v-html="renderMarkdown(event.content)"></div>
                                        
                                        <!-- [修改] 选项交互区 (智能渲染) -->
                                        <div v-if="event.options && event.options.length > 0" class="mt-8 pt-6 border-t border-[var(--border-dim)]">
                                            <div class="text-[10px] font-bold text-pink-500 uppercase tracking-widest mb-3"><i class="fa-solid fa-diamond-turn-right mr-1"></i> SELECT NEXT ACTION</div>
                                            <div class="flex flex-col gap-2"> <!-- 改为纵向排列以显示详情 -->
                                                <button v-for="(opt, optIdx) in event.options" :key="optIdx" 
                                                        @click.stop="selectOption(event, opt)"
                                                        class="group relative w-full px-4 py-3 bg-[var(--bg-badge)] hover:bg-pink-900/10 border border-[var(--border-dim)] hover:border-pink-500/50 text-left theme-rounded-sm transition">
                                                    
                                                    <!-- A. 对象模式 (严格匹配 label/desc) -->
                                                    <div v-if="typeof opt === 'object'">
                                                        <div class="text-sm font-bold text-pink-400 group-hover:text-pink-300 mb-1">{{ opt.label }}</div>
                                                        <div class="text-xs text-[var(--text-dim)] leading-relaxed opacity-80">{{ opt.desc }}</div>
                                                    </div>
                                                    <!-- B. 字符串模式 -->
                                                    <div v-else class="text-sm font-bold text-[var(--text-main)]">
                                                        {{ opt }}
                                                    </div>
                                                </button>
                                            </div>
                                        </div>

                                        <div class="pt-6 border-t border-[var(--border-dim)] flex justify-end gap-4 mt-8">
                                            <button @click.stop="copyToClipboard(event.content)" class="px-5 py-2 theme-rounded-sm border border-[var(--border-dim)] text-[var(--text-dim)] hover:text-[var(--text-main)] hover:bg-[var(--bg-panel)] transition font-bold text-xs uppercase tracking-widest"><i class="fa-regular fa-copy mr-2"></i> {{ t('btn_copy') }}</button>
                                            <button @click.stop="deleteEvent(tIdx, eIdx)" class="px-5 py-2 theme-rounded-sm border border-[var(--border-dim)] text-[var(--text-dim)] hover:text-red-400 hover:bg-red-900/20 transition font-bold text-xs uppercase tracking-widest"><i class="fa-solid fa-trash mr-2"></i> {{ t('btn_delete') }}</button>
                                        </div>
                                    </div>
                                </transition>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="h-40"></div>
            </div>

<!-- [修改后] 地图界面容器 -->
            <div v-show="showMap" class="flex-1 overflow-hidden relative flex flex-col bg-[var(--bg-deep)] z-10 select-none">
                
                <!-- 地图工具栏 -->
                <div class="p-2 border-b border-[var(--border-dim)] bg-[var(--bg-sidebar)] flex justify-between items-center shrink-0 z-20">
                    <div class="flex gap-2">
                        <label class="cursor-pointer px-3 py-1 theme-rounded-sm bg-[var(--bg-panel)] border border-[var(--border-dim)] text-[10px] font-bold hover:text-[var(--text-main)] text-[var(--text-dim)] transition flex items-center gap-2 hover:border-indigo-500">
                            <i class="fa-solid fa-upload"></i> {{ t('btn_upload_map') }}
                            <input type="file" @change="handleMapUpload" class="hidden" accept="image/*">
                        </label>
                        
                        <div class="h-6 w-px bg-[var(--border-dim)] mx-1"></div>
                        <div class="flex bg-[var(--bg-badge)] theme-rounded-sm border border-[var(--border-dim)] overflow-hidden">
                            <button @click="mapToolMode = 'view'" :class="mapToolMode === 'view' ? 'bg-amber-600 text-white shadow-inner' : 'text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="px-3 py-1 text-[10px] font-bold transition flex items-center gap-1">
                                <i class="fa-solid fa-hand"></i> {{ t('mode_view') }}
                            </button>
                            <button @click="mapToolMode = 'pin'" :class="mapToolMode === 'pin' ? 'bg-indigo-600 text-white shadow-inner' : 'text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="px-3 py-1 text-[10px] font-bold transition flex items-center gap-1">
                                <i class="fa-solid fa-location-dot"></i> {{ t('mode_pin') }}
                            </button>
                            <button @click="mapToolMode = 'region'" :class="mapToolMode === 'region' ? 'bg-emerald-600 text-white shadow-inner' : 'text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="px-3 py-1 text-[10px] font-bold transition flex items-center gap-1">
                                <i class="fa-solid fa-draw-polygon"></i> {{ t('mode_region') }}
                            </button>
                        </div>
                        
                        <button @click="resetMapView" class="px-3 py-1 theme-rounded-sm bg-[var(--bg-panel)] border border-[var(--border-dim)] text-[10px] font-bold text-[var(--text-dim)] hover:text-[var(--text-main)]"><i class="fa-solid fa-compress"></i> {{ t('btn_fit') }}</button>
                        <div class="h-6 w-px bg-[var(--border-dim)] mx-1"></div>
                        
                        <button @click="exportMapConfig" class="px-3 py-1 theme-rounded-sm bg-[var(--bg-panel)] border border-[var(--border-dim)] text-[10px] font-bold text-[var(--text-dim)] hover:text-emerald-500 transition">
                            <i class="fa-solid fa-file-export"></i> {{ t('btn_export') }}
                        </button>
                        <button @click="exportMapImage" class="px-3 py-1 theme-rounded-sm bg-[var(--bg-panel)] border border-[var(--border-dim)] text-[10px] font-bold text-[var(--text-dim)] hover:text-pink-500 transition">
                            <i class="fa-solid fa-camera"></i> {{ t('btn_img') }}
                        </button>
                        <label class="cursor-pointer px-3 py-1 theme-rounded-sm bg-[var(--bg-panel)] border border-[var(--border-dim)] text-[10px] font-bold text-[var(--text-dim)] hover:text-indigo-500 transition">
                            <i class="fa-solid fa-file-import"></i> {{ t('btn_import') }}
                            <input type="file" @change="handleMapConfigImport" class="hidden" accept=".json">
                        </label>
                    </div>

                    <div class="text-[10px] text-[var(--text-dim)] font-mono-tech flex gap-4 hidden xl:flex">
                        <span><i class="fa-solid fa-mouse-pointer mr-1"></i> {{ t('hint_click_pin') }}</span>
                        <span><i class="fa-solid fa-hand mr-1"></i> {{ t('hint_drag') }}</span>
                        <span><i class="fa-solid fa-magnifying-glass mr-1"></i> {{ t('hint_zoom') }}</span>
                    </div>
                    
                    <div class="text-[10px] font-mono font-bold text-emerald-500">{{ (mapView.scale * 100).toFixed(0) }}%</div>
                    <!-- [新增] 徽章控制区 -->
                    <div class="flex items-center gap-3 border-l border-[var(--border-dim)] pl-3 ml-2">
                        
                        <!-- 1. 显示模式切换 -->
                        <button @click="cycleMapDisplayMode" :title="'Current: ' + mapView.displayMode" class="text-[var(--text-dim)] hover:text-[var(--text-main)] transition w-6 text-center">
                            <i v-if="mapView.displayMode === 'full'" class="fa-solid fa-tags"></i>
                            <i v-else-if="mapView.displayMode === 'icon'" class="fa-solid fa-icons"></i>
                            <i v-else class="fa-solid fa-circle-dot"></i>
                        </button>

                        <!-- 2. 大小缩放滑块 -->
                        <div class="flex items-center gap-2 group">
                            <i class="fa-solid fa-text-height text-[10px] text-[var(--text-dim)]"></i>
                            <input type="range" v-model.number="mapView.badgeScale" min="0.2" max="2.0" step="0.1" 
                                   class="w-16 h-1 bg-[var(--border-dim)] theme-rounded-sm appearance-none cursor-pointer accent-indigo-500">
                        </div>
                    </div>
                </div>

                <!-- 地图画布容器 -->
                <!-- 关键样式: overflow-hidden (隐藏超出部分), cursor-move (提示可拖拽) -->
                <div class="map-viewport flex-1 overflow-hidden relative bg-[#050505] cursor-move"
                     @wheel.prevent="onMapWheel"
                     @mousedown="onMapMouseDown"
                     @mousemove="onMapMouseMove"
                     @mouseup="onMapMouseUp"
                     @mouseleave="onMapMouseUp">
                    
                    <!-- 空状态 -->
                    <div v-if="!map_data.image" class="absolute inset-0 flex flex-col items-center justify-center text-[var(--text-dim)] opacity-30 pointer-events-none gap-4">
                        <i class="fa-solid fa-map-location-dot text-6xl"></i>
                        <span class="text-xs uppercase font-bold tracking-widest">{{ t('msg_no_map') }}</span>
                    </div>
                    
                    <!-- 
                        变换层 (Transform Layer) 
                        style: 应用动态的 scale 和 translate
                        transform-origin: 0 0 (从左上角开始变换，便于计算)
                    -->
                    <div v-else 
                        id="map-capture-target"
                        class="relative inline-block origin-top-left transition-transform duration-75 ease-out will-change-transform"
                        :style="{ transform: `translate(${mapView.x}px, ${mapView.y}px) scale(${mapView.scale})`, width: '100%' }"
                        @click="onMapBackgroundClick">
                        
                        <!-- 1. 底图层 -->
                        <img :src="map_data.image" class="block w-full pointer-events-none opacity-80 select-none" draggable="false">
                        
                        <!-- 2. Regions 地块遮罩层 (最底层交互 z-0) -->
                        <div v-for="(reg, idx) in map_data.regions" :key="reg.id"
                             class="absolute z-0"
                             :class="mapToolMode === 'region' ? 'pointer-events-auto cursor-pointer' : 'pointer-events-none'"
                             :style="{ left: reg.x + '%', top: reg.y + '%', width: reg.w + '%', height: reg.h + '%' }"
                             @click.stop="onRegionClick(reg, idx)">
                             
                             <svg class="w-full h-full overflow-visible" viewBox="0 0 100 100" preserveAspectRatio="none">
                                <defs>
                                    <!-- 定义遮罩：引入 Base64 图片 -->
                                    <mask :id="'mask-' + reg.id">
                                        <image :href="reg.maskData" x="0" y="0" width="100" height="100" preserveAspectRatio="none" />
                                    </mask>
                                </defs>
                                <!-- 绘制矩形，应用遮罩和颜色 -->
                                <rect x="0" y="0" width="100" height="100" 
                                      :fill="getRegionColor(reg)" 
                                      fill-opacity="0.5"
                                      :mask="'url(#mask-' + reg.id + ')'" 
                                      class="transition-opacity duration-200 hover:opacity-80" />
                             </svg>
                        </div>

                        <!-- 3. Regions 地块徽章层 (中间层 z-20) -->
                        <div v-for="(reg, idx) in map_data.regions" :key="'label-'+reg.id"
                             class="absolute w-0 h-0 z-20 pointer-events-none flex items-center justify-center"
                             :style="{ left: reg.centerX + '%', top: reg.centerY + '%' }">
                             
                             <!-- [修改] 增加 transform: scale(...) 和 v-if 控制 -->
                             <div class="flex items-center gap-1.5 bg-black/70 backdrop-blur-[2px] border border-white/10 px-2 py-1 theme-rounded-sm shadow-[0_4px_6px_rgba(0,0,0,0.5)] transition-all duration-200"
                                  :style="{ transform: `scale(${mapView.badgeScale})` }">
                                 
                                 <!-- A. 微型模式 (Dot) -->
                                 <div v-if="mapView.displayMode === 'dot'" class="w-2 h-2 rounded-full" :style="{ backgroundColor: getRegionColor(reg) }"></div>

                                 <!-- B. 图标模式/全模式 (Icon) -->
                                 <template v-else>
                                    <img v-if="isImage(getRegionOwnerLogo(reg))" 
                                        :src="getRegionOwnerLogo(reg)" 
                                        class="h-5 w-auto max-w-[40px] object-contain shadow-sm border border-white/10 rounded-[1px] self-center">
                                    <i v-else :class="getRegionOwnerLogo(reg)" 
                                        class="text-sm drop-shadow-[0_1px_2px_rgba(0,0,0,1)] self-center" 
                                        :style="{ color: getRegionColor(reg) }"></i>
                                     
                                     <!-- C. 仅全模式显示文字 (Text) -->
                                     <div v-if="mapView.displayMode === 'full'" class="flex flex-col leading-none">
                                        <span class="text-[10px] font-bold whitespace-nowrap shadow-black drop-shadow-md"
                                            :style="{ color: getRegionColor(reg) }">
                                            {{ reg.name || 'Unnamed' }}
                                        </span>
                                         <span v-if="reg.ownerId" class="text-[8px] font-mono text-[var(--text-dim)] uppercase tracking-tight scale-90 origin-left mt-0.5 truncate">
                                            {{ getFactionName(reg.ownerId) }}
                                         </span>
                                     </div>
                                 </template>
                             </div>
                        </div>

                        <!-- 4. Pins 普通点层 (最顶层 z-30) -->
                        <div v-for="(pin, idx) in map_data.pins" :key="pin.id" 
                             class="absolute transform -translate-x-1/2 -translate-y-1/2 transition group z-30 flex flex-col items-center justify-center origin-center"
                             :class="mapToolMode === 'pin' ? 'pointer-events-auto cursor-pointer' : 'pointer-events-none'"
                             :style="{ left: pin.x + '%', top: pin.y + '%', transform: `translate(-50%, -50%) scale(${mapView.badgeScale})` }"
                             @mousedown.stop 
                             @click.stop="onPinClick(pin, idx)">
                             
                             <!-- A. 微型模式 (Dot) -->
                             <div v-if="mapView.displayMode === 'dot'" class="w-3 h-3 rounded-full border border-white shadow-md" :style="{ backgroundColor: getFinalPinColor(pin) }"></div>

                             <!-- B. 常规模式 (Icon) -->
                             <template v-else>
                                 <img v-if="isImage(getFinalPinIcon(pin))" 
                                      :src="getFinalPinIcon(pin)" 
                                      class="w-12 h-auto object-contain border-[1.5px] shadow-[0_4px_8px_rgba(0,0,0,0.6)] bg-black/20"
                                      :style="{ borderColor: getFinalPinColor(pin) }">
                                 
                                 <i v-else :class="getFinalPinIcon(pin)" 
                                   class="text-3xl drop-shadow-[0_2px_4px_rgba(0,0,0,0.9)] transition-colors duration-200"
                                   :style="{ color: getFinalPinColor(pin) }"></i>
                             </template>

                             <!-- 悬浮提示 (始终保持缩放比例，或可以设为不缩放) -->
                            <div v-if="mapView.displayMode !== 'dot'" 
                                class="absolute left-1/2 -translate-x-1/2 bottom-full mb-1.5 bg-black/90 text-[10px] px-2 py-0.5 theme-rounded-sm border whitespace-nowrap pointer-events-none font-bold shadow-lg opacity-0 group-hover:opacity-100 transition-opacity"
                                :style="{ color: getFinalPinColor(pin), borderColor: getFinalPinColor(pin) + '60' }">
                            {{ pin.label || getPinName(pin.linkId) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </section>

        <!-- 右侧：指挥台 -->
        <aside role="complementary" aria-label="Command Console" class="w-2/5 bg-[var(--bg-panel)] flex flex-col shrink-0 shadow-[0_0_50px_var(--shadow-color)] z-40 border-l border-[var(--border-dim)] transition-colors duration-300">
            <div class="flex border-b border-[var(--border-dim)] bg-[var(--bg-sidebar)]">
                <button @click="tabs.right = 'staging'" :class="tabs.right === 'staging' ? 'border-indigo-500 text-[var(--text-main)] bg-[var(--bg-panel)]' : 'border-transparent text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="flex-1 py-4 border-b-4 font-bold transition text-sm tracking-wide"><i class="fa-solid fa-layer-group mr-2"></i> {{ t('tab_pending') }} <span v-if="pendingEvents.length" class="ml-2 bg-indigo-600 text-white text-[10px] px-2 py-0.5 rounded-full align-middle">{{pendingEvents.length}}</span></button>
                <!-- [新增] 战斗 Tab -->
                <button @click="tabs.right = 'combat'" :class="tabs.right === 'combat' ? 'border-red-500 text-[var(--text-main)] bg-[var(--bg-panel)]' : 'border-transparent text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="flex-1 py-4 border-b-4 font-bold transition text-sm tracking-wide"><i class="fa-solid fa-gavel mr-2"></i> {{ t('tab_combat') }}</button>
                
                <button @click="tabs.right = 'input'" :class="tabs.right === 'input' ? 'border-indigo-500 text-[var(--text-main)] bg-[var(--bg-panel)]' : 'border-transparent text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="flex-1 py-4 border-b-4 font-bold transition text-sm tracking-wide"><i class="fa-solid fa-terminal mr-2"></i> {{ t('tab_console') }}</button>
                <button @click="tabs.right = 'godmode'" :class="tabs.right === 'godmode' ? 'border-amber-500 text-[var(--text-main)] bg-[var(--bg-panel)]' : 'border-transparent text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="flex-1 py-4 border-b-4 font-bold transition text-sm tracking-wide"><i class="fa-solid fa-hand-sparkles mr-2"></i> {{ t('tab_godmode') }}</button>
            </div>

            <div class="h-[30%] min-h-[250px] border-b border-[var(--border-dim)] bg-[var(--bg-header)] overflow-y-auto p-5 relative">
                <div v-if="tabs.right === 'staging'" class="space-y-3">
                    <div v-for="(evt, idx) in pendingEvents" :key="'p-'+idx" class="bg-[var(--bg-badge)] border border-[var(--border-highlight)] theme-rounded p-4 cursor-pointer group hover:bg-[var(--bg-panel)] hover:border-indigo-500/50 transition relative overflow-hidden" @click="loadFromStaging(idx)">
                        <div class="absolute left-0 top-0 bottom-0 w-1" :style="{ backgroundColor: getFactionColor(evt.factionId) }"></div>
                        <div class="pl-3">
                            <div class="flex justify-between text-[10px] text-[var(--text-dim)] font-bold uppercase mb-1 font-mono-tech">
                                <span>{{ evt.timeStart }} - {{ evt.timeEnd }}</span>
                                <span :style="{ color: getFactionColor(evt.factionId) }">{{ getFactionName(evt.factionId) }}</span>
                            </div>
                            <div class="text-base font-bold text-[var(--text-main)] mb-2 truncate">{{ evt.summary }}</div>
                            <div class="flex flex-wrap gap-2">
                                <span v-for="imp in evt.impacts" class="text-[10px] px-2 py-0.5 theme-rounded-sm border font-mono-tech" :style="{ borderColor: getImpactColor(imp), color: getImpactColor(imp), backgroundColor: getImpactColor(imp)+'10' }">
                                    <!-- 分支 A: 属性变更 (包括全局) -->
                                    <template v-if="imp.type === 'STAT_CHANGE'">
                                        <template v-if="imp.targetId === 'global'">
                                            <i class="fa-solid fa-globe opacity-70"></i> {{ imp.targetName }}.{{ imp.attrLabel }}:
                                        </template>
                                        <template v-else>
                                            {{ imp.targetName }}.{{ imp.attrLabel }}:
                                        </template>
                                    </template>
                                    <!-- 分支 B: 其他类型 -->
                                    <template v-else>
                                        <i class="fa-solid fa-bolt mr-1"></i>{{ imp.type }}:
                                    </template>

                                    <!-- 值显示部分保持不变 -->
                                    [{{ resolveVal(imp.oldValue) }} <i class="fa-solid fa-arrow-right opacity-50"></i> {{ resolveVal(imp.newValue) }}]
                                </span>
                            </div>
                        </div>
                        <button @click.stop="pendingEvents.splice(idx, 1); saveGame('autosave.json')" class="absolute top-2 right-2 text-[var(--text-dim)] hover:text-red-400 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-times text-lg"></i></button>
                    </div>
                    <div v-if="pendingEvents.length === 0" class="h-full flex flex-col items-center justify-center text-[var(--text-dim)] opacity-50">
                        <i class="fa-solid fa-inbox text-5xl mb-3"></i>
                        <span class="font-mono-tech uppercase font-bold tracking-widest text-sm">{{ t('msg_empty_queue') }}</span>
                    </div>
                </div>
                <div v-if="tabs.right === 'input'" class="h-full">
                    <textarea v-model="rawInput" class="w-full h-full bg-transparent border-none outline-none text-[var(--text-main)] font-mono-tech p-2 resize-none text-base leading-relaxed" :placeholder="t('placeholder_input')"></textarea>
                </div>
                <!-- [新增] 战斗系统面板 -->
                <div v-if="tabs.right === 'combat'" class="h-full flex flex-col p-5 overflow-y-auto relative">
                    <div class="absolute inset-0 bg-red-900/5 pointer-events-none"></div>
                    <div class="text-[10px] text-red-500 font-bold uppercase tracking-widest mb-4"><i class="fa-solid fa-crosshairs mr-1"></i> {{ t('header_combat') }}</div>

                    <!-- 1. 双方选择 -->
                    <div class="flex items-center gap-2 mb-4">
                        <div class="flex-1 bg-[var(--bg-badge)] p-2 theme-rounded-sm border border-red-500/30">
                            <div class="text-[9px] text-[var(--text-dim)] uppercase mb-1">Attacker</div>
                            <!-- [修改] text-red-400 改为动态 style -->
                            <select v-model="combatForm.attackerId" 
                                    class="w-full bg-transparent text-sm font-bold outline-none transition-colors duration-300"
                                    :style="{ color: combatForm.attackerId ? getFactionColor(combatForm.attackerId) : '#f87171' }">
                                <option value="" disabled>Select</option>
                                <option v-for="p in players" :value="p.id">{{ p.name }}</option>
                            </select>
                        </div>
                        <div class="text-[var(--text-dim)] font-black text-lg">VS</div>
                        <div class="flex-1 bg-[var(--bg-badge)] p-2 theme-rounded-sm border border-blue-500/30">
                            <div class="text-[9px] text-[var(--text-dim)] uppercase mb-1">Defender</div>
                            <!-- [修改] text-blue-400 改为动态 style -->
                            <select v-model="combatForm.defenderId" 
                                    class="w-full bg-transparent text-sm font-bold outline-none transition-colors duration-300"
                                    :style="{ color: combatForm.defenderId ? getFactionColor(combatForm.defenderId) : '#60a5fa' }">
                                <option value="" disabled>Select</option>
                                <option v-for="p in players" :value="p.id">{{ p.name }}</option>
                            </select>
                        </div>
                    </div>
                    <!-- 1.5 战斗地点 (新增) -->
                    <div class="mb-4">
                        <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-1"><i class="fa-solid fa-map-pin mr-1"></i> {{ t('label_combat_loc') || 'Location' }}</label>
                        <select v-model="combatForm.locationId" class="w-full input-tech p-2 theme-rounded-sm text-xs font-bold outline-none">
                            <option value="">-- No Specific Location --</option>
                            <optgroup label="Regions (Territory)">
                                <option v-for="r in map_data.regions" :value="r.name">{{ r.name }} ({{ getFactionName(r.ownerId) }})</option>
                            </optgroup>
                            <optgroup label="Pins (POI)">
                                <option v-for="p in map_data.pins" :value="p.label || p.id">{{ p.label || 'Marker' }}</option>
                            </optgroup>
                        </select>
                    </div>

                <!-- 2. 战斗背景/意图 -->
                    <div class="mb-4">
                        <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-1">{{ t('label_combat_context') }}</label>
                        <textarea v-model="combatForm.context" placeholder="E.g. 争夺桥头堡 / 遭遇战 / 试图刺杀" class="w-full h-16 input-tech p-2 theme-rounded-sm text-xs resize-none outline-none"></textarea>
                    </div>

                <!-- 3. 骰子序列系统 (大尺寸动画版) -->
                    <div class="bg-[var(--bg-input)] p-4 theme-rounded-sm border border-[var(--border-dim)] mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <label class="text-[10px] font-bold text-[var(--text-dim)] uppercase">{{ t('label_dice_check') }}</label>
                            <button @click="addCombatDie" class="text-[10px] bg-[var(--bg-badge)] border border-[var(--border-dim)] px-2 py-0.5 theme-rounded-sm hover:text-emerald-400 transition"><i class="fa-solid fa-plus mr-1"></i> Add Die</button>
                        </div>
                        
                        <!-- 骰子列表 -->
                        <div class="space-y-3 max-h-[250px] overflow-y-auto pr-2">
                            <!-- [修改] 增大整体间距和内边距 (p-3, gap-3) -->
                            <div v-for="(die, idx) in combatForm.dicePool" :key="idx" class="flex items-center gap-3 bg-[var(--bg-deep)] p-3 theme-rounded-sm border border-[var(--border-dim)]">
                                
                                <!-- [修改] 增大图标尺寸 (text-4xl)，并给固定宽度 (w-12) -->
                                <i class="w-12 text-center text-4xl text-[var(--text-dim)] transition-transform duration-300" 
                                :class="[getDieIcon(die.type), isRollingDice ? 'dice-rolling-animation' : '']"></i>
                                
                                <!-- 垂直分割线 -->
                                <div class="w-px h-10 bg-[var(--border-dim)]"></div>
                                
                                <div class="flex-1 flex flex-col gap-2">
                                    <!-- 上排: 意图 -->
                                    <input v-model="die.label" placeholder="Check (e.g. Hit/Dmg)" class="w-full bg-transparent text-sm font-bold outline-none border-b border-transparent focus:border-[var(--text-dim)] transition placeholder-opacity-50 placeholder-[var(--text-dim)]">
                                    
                                    <!-- 下排: 类型选择 -->
                                    <select v-model="die.type" @change="die.val = null" class="w-full bg-transparent text-[10px] font-mono font-bold outline-none text-[var(--text-dim)]">
                                        <option value="d6">D6 - Standard Cube</option>
                                        <option value="d20">D20 - Icosahedron</option>
                                        <option value="d100">D100 - Percentile</option>
                                    </select>
                                </div>

                                <!-- [修改] 增大结果显示区字体和宽度 (text-4xl, w-16) -->
                                <div class="w-16 text-center font-mono font-black text-4xl" :class="getDiceColorClass(die.val, die.type)">
                                    {{ die.val !== null ? die.val : '-' }}
                                </div>

                                <!-- [修改] 增大删除按钮 -->
                                <button @click="combatForm.dicePool.splice(idx, 1)" class="text-xl text-[var(--text-dim)] hover:text-red-400 px-2 self-start"><i class="fa-solid fa-times"></i></button>
                            </div>
                        </div>

                        <!-- [修改] 增大投掷按钮 -->
                        <button @click="rollCombatDice" :disabled="isRollingDice || combatForm.dicePool.length === 0" class="w-full mt-4 py-3 bg-[var(--bg-panel)] border border-[var(--border-dim)] theme-rounded-sm hover:bg-[var(--bg-header)] transition active:scale-95 flex items-center justify-center gap-3 font-bold text-sm uppercase tracking-wider group">
                            <i :class="isRollingDice ? 'fa-solid fa-circle-notch fa-spin text-lg' : 'fa-solid fa-dice-d20 text-lg'"></i>
                            ROLL ALL DICE
                        </button>
                    </div>

                    <!-- 4. 执行按钮 -->
                    <div class="mt-auto">
                        <button @click="executeCombat" :disabled="isThinking || !combatForm.attackerId || !combatForm.defenderId || combatForm.dicePool.length === 0 || combatForm.dicePool[0].val === null" class="w-full py-3 bg-red-700 hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold text-xs uppercase tracking-widest theme-rounded-sm shadow-lg flex items-center justify-center gap-2 transition">
                            <i v-if="isThinking" class="fa-solid fa-circle-notch fa-spin"></i>
                            <i v-else class="fa-solid fa-gavel"></i>
                            {{ t('btn_judge_combat') }}
                        </button>
                    </div>
                </div>
                <div v-if="tabs.right === 'godmode'" class="h-full flex flex-col p-5 relative">
                    <div class="absolute inset-0 bg-amber-900/5 pointer-events-none"></div>
                    <div class="text-[10px] text-amber-500 font-bold uppercase tracking-widest mb-2"><i class="fa-solid fa-database mr-1"></i> {{ t('header_godmode') }}</div>
                    <p class="text-xs text-[var(--text-dim)] mb-4 leading-relaxed">用自然语言直接修改世界状态。例如：“把所有名为‘帝国’的势力的兵力设为0”，“给所有人增加一个‘理智值’属性，默认为100”。</p>
                    <textarea v-model="godModeInput" class="flex-1 bg-[var(--bg-input)] border border-amber-500/30 theme-rounded-sm p-3 text-sm font-mono text-[var(--text-main)] resize-none outline-none focus:border-amber-500 transition" placeholder="t('ph_godmode')"></textarea>
                    <div class="mt-4 flex justify-end">
                        <button @click="executeGodMode" :disabled="isThinking || !godModeInput.trim()" class="px-6 py-2 bg-amber-600 hover:bg-amber-500 text-white font-bold text-xs uppercase tracking-widest theme-rounded-sm shadow-lg flex items-center gap-2 disabled:opacity-50">
                            <i :class="isThinking ? 'fa-solid fa-circle-notch fa-spin' : 'fa-solid fa-bolt'"></i> {{ t('btn_execute') }}
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex-1 flex flex-col bg-[var(--bg-panel)] relative overflow-hidden">
                
                <!-- 1. 顶部：AI 按钮栏 -->
                <div class="p-4 bg-[var(--bg-sidebar)] border-b border-[var(--border-dim)] shadow-xl z-20 shrink-0">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest"><i class="fa-solid fa-microchip mr-1"></i> {{ t('ai_core_label') }}</span>
                        <!-- [新增] 安科模式开关 -->
                        <button @click="generateOptions = !generateOptions" 
                            :class="generateOptions ? 'bg-pink-600 border-pink-500 text-white shadow-[0_0_15px_rgba(219,39,119,0.4)]' : 'bg-[var(--bg-badge)] border-[var(--border-dim)] text-[var(--text-dim)] hover:text-[var(--text-main)]'"
                            class="px-3 py-1.5 theme-rounded-sm border text-[10px] font-bold transition-all duration-300 flex items-center gap-2">
                            <i :class="generateOptions ? 'fa-solid fa-dice text-white' : 'fa-solid fa-dice text-[var(--text-dim)]'"></i>
                            <span>{{ generateOptions ? 'ANKO: ON' : 'ANKO MODE' }}</span>
                        </button>
                    </div>
                    <button @click="openContextModal" :disabled="isThinking" class="w-full py-4 theme-rounded-sm bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-500 hover:to-indigo-600 text-white font-bold text-sm tracking-widest shadow-lg shadow-indigo-900/30 transition disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-3">
                        <i :class="isThinking ? 'fa-solid fa-circle-notch fa-spin' : 'fa-solid fa-bolt'"></i>
                        {{ isThinking ? t('status_thinking') : t('btn_ai_deduce') }}
                    </button>
                </div>

                <!-- 2. 中间：滚动输入区域 (关键：flex-1 overflow-y-auto) -->
                <div class="flex-1 overflow-y-auto p-0 min-h-0">
                    
                    <!-- 行动方 & 时间 -->
                    <div class="p-5 border-b border-[var(--border-dim)] flex gap-4 bg-[var(--bg-header)]">
                        <div class="flex-1">
                            <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-1 tracking-wider">{{ t('label_actor') }}</label>
                            <select v-model="editor.factionId" class="w-full input-tech theme-rounded-sm p-3 text-sm font-bold outline-none">
                                <option value="" disabled selected>{{ t('option_ai_auto') }}</option>
                                <option value="global">{{ t('option_global') }}</option>
                                <option v-for="p in players" :value="p.id">{{ p.name }}</option>
                            </select>
                        </div>
                        <div class="w-1/4">
                            <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-1 tracking-wider">{{ t('label_start') }}</label>
                            <input v-model="editor.timeStart" class="w-full input-tech theme-rounded-sm p-3 text-sm font-mono-tech text-center outline-none">
                        </div>
                        <div class="w-1/4">
                            <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-1 tracking-wider">{{ t('label_end') }}</label>
                            <input v-model="editor.timeEnd" class="w-full input-tech theme-rounded-sm p-3 text-sm font-mono-tech text-center outline-none">
                        </div>
                    </div>

                    <!-- 摘要 -->
                    <div class="p-5 border-b border-[var(--border-dim)]">
                        <label class="block text-[10px] font-bold text-emerald-500 uppercase mb-2 tracking-widest">{{ t('label_summary') }}</label>
                        <textarea v-model="editor.summary" class="w-full h-24 input-tech theme-rounded-sm p-3 text-lg font-bold text-[var(--text-main)] resize-none outline-none leading-normal" placeholder="..."></textarea>
                    </div>

                    <!-- 状态变更 (已升级) -->
                    <div class="p-5 border-b border-[var(--border-dim)] bg-[var(--bg-badge)]">
                        <label class="block text-[10px] font-bold text-amber-500 uppercase mb-3 tracking-widest">{{ t('label_impact') }}</label>
                        
                            <!-- Impact 列表显示区 (已升级) -->
                            <div class="flex flex-wrap gap-3 mb-4">
                                <div v-for="(imp, idx) in editor.impacts" :key="idx" class="impact-badge pr-0 overflow-hidden relative" 
                                    :style="{ borderColor: getImpactColor(imp) }">
                                    
                                    <!-- 1. 属性变更 Badge -->
                                    <template v-if="imp.type === 'STAT_CHANGE'">
                                        <!-- 分支 A: 全局变量变更 -->
                                        <template v-if="imp.targetId === 'global'">
                                            <div class="flex items-center gap-2 pr-2 border-r border-slate-500/40">
                                                <i class="fa-solid fa-globe text-slate-400"></i>
                                                <span class="font-bold text-xs text-slate-400">{{ imp.targetName }}</span>
                                            </div>
                                            <div class="font-mono-tech text-xs text-[var(--text-main)] pl-2">
                                                <span class="text-[var(--text-dim)] mr-1">{{ imp.attrLabel }}</span>
                                                <span class="font-bold">{{ resolveVal(imp.oldValue) }} → {{ resolveVal(imp.newValue) }}</span>
                                            </div>
                                        </template>
                                        <!-- 分支 B: 普通实体变更 -->
                                        <template v-else>
                                            <div class="flex items-center gap-2 pr-2 border-r" :style="{ borderColor: getFactionColor(imp.targetId) + '40' }">
                                                <img v-if="isImage(getFactionLogo(imp.targetId))" :src="getFactionLogo(imp.targetId)" class="h-4 w-auto max-w-[24px] object-contain rounded-[1px] border border-white/10">
                                                <i v-else :class="getFactionLogo(imp.targetId)" :style="{ color: getFactionColor(imp.targetId) }"></i>
                                                <span class="font-bold text-xs" :style="{ color: getFactionColor(imp.targetId) }">{{ imp.targetName }}</span>
                                            </div>
                                            <div class="font-mono-tech text-xs text-[var(--text-main)] pl-2">
                                                <span class="text-[var(--text-dim)] mr-1">{{ imp.attrLabel }}</span>
                                                <span class="font-bold">{{ resolveVal(imp.oldValue) }} <i class="fa-solid fa-arrow-right text-[10px] mx-1 opacity-50"></i> {{ resolveVal(imp.newValue) }}</span>
                                            </div>
                                        </template>
                                    </template>
                                
                                <!-- 2. 地块转移 Badge -->
                                <template v-else-if="imp.type === 'REGION_TRANSFER'">
                                    <i class="fa-solid fa-map-location-dot mr-1 text-indigo-400"></i>
                                    <span class="text-[var(--text-dim)] text-xs">{{ imp.targetName }}</span>
                                    <i class="fa-solid fa-arrow-right text-[10px] mx-1 opacity-50"></i>
                                    <i :class="getFactionLogo(imp.newValue)" class="mr-1" :style="{color: getFactionColor(imp.newValue)}"></i>
                                    <span class="font-bold text-xs" :style="{color: getFactionColor(imp.newValue)}">{{ getFactionName(imp.newValue) }}</span>
                                </template>

                                <!-- 3. 创建实体 Badge -->
                                <template v-else-if="imp.type === 'ENTITY_CREATE'">
                                    <i class="fa-solid fa-user-plus mr-1 text-emerald-400"></i>
                                    <span class="text-xs">New Entity:</span>
                                    <span class="font-bold text-xs text-emerald-400 ml-1">{{ imp.data.name }}</span>
                                </template>

                                <!-- 4. 移除实体 Badge -->
                                <template v-else-if="imp.type === 'ENTITY_REMOVE'">
                                    <i class="fa-solid fa-user-minus mr-1 text-red-400"></i>
                                    <span class="text-xs text-[var(--text-dim)]">Removed:</span>
                                    <span class="font-bold text-xs text-red-400 ml-1">{{ getFactionName(imp.targetId) }}</span>
                                </template>
                                <!-- 5. 移动标记 Badge [新增] -->
                                <template v-else-if="imp.type === 'PIN_MOVE'">
                                    <i class="fa-solid fa-arrows-up-down-left-right mr-1 text-pink-400"></i>
                                    <span class="font-bold text-xs text-pink-400">{{ imp.targetName }}</span>
                                    <span class="font-mono text-[10px] ml-1 opacity-70">to [{{ imp.newValue }}]</span>
                                </template>
                                <button @click="removeImpact(idx)" class="ml-2 px-2 self-stretch flex items-center bg-black/10 hover:bg-red-500/20 text-[var(--text-dim)] hover:text-red-400"><i class="fa-solid fa-times"></i></button>
                            </div>
                        </div>
                        
                        <!-- Impact 编辑器 (已升级) -->
                        <div class="bg-[var(--bg-badge)] p-2 theme-rounded-sm border border-[var(--border-dim)]">
                            <!-- A. 类型选择 (中文替换) -->
                            <div class="flex p-1 gap-1 bg-[var(--bg-deep)] theme-rounded-sm border border-[var(--border-dim)] mb-2">
                                <button @click="impactForm.type = 'STAT_CHANGE'" :class="impactForm.type === 'STAT_CHANGE' ? 'bg-indigo-600 text-white' : 'text-[var(--text-dim)] hover:bg-[var(--bg-panel)]'" class="flex-1 py-1 text-[10px] font-bold theme-rounded-sm transition">{{ t('btn_type_stat') }}</button>
                                <button @click="impactForm.type = 'REGION_TRANSFER'" :class="impactForm.type === 'REGION_TRANSFER' ? 'bg-indigo-600 text-white' : 'text-[var(--text-dim)] hover:bg-[var(--bg-panel)]'" class="flex-1 py-1 text-[10px] font-bold theme-rounded-sm transition">{{ t('btn_type_region') }}</button>
                                <button @click="impactForm.type = 'ENTITY_CREATE'" :class="impactForm.type === 'ENTITY_CREATE' ? 'bg-emerald-600 text-white' : 'text-[var(--text-dim)] hover:bg-[var(--bg-panel)]'" class="flex-1 py-1 text-[10px] font-bold theme-rounded-sm transition">{{ t('btn_type_create') }}</button>
                                <button @click="impactForm.type = 'ENTITY_REMOVE'" :class="impactForm.type === 'ENTITY_REMOVE' ? 'bg-red-600 text-white' : 'text-[var(--text-dim)] hover:bg-[var(--bg-panel)]'" class="flex-1 py-1 text-[10px] font-bold theme-rounded-sm transition">{{ t('btn_type_remove') }}</button>
                                <button @click="impactForm.type = 'PIN_MOVE'" :class="impactForm.type === 'PIN_MOVE' ? 'bg-pink-600 text-white' : 'text-[var(--text-dim)] hover:bg-[var(--bg-panel)]'" class="flex-1 py-1 text-[10px] font-bold theme-rounded-sm transition">移动标记</button>
                            </div>

                            <!-- B. 条件表单 (中文替换) -->
                            <div class="flex gap-3 items-center">
                                <!-- Form 1: Stat Change -->
                                <template v-if="impactForm.type === 'STAT_CHANGE'">
                                    <!-- [修改] 目标选择框：增加 Global 选项 -->
                                    <select v-model="impactForm.targetId" class="input-tech text-xs p-2 w-1/3 outline-none">
                                        <option value="" disabled>{{ t('ph_target_entity') }}</option>
                                        <option value="global" class="text-amber-500 font-bold">【全局环境】</option> <!-- 新增 -->
                                        <option v-for="p in players" :value="p.id">{{ p.name }}</option>
                                    </select>

                                    <!-- [修改] 属性选择框：根据是否选择 Global 切换列表 -->
                                    <select v-model="impactForm.attrKey" class="input-tech text-xs p-2 w-1/4 outline-none">
                                        <option value="" disabled>{{ t('ph_attribute') }}</option>
                                        
                                        <!-- 如果选了 Global，循环显示 global_vars -->
                                        <template v-if="impactForm.targetId === 'global'">
                                            <option v-for="g in global_vars" :value="g.key">{{ g.key }}</option>
                                        </template>
                                        
                                        <!-- 否则，根据所选目标的类型，显示对应的属性字段 -->
                                        <template v-else>
                                            <!-- 计算属性: 根据 impactForm.targetId 找到实体，再找到 schemaId，再找到 fields -->
                                            <option v-for="field in getFieldsForImpactTarget(impactForm.targetId)" :value="field.key">
                                                {{ field.label }}
                                            </option>
                                        </template>
                                    </select>

                                    <!-- 显示当前值 (也需要适配 Global) -->
                                    <div class="px-2 text-[10px] text-center text-[var(--text-dim)] font-mono bg-[var(--bg-badge)] theme-rounded-sm h-8 flex items-center justify-center min-w-[40px]">
                                        {{ getAttrValueDisplay(impactForm.targetId, impactForm.attrKey) }} <i class="fa-solid fa-arrow-right ml-1"></i>
                                    </div>
                                    
                                    <input v-model="impactForm.newValue" @keyup.enter="addImpact" :placeholder="t('ph_new_value')" class="input-tech text-emerald-400 font-bold font-mono-tech theme-rounded-sm p-2 flex-1 outline-none text-center">
                                </template>
                                <!-- Form 2: Region Transfer -->
                                <template v-if="impactForm.type === 'REGION_TRANSFER'">
                                    <select v-model="impactForm.targetName" class="input-tech text-xs p-2 w-1/2 outline-none"><option value="" disabled>{{ t('ph_target_region') }}</option><option v-for="reg in map_data.regions" :value="reg.name">{{ reg.name }}</option></select>
                                    <select v-model="impactForm.newValue" class="input-tech text-xs p-2 flex-1 outline-none"><option value="" disabled>{{ t('ph_new_controller') }}</option><option v-for="p in players" :value="p.id">{{ p.name }}</option></select>
                                </template>

                                <!-- Form 3: Create Entity -->
                                <template v-if="impactForm.type === 'ENTITY_CREATE'">
                                    <input v-model="impactForm.newValue" :placeholder="t('ph_new_entity_name')" class="input-tech font-bold theme-rounded-sm p-2 flex-1 outline-none">
                                </template>

                                <!-- Form 4: Remove Entity -->
                                <template v-if="impactForm.type === 'ENTITY_REMOVE'">
                                    <select v-model="impactForm.targetId" class="input-tech text-xs p-2 w-full outline-none"><option value="" disabled>{{ t('ph_entity_remove') }}</option><option v-for="p in players" :value="p.id">{{ p.name }}</option></select>
                                </template>
                                <!-- Form 5: Move Pin [新增] -->
                                <template v-if="impactForm.type === 'PIN_MOVE'">
                                    <select v-model="impactForm.targetId" class="input-tech text-xs p-2 w-1/2 outline-none">
                                        <option value="" disabled>Select Pin</option>
                                        <option v-for="pin in map_data.pins" :value="pin.id">{{ pin.label || getPinName(pin.linkId) }}</option>
                                    </select>
                                    <div class="flex flex-1 gap-1">
                                        <input v-model="impactForm.newValue" placeholder="X,Y (e.g. 50,50)" class="input-tech text-xs p-2 w-full font-mono outline-none text-center" title="Format: x,y">
                                    </div>
                                </template>
                                
                                <button @click="addImpact" class="h-8 w-10 theme-rounded-sm bg-emerald-600 hover:bg-emerald-500 text-white flex items-center justify-center shrink-0"><i class="fa-solid fa-plus"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- 详细内容 (设置 min-h 防止挤压) -->
                    <!-- [修改后] 右侧编辑器区域 -->
                    <div class="p-5 flex flex-col min-h-[400px] relative pb-20"> <!-- 1. 增加 pb-20 防止底部被遮挡 -->
                        
                        <label class="block text-[10px] font-bold text-indigo-400 uppercase mb-2 tracking-widest">{{ t('label_details') }}</label>
                        
                        <!-- 内容输入框 -->
                        <textarea v-model="editor.content" class="flex-1 input-tech theme-rounded-sm p-4 text-base font-mono-tech text-[var(--text-main)] resize-none outline-none leading-relaxed h-full min-h-[200px]" placeholder="// ..."></textarea>
                        
                        <!-- [修改点] 安科选项编辑区 -->
                        <div class="mt-4 pt-4 border-t border-[var(--border-dim)]">
                            <!-- 2. 标题行：左对齐，按钮紧跟文字 -->
                            <div class="flex items-center gap-3 mb-2">
                                <div class="text-[10px] font-bold text-pink-500 uppercase tracking-widest"><i class="fa-solid fa-list-ul mr-1"></i> ANKO OPTIONS</div>
                                <!-- Add 按钮放在这里 -->
                                <button @click="addOptionToEditor" class="text-[10px] bg-pink-900/20 text-pink-400 border border-pink-500/30 px-2 py-0.5 theme-rounded-sm hover:bg-pink-600 hover:text-white transition flex items-center gap-1" title="Add new option">
                                    <i class="fa-solid fa-plus"></i> Add
                                </button>
                            </div>

                            <!-- 选项列表 -->
                            <div v-if="editor.options && editor.options.length > 0" class="space-y-2">
                                <div v-for="(opt, oi) in editor.options" :key="oi" class="bg-[var(--bg-badge)] p-2 theme-rounded-sm border border-[var(--border-dim)] flex gap-2 items-start group">
                                    <div class="flex-1 space-y-1">
                                        <!-- Label 输入 -->
                                        <div class="flex items-center gap-2">
                                            <span class="text-[9px] text-pink-500 font-bold uppercase w-8 text-right">Label</span>
                                            <input v-model="opt.label" class="flex-1 bg-[var(--bg-input)] text-xs font-bold text-[var(--text-main)] px-1 py-0.5 theme-rounded-sm border border-[var(--border-dim)] outline-none focus:border-pink-500 placeholder-pink-500/30" placeholder="Short Title">
                                        </div>
                                        <!-- Desc 输入 -->
                                        <div class="flex items-center gap-2">
                                            <span class="text-[9px] text-[var(--text-dim)] font-bold uppercase w-8 text-right">Desc</span>
                                            <input v-model="opt.desc" class="flex-1 bg-[var(--bg-input)] text-xs text-[var(--text-dim)] px-1 py-0.5 theme-rounded-sm border border-[var(--border-dim)] outline-none focus:border-pink-500 placeholder-[var(--text-dim)]/30" placeholder="Consequence description...">
                                        </div>
                                    </div>
                                    <!-- 删除按钮 -->
                                    <button @click="editor.options.splice(oi,1)" class="text-[var(--text-dim)] hover:text-red-400 mt-1 px-1"><i class="fa-solid fa-times"></i></button>
                                </div>
                            </div>
                            <div v-else class="text-[10px] text-[var(--text-dim)] italic opacity-30 py-1 pl-1">
                                (No options defined. Click 'Add' to create manual choices.)
                            </div>
                        </div>

                        <!-- 悬浮的 Add to Pending 按钮 (保持不变) -->
                        <div class="absolute bottom-8 right-8 z-20">
                            <button @click="addToStaging" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 theme-rounded-sm shadow-xl font-bold text-sm transition transform active:scale-95 hover:-translate-y-1 flex items-center gap-2">
                                <i class="fa-solid fa-plus"></i> {{ t('btn_add_pending') }}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 3. 底部：Commit 按钮 (关键：shrink-0 z-50) -->
                <div class="bg-[var(--bg-sidebar)] p-5 border-t border-[var(--border-dim)] flex justify-between items-center shadow-[0_-10px_40px_var(--shadow-color)] z-50 shrink-0 relative">
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] text-[var(--text-dim)] font-bold uppercase tracking-widest">{{ t('label_next_turn_b') }}</span>
                        <input v-model="pendingTurnRange" class="bg-[var(--bg-input)] border border-[var(--border-dim)] text-emerald-500 font-mono-tech text-sm font-bold theme-rounded-sm px-2 py-0.5 w-24 outline-none text-center" :placeholder="t('auto')">
                    </div>
                    <button @click="commitTurn" :disabled="pendingEvents.length === 0" class="px-8 py-3 bg-indigo-600 hover:bg-indigo-500 disabled:bg-[var(--bg-input)] disabled:text-[var(--text-dim)] text-white font-bold text-sm tracking-widest uppercase theme-rounded-sm shadow-lg transition transform active:scale-[0.98] flex items-center gap-3">
                        <i class="fa-solid fa-play"></i> {{ t('btn_commit') }}
                    </button>
                </div>

            </div>
        </aside>

    </main>
    <!-- [新增] 截图模式辅助层 -->
    <div v-if="isScreenshotMode" class="screenshot-backdrop" @mousemove="handleScreenshotHover" @click.stop.prevent="captureScreenshot" @contextmenu.prevent="exitScreenshotMode"></div>
    <div v-if="isScreenshotMode && screenshotRect.w > 0" class="screenshot-overlay" :style="{ top: screenshotRect.y + 'px', left: screenshotRect.x + 'px', width: screenshotRect.w + 'px', height: screenshotRect.h + 'px' }">
        <div class="screenshot-label">SNAP: {{ screenshotTargetName }} (Click to Save)</div>
    </div>
<!-- HIDDEN POSTER CANVAS -->
    <div id="poster-canvas">
        
        <!-- TEMPLATE 1: TERMINAL (完全修复版) -->
        <div v-if="ui.theme !== 'newspaper'" class="poster-terminal" :style="{ borderLeftColor: posterData.color }">
            <div class="bg-texture"></div>
            <i :class="posterData.icon" class="poster-watermark-logo" :style="{ color: posterData.color }"></i>
            
            <div class="poster-header">
                <div class="text-slate-400 font-mono-tech text-3xl font-bold tracking-wider flex items-center">
                    <i class="fa-regular fa-clock mr-4"></i>{{ posterData.timeDisplay }}
                </div>
                <div class="uppercase flex items-center gap-4 text-3xl font-bold tracking-wider whitespace-nowrap" :style="{ color: posterData.color }">
                    <i class="fa-solid fa-tower-broadcast opacity-80"></i> {{ posterData.factionName }}
                </div>
            </div>

            <div class="poster-body">
                <h1 class="leading-tight">{{ posterData.title }}</h1>
                
                <!-- 属性徽章：恢复左右分栏结构 -->
                <div v-if="posterData.badges && posterData.badges.length > 0" class="poster-badge-container">
                    <div v-for="(badge, i) in posterData.badges" :key="i" class="poster-badge" :style="{ borderColor: badge.color }">
                        <div class="poster-badge-left">
                            <i :class="badge.icon" :style="{ color: badge.color }"></i>
                            <span :style="{ color: badge.color }">{{ badge.name }}</span>
                        </div>
                        <div class="poster-badge-right">
                            <span class="text-slate-400 uppercase mr-4 tracking-wider">{{ badge.label }}</span>
                            <i class="fa-solid fa-arrow-right text-slate-600 mr-4 text-sm"></i>
                            <span class="font-bold text-white tracking-wide">{{ badge.val }}</span>
                        </div>
                    </div>
                </div>

                <div class="poster-md md-body" v-html="posterData.content"></div>
            </div>

            <div class="poster-footer">
                <div class="flex items-center gap-4"><i class="fa-solid fa-layer-group text-indigo-500"></i><span>LEVANT 自动化推演</span></div>
                <div class="flex flex-col items-end"><span class="text-slate-500 text-sm mb-1 font-bold">POWERED BY 絜矩 (QQ 2124223354)</span><span class="text-emerald-500 font-bold">LEVANT v1.08</span></div>
            </div>
        </div>

        <!-- TEMPLATE 2: NEWSPAPER (保留所有优化) -->
        <div v-else class="poster-newspaper">
            <div class="paper-grain"></div>
            
            <div class="news-header">
                <div class="brand">NEWS</div>
                <div class="meta">
                    <span>Vol. {{ timeline.length + 1 }}</span>
                    <span>{{ posterData.timeDisplay }}</span>
                    <span>{{ posterData.factionName }}</span>
                </div>
            </div>

            <h1 class="headline">{{ posterData.title }}</h1>

            <div v-if="posterData.badges && posterData.badges.length > 0" class="badges-row">
                 <div v-for="(badge, i) in posterData.badges" :key="i" class="stamp-badge">
                     <i :class="badge.icon"></i>
                     <span>{{ badge.label }}: {{ badge.val }}</span>
                 </div>
            </div>

            <div class="poster-md content-cols" v-html="posterData.content"></div>

            <div style="margin-top: auto; border-top: 1px solid #333; padding-top: 20px; text-align: center; font-family: monospace; font-size: 14px; color: #555;">
                LEVANT 自动化推演 | AUTOMATED REPORT | POWERED BY 絜矩 (QQ 2124223354)
            </div>
        </div>

    </div>

    <!-- Context Assembler Modal -->
    <transition name="fade">
        <div v-if="showContextModal" class="modal-mask" @click.self="showContextModal = false">
            <div role="dialog" aria-label="Context Assembler" class="glass-panel theme-rounded w-[900px] h-[90vh] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-5 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center shrink-0">
                    <div>
                        <h3 class="text-xl font-bold text-[var(--text-main)]"><i class="fa-solid fa-layer-group mr-2 text-indigo-400"></i>{{ t('modal_context_title') }}</h3>
                        <p class="text-xs text-[var(--text-dim)] mt-1">{{ t('modal_context_subtitle') }}</p>
                    </div>
                    <button @click="showContextModal = false" class="text-[var(--text-dim)] hover:text-[var(--text-main)] text-xl"><i class="fa-solid fa-times"></i></button>
                </div>

                <div class="flex-1 flex overflow-hidden">
                    <!-- 左侧：组装流水线 -->
                    <div class="w-1/2 p-5 bg-[var(--bg-panel)] overflow-y-auto border-r border-[var(--border-dim)]">
                        <!-- System Prompt -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-[var(--text-dim)] uppercase tracking-widest">{{ t('set_sys_prompt') }} (Temp)</label>
                            </div>
                            <textarea v-model="tempSystemPrompt" class="w-full h-24 bg-[var(--bg-badge)] border border-[var(--border-dim)] theme-rounded-sm p-2 text-xs text-[var(--text-main)] font-mono resize-none"></textarea>
                        </div>
                        <!-- 模块列表 (拖拽排序) -->
                        <div class="space-y-4">
                            <div v-for="type in contextConfig.order" :key="type">
                                <!-- 🔴 当前指令 -->
                                <div v-if="type === 'current'" class="border border-red-500/30 theme-rounded-sm bg-red-900/10">
                                    <div class="p-2 bg-red-900/20 border-b border-red-500/20 flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" v-model="contextConfig.includeCurrent" class="accent-red-500">
                                            <span class="text-xs font-bold text-red-400 uppercase">🔴 {{ t('ctx_current') }}</span>
                                        </div>
                                        <div class="flex gap-1 text-[var(--text-dim)] text-[10px]">
                                            <button @click="moveContextItem('current', -1)"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('current', 1)"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                    <div v-if="contextConfig.includeCurrent" class="p-2 text-[10px] text-[var(--text-dim)] font-mono space-y-1">
                                        <div v-if="rawInput" class="truncate">CMD: {{ rawInput }}</div>
                                        <div v-if="editor.summary" class="truncate text-[var(--text-main)]">Summary: {{ editor.summary }}</div>
                                    </div>
                                </div>
                                <!-- 全局变量 -->
                                <div v-if="type === 'global'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" v-model="contextConfig.includeGlobal" class="accent-indigo-500">
                                            <span class="text-xs font-bold text-indigo-400 uppercase">{{ t('ctx_global') }}</span>
                                        </div>
                                        <div class="flex gap-1 text-[var(--text-dim)] text-[10px]">
                                            <button @click="moveContextItem('global', -1)"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('global', 1)"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <!-- 规则 -->
                                <div v-if="type === 'rules'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" v-model="contextConfig.includeRules" class="accent-indigo-500">
                                            <span class="text-xs font-bold text-amber-400 uppercase">{{ t('ctx_rules') }}</span>
                                        </div>
                                        <div class="flex gap-1 text-[var(--text-dim)] text-[10px]">
                                            <button @click="moveContextItem('rules', -1)"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('rules', 1)"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Lore -->
                                <div v-if="type === 'lore'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs font-bold text-emerald-400 uppercase">{{ t('ctx_lore') }}</span>
                                        </div>
                                        <div class="flex gap-1 text-[var(--text-dim)] text-[10px]">
                                            <button @click="moveContextItem('lore', -1)"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('lore', 1)"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                    <div class="p-2 space-y-1 max-h-40 overflow-y-auto">
                                        <div v-for="(entry, i) in contextConfig.loreList" :key="i" class="flex items-center gap-2 context-item" :class="{'active': entry.active, 'disabled': !entry.active}">
                                            <input type="checkbox" v-model="entry.active" class="accent-emerald-500">
                                            <span class="text-xs text-[var(--text-main)] truncate flex-1">{{ entry.keys }}</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Players -->
                                <div v-if="type === 'players'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs font-bold text-blue-400 uppercase">{{ t('ctx_entities') }}</span>
                                        </div>
                                        <div class="flex gap-1 text-[var(--text-dim)] text-[10px]">
                                            <button @click="moveContextItem('players', -1)"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('players', 1)"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                    <div class="p-2 space-y-1 max-h-40 overflow-y-auto">
                                        <div v-for="(p, i) in contextConfig.playerList" :key="i" class="flex items-center gap-2 context-item" :class="{'active': p.active, 'disabled': !p.active}">
                                            <input type="checkbox" v-model="p.active" class="accent-blue-500">
                                            <span class="text-xs truncate flex-1 font-bold" :style="{ color: p.color }">{{ p.name }}</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- [新增] Map Data 模块 -->
                                <div v-if="type === 'map'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <!-- 标题栏 -->
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" v-model="contextConfig.includeMap" class="accent-pink-500">
                                            <span class="text-xs font-bold text-pink-400 uppercase">{{ t('view_map') }} DATA</span>
                                        </div>
                                        <div class="flex gap-1 text-[var(--text-dim)] text-[10px]">
                                            <button @click="moveContextItem('map', -1)"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('map', 1)"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                    
                                    <!-- 内容列表 (可滚动) -->
                                    <div v-if="contextConfig.includeMap" class="p-2 space-y-3 max-h-60 overflow-y-auto">
                                        
                                        <!-- 子列表: Regions -->
                                        <div v-if="contextConfig.mapRegionList.length > 0">
                                            <div class="text-[9px] font-bold text-[var(--text-dim)] uppercase mb-1 flex justify-between">
                                                <span><i class="fa-solid fa-draw-polygon mr-1"></i>Regions</span>
                                                <span class="opacity-50">{{ contextConfig.mapRegionList.filter(r=>r.active).length }}/{{ contextConfig.mapRegionList.length }}</span>
                                            </div>
                                            <div class="space-y-1">
                                                <div v-for="(reg, i) in contextConfig.mapRegionList" :key="'reg'+i" 
                                                    class="flex items-center gap-2 context-item py-1" 
                                                    :class="{'active': reg.active, 'disabled': !reg.active}">
                                                    <input type="checkbox" v-model="reg.active" class="accent-pink-500">
                                                    <span class="text-xs text-[var(--text-main)] truncate flex-1">{{ reg.name }}</span>
                                                    <span class="text-[9px] px-1 bg-black/20 rounded text-[var(--text-dim)]">{{ getFactionName(reg.ownerId) }}</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 子列表: Pins -->
                                        <div v-if="contextConfig.mapPinList.length > 0">
                                            <div class="text-[9px] font-bold text-[var(--text-dim)] uppercase mb-1 mt-2 flex justify-between">
                                                <span><i class="fa-solid fa-map-pin mr-1"></i>Pins (POI)</span>
                                                <span class="opacity-50">{{ contextConfig.mapPinList.filter(p=>p.active).length }}/{{ contextConfig.mapPinList.length }}</span>
                                            </div>
                                            <div class="space-y-1">
                                                <div v-for="(pin, i) in contextConfig.mapPinList" :key="'pin'+i" 
                                                    class="flex items-center gap-2 context-item py-1" 
                                                    :class="{'active': pin.active, 'disabled': !pin.active}">
                                                    <input type="checkbox" v-model="pin.active" class="accent-orange-500">
                                                    <span class="text-xs text-[var(--text-main)] truncate flex-1">{{ pin.label || getPinName(pin.linkId) || 'Marker' }}</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 空状态提示 -->
                                        <div v-if="contextConfig.mapRegionList.length === 0 && contextConfig.mapPinList.length === 0" class="text-center py-4 opacity-50 text-xs">
                                            (No Map Data)
                                        </div>
                                    </div>
                                </div>
                                <!-- History -->
                                <div v-if="type === 'history'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" v-model="contextConfig.includeHistory" class="accent-indigo-500">
                                            <span class="text-xs font-bold text-[var(--text-main)] uppercase">{{ t('ctx_history') }}</span>
                                        </div>
                                        <div class="flex gap-1 text-[var(--text-dim)] text-[10px]">
                                            <button @click="moveContextItem('history', -1)"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('history', 1)"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                    <div v-if="contextConfig.includeHistory" class="p-4 space-y-4">
                                        <!-- 深记忆控制 -->
                                        <div>
                                            <div class="flex justify-between text-[10px] font-bold text-emerald-500 mb-1 uppercase tracking-wider">
                                                <span>{{ t('ctx_hist_deep') }}</span>
                                                <span>{{ contextConfig.historyDeepDepth }} Turns</span>
                                            </div>
                                            <input type="range" v-model.number="contextConfig.historyDeepDepth" min="0" max="5" class="w-full h-1 bg-[var(--border-dim)] theme-rounded-sm appearance-none cursor-pointer accent-emerald-500">
                                        </div>
                                        <!-- 浅记忆控制 -->
                                        <div>
                                            <div class="flex justify-between text-[10px] font-bold text-[var(--text-dim)] mb-1 uppercase tracking-wider">
                                                <span>{{ t('ctx_hist_shallow') }}</span>
                                                <span>{{ contextConfig.historyShallowDepth }} Turns</span>
                                            </div>
                                            <input type="range" v-model.number="contextConfig.historyShallowDepth" min="0" max="20" class="w-full h-1 bg-[var(--border-dim)] theme-rounded-sm appearance-none cursor-pointer">
                                        </div>
                                        <div class="text-[10px] text-[var(--text-dim)] italic border-t border-[var(--border-dim)] pt-2 mt-2">
                                            Total Context: Past {{ contextConfig.historyShallowDepth + contextConfig.historyDeepDepth }} Turns <i class="fa-solid fa-arrow-right mx-1"></i> Present
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧：实时预览 -->
                    <div class="w-1/2 p-5 bg-[var(--bg-header)] flex flex-col">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-[var(--text-dim)] uppercase tracking-widest">{{ t('ctx_preview_label') }}</label>
                            <span class="text-xs font-mono text-indigo-400">{{ finalContextPreview.length }} chars</span>
                        </div>
                        <textarea readonly :value="finalContextPreview" class="flex-1 w-full bg-[var(--bg-deep)] border border-[var(--border-dim)] theme-rounded-sm p-4 text-xs font-mono text-[var(--text-dim)] resize-none outline-none leading-relaxed"></textarea>
                    </div>
                </div>

                <div class="p-5 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center shrink-0">
                    <div class="text-xs text-[var(--text-dim)]">{{ t('ctx_preview_hint') }}</div>
                    <button @click="runAiInference" :disabled="isThinking" class="px-8 py-3 theme-rounded-sm bg-emerald-600 hover:bg-emerald-500 text-white font-bold text-sm shadow-lg transition flex items-center gap-2">
                        <i v-if="isThinking" class="fa-solid fa-circle-notch fa-spin"></i>
                        <i v-else class="fa-solid fa-bolt"></i>
                        EXECUTE
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <!-- Modals (Settings) -->
    <transition name="fade">
        <div v-if="showSettings" class="modal-mask" @click.self="showSettings=false">
            <div role="dialog" aria-label="Settings" class="glass-panel theme-rounded w-[600px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-6 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center">
                    <h2 class="text-xl font-bold"><i class="fa-solid fa-sliders mr-2 text-[var(--text-dim)]"></i> {{ t('settings_title') }}</h2>
                    <button @click="showSettings = false" class="text-[var(--text-dim)] hover:text-[var(--text-main)] text-xl"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-8 space-y-8 bg-[var(--bg-panel)] max-h-[70vh] overflow-y-auto">
                    <!-- UI 设置 -->
                    <section>
                        <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-4 pb-2 border-b border-[var(--border-dim)]">{{ t('settings_ui') }}</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-[var(--text-dim)] mb-2">{{ t('settings_theme') }}</label>
                                <select v-model="ui.theme" class="w-full input-tech theme-rounded-sm p-3 text-sm outline-none">
                                    <option value="terminal">Terminal (Dark)</option>
                                    <option value="newspaper">Newspaper (Light)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-[var(--text-dim)] mb-2">{{ t('settings_lang') }}</label>
                                <select v-model="ui.lang" class="w-full input-tech theme-rounded-sm p-3 text-sm outline-none">
                                    <option value="zh">中文 (Chinese)</option>
                                    <option value="en">English</option>
                                    <option value="ja">日本語 (Japanese)</option>
                                </select>
                            </div>
                        </div>
                    </section>
                    
                    <section>
                        <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-4 pb-2 border-b border-[var(--border-dim)]">{{ t('set_llm_config') }}</h3>
                        
                        <!-- 快速预设按钮 -->
                        <div class="mb-4 flex gap-2 overflow-x-auto pb-2">
                            <button @click="applyPreset('Gemini')" class="px-3 py-1 theme-rounded-sm border border-[var(--border-dim)] text-[10px] font-bold hover:bg-emerald-600 hover:text-white transition">Gemini</button>
                            <button @click="applyPreset('Claude')" class="px-3 py-1 theme-rounded-sm border border-[var(--border-dim)] text-[10px] font-bold hover:bg-orange-700 hover:text-white transition">Claude</button>
                            <button @click="applyPreset('DeepSeek')" class="px-3 py-1 theme-rounded-sm border border-[var(--border-dim)] text-[10px] font-bold hover:bg-blue-600 hover:text-white transition">DeepSeek</button>
                            <button @click="applyPreset('Qwen')" class="px-3 py-1 theme-rounded-sm border border-[var(--border-dim)] text-[10px] font-bold hover:bg-purple-600 hover:text-white transition">Qwen</button>
                            <button @click="applyPreset('OpenAI')" class="px-3 py-1 theme-rounded-sm border border-[var(--border-dim)] text-[10px] font-bold hover:bg-gray-600 hover:text-white transition">OpenAI</button>
                            <button @click="applyPreset('SiliconFlow')" class="px-3 py-1 theme-rounded-sm border border-[var(--border-dim)] text-[10px] font-bold hover:bg-orange-600 hover:text-white transition">SiliconFlow</button>
                            <button @click="applyPreset('Others')" class="px-3 py-1 theme-rounded-sm border border-[var(--border-dim)] text-[10px] font-bold hover:bg-indigo-600 hover:text-white transition">Others</button>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-[var(--text-dim)] mb-2">{{ t('set_provider') }}</label>
                                <select v-model="settings.api.provider" class="w-full input-tech theme-rounded-sm p-3 text-sm outline-none">
                                    <option value="Gemini">Gemini (Google)</option>
                                    <option value="Claude">Claude (Anthropic)</option>
                                    <option value="OpenAI">OpenAI Compatible (General)</option>
                                    <option value="Others">Others (Custom BaseURL)</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2">
                                    <label class="block text-xs font-bold text-[var(--text-dim)] mb-2">{{ t('set_base_url') }} <span class="text-[10px] opacity-50">(Required for DeepSeek/Qwen)</span></label>
                                    <input v-model="settings.api.baseUrl" placeholder="e.g. https://api.deepseek.com" class="w-full input-tech theme-rounded-sm p-3 text-sm outline-none font-mono">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-xs font-bold text-[var(--text-dim)] mb-2">{{ t('set_model') }}</label>
                                    <input v-model="settings.api.model" placeholder="e.g. deepseek-chat" class="w-full input-tech theme-rounded-sm p-3 text-sm outline-none font-mono">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-[var(--text-dim)] mb-2">{{ t('set_key') }}</label>
                                <input v-model="settings.api.key" type="password" class="w-full input-tech theme-rounded-sm p-3 text-sm outline-none">
                            </div>
                        </div>
                    </section>
                    
                    <!-- 新增代理设置区块 -->
                    <section>
                        <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-4 pb-2 border-b border-[var(--border-dim)]">{{ t('set_proxy') }}</h3>
                        <div class="flex items-center gap-4 bg-[var(--bg-badge)] p-3 theme-rounded-sm border border-[var(--border-dim)]">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" v-model="settings.proxy.enabled" id="useProxy" class="accent-indigo-500 w-4 h-4">
                                <label for="useProxy" class="text-sm font-bold cursor-pointer select-none">{{ t('set_enable_proxy') }}</label>
                            </div>
                            <div class="h-6 w-px bg-[var(--border-dim)] mx-2"></div>
                            <div class="flex-1 flex items-center gap-2" :class="{'opacity-50 pointer-events-none': !settings.proxy.enabled}">
                                <label class="text-xs font-mono text-[var(--text-dim)]">127.0.0.1:</label>
                                <input v-model="settings.proxy.port" placeholder="7890" class="w-20 input-tech theme-rounded-sm p-1.5 text-center text-sm font-mono outline-none">
                            </div>
                        </div>
                    </section>

                    <section>
                         <h3 class="text-xs font-bold text-emerald-400 uppercase tracking-widest mb-2 pb-2 border-b border-[var(--border-dim)]">AI Prompt Configuration</h3>
                         
                         <!-- 标签切换按钮 -->
                         <div class="flex gap-2 mb-2">
                             <button @click="settingsPromptTab = 'system'" 
                                     :class="settingsPromptTab === 'system' ? 'bg-emerald-600 text-white' : 'bg-[var(--bg-badge)] text-[var(--text-dim)] hover:text-[var(--text-main)]'"
                                     class="px-3 py-1 text-[10px] font-bold theme-rounded-sm transition">
                                 System (Deduction)
                             </button>
                             <button @click="settingsPromptTab = 'script'" 
                                     :class="settingsPromptTab === 'script' ? 'bg-indigo-600 text-white' : 'bg-[var(--bg-badge)] text-[var(--text-dim)] hover:text-[var(--text-main)]'"
                                     class="px-3 py-1 text-[10px] font-bold theme-rounded-sm transition">
                                 Script Gen
                             </button>
                             <button @click="settingsPromptTab = 'god'" 
                                     :class="settingsPromptTab === 'god' ? 'bg-amber-600 text-white' : 'bg-[var(--bg-badge)] text-[var(--text-dim)] hover:text-[var(--text-main)]'"
                                     class="px-3 py-1 text-[10px] font-bold theme-rounded-sm transition">
                                 God Mode
                             </button>
                         </div>

                         <!-- 1. System Prompt 编辑框 -->
                         <div v-if="settingsPromptTab === 'system'">
                             <div class="text-[10px] text-[var(--text-dim)] mb-1">用于日常“战术推演”与“智能补全”的核心指令。</div>
                             <textarea v-model="settings.prompts.system" class="w-full h-64 input-tech theme-rounded-sm p-3 text-xs font-mono resize-none outline-none text-[var(--text-dim)]"></textarea>
                         </div>

                         <!-- 2. Script Generator Prompt 编辑框 -->
                         <div v-if="settingsPromptTab === 'script'">
                             <div class="text-[10px] text-[var(--text-dim)] mb-1">用于“剧本生成”功能，控制世界观初始化逻辑。</div>
                             <textarea v-model="settings.prompts.script_generator" class="w-full h-64 input-tech theme-rounded-sm p-3 text-xs font-mono resize-none outline-none text-[var(--text-dim)]"></textarea>
                         </div>

                         <!-- 3. God Mode Prompt 编辑框 -->
                         <div v-if="settingsPromptTab === 'god'">
                             <div class="text-[10px] text-[var(--text-dim)] mb-1">用于“上帝模式”功能，控制直接修改 JSON 数据的逻辑。</div>
                             <textarea v-model="settings.prompts.god_mode" class="w-full h-64 input-tech theme-rounded-sm p-3 text-xs font-mono resize-none outline-none text-[var(--text-dim)]"></textarea>
                         </div>
                    </section>
                </div>
                <div class="p-6 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-end gap-4"><button @click="showSettings = false" class="px-5 py-2 theme-rounded-sm bg-[var(--bg-badge)] text-[var(--text-dim)] font-bold text-sm hover:text-[var(--text-main)]">{{ t('btn_cancel') }}</button><button @click="saveSettings" class="px-6 py-2 theme-rounded-sm bg-emerald-600 text-white font-bold text-sm shadow-lg hover:bg-emerald-500">{{ t('btn_save') }}</button></div>
            </div>
        </div>
    </transition>

    <!-- Modals (Faction) -->
    <transition name="fade">
        <div v-if="showFactionModal" class="modal-mask" @click.self="closeFactionModal">
            <div role="dialog" aria-label="Edit Entity" class="glass-panel theme-rounded w-[550px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-6 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center">
                    <h3 class="text-xl font-bold">{{ editingFaction.id ? t('modal_edit_entity') : t('modal_new_entity') }}</h3>
                    <button @click="closeFactionModal" class="text-[var(--text-dim)] hover:text-[var(--text-main)] text-xl"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-8 overflow-y-auto max-h-[70vh] space-y-6 bg-[var(--bg-panel)]">
                    <div><label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('label_name') }}</label><input v-model="editingFaction.name" class="w-full input-tech p-3 theme-rounded-sm text-lg font-bold outline-none"></div>
                    
                    <!-- [优化] 父级实体选择 (支持层级缩进显示) -->
                    <div>
                        <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">Parent Entity (Hierarchy)</label>
                        <select v-model="editingFaction.parentId" class="w-full input-tech p-3 theme-rounded-sm text-sm font-mono outline-none">
                            <option value="">-- No Parent (Top Level) --</option>
                            <!-- 使用 sortedPlayers 可以在下拉框中也保持顺序 -->
                            <option v-for="p in sortedPlayers" :key="p.id" :value="p.id" 
                                    v-show="p.id !== editingFaction.id"
                                    :disabled="p._depth >= 2"> <!-- 可选：限制层级深度防止过深 -->
                                <!--利用非换行空格实现视觉缩进-->
                                {{ '&nbsp;&nbsp;'.repeat(p._depth) + (p._depth > 0 ? '└─ ' : '') + p.name }} 
                            </option>
                        </select>
                        <p class="text-[10px] text-[var(--text-dim)] mt-1">
                            <i class="fa-solid fa-info-circle mr-1"></i>
                        </p>
                    </div>
                    <!-- [新增结束] -->

                    <div>
                        <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('label_icon_color') }}</label>
                        <div class="flex gap-4 items-start">
                            <!-- 左侧：预览与上传 -->
                            <div class="flex flex-col items-center gap-2">
                                <!-- 容器改为 20(宽) x 14(高) 约等于 3:2 旗帜比例 -->
                                <div class="w-20 h-14 theme-rounded-sm border border-[var(--border-dim)] bg-[var(--bg-badge)] flex items-center justify-center overflow-hidden relative group cursor-pointer" :style="{ borderColor: editingFaction.color }">
                                    <img v-if="isImage(editingFaction.logo)" :src="editingFaction.logo" class="w-full h-full object-contain">
                                    <i v-else :class="editingFaction.logo || 'fa-solid fa-users'" class="text-2xl" :style="{ color: editingFaction.color }"></i>
                                    
                                    <!-- 悬浮上传遮罩 -->
                                    <label class="absolute inset-0 bg-black/60 flex items-center justify-center opacity-0 group-hover:opacity-100 transition cursor-pointer text-white text-xs font-bold">
                                        UPLOAD
                                        <input type="file" @change="handleFactionImageUpload" class="hidden" accept="image/*">
                                    </label>
                                </div>
                            </div>

                            <!-- 右侧：手动输入与颜色 -->
                            <div class="flex-1 space-y-2">
                                <input v-model="editingFaction.logo" placeholder="fa-class OR data:image..." class="w-full input-tech p-2 theme-rounded-sm text-xs font-mono outline-none text-[var(--text-dim)] truncate">
                                
                                <div class="flex items-center gap-2 bg-[var(--bg-badge)] p-1 theme-rounded-sm border border-[var(--border-dim)]">
                                    <input type="color" v-model="editingFaction.color" class="h-8 w-8 bg-transparent border-none cursor-pointer">
                                    <input v-model="editingFaction.color" class="w-full bg-transparent text-xs font-mono uppercase outline-none text-[var(--text-dim)]">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div><label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('label_desc') }}</label><textarea v-model="editingFaction.desc" class="w-full h-24 input-tech p-3 theme-rounded-sm text-sm resize-none outline-none"></textarea></div>
                    
                    <div class="pt-4 border-t border-[var(--border-dim)]">
                        <div class="flex justify-between items-center mb-4">
                             <label class="block text-xs font-bold text-amber-500 uppercase">{{ t('label_stats') }}</label>
                             <!-- [新增] 实体类型选择器 -->
                             <div class="flex items-center gap-2">
                                 <span class="text-[10px] text-[var(--text-dim)] uppercase">Type:</span>
                                 <select v-model="editingFaction.schemaId" class="bg-[var(--bg-badge)] border border-[var(--border-dim)] text-[10px] theme-rounded-sm p-1 text-[var(--text-main)] outline-none">
                                     <option v-for="rs in rule_sets" :key="rs.id" :value="rs.id">{{ rs.name }}</option>
                                 </select>
                             </div>
                        </div>
                        
                        <!-- [修改] 遍历当前实体所选规则集的字段 -->
                        <div class="grid grid-cols-2 gap-4 p-4 bg-[var(--bg-badge)] theme-rounded-sm border border-[var(--border-dim)]">
                            <div v-for="field in getFieldsBySchemaId(editingFaction.schemaId)" :key="field.key">
                                <label class="block text-[10px] text-[var(--text-dim)] font-bold mb-1">{{ field.label }} <span class="opacity-30 font-mono">({{ field.key }})</span></label>
                                <input v-model="editingFaction.stats[field.key]" class="w-full input-tech p-2 theme-rounded-sm text-emerald-400 font-mono-tech font-bold text-sm outline-none border-b-2 border-transparent focus:border-amber-500 transition">
                            </div>
                            <div v-if="getFieldsBySchemaId(editingFaction.schemaId).length === 0" class="col-span-2 text-center text-[var(--text-dim)] text-xs py-2">
                                No attributes defined for this type.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center">
                    <button v-if="editingFaction.id" @click="deleteFaction" class="text-red-500 font-bold text-sm hover:text-red-400"><i class="fa-solid fa-trash mr-2"></i>{{ t('btn_destroy') }}</button><div v-else></div>
                    <div class="flex gap-4"><button @click="closeFactionModal" class="px-5 py-2 theme-rounded-sm bg-[var(--bg-badge)] text-[var(--text-dim)] font-bold text-sm hover:text-[var(--text-main)]">{{ t('btn_cancel') }}</button><button @click="saveFaction" class="px-6 py-2 theme-rounded-sm bg-indigo-600 text-white font-bold text-sm shadow-lg hover:bg-indigo-500">{{ t('btn_confirm') }}</button></div>
                </div>
            </div>
        </div>
    </transition>

    <!-- Modals (Save/Load) -->
    <transition name="fade">
        <div v-if="showSaveLoadModal" class="modal-mask" @click.self="showSaveLoadModal = false">
            <div class="glass-panel theme-rounded w-[550px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-6 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center">
                    <h3 class="text-xl font-bold"><i class="fa-solid fa-hard-drive mr-2 text-indigo-400"></i>{{ t('modal_files') }}</h3>
                    <button @click="showSaveLoadModal = false" class="text-[var(--text-dim)] hover:text-[var(--text-main)] text-xl"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-8 bg-[var(--bg-panel)]">
                    <div class="mb-6"><label class="block text-sm font-bold text-[var(--text-dim)] mb-3">{{ t('label_save_as') }}</label><div class="flex gap-3"><input v-model="newSaveFilename" @keyup.enter="saveGame(newSaveFilename)" placeholder="Filename..." class="flex-1 input-tech p-3 theme-rounded-sm text-sm font-mono outline-none"><button @click="saveGame(newSaveFilename)" :disabled="!newSaveFilename.trim()" class="px-6 py-2 bg-indigo-600 text-white theme-rounded-sm font-bold text-sm hover:bg-indigo-500 disabled:opacity-50">{{ t('btn_save') }}</button></div></div>
                    <div class="border-t border-[var(--border-dim)] pt-6">
                        <label class="block text-sm font-bold text-[var(--text-dim)] mb-3">{{ t('label_local_files') }}</label>
                        <div class="max-h-[40vh] overflow-y-auto space-y-2 pr-2">
                            <div v-for="file in saveFiles" :key="file" class="flex justify-between items-center bg-[var(--bg-badge)] p-3 theme-rounded-sm border border-[var(--border-dim)] hover:border-[var(--text-dim)] group">
                                <span class="font-mono text-sm text-emerald-400 font-bold"><i class="fa-solid fa-file-code mr-3 opacity-50"></i>{{ file }}</span>
                                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition"><button @click="loadGame(file)" class="px-3 py-1 bg-emerald-700 text-white theme-rounded-sm text-xs font-bold hover:bg-emerald-600">{{ t('btn_load') }}</button><button @click="saveGame(file)" class="px-3 py-1 bg-amber-700 text-white theme-rounded-sm text-xs font-bold hover:bg-amber-600">{{ t('btn_overwrite') }}</button><button @click="deleteSave(file)" class="px-3 py-1 bg-red-800 text-white theme-rounded-sm text-xs hover:bg-red-700"><i class="fa-solid fa-trash"></i></button></div>
                            </div>
                            <div v-if="saveFiles.length===0" class="text-center text-[var(--text-dim)] italic p-4">{{ t('msg_no_files') }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <!-- Modals (Script Gen) -->
<!-- Modals (Map Pin Editor) -->
    <transition name="fade">
        <div v-if="showPinModal" class="modal-mask" @click.self="showPinModal = false">
            <div role="dialog" aria-label="Map Editor" class="glass-panel theme-rounded w-[450px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <!-- 1. 顶部标题栏 -->
                <div class="p-4 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center shrink-0">
                    <h3 class="text-lg font-bold flex items-center gap-2">
                        <i v-if="editingRegionIndex !== -2" class="fa-solid fa-map text-emerald-500"></i>
                        <i v-else class="fa-solid fa-map-pin text-amber-500"></i>
                        {{ editingRegionIndex !== -2 ? (editingRegionIndex === -1 ? t('map_new_terr') : t('map_edit_terr')) : (editingPinIndex === -1 ? t('map_add_pin') : t('map_edit_pin')) }}
                    </h3>
                    <button @click="showPinModal = false" class="text-[var(--text-dim)] hover:text-[var(--text-main)] transition"><i class="fa-solid fa-times"></i></button>
                </div>
                
                <div class="p-6 bg-[var(--bg-panel)] overflow-y-auto max-h-[75vh] space-y-5">
                    
                    <!-- 分支 A: 地块 (Region) 编辑模式 -->
                    <div v-if="editingRegionIndex !== -2" class="space-y-4">
                        <div class="p-3 bg-[var(--bg-badge)] theme-rounded-sm border border-[var(--border-dim)] relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-2 opacity-10"><i class="fa-solid fa-earth-americas text-4xl"></i></div>
                            <div class="text-[10px] text-emerald-500 font-bold uppercase tracking-widest mb-3 relative z-10">
                                <i class="fa-solid fa-flag mr-1"></i> {{ t('map_geo_title') }}
                            </div>

                            <!-- A1. 地理名称 (Name) -->
                            <div class="mb-3 relative z-10">
                                <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-1">{{ t('label_geo_name') }}</label>
                                <input v-model="pinForm.customLabel" placeholder="e.g. Normandy / 铁血峡谷" 
                                       class="w-full input-tech p-2 theme-rounded-sm text-sm font-bold text-[var(--text-main)] outline-none border-l-4 border-[var(--border-dim)] focus:border-emerald-500 transition">
                                <p class="text-[9px] text-[var(--text-dim)] mt-1 opacity-70">{{ t('hint_geo_name') }}</p>
                            </div>

                            <!-- A2. 当前控制权 (Owner) -->
                            <div class="relative z-10">
                                <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-1">{{ t('label_controller') }}</label>
                                <div class="flex items-center gap-2">
                                    <select v-model="pinForm.selectedId" class="flex-1 input-tech p-2 theme-rounded-sm text-sm font-mono font-bold outline-none border-l-4 transition"
                                            :style="{ borderLeftColor: pinForm.selectedId ? getFactionColor(pinForm.selectedId) : 'var(--border-dim)' }">
                                        <option value="">{{ t('opt_neutral') }}</option>
                                        <option v-for="p in players" :key="p.id" :value="p.id">
                                            {{ p.name }}
                                        </option>
                                    </select>
                                    <div v-if="pinForm.selectedId" class="w-8 h-8 theme-rounded-sm shadow-inner flex items-center justify-center border border-[var(--border-dim)]" :style="{ backgroundColor: getFactionColor(pinForm.selectedId) }">
                                        <i :class="getFactionLogo(pinForm.selectedId)" class="text-white text-xs drop-shadow-md"></i>
                                    </div>
                                </div>
                                <p class="text-[9px] text-[var(--text-dim)] mt-1 opacity-70">{{ t('hint_controller') }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- 分支 B: 普通点 (Pin) 编辑模式 -->
                    <div v-else class="space-y-4">
                        <!-- 模式切换 Tabs -->
                        <div>
                            <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('label_marker_type') }}</label>
                            <div class="flex bg-[var(--bg-badge)] theme-rounded-sm p-1 border border-[var(--border-dim)]">
                                <button @click="pinForm.mode = 'entity'" :class="pinForm.mode === 'entity' ? 'bg-indigo-600 text-white shadow' : 'text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="flex-1 py-1.5 text-xs font-bold theme-rounded-sm transition">{{ t('btn_type_entity') }}</button>
                                <button @click="pinForm.mode = 'lore'" :class="pinForm.mode === 'lore' ? 'bg-emerald-600 text-white shadow' : 'text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="flex-1 py-1.5 text-xs font-bold theme-rounded-sm transition">{{ t('btn_type_lore') }}</button>
                                <button @click="pinForm.mode = 'custom'" :class="pinForm.mode === 'custom' ? 'bg-amber-600 text-white shadow' : 'text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="flex-1 py-1.5 text-xs font-bold theme-rounded-sm transition">{{ t('btn_type_custom') }}</button>
                            </div>
                        </div>

                        <!-- 选项 B1: 实体选择 -->
                        <div v-if="pinForm.mode === 'entity'">
                            <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('label_select_entity') }}</label>
                            <select v-model="pinForm.selectedId" class="w-full input-tech p-2 theme-rounded-sm text-sm font-bold outline-none">
                                <option value="" disabled>{{ t('opt_choose_entity') }}</option>
                                <option v-for="p in players" :key="p.id" :value="p.id">{{ p.name }}</option>
                            </select>
                        </div>

                        <!-- 选项 B2: 资料选择 -->
                        <div v-if="pinForm.mode === 'lore'">
                            <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('label_select_lore') }}</label>
                            <select v-model="pinForm.selectedId" class="w-full input-tech p-2 theme-rounded-sm text-sm font-bold outline-none">
                                <option value="" disabled>{{ t('opt_choose_lore') }}</option>
                                <option v-for="(entry, idx) in lorebook" :key="idx" :value="entry.keys">{{ entry.keys }}</option>
                            </select>
                            <p class="text-[10px] text-[var(--text-dim)] mt-1">{{ t('hint_lore_link') }}</p>
                        </div>

                        <!-- 选项 B3: 自定义 -->
                        <div v-if="pinForm.mode === 'custom'">
                            <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('label_custom_label') }}</label>
                            <input v-model="pinForm.customLabel" placeholder="e.g. Ruined Tower" class="w-full input-tech p-2 theme-rounded-sm text-sm font-bold outline-none" @keyup.enter="saveMapPin">
                        </div>
                    </div>

                    <!-- 通用部分: 外观与坐标微调 -->
                    
                    <!-- 1. 图标与颜色 -->
                    <div class="pt-4 border-t border-[var(--border-dim)]">
                        <div class="flex justify-between items-center mb-2 cursor-pointer group" @click="pinForm.showAppearance = !pinForm.showAppearance">
                             <label class="text-xs font-bold text-[var(--text-dim)] uppercase group-hover:text-[var(--text-main)] transition">
                                {{ t('label_appearance') }} <i class="fa-solid fa-chevron-down text-[10px] ml-1 opacity-50"></i>
                             </label>
                        </div>
                        
                        <div v-show="editingRegionIndex === -2 || pinForm.showAppearance" class="grid grid-cols-2 gap-4 bg-[var(--bg-badge)] p-3 theme-rounded-sm border border-[var(--border-dim)]">
                            <div>
                                <label class="block text-[10px] font-bold text-[var(--text-dim)] mb-1">{{ t('label_icon_class') }}</label>
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 flex items-center justify-center bg-[var(--bg-panel)] theme-rounded-sm border border-[var(--border-dim)] shrink-0">
                                        <i :class="pinForm.icon || 'fa-solid fa-question'" :style="{color: pinForm.color}"></i>
                                    </div>
                                    <input v-model="pinForm.icon" placeholder="fa-..." class="w-full input-tech p-1.5 theme-rounded-sm text-[10px] font-mono outline-none">
                                </div>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-[var(--text-dim)] mb-1">{{ t('label_custom_color') }}</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" v-model="pinForm.color" class="h-8 w-8 bg-transparent border-none cursor-pointer shrink-0">
                                    <input v-model="pinForm.color" class="w-full input-tech p-1.5 theme-rounded-sm text-[10px] font-mono outline-none uppercase">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. 坐标微调 -->
                    <div class="pt-4 border-t border-[var(--border-dim)]">
                        <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">
                            {{ editingRegionIndex !== -2 ? t('label_pos_region') : t('label_pos_pin') }}
                        </label>
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <label class="text-[9px] text-[var(--text-dim)] font-mono">POS X (%)</label>
                                <div class="flex items-center gap-1">
                                    <input v-if="editingRegionIndex !== -2" type="number" step="0.5" v-model="pinForm.centerX" class="w-full input-tech p-2 theme-rounded-sm text-xs font-mono outline-none text-center">
                                    <input v-else type="number" step="0.5" v-model="pinForm.x" class="w-full input-tech p-2 theme-rounded-sm text-xs font-mono outline-none text-center">
                                </div>
                            </div>
                            <div class="flex-1">
                                <label class="text-[9px] text-[var(--text-dim)] font-mono">POS Y (%)</label>
                                <div class="flex items-center gap-1">
                                    <input v-if="editingRegionIndex !== -2" type="number" step="0.5" v-model="pinForm.centerY" class="w-full input-tech p-2 theme-rounded-sm text-xs font-mono outline-none text-center">
                                    <input v-else type="number" step="0.5" v-model="pinForm.y" class="w-full input-tech p-2 theme-rounded-sm text-xs font-mono outline-none text-center">
                                </div>
                            </div>
                        </div>
                        <p class="text-[9px] text-emerald-500 mt-2 opacity-70">
                            <i class="fa-solid fa-circle-info mr-1"></i>
                            {{ editingRegionIndex !== -2 ? t('hint_pos_region') : t('hint_pos_pin') }}
                        </p>
                    </div>

                </div>

                <!-- 底部按钮 -->
                <div class="p-4 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between shrink-0">
                    <button v-if="editingPinIndex !== -1 || (editingRegionIndex !== -2 && editingRegionIndex !== -1)" 
                            @click="deleteMapPin" 
                            class="text-red-500 hover:text-red-400 text-xs font-bold px-3 py-2 border border-red-900/30 theme-rounded-sm bg-red-900/10 transition">
                        <i class="fa-solid fa-trash mr-1"></i> {{ t('btn_remove') }}
                    </button>
                    <div v-else></div> 

                    <div class="flex gap-2">
                        <button @click="showPinModal = false" class="px-4 py-2 theme-rounded-sm border border-[var(--border-dim)] text-xs font-bold hover:bg-[var(--bg-panel)] transition text-[var(--text-dim)] hover:text-[var(--text-main)]">{{ t('btn_cancel') }}</button>
                        <button @click="saveMapPin" class="px-6 py-2 theme-rounded-sm bg-emerald-600 text-white text-xs font-bold shadow-lg hover:bg-emerald-500 transition">{{ t('btn_confirm') }}</button>
                    </div>
                </div>
            </div>
        </div>
    </transition>
    <transition name="fade">
        <div v-if="showScriptGenModal" class="modal-mask" @click.self="showScriptGenModal = false">
            <div class="glass-panel theme-rounded w-[600px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-6 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center"><h3 class="text-xl font-bold">{{ t('modal_script_gen') }}</h3><button @click="showScriptGenModal = false" class="text-[var(--text-dim)] hover:text-[var(--text-main)]"><i class="fa-solid fa-times"></i></button></div>
                <div class="p-8 bg-[var(--bg-panel)] gap-4 flex flex-col max-h-[70vh] overflow-y-auto">
                    <p class="text-sm text-[var(--text-dim)] bg-[var(--bg-badge)] p-4 theme-rounded-sm border border-[var(--border-dim)]">{{ t('msg_script_gen_hint') }}</p>
                    
                    <!-- 文件上传区域 -->
                    <div class="border-2 border-dashed border-[var(--border-dim)] theme-rounded-sm p-4 hover:border-indigo-500/50 transition bg-[var(--bg-badge)]">
                        <label class="cursor-pointer flex flex-col items-center justify-center gap-2">
                            <i class="fa-solid fa-cloud-arrow-up text-2xl text-[var(--text-dim)]"></i>
                            <span class="text-xs font-bold text-[var(--text-dim)] uppercase tracking-wide">{{ t('label_upload_ref') }}</span>
                            <input type="file" multiple @change="handleScriptFiles" class="hidden" accept=".txt,.md,.json,.png,.jpg,.jpeg">
                        </label>
                        <div v-if="scriptAttachments.length > 0" class="mt-3 grid grid-cols-2 gap-2">
                            <div v-for="(file, idx) in scriptAttachments" :key="idx" class="text-[10px] bg-[var(--bg-deep)] p-2 border border-[var(--border-dim)] truncate flex justify-between items-center text-[var(--text-main)]">
                                <span><i :class="file.type.includes('image') ? 'fa-regular fa-image' : 'fa-regular fa-file-lines'" class="mr-1"></i>{{ file.name }}</span>
                                <button @click="scriptAttachments.splice(idx,1)" class="text-red-400 hover:text-red-300"><i class="fa-solid fa-times"></i></button>
                            </div>
                        </div>
                    </div>

                    <textarea v-model="scriptGenPrompt" class="w-full h-32 input-tech p-4 theme-rounded-sm text-base resize-none outline-none" placeholder="t('placeholder_prompt')"></textarea>
                </div>
                <div class="p-6 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-end">
                    <button @click="generateScript" :disabled="isThinking || !scriptGenPrompt.trim()" class="w-full py-4 theme-rounded-sm bg-gradient-to-r from-indigo-600 to-indigo-700 text-white font-bold text-lg tracking-widest shadow-lg hover:from-indigo-500 hover:to-indigo-600 flex justify-center items-center gap-3 disabled:opacity-50"><i :class="isThinking ? 'fa-solid fa-circle-notch fa-spin' : 'fa-solid fa-meteor'"></i> {{ isThinking ? t('status_generating') : t('btn_start_gen') }}</button>
                </div>
            </div>
        </div>
    </transition>
</div>

<script>
    const { createApp } = Vue;
    const API_BASE = "http://127.0.0.1:8000";

    createApp({
        data() {
            return {
                serverConnected: false, isThinking: false, currentSaveFile: 'savegame.json',
                showSettings: false, showFactionModal: false, showSaveLoadModal: false, showScriptGenModal: false, showContextModal: false,
                saveFiles: [], newSaveFilename: '', 
                mapToolMode: 'view',
                // [新增] 安科模式开关
                generateOptions: false,
                // --- 输入相关 ---
                scriptGenPrompt: '',
                rawInput: '',
                godModeInput: '', // [新增] 上帝模式输入
                scriptAttachments: [], // [新增] 剧本生成附件列表
                
                editingFaction: { id: '', name: '', logo: '', stats: {} },
                editingTurnId: null, editingEventId: null,
                tabs: { left: 'players', right: 'input' },
                // [新增] 战斗表单数据
                combatForm: {
                    attackerId: '',
                    defenderId: '',
                    context: '',
                    locationId: '', // [新增] 战斗地点 ID
                    // [新增] 骰子池：默认先给一个 D20
                    dicePool: [
                        { type: 'd20', val: null, label: '' } 
                    ] 
                },
                isRollingDice: false,
                // [新增] 截图模式状态
                isScreenshotMode: false,
                screenshotRect: { x: 0, y: 0, w: 0, h: 0 },
                screenshotTarget: null, // 当前吸附的 DOM 元素
                screenshotTargetName: '', // 显示组件名称
                // [新增] 地图打点模态框状态
                showPinModal: false,
                editingPinIndex: -1, // -1 表示新建，>=0 表示编辑索引
                pinForm: {
                    x: 0, y: 0,
                    mode: 'entity', // entity | lore | custom
                    selectedId: '', // 用于 entity id 或 lore keys
                    customLabel: ''
                },
                
                // --- UI Settings ---
                ui: { theme: 'terminal', lang: 'zh' },
                
                // [新增] 用于设置面板切换 Prompt 标签页
                settingsPromptTab: 'system', 

                settings: {
                    api: { provider: 'Gemini', baseUrl: '', model: 'gemini-2.5-flash', key: '' },
                    proxy: { enabled: true, port: '7890' }, 
                    prompts: {
                        // --- 1. 日常推演 (Daily Deduction) - v3 多层级/多规则版 ---
                        system: `你是一个辅助世界推演的 AI 引擎。
                        【任务】
                        根据“世界上下文”和“用户指令”，推演下一阶段事件并以 JSON 格式输出。

                        【核心原则】
                        1. **层级联动**：子实体(Child)的变动会波及父实体(Parent)；父实体的决策会限制子实体。
                        2. **规则一致性**：修改属性(attrKey)时，必须符合该实体 schemaId 对应的规则集定义。
                        3. **JSON 完整性**：**必须确保 JSON 格式极其严谨，所有大括号 {} 和中括号 [] 必须成对闭合，严禁截断！**

                        【输出格式规范】
                        1. **纯 JSON**：直接输出 JSON 字符串，不要包含 \`\`\`json 标记。
                        2. **文本要求**：中文描述。content > 100字。stats 属性值优先使用描述性文本(如"动荡"而非"30")。
                        3. **数据一致性**：oldValue 必须等于当前值。

                        【特殊 Impact 事件类型】
                        A. REGION_TRANSFER: { "targetName": "地块名", "newValue": "新领主ID" }
                        B. ENTITY_CREATE:   { "data": { "name": "...", "parentId": "...", "schemaId": "..." } }
                        C. ENTITY_REMOVE:   { "targetId": "..." }
                        D. PIN_MOVE:        { "targetId": "...", "newValue": "x,y" }
                        E. GLOBAL MOD:      { "type": "STAT_CHANGE", "targetId": "global", ... }

                        【分支选项 (OPTIONS) - 仅在被要求时生成】
                        - **结构必须为对象数组**：[ { "label": "...", "desc": "..." }, ... ]
                        - **字段定义**：
                        * "label": 4-8字短标题 (如"正面强攻")。
                        * "desc": 详细后果预估。
                        - **严禁**使用纯字符串数组！

                        【标准 JSON 响应模板】
                        {
                        "factionId": "行动方ID (如 p_empire)",
                        "timeStart": "时间段开始",
                        "timeEnd": "时间段结束",
                        "summary": "简短标题",
                        "content": "详细剧情描述...",
                        
                        // [可选] 仅在用户明确要求生成选项(Anko模式)时才包含此字段
                        "options": [
                            { "label": "外交斡旋", "desc": "尝试通过谈判解决争端，消耗资金但避免伤亡。" },
                            { "label": "武力镇压", "desc": "调动近卫军进行清洗，虽然高效但会大幅降低稳定度。" },
                            { "label": "静观其变", "desc": "暂时不采取行动，观察局势变化，风险较低。" }
                        ],

                        "impacts": [
                            {
                            "type": "STAT_CHANGE",
                            "targetId": "p_target_id",
                            "attrKey": "stability",
                            "oldValue": "稳固",
                            "newValue": "动荡"
                            },
                            {
                            "type": "REGION_TRANSFER",
                            "targetName": "诺曼底",
                            "newValue": "p_new_owner"
                            }
                        ]
                        }`,

                        // --- 2. 剧本生成 (Script Generator) - v5 树状结构版 ---
                        script_generator: `你是一个世界设定生成器，严格按照指定的 JSON 结构输出。

                    【任务目标】
                    构建一个具有**深度层级结构**和**多样化实体类型**的世界。

                    【关键指令】
                    1. **多重规则集 (Rule Sets)**：不要只使用一套通用属性。请定义至少 2-3 套不同的规则集（rule_sets）。例如：
                       - "国家规则" (包含: 稳定度, 经济, 外交立场)
                       - "城市/行省规则" (包含: 治安, 人口, 归属感)
                       - "关键角色规则" (包含: 影响力, 忠诚, 个人战力)
                    2. **层级结构 (Hierarchy)**：利用 "parentId" 字段构建树状关系。不要只生成一堆顶级势力。
                       - 例如：创建一个“帝国”作为顶级节点，然后创建几个“行省”或“军团”作为其子节点（parentId 指向帝国）。
                    3. **关联性**：确保每个 player 的 "schemaId" 对应正确的 rule_sets id。

                    【输出规则】
                    1. **只输出纯 JSON**：单一、合法的 JSON 对象，无Markdown。
                    2. **严格遵守结构**：参照下方的【JSON 结构范例】。
                    3. **语言与篇幅**：中文描述。Timeline 中的 event content 必须超过 100 字。
                    4. **属性值**：使用 8 字以内的描述性文本（如“动荡(D)”、“繁荣”）而非纯数字。

                    【JSON 结构与范例】
                    {
                    "rule_sets": [
                        {
                            "id": "rs_nation",
                            "name": "国家政体",
                            "fields": [
                                { "key": "gov_type", "label": "政体" },
                                { "key": "stability", "label": "稳定度" }
                            ]
                        },
                        {
                            "id": "rs_hero",
                            "name": "英雄单位",
                            "fields": [
                                { "key": "class", "label": "职阶" },
                                { "key": "loyalty", "label": "忠诚" }
                            ]
                        }
                    ],
                    "global_vars": [
                        { "key": "当前纪元", "value": "第四纪元" }
                    ],
                    "lorebook": [
                        {
                        "keys": "源石,Originium", 
                        "content": "一种黑色的结晶矿物...",
                        "mode": "auto"
                        }
                    ],
                    "players": [
                        {
                        "id": "p_empire",
                        "name": "乌萨斯帝国",
                        "logo": "fa-solid fa-crown",
                        "color": "#881c1c",
                        "desc": "以军事立国的庞大帝国。",
                        "parentId": "", 
                        "schemaId": "rs_nation",
                        "stats": {
                            "gov_type": "君主专制",
                            "stability": "高压统治"
                        }
                        },
                        {
                        "id": "p_patriot",
                        "name": "爱国者",
                        "logo": "fa-solid fa-shield-halved",
                        "color": "#555555",
                        "desc": "帝国的传奇将领。",
                        "parentId": "p_empire",
                        "schemaId": "rs_hero",
                        "stats": {
                            "class": "重装盾卫",
                            "loyalty": "死忠"
                        }
                        }
                    ],
                    "timeline": [
                        {
                        "id": 1,
                        "timeRange": "1096年 冬",
                        "events": [
                            {
                            "factionId": "p_empire",
                            "timeStart": "冬初",
                            "timeEnd": "冬末",
                            "summary": "大叛乱的前兆",
                            "content": "（此处生成超过 100 字的详细描述，描述帝国与其下属将领之间的互动...）",
                            "impacts": [
                                {
                                "targetId": "p_patriot",
                                "targetName": "爱国者",
                                "attrKey": "loyalty",
                                "attrLabel": "忠诚",
                                "newValue": "动摇"
                                }
                            ]
                            }
                        ]
                        }
                    ]
                    }`,

                        // --- 3. 上帝模式 (God Mode) - v3 兼容多规则版 ---
                        god_mode: `你是一个智能数据库管理员，能够理解并执行对 JSON 数据的关联修改。

                        【核心指令】
                        根据用户的自然语言指令，修改当前的 JSON 状态。你必须返回一个包含所有被修改的顶层字段的 JSON 对象。

                        【关键规则：多规则集与层级】
                        1. **修改规则集 (Rule Sets)**：
                           - 用户可能会说“给所有国家增加人口属性”。你需要找到 \`rule_sets\` 中代表“国家”的那个对象，在它的 \`fields\` 中添加新字段。
                           - 如果用户要求创建一种新类型的实体（如“创造一个神器类型”），你需要向 \`rule_sets\` 数组添加一个新对象。
                        2. **数据一致性**：
                           - 当你在规则集中添加了新属性（如 "mana"），请尝试智能地更新所有使用该规则集 ("schemaId") 的实体的 \`stats\`，给它们一个默认值。

                        【严重警告：数组完整性】
                        当你修改任何数组（如 \`players\`, \`rule_sets\`）时，**必须返回该数组的完整内容**（包括未修改的项），否则数据会丢失。

                        【输出规则】
                        1. **只输出纯 JSON**。
                        2. 仅返回被修改的顶层字段。

                        【示例】
                        用户指令: "给所有属于'英雄'规则的实体增加'魔法值(mp)'，默认为0"
                        正确输出:
                        {
                        "rule_sets": [
                            { 
                                "id": "rs_nation", ... 
                            }, 
                            { 
                                "id": "rs_hero", 
                                "name": "英雄", 
                                "fields": [
                                    { "key": "hp", "label": "生命" },
                                    { "key": "mp", "label": "魔法值" } // ★ 新增字段
                                ]
                            }
                        ],
                        "players": [
                            { 
                            "id": "p_arthur", 
                            "schemaId": "rs_hero", // 匹配到了规则集
                            "stats": { 
                                "hp": "100", 
                                "mp": "0" // ★ 自动填充默认值
                            } 
                            },
                            { 
                            "id": "p_england", 
                            "schemaId": "rs_nation", 
                            "stats": { ... } // 未受影响
                            }
                        ]
                        }`
                    }
                },
                
                // --- i18n Dictionary ---
                translations: {
                    app_title: { zh: "LEVANT 自动化推演", en: "LEVANT Auto-Deduction", ja: "LEVANT 自動演繹" },
                    status_online: { zh: "系统联机", en: "SYSTEM ONLINE", ja: "システム稼働中" },
                    status_offline: { zh: "离线模式", en: "OFFLINE MODE", ja: "オフライン" },
                    next_turn_label: { zh: "下一回合 / 序列", en: "NEXT TURN / SEQ", ja: "次のターン / シーケンス" },
                    auto: { zh: "自动", en: "AUTO", ja: "自動" },
                    btn_script_gen: { zh: "剧本生成", en: "Script Gen", ja: "シナリオ生成" },
                    btn_files: { zh: "档案管理", en: "Files", ja: "ファイル管理" },
                    tab_world: { zh: "世界", en: "World", ja: "世界" },
                    tab_entity: { zh: "实体", en: "Entities", ja: "実体" },
                    tab_lore: { zh: "资料", en: "Lore", ja: "資料" },
                    tab_rules: { zh: "规则", en: "Rules", ja: "ルール" },
                    btn_add_global: { zh: "添加全局状态", en: "Add Global Var", ja: "グローバル変数を追加" },
                    btn_new_entity: { zh: "注册新实体", en: "New Entity", ja: "新規実体登録" },
                    btn_add_lore: { zh: "新增资料条目", en: "Add Lore Entry", ja: "資料エントリ追加" },
                    btn_export_rules: { zh: "导出规则海报", en: "Export Rules", ja: "ルール出力" },
                    btn_add_rule: { zh: "添加属性字段", en: "Add Attribute", ja: "属性フィールド追加" },
                    msg_no_events: { zh: "等待情报输入...", en: "Awaiting Intelligence...", ja: "情報入力待ち..." },
                    btn_copy: { zh: "复制", en: "Copy", ja: "コピー" },
                    btn_delete: { zh: "删除", en: "Delete", ja: "削除" },
                    tab_pending: { zh: "待决", en: "Pending", ja: "保留中" },
                    tab_console: { zh: "指令台", en: "Console", ja: "コンソール" },
                    tab_godmode: { zh: "上帝模式", en: "God Mode", ja: "神モード" },
                    msg_empty_queue: { zh: "队列为空", en: "Queue Empty", ja: "キューが空です" },
                    placeholder_input: { zh: "// 输入原始指令...\n例如: #Cortex 试图入侵 #NeoTokyo", en: "// Input raw command...\ne.g., #Cortex attempts to hack #NeoTokyo", ja: "// コマンドを入力...\n例: #Cortex が #NeoTokyo に侵入を試みる" },
                    ai_core_label: { zh: "AI 智能核心 (Active)", en: "AI CORE (Active)", ja: "AI コア (稼働中)" },
                    btn_ai_deduce: { zh: "AI 智能补全 / 推演", en: "AI DEDUCTION / AUTO-COMPLETE", ja: "AI 自動補完 / 演繹" },
                    status_thinking: { zh: "正在进行战术推演...", en: "Calculating Strategy...", ja: "戦術演算中..." },
                    label_actor: { zh: "行动实体", en: "Actor", ja: "行動主体" },
                    label_start: { zh: "开始", en: "Start", ja: "開始" },
                    label_end: { zh: "结束", en: "End", ja: "終了" },
                    option_ai_auto: { zh: "AI 自动判断", en: "AI Auto-Detect", ja: "AI 自動判定" },
                    option_global: { zh: "全局事件", en: "Global Event", ja: "グローバルイベント" },
                    label_summary: { zh: "标题摘要", en: "Summary", ja: "要約" },
                    label_impact: { zh: "状态变更计算", en: "State Impact Calc", ja: "状態変化計算" },
                    label_details: { zh: "详细情报档案", en: "Detailed Intelligence", ja: "詳細情報アーカイブ" },
                    btn_add_pending: { zh: "加入待决序列", en: "Add to Pending", ja: "保留リストに追加" },
                    btn_commit: { zh: "执行推演 (Commit)", en: "COMMIT TURN", ja: "ターン実行 (Commit)" },
                    modal_context_title: { zh: "上下文装配与推演", en: "Context Assembler", ja: "コンテキストアセンブラ" },
                    modal_context_subtitle: { zh: "确认 AI 将接收到的“世界切片”以及“当前指令”。", en: "Confirm the 'World Slice' and 'Action' sent to AI.", ja: "AIに送信する「世界スライス」と「現在指令」を確認してください。" },
                    ctx_current: { zh: "当前指令与草稿", en: "Current Action", ja: "現在の指令" },
                    ctx_global: { zh: "世界全局变量", en: "Global Vars", ja: "グローバル変数" },
                    ctx_rules: { zh: "属性规则定义", en: "Stat Rules", ja: "属性ルール" },
                    ctx_lore: { zh: "资料设定 (Lore)", en: "Lore Entries", ja: "資料設定" },
                    ctx_entities: { zh: "参与实体", en: "Active Entities", ja: "参加実体" },
                    ctx_hist_deep: { zh: "深层记忆 (近 - 含详情)", en: "Deep Mem (Recent - Full)", ja: "深層記憶 (詳細)" },
                    ctx_hist_shallow: { zh: "浅层记忆 (远 - 仅摘要)", en: "Shallow Mem (Older - Summary)", ja: "浅層記憶 (要約)" },
                    ctx_preview_label: { zh: "Payload 预览 (AI 可见内容)", en: "Payload Preview (What AI Sees)", ja: "ペイロードプレビュー" }, // 新增
                    ctx_preview_hint: { zh: "AI 将基于以上预览内容进行生成。", en: "AI will generate based on the preview content.", ja: "AIは上記に基づいて生成します。" }, // 新增
                    btn_execute: { zh: "执行", en: "EXECUTE", ja: "実行" }, // 新增
                    settings_title: { zh: "系统配置", en: "System Settings", ja: "システム設定" },
                    settings_ui: { zh: "界面与语言", en: "Interface & Language", ja: "UIと言語" },
                    settings_theme: { zh: "界面风格", en: "Theme", ja: "テーマ" },
                    settings_lang: { zh: "系统语言", en: "Language", ja: "言語" },
                    btn_cancel: { zh: "取消", en: "Cancel", ja: "キャンセル" },
                    btn_save: { zh: "保存配置", en: "Save Config", ja: "設定保存" },
                    modal_edit_entity: { zh: "编辑实体档案", en: "Edit Entity", ja: "実体編集" },
                    modal_new_entity: { zh: "注册新实体", en: "Register Entity", ja: "新規実体登録" },
                    label_name: { zh: "名称", en: "Name", ja: "名称" },
                    label_icon_color: { zh: "图标 & 颜色", en: "Icon & Color", ja: "アイコン & 色" },
                    label_desc: { zh: "描述", en: "Description", ja: "説明" },
                    label_stats: { zh: "属性面板", en: "Stats", ja: "ステータス" },
                    btn_destroy: { zh: "销毁数据", en: "Destroy Data", ja: "データ破棄" },
                    btn_confirm: { zh: "确认", en: "Confirm", ja: "確認" },
                    modal_files: { zh: "档案管理", en: "File Management", ja: "ファイル管理" },
                    label_save_as: { zh: "另存为", en: "Save As", ja: "名前を付けて保存" },
                    label_local_files: { zh: "本地档案", en: "Local Files", ja: "ローカルファイル" },
                    btn_load: { zh: "读取", en: "Load", ja: "読込" },
                    btn_overwrite: { zh: "覆盖", en: "Overwrite", ja: "上書" },
                    msg_no_files: { zh: "无存档", en: "No Files", ja: "ファイルなし" },
                    modal_script_gen: { zh: "AI 剧本生成", en: "AI Script Generation", ja: "AI シナリオ生成" },
                    msg_script_gen_hint: { zh: "上传设定集、地图图片或描述您想要的世界观。AI 将自动生成实体、属性规则和开场。", en: "Upload lore, maps, or describe your world. AI will generate entities, rules, and intro.", ja: "設定資料、地図をアップロード、または世界観を記述。AIが実体、ルール、オープニングを生成します。" },
                    label_upload_ref: { zh: "上传参考文档 / 图片", en: "Upload Reference Docs / Images", ja: "参考資料/画像をアップロード" }, // 新增
                    placeholder_prompt: { zh: "提示词 (例如: '一个魔法吞噬灵魂的黑暗奇幻世界...')", en: "Prompt (e.g., 'A grimdark fantasy world...')", ja: "プロンプト (例: '魔法が魂を食らうダークファンタジー世界...')" }, // 新增
                    status_generating: { zh: "正在构建世界...", en: "Constructing World...", ja: "世界構築中..." },
                    btn_start_gen: { zh: "初始化剧本生成", en: "Initialize Generation", ja: "生成開始" },
                    
                    // --- 侧边栏 ---
                    header_global_vars: { zh: "全局变量控制", en: "Global Variables", ja: "グローバル変数" },

                    // --- 地图工具栏 ---
                    view_timeline: { zh: "时间轴情报流", en: "Timeline Stream", ja: "タイムライン" },
                    view_map: { zh: "战术地图", en: "Tactical Map", ja: "戦術地図" },
                    btn_upload_map: { zh: "上传地图", en: "Upload Map", ja: "地図読込" },
                    mode_view: { zh: "浏览", en: "View", ja: "閲覧" },
                    mode_pin: { zh: "标记", en: "Pin", ja: "ピン" },
                    mode_region: { zh: "区域", en: "Region", ja: "領域" },
                    btn_fit: { zh: "适配", en: "Fit", ja: "全体" },
                    btn_export: { zh: "导出", en: "Export", ja: "出力" },
                    btn_import: { zh: "导入", en: "Import", ja: "取込" },
                    btn_img: { zh: "截图", en: "IMG", ja: "画像" },
                    hint_click_pin: { zh: "点击", en: "CLICK", ja: "クリック" },
                    hint_drag: { zh: "拖拽", en: "DRAG", ja: "ドラッグ" },
                    hint_zoom: { zh: "滚轮", en: "WHEEL", ja: "ホイール" },
                    msg_no_map: { zh: "未装载战术地图", en: "No Tactical Map Loaded", ja: "戦術地図なし" },

                    // --- 事件编辑 ---
                    header_manage_impacts: { zh: "影响管理", en: "Manage Impacts", ja: "影響管理" },
                    label_target: { zh: "目标", en: "Target", ja: "対象" },
                    label_attr: { zh: "属性", en: "Attr", ja: "属性" },
                    label_val: { zh: "新值", en: "Val", ja: "値" },
                    
                    // --- Impact Editor (右侧栏) ---
                    btn_type_stat: { zh: "属性变更", en: "CHANGE STAT", ja: "ステータス変更" }, // 新增
                    btn_type_region: { zh: "地块转移", en: "TRANSFER REGION", ja: "領土移譲" }, // 新增
                    btn_type_create: { zh: "创建实体", en: "CREATE ENTITY", ja: "実体作成" }, // 新增
                    btn_type_remove: { zh: "移除实体", en: "REMOVE ENTITY", ja: "実体削除" }, // 新增
                    ph_target_entity: { zh: "目标实体", en: "Target Entity", ja: "対象実体" }, // 新增
                    ph_attribute: { zh: "属性", en: "Attribute", ja: "属性" }, // 新增
                    ph_target_region: { zh: "目标区域", en: "Target Region", ja: "対象地域" }, // 新增
                    ph_new_controller: { zh: "新控制者", en: "New Controller", ja: "新支配者" }, // 新增
                    ph_new_entity_name: { zh: "新实体名称...", en: "New Entity Name...", ja: "新実体名..." }, // 新增
                    ph_entity_remove: { zh: "选择要移除的实体", en: "Entity to Remove", ja: "削除する実体" }, // 新增
                    ph_new_value: { zh: "新值", en: "New Value", ja: "新しい値" }, // 新增

                    // --- 右侧 & 底部 ---
                    header_godmode: { zh: "全局状态干涉 (上帝模式)", en: "GLOBAL STATE MANIPULATION", ja: "神の操作" },
                    ph_godmode: { zh: "输入神之指令...", en: "Enter divine command...", ja: "神のコマンドを入力..." }, // 新增
                    label_next_turn_b: { zh: "下个回合:", en: "Next Turn:", ja: "次ターン:" },

                    // --- 设置模态框 ---
                    set_llm_config: { zh: "LLM API 配置", en: "LLM API Configuration", ja: "LLM API 設定" },
                    set_provider: { zh: "服务提供商", en: "Provider Type", ja: "プロバイダー" },
                    set_base_url: { zh: "API 地址 (Base URL)", en: "Base URL", ja: "API URL" },
                    set_model: { zh: "模型名称", en: "Model Name", ja: "モデル名" },
                    set_key: { zh: "API 密钥 (Key)", en: "API Key", ja: "API キー" },
                    set_proxy: { zh: "网络代理 (Proxy)", en: "Network Proxy", ja: "プロキシ" },
                    set_enable_proxy: { zh: "启用本地代理", en: "Enable Local Proxy", ja: "プロキシ有効化" },
                    set_sys_prompt: { zh: "系统提示词 (System Prompt)", en: "System Prompt", ja: "システムプロンプト" },

                    // --- 地图编辑模态框 (大量新增) ---
                    map_new_terr: { zh: "新建领土 (Region)", en: "New Territory", ja: "新規領土" },
                    map_edit_terr: { zh: "编辑领土 (Region)", en: "Edit Territory", ja: "領土編集" },
                    map_add_pin: { zh: "添加标记 (Pin)", en: "Add Pin", ja: "ピン追加" },
                    map_edit_pin: { zh: "编辑标记 (Pin)", en: "Edit Pin", ja: "ピン編集" },
                    
                    map_geo_title: { zh: "地缘政治设定", en: "Geopolitics", ja: "地政学設定" },
                    label_geo_name: { zh: "地理名称", en: "Region Name", ja: "地域名" },
                    hint_geo_name: { zh: "该地块的永久地理名称。", en: "The permanent name of this land.", ja: "この土地の恒久的な名前。" },
                    label_controller: { zh: "当前控制权", en: "Current Controller", ja: "支配勢力" },
                    opt_neutral: { zh: "-- 中立 / 无主 --", en: "-- Neutral / Unclaimed --", ja: "-- 中立 / 無主 --" },
                    hint_controller: { zh: "颜色将自动跟随控制者。", en: "Color matches the controller automatically.", ja: "色は支配者に追従します。" },
                    
                    label_marker_type: { zh: "标记类型", en: "Marker Type", ja: "マーカー種類" },
                    btn_type_entity: { zh: "实体", en: "Entity", ja: "実体" },
                    btn_type_lore: { zh: "资料", en: "Lore", ja: "資料" },
                    btn_type_custom: { zh: "自定义", en: "Custom", ja: "カスタム" },
                    
                    label_select_entity: { zh: "选择实体", en: "Select Entity", ja: "実体選択" },
                    opt_choose_entity: { zh: "-- 请选择实体 --", en: "-- Choose Entity --", ja: "-- 実体を選択 --" },
                    label_select_lore: { zh: "选择资料条目", en: "Select Lore Entry", ja: "資料エントリ選択" },
                    opt_choose_lore: { zh: "-- 请选择资料 --", en: "-- Choose Lore --", ja: "-- 資料を選択 --" },
                    hint_lore_link: { zh: "链接至资料库。", en: "Links to Lore Library.", ja: "資料データベースへリンク。" },
                    label_custom_label: { zh: "自定义标签", en: "Label Name", ja: "ラベル名" },
                    
                    label_appearance: { zh: "图标与颜色覆盖 (可选)", en: "Icon & Color Override", ja: "アイコンと色のオーバーライド" },
                    label_icon_class: { zh: "图标类名 (FontAwesome)", en: "Icon Class", ja: "アイコンクラス" },
                    label_custom_color: { zh: "自定义颜色", en: "Custom Color", ja: "カスタム色" },
                    
                    label_pos_region: { zh: "标签位置微调 (重心)", en: "Label Position (Centroid)", ja: "ラベル位置 (重心)" },
                    label_pos_pin: { zh: "标记坐标微调", en: "Pin Position", ja: "ピン座標" },
                    hint_pos_region: { zh: "微调地块标签的中心点。", en: "Fine-tune the label center point.", ja: "ラベルの中心点を微調整。" },
                    hint_pos_pin: { zh: "微调标记点的位置。", en: "Fine-tune pin location.", ja: "ピンの位置を微調整。" },
                    
                    btn_remove: { zh: "移除", en: "Remove", ja: "削除" },



                    tab_combat: { zh: "战斗裁判", en: "Combat", ja: "戦闘" },
                    header_combat: { zh: "战斗裁决系统 (UCS)", en: "Universal Combat System", ja: "汎用戦闘システム" },
                    label_combat_context: { zh: "战斗背景 / 战术意图", en: "Context / Intent", ja: "戦闘背景 / 意図" },
                    label_dice_check: { zh: "命运检定 (RNG)", en: "Fate Check (RNG)", ja: "運命判定" },
                    msg_click_roll: { zh: "点击骰子进行检定", en: "Click dice to roll", ja: "ダイスをクリック" },
                    btn_judge_combat: { zh: "AI 裁决战斗结果", en: "AI Judge Combat", ja: "AI 戦闘裁定" }
                },

                // [修改] stat_schema 升级为 rule_sets (允许多套规则)
                // 结构示例: [{ id: 'default', name: '通用规则', fields: [{key:'hp', label:'生命'}] }]
                rule_sets: [], 
                activeSchemaId: '', // 当前在左侧栏正在编辑哪一套规则
                
                lorebook: [], players: [], timeline: [], global_vars: [],
                map_data: { image: '', pins: [], regions: [] },

                // [新增] 地图交互模式状态
                mapToolMode: 'pin', // 'pin' | 'region'
                isProcessingRegion: false,
                editingRegionIndex: -2, // -2:无, -1:新增, >=0:编辑
                
                // [新增] 地图视图控制状态
                mapView: {
                    scale: 1,      
                    x: 0,          
                    y: 0,          
                    isDragging: false,
                    startX: 0,
                    startY: 0,
                    // ★ 新增：徽章大小控制 (默认 1.0)
                    badgeScale: 1.0, 
                    // ★ 新增：显示模式 (full=全显示, icon=仅图标, dot=仅点)
                    displayMode: 'full' 
                },
                showMap: false,
                // [优化] 时间轴分页控制
                timelinePageSize: 10, 
                showAllTimeline: false,
                pendingTurnRange: "", pendingEvents: [],
                // [修改] 增加 options 数组
                editor: { factionId: '', timeStart: '', timeEnd: '', summary: '', content: '', impacts: [], options: [] },
                impactForm: { type: 'STAT_CHANGE', targetId: '', attrKey: '', newValue: '', targetName: '' },
                editImpactForm: { type: 'STAT_CHANGE', targetId: '', attrKey: '', newValue: '', targetName: '' },
                
                posterData: { title: '', factionName: '', color: '', icon: '', content: '', badges: [], timeDisplay: '' },
                quoteIdx: 0,
                quotes: [ "岁寒，然后知松柏之后凋也", "看看演员 王公 游民 盗贼的心电图", "人生若只如初见，何事秋风悲画扇", "我还想和你谈论宇宙和天空", "西郊有密林，助君出重围", "我一无所有 只有一颗赤子之心", "高树多悲风，海水扬其波", "你方唱罢我登场，反认他乡是故乡", "空山新林归鹧鸪，世间繁华梦一出", "昨夜西风凋碧树，独上高楼，望尽天涯路", "我听见那声音向我严正发问 我为明天尽些什么义务", "六朝何事？只成门户私计！" ],
                
                tempSystemPrompt: "",
                contextConfig: {
                    includeGlobal: true, includeRules: true, includeHistory: true, includeCurrent: true,
                    includeMap: true, // [恢复] 地图总开关
                    
                    // [恢复] 核心记忆变量
                    historyDeepDepth: 1,    // 深层记忆 (近 - 含详情)
                    historyShallowDepth: 3, // 浅层记忆 (远 - 仅摘要)
                    
                    loreList: [], playerList: [],
                    
                    // [恢复] 地图筛选列表
                    mapRegionList: [], 
                    mapPinList: [],

                    // [恢复] 正确的装配顺序，Map 在 Players 之后
                    order: ['global', 'rules', 'lore', 'players', 'map', 'history', 'current']
                }
            }
        },
        watch: {
            // 1. 监听 UI 主题变化，实时切换 CSS 变量
            'ui.theme': {
                handler(newTheme) {
                    document.body.setAttribute('data-theme', newTheme);
                },
                immediate: true
            },

            // 2. [新增] 监听地图打点表单中的 selectedId 变化
            // 当用户在下拉框选择了一个实体或资料时，自动填充图标和颜色
            'pinForm.selectedId': function(newVal) {
                // 如果是“实体(Entity)”模式
                if (this.pinForm.mode === 'entity' && newVal) {
                    const p = this.players.find(x => x.id === newVal);
                    if (p) {
                        // 自动填入该实体的 Logo 和 颜色
                        this.pinForm.icon = p.logo || 'fa-solid fa-users';
                        this.pinForm.color = p.color || '#ffffff';
                    }
                }
                // 如果是“资料(Lore)”模式
                else if (this.pinForm.mode === 'lore' && newVal) {
                    // 如果当前还是默认图标，或者是空的，就自动填入“书签”图标和绿色
                    // 这样设计是为了防止覆盖用户刚刚手动修改过的自定义图标
                    const currentIcon = this.pinForm.icon;
                    if (!currentIcon || currentIcon === 'fa-solid fa-map-pin' || currentIcon === 'fa-solid fa-users') {
                        this.pinForm.icon = 'fa-solid fa-book-bookmark';
                        this.pinForm.color = '#10b981'; // 资料默认给个翡翠绿
                    }
                }
            },
            
            // 3. [新增] 监听模式切换，重置一下默认值，避免图标残留
            'pinForm.mode': function(newMode) {
                if (newMode === 'custom') {
                    // 切换到自定义模式时，如果当前没有图标，给一个默认的
                    if (!this.pinForm.icon) {
                        this.pinForm.icon = 'fa-solid fa-map-pin';
                        this.pinForm.color = '#f59e0b'; // 琥珀色
                    }
                }
                // 切换到实体模式时，清空 selectedId 以便触发下一次选择监听
                if (newMode === 'entity') {
                   // 这里不需要强制清空 selectedId，保留上次的选择体验可能更好
                   // 但如果想重置，可以在这里写 this.pinForm.selectedId = '';
                }
            }
        },
        async mounted() {
            const savedSettings = localStorage.getItem('levant_settings');
            if (savedSettings) {
                try {
                    const parsed = JSON.parse(savedSettings);
                    if(parsed.api) this.settings.api = { ...this.settings.api, ...parsed.api };
                    if(parsed.proxy) this.settings.proxy = { ...this.settings.proxy, ...parsed.proxy }; 
                    if(parsed.prompts) this.settings.prompts = { ...this.settings.prompts, ...parsed.prompts };
                    if(parsed.ui) this.ui = { ...this.ui, ...parsed.ui }; 
                } catch(e) { console.error("Failed to load settings", e); }
            }

            document.body.setAttribute('data-theme', this.ui.theme);

            await this.loadGame(this.currentSaveFile);
            if (this.map_data.image) {
                // 使用 $nextTick 确保 DOM 里的 Canvas 已经渲染出来
                this.$nextTick(() => this.initMapCanvas(this.map_data.image));
            }
            window.addEventListener('beforeunload', () => { if(this.serverConnected) this.saveGame('autosave.json'); });
            
            setInterval(() => {
                let nextIdx; do { nextIdx = Math.floor(Math.random() * this.quotes.length); } while (nextIdx === this.quoteIdx); 
                this.quoteIdx = nextIdx;
            }, 6000);
        },
        computed: {
            // [优化] 仅渲染可见的时间轴回合，避免后期 DOM 爆炸
            visibleTimeline() {
                if (this.showAllTimeline) return this.timeline;
                // 仅返回最后 N 个回合
                const start = Math.max(0, this.timeline.length - this.timelinePageSize);
                return this.timeline.slice(start);
            },
            // [新增] 树状实体列表：将扁平的 players 转换为带层级信息的列表
            sortedPlayers() {
                const result = [];
                // 1. 建立 ID 到对象的映射，方便查找
                const map = new Map(this.players.map(p => [p.id, { ...p, _depth: 0 }]));
                
                // 2. 递归函数：添加节点及其子节点
                const addNode = (parentId, depth) => {
                    // 找到所有父级ID为 parentId 的实体
                    const children = this.players.filter(p => (p.parentId || '') === parentId);
                    
                    children.forEach(child => {
                        const childObj = map.get(child.id);
                        childObj._depth = depth;
                        result.push(childObj);
                        // 递归查找下一层
                        addNode(child.id, depth + 1);
                    });
                };

                // 3. 从根节点（parentId 为空）开始遍历
                addNode('', 0);
                
                // 4. 处理孤儿节点（以防万一数据错乱，虽不常见但为了健壮性）
                const addedIds = new Set(result.map(r => r.id));
                this.players.forEach(p => {
                    if (!addedIds.has(p.id)) {
                        result.push({ ...p, _depth: 0 }); // 放在最后，视为根节点
                    }
                });

                return result;
            },

            currentAttrValue() {
                if (!this.impactForm.targetId || !this.impactForm.attrKey) return '---';
                const p = this.players.find(x => x.id === this.impactForm.targetId);
                return p ? (p.stats[this.impactForm.attrKey] || 'N/A') : '???';
            },
            // index.html 约 1300 行左右
            finalContextPreview() {
                let preview = "";
                
                this.contextConfig.order.forEach(type => {
                    // ... (Global, Rules, Lore, Players 保持原样) ...
                    if (type === 'global' && this.contextConfig.includeGlobal) {
                        preview += `=== [WORLD: GLOBAL VARS] ===\n${this.global_vars.map(g => `${g.key}: ${g.value}`).join('\n')}\n\n`;
                    }
                    if (type === 'rules' && this.contextConfig.includeRules) {
                        preview += `=== [WORLD: RULES] ===\n`;
                        this.rule_sets.forEach(rs => {
                            preview += `> ${rs.name}: ${rs.fields.map(f => f.key).join(', ')}\n`;
                        });
                        preview += `\n`;
                    }
                    if (type === 'lore') {
                        const activeLore = this.contextConfig.loreList.filter(l => l.active);
                        if (activeLore.length) preview += `=== [WORLD: LORE] ===\n${activeLore.map(l => `> [${l.keys}]: ${l.content}`).join('\n')}\n\n`;
                    }
                    if (type === 'players') {
                        const activeP = this.contextConfig.playerList.filter(p => p.active);
                        if (activeP.length) preview += `=== [WORLD: ENTITIES] ===\n${activeP.map(p => { const r=this.players.find(x=>x.id===p.id); return `ID:${r.id}|${r.name}\nDesc:${r.desc}\nStats:${JSON.stringify(r.stats)}`; }).join('\n\n')}\n\n`;
                    }

                    // === [核心修复] 5. 地图数据 (Map) - 适配你的筛选列表 ===
                    if (type === 'map' && this.contextConfig.includeMap) {
                        preview += `=== [TACTICAL MAP DATA] ===\n`;
                        
                        // 1. 仅获取被勾选 active 的区域
                        const activeRegions = this.contextConfig.mapRegionList.filter(r => r.active);
                        if (activeRegions.length > 0) {
                            preview += "Regions (Territory Control):\n";
                            activeRegions.forEach(reg => {
                                // 注意：因为 contextConfig 里的对象是副本，我们需要用 ID 回查 owner 的最新名称
                                const realReg = this.map_data.regions.find(r => r.id === reg.id) || reg;
                                const ownerName = realReg.ownerId ? this.getFactionName(realReg.ownerId) : "NEUTRAL";
                                preview += `- Region "${realReg.name}" (Owner: ${ownerName})\n`;
                            });
                        }

                        // 2. 仅获取被勾选 active 的标记点
                        const activePins = this.contextConfig.mapPinList.filter(p => p.active);
                        if (activePins.length > 0) {
                            preview += "\nPoints of Interest:\n";
                            activePins.forEach(pin => {
                                const realPin = this.map_data.pins.find(p => p.id === pin.id) || pin;
                                const label = realPin.label || this.getPinName(realPin.linkId);
                                preview += `- Pin "${label}" at [${realPin.x.toFixed(1)}%, ${realPin.y.toFixed(1)}%]\n`;
                            });
                        }
                        
                        if (activeRegions.length === 0 && activePins.length === 0) {
                            preview += "(No map items selected)\n";
                        }
                        preview += "\n";
                    }

                    // === [核心修复] 6. 历史回溯 (History) - 适配 historyDeepDepth/historyShallowDepth ===
                    if (type === 'history' && this.contextConfig.includeHistory) {
                        preview += `=== [HISTORY MEMORY] ===\n`;
                        
                        const totalLen = this.timeline.length;
                        // 使用你UI中绑定的变量
                        const deepLen = this.contextConfig.historyDeepDepth || 0;
                        const shallowLen = this.contextConfig.historyShallowDepth || 0;

                        // 正序切片计算: 
                        // [Start] ... [Shallow Zone] ... [Deep Zone] ... [End]
                        const deepStart = Math.max(0, totalLen - deepLen);
                        const shallowEnd = deepStart;
                        const shallowStart = Math.max(0, shallowEnd - shallowLen);

                        const shallowTurns = this.timeline.slice(shallowStart, shallowEnd);
                        const deepTurns = this.timeline.slice(deepStart);

                        // 渲染浅层 (只摘要)
                        if (shallowTurns.length > 0) {
                            preview += `--- Shallow Memory (Summary Only) ---\n`;
                            shallowTurns.forEach(turn => {
                                preview += `[Turn ${turn.id}] ${turn.timeRange}\n`;
                                turn.events.forEach(e => {
                                    preview += ` • ${e.summary} (Actor: ${e.factionId})\n`;
                                });
                                preview += `\n`;
                            });
                        }

                        // 渲染深层 (含详情)
                        if (deepTurns.length > 0) {
                            preview += `--- Deep Memory (Full Details) ---\n`;
                            deepTurns.forEach(turn => {
                                preview += `[Turn ${turn.id}] ${turn.timeRange}\n`;
                                turn.events.forEach(e => {
                                    preview += ` • ${e.summary} (Actor: ${e.factionId})\n`;
                                    if (e.content) preview += `   Details: ${e.content.substring(0, 150)}...\n`;
                                    if (e.impacts && e.impacts.length) {
                                         preview += `   Impacts: ${e.impacts.map(i => `${i.targetName}.${i.attrLabel}: ${i.change || (i.oldValue+'->'+i.newValue)}`).join('; ')}\n`;
                                    }
                                });
                                preview += `\n`;
                            });
                        }

                        if (shallowTurns.length === 0 && deepTurns.length === 0) {
                            preview += "(No history available in current range)\n\n";
                        }
                    }

                    // 7. Current (保持原样)
                    if (type === 'current' && this.contextConfig.includeCurrent) {
                        preview += `=== [CURRENT INSTRUCTION] ===\n`;
                        if (this.rawInput) preview += `> CMD: ${this.rawInput}\n`;
                        if (this.editor.factionId) preview += `> ActorID: ${this.editor.factionId}\n`;
                        if (this.editor.summary) preview += `> Draft: ${this.editor.summary}\n`;
                        preview += `\n`;
                    }
                });
                return preview;
            }
        },
        methods: {
            // [新增] 添加选项到右侧编辑器
            addOptionToEditor() {
                if (!this.editor.options) this.editor.options = [];
                this.editor.options.push({ label: 'New Option', desc: 'Description of the outcome...' });
            },

            // [新增] 添加选项到时间轴事件
            addOptionToEvent(event) {
                if (!event.options) event.options = [];
                // 确保是对象结构
                event.options.push({ label: 'New Decision', desc: 'Potential consequences...' });
            },

            // --- 新增工具方法 ---
            createImpactObject(form) {
                const type = form.type || 'STAT_CHANGE';
                let newImpact = { type };

                if (type === 'STAT_CHANGE') {
                    if (!form.targetId || !form.attrKey || form.newValue === '') return null;
                    
                    // 全局变量处理
                    if (form.targetId === 'global') {
                        Object.assign(newImpact, {
                            targetId: 'global',
                            targetName: 'Global',
                            attrKey: form.attrKey,
                            attrLabel: form.attrKey,
                            oldValue: this.getAttrValueDisplay('global', form.attrKey),
                            newValue: form.newValue
                        });
                    } else {
                        // 实体处理
                        const t = this.players.find(p => p.id === form.targetId);
                        if (!t) return null;
                        
                        // ★ 修复：不再依赖 this.stat_schema，而是通过 getSchemaLabel 全局查找
                        const label = this.getSchemaLabel(form.attrKey, t.schemaId);
                        
                        Object.assign(newImpact, {
                            targetId: t.id,
                            targetName: t.name,
                            attrKey: form.attrKey,
                            attrLabel: label,
                            oldValue: t.stats[form.attrKey] || '-',
                            newValue: form.newValue
                        });
                    }
                } 
                else if (type === 'REGION_TRANSFER') {
                    if (!form.targetName || !form.newValue) return null;
                    Object.assign(newImpact, { targetName: form.targetName, newValue: form.newValue });
                }
                else if (type === 'ENTITY_CREATE') {
                    if (!form.newValue.trim()) return null;
                    Object.assign(newImpact, { data: { name: form.newValue.trim() } });
                }
                else if (type === 'ENTITY_REMOVE') {
                    if (!form.targetId) return null;
                    Object.assign(newImpact, { targetId: form.targetId });
                }
                else if (type === 'PIN_MOVE') {
                    if (!form.targetId || !form.newValue) return null;
                    const pin = this.map_data.pins.find(p => p.id === form.targetId);
                    const oldCoords = pin ? `${pin.x.toFixed(1)},${pin.y.toFixed(1)}` : '?,?';
                    Object.assign(newImpact, {
                        targetId: form.targetId,
                        targetName: pin ? (pin.label || this.getPinName(pin.linkId)) : 'Unknown Pin',
                        oldValue: oldCoords,
                        newValue: form.newValue
                    });
                }
                return newImpact;
            },
// --- [新增] 智能截图系统 ---
            
            toggleScreenshotMode() {
                this.isScreenshotMode = !this.isScreenshotMode;
                if (!this.isScreenshotMode) {
                    this.screenshotRect = { x:0, y:0, w:0, h:0 };
                    this.screenshotTarget = null;
                }
            },

            exitScreenshotMode() {
                this.isScreenshotMode = false;
            },

            // 核心逻辑：智能查找“值得截图”的父级容器
            handleScreenshotHover(e) {
                const elements = document.elementsFromPoint(e.clientX, e.clientY);
                
                // 1. 找到第一个不是“截图辅助层”的元素
                const el = elements.find(node => 
                    node.nodeType === 1 && 
                    !node.classList.contains('screenshot-backdrop') &&
                    !node.classList.contains('screenshot-overlay') &&
                    !node.classList.contains('screenshot-label')
                );

                if (!el) return;

                // 2. [关键修改] 特殊处理地图区域
                // 如果鼠标下的元素属于地图视口（或者是视口本身），直接强制锁定为视口容器
                // 这样无论地图放大多少倍，我们只截取“窗口”看到的部分
                const mapViewport = el.closest('.map-viewport');
                if (mapViewport) {
                    this.screenshotTarget = mapViewport;
                    this.screenshotTargetName = "Tactical_Map_View";
                    
                    const rect = mapViewport.getBoundingClientRect();
                    this.screenshotRect = {
                        x: rect.left,
                        y: rect.top,
                        w: rect.width,
                        h: rect.height
                    };
                    return; // 地图处理完毕，直接返回
                }

                // 3. 常规组件吸附逻辑 (处理非地图区域)
                const targetSelectors = [
                    '.info-card',          // 实体卡片
                    '.impact-badge',       // 状态胶囊
                    '.glass-panel',        // 弹窗
                    'aside',               // 侧边栏
                    'header',              // 顶栏
                    'section[role="main"]',// 中间主视图 (如果没选中地图视口，可能会选中这个)
                    '.poster-terminal',    
                    '.poster-newspaper'
                ];

                let target = el.closest(targetSelectors.join(','));

                // 兜底逻辑
                if (!target) {
                    // 排除大背景，防止误触
                    if (el.id === 'app' || el.tagName === 'BODY' || el.tagName === 'HTML' || el.classList.contains('app-texture')) {
                        this.screenshotRect = { x:0, y:0, w:0, h:0 };
                        this.screenshotTarget = null;
                        return;
                    }
                    target = el; 
                }

                this.screenshotTarget = target;
                
                // 获取显示名称
                let name = target.className;
                if (typeof name === 'string') name = name.split(' ')[0];
                else name = target.tagName.toLowerCase();
                
                if (target.getAttribute('aria-label')) name = target.getAttribute('aria-label');
                this.screenshotTargetName = name || 'Element';

                // 计算位置
                const rect = target.getBoundingClientRect();
                this.screenshotRect = {
                    x: rect.left,
                    y: rect.top,
                    w: rect.width,
                    h: rect.height
                };
            },

            async captureScreenshot() {
                if (!this.screenshotTarget) {
                    alert("错误：未选中任何区域。");
                    return;
                }

                const rect = { ...this.screenshotRect };
                const fileNameLabel = this.screenshotTargetName || "Capture";

                // 1. 暂时隐藏截图框
                this.isScreenshotMode = false;
                await this.$nextTick();

                try {
                    // 获取 DPR (Retina屏幕支持)
                    const dpr = window.devicePixelRatio || 1;
                    
                    // 计算屏幕物理分辨率
                    const screenW = window.screen.width * dpr;
                    const screenH = window.screen.height * dpr;

                    // 2. 唤起屏幕共享 (参数调优版)
                    const stream = await navigator.mediaDevices.getDisplayMedia({
                        video: {
                            displaySurface: "browser",
                            // 【优化】去掉鼠标光标 (需选择"当前标签页")
                            cursor: "never", 
                            
                            // 【优化】请求最大物理分辨率
                            width: { ideal: screenW, max: 8192 }, 
                            height: { ideal: screenH, max: 8192 },
                            
                            // 【优化】强制低帧率，告诉编码器我们要的是画质而不是流畅度
                            frameRate: { ideal: 1, max: 15 }, 
                            
                            resizeMode: "none"
                        },
                        audio: false,
                        preferCurrentTab: true
                    });

                    // 3. 视频预热
                    const video = document.createElement("video");
                    video.style.position = "fixed";
                    video.style.top = "-9999px";
                    video.style.left = "-9999px";
                    // 确保 video 元素本身也是物理像素大小，防止浏览器内部缩放
                    video.style.width = window.innerWidth + "px";
                    video.style.height = window.innerHeight + "px";
                    document.body.appendChild(video);

                    video.srcObject = stream;
                    await video.play();

                    // 【强制等待】等待画面变清晰 (视频流刚开始几帧通常很糊，主要是关键帧未到)
                    await new Promise(resolve => setTimeout(resolve, 800));

                    // 4. 计算精准坐标 (消除亚像素模糊)
                    // 视频实际分辨率
                    const videoW = video.videoWidth;
                    // CSS 视口分辨率
                    const viewportW = window.innerWidth;
                    // 真实的缩放因子
                    const scaleFactor = videoW / viewportW;

                    // 【关键优化】所有坐标强制取整 (Math.round)，避免半像素渲染导致的模糊
                    const sX = Math.round(rect.x * scaleFactor);
                    const sY = Math.round(rect.y * scaleFactor);
                    const sW = Math.round(rect.w * scaleFactor);
                    const sH = Math.round(rect.h * scaleFactor);

                    // 5. 绘图
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");

                    canvas.width = sW;
                    canvas.height = sH;

                    // 关闭平滑 (在 1:1 像素映射时，关闭平滑反而更锐利)
                    ctx.imageSmoothingEnabled = false;

                    // 【可选黑科技】应用 SVG 锐化滤镜补偿视频压缩模糊
                    // 如果觉得画面太“硬”，可以注释掉下面这行
                    ctx.filter = 'contrast(1.05) saturate(1.05)'; 

                    ctx.drawImage(
                        video,
                        sX, sY, sW, sH,  // 源坐标 (物理像素)
                        0, 0, canvas.width, canvas.height // 目标坐标
                    );

                    // 6. 清理
                    stream.getTracks().forEach(track => track.stop());
                    document.body.removeChild(video);

                    // 7. 下载
                    const link = document.createElement('a');
                    link.download = `Crystal_Snap_${fileNameLabel}_${Date.now()}.png`;
                    link.href = canvas.toDataURL("image/png");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                } catch (e) {
                    console.error(e);
                    if (e.name !== 'NotAllowedError') {
                        alert("截图异常: " + e.message);
                    }
                } finally {
                    document.body.style.cursor = 'default';
                    this.isScreenshotMode = true;
                }
            },
            // [新增] 切换地图标记显示模式
            cycleMapDisplayMode() {
                const modes = ['full', 'icon', 'dot'];
                const idx = modes.indexOf(this.mapView.displayMode);
                this.mapView.displayMode = modes[(idx + 1) % modes.length];
            },
            // [新增] 辅助 Impact 表单：根据选中的目标ID，返回其可用的属性字段列表
            getFieldsForImpactTarget(targetId) {
                if (!targetId || targetId === 'global') return []; // Global 单独处理
                const p = this.players.find(x => x.id === targetId);
                if (!p) return [];
                return this.getFieldsBySchemaId(p.schemaId);
            },
            getImpactColor(imp) {
            const type = imp.type || 'STAT_CHANGE';
            switch(type) {
                case 'STAT_CHANGE': return this.getFactionColor(imp.targetId);
                case 'REGION_TRANSFER': return '#6366f1'; // Indigo
                case 'ENTITY_CREATE': return '#10b981';   // Emerald
                case 'ENTITY_REMOVE': return '#ef4444';   // Red
                default: return '#64748b';
            }
        },
            getAttrValueDisplay(tid, key) {
                if (!tid || !key) return '---';
                if (tid === 'global') {
                    const g = this.global_vars.find(x => x.key === key);
                    return g ? g.value : '???';
                } else {
                    const p = this.players.find(x => x.id === tid);
                    return p ? (p.stats[key] || 'N/A') : '???';
                }
            },

            getFinalPinIcon(pin) {
                // 1. 如果 Pin 本身有自定义图标，优先使用
                if (pin.icon) return pin.icon;
                
                // 2. 如果没有自定义，且关联了实体，使用实体的 Logo
                if (pin.type === 'entity' || (!pin.type && pin.linkId)) {
                    const p = this.players.find(x => x.id === pin.linkId);
                    if (p && p.logo) return p.logo;
                }
                
                // 3. 默认图标 (区分资料点和普通点)
                if (pin.type === 'lore') return 'fa-solid fa-book-bookmark';
                return 'fa-solid fa-map-pin';
            },

            getFinalPinColor(pin) {
                // 1. 优先使用 Pin 自定义颜色
                if (pin.color) return pin.color;
                
                // 2. 使用实体颜色
                if (pin.type === 'entity' || (!pin.type && pin.linkId)) {
                    const p = this.players.find(x => x.id === pin.linkId);
                    if (p && p.color) return p.color;
                }
                
                // 3. 默认颜色
                if (pin.type === 'lore') return '#10b981'; // Emerald
                return '#f59e0b'; // Amber
            },


            // 1. 上传图片 (上传后自动重置视图)
// 1. 上传图片 (上传后自动重置视图，并初始化 Canvas)
            handleMapUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.map_data.image = e.target.result;
                    this.map_data.regions = []; // 换新地图时清空地块
                    this.resetMapView();
                    
                    this.saveGame('autosave.json');
                    
                    // [新增] 初始化分析用 Canvas
                    this.$nextTick(() => this.initMapCanvas(this.map_data.image));
                };
                reader.readAsDataURL(file);
            },
            
            // [新增] Canvas 初始化辅助函数
            initMapCanvas(imgSrc) {
                const canvas = document.getElementById('map-analysis-canvas');
                if(!canvas) return;
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                };
                img.src = imgSrc;
            },

            // 2. 重置视图 (Fit Width)
            resetMapView() {
                this.mapView = { scale: 1, x: 0, y: 0, isDragging: false, startX: 0, startY: 0 };
            },

            // 3. 鼠标滚轮 (缩放)
            onMapWheel(e) {
                if (!this.map_data.image) return;
                const zoomIntensity = 0.1;
                const direction = e.deltaY > 0 ? -1 : 1;
                let newScale = this.mapView.scale + (direction * zoomIntensity);

                // [修改] 限制缩放范围 (0.5x ~ 10x)，即最高 1000%
                newScale = Math.min(Math.max(0.5, newScale), 10);
                
                // 简单的居中缩放逻辑 (为了代码简洁，暂时不做跟随鼠标位置的复杂矩阵计算)
                // 如果需要更高级的“跟随鼠标缩放”，代码量会增加很多
                this.mapView.scale = newScale;
            },
            exportMapConfig() {
                if (!this.map_data.image) return alert("No map data to export.");
                
                // 将 map_data 对象转为 JSON 字符串
                const dataStr = JSON.stringify(this.map_data, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                
                // 创建临时链接下载
                const link = document.createElement('a');
                link.href = url;
                link.download = `MapConfig_${Date.now()}.json`;
                link.click();
                
                // 清理
                URL.revokeObjectURL(url);
            },

            // 导入地图配置
            handleMapConfigImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // 简单校验数据结构
                        if (!importedData.image || !Array.isArray(importedData.pins)) {
                            throw new Error("Invalid map configuration file.");
                        }

                        if (confirm("Importing map will overwrite current map data. Continue?")) {
                            // 覆盖数据
                            this.map_data = importedData;
                            
                            // 兼容性处理：如果导入的是旧版数据没有 regions，补上
                            if (!this.map_data.regions) this.map_data.regions = [];

                            // 重置视图并保存
                            this.resetMapView();
                            this.saveGame('autosave.json');
                            
                            // 【关键】重新初始化 Canvas，否则导入后无法使用 Region 泛洪工具
                            this.$nextTick(() => {
                                this.initMapCanvas(this.map_data.image);
                            });
                            
                            alert("Map imported successfully!");
                        }
                    } catch (err) {
                        console.error(err);
                        alert("Failed to import map: " + err.message);
                    }
                    // 清空 input value，允许重复导入同一个文件
                    event.target.value = '';
                };
                reader.readAsText(file);
            },
// [新增] 导出为 PNG 图片
            async exportMapImage() {
                if (!this.map_data.image) return alert("No map loaded.");

                // 1. 获取地图的核心变换层
                // 【修改】改为通过 ID 获取，更加稳健
                const element = document.getElementById('map-capture-target');
                
                // 【修改】如果找不到元素，弹出提示，而不是静默失败
                if (!element) {
                    alert("Error: Map element not found (ID: map-capture-target missing).");
                    return;
                }

                // 2. 保存当前视图状态 (为了截图后恢复)
                const oldView = { ...this.mapView };
                const oldCursor = document.body.style.cursor;

                // 3. 提示用户并在后台调整视图
                document.body.style.cursor = 'wait';
                
                // 【关键步骤】重置视图以截取全图
                this.mapView = { scale: 1, x: 0, y: 0, isDragging: false };
                
                // 等待 Vue 更新 DOM
                await this.$nextTick();
                // 增加一点等待时间，确保图片渲染就绪
                await new Promise(resolve => setTimeout(resolve, 300));

                try {
                    // 4. 执行截图
                    const canvas = await html2canvas(element, {
                        backgroundColor: null, // 透明背景
                        scale: 2,              // 2倍采样
                        useCORS: true,         
                        logging: false,
                        // 忽略隐藏的辅助元素
                        ignoreElements: (el) => el.classList.contains('pointer-events-none') && el.tagName === 'DIV' && el.innerHTML === '' 
                    });

                    // 5. 触发下载
                    const link = document.createElement('a');
                    link.download = `Tactical_Map_${Date.now()}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    
                } catch (e) {
                    console.error(e);
                    alert("Image export failed: " + e.message);
                } finally {
                    // 6. 恢复视图
                    this.mapView = oldView;
                    document.body.style.cursor = oldCursor;
                }
            },
            // 4. 鼠标按下 (开始拖拽)
            onMapMouseDown(e) {
                if (!this.map_data.image) return;
                this.mapView.isDragging = true;
                this.mapView.startX = e.clientX - this.mapView.x;
                this.mapView.startY = e.clientY - this.mapView.y;
                
                // 记录点击初始位置，用于在 MouseUp 判断是点击还是拖拽
                this.dragOrigin = { x: e.clientX, y: e.clientY };
            },

            // 5. 鼠标移动 (拖拽中)
            onMapMouseMove(e) {
                if (!this.mapView.isDragging) return;
                e.preventDefault();
                this.mapView.x = e.clientX - this.mapView.startX;
                this.mapView.y = e.clientY - this.mapView.startY;
            },

            // 6. 鼠标抬起 (结束拖拽 OR 触发点击)
            onMapMouseUp(e) {
                if (!this.mapView.isDragging) return;
                this.mapView.isDragging = false;

                // 计算移动距离
                const dist = Math.sqrt(
                    Math.pow(e.clientX - this.dragOrigin.x, 2) + 
                    Math.pow(e.clientY - this.dragOrigin.y, 2)
                );

                // 如果移动距离小于 5px，则视为“点击添加点”
                if (dist < 5) {
                    this.handleAddPinClick(e);
                }
            },

            // 7. 处理添加点的逻辑 (也就是之前的 onMapBackgroundClick)
            // 注意：这里需要根据当前的 scale 和 translate 反推回 % 坐标
// 7. 处理点击逻辑：根据模式分流 (添加点 OR 添加区域)
            handleAddPinClick(e) {
                if (this.mapToolMode === 'view') return;

                const transformLayer = e.currentTarget.querySelector('.origin-top-left');
                if (!transformLayer) return;

                const rect = transformLayer.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;

                // 计算百分比
                const xPct = (clickX / rect.width) * 100;
                const yPct = (clickY / rect.height) * 100;
                if (xPct < 0 || xPct > 100 || yPct < 0 || yPct > 100) return;

                if (this.mapToolMode === 'pin') {
                    // --- 原有点模式 ---
                    this.editingPinIndex = -1;
                    this.editingRegionIndex = -2; // 确保不冲突
                    this.pinForm = {
                        x: xPct, y: yPct,
                        mode: 'entity', selectedId: '', customLabel: '', 
                        icon: 'fa-solid fa-map-pin', color: '#ffffff'
                    };
                    this.showPinModal = true;
                } else if (this.mapToolMode === 'region') {
                    // --- [新增] 区域泛洪模式 ---
                    const canvas = document.getElementById('map-analysis-canvas');
                    if(!canvas) return alert("Canvas not ready. Re-upload image.");
                    
                    // 换算回原图像素坐标
                    const rawX = Math.floor((clickX / rect.width) * canvas.width);
                    const rawY = Math.floor((clickY / rect.height) * canvas.height);
                    
                    this.createRegionFromPoint(rawX, rawY);
                }
            },
// [新增] 泛洪算法生成地块
            createRegionFromPoint(startX, startY) {
                if (this.isProcessingRegion) return;
                this.isProcessingRegion = true;
                document.body.style.cursor = 'wait';

                try {
                    const canvas = document.getElementById('map-analysis-canvas');
                    const ctx = canvas.getContext('2d');
                    const width = canvas.width;
                    const height = canvas.height;
                    
                    // 获取全图像素数据
                    const imageData = ctx.getImageData(0, 0, width, height);
                    const data = imageData.data;

                    // 获取点击点的颜色
                    const startPos = (startY * width + startX) * 4;
                    const startColor = [data[startPos], data[startPos+1], data[startPos+2], data[startPos+3]];

                    // 颜色容差 (40)
                    const tolerance = 40; 
                    const match = (pos) => {
                        const r = data[pos], g = data[pos+1], b = data[pos+2];
                        return Math.abs(r - startColor[0]) < tolerance &&
                               Math.abs(g - startColor[1]) < tolerance &&
                               Math.abs(b - startColor[2]) < tolerance; 
                    };

                    // BFS 泛洪 (优化：使用单层整数栈减少GC压力)
                    // 将坐标 x,y 编码为单一整数 index = y * width + x
                    const stack = [startY * width + startX]; 
                    const visited = new Uint8Array(width * height);
                    const regionPixels = []; 
                    
                    let minX = width, maxX = 0, minY = height, maxY = 0;
                    
                    visited[startY * width + startX] = 1;

                    // 预先定义方向数组，避免循环内创建对象
                    const dx = [1, -1, 0, 0];
                    const dy = [0, 0, 1, -1];

                    while (stack.length) {
                        const idx = stack.pop();
                        const x = idx % width;
                        const y = (idx / width) | 0; // 取整
                        
                        regionPixels.push(x, y);
                        
                        // 只需要比较当前点，不需要每次循环都比较
                        if (x < minX) minX = x;
                        if (x > maxX) maxX = x;
                        if (y < minY) minY = y;
                        if (y > maxY) maxY = y;

                        for (let i = 0; i < 4; i++) {
                            const nx = x + dx[i];
                            const ny = y + dy[i];

                            if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                                const nIdx = ny * width + nx;
                                if (!visited[nIdx]) {
                                    if (match(nIdx * 4)) {
                                        visited[nIdx] = 1;
                                        stack.push(nIdx);
                                    }
                                }
                            }
                        }
                    }

                    if (regionPixels.length < 50) {
                        alert("Area too small!");
                        return;
                    }

                    // 生成掩码图片
                    const regionW = maxX - minX + 1;
                    const regionH = maxY - minY + 1;
                    const maskCanvas = document.createElement('canvas');
                    maskCanvas.width = regionW;
                    maskCanvas.height = regionH;
                    const maskCtx = maskCanvas.getContext('2d');
                    const maskImgData = maskCtx.createImageData(regionW, regionH);
                    
                    for (let i = 0; i < regionPixels.length; i += 2) {
                        const px = regionPixels[i] - minX;
                        const py = regionPixels[i+1] - minY;
                        const idx = (py * regionW + px) * 4;
                        
                        // 改为白色 (255, 255, 255)，为了兼容 SVG Mask
                        maskImgData.data[idx] = 255;   // R
                        maskImgData.data[idx+1] = 255; // G
                        maskImgData.data[idx+2] = 255; // B
                        maskImgData.data[idx+3] = 255; // A (完全不透明)
                    }
                    maskCtx.putImageData(maskImgData, 0, 0);

                    // 计算重心
                    let sumX = 0, sumY = 0;
                    let pixelCount = 0;
                    
                    for (let i = 0; i < regionPixels.length; i += 2) {
                        sumX += regionPixels[i];
                        sumY += regionPixels[i+1];
                        pixelCount++;
                    }
                    
                    // 计算相对于原图宽高的百分比
                    const centerX = (sumX / pixelCount / width) * 100;
                    const centerY = (sumY / pixelCount / height) * 100;

                    // 打开编辑框
                    this.editingRegionIndex = -1; // 标记新增 Region
                    this.editingPinIndex = -2;    // 关闭 Pin 模式
                    this.pinForm = {
                        // Region 特有
                        x: (minX / width) * 100,
                        y: (minY / height) * 100,
                        w: (regionW / width) * 100,
                        h: (regionH / height) * 100,
                        maskData: maskCanvas.toDataURL(),
                        centerX: centerX,
                        centerY: centerY,
                        
                        // 通用
                        mode: 'entity', selectedId: '', customLabel: 'New Region',
                        icon: 'fa-solid fa-flag', color: '#ffffff'
                    };
                    this.showPinModal = true;

                } catch (e) {
                    console.error(e);
                    alert("Region detection failed.");
                } finally {
                    this.isProcessingRegion = false;
                    document.body.style.cursor = 'default';
                }
            },

            // [新增] 点击已存在的地块
            onRegionClick(reg, idx) {
                this.editingRegionIndex = idx;
                this.editingPinIndex = -2; 
                
                // 回填表单
                this.pinForm = {
                    ...reg, // 加载几何数据
                    
                    // 映射回表单字段
                    customLabel: reg.name,   // 地理名 -> customLabel
                    selectedId: reg.ownerId, // 控制者 -> selectedId
                    
                    icon: reg.icon || 'fa-solid fa-mountain', // 默认图标
                    color: reg.color // 通常不需要，因为颜色由 owner 决定，除非有 override
                };
                this.showPinModal = true;
            },
            onPinClick(pin, idx) {
                // 【关键修复】明确告诉系统：我现在是在编辑点，不是在编辑区域
                this.editingPinIndex = idx;
                this.editingRegionIndex = -2; // -2 代表不处于区域编辑模式
                
                let mode = pin.type || 'custom';
                if (!pin.type) {
                     if (this.players.some(p => p.id === pin.linkId)) mode = 'entity';
                     else if (pin.linkId) mode = 'lore';
                     else mode = 'custom';
                }

                this.pinForm = {
                    x: pin.x, y: pin.y,
                    mode: mode,
                    selectedId: pin.linkId || '',
                    customLabel: pin.label || '',
                    icon: pin.icon || this.getFinalPinIcon(pin),
                    color: pin.color || this.getFinalPinColor(pin)
                };
                this.showPinModal = true;
            },
            // 3. 保存 (新增或修改)
            saveMapPin() {
                // 构建数据
                // 约定：对于 Region，customLabel 是地理名(name)，selectedId 是控制者(ownerId)
                // 对于 Pin，customLabel 是标签(label)，selectedId 是链接实体(linkId)
                
                let nameOrLabel = this.pinForm.customLabel || "Unnamed";
                let idRef = this.pinForm.selectedId || "";

                if (this.pinForm.mode === 'entity' && this.editingRegionIndex === -2) {
                    const p = this.players.find(x => x.id === this.pinForm.selectedId);
                    nameOrLabel = p ? p.name : "Unknown";
                } else if (this.pinForm.mode === 'lore' && this.editingRegionIndex === -2) {
                    nameOrLabel = this.pinForm.selectedId;
                }

                const baseData = {
                    icon: this.pinForm.icon,
                    color: this.pinForm.color
                };

                // --- 保存分支 ---
                if (this.editingRegionIndex !== -2) {
                    // === Region (地块) 保存逻辑 ===
                    const regionData = {
                        ...baseData,
                        id: this.editingRegionIndex === -1 ? 'reg_' + Date.now() : this.map_data.regions[this.editingRegionIndex].id,
                        type: 'territory',
                        name: this.pinForm.customLabel || "Region", // 地理名
                        ownerId: this.pinForm.selectedId,           // 控制权
                        
                        // 几何数据
                        x: this.pinForm.x, y: this.pinForm.y,
                        w: this.pinForm.w, h: this.pinForm.h,
                        maskData: this.pinForm.maskData,
                        centerX: this.pinForm.centerX, centerY: this.pinForm.centerY
                    };

                    if (!this.map_data.regions) this.map_data.regions = [];
                    if (this.editingRegionIndex === -1) this.map_data.regions.push(regionData);
                    else this.map_data.regions[this.editingRegionIndex] = regionData;
                    
                    this.editingRegionIndex = -2; 
                } else {
                    // === Pin (标记点) 保存逻辑 ===
                    const pinData = {
                        ...baseData,
                        id: this.editingPinIndex === -1 ? 'pin_' + Date.now() : this.map_data.pins[this.editingPinIndex].id,
                        type: this.pinForm.mode,
                        label: nameOrLabel,
                        linkId: idRef,
                        x: this.pinForm.x,
                        y: this.pinForm.y
                    };
                    if (this.editingPinIndex === -1) this.map_data.pins.push(pinData);
                    else this.map_data.pins[this.editingPinIndex] = pinData;
                }

                this.saveGame('autosave.json');
                this.showPinModal = false;
            },

            deleteMapPin() {
                if(confirm("Remove this item?")) {
                    if (this.editingRegionIndex !== -2 && this.editingRegionIndex !== -1) {
                        this.map_data.regions.splice(this.editingRegionIndex, 1);
                    } else if (this.editingPinIndex !== -1) {
                        this.map_data.pins.splice(this.editingPinIndex, 1);
                    }
                    this.saveGame('autosave.json');
                    this.showPinModal = false;
                    this.editingRegionIndex = -2;
                }
            },

            getPinColor(linkId) {
                if (!linkId) return '#fbbf24'; // default amber
                return this.getFactionColor(linkId);
            },
            
            getPinName(linkId) {
                if (!linkId) return 'Marker';
                return this.getFactionName(linkId);
            },

            // 构建层级树字符串，供 AI 使用
            buildHierarchyString() {
                const roots = this.players.filter(p => !p.parentId);
                let output = "";
                
                const printNode = (p, depth) => {
                    const indent = "  ".repeat(depth);
                    
                    // 清洗 stats，防止属性中混入 Base64 图片
                    const safeStats = { ...p.stats };
                    for (const key in safeStats) {
                        const val = safeStats[key];
                        // 如果值是字符串且过长，判定为非文本数据，进行截断
                        if (typeof val === 'string' && val.length > 200) {
                            safeStats[key] = "[LONG_DATA_OMITTED]";
                        }
                    }
                    const statsStr = JSON.stringify(safeStats);

                    output += `${indent}- [${p.name}] (ID: ${p.id}) ${statsStr}\n`;
                    
                    // 查找子节点
                    const children = this.players.filter(child => child.parentId === p.id);
                    children.forEach(c => printNode(c, depth + 1));
                };

                roots.forEach(r => printNode(r, 0));
                return output;
            },

            // 构建地图描述字符串，供 AI 使用
            buildMapString() {
                if ((!this.map_data.regions || this.map_data.regions.length === 0) && (!this.map_data.pins || this.map_data.pins.length === 0)) return "No tactical map data defined.";
                
                let output = "=== TACTICAL MAP STATUS (Geopolitics) ===\n";
                
                // 1. 输出地块控制权信息
                if (this.map_data.regions && this.map_data.regions.length > 0) {
                    output += "Regions (Territory Control):\n";
                    this.map_data.regions.forEach(reg => {
                        const ownerName = reg.ownerId ? this.getFactionName(reg.ownerId) : "NEUTRAL/UNCLAIMED";
                        output += `- Region "${reg.name}" is controlled by [${ownerName}] (ID: ${reg.ownerId || 'None'}).\n`;
                    });
                }
                
                // 2. 输出关键点信息
                if (this.map_data.pins && this.map_data.pins.length > 0) {
                    output += "\nKey Locations (Points of Interest):\n";
                    this.map_data.pins.forEach(pin => {
                        const name = pin.label || this.getPinName(pin.linkId);
                        output += `- POI "${name}" at [${pin.x.toFixed(1)}%, ${pin.y.toFixed(1)}%]. Type: ${pin.type}.\n`;
                    });
                }
                
                output += "Note: Map coordinates are 0-100% relative.\n";
                return output;
            },
            applyPreset(type) {
                if (type === 'Gemini') {
                    this.settings.api.provider = 'Gemini';
                    this.settings.api.baseUrl = ''; 
                    this.settings.api.model = 'gemini-2.5-flash';
                } else if (type === 'Claude') {
                    this.settings.api.provider = 'Claude';
                    this.settings.api.baseUrl = ''; // Claude 不需要 BaseURL (除非用代理，但通常直接连)
                    this.settings.api.model = 'claude-sonnet-4-5-20250929';
                } else if (type === 'DeepSeek') {
                    this.settings.api.provider = 'OpenAI';
                    this.settings.api.baseUrl = 'https://api.deepseek.com';
                    this.settings.api.model = 'deepseek-chat';
                } else if (type === 'Qwen') {
                    this.settings.api.provider = 'OpenAI';
                    this.settings.api.baseUrl = 'https://dashscope.aliyuncs.com/compatible-mode/v1';
                    this.settings.api.model = 'qwen-plus';
                } else if (type === 'OpenAI') {
                    this.settings.api.provider = 'OpenAI';
                    this.settings.api.baseUrl = 'https://api.openai.com/v1';
                    this.settings.api.model = 'gpt-4o';
                } else if (type === 'SiliconFlow') {
                    this.settings.api.provider = 'OpenAI';
                    this.settings.api.baseUrl = 'https://api.siliconflow.cn/v1';
                    this.settings.api.model = 'deepseek-ai/DeepSeek-V3';
                } else if (type === 'Others') {
                    this.settings.api.provider = 'Others';
                    this.settings.api.baseUrl = ''; // 用户自填
                    this.settings.api.model = ''; // 用户自填
                }
            },
            t(key) {
                if (!this.translations[key]) return key;
                return this.translations[key][this.ui.lang] || this.translations[key]['zh'];
            },
            renderMarkdown(text) { return marked.parse(text || ''); },
            getFactionColor(id) { 
                if(!id || id === 'global') return '#94a3b8'; 
                const p = this.players.find(x => x.id === id); 
                return p ? p.color : '#6366f1'; 
            },
            getFactionName(id) { 
                if (id === 'global') return this.t('option_global'); 
                if (!id) return 'Unknown';
                const p = this.players.find(x => x.id === id); 
                return p ? p.name : 'Unknown'; 
            },
            getFactionLogo(id) { 
                if (id === 'global') return 'fa-solid fa-globe'; 
                if (!id) return 'fa-solid fa-users';
                const p = this.players.find(x => x.id === id); 
                return p && p.logo ? p.logo : 'fa-solid fa-users'; 
            },
            getSchemaLabel(key) { const s = this.stat_schema.find(x => x.key === key); return s ? s.label : key; },
            // [新增] 获取指定规则集的所有字段
            getFieldsBySchemaId(sid) {
                const schema = this.rule_sets.find(r => r.id === sid);
                return schema ? schema.fields : [];
            },
            // [新增] 获取当前正在编辑的规则集字段
            getActiveSchemaFields() {
                return this.getFieldsBySchemaId(this.activeSchemaId);
            },
            // [修改] 根据 key 查找 label (需要遍历所有规则集，或者指定规则集)
            getSchemaLabel(key, schemaId = null) {
                // 1. 如果指定了 schemaId，精准查找
                if (schemaId) {
                    const schema = this.rule_sets.find(r => r.id === schemaId);
                    if (schema) {
                        const field = schema.fields.find(f => f.key === key);
                        if (field) return field.label;
                    }
                }
                // 2. 全局查找 (用于 Impact 显示等上下文不明确的情况)
                for (const rs of this.rule_sets) {
                    const field = rs.fields.find(f => f.key === key);
                    if (field) return field.label;
                }
                return key; // 找不到则返回 key 本身
            },
            // [新增] 添加新规则集
            addNewRuleSet() {
                const name = prompt("New Rule Set Name (e.g. 'Character', 'Nation')");
                if (!name) return;
                const newId = 'rs_' + Date.now();
                this.rule_sets.push({ id: newId, name: name, fields: [] });
                this.activeSchemaId = newId;
                this.saveGame('autosave.json');
            },
            // [新增] 删除规则集
            deleteActiveRuleSet() {
                if (this.rule_sets.length <= 1) return alert("Must keep at least one rule set.");
                if (!confirm("Delete this rule set? Entities using it will lose stat definitions.")) return;
                const idx = this.rule_sets.findIndex(r => r.id === this.activeSchemaId);
                this.rule_sets.splice(idx, 1);
                this.activeSchemaId = this.rule_sets[0].id;
                this.saveGame('autosave.json');
            },
            // [新增] 判断是否为图片 (Base64 或 URL)
            isImage(str) { return str && (str.startsWith('data:image') || str.startsWith('http') || str.includes('.png') || str.includes('.jpg')); },
            // [新增] 智能解析值：如果是实体ID则显示名称，否则显示原值
            resolveVal(val) {
                if (!val || typeof val !== 'string') return val;
                // 尝试在 players 列表里找
                const p = this.players.find(x => x.id === val);
                if (p) return p.name;
                // 如果是 global，显示对应文本
                if (val === 'global') return this.t('option_global');
                return val;
            },
            
            // [新增] 处理实体头像上传
            handleFactionImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    // 将结果存入 editingFaction.logo
                    this.editingFaction.logo = e.target.result;
                };
                reader.readAsDataURL(file);
            },
            formatTimeSpan(event) { if (!event.timeStart) return "Time ?"; if (!event.timeEnd || event.timeStart === event.timeEnd) return event.timeStart; return `${event.timeStart} - ${event.timeEnd}`; },
            getRegionColor(reg) {
                // 1. 如果有 ownerId，优先使用 owner 的颜色
                if (reg.ownerId) {
                    const p = this.players.find(x => x.id === reg.ownerId);
                    if (p) return p.color;
                }
                // 2. 如果地块自己定义了 override 颜色，使用之
                if (reg.color && reg.color !== '#ffffff') return reg.color;
                
                // 3. 默认无主颜色 (slate-500)
                return '#64748b';
            },

            getRegionOwnerLogo(reg) {
                if (reg.ownerId) {
                    const p = this.players.find(x => x.id === reg.ownerId);
                    if (p && p.logo) return p.logo;
                }
                return reg.icon || 'fa-solid fa-mountain';
            },

            async exportAsImage(type, data) {
                this.posterData = { title: '', factionName: '', color: '', icon: '', content: '', badges: [], timeDisplay: '' };
                const currentTurnTime = this.timeline.length > 0 ? this.timeline[this.timeline.length-1].timeRange : 'Current';
                if (type === 'faction') {
                    this.posterData.title = data.name;
                    this.posterData.factionName = "ENTITY FILE";
                    this.posterData.color = data.color;
                    this.posterData.icon = data.logo;
                    this.posterData.content = this.renderMarkdown(data.desc);
                    this.posterData.timeDisplay = currentTurnTime;
                    for(let key in data.stats) {
                        this.posterData.badges.push({ name: data.name, icon: data.logo, color: data.color, label: this.getSchemaLabel(key), val: data.stats[key] });
                    }
                } else if (type === 'event') {
                    this.posterData.title = data.summary;
                    this.posterData.factionName = this.getFactionName(data.factionId);
                    this.posterData.color = this.getFactionColor(data.factionId);
                    this.posterData.icon = this.getFactionLogo(data.factionId);
                    this.posterData.content = this.renderMarkdown(data.content);
                    this.posterData.timeDisplay = this.formatTimeSpan(data);
                    if(data.impacts) {
                        data.impacts.forEach(imp => {
                            // ★ 核心修复：手动拼接数值变化字符串
                            const changeString = `${imp.oldValue} → ${imp.newValue}`;
                            
                            this.posterData.badges.push({
                                name: imp.targetName,
                                icon: this.getFactionLogo(imp.targetId),
                                color: this.getFactionColor(imp.targetId),
                                label: imp.attrLabel,
                                val: changeString // ★ 使用拼接好的字符串
                            });
                        });
                    }
                } else if (type === 'lore') {
                    this.posterData.title = data.keys;
                    this.posterData.factionName = "LORE DATABASE";
                    this.posterData.color = "#10b981";
                    this.posterData.icon = "fa-solid fa-database";
                    this.posterData.content = this.renderMarkdown(data.content);
                    this.posterData.timeDisplay = currentTurnTime;
                } else if (type === 'rules') {
                    this.posterData.title = "SYSTEM RULES";
                    this.posterData.factionName = "CORE";
                    this.posterData.color = "#f59e0b";
                    this.posterData.icon = "fa-solid fa-sliders";
                    this.posterData.timeDisplay = currentTurnTime;
                    let content = "Current Rules:\n\n";
                    data.forEach(d => content += `- **${d.label}** [${d.key}]\n`);
                    this.posterData.content = this.renderMarkdown(content);
                }
                await this.$nextTick();
                const element = document.getElementById('poster-canvas');
                await new Promise(resolve => setTimeout(resolve, 100));
                try {
                    const canvas = await html2canvas(element, { backgroundColor: null, scale: 2, useCORS: true, logging: false });
                    const link = document.createElement('a');
                    link.download = `Levant_${type}_${Date.now()}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                } catch (e) { alert("Error generating image"); }
            },

            async openSaveLoadModal() {
                try {
                    const res = await axios.get(`${API_BASE}/api/saves`);
                    this.saveFiles = res.data.files;
                    this.showSaveLoadModal = true;
                } catch (e) { alert("Failed to fetch saves"); }
            },
            async loadGame(filename) {
                if (!filename) return;
                try {
                    const res = await axios.get(`${API_BASE}/api/state?filename=${filename}`);
                    this.applyState(res.data);
                    
                    // [新增] 读取存档后，如果有地图图片，必须重新绘制隐藏的分析用 Canvas
                    // 否则“区域泛洪/魔棒”工具会因为 Canvas 为空而失效
                    if (this.map_data.image) {
                        this.$nextTick(() => {
                            this.initMapCanvas(this.map_data.image);
                        });
                    }

                    this.currentSaveFile = filename;
                    this.showSaveLoadModal = false;
                } catch (e) { this.serverConnected = false; }
            },
            // [优化] 简单的防抖保存包装器
            debouncedSave(filename) {
                if (this.saveTimeout) clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(() => {
                    this.saveGame(filename);
                }, 1000); // 延迟 1 秒保存
            },

            async saveGame(filename) {
                // 如果是防抖触发的，清除计时器句柄
                if (this.saveTimeout) { 
                    clearTimeout(this.saveTimeout); 
                    this.saveTimeout = null; 
                }
                
                if (!filename || !filename.trim()) return;
                if (!filename.endsWith('.json')) filename += '.json';
                
                try {
                    const stateData = { 
                        // [核心修改] 保存 rule_sets 数组，而不是旧的 stat_schema
                        rule_sets: this.rule_sets,
                        
                        lorebook: this.lorebook, 
                        players: this.players, 
                        timeline: this.timeline, 
                        global_vars: this.global_vars, 
                        currentTurnPending: this.pendingEvents,
                        map_data: this.map_data 
                    };
                    
                    await axios.post(`${API_BASE}/api/state?filename=${filename}`, stateData);
                    this.currentSaveFile = filename;
                    this.serverConnected = true;
                    if (this.showSaveLoadModal) { this.showSaveLoadModal = false; this.newSaveFilename = ''; }
                } catch (e) { 
                    console.error(e);
                    // 修复报错显示，把对象转成字符串
                    let errorMsg = e.message;
                    if (e.response && e.response.data) {
                        errorMsg = JSON.stringify(e.response.data, null, 2);
                    }
                    alert("Save Failed:\n" + errorMsg);
                }
            },
            async deleteSave(filename) {
                if (!confirm(`Delete "${filename}"?`)) return;
                try { await axios.delete(`${API_BASE}/api/saves/${filename}`); this.openSaveLoadModal(); } catch (e) { alert("Delete failed"); }
            },
applyState(data) {
                const sanitizedData = JSON.parse(JSON.stringify(data));
                
                // 1. [修改] 直接从后端加载已处理好的 rule_sets。后端已负责兼容旧存档。
                this.rule_sets = sanitizedData.rule_sets || [];

                // 2. [核心修复] 加载完 rule_sets 后，必须验证并重置 activeSchemaId
                // 检查当前的 activeSchemaId 是否在新的 rule_sets 中还存在
                const isActiveIdValid = this.rule_sets.some(rs => rs.id === this.activeSchemaId);

                // 如果ID无效 (或从未设置过), 并且存在至少一个规则集，则自动选中第一个
                if ((!isActiveIdValid || !this.activeSchemaId) && this.rule_sets.length > 0) {
                    this.activeSchemaId = this.rule_sets[0].id;
                } 
                // 如果加载后一个规则集都没有，则清空 activeSchemaId
                else if (this.rule_sets.length === 0) {
                    this.activeSchemaId = '';
                }

                // 3. [保留] 加载其他数据
                this.lorebook = sanitizedData.lorebook || [];
                this.players = sanitizedData.players || []; 
                this.timeline = sanitizedData.timeline || []; 
                this.global_vars = sanitizedData.global_vars || [];
                this.map_data = sanitizedData.map_data || { image: '', pins: [] }; 
                this.pendingEvents = sanitizedData.currentTurnPending || [];
                this.serverConnected = true;
            },
            
            addGlobalVar() {
                this.global_vars.push({ key: 'New Var', value: 'Value' });
                this.saveGame('autosave.json');
            },

            openContextModal() {
                if (!this.settings.api.key) return alert("Please set API Key in settings.");
                const rawInputText = this.rawInput.trim(); 
                const editorDraft = this.editor.summary;
                if (!rawInputText && !editorDraft) return alert("Please input command or summary!");

                this.tempSystemPrompt = this.settings.prompts.system;
                const inputText = (rawInputText + " " + editorDraft).toLowerCase();
                this.contextConfig.loreList = this.lorebook.map(entry => {
                    let isActive = false;
                    if (entry.mode === 'on') isActive = true;
                    else if (entry.mode === 'auto') {
                        const keywords = entry.keys.split(/[,，]/).map(k => k.trim().toLowerCase()).filter(k => k);
                        isActive = keywords.some(k => inputText.includes(k));
                    }
                    return { ...entry, active: isActive, originalMode: entry.mode };
                });
                this.contextConfig.playerList = this.players.map(p => ({ id: p.id, name: p.name, logo: p.logo, color: p.color, active: true }));
                this.contextConfig.mapRegionList = this.map_data.regions.map(r => ({ 
                    ...r, 
                    active: true 
                }));
                this.contextConfig.mapPinList = this.map_data.pins.map(p => ({ 
                    id: p.id, label: p.label, linkId: p.linkId, type: p.type, x: p.x, y: p.y, active: true 
                }));

                this.showContextModal = true;
            },

            moveContextItem(type, direction) {
                const idx = this.contextConfig.order.indexOf(type);
                if (idx < 0) return;
                const newIdx = idx + direction;
                if (newIdx >= 0 && newIdx < this.contextConfig.order.length) {
                    const temp = this.contextConfig.order[newIdx];
                    this.contextConfig.order[newIdx] = this.contextConfig.order[idx];
                    this.contextConfig.order[idx] = temp;
                }
            },

            // --- 新增: 处理文件上传 ---
            async handleScriptFiles(event) {
                const files = event.target.files;
                if (!files.length) return;
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const rawData = e.target.result; 
                        let payload = { name: file.name, type: file.type, data: '' };
                        if (file.type.startsWith('image')) {
                            payload.data = rawData.split(',')[1]; // 去除 data:image/png;base64, 前缀
                        } else {
                            payload.data = rawData; // 文本内容
                        }
                        this.scriptAttachments.push(payload);
                    };
                    if (file.type.startsWith('image')) {
                        reader.readAsDataURL(file);
                    } else {
                        reader.readAsText(file);
                    }
                }
            },
            // [修改] 点击选项后的处理逻辑
            selectOption(event, optData) {
                let decisionText = "";
                if (typeof optData === 'object') {
                    // 严格取 label，并附带 desc 给 AI 做上下文
                    decisionText = `${optData.label} (${optData.desc})`;
                } else {
                    decisionText = optData;
                }
                
                this.rawInput = `[Decision] ${this.getFactionName(event.factionId)} chose: ${decisionText}`;
                
                // 2. 切换到指令 Tab
                this.tabs.right = 'input';
                
                // 3. 自动打开上下文组装窗口 (或者你可以直接调用 runAiInference，但打开窗口更安全)
                this.openContextModal();

                // 4. 可选：为了方便，自动把“当前指令”勾选上（如果之前没勾的话）
                this.contextConfig.includeCurrent = true;
            },
            // --- ★ 核心智能 JSON 修复引擎 v6.0 (Heuristic Stack Repair) ★ ---
            // 真正的“科学”修复：基于堆栈深度的启发式决策 (Insertion vs Substitution)
            smartJSONParse(jsonStr) {
                const firstOpen = jsonStr.indexOf('{');
                if (firstOpen === -1) throw new Error("No JSON object found.");
                
                // 截取从第一个 { 开始的字符串
                let str = jsonStr.substring(firstOpen);
                
                // 结果构建器
                let result = [];
                // 期望栈：存入“期望看到的闭合符号”
                let stack = []; 
                let inString = false;
                let i = 0;
                
                // 根节点闭合标记
                let rootClosed = false;

                for (; i < str.length; i++) {
                    if (rootClosed) break; // 根节点闭合后，忽略剩余字符

                    const char = str[i];
                    
                    // 1. 字符串状态处理
                    if (char === '"' && (i === 0 || str[i-1] !== '\\')) {
                        inString = !inString;
                        result.push(char);
                        continue;
                    }
                    if (inString) {
                        result.push(char);
                        continue;
                    }

                    // 2. 结构字符处理
                    if (char === '{') {
                        stack.push('}');
                        result.push(char);
                    } 
                    else if (char === '[') {
                        stack.push(']');
                        result.push(char);
                    } 
                    else if (char === '}' || char === ']') {
                        if (stack.length === 0) {
                            // 栈空了还有闭合符，说明多了，忽略
                            continue;
                        }

                        const expected = stack[stack.length - 1]; // 栈顶期望

                        // === 情况 A: 完美匹配 ===
                        if (char === expected) {
                            stack.pop();
                            result.push(char);
                            if (stack.length === 0) rootClosed = true;
                        } 
                        // === 情况 B: 不匹配，进行启发式决策 ===
                        else {
                            // 关键逻辑：判断是“漏写了”还是“写错了”
                            // 检查栈的倒数第二层（Parent的Parent）
                            const parentExpected = stack.length > 1 ? stack[stack.length - 2] : null;

                            // 如果当前字符匹配“爷爷节点”的期望，说明“父亲节点”漏闭合了
                            // 例子: [ { "a":1 ]  --> 栈是 ['}', ']']。当前是 ']'。
                            // ']' 不等于栈顶 '}'，但等于爷爷 ']'。
                            // 结论：漏写了 '}'。
                            if (char === parentExpected) {
                                // 动作：插入栈顶期望的符号，弹出栈顶
                                const missingChar = stack.pop();
                                result.push(missingChar); 
                                
                                // 回溯：当前的 char (即 ']') 还没被消费，i 减 1 让下一轮循环处理它
                                i--; 
                            } 
                            // 否则，认为是单纯的笔误 (Typo)
                            // 例子: { "a": 1 ] --> 栈是 ['}']。没有爷爷。
                            // 结论：把 ']' 写成了 '}'。
                            else {
                                // 动作：强制替换
                                stack.pop();
                                result.push(expected); // 写入期望的符号，而不是当前的 char
                                if (stack.length === 0) rootClosed = true;
                            }
                        }
                    } 
                    // 3. 普通字符 (非结构非字符串)
                    else {
                        result.push(char);
                    }
                }

                // 4. 自动补全截断 (Auto-Complete)
                // 循环结束如果栈还有剩，说明被截断了，依次补齐
                while (stack.length > 0) {
                    result.push(stack.pop());
                }

                // 5. 最终清洗：转字符串 -> 去尾部逗号 -> 解析
                let fixedStr = result.join('');
                
                // 正则：去除 } 或 ] 前面的逗号 (JSON 不允许尾部逗号)
                fixedStr = fixedStr.replace(/,\s*([\]}])/g, '$1');

                try {
                    return JSON.parse(fixedStr);
                } catch (e) {
                    console.error("智能修复 v6 失败。原始:", str, "\n修复后:", fixedStr);
                    throw e;
                }
            },
            // --- 核心推演 (修改后支持 baseUrl 和 Attachments 接口) ---
            async runAiInference() {
                this.isThinking = true;
                
                // --- 构建单体上下文 (严格遵循 contextConfig.order 顺序) ---
                let contextPayload = "";
                
                this.contextConfig.order.forEach(type => {
                    
                    // 1. 全局变量
                    if (type === 'global' && this.contextConfig.includeGlobal) {
                        contextPayload += `=== [WORLD: GLOBAL VARS] ===\n${this.global_vars.map(g => `${g.key}: ${g.value}`).join('\n')}\n\n`;
                    }
                    
                    if (type === 'rules' && this.contextConfig.includeRules) {
                        contextPayload += `=== [WORLD: RULES DEFINITIONS] ===\n`;
                        // 遍历所有规则集发送给 AI
                        this.rule_sets.forEach(rs => {
                            const fieldsStr = rs.fields.map(f => `${f.key}=${f.label}`).join(', ');
                            contextPayload += `TYPE [${rs.name}]: ${fieldsStr}\n`;
                        });
                        contextPayload += `\n`;
                    }
                    
                    // 3. 资料设定
                    if (type === 'lore') {
                        const activeLore = this.contextConfig.loreList.filter(l => l.active);
                        if (activeLore.length > 0) {
                            contextPayload += `=== [WORLD: LORE] ===\n${activeLore.map(l => `> [${l.keys}]: ${l.content}`).join('\n')}\n\n`;
                        }
                    }
                    
                    // 4. 参与实体
                    if (type === 'players') {
                        const activePlayers = this.contextConfig.playerList.filter(p => p.active);
                        if (activePlayers.length > 0) {
                            contextPayload += `=== [WORLD: ENTITIES] ===\n${activePlayers.map(p => {
                                const realP = this.players.find(x => x.id === p.id);
                                return `ID:${realP.id} | ${realP.name}\n  Desc: ${realP.desc}\n  Stats: ${JSON.stringify(realP.stats)}`;
                            }).join('\n\n')}\n\n`;
                        }
                    }

                    // 5. 地图数据 (Map) - 适配筛选列表
                    if (type === 'map' && this.contextConfig.includeMap) {
                        const activeRegions = this.contextConfig.mapRegionList.filter(r => r.active);
                        const activePins = this.contextConfig.mapPinList.filter(p => p.active);
                        
                        if (activeRegions.length > 0 || activePins.length > 0) {
                            contextPayload += `=== [TACTICAL MAP DATA] ===\n`;
                            
                            if (activeRegions.length > 0) {
                                contextPayload += "Regions (Control):\n";
                                activeRegions.forEach(reg => {
                                    // 必须回查原始数据以获取最新状态
                                    const realReg = this.map_data.regions.find(r => r.id === reg.id) || reg;
                                    const owner = realReg.ownerId ? this.getFactionName(realReg.ownerId) : "NEUTRAL";
                                    contextPayload += `- Region "${realReg.name}" (Owner: ${owner})\n`;
                                });
                            }
                            
                            if (activePins.length > 0) {
                                contextPayload += "\nPoints of Interest:\n";
                                activePins.forEach(pin => {
                                    const realPin = this.map_data.pins.find(p => p.id === pin.id) || pin;
                                    const label = realPin.label || this.getPinName(realPin.linkId);
                                    contextPayload += `- Pin "${label}" at [${realPin.x.toFixed(0)},${realPin.y.toFixed(0)}]\n`;
                                });
                            }
                            contextPayload += "\n";
                        }
                    }

                    // 6. 历史回溯 (History) - 正序 + 深浅分离
                    if (type === 'history' && this.contextConfig.includeHistory) {
                        const totalLen = this.timeline.length;
                        const deepLen = this.contextConfig.historyDeepDepth;       // 近期 (详情)
                        const shallowLen = this.contextConfig.historyShallowDepth; // 远期 (摘要)

                        // 计算切片索引 (正序: 远 -> 近)
                        const deepStart = Math.max(0, totalLen - deepLen);
                        const shallowEnd = deepStart;
                        const shallowStart = Math.max(0, shallowEnd - shallowLen);

                        const shallowTurns = this.timeline.slice(shallowStart, shallowEnd);
                        const deepTurns = this.timeline.slice(deepStart);

                        if (shallowTurns.length > 0 || deepTurns.length > 0) {
                            contextPayload += `=== [HISTORY MEMORY] ===\n`;
                            
                            // A. 浅层记忆 (仅摘要)
                            if (shallowTurns.length > 0) {
                                contextPayload += `--- Shallow Memory (Far Context / Summary Only) ---\n`;
                                shallowTurns.forEach(turn => {
                                    contextPayload += `[Turn ${turn.id}] ${turn.timeRange}\n`;
                                    turn.events.forEach(e => {
                                        contextPayload += ` • ${e.summary} (Actor: ${e.factionId})\n`;
                                    });
                                    contextPayload += `\n`;
                                });
                            }

                            // B. 深层记忆 (含完整 Content 和 Impacts)
                            if (deepTurns.length > 0) {
                                contextPayload += `--- Deep Memory (Recent Events / Full Detail) ---\n`;
                                deepTurns.forEach(turn => {
                                    contextPayload += `[Turn ${turn.id}] ${turn.timeRange}\n`;
                                    turn.events.forEach(e => {
                                        contextPayload += ` • ${e.summary} (Actor: ${e.factionId})\n`;
                                        // 注入完整内容，不截断
                                        if (e.content) contextPayload += `   Details: ${e.content}\n`;
                                        if (e.impacts && e.impacts.length) {
                                             contextPayload += `   Impacts: ${e.impacts.map(i => `${i.targetName}.${i.attrLabel}: ${i.change || (i.oldValue+'->'+i.newValue)}`).join('; ')}\n`;
                                        }
                                    });
                                    contextPayload += `\n`;
                                });
                            }
                            contextPayload += "\n";
                        }
                    }

                    // 7. 当前指令 (Current)
                    if (type === 'current' && this.contextConfig.includeCurrent) {
                        contextPayload += `=== [CURRENT INSTRUCTION] ===\n`;
                        if (this.rawInput) contextPayload += `> COMMAND: ${this.rawInput}\n`;
                        if (this.editor.factionId) contextPayload += `> ACTOR_ID: ${this.editor.factionId}\n`;
                        if (this.editor.timeStart) contextPayload += `> TIME: ${this.editor.timeStart} - ${this.editor.timeEnd}\n`;
                        if (this.editor.summary) contextPayload += `> DRAFT_TITLE: ${this.editor.summary}\n`;
                        if (this.editor.content) contextPayload += `> DRAFT_CONTENT: ${this.editor.content}\n`;
                        if (this.editor.impacts.length) {
                            contextPayload += `> PLANNED_IMPACTS: ${JSON.stringify(this.editor.impacts)}\n`;
                        }
                        // 安科模式开关
                        if (this.generateOptions) {
                            contextPayload += `> MODE: Generate "options" array for player decision.\n`;
                        }
                        contextPayload += `\n`;
                    }
                });

                // --- 组装 API 请求 ---
                const payload = { 
                    provider: this.settings.api.provider, 
                    apiKey: this.settings.api.key, 
                    baseUrl: this.settings.api.baseUrl,
                    model: this.settings.api.model, 
                    useProxy: this.settings.proxy.enabled, 
                    proxyPort: this.settings.proxy.port,
                    
                    systemPrompt: this.tempSystemPrompt, 
                    
                    // 核心修改：所有信息都放在 context 里，history 留空以避免后端重复插入
                    context: contextPayload,    
                    history: "",    
                    
                    // userPrompt 仅作为最后的触发器
                    userPrompt: "Analyze context and generate the next turn JSON event." 
                };

                try {
                    const res = await axios.post(`${API_BASE}/api/ai/generate`, payload);
                    const match = res.data.result.match(/\{[\s\S]*\}/);
                    if (!match) throw new Error("AI did not return a valid JSON object.");
                    
                    // ... (后续解析逻辑保持不变) ...
                    const parsed = this.smartJSONParse(match[0]); // 使用你的智能解析器
                    
                    this.editor.content = parsed.content || ""; 
                    this.editor.summary = parsed.summary || ""; 
                    this.editor.factionId = parsed.factionId || this.editor.factionId; 
                    this.editor.timeStart = parsed.timeStart || ""; 
                    this.editor.timeEnd = parsed.timeEnd || "";
                    // 处理选项
                    if (parsed.options && Array.isArray(parsed.options)) {
                        this.editor.options = parsed.options;
                    }
                    
                     if(parsed.impacts && Array.isArray(parsed.impacts)) {
                        this.editor.impacts = []; 
                        parsed.impacts.forEach(imp => {
                            
                            // --- ★ 智能类型推断 (Duck Typing) & 标准化 ★ ---
                            let normalizedType = 'UNKNOWN';

                            // 规则1: 只要有 attrKey，就一定是属性变更
                            if (imp.attrKey) {
                                normalizedType = 'STAT_CHANGE';
                            }
                            // 规则2: 只要有 targetName 且没有 attrKey，大概率是地块转移
                            else if (imp.targetName && !imp.attrKey) {
                                normalizedType = 'REGION_TRANSFER';
                            }
                            // 规则3: 只要有 data 对象，就是创建实体
                            else if (imp.data && typeof imp.data === 'object') {
                                normalizedType = 'ENTITY_CREATE';
                            }
                            // 规则4: 只有 targetId，意图不明确，可能是移除
                            else if (imp.targetId && Object.keys(imp).length <= 2) {
                                normalizedType = 'ENTITY_REMOVE';
                            }
                            // ... 未来可以扩展更多规则

                            // 如果无法推断，则信任 AI 的原始 type (如果存在)
                            if (normalizedType === 'UNKNOWN' && imp.type) {
                                normalizedType = imp.type;
                            }
                            
                            imp.type = normalizedType; // ★ 强制覆盖 type

                            // --- ★ 标准化后的数据填充 ★ ---
                            
                            // 填充 STAT_CHANGE 类型
                            if (imp.type === 'STAT_CHANGE') {
                                // 兼容全局变量，AI 可能返回 "GLOBAL"，"Global" 等
                                if (imp.targetId && imp.targetId.toLowerCase() === 'global') {
                                    imp.targetId = 'global';
                                    imp.targetName = 'Global';
                                    imp.attrLabel = imp.attrKey; // 全局变量 key 就是 label
                                } else {
                                    const p = this.players.find(x => x.id === imp.targetId);
                                    imp.targetName = p ? p.name : 'Unknown';
                                    // 注意：这里需要遍历所有 rule_sets 来查找 label
                                    imp.attrLabel = this.getSchemaLabel(imp.attrKey, p ? p.schemaId : null);
                                }
                            }
                            
                            // 填充 oldValue (所有类型都可能需要)
                            if (imp.oldValue === undefined) imp.oldValue = "?";

                            this.editor.impacts.push(imp); 
                        });
                    }
                    this.showContextModal = false;
                } catch (e) { alert("AI Error: " + e.message); } 
                finally { this.isThinking = false; }
            },
            
            addImpact() {
                const impact = this.createImpactObject(this.impactForm);
                if (impact) {
                    this.editor.impacts.push(impact);
                    // 重置表单
                    this.impactForm.targetId = '';
                    this.impactForm.attrKey = '';
                    this.impactForm.newValue = '';
                    this.impactForm.targetName = '';
                }
            },
            removeImpact(idx) { this.editor.impacts.splice(idx, 1); },
            
            // [修复] 移除重复的、不完整的 addToStaging 定义，只保留这一个
            addToStaging() { 
                if (!this.editor.summary) return; 
                this.pendingEvents.push(JSON.parse(JSON.stringify({ 
                    ...this.editor, 
                    factionId: this.editor.factionId || 'global', 
                    timeStart: this.editor.timeStart || '?', 
                    timeEnd: this.editor.timeEnd || '?', 
                    content: this.editor.content || this.editor.summary, 
                    isOpen: false 
                }))); 
                // 清空编辑器
                this.editor.summary = ""; 
                this.editor.content = ""; 
                this.editor.impacts = []; 
                this.editor.options = []; // 这个在被删除的版本里漏掉了
                this.editor.factionId = ""; 
                this.editor.timeStart = ""; 
                this.editor.timeEnd = ""; 
                this.tabs.right = 'staging'; 
                this.saveGame('autosave.json'); 
            },

            loadFromStaging(i) { Object.assign(this.editor, JSON.parse(JSON.stringify(this.pendingEvents[i]))); this.pendingEvents.splice(i,1); this.tabs.right = 'input'; this.saveGame('autosave.json'); },
            commitTurn() {
                if(this.pendingEvents.length === 0) return;
                
                const numericIds = this.timeline.map(t => parseInt(t.id, 10)).filter(id => !isNaN(id));
                const maxId = numericIds.length > 0 ? Math.max(...numericIds) : 0;
                const range = this.pendingTurnRange || `Turn ${maxId + 1}`;
                
                const newEvents = JSON.parse(JSON.stringify(this.pendingEvents));
                
                // === 核心：遍历所有事件和 impact，应用世界变更 ===
                newEvents.forEach(evt => {
                    if (!evt.impacts) return;
                    
                    evt.impacts.forEach(imp => {
                        // 默认 impact 类型为 'STAT_CHANGE' 以兼容旧数据
                        const type = imp.type || 'STAT_CHANGE';

                        switch (type) {
                            case 'STAT_CHANGE':
                                // [修改] 增加对全局变量的判断
                                if (imp.targetId === 'global') {
                                    // 在全局变量数组中查找 key
                                    const gVar = this.global_vars.find(g => g.key === imp.attrKey);
                                    if (gVar) {
                                        gVar.value = imp.newValue; // 更新全局变量的值
                                    }
                                } else {
                                    // 原有的逻辑：更新实体属性
                                    const player = this.players.find(p => p.id === imp.targetId);
                                    if (player && imp.newValue !== undefined) { 
                                        player.stats[imp.attrKey] = imp.newValue; 
                                    }
                                }
                                break;
                            
                            case 'REGION_TRANSFER':
                                // 2. 地块控制权转移
                                // imp.targetName = region name, imp.newValue = new owner ID
                                const region = this.map_data.regions.find(r => r.name === imp.targetName);
                                if (region) {
                                    region.ownerId = imp.newValue;
                                } else {
                                    console.warn(`Region Transfer failed: Region '${imp.targetName}' not found.`);
                                }
                                break;

                            case 'ENTITY_CREATE':
                                // 3. 新建实体
                                // imp.data 包含新实体的信息
                                if (imp.data && imp.data.name) {
                                    const newEntity = {
                                        id: 'p' + Date.now() + Math.random().toString(16).slice(2),
                                        name: imp.data.name,
                                        logo: imp.data.logo || 'fa-solid fa-question',
                                        color: imp.data.color || '#cccccc',
                                        desc: imp.data.desc || '',
                                        stats: {}
                                    };
                                    // 确保新实体拥有所有基础属性
                                    this.stat_schema.forEach(s => {
                                        newEntity.stats[s.key] = (imp.data.stats && imp.data.stats[s.key]) ? imp.data.stats[s.key] : '-';
                                    });
                                    this.players.push(newEntity);
                                }
                                break;

                            case 'ENTITY_REMOVE':
                                // 4. 移除实体
                                // imp.targetId = entity ID to remove
                                const index = this.players.findIndex(p => p.id === imp.targetId);
                                if (index !== -1) {
                                    this.players.splice(index, 1);
                                }
                                break;
                            case 'PIN_MOVE':
                                // 5. 移动标记 [新增]
                                // imp.targetId = pin ID, imp.newValue = "x,y"
                                const pinToMove = this.map_data.pins.find(p => p.id === imp.targetId);
                                if (pinToMove && imp.newValue) {
                                    const parts = imp.newValue.split(/[,\s]+/); // 支持逗号或空格分隔
                                    if (parts.length >= 2) {
                                        const nx = parseFloat(parts[0]);
                                        const ny = parseFloat(parts[1]);
                                        if (!isNaN(nx) && !isNaN(ny)) {
                                            pinToMove.x = nx;
                                            pinToMove.y = ny;
                                        }
                                    }
                                }
                                break;
                        }
                    });
                });

                this.timeline.push({ id: maxId + 1, timeRange: range, events: newEvents });
                this.pendingEvents = []; 
                this.pendingTurnRange = ""; 
                this.saveGame('autosave.json');
                this.$nextTick(() => { 
                    const el = document.getElementById('timeline-scroll'); 
                    if(el) el.scrollTop = el.scrollHeight; 
                });
            },
            deleteTurn(tIdx) { if (confirm(`Delete Turn?`)) { this.timeline.splice(tIdx, 1); this.saveGame('autosave.json'); } },
            toggleEventOpen(event) { if(!this.editingEventId && !this.editingTurnId) event.isOpen = !event.isOpen; },
            isEditingEvent(t, e) { return this.editingEventId === `${t}-${e}`; },
            
            enableEventEdit(t, e) { 
                this.editingEventId = `${t}-${e}`; 
                this.editingTurnId = null;
                // 重置表单，默认类型为 STAT_CHANGE
                this.editImpactForm = { type: 'STAT_CHANGE', targetId: '', attrKey: '', newValue: '', targetName: '' };
            },
            
            // 新增：向历史事件添加 Impact
            addEventImpact(event) {
                const impact = this.createImpactObject(this.editImpactForm);
                if (impact) {
                    if (!event.impacts) event.impacts = [];
                    event.impacts.push(impact);
                    // 重置表单
                    this.editImpactForm.targetId = '';
                    this.editImpactForm.attrKey = '';
                    this.editImpactForm.newValue = '';
                    this.editImpactForm.targetName = '';
                }
            },
            
            // 新增：从历史事件移除 Impact
            removeEventImpact(event, idx) {
                event.impacts.splice(idx, 1);
            },

            saveTurnEdit() { this.editingTurnId = null; this.saveGame('autosave.json'); },
            saveEventEdit() { this.editingEventId = null; this.saveGame('autosave.json'); },
            deleteEvent(t,e) { if(confirm("Delete Event?")) { this.timeline[t].events.splice(e,1); this.saveGame('autosave.json'); } },
            saveSettings() { 
                const toSave = { api: this.settings.api, proxy: this.settings.proxy, prompts: this.settings.prompts, ui: this.ui }; // 新增 proxy
                localStorage.setItem('levant_settings', JSON.stringify(toSave));
                this.showSettings = false; 
                alert("Settings Saved!"); 
            },
            addLoreEntry() { this.lorebook.unshift({ keys: '', content: '', mode: 'auto' }); },
            cycleLoreMode(e) { const m=['on','auto','off']; e.mode = m[(m.indexOf(e.mode)+1)%3]; this.saveGame('autosave.json') },
            addSchemaField() { 
                const l=prompt("Label Name (e.g. 'Health', 'GDP')"); 
                if(l) { 
                    const k=prompt("Key (English, e.g. 'hp', 'gdp')"); 
                    if(k) { 
                        // 添加到当前规则集
                        this.getActiveSchemaFields().push({label:l, key:k}); 
                        // 初始化所有使用该规则集的实体
                        this.players.filter(p => p.schemaId === this.activeSchemaId).forEach(p => { 
                            if(!p.stats[k]) p.stats[k] = '-'; 
                        }); 
                        this.saveGame('autosave.json'); 
                    } 
                } 
            },
            copyToClipboard(t) { navigator.clipboard.writeText(t); },
            openFactionModal(p) { 
                if(p) { 
                    this.editingFaction = JSON.parse(JSON.stringify(p)); 
                    // 确保有 schemaId
                    if(!this.editingFaction.schemaId) this.editingFaction.schemaId = this.rule_sets[0]?.id || 'default';
                } else { 
                    // 新建实体
                    this.editingFaction = {
                        id:'', name:'', logo: 'fa-solid fa-users', color:'#ffffff', desc:'', 
                        parentId: '', 
                        schemaId: this.activeSchemaId || (this.rule_sets[0]?.id || 'default'), // 默认用当前正在查看的规则
                        stats:{}
                    }; 
                    // 预填空值
                    this.getFieldsBySchemaId(this.editingFaction.schemaId).forEach(s => this.editingFaction.stats[s.key]='-'); 
                } 
                this.showFactionModal = true; 
            },
            closeFactionModal() { this.showFactionModal = false; },
            saveFaction() { if(!this.editingFaction.name) return; if(this.editingFaction.id) { const i = this.players.findIndex(p => p.id === this.editingFaction.id); if(i !== -1) this.players[i] = JSON.parse(JSON.stringify(this.editingFaction)); } else { this.editingFaction.id = 'p'+Date.now(); this.players.push(JSON.parse(JSON.stringify(this.editingFaction))); } this.closeFactionModal(); this.saveGame('autosave.json'); },
            deleteFaction() { const i = this.players.findIndex(p => p.id === this.editingFaction.id); if(i !== -1 && confirm("Destroy Entity?")) { this.players.splice(i,1); this.closeFactionModal(); this.saveGame('autosave.json'); } },
            openScriptGenModal() { this.scriptGenPrompt = ''; this.scriptAttachments = []; this.showScriptGenModal = true; },
            
            // --- 查找并替换 methods 中的 generateScript ---

            async generateScript() {
                if (!this.settings.api.key) return alert("API Key missing");
                if (!confirm("确定覆盖当前进度？")) return;
                this.isThinking = true;
                
                const payload = { 
                    provider: this.settings.api.provider, 
                    apiKey: this.settings.api.key, 
                    baseUrl: this.settings.api.baseUrl, 
                    model: this.settings.api.model, 
                    useProxy: this.settings.proxy.enabled, 
                    proxyPort: this.settings.proxy.port, 
                    systemPrompt: this.settings.prompts.script_generator, 
                    context: `Req: "${this.scriptGenPrompt}"`, 
                    userPrompt: "Generate JSON.",
                    attachments: this.scriptAttachments 
                };

                try {
                    const res = await axios.post(`${API_BASE}/api/ai/generate`, payload);
                    const match = res.data.result.match(/\{[\s\S]*\}/);
                    if (!match) throw new Error("JSON Error");
                    
                    let newState = JSON.parse(match[0]);

                    // --- ★★★ 核心后处理逻辑开始 ★★★ ---
                    if (newState.timeline && newState.players) {
                        // 1. 创建一个玩家初始状态的快速查找表 (Map)
                        const playerStatsMap = new Map();
                        newState.players.forEach(p => playerStatsMap.set(p.id, p.stats));

                        // 2. 遍历 timeline 中的所有事件和 impact
                        newState.timeline.forEach(turn => {
                            turn.events?.forEach(event => {
                                event.impacts?.forEach(impact => {
                                    const initialStats = playerStatsMap.get(impact.targetId);
                                    
                                    // 3. 如果找到了对应的玩家和初始状态
                                    if (initialStats) {
                                        // 4. 将初始状态值赋给 oldValue
                                        impact.oldValue = initialStats[impact.attrKey] ?? "?";
                                    } else {
                                        // 如果没找到，则设为 '?'
                                        impact.oldValue = "?";
                                    }

                                    // 5. 确保 newValue 存在，防止 AI 遗漏
                                    if (impact.newValue === undefined) {
                                        impact.newValue = "?";
                                    }
                                });
                            });
                        });
                    }
                    // --- ★★★ 核心后处理逻辑结束 ★★★ ---


                    // (保留之前的 lorebook 容错处理)
                    if (newState.lorebook) {
                        newState.lorebook.forEach(entry => {
                            if (!entry.keys) {
                                entry.keys = entry.title || entry.key || entry.name || "未命名条目";
                            }
                            delete entry.title;
                        });
                    }

                    // (保留之前的 attrLabel 容错处理)
                    if(newState.timeline) {
                        const labelMap = {};
                        if(newState.stat_schema) newState.stat_schema.forEach(s => labelMap[s.key] = s.label);
                        
                        newState.timeline.forEach(t => {
                            if(t.events) t.events.forEach(e => {
                                if(e.impacts) e.impacts.forEach(i => {
                                    if(!i.attrLabel && labelMap[i.attrKey]) i.attrLabel = labelMap[i.attrKey];
                                });
                            });
                        });
                    }

                    this.applyState(newState);
                    this.showScriptGenModal = false;
                    this.scriptAttachments = []; 
                    this.scriptGenPrompt = '';
                } catch(e) { 
                    alert("Gen Failed: " + e.message); 
                } finally { this.isThinking = false; }
            },

            // --- [新增] 战斗系统相关方法 ---

            rollCombatDice() {
                if (this.isRollingDice || this.combatForm.dicePool.length === 0) return;
                
                this.isRollingDice = true;
                // 重置所有骰子结果为 null，这样 '-' 会重新显示
                this.combatForm.dicePool.forEach(d => d.val = null);
                
                let count = 0;
                // 动画持续时间更长一点，更有感觉
                const interval = setInterval(() => {
                    // 在动画过程中，为每个骰子赋予快速变化的随机值
                    this.combatForm.dicePool.forEach(d => {
                        const max = parseInt(d.type.substring(1));
                        // 这里显示的是过程值
                        d.val = Math.floor(Math.random() * max) + 1;
                    });
                    
                    count++;
                    // 动画迭代次数，可以调整
                    if (count >= 12) {
                        clearInterval(interval);
                        // 动画结束后，再进行一次最终的、真正的投掷
                        this.combatForm.dicePool.forEach(d => {
                            const max = parseInt(d.type.substring(1));
                            d.val = Math.floor(Math.random() * max) + 1;
                        });
                        // 稍作延迟再结束动画状态，让最终结果停留一下
                        setTimeout(() => {
                            this.isRollingDice = false;
                        }, 200);
                    }
                }, 60); // 间隔越小，数字跳动越快
            },

            getDiceColorClass(val, type) {
                const max = parseInt(type.substring(1));
                const ratio = val / max;
                if (ratio >= 0.95 || val === max) return 'text-amber-400'; // 大成功
                if (ratio <= 0.05 || val === 1) return 'text-red-500';   // 大失败
                if (ratio >= 0.6) return 'text-emerald-400';             // 成功
                return 'text-[var(--text-dim)]';                         // 普通/失败
            },

            getDiceText(val, type) {
                const max = parseInt(type.substring(1));
                const ratio = val / max;
                if (val === max) return "CRITICAL SUCCESS!";
                if (val === 1) return "CRITICAL FAILURE!";
                if (ratio >= 0.5) return "Pass";
                return "Fail";
            },
            addCombatDie() {
                this.combatForm.dicePool.push({ type: 'd20', val: null, label: '' });
            },
            getDieIcon(type) {
                switch(type) {
                    case 'd6': return 'fa-solid fa-dice-d6';
                    case 'd100': return 'fa-solid fa-dice'; // D100没有专用图标，用一个通用的
                    case 'd20':
                    default: return 'fa-solid fa-dice-d20';
                }
            },

            async executeCombat() {
                if (!this.settings.api.key) return alert("API Key missing");
                
                // 1. 准备数据
                const attacker = this.players.find(p => p.id === this.combatForm.attackerId);
                const defender = this.players.find(p => p.id === this.combatForm.defenderId);
                
                // --- 处理地点 ---
                let locStr = "未知/无特定地点";
                let locOwnerId = "";
                if (this.combatForm.locationId) {
                    // 尝试在 Regions 中找
                    const reg = this.map_data.regions.find(r => r.name === this.combatForm.locationId);
                    if (reg) {
                        const owner = this.getFactionName(reg.ownerId);
                        locOwnerId = reg.ownerId;
                        locStr = `[领土] ${reg.name} (控制方: ${owner}, ID: ${reg.ownerId})`;
                    } else {
                        // 尝试在 Pins 中找
                        const pin = this.map_data.pins.find(p => (p.label === this.combatForm.locationId || p.id === this.combatForm.locationId));
                        if (pin) locStr = `[标记点/设施] ${pin.label || "未命名点"}`;
                    }
                }

                // --- 处理骰子序列 (转为清晰的文本描述) ---
                // 格式示例: 
                // 1. [命中判定]: 18/20 (Success)
                // 2. [伤害判定]: 1/6 (Critical Failure)
                let diceAnalysis = this.combatForm.dicePool.map((d, i) => {
                    const max = parseInt(d.type.substring(1));
                    const desc = this.getDiceText(d.val, d.type);
                    const label = d.label ? `[${d.label}]` : `[第 ${i+1} 轮判定]`;
                    return `${i+1}. ${label}: 结果 ${d.val} (骰子 ${d.type}, 满分 ${max}) -> 判定: ${desc}`;
                }).join('\n   ');

                // --- 3. 组装终极 Prompt ---
                const systemPrompt = `你是一个严谨的 TRPG 战斗裁判与世界模拟引擎。你的任务是根据输入数据推演战斗结果。

            【核心裁决逻辑】
            1. **属性对抗**：对比攻守双方 Stats。强者通常胜出，但需结合骰子修正。
            2. **地点环境 (Location)**：
            - 当前地点为: ${locStr}。
            - 如果地点控制者 (Owner) 与某一方一致，该方享有“主场优势（补给/地形/情报）”。
            - 如果是险恶地形，双方可能都会受损。
            3. **骰子序列叙事 (Dice Sequence)**：
            - 用户提供了一组骰子，代表**连续的**或**多维度的**判定。
            - 你必须按顺序解释这些骰子。例如：骰子1(命中)大成功，但骰子2(伤害)大失败 -> 描述为“精准击中了敌人的盔甲缝隙，但武器却在关键时刻卡壳/断裂，仅造成轻微皮肉伤”。
            - **骰子结果是绝对客观事实，不可忽略。**
            4. **层级波及 (Hierarchy)**：
            - 如果一方是“子实体”（如：某军团），受损严重时，必须考虑对其“父实体”（如：所属国家）造成连带影响（如：国家威望下降、国家兵力减少）。

            【非常重要：JSON 输出格式】
            必须只返回一个 JSON 对象，严格遵守 TimelineEvent 结构。**Impacts 数组必须扁平化**。

            {
            "summary": "简短且具有冲击力的标题",
            "content": "详细的战报（>150字）。请结合“地点环境”进行景物描写，并根据“骰子序列”的每一步编写战斗转折...",
            "impacts": [
                {
                "type": "STAT_CHANGE",
                "targetId": "${attacker.id}",
                "attrKey": "manpower",  
                "oldValue": "...",
                "newValue": "..."
                },
                {
                "type": "STAT_CHANGE",
                "targetId": "${defender.id}",
                "attrKey": "stability",
                "oldValue": "...",
                "newValue": "..."
                },
                {
                "type": "REGION_TRANSFER",  // 仅在战斗意图是“攻占”且攻击方大胜时生成
                "targetName": "${this.combatForm.locationId}", // 必须使用输入的地点名
                "newValue": "${attacker.id}"
                }
            ]
            }

            【输入数据】
            [战斗背景]: ${this.combatForm.context || "遭遇战"}
            [战斗地点]: ${locStr}

            [攻击方]: ${attacker.name} (ID: ${attacker.id})
            - Parent: ${attacker.parentId || "None"}
            - Desc: ${attacker.desc}
            - Stats: ${JSON.stringify(attacker.stats)}

            [防御方]: ${defender.name} (ID: ${defender.id})
            - Parent: ${defender.parentId || "None"}
            - Desc: ${defender.desc}
            - Stats: ${JSON.stringify(defender.stats)}

            [命运骰子序列]:
            ${diceAnalysis}`;

                this.isThinking = true;

                const payload = {
                    provider: this.settings.api.provider,
                    apiKey: this.settings.api.key,
                    baseUrl: this.settings.api.baseUrl,
                    model: this.settings.api.model,
                    useProxy: this.settings.proxy.enabled,
                    proxyPort: this.settings.proxy.port,
                    systemPrompt: systemPrompt,
                    context: "Combat Simulation",
                    userPrompt: "Generate the JSON result based on the dice sequence and environment."
                };

                try {
                    const res = await axios.post(`${API_BASE}/api/ai/generate`, payload);
                    const match = res.data.result.match(/\{[\s\S]*\}/);
                    if (!match) throw new Error("Invalid JSON returned by AI");
                    
                    const combatEvent = JSON.parse(match[0]);
                    
                    // 自动补全
                    combatEvent.factionId = attacker.id;
                    combatEvent.timeStart = "Combat";
                    combatEvent.timeEnd = "End";
                    
                    // 填入编辑器
                    this.editor.factionId = combatEvent.factionId;
                    this.editor.summary = combatEvent.summary;
                    this.editor.content = combatEvent.content;
                    
                    // 解析 Impacts 确保格式正确
                    this.editor.impacts = [];
                    if (combatEvent.impacts) {
                        combatEvent.impacts.forEach(imp => {
                            if (!imp.oldValue) imp.oldValue = "?";
                            if (!imp.type) imp.type = "STAT_CHANGE";
                            
                            // 自动修复 Label
                            if (imp.type === 'STAT_CHANGE') {
                                const s = this.stat_schema.find(k => k.key === imp.attrKey);
                                imp.attrLabel = s ? s.label : imp.attrKey;
                                imp.targetName = this.getFactionName(imp.targetId);
                            } else if (imp.type === 'REGION_TRANSFER') {
                                imp.targetName = imp.targetName || "Region";
                                imp.attrLabel = "Control"; // 占位
                            }
                            
                            this.editor.impacts.push(imp);
                        });
                    }
                    
                    this.tabs.right = 'input'; 
                    
                } catch (e) {
                    alert("Combat Judge Error: " + e.message);
                } finally {
                    this.isThinking = false;
                }
            },
            // --- 新增: 上帝模式执行逻辑 ---
            async executeGodMode() {
                if (!this.settings.api.key) return alert("API Key missing");
                this.isThinking = true;

                // 1. 数据清洗，为 AI 准备上下文
                const safePlayers = this.players.map(p => {
                    const copy = { ...p };
                    if (this.isImage(copy.logo) && copy.logo.length > 100) {
                        copy.logo = "[IMAGE_DATA_OMITTED]";
                    }
                    return copy;
                });
                const safeRegions = (this.map_data.regions || []).map(r => {
                    const copy = { ...r };
                    if (copy.maskData) copy.maskData = "[MASK_DATA_OMITTED]"; 
                    copy.x = parseFloat(copy.x.toFixed(1));
                    copy.y = parseFloat(copy.y.toFixed(1));
                    copy.w = parseFloat(copy.w.toFixed(1));
                    copy.h = parseFloat(copy.h.toFixed(1));
                    copy.centerX = parseFloat(copy.centerX.toFixed(1));
                    copy.centerY = parseFloat(copy.centerY.toFixed(1));
                    return copy;
                });

                // --- 【核心修复】在这里定义 currentStateSlice ---
                const currentStateSlice = {
                    rule_sets: this.rule_sets,
                    global_vars: this.global_vars,
                    players: safePlayers,
                    map_data: {
                        regions: safeRegions,
                        // 也应该清洗 pins
                        pins: (this.map_data.pins || []).map(p => ({
                            id: p.id,
                            type: p.type,
                            label: p.label,
                            linkId: p.linkId,
                            x: parseFloat(p.x.toFixed(1)),
                            y: parseFloat(p.y.toFixed(1))
                        }))
                    }
                };
                // --- 修复结束 ---

                // 2. 准备发送给后端的 payload
                const payload = {
                    provider: this.settings.api.provider,
                    apiKey: this.settings.api.key,
                    baseUrl: this.settings.api.baseUrl,
                    model: this.settings.api.model,
                    useProxy: this.settings.proxy.enabled,
                    proxyPort: this.settings.proxy.port,
                    systemPrompt: this.settings.prompts.god_mode,
                    // 现在这里的 context 是有效的了
                    context: JSON.stringify(currentStateSlice),
                    userPrompt: `INSTRUCTION: ${this.godModeInput}`
                };

                try {
                    const res = await axios.post(`${API_BASE}/api/ai/generate`, payload);
                    const match = res.data.result.match(/\{[\s\S]*\}/);
                    if (!match) throw new Error("Invalid JSON returned by AI");
                    
                    const changes = JSON.parse(match[0]);
                    
                    for (const key in changes) {
                        if (key === 'players' && Array.isArray(changes.players)) {
                            const originalPlayersMap = new Map(this.players.map(p => [p.id, p]));
                            const updatedPlayers = changes.players.map(aiPlayer => {
                                const originalPlayer = originalPlayersMap.get(aiPlayer.id);
                                if (originalPlayer && aiPlayer.logo === "[IMAGE_DATA_OMITTED]") {
                                    aiPlayer.logo = originalPlayer.logo;
                                }
                                return aiPlayer;
                            });
                            this.players = updatedPlayers;
                        }
                        else if (key === 'map_data' && changes.map_data && Array.isArray(changes.map_data.regions)) {
                            const originalRegionsMap = new Map((this.map_data.regions || []).map(r => [r.id, r]));
                            const updatedRegions = changes.map_data.regions.map(aiRegion => {
                                const originalRegion = originalRegionsMap.get(aiRegion.id);
                                if (originalRegion && aiRegion.maskData === "[MASK_DATA_OMITTED]") {
                                    aiRegion.maskData = originalRegion.maskData;
                                }
                                return aiRegion;
                            });
                            this.map_data.regions = updatedRegions;
                        }
                        else if (Object.prototype.hasOwnProperty.call(this, key)) {
                            this[key] = changes[key];
                        }
                    }
                    
                    this.godModeInput = '';
                    this.saveGame('autosave.json');
                    alert("World Reality Rewritten.");
                } catch(e) {
                    alert("God Mode Failed: " + e.message);
                } finally {
                    this.isThinking = false;
                }
            }
        }
    }).mount('#app');
</script>
</body>
</html>