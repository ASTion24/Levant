<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LEVANT 自动化推演</title>
    <link rel="icon" href="logo.png" type="image/png"> 
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="capacitor-filesystem.js"></script>
    <!-- ★★★ 新增：Levant Native Adapter ★★★ -->
    <script src="api_layer.js"></script>
    
    <style>
        /* --- ★★★ 命运投掷仪式感动画 ★★★ --- */
        .dice-overlay-backdrop {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            perspective: 1000px; /* 3D 透视 */
        }

        /* 骰子容器：浮动感 */
        .ceremony-die-container {
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* 阶段一：剧烈震动 (Shaking) */
        @keyframes dice-shake-violent {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .anim-shake-violent {
            animation: dice-shake-violent 0.05s infinite;
            color: #94a3b8; /* 灰色 */
            filter: blur(1px); /* 运动模糊 */
        }

        /* 阶段二：结果落地 (Impact) */
        @keyframes dice-impact {
            0% { transform: scale(3) rotateY(180deg); opacity: 0; filter: blur(10px); }
            50% { transform: scale(0.9); opacity: 1; filter: blur(0px); }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .anim-impact {
            animation: dice-impact 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }

        /* 大成功光效 */
        .crit-success-glow {
            box-shadow: 0 0 50px rgba(251, 191, 36, 0.6); /* Amber glow */
            border-color: #fbbf24 !important;
            color: #fbbf24 !important;
            transform: scale(1.1);
        }
        
        /* 大失败光效 */
        .crit-fail-glow {
            box-shadow: 0 0 50px rgba(239, 68, 68, 0.6); /* Red glow */
            border-color: #ef4444 !important;
            color: #ef4444 !important;
            transform: scale(0.95) rotate(5deg);
        }
        /* ★★★ [新增] 对话气泡小三角 ★★★ */
        .speech-bubble {
            position: relative;
        }

        .speech-bubble::before {
            content: '';
            position: absolute;
            left: -10px; /* 三角形指向左侧 */
            top: 14px; /* 对齐头像中间位置 */
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 10px solid var(--bg-badge); /* 三角形颜色和背景一致 */
            filter: drop-shadow(-1px 0 0 var(--border-dim)); /* 给三角形加个边框，更融合 */
        }
        /* --- Logo 浮现动画 --- */
        .fade-slide-up-enter-active {
            transition: all 1.2s cubic-bezier(0.22, 1, 0.36, 1); /* 这种贝塞尔曲线会有弹性的感觉 */
        }
        .fade-slide-up-enter-from {
            opacity: 0;
            transform: translateY(40px) scale(0.95);
            filter: blur(10px);
        }
        .fade-slide-up-enter-to {
            opacity: 1;
            transform: translateY(0) scale(1);
            filter: blur(0);
        }
/* --- 截图模式专用样式 --- */
        .screenshot-overlay {
            position: fixed;
            pointer-events: none; /* 让鼠标事件穿透，以便 JS 计算下方的元素 */
            z-index: 99999;
            border: 2px solid #00ff00; /* 亮绿色边框 */
            background-color: rgba(0, 255, 0, 0.1); /* 淡淡的绿色遮罩 */
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5), inset 0 0 10px rgba(0, 255, 0, 0.2);
            transition: all 0.1s ease-out; /* 平滑跟随 */
            border-radius: 4px;
        }

        /* 截图时的提示文字 */
        .screenshot-label {
            position: absolute;
            top: -24px;
            left: 0;
            background: #00ff00;
            color: #000;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 2px;
            font-family: monospace;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* 截图时的全屏遮罩，防止误触其他按钮 */
        .screenshot-backdrop {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            cursor: crosshair; /* 十字准星光标 */
            z-index: 99998;
            background: rgba(0,0,0,0.01); /* 几乎透明，用于捕获点击 */
        }
        /* --- 核心配色 (CSS Variables) - 美学优化版 --- */
        :root {
            /* Terminal / Dark Theme - 增加深邃感与霓虹辉光 */
            --bg-deep: #030508;         /* 更深邃的黑 */
            --bg-panel: rgba(10, 15, 24, 0.7); /* 降低不透明度，配合模糊 */
            --bg-sidebar: #05080c;
            --bg-header: rgba(5, 8, 12, 0.8);
            --bg-input: rgba(0, 0, 0, 0.3);
            --bg-input-focus: rgba(15, 23, 42, 0.8);
            --bg-glass: rgba(13, 19, 30, 0.65); /* 更通透的玻璃 */
            --bg-card: rgba(30, 41, 59, 0.3);
            --bg-badge: rgba(255, 255, 255, 0.03);
            --bg-hover: rgba(255, 255, 255, 0.08);
            
            --text-main: #e2e8f0;       
            --text-dim: #64748b;        
            --text-accent: #818cf8;     /* 更柔和的靛蓝 */
            --text-danger: #f87171;     
            --text-inverse: #000000;    
            
            --border-highlight: rgba(255, 255, 255, 0.12); /* 提亮边框 */
            --border-dim: #1e293b;      
            
            --shadow-color: rgba(0, 0, 0, 0.8);
            --font-main: 'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif; /* 推荐 Inter */
            --font-mono: 'JetBrains Mono', 'Fira Code', monospace;

            --radius-panel: 12px; /* 稍微加大圆角，更现代 */
            --radius-btn: 6px;
            
            --texture-overlay: none;
        }

        /* 主题：报社 (Newspaper / Light) - 增强纸张纹理与油墨感 */
        [data-theme="newspaper"] {
            --bg-deep: #f0ebe3;       /* 暖色调羊皮纸背景 */
            --bg-panel: #fdfbf7;      
            --bg-sidebar: #eaddcf;    /* 侧边栏稍深 */
            --bg-header: #e6e0d4;     
            --bg-input: #faf9f6;      
            --bg-input-focus: #ffffff;
            --bg-glass: rgba(253, 251, 247, 0.95);
            --bg-card: #fdfbf7;
            --bg-badge: rgba(0,0,0,0.03);
            --bg-hover: rgba(0,0,0,0.06);

            --text-main: #2c2c2c;     /* 柔和的墨色，非纯黑 */
            --text-dim: #66605b;      
            --text-accent: #8b1c1c;   /* 更加复古的深红 */
            --text-danger: #b91c1c;
            --text-inverse: #ffffff;

            --border-highlight: rgba(0,0,0,0.08);
            --border-dim: #b8b2a7;    /* 配合纸张颜色的边框 */
            
            --shadow-color: rgba(60, 50, 40, 0.1); /* 暖色调阴影 */
            
            --font-main: 'Georgia', 'Source Han Serif CN', 'Songti SC', serif; 
            --font-mono: 'Courier Prime', 'Courier New', monospace;      

            --radius-panel: 2px; /* 近乎直角 */
            --radius-btn: 2px;

            /* 更细腻的纸张噪点 */
            --texture-overlay: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
        }

        body { 
            background-color: var(--bg-deep); 
            color: var(--text-main); 
            font-family: var(--font-main); 
            font-size: 16px; 
            overflow: hidden; 
            line-height: 1.6; 
            transition: background-color 0.3s, color 0.3s;
        }

        /* 纹理层 */
        .app-texture {
            position: absolute; inset: 0; pointer-events: none; z-index: 1;
            background-image: var(--texture-overlay);
            opacity: 0.6; mix-blend-mode: multiply;
        }

        /* --- 通用圆角类 (适配不同主题) --- */
        .theme-rounded { border-radius: var(--radius-panel); }
        .theme-rounded-sm { border-radius: var(--radius-btn); }
        
        /* 报社模式下的特殊边框风格 */
        [data-theme="newspaper"] header { border-bottom: 3px double var(--border-dim); }
        [data-theme="newspaper"] aside { border-right: 1px solid var(--border-dim); }
        [data-theme="newspaper"] .info-card { border: 1px solid var(--border-dim); box-shadow: 2px 2px 0px rgba(0,0,0,0.1); }
        [data-theme="newspaper"] .modal-mask .glass-panel { border: 4px double #444; box-shadow: 10px 10px 0px rgba(0,0,0,0.2); }

        /* --- 滚动条 --- */
        /* [新增] 移动端触摸屏适配：强制显示 hover 元素 */
        @media (hover: none) {
            .group:hover .group-hover\:opacity-100,
            .group .group-hover\:opacity-100 {
                opacity: 1 !important;
            }
            /* 同样处理 flex 布局的隐藏元素 */
            .group:hover .group-hover\:flex,
            .group .group-hover\:flex {
                display: flex !important;
            }
        }

        /* --- 极简滚动条 --- */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { 
            background: var(--border-dim); 
            border-radius: 4px; 
            transition: background 0.3s;
        }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }
        /* 报社模式下滚动条稍微明显一点 */
        [data-theme="newspaper"] ::-webkit-scrollbar { width: 6px; }
        [data-theme="newspaper"] ::-webkit-scrollbar-thumb { background: #d1cdc7; border-radius: 0; }
        [data-theme="newspaper"] ::-webkit-scrollbar-thumb:hover { background: #8b1c1c; }

        /* [新增] 移动端平滑滚动支持 (iOS) */
        .overflow-y-auto {
            -webkit-overflow-scrolling: touch;
        }

        /* --- 组件风格优化 --- */
        .glass-panel { 
            background: var(--bg-glass); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-highlight);
            border-top: 1px solid rgba(255,255,255,0.15); /* 顶部高光 */
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); 
        }
        /* --- ★★★ [性能优化] 地图拖拽时禁用子元素交互 ★★★ --- */
        .map-dragging .pointer-events-auto {
            pointer-events: none !important;
        }
        /* 优化图层渲染，开启 GPU 加速 */
        .map-layer-optimized {
            will-change: transform, opacity;
        }

        .info-card {
            background: var(--bg-card);
            border: 1px solid var(--border-highlight);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        /* 报社模式去除卡片圆角，增加双线边框 */
        [data-theme="newspaper"] .info-card {
            border: 1px solid var(--border-dim);
            box-shadow: 2px 2px 0 var(--border-dim); /* 硬阴影模拟印刷品 */
        }
        
        .info-card:hover {
            border-color: var(--text-accent);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px var(--shadow-color);
            background: linear-gradient(to bottom right, var(--bg-card), var(--bg-hover)); /* 微妙的渐变光 */
        }
        [data-theme="newspaper"] .info-card:hover {
            transform: translateY(-1px);
            box-shadow: 3px 3px 0 var(--text-accent); /* 悬浮时阴影变色 */
        }

        .font-mono-tech { 
            font-family: var(--font-mono); 
            letter-spacing: -0.02em; /* 代码体稍微紧凑一点更易读 */
        }
        /* 标题类需要更宽的间距 */
        header h1, .uppercase {
            letter-spacing: 0.05em;
        }

        /* 输入框优化 */
        .input-tech {
            background: var(--bg-input); 
            border: 1px solid transparent; /* 默认无边框，只显示底色 */
            border-bottom: 1px solid var(--border-dim); /* 仅保留底边框增强设计感 */
            color: var(--text-main); 
            transition: all 0.3s ease;
        }
        .input-tech:focus { 
            border-color: var(--text-accent); 
            background: var(--bg-input-focus);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        [data-theme="newspaper"] .input-tech {
            background: transparent;
            border: 1px solid var(--border-dim);
            font-family: 'Courier Prime', monospace;
        }

        /* --- 模态框 --- */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.75); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
        }

        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        /* --- 启动页专用过渡 --- */
        .splash-leave-active { 
            /* 时间缩短为 0.8s，使用 cubic-bezier 模拟起步慢、后段极速的加速感 */
            transition: all 0.8s cubic-bezier(0.7, 0, 1, 1);
            /* 确保变换以屏幕中心为原点 */
            transform-origin: center center;
        }

        .splash-leave-to { 
            opacity: 0; 
            /* 1. 剧烈放大：模拟穿过画面 */
            transform: scale(4) perspective(500px); 
            /* 2. 视觉特效：增加模糊(速度感) + 亮度爆表(能量感) */
            filter: blur(20px) brightness(2.5); 
            pointer-events: none; 
        }
        /* 当启动页正在消失时，让背景网格和扫描线先隐形，突出 Logo 的飞出 */
        .splash-leave-active .synthwave-grid,
        .splash-leave-active .scanlines-retro,
        .splash-leave-active .cyber-halo {
            transition: opacity 0.3s ease; /* 0.3s 快速消失 */
            opacity: 0 !important;
        }
        /* --- 复古未来 (Retro-Future) 启动页样式 --- */
        .retro-bg {
            /* 优化：增加噪点叠加和更深的暗角，提升电影感 */
            background-color: #020617;
            background-image: 
                radial-gradient(circle at center top, #2e1065 0%, #020617 70%),
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            background-blend-mode: overlay;
            box-shadow: inset 0 0 150px rgba(0,0,0,0.9); /* 强力暗角 */
        }

        .synthwave-grid {
            background-image: 
                linear-gradient(rgba(192, 38, 211, 0.4) 1px, transparent 1px),
                linear-gradient(90deg, rgba(192, 38, 211, 0.4) 1px, transparent 1px);
            background-size: 60px 60px;
            background-position: center center;
            transform: perspective(300px) rotateX(60deg) scale(2) translateY(0);
            transform-origin: center bottom;
            opacity: 0.3; /* 调低透明度，让它不那么抢眼 */
            animation: grid-fly 4s linear infinite;
            /* 优化：更柔和的渐变遮罩，消除硬边 */
            mask-image: linear-gradient(to top, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 60%); 
            -webkit-mask-image: linear-gradient(to top, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 60%);
        }

        @keyframes grid-fly {
            0% { background-position: center 0; }
            100% { background-position: center 60px; }
        }

        .scanlines-retro {
            background: linear-gradient(
                to bottom,
                rgba(18, 16, 16, 0) 50%,
                rgba(0, 0, 0, 0.25) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
        }

        /* 铬金文字渐变效果 */
        .chrome-text {
            background: linear-gradient(to bottom, #22d3ee 0%, #e879f9 50%, #ffffff 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 20px rgba(34, 211, 238, 0.5);
        }

        /* 霓虹呼吸 */
        @keyframes neon-glow {
            0%, 100% { filter: drop-shadow(0 0 5px rgba(168, 85, 247, 0.6)) drop-shadow(0 0 15px rgba(34, 211, 238, 0.4)); }
            50% { filter: drop-shadow(0 0 20px rgba(168, 85, 247, 0.8)) drop-shadow(0 0 30px rgba(34, 211, 238, 0.6)); transform: scale(1.02); }
        }
         /* --- [新增] 赛博光晕背景 --- */
        .cyber-halo {
            background: 
                radial-gradient(circle at center, rgba(34, 211, 238, 0.3) 0%, transparent 60%),
                conic-gradient(from 0deg, transparent 0%, rgba(168, 85, 247, 0.1) 50%, transparent 100%);
            filter: blur(60px); /* 增加模糊度，使光感更朦胧 */
            mix-blend-mode: screen; /* 让光效叠加更亮 */
            animation: halo-breathe 8s infinite ease-in-out; /* 放慢呼吸节奏 */
            pointer-events: none;
        }
        /* --- 无缝滚动核心样式 --- */
        @keyframes scroll-seamless {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); } /* 只移动总宽度的一半（即一份文本+间距的长度） */
        }
        
        .animate-scroll-seamless {
            display: flex;
            width: max-content; /* 让宽度根据内容自动撑开 */
            animation: scroll-seamless 10s linear infinite; /* 10秒循环一次，匀速 */
        }
        
        /* 左右淡出遮罩，让滚动看起来更自然 */
        .mask-sides {
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }
        @keyframes halo-breathe {
            0%, 100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
        }
        /* 状态变更框 */
        .impact-badge {
            display: inline-flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem;
            border-width: 1px; font-size: 0.9rem;
            box-shadow: 0 2px 5px var(--shadow-color); backdrop-filter: blur(4px);
            white-space: nowrap; color: var(--text-main);
            border-radius: var(--radius-btn);
        }

        /* Markdown */
        .md-content { font-size: 0.95rem; line-height: 1.75; }
        .md-content h1, .md-content h2 { 
            color: var(--text-main); 
            font-weight: 800; 
            margin-top: 1.5em; 
            margin-bottom: 0.75em; 
            border-bottom: 1px solid var(--border-dim); 
            padding-bottom: 0.3em; 
            font-size: 1.25rem;
            letter-spacing: 0.02em;
        }
        .md-content p { margin-bottom: 1.2em; text-align: justify; opacity: 0.95; }
        .md-content strong { color: var(--text-accent); font-weight: 700; }

        /* ★★★ [新增] Markdown 链接样式 ★★★ */
        .md-content a {
            color: #34d399; /* 亮翡翠绿，醒目 */
            text-decoration: underline; /* 下划线 */
            text-underline-offset: 4px; /* 下划线稍微离文字远一点，更好看 */
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .md-content a:hover {
            color: #10b981; /* 悬停变深 */
            background: rgba(16, 185, 129, 0.1); /* 增加背景色块 */
            border-radius: 4px;
        }

        /* 报社模式特殊排版 */
        [data-theme="newspaper"] .md-content h1 { 
            text-align: center; 
            border-bottom: 3px double var(--text-main); 
            text-transform: uppercase;
        }
        [data-theme="newspaper"] .md-content p::first-letter {
            font-weight: bold;
            font-size: 1.1em;
        }

        /* 背景LOGO */
        .event-card-bg-logo { 
            position: absolute; top: -10px; right: -20px; font-size: 220px; opacity: 0.04; 
            transform: rotate(-10deg); transition: all 0.5s ease; z-index: 0; pointer-events: none;
        }
        .group\/event:hover .event-card-bg-logo { opacity: 0.08; transform: rotate(0deg) scale(1.05); }

        /* --- 上下文拖拽列表样式 --- */
        .context-item {
            display: flex; align-items: center; gap: 10px; padding: 8px;
            background: var(--bg-badge); border: 1px solid var(--border-highlight);
            margin-bottom: 4px; transition: all 0.2s; cursor: grab;
            color: var(--text-main);
            border-radius: var(--radius-btn);
        }
        .context-item:hover { background: var(--bg-hover); }
        .context-item:active { cursor: grabbing; }
        .context-item.active { border-left: 3px solid #10b981; }
        .context-item.disabled { opacity: 0.5; }
        /* --- ★★★ [优化版] Galgame / VN 模式专用样式 ★★★ --- */
        .vn-container {
            position: absolute; inset: 0; z-index: 900;
            background-color: #000;
            display: flex; flex-direction: column;
            overflow: hidden;
            font-family: "Noto Serif SC", "Songti SC", serif; /* 剧情模式推荐衬线体 */
        }

        /* 1. 动态背景：缓慢缩放，营造电影感 */
        @keyframes bg-pan {
            0% { transform: scale(1.05); }
            100% { transform: scale(1.15); }
        }
        .vn-background {
            position: absolute; inset: -20px; z-index: 0;
            background-size: cover; background-position: center;
            filter: brightness(0.4) blur(2px); /* 压暗背景，突出人物 */
            animation: bg-pan 20s alternate infinite linear;
        }

        /* 2. 立绘层：增加呼吸效果 */
        .vn-tachie-stage {
            position: absolute; inset: 0; z-index: 10;
            display: flex; justify-content: center; align-items: flex-end;
            pointer-events: none;
            padding-bottom: 0; 
        }

        /* 立绘呼吸动画 */
        @keyframes tachie-breathe {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-3px) scale(1.005); }
        }

        .vn-tachie-img {
            height: 95%; width: auto; max-width: none;
            filter: drop-shadow(0 0 15px rgba(0,0,0,0.5));
            animation: tachie-breathe 4s ease-in-out infinite;
            transform-origin: bottom center;
            transition: filter 0.3s;
        }

        /* 3. 对话框 UI：现代黑金/科技风格 */
        .vn-ui-layer {
            position: absolute; bottom: 0; left: 0; right: 0; height: 320px; z-index: 100;
            background: linear-gradient(to top, rgba(0,0,0,1) 10%, rgba(0,0,0,0.8) 40%, transparent 100%);
            display: flex; flex-direction: column; justify-content: flex-end;
            padding: 0 5% 40px 5%;
            cursor: pointer;
        }

        /* 名字铭牌 */
        .vn-name-box {
            align-self: flex-start;
            background: rgba(0, 0, 0, 0.8);
            border-left: 4px solid #fff;
            padding: 8px 24px;
            margin-bottom: 10px;
            transform: skewX(-15deg); /* 倾斜设计 */
            box-shadow: 5px 5px 0 rgba(0,0,0,0.3);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 10px;
        }
        .vn-name-text {
            transform: skewX(15deg); /* 文字反倾斜 */
            font-size: 24px; font-weight: 900; color: #fff;
            letter-spacing: 0.05em;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        /* 文本框 */
        .vn-text-box {
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 4px;
            padding: 25px 40px;
            min-height: 160px;
            position: relative;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
        }
        /* 装饰线 */
        .vn-text-box::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
        }

        .vn-text-content {
            font-size: 20px; line-height: 1.7; color: #e2e8f0;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            flex: 1;
        }

        /* 旁白模式特殊样式 */
        .vn-text-box.narrator-mode {
            background: rgba(0, 0, 0, 0.6);
            border: none;
            text-align: center;
            display: flex; align-items: center; justify-content: center;
            font-style: italic;
        }
        .vn-text-box.narrator-mode .vn-text-content {
            color: #94a3b8; font-size: 22px;
        }

        /* 下一句提示符 (跳动三角形) */
        .vn-next-indicator {
            position: absolute; bottom: 15px; right: 20px;
            font-size: 14px; color: #38bdf8;
            animation: bounce 1s infinite;
        }

        /* 4. 选项层优化 */
        .vn-options-overlay {
            position: absolute; inset: 0; z-index: 200;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 24px;
            animation: fadeIn 0.5s ease;
        }
        .vn-option-btn {
            width: 70%; max-width: 800px; padding: 25px 40px;
            background: linear-gradient(90deg, rgba(15, 23, 42, 0.9) 0%, rgba(15, 23, 42, 0.7) 100%);
            border: 1px solid rgba(56, 189, 248, 0.3);
            border-left: 6px solid #38bdf8;
            color: #fff; font-size: 18px; font-weight: bold; text-align: left;
            transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
            cursor: pointer; position: relative; overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .vn-option-btn:hover {
            transform: translateX(20px);
            background: rgba(56, 189, 248, 0.15);
            border-color: #38bdf8;
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
        }
        .vn-option-btn::after {
            content: 'DECISION'; position: absolute; right: 10px; bottom: 5px;
            font-size: 60px; font-weight: 900; color: rgba(255,255,255,0.03);
            font-style: italic; pointer-events: none;
        }
        
        /* --- 海报生成专用样式 --- */
        #poster-canvas {
            position: fixed; left: -9999px; top: 0; width: 1080px; padding: 0; margin: 0;
            box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden;
        }
        
        /* Style 1: Cyberpunk Terminal (暗色终端风格修正) */
        /* Style 1: Cyberpunk Terminal (完全还原 v1.3.1 样式) */
        .poster-terminal {
            width: 100%; height: 100%; min-height: 1200px;
            background: linear-gradient(to bottom, #0f1623, #05080c);
            color: white; font-family: 'PingFang SC', sans-serif;
            border-left-width: 24px; position: relative; display: flex; flex-direction: column;
        }
        .poster-terminal .bg-texture {
            position: absolute; inset: 0; z-index: 0; opacity: 0.05; pointer-events: none;
            background-image: radial-gradient(#94a3b8 1px, transparent 1px); background-size: 40px 40px;
        }
        .poster-terminal .poster-header {
            padding: 60px 70px; background: rgba(0,0,0,0.2); border-bottom: 2px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 10;
        }
        .poster-terminal .poster-body { padding: 50px 70px; position: relative; z-index: 10; flex: 1; }
        .poster-terminal h1 {
            font-size: 64px; line-height: 1.2; font-weight: 900; color: #fff; margin-bottom: 50px; letter-spacing: -0.02em;
            border-bottom: 2px solid #334155; padding-bottom: 20px;
        }
        .poster-terminal .md-body { font-size: 28px; line-height: 1.8; color: #cbd5e1; }
        .poster-terminal .md-body strong { color: #f59e0b; font-weight: bold; }

        /* 关键修复：徽章容器 */
        .poster-terminal .poster-badge-container {
            margin-bottom: 50px; display: flex; flex-direction: column; gap: 20px; position: relative; z-index: 10;
        }
        /* 关键修复：徽章本体（Flex布局） */
        .poster-terminal .poster-badge {
            display: flex; height: 64px; 
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; overflow: hidden; backdrop-filter: blur(10px);
        }
        /* 关键修复：徽章左侧 */
        .poster-terminal .poster-badge-left {
            display: flex; align-items: center; justify-content: center; 
            padding: 0 30px; padding-bottom: 4px; /* 微调对齐 */
            min-width: 200px; 
            background: rgba(0,0,0,0.2); border-right: 1px solid rgba(255,255,255,0.1);
            font-weight: 800; font-size: 22px; gap: 14px; height: 100%; color: inherit;
        }
        /* 关键修复：徽章右侧 */
        .poster-terminal .poster-badge-right {
            display: flex; align-items: center; 
            padding: 0 30px; padding-bottom: 4px; /* 微调对齐 */
            flex: 1;
            font-family: 'JetBrains Mono', monospace; font-size: 22px; height: 100%; line-height: 1;
        }

        .poster-terminal .poster-footer {
            padding: 40px 70px; background: rgba(0,0,0,0.4); border-top: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center; font-family: 'JetBrains Mono', monospace;
            color: #64748b; font-size: 18px; text-transform: uppercase; letter-spacing: 0.1em; position: relative; z-index: 10;
        }
        /* Style 2: Vintage Newspaper */
        .poster-newspaper {
            width: 100%; height: 100%; min-height: 1200px;
            background-color: #f4f1ea; color: #1a1a1a;
            font-family: 'Georgia', 'Songti SC', serif;
            position: relative; display: flex; flex-direction: column;
            padding: 60px;
        }
        .poster-newspaper .paper-grain {
            position: absolute; inset: 0; opacity: 0.15; z-index: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }
        .poster-newspaper .news-header {
            border-bottom: 4px double #1a1a1a; 
            padding-bottom: 15px; 
            
            /* --- 关键修改 --- */
            /* 原来可能是 40px，现在改为 15px */
            /* 作用：减少刊头和标题之间的空白，让标题往上走 */
            margin-bottom: 15px; 
            
            text-align: center; 
            position: relative; 
            z-index: 10;
        }
        .poster-newspaper .brand { font-size: 80px; font-weight: 900; letter-spacing: -0.02em; text-transform: uppercase; line-height: 1; margin-bottom: 50px; }
        .poster-newspaper .meta { display: flex; justify-content: space-between; border-top: 1px solid #1a1a1a; border-bottom: 1px solid #1a1a1a; padding: 10px 0; font-family: 'Courier New', monospace; font-size: 20px; text-transform: uppercase; font-weight: bold; }
        
        .poster-newspaper .headline { 
            font-size: 72px; 
            line-height: 1.1; 
            font-weight: 900; 
            
            /* --- 关键修改 --- */
            margin-top: 0;       /* 确保标题顶部没有多余间隙 */
            /* 原来可能是 20px，现在改为 50px */
            /* 作用：给下方的红色倾斜印章留出足够的旋转空间，防止重叠 */
            margin-bottom: 50px; 
            
            text-align: center; 
            font-family: 'Times New Roman', serif; 
            position: relative; 
            z-index: 10; 
        }
        
        .poster-newspaper .content-cols {
            column-count: 2; 
            column-gap: 60px; 
            font-size: 26px; 
            line-height: 1.6; 
            text-align: justify; 
            position: relative; 
            z-index: 10;
            
            /* --- 核心修复代码 --- */
            /* 1. 增加底部边距，强制把底部的双线栏顶下去，防止重叠 */
            margin-bottom: 80px; 
            
            /* 2. 自动占据剩余空间，但配合上面的margin确保不压线 */
            flex: 1; 
        }
        
        /* 1. 徽章容器：调整间距，防止正文过高 */
        .poster-newspaper .badges-row { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 30px; /* 增加水平间距，防止印章挤在一起 */
            margin-bottom: 30px; /* 减小下方外边距，让正文上移 */
            justify-content: center; 
            position: relative; 
            z-index: 10; 
            border-bottom: 2px solid #1a1a1a; 
            padding-bottom: 25px; /* 稍微留一点呼吸空间给旋转的印章 */
        }

        /* 2. 红色倾斜印章：核心样式找回 */
        .poster-newspaper .stamp-badge {
            border: 3px solid #8b0000; /* 加粗边框，更有印章感 */
            color: #8b0000; 
            padding: 8px 18px; 
            
            /* --- 关键：倾斜效果 --- */
            transform: rotate(-3deg); 
            
            font-family: 'Courier New', monospace; 
            font-weight: 900; 
            font-size: 22px;
            display: flex; 
            align-items: center; 
            gap: 10px; 
            text-transform: uppercase;
            background: transparent; 
            /* 增加一点粗糙的阴影，模拟印泥未干 */
            text-shadow: 1px 1px 0px rgba(139, 0, 0, 0.1);
            box-shadow: 2px 2px 0px rgba(139, 0, 0, 0.1);
        }
        /* [升级] 骰子滚动动画 - 幅度更大 */
        @keyframes dice-shake {
            0%, 100% { transform: rotate(0deg) scale(1); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(-8deg) scale(1.2); } /* 幅度更大 */
            20%, 40%, 60%, 80% { transform: rotate(8deg) scale(1.2); }  /* 幅度更大 */
        }
        .dice-rolling-animation {
            animation: dice-shake 0.8s cubic-bezier(.36,.07,.19,.97) both;
            color: var(--text-accent) !important;
        }

        /* ★★★ [修改] 新版彩蛋特效：核心共鸣 ★★★ */
        .core-overlay {
            position: fixed; inset: 0; z-index: 999999;
            background: radial-gradient(circle at center, rgba(15, 23, 42, 0.9) 0%, #000000 100%);
            backdrop-filter: blur(10px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: auto;
            animation: core-fade-in 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }

        .core-container {
            position: relative;
            width: 300px; height: 300px;
            display: flex; justify-content: center; align-items: center;
            transform-style: preserve-3d;
            animation: core-float 6s ease-in-out infinite;
        }

        /* 核心 Logo */
        .core-logo-img {
            width: 180px; height: 180px; object-fit: contain;
            filter: drop-shadow(0 0 20px rgba(56, 189, 248, 0.6));
            animation: core-pulse 4s ease-in-out infinite;
            z-index: 10;
        }

        /* 外部旋转环 */
        .core-ring {
            position: absolute; inset: 0;
            border: 1px solid rgba(56, 189, 248, 0.3);
            border-top: 1px solid rgba(56, 189, 248, 0.9);
            border-bottom: 1px solid rgba(56, 189, 248, 0.9);
            border-radius: 50%;
            animation: core-spin 10s linear infinite;
        }
        .core-ring::before {
            content: ''; position: absolute; inset: -10px;
            border: 1px dashed rgba(168, 85, 247, 0.3);
            border-radius: 50%;
            animation: core-spin-rev 15s linear infinite;
        }

        .core-text {
            margin-top: 60px;
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
        }
        .core-title {
            font-size: 1.5rem; letter-spacing: 0.5em; font-weight: 300;
            margin-bottom: 10px;
            background: linear-gradient(to right, #38bdf8, #a855f7);
            -webkit-background-clip: text; background-clip: text; color: transparent;
        }
        .core-subtitle {
            font-size: 0.75rem; letter-spacing: 0.2em; opacity: 0.5;
            animation: blink 2s infinite;
        }
        /* 主角模式：对话框变色，且名字靠右 (或是其他你喜欢的样式) */
        .vn-text-box.protagonist-mode {
            border-left: 4px solid #818cf8; /* Indigo */
            background: linear-gradient(90deg, rgba(15, 23, 42, 0.9) 0%, rgba(49, 46, 129, 0.4) 100%);
        }
        .vn-text-box.protagonist-mode .vn-text-content {
            font-style: normal;
            color: #e0e7ff;
        }

        @keyframes core-fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes core-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        @keyframes core-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes core-spin-rev { from { transform: rotate(360deg); } to { transform: rotate(0deg); } }
        @keyframes core-pulse { 
            0%, 100% { filter: drop-shadow(0 0 20px rgba(56, 189, 248, 0.4)); transform: scale(1); } 
            50% { filter: drop-shadow(0 0 50px rgba(168, 85, 247, 0.8)); transform: scale(1.05); } 
        }
        @keyframes blink { 0%, 100% { opacity: 0.5; } 50% { opacity: 0.2; } }
    </style>
</head>
<body>

<!-- [优化] 移动端使用 100dvh 解决 iOS Safari 地址栏遮挡问题 -->
<div id="app" class="h-[100dvh] lg:h-screen flex flex-col relative text-[var(--text-main)]" :class="ui.theme === 'newspaper' ? 'font-serif' : 'font-sans'">

    <!-- ★★★ [修改] 新版彩蛋遮罩层 ★★★ -->
    <div v-if="showEasterEgg" class="core-overlay" @click="closeEasterEgg">
        <div class="core-container">
            <div class="core-ring"></div>
            <!-- 这里引用你的 logo.png -->
            <img src="logo.png" class="core-logo-img">
        </div>
        
        <div class="core-text">
            <div class="core-title">LEVANT ENGINE</div>
            <div class="core-subtitle">SYSTEM SYNCHRONIZED // AWAITING INPUT</div>
        </div>
    </div>

    <!-- ★★★ 极简赛博启动界面 (Clean Cyber Splash) ★★★ -->
    <transition name="splash">
        <div v-if="showSplash" 
            @click="handleSplashClick" 
            class="fixed inset-0 z-[100000] retro-bg overflow-hidden flex flex-col items-center justify-center cursor-pointer select-none font-sans group">
            
            <!-- 1. 背景层 (保持不变) -->
            <div class="absolute bottom-[-20%] left-[-50%] right-[-50%] h-[80%] synthwave-grid pointer-events-none"></div>
            <canvas ref="matrixCanvas" class="absolute inset-0 z-0 pointer-events-none opacity-20"></canvas>
            <div class="absolute inset-0 scanlines-retro z-50 pointer-events-none opacity-40"></div>
            <div class="absolute w-[800px] h-[800px] rounded-full cyber-halo top-1/2 left-1/2 mt-[-50px] z-0"></div>

            <!-- 2. HUD 边框 (保持不变) -->
            <div class="absolute top-8 left-8 w-32 h-32 border-l-2 border-t-2 border-cyan-500/50 rounded-tl-xl pointer-events-none transition-all duration-500 group-hover:w-40 group-hover:h-40 group-hover:border-cyan-400"></div>
            <div class="absolute top-8 right-8 w-32 h-32 border-r-2 border-t-2 border-fuchsia-500/50 rounded-tr-xl pointer-events-none transition-all duration-500 group-hover:w-40 group-hover:h-40 group-hover:border-fuchsia-400"></div>
            <div class="absolute bottom-8 left-8 w-32 h-32 border-l-2 border-b-2 border-fuchsia-500/50 rounded-bl-xl pointer-events-none transition-all duration-500 group-hover:w-40 group-hover:h-40 group-hover:border-fuchsia-400"></div>
            <div class="absolute bottom-8 right-8 w-32 h-32 border-r-2 border-b-2 border-cyan-500/50 rounded-br-xl pointer-events-none transition-all duration-500 group-hover:w-40 group-hover:h-40 group-hover:border-cyan-400"></div>

            <!-- 3. 中心内容区 (Logo 和 文字) -->
            <div class="relative z-40 flex flex-col items-center justify-center min-h-[400px]">
                
                <!-- 阶段一：待机 (Waiting) -->
                <div v-if="!hasInteracted" class="text-center animate-pulse">
                    <div class="text-4xl md:text-6xl font-black text-white/90 tracking-[0.2em] font-mono mb-4 drop-shadow-[0_0_10px_rgba(255,255,255,0.8)]">
                        LEVANT
                    </div>
                    <div class="text-sm md:text-base text-cyan-400 font-bold border border-cyan-500/50 px-6 py-3 bg-black/40 backdrop-blur-sm uppercase hover:bg-cyan-900/30 transition select-none"
                        :class="ui.lang === 'en' ? 'tracking-[0.5em]' : 'tracking-[0.2em]'">
                        {{ t('splash_init') }}
                    </div>
                </div>

                <!-- 阶段二：Logo (Active) -->
                <transition name="fade-slide-up">
                    <div v-if="hasInteracted" class="flex flex-col items-center">
                        <!-- Logo 容器 -->
                        <div class="relative" style="animation: neon-glow 4s infinite ease-in-out;">
                            <img src="logo.png" 
                                class="w-[450px] h-[450px] object-contain relative transition-transform duration-700 hover:scale-105 hover:-translate-y-2">
                        </div>
                        <!-- 版本号 -->
                        <div class="relative -mt-8 z-50">
                            <div class="absolute inset-0 bg-fuchsia-900/40 blur-lg rounded-full"></div>
                            <div class="relative px-6 py-2 bg-black/20 backdrop-blur-[2px] rounded-full border border-white/5">
                                <span class="text-sm font-bold text-fuchsia-300 uppercase tracking-[0.35em] font-mono"
                                    style="text-shadow: 0 0 12px rgba(232,121,249,0.9);">
                                    v{{ APP_VERSION }} Farewell for you
                                </span>
                            </div>
                        </div>
                        <!-- 底部提示 -->
                        <div class="mt-12 text-[10px] text-cyan-300/40 font-mono tracking-[1em] uppercase animate-pulse">
                            System_Ready_To_Enter
                        </div>
                    </div>
                </transition>
            </div>

            <!-- 4. 音乐盒 (独立定位，不参与中心布局，修复重叠问题) -->
            <!-- 使用 fixed 定位，确保它永远贴在屏幕右下角 -->
            <transition name="fade">
                <div v-if="hasInteracted" class="fixed bottom-12 right-12 text-right z-50 pointer-events-none">
                    <div class="flex items-center justify-end gap-3 text-emerald-400/80">
                        <div class="flex gap-1 items-end h-4">
                            <div class="w-1 bg-emerald-400 animate-[bounce_1s_infinite] h-2"></div>
                            <div class="w-1 bg-emerald-400 animate-[bounce_1.2s_infinite] h-4"></div>
                            <div class="w-1 bg-emerald-400 animate-[bounce_0.8s_infinite] h-3"></div>
                        </div>
                        <div class="text-[10px] font-mono font-bold tracking-widest uppercase border-r-2 border-emerald-500 pr-3">
                            Now Playing
                        </div>
                    </div>
                    <div class="text-xs text-white/60 font-mono mt-1 tracking-wider uppercase">
                        {{ currentBgmName }}
                    </div>
                </div>
            </transition>

            <!-- 底部版权 -->
            <div class="absolute bottom-6 w-full text-center text-[9px] text-white/10 font-mono tracking-widest z-40 pointer-events-none">
                LEVANT ENGINE V{{ APP_VERSION }} // INITIALIZED
            </div>
        </div>
    </transition>

    <canvas id="map-analysis-canvas" style="display: none;"></canvas>
    <!-- 纸张纹理层 -->
    <div class="app-texture"></div>

    <!-- 顶部导航 -->
    <header role="banner" aria-label="Top Navigation" class="h-24 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex items-center px-8 justify-between shrink-0 z-50 shadow-sm relative w-full transition-colors duration-300">
        <!-- 左侧区域 -->
        <!-- [最终修复] flex-1 占据剩余空间, min-w-0 允许内部文字缩略 -->
        <div class="flex items-center gap-2 lg:gap-6 flex-1 min-w-0 mr-2">
            <!-- Logo: 保持原样 -->
            <div class="shrink-0 mr-2 lg:mr-4 flex items-center">
                <img src="logo.png" 
                    @click="handleLogoClick"
                    class="cursor-pointer w-10 h-10 lg:w-16 lg:h-16 object-contain drop-shadow-[0_2px_10px_rgba(0,0,0,0.3)] transition-transform duration-300 hover:scale-110 active:scale-95"
                    alt="Levant Logo">
            </div>
            
            <div class="flex flex-col justify-center min-w-0 overflow-hidden">
                <div class="flex items-center">
                    <!-- 标题: 增加 truncate 实现省略号 -->
                    <h1 class="font-black text-lg lg:text-2xl text-[var(--text-main)] tracking-tight leading-none truncate">{{ t('app_title') }}</h1>
                    
                    <span class="text-[var(--text-dim)] font-light text-sm font-mono-tech mr-4 hidden lg:inline">v{{ APP_VERSION }}</span>
                    <div class="h-4 w-px bg-[var(--border-dim)] mr-4 hidden lg:block"></div>
                    <div class="hidden lg:flex items-center gap-2 px-3 py-1 theme-rounded-sm bg-[var(--bg-badge)] border border-[var(--border-dim)] text-indigo-400 font-mono-tech text-xs font-bold tracking-wide backdrop-blur-sm mr-4 shrink-0">
                        <span>POWERED BY 絜矩 (QQ 2124223354)</span>
                    </div>

                    <!-- 语录展示区 -->
                    <div class="relative h-8 w-[500px] overflow-hidden flex items-center hidden 2xl:flex">
                        <transition-group name="quote">
                            <div :key="quoteIdx" class="absolute left-0 text-[var(--text-dim)] text-sm font-serif italic tracking-widest whitespace-nowrap">
                                <i class="fa-solid fa-quote-left text-xs opacity-50 mr-2 transform -translate-y-1"></i>
                                {{ quotes[quoteIdx] }}
                                <i class="fa-solid fa-quote-right text-xs opacity-50 ml-1 transform -translate-y-1"></i>
                            </div>
                        </transition-group>
                    </div>
                </div>

                <!-- 状态信息 (移动端隐藏以节省空间) -->
                <div class="hidden lg:flex items-center gap-3 mt-1.5 text-[10px] font-mono-tech uppercase tracking-widest text-[var(--text-dim)]">
                    <span :class="serverConnected ? 'text-emerald-500' : 'text-red-500'" class="flex items-center gap-2 font-bold">
                        <i class="fa-solid fa-wifi"></i> {{ serverConnected ? t('status_online') : t('status_offline') }}
                    </span>
                    <span v-if="currentSaveFile" class="text-indigo-400 ml-2 border-l border-[var(--border-dim)] pl-2">
                        <i class="fa-solid fa-floppy-disk mr-1"></i> {{ currentSaveFile }}
                    </span>
                </div>
            </div>
        </div>

        <!-- 右侧区域 -->
        <!-- [最终修复] gap-1 极小间距，按钮强制方形，shrink-0 防止被标题挤压 -->
        <div class="flex items-center gap-1 lg:gap-4 shrink-0">
            
            <!-- 回合数: 保持桌面端显示 (手机端隐藏) -->
            <div class="text-right mr-4 border-r border-[var(--border-dim)] pr-6 hidden lg:block">
                <div class="text-[10px] text-[var(--text-dim)] uppercase font-bold tracking-widest mb-1">{{ t('next_turn_label') }}</div>
                <div class="text-emerald-500 font-mono-tech font-bold text-2xl leading-none tracking-tight">{{ pendingTurnRange || t('auto') }}</div>
            </div>
            
            <!-- 1. 撤销/重做按钮组 (手机端可见) -->
            <div class="flex gap-1 mr-1 pr-2 border-r border-[var(--border-dim)] lg:border-none lg:mr-2 lg:pr-0">
                <button @click="performUndo" :disabled="undoStack.length === 0" 
                        :class="undoStack.length === 0 ? 'opacity-30 cursor-not-allowed' : 'hover:bg-[var(--bg-hover)] hover:text-white'"
                        class="w-9 h-9 flex items-center justify-center theme-rounded-sm border border-[var(--border-dim)] text-[var(--text-dim)] transition active:scale-90" 
                        title="Undo">
                    <i class="fa-solid fa-rotate-left"></i>
                </button>
                <button @click="performRedo" :disabled="redoStack.length === 0"
                        :class="redoStack.length === 0 ? 'opacity-30 cursor-not-allowed' : 'hover:bg-[var(--bg-hover)] hover:text-white'"
                        class="w-9 h-9 flex items-center justify-center theme-rounded-sm border border-[var(--border-dim)] text-[var(--text-dim)] transition active:scale-90" 
                        title="Redo">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
            </div>

            <!-- 2. ★★★ [优化] 响应式音乐播放器 ★★★ -->
            <!-- 
               核心逻辑：
               - 外层 div: 去掉了 hidden，手机端现在可以看到它了。
               - 宽度控制: 手机端强制 w-9 (方形)，电脑端根据播放状态伸缩。
            -->
            <div class="flex items-center theme-rounded-sm bg-[var(--bg-panel)] border transition-all duration-300 overflow-hidden h-9 lg:h-11"
                 :class="isBgmPlaying ? 'border-emerald-500/50 shadow-[0_0_10px_rgba(16,185,129,0.1)] lg:pr-1 lg:pl-3 lg:gap-2' : 'border-[var(--border-dim)] w-9 lg:w-11 justify-center'">
                
                <!-- 歌名+切歌按钮 (仅桌面端显示 hidden lg:flex) -->
                <!-- 手机屏幕太小，放不下滚动的文字，所以隐藏这部分，只保留主开关 -->
                <transition name="fade">
                    <div v-if="isBgmPlaying" class="hidden lg:flex items-center gap-3 h-full">
                        <div class="flex flex-col justify-center items-end w-36 h-full overflow-hidden">
                            <span class="text-[8px] text-[var(--text-dim)] uppercase tracking-widest leading-none mb-0.5 opacity-70 scale-90 origin-right">NOW PLAYING</span>
                            <div class="relative w-full h-5 overflow-hidden flex items-center mask-sides">
                                <div class="animate-scroll-seamless">
                                    <span class="text-[11px] text-emerald-400 font-mono font-bold whitespace-nowrap pr-8 leading-none pt-0.5">{{ currentBgmName }}</span>
                                    <span class="text-[11px] text-emerald-400 font-mono font-bold whitespace-nowrap pr-8 leading-none pt-0.5">{{ currentBgmName }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="w-px h-5 bg-[var(--border-dim)]"></div>
                        <button @click="changeBgm" class="w-7 h-7 flex items-center justify-center text-[var(--text-dim)] hover:text-emerald-400 hover:bg-[var(--bg-hover)] theme-rounded-sm transition shrink-0"><i class="fa-solid fa-forward-step text-xs"></i></button>
                    </div>
                </transition>

                <!-- 主开关按钮 (全端显示) -->
                <button @click="toggleMainBgm" 
                        class="flex items-center justify-center transition-transform active:scale-95 group shrink-0 w-9 h-9 lg:w-auto lg:h-full lg:px-0"
                        title="Music Switch">
                    <!-- 播放时显示旋转光盘，停止时显示音符 -->
                    <i :class="isBgmPlaying ? 'fa-solid fa-compact-disc fa-spin text-emerald-500 text-lg lg:text-xl' : 'fa-solid fa-music text-[var(--text-dim)] group-hover:text-[var(--text-main)] text-sm lg:text-lg'" style="animation-duration: 3s;"></i>
                </button>
            </div>
            
            <!-- 3. 剧本生成 (手机端只显图标) -->
            <button @click="openScriptGenModal" class="w-9 h-9 lg:w-auto lg:h-11 lg:px-5 flex items-center justify-center gap-2 theme-rounded-sm bg-[var(--bg-panel)] hover:bg-[var(--bg-hover)] text-[var(--text-accent)] border border-[var(--border-dim)] transition font-bold text-sm ml-1">
                <i class="fa-solid fa-wand-sparkles"></i> <span class="hidden lg:inline">{{ t('btn_script_gen') }}</span>
            </button>

            <!-- 4. 地图编辑器 (手机端隐藏) -->
            <a href="/map_editor" target="_blank" class="hidden lg:flex h-11 px-5 theme-rounded-sm bg-[var(--bg-panel)] hover:bg-[var(--bg-hover)] text-emerald-500 border border-[var(--border-dim)] transition font-bold text-sm items-center gap-2 ml-2 no-underline" title="Map Editor">
                <i class="fa-solid fa-map-location-dot"></i> 地图编辑
            </a>

            <!-- 5. 设置按钮 -->
            <button @click="showSettings = true" class="w-9 h-9 lg:w-11 lg:h-11 theme-rounded-sm bg-[var(--bg-panel)] hover:bg-[var(--bg-hover)] text-[var(--text-dim)] border border-[var(--border-dim)] transition flex items-center justify-center ml-1">
                <i class="fa-solid fa-gear text-lg"></i>
            </button>
            
            <!-- 6. 截图按钮 (手机端隐藏) -->
            <button @click="toggleScreenshotMode" :class="isScreenshotMode ? 'bg-emerald-600 text-white border-emerald-500' : 'bg-[var(--bg-panel)] text-[var(--text-dim)]'" class="hidden lg:flex h-11 w-11 theme-rounded-sm hover:bg-[var(--bg-hover)] border border-[var(--border-dim)] transition items-center justify-center ml-2">
                <i class="fa-solid fa-crop-simple text-lg"></i>
            </button>
            
            <!-- 7. 档案按钮 -->
            <button @click="openSaveLoadModal" class="w-9 h-9 lg:w-auto lg:h-11 lg:px-6 flex items-center justify-center gap-2 theme-rounded-sm bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-900/40 transition font-bold text-sm border-t border-indigo-400/30 ml-1">
                <i class="fa-solid fa-folder-open"></i> <span class="hidden lg:inline">{{ t('btn_files') }}</span>
            </button>
        </div>
    </header>

    <!-- 修改：增加 lg:flex-row 响应式方向，移动端默认 flex-col -->
    <main class="flex-1 flex flex-col lg:flex-row overflow-hidden z-10 relative">
        
        <!-- ★★★ [优化] VN 剧场模式层 ★★★ -->
        <transition name="fade">
            <div v-if="vnMode" class="vn-container">
                <!-- 1. 背景层 -->
                <div class="vn-background" :style="{ backgroundImage: `url(${getMapBackground() || 'logo.png'})` }"></div>
                
                <!-- 2. 立绘层 -->
                <div class="vn-tachie-stage">
                    <!-- [修改] 增加判定：如果角色是 isProtagonist，则不显示立绘 (POV视角) -->
                    <img v-if="vnCurrentLine && vnCurrentLine.role !== 'narrator' && !isProtagonist(vnCurrentLine.role) && getFactionAvatar(vnCurrentLine.role, vnCurrentLine.tag)"
                        :key="vnCurrentLine.role + vnCurrentLine.tag"
                        :src="getFactionAvatar(vnCurrentLine.role, vnCurrentLine.tag)"
                        class="vn-tachie-img"
                        :style="getAvatarStyleObj(vnCurrentLine.role, vnCurrentLine.tag)">
                </div>

                <!-- 3. UI 层 (对话框) -->
                <!-- 修改：移除 @click，增加 pointer-events-none 让外壳不阻挡，但由内部子元素接管交互 -->
                <div class="vn-ui-layer pointer-events-none">
                    
                    <!-- ★★★ [新增] 专门的点击交互层 (作为背景板) ★★★ -->
                    <!-- 这个层铺满整个区域，z-index 为 0，负责捕捉“点击空白处下一句” -->
                    <!-- pointer-events-auto 恢复交互 -->
                    <div class="absolute inset-0 z-0 pointer-events-auto" @click="vnNextLine"></div>
                    
                    <!-- 名字铭牌 (非旁白时显示) -->
                    <transition name="slide-up">
                        <!-- 修改：增加 relative z-10 pointer-events-auto -->
                        <div class="vn-name-box relative z-10 pointer-events-auto" v-if="vnCurrentLine && vnCurrentLine.role !== 'narrator'"
                             :style="{ borderLeftColor: getFactionColor(vnCurrentLine.role) }">
                            <div class="vn-name-text" :style="{ color: getFactionColor(vnCurrentLine.role) }">
                                {{ getFactionName(vnCurrentLine.role) }}
                            </div>
                            <!-- 小 Logo -->
                            <i :class="getFactionLogo(vnCurrentLine.role)" class="text-white opacity-50 text-xl transform skew-x-12"></i>
                        </div>
                    </transition>
                    
                    <!-- 文本框 -->
                    <div class="vn-text-box relative z-10 pointer-events-auto" @click="vnNextLine"
                        :class="{ 
                            'narrator-mode': vnCurrentLine && vnCurrentLine.role === 'narrator',
                            'protagonist-mode': vnCurrentLine && isProtagonist(vnCurrentLine.role)
                        }">
                        <div class="vn-text-content">
                            <!-- 使用 v-html 允许简单的格式，如换行 -->
                            <span v-html="vnDisplayedText"></span>
                            <!-- 光标 -->
                            <span v-if="vnIsTyping" class="inline-block w-2 h-5 bg-emerald-400 ml-1 animate-pulse align-middle"></span>
                        </div>
                        
                        <!-- 下一句指示器 (打字结束且不是最后一句时显示) -->
                        <div v-if="!vnIsTyping" class="vn-next-indicator">
                             <i class="fa-solid fa-play"></i>
                        </div>
                    </div>
                    <!-- vn-text-box 结束 -->

                    <!-- ★★★ [新增] 实时互动输入栏 (Interactive Chat) ★★★ -->
                    <!-- 仅在打字结束，且没有弹出选项时显示 -->
                    <div v-if="!vnIsTyping && !vnShowOptions" class="mt-4 pointer-events-auto flex gap-2 animate-fade-in-up relative z-20" @click.stop>
                        <!-- 修改点：添加了 @click.stop 和 @touchstart.stop -->
                        <input v-model="vnUserInput" 
                            @click.stop
                            @touchstart.stop
                            @keyup.enter="sendVNChat"
                            placeholder="Say or do something..." 
                            class="flex-1 bg-black/60 border border-white/20 theme-rounded-sm px-4 py-2 text-white outline-none focus:border-indigo-500 transition backdrop-blur-md font-bold shadow-lg"
                        >
                        <button @click="sendVNChat" :disabled="isThinking" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 theme-rounded-sm font-bold transition flex items-center gap-2">
                            <i :class="isThinking ? 'fa-solid fa-circle-notch fa-spin' : 'fa-solid fa-paper-plane'"></i>
                            <span class="hidden lg:inline">Send</span>
                        </button>
                        <!-- ★★★ [新增] 手动保存退出按钮 (放在发送按钮旁边) -->
                        <button @click="saveAndExitVN" class="bg-red-900/80 hover:bg-red-700 text-white px-3 py-2 theme-rounded-sm font-bold transition flex items-center justify-center border border-red-500/30" title="Save & Quit">
                            <i class="fa-solid fa-power-off"></i>
                        </button>
                    </div>
                </div>

                <!-- 4. 选项层 -->
                <div v-if="vnShowOptions" class="vn-options-overlay">
                    <div class="text-3xl font-black text-white mb-8 uppercase tracking-[0.2em] drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">
                        Critical Decision
                    </div>
                    <button v-for="(opt, idx) in vnCurrentEvent.options" :key="idx" 
                            @click="selectOption(vnCurrentEvent, opt); vnMode = false"
                            class="vn-option-btn group">
                        <div>
                            <div class="text-xl mb-1">{{ typeof opt === 'object' ? opt.label : opt }}</div>
                            <div v-if="typeof opt === 'object'" class="text-sm text-gray-400 font-normal">{{ opt.desc }}</div>
                        </div>
                    </button>
                    <button v-if="!vnCurrentEvent.options || vnCurrentEvent.options.length === 0" 
                            @click="saveAndExitVN"
                            class="vn-option-btn justify-center text-center opacity-70 hover:opacity-100">
                        <i class="fa-solid fa-floppy-disk mr-2"></i> [ END SCENE & SAVE ]
                    </button>
                </div>
                
                <!-- VN 顶部工具栏 (导演设置 + 退出) -->
                <div class="absolute top-6 right-6 z-[300] flex gap-2">
                    <!-- 1. 导演/设置按钮 -->
                    <button @click="vnShowSettings = !vnShowSettings" 
                            class="text-white/50 hover:text-white bg-black/40 hover:bg-indigo-600/80 theme-rounded-sm w-12 h-12 flex items-center justify-center transition border border-white/10 backdrop-blur-md"
                            title="Director Panel">
                        <i class="fa-solid fa-sliders"></i>
                    </button>

                    <!-- 2. 保存并退出按钮 -->
                    <button @click="saveAndExitVN" 
                            class="text-white/50 hover:text-red-500 bg-black/40 hover:bg-red-900/50 theme-rounded-sm w-12 h-12 flex items-center justify-center transition border border-white/10 backdrop-blur-md"
                            title="Save & Exit">
                        <i class="fa-solid fa-power-off"></i>
                    </button>
                </div>

                <!-- ★★★ [新增] 导演面板 (Director Panel) ★★★ -->
                <transition name="fade">
                    <div v-if="vnShowSettings" class="absolute top-20 right-6 z-[290] w-80 bg-black/90 border border-indigo-500/30 theme-rounded-sm backdrop-blur-xl p-4 shadow-2xl text-white flex flex-col gap-4" @click.stop>
                        
                        <!-- 标题栏 -->
                        <div class="flex justify-between items-center pb-2 border-b border-white/10">
                            <h4 class="text-xs font-bold text-indigo-400 uppercase tracking-widest"><i class="fa-solid fa-clapperboard mr-2"></i>导演控制台</h4>
                            <button @click="vnShowSettings = false" class="text-white/30 hover:text-white"><i class="fa-solid fa-times"></i></button>
                        </div>

                        <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-1" style="scrollbar-width: thin; scrollbar-color: #4f46e5 #1e1b4b;">
                            
                            <!-- ★ [新增] 身份切换 (Identity Override) -->
                            <div class="bg-indigo-900/30 p-2 theme-rounded-sm border border-indigo-500/30">
                                <label class="block text-[10px] font-bold text-indigo-300 uppercase mb-1">当前扮演 (Current Identity)</label>
                                <select v-model="vnPlayerRoleId" class="w-full bg-black/50 text-xs text-white border border-indigo-500/50 rounded px-2 py-1 outline-none focus:bg-indigo-900/50">
                                    <option value="narrator">-- 旁白 / 上帝视角 (Narrator) --</option>
                                    <optgroup label="Characters">
                                        <option v-for="p in players" :key="p.id" :value="p.id">
                                            {{ p.name }} {{ p.isProtagonist ? '(Main)' : '' }}
                                        </option>
                                    </optgroup>
                                </select>
                            </div>

                            <!-- A. 演员调度 -->
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">活跃演员 (Active Cast)</label>
                                <div class="space-y-1">
                                    <!-- 列表逻辑微调：显示所有非当前扮演的角色 -->
                                    <!-- 这样如果你扮演了路人A，路人A就会从列表中消失(因为是你自己)，你可以勾选原本的主角作为对手戏 -->
                                    <div v-for="p in players" :key="p.id" v-show="p.id !== vnPlayerRoleId" 
                                         class="flex items-center gap-2 p-2 theme-rounded-sm border transition cursor-pointer select-none"
                                         :class="vnActiveEntityIds.includes(p.id) ? 'bg-indigo-900/40 border-indigo-500/50' : 'bg-white/5 border-transparent hover:bg-white/10'"
                                         @click="vnActiveEntityIds.includes(p.id) ? vnActiveEntityIds = vnActiveEntityIds.filter(x=>x!==p.id) : vnActiveEntityIds.push(p.id)">
                                        
                                        <div class="w-4 h-4 border theme-rounded-sm flex items-center justify-center transition-colors"
                                             :class="vnActiveEntityIds.includes(p.id) ? 'bg-indigo-500 border-indigo-500' : 'border-gray-500 bg-transparent'">
                                            <i v-if="vnActiveEntityIds.includes(p.id)" class="fa-solid fa-check text-[10px] text-white"></i>
                                        </div>
                                        
                                        <div class="w-6 h-6 theme-rounded-sm overflow-hidden bg-black/30 flex items-center justify-center shrink-0">
                                            <img v-if="isImage(p.logo)" :src="p.logo" class="w-full h-full object-contain">
                                            <i v-else :class="p.logo || 'fa-solid fa-user'" class="text-[10px]"></i>
                                        </div>
                                        
                                        <span class="text-xs font-bold truncate flex-1" :style="{color: p.color}">{{ p.name }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- B. 上下文配置 -->
                            <div class="pt-3 border-t border-white/10 space-y-2">
                                <label class="block text-[10px] font-bold text-gray-400 uppercase">上下文开关</label>
                                
                                <!-- 开关组 -->
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="flex items-center justify-between p-1 hover:bg-white/5 theme-rounded-sm">
                                        <span class="text-[10px] text-gray-300">属性 (Stats)</span>
                                        <input type="checkbox" v-model="vnContextConfig.includeStats" class="accent-indigo-500 w-3 h-3 cursor-pointer">
                                    </div>
                                    <div class="flex items-center justify-between p-1 hover:bg-white/5 theme-rounded-sm">
                                        <span class="text-[10px] text-gray-300">表情 (Tags)</span>
                                        <input type="checkbox" v-model="vnContextConfig.includeTags" class="accent-indigo-500 w-3 h-3 cursor-pointer">
                                    </div>
                                    <div class="flex items-center justify-between p-1 hover:bg-white/5 theme-rounded-sm">
                                        <span class="text-[10px] text-gray-300">自定义 Prompt</span>
                                        <input type="checkbox" v-model="vnContextConfig.includeCustom" class="accent-indigo-500 w-3 h-3 cursor-pointer">
                                    </div>
                                    <div class="flex items-center justify-between p-1 hover:bg-white/5 theme-rounded-sm">
                                        <span class="text-[10px] text-gray-300">地图 (Map)</span>
                                        <input type="checkbox" v-model="vnContextConfig.includeMap" class="accent-indigo-500 w-3 h-3 cursor-pointer">
                                    </div>
                                </div>

                                <!-- ★ [新增] 独立历史记忆设置 -->
                                <div class="bg-white/5 p-2 theme-rounded-sm border border-white/5 mt-2">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-[10px] font-bold text-gray-300 uppercase">历史记忆 (History)</span>
                                        <input type="checkbox" v-model="vnContextConfig.includeHistory" class="accent-indigo-500 w-3 h-3 cursor-pointer">
                                    </div>
                                    
                                    <div v-if="vnContextConfig.includeHistory" class="space-y-2">
                                        <div>
                                            <div class="flex justify-between text-[9px] text-gray-400 mb-1">
                                                <span>深层 (Deep/Detail)</span>
                                                <span class="text-indigo-400">{{ vnContextConfig.historyDeepDepth }} Turns</span>
                                            </div>
                                            <input type="range" v-model.number="vnContextConfig.historyDeepDepth" min="0" max="5" class="w-full h-1 bg-gray-700 theme-rounded-sm appearance-none cursor-pointer accent-indigo-500">
                                        </div>
                                        <div>
                                            <div class="flex justify-between text-[9px] text-gray-400 mb-1">
                                                <span>浅层 (Shallow/Summary)</span>
                                                <span class="text-indigo-400">{{ vnContextConfig.historyShallowDepth }} Turns</span>
                                            </div>
                                            <input type="range" v-model.number="vnContextConfig.historyShallowDepth" min="0" max="20" class="w-full h-1 bg-gray-700 theme-rounded-sm appearance-none cursor-pointer accent-indigo-500">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </transition>
            </div>
        </transition>
        
        <!-- 左侧：资料库 -->
        <aside role="region" aria-label="Library Panel" 
               v-show="mobileActiveView === 'library' || isLargeScreen"
               class="w-full lg:w-1/5 lg:min-w-[380px] h-full bg-[var(--bg-sidebar)] border-r border-[var(--border-dim)] flex flex-col overflow-hidden shrink-0 z-30 relative shadow-lg transition-colors duration-300">
            
            <!-- Tab 栏: 手机端减小文字大小 -->
            <div class="grid grid-cols-4 p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] gap-1 shrink-0">
                <button @click="tabs.left = 'world'" :class="tabs.left==='world' ? 'bg-[var(--bg-panel)] text-[var(--text-main)] border-[var(--border-dim)]' : 'text-[var(--text-dim)] border-transparent hover:text-[var(--text-main)]'" class="py-2 theme-rounded-sm border transition text-[10px] lg:text-xs font-bold tracking-wide flex flex-col lg:flex-row items-center justify-center gap-1">
                    <i class="fa-solid fa-globe"></i><span>{{ t('tab_world') }}</span>
                </button>
                <button @click="tabs.left = 'players'" :class="tabs.left==='players' ? 'bg-[var(--bg-panel)] text-indigo-400 border-[var(--border-dim)]' : 'text-[var(--text-dim)] border-transparent hover:text-[var(--text-main)]'" class="py-2 theme-rounded-sm border transition text-[10px] lg:text-xs font-bold tracking-wide flex flex-col lg:flex-row items-center justify-center gap-1">
                    <i class="fa-solid fa-users"></i><span>{{ t('tab_entity') }}</span>
                </button>
                <button @click="tabs.left = 'lore'" :class="tabs.left==='lore' ? 'bg-[var(--bg-panel)] text-emerald-400 border-[var(--border-dim)]' : 'text-[var(--text-dim)] border-transparent hover:text-[var(--text-main)]'" class="py-2 theme-rounded-sm border transition text-[10px] lg:text-xs font-bold tracking-wide flex flex-col lg:flex-row items-center justify-center gap-1">
                    <i class="fa-solid fa-book"></i><span>{{ t('tab_lore') }}</span>
                </button>
                <button @click="tabs.left = 'stat_schema'" :class="tabs.left==='stat_schema' ? 'bg-[var(--bg-panel)] text-amber-400 border-[var(--border-dim)]' : 'text-[var(--text-dim)] border-transparent hover:text-[var(--text-main)]'" class="py-2 theme-rounded-sm border transition text-[10px] lg:text-xs font-bold tracking-wide flex flex-col lg:flex-row items-center justify-center gap-1">
                    <i class="fa-solid fa-sliders"></i><span>{{ t('tab_rules') }}</span>
                </button>
            </div>

            <!-- 1. 全局变量 -->
            <div v-if="tabs.left === 'world'" class="flex-1 min-h-0 overflow-y-auto p-3 lg:p-5 space-y-3 touch-pan-y overscroll-contain">
                <div class="text-xs text-[var(--text-dim)] font-bold uppercase tracking-widest mb-2 px-1">{{ t('header_global_vars') }}</div>
                <div v-for="(gVar, idx) in global_vars" :key="idx" class="bg-[var(--bg-panel)] p-2 lg:p-3 theme-rounded-sm border border-[var(--border-dim)] flex flex-col gap-2 group">
                    
                    <!-- 手机端: 上下布局 (Key 上 Value 下) / 桌面端: 左右布局 -->
                    <div class="flex flex-col lg:flex-row gap-2">
                        <!-- Key 输入框 -->
                        <input v-model="gVar.key" @change="debouncedSave('autosave.json')" class="w-full lg:w-1/3 bg-[var(--bg-badge)] text-sm text-indigo-400 p-2 theme-rounded-sm border border-[var(--border-dim)] outline-none font-bold font-mono-tech" :placeholder="t('ph_var_key')">
                        
                        <!-- Value 输入框 / 删除按钮 -->
                        <div class="flex flex-1 gap-2">
                            <input v-if="gVar.visibility !== 'readonly'" v-model="gVar.value" @change="debouncedSave('autosave.json')" :type="gVar.type === 'number' ? 'number' : 'text'" class="flex-1 bg-[var(--bg-badge)] text-sm text-[var(--text-main)] p-2 theme-rounded-sm border border-[var(--border-dim)] outline-none" :placeholder="t('ph_var_val')">
                            <div v-else class="flex-1 bg-[var(--bg-input)] text-sm text-pink-400 font-mono font-bold p-2 theme-rounded-sm border border-dashed border-pink-500/30 flex items-center">
                                <i class="fa-solid fa-calculator mr-2 text-[10px]"></i> {{ gVar.value }}
                            </div>
                            <button @click="global_vars.splice(idx,1); saveGame('autosave.json')" class="text-[var(--text-dim)] hover:text-red-400 px-2 lg:opacity-0 lg:group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    
                    <!-- 配置行 (保持不变) -->
                    <div class="flex gap-1 items-center border-t border-[var(--border-dim)] pt-2 mt-1">
                        <!-- (此处原有 select 代码保持不变) -->
                        <select v-model="gVar.type" class="bg-transparent text-[9px] text-[var(--text-dim)] outline-none uppercase font-bold w-16">
                            <option value="string">STR</option>
                            <option value="number">NUM</option>
                        </select>
                        <div class="w-px h-3 bg-[var(--border-dim)]"></div>
                        <select v-model="gVar.visibility" class="bg-transparent text-[9px] outline-none uppercase font-bold w-20" :class="gVar.visibility==='editable'?'text-emerald-500':(gVar.visibility==='readonly'?'text-amber-500':'text-gray-500')">
                            <option value="editable">Edit</option>
                            <option value="readonly">Auto</option>
                            <option value="hidden">Hide</option>
                        </select>
                        <input v-if="gVar.type === 'number' && gVar.visibility === 'readonly'" 
                            v-model="gVar.formula" 
                            placeholder="Formula..." 
                            class="flex-1 bg-transparent text-[9px] text-pink-400 font-mono outline-none text-right placeholder-gray-700">
                    </div>
                </div>
                <button @click="addGlobalVar" class="w-full py-3 bg-[var(--bg-panel)] text-[var(--text-dim)] theme-rounded-sm border border-[var(--border-dim)] font-bold text-sm hover:bg-[var(--bg-header)] transition hover:text-[var(--text-main)]"><i class="fa-solid fa-plus mr-2"></i> {{ t('btn_add_global') }}</button>
            </div>

            <!-- 2. 实体列表 -->
            <div v-if="tabs.left === 'players'" class="flex-1 min-h-0 overflow-y-auto p-3 lg:p-5 space-y-3 lg:space-y-4 touch-pan-y overscroll-contain">
                 <div role="group" :aria-label="player.name" v-for="player in sortedPlayers" :key="player.id" @click="openFactionModal(player)" 
                      class="info-card cursor-pointer theme-rounded p-3 lg:p-5 relative group transition-all duration-300"
                      :style="{ marginLeft: (player._depth * (isLargeScreen ? 24 : 12)) + 'px', borderLeft: player._depth > 0 ? '4px solid ' + player.color : '' }">
                    
                    <!-- 连接线: 手机端缩短 -->
                    <div v-if="player._depth > 0" class="absolute -left-3 lg:-left-4 top-1/2 -translate-y-1/2 text-[var(--border-dim)]">
                        <i class="fa-solid fa-turn-up rotate-90 text-sm lg:text-lg"></i>
                    </div>

                    <div class="flex justify-between items-start mb-2 lg:mb-4">
                        <div class="flex items-center gap-3 lg:gap-4">
                            <!-- Logo: 手机端稍小 -->
                            <div class="w-10 h-10 lg:w-12 lg:h-12 theme-rounded-sm bg-[var(--bg-badge)] border border-[var(--border-dim)] flex items-center justify-center text-lg lg:text-xl shadow-inner overflow-hidden p-0.5 shrink-0" :style="{ color: player.color, borderColor: player.color + '40' }">
                                <img v-if="isImage(player.logo)" :src="player.logo" class="w-full h-full object-contain">
                                <i v-else :class="player.logo || 'fa-solid fa-users'"></i>
                            </div>
                            <!-- 名字 -->
                            <div class="min-w-0">
                                <div class="font-black text-sm lg:text-base leading-tight mb-1 flex items-center gap-2 truncate" 
                                    :style="{ color: player.color }">
                                    <span class="truncate">{{ player.name }}</span>
                                    <i v-if="players.some(p => p.parentId === player.id)" class="fa-solid fa-sitemap text-[9px] text-[var(--text-dim)] shrink-0" title="拥有下属实体"></i>
                                </div>
                                <div class="text-[9px] lg:text-[10px] font-mono-tech text-[var(--text-dim)] uppercase tracking-widest truncate">ID: {{ player.id }}</div>
                            </div>
                        </div>
                        <!-- 操作菜单: 手机端始终显示点点点，或者增大点击区域 -->
                        <div class="flex gap-2 shrink-0">
                             <button @click.stop="exportAsImage('faction', player)" class="text-[var(--text-dim)] hover:text-emerald-400 transition" title="生成战术海报"><i class="fa-solid fa-camera"></i></button>
                             <i class="fa-solid fa-ellipsis-vertical text-[var(--text-dim)] px-2"></i>
                        </div>
                    </div>
                    <!-- 属性网格 -->
                    <div class="grid grid-cols-2 gap-2">
                        <div v-for="field in getFieldsBySchemaId(player.schemaId)" :key="field.key" class="bg-[var(--bg-badge)] px-2 py-1.5 theme-rounded-sm border border-[var(--border-dim)] flex flex-col overflow-hidden">
                            <span class="text-[8px] lg:text-[9px] text-[var(--text-dim)] font-bold uppercase tracking-wider truncate">{{ field.label }}</span>
                            <span class="text-xs font-mono-tech font-bold truncate" :style="{ color: player.color }">{{ player.stats[field.key] || '-' }}</span>
                        </div>
                    </div>
                </div>
                <button @click="openFactionModal(null)" class="w-full py-4 border-2 border-dashed border-[var(--border-dim)] text-[var(--text-dim)] theme-rounded hover:text-indigo-400 hover:border-indigo-500/50 transition text-sm font-bold bg-[var(--bg-badge)] hover:bg-[var(--bg-panel)] uppercase tracking-widest flex items-center justify-center gap-2"><i class="fa-solid fa-plus-circle"></i> {{ t('btn_new_entity') }}</button>
            </div>

            <!-- 3. 资料设定 -->
            <div v-if="tabs.left === 'lore'" class="flex-1 min-h-0 overflow-y-auto p-5 space-y-4 touch-pan-y overscroll-contain">
                <div v-for="(entry, idx) in lorebook" :key="idx" class="info-card theme-rounded p-4">
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-[var(--border-highlight)]">
                        <input v-model="entry.keys" @change="debouncedSave('autosave.json')" class="bg-transparent text-sm font-bold text-emerald-400 w-full outline-none placeholder-[var(--text-dim)]" placeholder="t('ph_lore_key')">
                        <div class="flex items-center gap-2">
                            <button @click="exportAsImage('lore', entry)" class="text-[var(--text-dim)] hover:text-emerald-400 transition text-xs" title="导出资料卡"><i class="fa-solid fa-camera"></i></button>
                            <button @click="cycleLoreMode(entry)" class="px-2 py-1 theme-rounded-sm text-[10px] font-bold uppercase tracking-wider min-w-[50px] transition-all border" :class="{'bg-emerald-900/40 text-emerald-400 border-emerald-500/40': entry.mode==='on', 'bg-indigo-900/40 text-indigo-400 border-indigo-500/40': entry.mode==='auto', 'bg-[var(--bg-badge)] text-[var(--text-dim)] border-[var(--border-dim)]': entry.mode==='off'}">{{ entry.mode === 'on' ? t('btn_mode_on') : (entry.mode === 'auto' ? t('btn_mode_auto') : t('btn_mode_off')) }}</button>
                        </div>
                    </div>
                    <textarea v-model="entry.content" @change="debouncedSave('autosave.json')" class="w-full bg-[var(--bg-badge)] theme-rounded-sm p-3 text-xs text-[var(--text-main)] resize-none h-20 border border-[var(--border-dim)] focus:border-emerald-500/50 outline-none leading-relaxed" :placeholder="t('ph_lore_content')"></textarea>
                    <div class="flex justify-end mt-1"><button @click="lorebook.splice(idx,1); saveGame('autosave.json')" class="text-xs text-[var(--text-dim)] hover:text-red-400"><i class="fa-solid fa-trash"></i></button></div>
                </div>
                <button @click="addLoreEntry" class="w-full py-3 bg-[var(--bg-panel)] hover:bg-[var(--bg-header)] text-emerald-500 theme-rounded-sm border border-[var(--border-dim)] transition font-bold text-sm"><i class="fa-solid fa-database mr-2"></i> {{ t('btn_add_lore') }}</button>
            </div>

            <!-- 4. 规则列表 (升级版) -->
            <div v-if="tabs.left === 'stat_schema'" class="flex-1 flex flex-col overflow-hidden">
                <!-- A. 规则集切换器 -->
                <div class="p-4 border-b border-[var(--border-dim)] bg-[var(--bg-header)] space-y-2 shrink-0">
                    <div class="flex justify-between items-center">
                         <span class="text-[10px] font-bold text-[var(--text-dim)] uppercase tracking-widest">{{ t('header_type_def') }}</span>
                         <div class="flex gap-1">
                             <button @click="addNewRuleSet" class="text-[var(--text-dim)] hover:text-[var(--text-main)]"><i class="fa-solid fa-plus-square"></i></button>
                             <button @click="deleteActiveRuleSet" class="text-[var(--text-dim)] hover:text-red-400"><i class="fa-solid fa-trash"></i></button>
                         </div>
                    </div>
                    <select v-model="activeSchemaId" @change="debouncedSave('autosave.json')" class="w-full input-tech p-2 theme-rounded-sm text-xs font-bold outline-none border-l-4 border-amber-500">
                        <option v-for="rs in rule_sets" :key="rs.id" :value="rs.id">{{ rs.name }}</option>
                    </select>
                </div>

                <!-- B. 字段列表 (绑定到当前选中的规则集) -->
                <div class="flex-1 min-h-0 overflow-y-auto p-5 space-y-3 touch-pan-y overscroll-contain">
                    <div v-if="getActiveSchemaFields().length === 0" class="text-center text-[var(--text-dim)] text-xs italic py-4">
                        {{ t('msg_no_fields') }}
                    </div>
                    <div v-for="(field, idx) in getActiveSchemaFields()" :key="idx" class="bg-[var(--bg-panel)] p-3 theme-rounded-sm border border-[var(--border-dim)] flex gap-3 items-center group">
                        <div class="flex flex-col gap-2 w-full">
                            <!-- 第一行：Label 和 Key -->
                            <div class="flex gap-2">
                                <div class="flex-1">
                                    <div class="text-[9px] text-[var(--text-dim)] uppercase mb-0.5">{{ t('lbl_field_label') }}</div>
                                    <input v-model="field.label" @change="debouncedSave('autosave.json')" class="w-full bg-[var(--bg-badge)] text-sm text-[var(--text-main)] p-1 theme-rounded-sm outline-none border border-transparent focus:border-[var(--border-dim)]">
                                </div>
                                <div class="w-24">
                                    <div class="text-[9px] text-[var(--text-dim)] uppercase mb-0.5">{{ t('lbl_field_key') }}</div>
                                    <input v-model="field.key" @change="debouncedSave('autosave.json')" class="w-full bg-[var(--bg-badge)] text-sm text-amber-500 font-mono p-1 theme-rounded-sm outline-none text-center border border-transparent focus:border-[var(--border-dim)]">
                                </div>
                            </div>
                            
                            <!-- 第二行：类型、可见性、公式 -->
                            <div class="flex gap-1 items-center">
                                <!-- 类型选择 -->
                                <select v-model="field.type" @change="debouncedSave('autosave.json')" class="bg-[var(--bg-input)] text-[10px] text-[var(--text-dim)] p-1 theme-rounded-sm outline-none border border-[var(--border-dim)] w-16">
                                    <option value="string">String</option>
                                    <option value="number">Number</option>
                                </select>

                                <!-- 可见性选择 -->
                                <select v-model="field.visibility" @change="debouncedSave('autosave.json')" class="bg-[var(--bg-input)] text-[10px] p-1 theme-rounded-sm outline-none border border-[var(--border-dim)] flex-1"
                                    :class="{'text-emerald-500': field.visibility==='editable', 'text-amber-500': field.visibility==='readonly', 'text-[var(--text-dim)]': field.visibility==='hidden'}">
                                    <option value="editable">Editable (AI)</option>
                                    <option value="readonly">Read-Only (AI)</option>
                                    <option value="hidden">Hidden (Secret)</option>
                                </select>

                                <!-- 公式输入 (仅当 Number + ReadOnly 时显示) -->
                                <!-- 修改后：只读框 + 编辑按钮 -->
                                <div v-if="field.type === 'number' && field.visibility === 'readonly'" class="flex gap-1 flex-[2]">
                                    <!-- 只读展示，稍微美化一下，让它看起来不像代码 -->
                                    <div class="flex-1 bg-[var(--bg-input)] text-[9px] text-pink-400 font-mono p-1 theme-rounded-sm border border-[var(--border-dim)] truncate cursor-not-allowed opacity-80" :title="field.formula">
                                        {{ field.formula || '(Empty Formula)' }}
                                    </div>
                                    <!-- 唤起构建器的按钮 -->
                                    <button @click="openFormulaModal(field)" class="px-2 bg-[var(--bg-panel)] border border-[var(--border-dim)] text-pink-500 hover:text-white hover:bg-pink-600 theme-rounded-sm transition text-xs font-bold">
                                        <i class="fa-solid fa-function"></i> ƒ
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button @click="getActiveSchemaFields().splice(idx,1); saveGame('autosave.json')" class="text-[var(--text-dim)] hover:text-red-400 px-1 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-times"></i></button>
                    </div>
                    
                    <button @click="addSchemaField" class="w-full py-3 bg-[var(--bg-panel)] text-amber-500 theme-rounded-sm border border-[var(--border-dim)] font-bold text-sm hover:bg-[var(--bg-header)] transition mt-4"><i class="fa-solid fa-plus mr-2"></i> {{ t('btn_add_rule') }}</button>
                </div>
            </div>
        </aside>

        <!-- 中间：情报流 / 地图 -->
        <section role="main" aria-label="Main View" 
                 v-show="mobileActiveView === 'main' || isLargeScreen"
                 class="w-full lg:w-2/5 h-full bg-[var(--bg-deep)] flex flex-col relative overflow-hidden border-r border-[var(--border-dim)] transition-colors duration-300">
            <!-- [新增] 全局背景大水印 (巨型、极淡、旋转) -->
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-0 overflow-hidden">
                <!-- [修改] 去掉了 rotate-12 -->
                <img src="logo.png" 
                    class="w-[800px] h-[800px] object-contain opacity-[0.03] grayscale brightness-200">
            </div>
            <!-- [新增 1] 视图切换栏 (这是关键，没有它你无法进入地图模式) -->
            <div class="h-12 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex shrink-0 z-20">
                <button @click="showMap = false" :class="!showMap ? 'text-[var(--text-main)] border-indigo-500 bg-[var(--bg-panel)]' : 'text-[var(--text-dim)] border-transparent'" class="flex-1 font-bold text-xs uppercase tracking-widest border-b-2 transition hover:bg-[var(--bg-panel)] flex items-center justify-center gap-2">
                    <i class="fa-solid fa-stream"></i> {{ t('view_timeline') }}
                </button>
                <button @click="showMap = true" :class="showMap ? 'text-[var(--text-main)] border-emerald-500 bg-[var(--bg-panel)]' : 'text-[var(--text-dim)] border-transparent'" class="flex-1 font-bold text-xs uppercase tracking-widest border-b-2 transition hover:bg-[var(--bg-panel)] flex items-center justify-center gap-2">
                    <i class="fa-solid fa-map"></i> {{ t('view_map') }}
                </button>
            </div>

            <!-- 背景纹理 -->
            <div class="absolute inset-0 pointer-events-none opacity-[0.03] top-12" style="background-image: radial-gradient(#94a3b8 1px, transparent 1px); background-size: 30px 30px;"></div>
            
            <!-- [修改 2] 原 Timeline 容器 -->
            <!-- 关键修复: min-h-0 防止flex子元素溢出, touch-pan-y 允许触摸滚动, overscroll-contain 防止连带父级滚动 -->
            <!-- [修改] 优化 Timeline 容器 (手机端 padding 减小) -->
            <div v-show="!showMap" id="timeline-scroll" class="flex-1 min-h-0 overflow-y-auto p-3 lg:p-10 lg:pr-4 scroll-smooth z-10 touch-pan-y overscroll-contain">
                
                <!-- [优化] 加载更多按钮 -->
                <div v-if="timeline.length > timelinePageSize && !showAllTimeline" class="flex justify-center mb-6 lg:mb-10">
                    <button @click="showAllTimeline = true" class="px-4 lg:px-6 py-2 bg-[var(--bg-panel)] border border-[var(--border-dim)] text-[var(--text-dim)] hover:text-[var(--text-main)] theme-rounded-sm text-xs font-bold uppercase tracking-widest transition">
                        <i class="fa-solid fa-clock-rotate-left mr-2"></i> {{ t('btn_show_all_history') }} ({{ timeline.length }})
                    </button>
                </div>

                <div v-if="timeline.length === 0" class="h-full flex flex-col items-center justify-center text-[var(--text-dim)] opacity-50 relative z-10">
                    <!-- [修改] 替换原有 Icon 为 Logo -->
                    <div class="relative mb-6">
                        <div class="absolute inset-0 bg-indigo-500 blur-3xl opacity-20 rounded-full animate-pulse"></div>
                        <img src="logo.png" class="w-24 h-24 lg:w-32 lg:h-32 object-contain relative z-10 drop-shadow-[0_0_15px_rgba(99,102,241,0.5)]">
                    </div>
                    
                    <p class="text-sm lg:text-lg font-mono-tech font-bold uppercase tracking-widest">{{ t('msg_no_events') }}</p>
                    <p class="text-xs font-mono mt-2 opacity-50">SYSTEM READY. AWAITING INPUT.</p>
                </div>

                <!-- [优化] 遍历 visibleTimeline 而不是 timeline -->
                <!-- 注意：key 必须保持唯一，这里假设 turn.id 是唯一的 -->
                <div v-for="(turn, tIdx) in visibleTimeline" :key="turn.id" class="mb-12 lg:mb-20">
                    <!-- 1. 回合大标题: 手机端改小字号 -->
                    <div class="flex items-center gap-4 lg:gap-6 mb-6 lg:mb-8 group/turn">
                        <div class="h-px bg-[var(--border-dim)] flex-1"></div>
                        <div class="text-center cursor-pointer group/edit" @click="editingTurnId = turn.id">
                            <div v-if="editingTurnId === turn.id" class="flex flex-col items-center gap-2">
                                <input v-model="turn.id" class="bg-black text-white text-2xl lg:text-3xl font-black text-center w-24 border border-indigo-500 theme-rounded-sm p-1">
                                <input v-model="turn.timeRange" class="bg-black text-emerald-400 text-sm lg:text-lg font-mono-tech text-center w-32 lg:w-48 border border-emerald-500 theme-rounded-sm p-1" @blur="saveTurnEdit" @keyup.enter="saveTurnEdit">
                            </div>
                            <div v-else>
                                <h2 class="text-2xl lg:text-5xl font-black text-[var(--text-main)] group-hover/edit:text-[var(--text-dim)] transition">TURN {{ turn.id }}</h2>
                                <div class="text-emerald-700 font-mono-tech font-bold text-xs lg:text-base uppercase tracking-[0.2em] mt-1 group-hover/edit:text-emerald-500 transition">{{ turn.timeRange }}</div>
                            </div>
                        </div>
                        <div class="h-px bg-[var(--border-dim)] flex-1 flex justify-end"><button @click="deleteTurn(tIdx)" class="opacity-100 lg:opacity-0 lg:group-hover/turn:opacity-100 text-[var(--text-dim)] hover:text-red-500 transition px-2 lg:px-4 text-sm lg:text-xl"><i class="fa-solid fa-trash"></i></button></div>
                    </div>

                    <!-- 2. 事件列表: 减小左侧缩进 -->
                    <div class="space-y-6 lg:space-y-12 pl-2 lg:pl-6 border-l-2 border-[var(--border-dim)] ml-2 lg:ml-10">
                        <div v-for="(event, eIdx) in turn.events" :key="eIdx" class="relative group/event">
                            <!-- 修改了连接线的长度，适配新的缩进 -->
                            <div class="absolute -left-[18px] lg:-left-[34px] top-6 lg:top-10 w-2 lg:w-6 h-0.5 bg-[var(--border-dim)] group-hover/event:bg-indigo-500 transition-all"></div>
                            
                            <!-- 新闻卡片本体 -->
                            <div role="article" aria-label="News Event" class="glass-panel theme-rounded border-0 border-l-[4px] lg:border-l-[6px] transition-all duration-300 relative overflow-hidden hover:shadow-[0_10px_50px_var(--shadow-color)]" :style="{ borderLeftColor: getFactionColor(event.factionId) }">
                                <!-- [修改] 背景 Logo: 支持图片 -->
                                <img v-if="isImage(getFactionLogo(event.factionId))" :src="getFactionLogo(event.factionId)" class="event-card-bg-logo opacity-[0.05] grayscale" style="object-fit: contain;">
                                <i v-else :class="getFactionLogo(event.factionId)" class="event-card-bg-logo" :style="{ color: getFactionColor(event.factionId) }"></i>
                                
                                <div class="bg-[var(--bg-header)] px-4 py-3 lg:px-6 lg:py-3 border-b border-[var(--border-highlight)] flex flex-col lg:flex-row justify-between lg:items-center relative z-10 backdrop-blur-sm gap-2">
                                    <div class="flex flex-wrap items-center gap-2 lg:gap-4 font-mono-tech text-xs lg:text-sm font-bold tracking-wider text-[var(--text-dim)]">
                                        <span class="text-[var(--text-dim)]"><i class="fa-regular fa-clock mr-1 lg:mr-2"></i>{{ formatTimeSpan(event) }}</span>
                                        <span class="hidden lg:block w-px h-4 bg-[var(--border-dim)]"></span>
                                        <div class="flex items-center gap-2">
                                            <!-- 遍历所有参与者 -->
                                            <span v-for="(fid, fIdx) in (event.factionIds && event.factionIds.length ? event.factionIds : [event.factionId])" 
                                                :key="fIdx"
                                                class="uppercase flex items-center gap-1.5" 
                                                :style="{ color: getFactionColor(fid) }">
                                                
                                                <!-- 分隔符 (仅在非第一个元素前显示) -->
                                                <span v-if="fIdx > 0" class="text-[var(--text-dim)] text-[10px] opacity-50 mx-0.5">&</span>

                                                <!-- Logo -->
                                                <img v-if="isImage(getFactionLogo(fid))" 
                                                    :src="getFactionLogo(fid)" 
                                                    class="h-3 lg:h-4 w-auto max-w-[24px] object-contain border border-white/20 rounded-[1px] shadow-sm">
                                                <i v-else :class="getFactionLogo(fid) || 'fa-solid fa-users'" class="text-[10px] lg:text-xs opacity-80"></i>
                                                
                                                <!-- Name (如果是多个，字体稍微小一点点) -->
                                                <span :class="(event.factionIds && event.factionIds.length > 1) ? 'text-[10px]' : 'text-xs'">
                                                    {{ getFactionName(fid) }}
                                                </span>
                                            </span>
                                        </div>
                                    </div>
                                    <!-- 修改后 -->
                                    <div class="flex gap-4 items-center self-end lg:self-auto">
                                        <!-- 新增：进入沉浸式剧场 -->
                                        <button @click.stop="startVNMode(event)" class="text-[var(--text-dim)] hover:text-pink-500 transition" title="Play Scene (Galgame Mode)">
                                            <i class="fa-solid fa-clapperboard"></i>
                                        </button>
                                        
                                        <button @click.stop="exportAsImage('event', event)" class="text-[var(--text-dim)] hover:text-emerald-400 transition" title="生成情报简报海报"><i class="fa-solid fa-camera"></i></button>
                                        <button v-if="!isEditingEvent(tIdx, eIdx)" @click.stop="enableEventEdit(tIdx, eIdx)" class="text-[var(--text-dim)] hover:text-[var(--text-main)] transition"><i class="fa-solid fa-pen-to-square"></i></button>
                                        <button v-else @click.stop="saveEventEdit()" class="text-emerald-500 hover:text-[var(--text-main)] transition"><i class="fa-solid fa-floppy-disk"></i></button>
                                    </div>
                                </div>

                                <div class="p-4 lg:p-8 cursor-pointer relative z-10" @click="toggleEventOpen(event)">
                                    <!-- 编辑模式 -->
                                    <div v-if="isEditingEvent(tIdx, eIdx)" @click.stop class="mb-6 space-y-4">
                                        <div class="flex gap-2"><input v-model="event.timeStart" class="input-tech p-2 w-1/2 theme-rounded-sm font-bold text-center" placeholder="t('label_start')"><input v-model="event.timeEnd" class="input-tech p-2 w-1/2 theme-rounded-sm font-bold text-center" placeholder="t('label_end')"></div>
                                        
                                        <!-- [新增] 内联多行动方修改 -->
                                        <div class="bg-[var(--bg-deep)] p-2 theme-rounded-sm border border-[var(--border-dim)] flex flex-wrap gap-2 items-center">
                                            <div class="text-[10px] font-bold text-[var(--text-dim)] uppercase mr-2">ACTORS:</div>
                                            
                                            <!-- 遍历当前 IDs -->
                                            <div v-for="(fid, idx) in (event.factionIds || [event.factionId])" :key="idx" 
                                                class="flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-bold border bg-black/20"
                                                :style="{ color: getFactionColor(fid), borderColor: getFactionColor(fid) }">
                                                {{ getFactionName(fid) }}
                                                <button @click="event.factionIds.splice(idx, 1); if(event.factionIds.length) event.factionId = event.factionIds[0];" class="hover:text-red-500 ml-1"><i class="fa-solid fa-times"></i></button>
                                            </div>

                                            <!-- 添加按钮 -->
                                            <select @change="(e) => { 
                                                if(!event.factionIds) event.factionIds = event.factionId ? [event.factionId] : [];
                                                if(!event.factionIds.includes(e.target.value)) {
                                                    event.factionIds.push(e.target.value);
                                                    event.factionId = event.factionIds[0]; // 更新主ID用于颜色
                                                }
                                                e.target.value=''; 
                                            }" class="bg-transparent text-[var(--text-dim)] text-xs font-bold outline-none cursor-pointer w-4 hover:text-white">
                                                <option value="" disabled selected>+</option>
                                                <option value="global">{{ t('option_global') }}</option>
                                                <option v-for="p in players" :value="p.id" :disabled="(event.factionIds||[]).includes(p.id)">{{ p.name }}</option>
                                            </select>
                                        </div>                                        
                                        <!-- [新增结束] -->
                                        <textarea v-model="event.summary" class="w-full h-24 input-tech p-3 theme-rounded-sm text-lg font-bold resize-none" placeholder="t('label_summary') + '...'"></textarea>
                                        
                                        <div class="bg-[var(--bg-badge)] p-3 theme-rounded-sm border border-[var(--border-dim)]">
                                            <div class="text-[10px] font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('header_manage_impacts') }}</div>
                                            <div class="flex flex-wrap gap-2 mb-3">
                                                <div v-for="(imp, i) in event.impacts" :key="i" class="impact-badge pr-1" 
                                                    :style="{ borderColor: getImpactColor(imp), backgroundColor: getImpactColor(imp) + '15' }">
                                                    
                                                    <!-- A. 属性变更 -->
                                                    <template v-if="!imp.type || imp.type === 'STAT_CHANGE'">
                                                        <span class="text-xs" :style="{ color: getFactionColor(imp.targetId) }">{{ imp.targetName }}.{{ imp.attrLabel }} [{{ imp.newValue }}]</span>
                                                    </template>
                                                    
                                                    <!-- B. 地块转移 -->
                                                    <template v-else-if="imp.type === 'REGION_TRANSFER'">
                                                        <i class="fa-solid fa-map-location-dot text-indigo-400 text-xs"></i>
                                                        <span class="text-[var(--text-dim)] text-xs">{{ imp.targetName }}</span>
                                                        <i class="fa-solid fa-arrow-right text-[10px] mx-1 opacity-50"></i>
                                                        <span class="font-bold text-xs" :style="{color: getFactionColor(imp.newValue)}">{{ getFactionName(imp.newValue) }}</span>
                                                    </template>
                                                    
                                                    <!-- C. 创建实体 -->
                                                    <template v-else-if="imp.type === 'ENTITY_CREATE'">
                                                        <i class="fa-solid fa-user-plus text-emerald-400 text-xs"></i>
                                                        <span class="font-bold text-xs text-emerald-400 ml-1">{{ imp.data?.name }}</span>
                                                    </template>

                                                    <!-- D. 移除实体 -->
                                                    <template v-else-if="imp.type === 'ENTITY_REMOVE'">
                                                        <i class="fa-solid fa-user-minus text-red-400 text-xs"></i>
                                                        <span class="font-bold text-xs text-red-400 decoration-line-through ml-1">{{ getFactionName(imp.targetId) }}</span>
                                                    </template>

                                                    <!-- 删除按钮 -->
                                                    <button @click="removeEventImpact(event, i)" class="ml-2 w-5 h-5 flex items-center justify-center theme-rounded-sm hover:bg-red-500/20 hover:text-red-500 text-[var(--text-dim)] transition"><i class="fa-solid fa-times"></i></button>
                                                </div>
                                            </div>
                                            <!-- [新增] 时间轴内的安科选项编辑器 -->
                                            <div class="bg-[var(--bg-badge)] p-3 theme-rounded-sm border border-[var(--border-dim)] mt-4">
                                                <!-- 标题行：左对齐 -->
                                                <div class="flex items-center gap-3 mb-3">
                                                    <div class="text-[10px] font-bold text-pink-500 uppercase tracking-widest">{{ t('header_anko_options') }}</div>
                                                    <button @click="addOptionToEvent(event)" class="text-[10px] bg-pink-900/20 text-pink-400 border border-pink-500/30 px-2 py-0.5 theme-rounded-sm hover:bg-pink-600 hover:text-white transition flex items-center gap-1">
                                                        <i class="fa-solid fa-plus"></i> {{ t('btn_add') }}
                                                    </button>
                                                </div>
                                                
                                                <div class="space-y-2">
                                                    <div v-for="(opt, oi) in event.options" :key="oi" class="bg-[var(--bg-deep)] p-2 theme-rounded-sm border border-[var(--border-dim)] flex gap-2 items-start">
                                                        <div class="flex-1 space-y-1">
                                                            <div class="flex items-center gap-2">
                                                                <span class="text-[9px] text-pink-500 font-bold uppercase w-8 text-right">{{ t('lbl_opt_label') }}</span>
                                                                <input v-model="opt.label" :placeholder="t('ph_opt_label')" class="flex-1 bg-transparent text-xs font-bold text-pink-400 px-1 border-b border-[var(--border-dim)] outline-none focus:border-pink-500">
                                                            </div>
                                                            <div class="flex items-center gap-2">
                                                                <span class="text-[9px] text-[var(--text-dim)] font-bold uppercase w-8 text-right">{{ t('lbl_opt_desc') }}</span>
                                                                <textarea v-model="opt.desc" :placeholder="t('ph_opt_desc')" class="flex-1 bg-transparent text-[10px] text-[var(--text-dim)] px-1 h-6 resize-none outline-none focus:text-[var(--text-main)] border-b border-transparent focus:border-[var(--border-dim)]"></textarea>
                                                            </div>
                                                        </div>
                                                        <button @click="event.options.splice(oi,1)" class="text-[var(--text-dim)] hover:text-red-400 mt-1"><i class="fa-solid fa-times"></i></button>
                                                    </div>
                                                    <div v-if="!event.options || event.options.length === 0" class="text-center text-[10px] text-[var(--text-dim)] italic opacity-50">{{ t('msg_no_options') }}</div>
                                                </div>
                                            </div>
                                            <!-- [修改 2] 新的添加表单 -->
                                            <div class="flex flex-col gap-2">
                                                <!-- 类型切换按钮 -->
                                                <div class="flex p-1 gap-1 bg-[var(--bg-deep)] theme-rounded-sm border border-[var(--border-dim)]">
                                                    <button @click="editImpactForm.type = 'STAT_CHANGE'" :class="editImpactForm.type === 'STAT_CHANGE' ? 'bg-indigo-600 text-white' : 'text-[var(--text-dim)] hover:bg-[var(--bg-panel)]'" class="flex-1 py-1 text-[10px] font-bold theme-rounded-sm transition">{{ t('btn_type_stat') }}</button>
                                                    <button @click="editImpactForm.type = 'REGION_TRANSFER'" :class="editImpactForm.type === 'REGION_TRANSFER' ? 'bg-indigo-600 text-white' : 'text-[var(--text-dim)] hover:bg-[var(--bg-panel)]'" class="flex-1 py-1 text-[10px] font-bold theme-rounded-sm transition">{{ t('btn_type_region') }}</button>
                                                    <button @click="editImpactForm.type = 'ENTITY_CREATE'" :class="editImpactForm.type === 'ENTITY_CREATE' ? 'bg-emerald-600 text-white' : 'text-[var(--text-dim)] hover:bg-[var(--bg-panel)]'" class="flex-1 py-1 text-[10px] font-bold theme-rounded-sm transition">{{ t('btn_type_create') }}</button>
                                                    <button @click="editImpactForm.type = 'ENTITY_REMOVE'" :class="editImpactForm.type === 'ENTITY_REMOVE' ? 'bg-red-600 text-white' : 'text-[var(--text-dim)] hover:bg-[var(--bg-panel)]'" class="flex-1 py-1 text-[10px] font-bold theme-rounded-sm transition">{{ t('btn_type_remove') }}</button>
                                                </div>

                                                <!-- 条件输入框 -->
                                                <div class="flex gap-2 items-center">
                                                    <!-- 1. 属性变更 -->
                                                    <template v-if="editImpactForm.type === 'STAT_CHANGE'">
                                                        <select v-model="editImpactForm.targetId" class="input-tech h-8 text-xs font-bold theme-rounded-sm outline-none w-1/3"><option value="" disabled selected>Target</option><option v-for="p in players" :value="p.id">{{ p.name }}</option></select>
                                                        <select v-model="editImpactForm.attrKey" class="input-tech h-8 text-xs font-bold theme-rounded-sm outline-none w-1/4"><option value="" disabled selected>Attr</option><option v-for="field in getFieldsForImpactTarget(editImpactForm.targetId)" :value="field.key">{{ field.label }}</option></select>
                                                        <input v-model="editImpactForm.newValue" placeholder="Val" class="input-tech h-8 flex-1 text-xs font-bold theme-rounded-sm outline-none px-2 text-center" @keyup.enter="addEventImpact(event)">
                                                    </template>

                                                    <!-- 2. 地块转移 -->
                                                    <template v-if="editImpactForm.type === 'REGION_TRANSFER'">
                                                        <select v-model="editImpactForm.targetName" class="input-tech h-8 text-xs font-bold theme-rounded-sm outline-none w-1/2"><option value="" disabled selected>Region</option><option v-for="reg in map_data.regions" :value="reg.name">{{ reg.name }}</option></select>
                                                        <select v-model="editImpactForm.newValue" class="input-tech h-8 text-xs font-bold theme-rounded-sm outline-none flex-1"><option value="" disabled selected>New Controller</option><option v-for="p in players" :value="p.id">{{ p.name }}</option></select>
                                                    </template>

                                                    <!-- 3. 创建实体 -->
                                                    <template v-if="editImpactForm.type === 'ENTITY_CREATE'">
                                                        <input v-model="editImpactForm.newValue" placeholder="New Entity Name" class="input-tech h-8 flex-1 text-xs font-bold theme-rounded-sm outline-none px-2" @keyup.enter="addEventImpact(event)">
                                                    </template>

                                                    <!-- 4. 移除实体 -->
                                                    <template v-if="editImpactForm.type === 'ENTITY_REMOVE'">
                                                        <select v-model="editImpactForm.targetId" class="input-tech h-8 text-xs font-bold theme-rounded-sm outline-none w-full"><option value="" disabled selected>Remove Entity</option><option v-for="p in players" :value="p.id">{{ p.name }}</option></select>
                                                    </template>

                                                    <button @click="addEventImpact(event)" class="h-8 w-8 theme-rounded-sm bg-emerald-600 hover:bg-emerald-500 text-white flex items-center justify-center shrink-0"><i class="fa-solid fa-plus"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 浏览模式 -->
                                    <h3 v-else class="text-lg lg:text-2xl font-black text-[var(--text-main)] mb-4 leading-snug">{{ event.summary }}</h3>
                                    
                                    <!-- [修复开始] 添加 Flex 容器 wrapper -->
                                    <div class="flex flex-wrap gap-2 items-center">
                                        <div v-for="(imp, i) in event.impacts" :key="i" class="impact-badge" 
                                            :style="{ borderColor: getImpactColor(imp), backgroundColor: getImpactColor(imp) + '15' }">
                                            
                                            <!-- 1. 属性变更 (默认) -->
                                            <template v-if="!imp.type || imp.type === 'STAT_CHANGE'">
                                                <!-- ... (内容保持不变) ... -->
                                                <div class="flex items-center gap-2 pr-2 border-r" :style="{ borderColor: getFactionColor(imp.targetId) + '40' }">
                                                    <img v-if="isImage(getFactionLogo(imp.targetId))" :src="getFactionLogo(imp.targetId)" class="h-4 w-auto max-w-[24px] object-contain rounded-[1px] border border-white/10">
                                                    <i v-else :class="getFactionLogo(imp.targetId)" :style="{ color: getFactionColor(imp.targetId) }"></i>
                                                    <span class="font-bold text-[10px] lg:text-xs" :style="{ color: getFactionColor(imp.targetId) }">{{ imp.targetName }}</span>
                                                </div>
                                                <div class="font-mono-tech text-[10px] lg:text-xs pl-2 text-[var(--text-main)]">
                                                    <span class="text-[var(--text-dim)] mr-1">{{ imp.attrLabel }}</span>
                                                    <span class="font-bold">{{ resolveVal(imp.oldValue) }} <i class="fa-solid fa-arrow-right text-[10px] mx-1 opacity-50"></i> {{ resolveVal(imp.newValue) }}</span>
                                                </div>
                                            </template>

                                            <!-- 2. 地块转移 -->
                                            <template v-else-if="imp.type === 'REGION_TRANSFER'">
                                                <!-- ... (内容保持不变) ... -->
                                                <div class="flex items-center gap-2">
                                                    <i class="fa-solid fa-map-location-dot text-indigo-400"></i>
                                                    <span class="text-[var(--text-dim)] text-[10px] lg:text-xs">{{ imp.targetName }}</span>
                                                    <i class="fa-solid fa-arrow-right text-[10px] mx-1 opacity-50"></i>
                                                    <div class="flex items-center gap-1">
                                                        <i :class="getFactionLogo(imp.newValue)" :style="{color: getFactionColor(imp.newValue)}"></i>
                                                        <span class="font-bold text-[10px] lg:text-xs" :style="{color: getFactionColor(imp.newValue)}">{{ getFactionName(imp.newValue) }}</span>
                                                    </div>
                                                </div>
                                            </template>

                                            <!-- 3. 创建实体 -->
                                            <template v-else-if="imp.type === 'ENTITY_CREATE'">
                                                <!-- ... (内容保持不变) ... -->
                                                <div class="flex items-center gap-2">
                                                    <i class="fa-solid fa-user-plus text-emerald-400"></i>
                                                    <span class="text-[10px] lg:text-xs opacity-70">New:</span>
                                                    <span class="font-bold text-[10px] lg:text-xs text-emerald-400">{{ imp.data?.name || 'New Entity' }}</span>
                                                </div>
                                            </template>

                                            <!-- 4. 移除实体 -->
                                            <template v-else-if="imp.type === 'ENTITY_REMOVE'">
                                                <!-- ... (内容保持不变) ... -->
                                                <div class="flex items-center gap-2">
                                                    <i class="fa-solid fa-user-minus text-red-400"></i>
                                                    <span class="text-[10px] lg:text-xs opacity-70">Removed:</span>
                                                    <span class="font-bold text-[10px] lg:text-xs text-red-400 decoration-line-through">{{ getFactionName(imp.targetId) }}</span>
                                                </div>
                                            </template>
                                            
                                            <!-- 5. 移动标记 -->
                                            <template v-else-if="imp.type === 'PIN_MOVE'">
                                                <!-- ... (内容保持不变) ... -->
                                                <div class="flex items-center gap-2">
                                                    <i class="fa-solid fa-arrows-up-down-left-right text-pink-400"></i>
                                                    <span class="text-[10px] lg:text-xs opacity-70">Move:</span>
                                                    <span class="font-bold text-[10px] lg:text-xs text-pink-400">{{ imp.targetName }}</span>
                                                    <span class="font-mono text-[10px] bg-black/20 px-1 rounded">{{ imp.oldValue }} <i class="fa-solid fa-arrow-right opacity-50"></i> {{ imp.newValue }}</span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                    <!-- [修复结束] -->

                                    <div class="mt-4 flex justify-center"><i class="fa-solid text-xl transition-transform duration-300" :class="event.isOpen ? 'fa-chevron-up text-indigo-500' : 'fa-chevron-down text-[var(--text-dim)]'"></i></div>
                                </div>

                                <transition name="slide-up">
                                    <div v-if="event.isOpen" class="bg-[var(--bg-glass)] border-t border-[var(--border-highlight)] relative z-10" :class="event.isVNMode ? 'p-0' : 'p-4 lg:p-8'">
                                        
                                        <!-- 编辑模式 (保持不变) -->
                                        <div v-if="isEditingEvent(tIdx, eIdx)" @click.stop class="p-8"><textarea v-model="event.content" class="w-full h-96 input-tech p-4 font-mono-tech rounded"></textarea></div>

                                        <div v-else>
                                            
                                            <!-- 分支 A: 如果是剧本格式 (JSON)，渲染为剧本列表 -->
                                            <div v-if="isJsonScript(event.content)" class="space-y-4 font-serif text-lg leading-relaxed text-[var(--text-main)]">
                                                <div v-for="(line, lIdx) in parseScript(event.content)" :key="lIdx" class="flex gap-4 items-start">
                                                    
                                                    <!-- 1. 头像+名字容器 (左侧) -->
                                                    <div class="shrink-0 w-32 flex flex-col items-end">
                                                        
                                                        <!-- A. 角色头像 -->
                                                        <!-- 如果是旁白 (narrator)，则不显示头像 -->
                                                        <div v-if="line.role !== 'narrator'" class="w-10 h-10 theme-rounded-sm bg-[var(--bg-badge)] border border-[var(--border-dim)] flex items-center justify-center text-lg shadow-inner overflow-hidden mb-1">
                                                            <!-- 优先显示图片 Logo -->
                                                            <img v-if="isImage(getFactionLogo(line.role))" 
                                                                :src="getFactionLogo(line.role)" 
                                                                class="w-full h-full object-contain">
                                                            <!-- 否则显示 FontAwesome Icon -->
                                                            <i v-else 
                                                            :class="getFactionLogo(line.role)" 
                                                            :style="{ color: getFactionColor(line.role) }">
                                                            </i>
                                                        </div>
                                                        
                                                        <!-- B. 角色名 -->
                                                        <div class="font-bold text-sm" 
                                                            :style="{ color: line.role === 'narrator' ? 'var(--text-dim)' : getFactionColor(line.role) }">
                                                            {{ line.role === 'narrator' ? '旁白' : getFactionName(line.role) }}
                                                        </div>
                                                    </div>

                                                    <!-- 2. 对话气泡 (右侧) -->
                                                    <div class="flex-1 mt-1">
                                                        <!-- 如果是旁白，使用引用块样式 -->
                                                        <div v-if="line.role === 'narrator'" class="pl-3 border-l-2 border-[var(--border-dim)] text-[var(--text-dim)] italic">
                                                            {{ line.text }}
                                                        </div>
                                                        <!-- 如果是对话，使用气泡样式 -->
                                                        <div v-else class="bg-[var(--bg-badge)] p-4 theme-rounded-sm border border-[var(--border-dim)] relative speech-bubble">
                                                            {{ line.text }}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- 分支 B: 如果是普通文本，走 Markdown 渲染 -->
                                            <div v-else class="md-content text-sm lg:text-lg" v-html="renderMarkdown(event.content)"></div>
                                            <!-- 原有的选项显示代码保留在这里，作为文档模式下的备选 -->
                                            <div v-if="event.options && event.options.length > 0" class="mt-8 pt-6 border-t border-[var(--border-dim)]">
                                                <!-- ... 原有的选项列表代码 ... -->
                                                <div class="text-[10px] font-bold text-pink-500 uppercase tracking-widest mb-3"><i class="fa-solid fa-diamond-turn-right mr-1"></i> SELECT NEXT ACTION</div>
                                                <div class="flex flex-col gap-2">
                                                    <button v-for="(opt, optIdx) in event.options" :key="optIdx" 
                                                            @click.stop="selectOption(event, opt)"
                                                            class="group relative w-full px-4 py-3 bg-[var(--bg-badge)] hover:bg-pink-900/10 border border-[var(--border-dim)] hover:border-pink-500/50 text-left theme-rounded-sm transition">
                                                        <div v-if="typeof opt === 'object'">
                                                            <div class="text-sm font-bold text-pink-400 group-hover:text-pink-300 mb-1">{{ opt.label }}</div>
                                                            <div class="text-xs text-[var(--text-dim)] leading-relaxed opacity-80">{{ opt.desc }}</div>
                                                        </div>
                                                        <div v-else class="text-sm font-bold text-[var(--text-main)]">{{ opt }}</div>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 底部工具栏 (复制/删除) - 移到最外层以共享 -->
                                        <div v-if="!event.isVNMode" class="pt-4 mt-4 border-t border-[var(--border-dim)] flex justify-end gap-2 lg:gap-4 pb-2">
                                            <!-- ★★★ [新增] 润色按钮 ★★★ -->
                                            <button @click.stop="openPolishModal(event)" class="px-3 py-1.5 lg:px-5 lg:py-2 theme-rounded-sm border border-[var(--border-dim)] text-indigo-400 hover:text-white hover:bg-indigo-600 transition font-bold text-[10px] lg:text-xs uppercase tracking-widest flex items-center gap-2">
                                                <i class="fa-solid fa-wand-magic-sparkles"></i> {{ t('btn_polish_text') }}
                                            </button>
                                            <button @click.stop="copyToClipboard(event.content)" class="px-3 py-1.5 lg:px-5 lg:py-2 theme-rounded-sm border border-[var(--border-dim)] text-[var(--text-dim)] hover:text-[var(--text-main)] hover:bg-[var(--bg-panel)] transition font-bold text-[10px] lg:text-xs uppercase tracking-widest"><i class="fa-regular fa-copy mr-1 lg:mr-2"></i> {{ t('btn_copy') }}</button>
                                            <button @click.stop="deleteEvent(tIdx, eIdx)" class="px-3 py-1.5 lg:px-5 lg:py-2 theme-rounded-sm border border-[var(--border-dim)] text-[var(--text-dim)] hover:text-red-400 hover:bg-red-900/20 transition font-bold text-[10px] lg:text-xs uppercase tracking-widest"><i class="fa-solid fa-trash mr-1 lg:mr-2"></i> {{ t('btn_delete') }}</button>
                                        </div>
                                    </div>
                                </transition>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="h-20 lg:h-40"></div>
            </div>

<!-- [修改后] 地图界面容器 -->
            <div v-show="showMap" class="flex-1 overflow-hidden relative flex flex-col bg-[var(--bg-deep)] z-10 select-none">
                
                <!-- 地图工具栏 -->
                <!-- [修复] 增加 overflow-x-auto 允许横向滚动，移除 justify-between 改为 gap-2 -->
                <div class="p-2 border-b border-[var(--border-dim)] bg-[var(--bg-sidebar)] flex items-center shrink-0 z-20 overflow-x-auto" style="-webkit-overflow-scrolling: touch;">
                    
                    <div class="flex gap-2 items-center">
                        <!-- 上传按钮: 增加 shrink-0, 移动端隐藏文字 -->
                        <label class="cursor-pointer px-3 py-2 lg:py-1 theme-rounded-sm bg-[var(--bg-panel)] border border-[var(--border-dim)] text-[10px] font-bold hover:text-[var(--text-main)] text-[var(--text-dim)] transition flex items-center gap-2 hover:border-indigo-500 shrink-0 whitespace-nowrap">
                            <i class="fa-solid fa-upload"></i> <span class="hidden lg:inline">{{ t('btn_upload_map') }}</span>
                            <input type="file" @change="handleMapUpload" class="hidden" accept="image/*">
                        </label>
                        
                        <div class="h-6 w-px bg-[var(--border-dim)] shrink-0"></div>
                        
                        <!-- 模式切换组: 增加 shrink-0 -->
                        <div class="flex bg-[var(--bg-badge)] theme-rounded-sm border border-[var(--border-dim)] overflow-hidden shrink-0">
                            <button @click="mapToolMode = 'view'" :class="mapToolMode === 'view' ? 'bg-amber-600 text-white shadow-inner' : 'text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="px-3 py-1 text-[10px] font-bold transition flex items-center gap-1 whitespace-nowrap">
                                <i class="fa-solid fa-hand"></i> <span class="hidden lg:inline">{{ t('mode_view') }}</span>
                            </button>
                            <button @click="mapToolMode = 'pin'" :class="mapToolMode === 'pin' ? 'bg-indigo-600 text-white shadow-inner' : 'text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="px-3 py-1 text-[10px] font-bold transition flex items-center gap-1 whitespace-nowrap">
                                <i class="fa-solid fa-location-dot"></i> <span class="hidden lg:inline">{{ t('mode_pin') }}</span>
                            </button>
                            <button @click="mapToolMode = 'region'" :class="mapToolMode === 'region' ? 'bg-emerald-600 text-white shadow-inner' : 'text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="px-3 py-1 text-[10px] font-bold transition flex items-center gap-1 whitespace-nowrap">
                                <i class="fa-solid fa-draw-polygon"></i> <span class="hidden lg:inline">{{ t('mode_region') }}</span>
                            </button>
                        </div>
                        
                        <!-- 适配按钮: 增加 shrink-0 -->
                        <button @click="resetMapView" class="px-3 py-1 theme-rounded-sm bg-[var(--bg-panel)] border border-[var(--border-dim)] text-[10px] font-bold text-[var(--text-dim)] hover:text-[var(--text-main)] shrink-0 whitespace-nowrap"><i class="fa-solid fa-compress"></i> <span class="hidden lg:inline">{{ t('btn_fit') }}</span></button>
                        
                        <!-- 缩放按钮组: 增加 shrink-0 -->
                        <div class="flex bg-[var(--bg-badge)] theme-rounded-sm border border-[var(--border-dim)] shrink-0">
                            <button @click="mapView.scale = Math.max(0.1, mapView.scale - 0.2)" class="px-3 py-1 text-[var(--text-dim)] hover:text-[var(--text-main)] transition"><i class="fa-solid fa-minus"></i></button>
                            <span class="px-2 py-1 text-[10px] font-mono font-bold text-emerald-500 border-l border-r border-[var(--border-dim)] min-w-[40px] text-center flex items-center justify-center">{{ (mapView.scale * 100).toFixed(0) }}%</span>
                            <button @click="mapView.scale = Math.min(10, mapView.scale + 0.2)" class="px-3 py-1 text-[var(--text-dim)] hover:text-[var(--text-main)] transition"><i class="fa-solid fa-plus"></i></button>
                        </div>

                        <div class="h-6 w-px bg-[var(--border-dim)] shrink-0"></div>
                        
                        <!-- 导出/截图/导入: 增加 shrink-0, 移动端隐藏文字 -->
                        <button @click="exportMapConfig" class="px-3 py-2 lg:py-1 theme-rounded-sm bg-[var(--bg-panel)] border border-[var(--border-dim)] text-[10px] font-bold text-[var(--text-dim)] hover:text-emerald-500 transition shrink-0 flex items-center gap-1 whitespace-nowrap">
                            <i class="fa-solid fa-file-export"></i> <span class="hidden lg:inline">{{ t('btn_export') }}</span>
                        </button>
                        <button @click="exportMapImage" class="px-3 py-2 lg:py-1 theme-rounded-sm bg-[var(--bg-panel)] border border-[var(--border-dim)] text-[10px] font-bold text-[var(--text-dim)] hover:text-pink-500 transition shrink-0 flex items-center gap-1 whitespace-nowrap">
                            <i class="fa-solid fa-camera"></i> <span class="hidden lg:inline">{{ t('btn_img') }}</span>
                        </button>
                        <label class="cursor-pointer px-3 py-2 lg:py-1 theme-rounded-sm bg-[var(--bg-panel)] border border-[var(--border-dim)] text-[10px] font-bold text-[var(--text-dim)] hover:text-indigo-500 transition shrink-0 flex items-center gap-1 whitespace-nowrap">
                            <i class="fa-solid fa-file-import"></i> <span class="hidden lg:inline">{{ t('btn_import') }}</span>
                            <input type="file" @change="handleMapConfigImport" class="hidden" accept=".json">
                        </label>
                    </div>

                    <!-- 桌面端提示 (保持隐藏) -->
                    <div class="text-[10px] text-[var(--text-dim)] font-mono-tech gap-4 hidden xl:flex ml-4 shrink-0">
                        <span><i class="fa-solid fa-mouse-pointer mr-1"></i> {{ t('hint_click_pin') }}</span>
                        <span><i class="fa-solid fa-hand mr-1"></i> {{ t('hint_drag') }}</span>
                        <span><i class="fa-solid fa-magnifying-glass mr-1"></i> {{ t('hint_zoom') }}</span>
                    </div>
                    
                    <!-- 徽章控制区: 增加 shrink-0 -->
                    <div class="flex items-center gap-3 border-l border-[var(--border-dim)] pl-3 ml-2 shrink-0">
                        
                        <!-- 1. 显示模式切换 -->
                        <button @click="cycleMapDisplayMode" :title="'Current: ' + mapView.displayMode" class="text-[var(--text-dim)] hover:text-[var(--text-main)] transition w-6 text-center">
                            <i v-if="mapView.displayMode === 'full'" class="fa-solid fa-tags"></i>
                            <i v-else-if="mapView.displayMode === 'icon'" class="fa-solid fa-icons"></i>
                            <i v-else-if="mapView.displayMode === 'flag'" class="fa-solid fa-flag"></i> <!-- 新增旗帜图标 -->
                            <i v-else class="fa-solid fa-circle-dot"></i>
                        </button>

                        <!-- 2. 大小缩放滑块 -->
                        <div class="flex items-center gap-2 group">
                            <i class="fa-solid fa-text-height text-[10px] text-[var(--text-dim)]"></i>
                            <input type="range" v-model.number="mapView.badgeScale" min="0.2" max="2.0" step="0.1" 
                                   class="w-16 h-1 bg-[var(--border-dim)] theme-rounded-sm appearance-none cursor-pointer accent-indigo-500">
                        </div>
                    </div>
                </div>

                <!-- 地图画布容器 -->
                <!-- 关键样式: overflow-hidden (隐藏超出部分), cursor-move (提示可拖拽) -->
                <div class="map-viewport flex-1 overflow-hidden relative bg-[#050505] cursor-move"
                    :class="{ 'map-dragging': mapView.isDragging }" 
                    @wheel.prevent="onMapWheel"
                    @mousedown="onMapMouseDown"
                    @mousemove="onMapMouseMove"
                    @mouseup="onMapMouseUp"
                    @mouseleave="onMapMouseUp"
                    @touchstart="onMapMouseDown"
                    @touchmove="onMapMouseMove"
                    @touchend="onMapMouseUp">
                    
                    <!-- 空状态 -->
                    <div v-if="!map_data.image" class="absolute inset-0 flex flex-col items-center justify-center text-[var(--text-dim)] opacity-30 pointer-events-none gap-4">
                        <!-- [修改] w-32 改为 w-64 (256px) -->
                        <img src="logo.png" class="w-128 h-128 object-contain grayscale opacity-80">
                        <span class="text-xs uppercase font-bold tracking-widest">{{ t('msg_no_map') }}</span>
                    </div>
                    
                    <!-- 
                        变换层 (Transform Layer) 
                        使用 CSS Grid 让所有子元素重叠 (grid-area: 1/1)，
                        这样图片层会自动撑开容器高度，解决塌陷问题。
                    -->
                    <div id="map-capture-target"
                        class="relative inline-grid origin-top-left transition-transform duration-75 ease-out will-change-transform"
                        :style="{ transform: `translate(${mapView.x}px, ${mapView.y}px) scale(${mapView.scale})`, width: '100%', gridTemplateAreas: '\'stack\'' }"
                        @click="onMapBackgroundClick">
                        
                        <!-- [修复] 图层渲染循环 (添加 map-layer-optimized 类) -->
                        <div v-for="(layer, lIdx) in map_data.layers" :key="layer.id"
                             class="w-full h-full pointer-events-none map-layer-optimized"
                             :style="{ zIndex: lIdx, opacity: layer.visible ? layer.opacity : 0, display: layer.visible ? 'block' : 'none', gridArea: 'stack' }">

                            <!-- Type A: 图像层 (Image) -->
                            <!-- 注意：Image 层必须 block w-full 才能撑开父容器 -->
                            <img v-if="layer.type === 'image'" :src="layer.data" class="block w-full h-auto object-contain select-none" draggable="false">

                            <!-- Type B: 地块层 (Region) -->
                            <template v-if="layer.type === 'region'">
                                <!-- 这一层必须 absolute inset-0 覆盖在 Grid 单元格上 -->
                                <div class="absolute inset-0 w-full h-full">
                                    <!-- B1. 遮罩交互区 (SVG Mask) -->
                            <!-- [修改] class 中将 pointer-events-auto 改为 pointer-events-none -->
                            <div v-for="(reg, rIdx) in layer.data" :key="reg.id"
                                v-memo="[reg.id, reg.x, reg.y, reg.w, reg.h, reg.color, reg.ownerId, reg.icon, mapToolMode, map_data.activeLayerId === layer.id, mapView.displayMode, dataVersion]"
                                class="absolute pointer-events-none region-hit-target"
                                :data-rid="reg.id"
                                :data-lid="layer.id"
                                :data-idx="rIdx"
                                :class="mapToolMode === 'region' ? 'cursor-pointer' : ''"
                                :style="{ left: reg.x + '%', top: reg.y + '%', width: reg.w + '%', height: reg.h + '%' }"
                                @click.stop="onRegionClick(reg, rIdx, layer)">
                                
                                <!-- [修改] 给 SVG 增加 pointer-events-auto，让实际形状恢复交互 -->
                                <svg class="w-full h-full overflow-visible pointer-events-auto" viewBox="0 0 100 100" preserveAspectRatio="none">
                                    <defs>
                                        <mask :id="'mask-' + reg.id">
                                            <image :href="reg.maskData" x="0" y="0" width="100" height="100" preserveAspectRatio="none" />
                                        </mask>
                                    </defs>
                                            
                                    <!-- 分支 A: 旗帜填充模式 (智能包围盒投影) -->
                                            <g v-if="mapView.displayMode === 'flag' && isImage(getRegionOwnerLogo(reg))">
                                                <!-- 1. 底色层 -->
                                                <rect x="0" y="0" width="100" height="100" 
                                                    :fill="getRegionColor(reg)" 
                                                    fill-opacity="1" 
                                                    :mask="'url(#mask-' + reg.id + ')'" />
                                                
                                                <!-- 2. 图案层 (调用 getFlagTransform 获取精准坐标) -->
                                                <!-- 
                                                    preserveAspectRatio="none": 
                                                    这里必须设为 none！因为我们的 getFlagTransform 函数
                                                    已经手动计算出了保持比例所需的精确 width/height。
                                                    如果我们再让 SVG 去自作聪明地 slice，反而会破坏我们的计算。
                                                -->
                                                <image :href="getRegionOwnerLogo(reg)"
                                                    :x="getFlagTransform(reg, layer).x"
                                                    :y="getFlagTransform(reg, layer).y"
                                                    :width="getFlagTransform(reg, layer).w"
                                                    :height="getFlagTransform(reg, layer).h"
                                                    preserveAspectRatio="none" 
                                                    :mask="'url(#mask-' + reg.id + ')'"
                                                    class="transition-opacity duration-200 hover:opacity-90" />
                                            </g>
                                                
                                            <!-- 分支 B: 默认纯色填充 -->
                                            <rect v-else
                                                x="0" y="0" width="100" height="100" 
                                                :fill="getRegionColor(reg)" 
                                                fill-opacity="0.5"
                                                :mask="'url(#mask-' + reg.id + ')'" 
                                                class="transition-opacity duration-200 hover:opacity-80" />
                                        </svg>
                                    </div>

                                    <!-- B2. 徽章显示区 -->
                                    <!-- ★★★ [性能优化] v-memo: 分离渲染，标牌和缩放/显示模式强相关 ★★★ -->
                                    <!-- B2. 徽章显示区 -->
                                    <div v-for="(reg, rIdx) in layer.data" :key="'lbl-'+reg.id"
                                        v-memo="[reg.id, reg.centerX, reg.centerY, reg.name, reg.ownerId, reg.icon, reg.color, mapView.badgeScale, mapView.displayMode]"
                                        class="absolute w-0 h-0 flex items-center justify-center pointer-events-none"
                                        :style="{ left: reg.centerX + '%', top: reg.centerY + '%' }">
                                        
                                        <!-- ★★★ [新增] 包裹一层 v-if，只有非 flag 模式才显示徽章 ★★★ -->
                                        <div v-if="mapView.displayMode !== 'flag'" 
                                            class="flex items-center gap-1.5 bg-black/70 backdrop-blur-[2px] border border-white/10 px-2 py-1 theme-rounded-sm shadow-[0_4px_6px_rgba(0,0,0,0.5)] transition-all duration-200"
                                            :style="{ transform: `scale(${mapView.badgeScale})` }">
                                            
                                            <!-- (内部内容保持不变: dot/icon/full 逻辑) -->
                                            <!-- A. 微型模式 (Dot) -->
                                            <div v-if="mapView.displayMode === 'dot'" class="w-2 h-2 rounded-full" :style="{ backgroundColor: getRegionColor(reg) }"></div>

                                            <!-- B. 图标模式/全模式 (Icon) -->
                                            <template v-else>
                                                <img v-if="isImage(getRegionOwnerLogo(reg))" 
                                                    :src="getRegionOwnerLogo(reg)" 
                                                    class="h-5 w-auto max-w-[40px] object-contain shadow-sm border border-white/10 rounded-[1px] self-center">
                                                <i v-else :class="getRegionOwnerLogo(reg)" 
                                                    class="text-sm drop-shadow-[0_1px_2px_rgba(0,0,0,1)] self-center" 
                                                    :style="{ color: getRegionColor(reg) }"></i>
                                                
                                                <!-- C. 仅全模式显示文字 (Text) -->
                                                <div v-if="mapView.displayMode === 'full'" class="flex flex-col leading-none">
                                                    <span class="text-[10px] font-bold whitespace-nowrap shadow-black drop-shadow-md"
                                                        :style="{ color: getRegionColor(reg) }">
                                                        {{ reg.name || 'Unnamed' }}
                                                    </span>
                                                    <span v-if="reg.ownerId" class="text-[8px] font-mono text-[var(--text-dim)] uppercase tracking-tight scale-90 origin-left mt-0.5 truncate">
                                                        {{ getFactionName(reg.ownerId) }}
                                                    </span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <!-- Type C: 标记层 (Marker) -->
                            <template v-if="layer.type === 'marker'">
                                <!-- 同样加上 absolute inset-0 -->
                                <div class="absolute inset-0 w-full h-full">
                                    <!-- ★★★ [性能优化] v-memo: 标记点优化 ★★★ -->
                                    <div v-for="(pin, pIdx) in layer.data" :key="pin.id" 
                                         v-memo="[pin.id, pin.x, pin.y, pin.type, pin.label, pin.linkId, pin.color, pin.icon, mapToolMode, map_data.activeLayerId === layer.id, mapView.badgeScale, mapView.displayMode]"
                                         class="absolute transform -translate-x-1/2 -translate-y-1/2 transition group flex flex-col items-center justify-center origin-center pointer-events-auto"
                                         :class="mapToolMode === 'pin' && map_data.activeLayerId === layer.id ? 'cursor-pointer' : ''"
                                         :style="{ left: pin.x + '%', top: pin.y + '%', transform: `translate(-50%, -50%) scale(${mapView.badgeScale})` }"
                                         @mousedown.stop 
                                         @click.stop="onPinClick(pin, pIdx, layer)">
                                         
                                         <!-- A. 微型模式 (Dot) -->
                                         <div v-if="mapView.displayMode === 'dot'" class="w-3 h-3 rounded-full border border-white shadow-md" :style="{ backgroundColor: getFinalPinColor(pin) }"></div>

                                         <!-- B. 常规模式 (Icon) -->
                                         <template v-else>
                                             <img v-if="isImage(getFinalPinIcon(pin))" 
                                                  :src="getFinalPinIcon(pin)" 
                                                  class="w-12 h-auto object-contain border-[1.5px] shadow-[0_4px_8px_rgba(0,0,0,0.6)] bg-black/20"
                                                  :style="{ borderColor: getFinalPinColor(pin) }">
                                             
                                             <i v-else :class="getFinalPinIcon(pin)" 
                                               class="text-3xl drop-shadow-[0_2px_4px_rgba(0,0,0,0.9)] transition-colors duration-200"
                                               :style="{ color: getFinalPinColor(pin) }"></i>
                                         </template>

                                         <!-- 悬浮提示 -->
                                        <div v-if="mapView.displayMode !== 'dot'" 
                                            class="absolute left-1/2 -translate-x-1/2 bottom-full mb-1.5 bg-black/90 text-[10px] px-2 py-0.5 theme-rounded-sm border whitespace-nowrap pointer-events-none font-bold shadow-lg opacity-0 group-hover:opacity-100 transition-opacity"
                                            :style="{ color: getFinalPinColor(pin), borderColor: getFinalPinColor(pin) + '60' }">
                                        {{ pin.label || getPinName(pin.linkId) }}
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>


            <!-- [新增] 图层管理器面板 (带折叠功能) -->
            <div v-show="showMap" 
                 class="bg-[var(--bg-sidebar)] border-t border-[var(--border-dim)] flex flex-col shrink-0 z-20 transition-all duration-300 ease-in-out"
                 :class="isLayerManagerOpen ? 'h-48' : 'h-8'">
                
                <!-- 头部：点击可折叠/展开 -->
                <div class="px-3 py-1.5 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center cursor-pointer hover:bg-[var(--bg-panel)] transition select-none"
                     @click="isLayerManagerOpen = !isLayerManagerOpen"
                     title="Toggle Layer Manager">
                    
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-layer-group text-[var(--text-dim)] text-xs transition-transform duration-300"
                           :class="isLayerManagerOpen ? 'rotate-0' : '-rotate-90'"></i>
                        <span class="text-[10px] font-bold text-[var(--text-dim)] uppercase tracking-widest">{{ t('header_layer_manager') }}</span>
                    </div>

                    <!-- 按钮组：仅在展开时显示，或者你也可以选择一直显示但需要阻止冒泡 -->
                    <div class="flex gap-1" @click.stop>
                        <button @click="addLayer('image')" title="Add Map Layer" class="theme-rounded-sm border border-[var(--border-dim)] bg-[var(--bg-panel)] text-[var(--text-dim)] hover:text-[var(--text-main)] px-2 py-0.5 text-[10px]"><i class="fa-regular fa-image"></i> {{ t('btn_add_layer_map') }}</button>
                        <button @click="addLayer('region')" title="Add Region Layer" class="theme-rounded-sm border border-[var(--border-dim)] bg-[var(--bg-panel)] text-[var(--text-dim)] hover:text-emerald-500 px-2 py-0.5 text-[10px]"><i class="fa-solid fa-draw-polygon"></i> {{ t('btn_add_layer_reg') }}</button>
                        <button @click="addLayer('marker')" title="Add Marker Layer" class="theme-rounded-sm border border-[var(--border-dim)] bg-[var(--bg-panel)] text-[var(--text-dim)] hover:text-amber-500 px-2 py-0.5 text-[10px]"><i class="fa-solid fa-location-dot"></i> {{ t('btn_add_layer_pin') }}</button>                    </div>
                </div>
                
                <!-- 列表内容：折叠时隐藏以防止布局问题 -->
                <div v-show="isLayerManagerOpen" class="flex-1 overflow-y-auto p-2 space-y-1">
                    <!-- 图层列表项 -->
                    <div v-for="(layer, idx) in map_data.layers" :key="layer.id" 
                         @click="map_data.activeLayerId = layer.id"
                         :class="map_data.activeLayerId === layer.id ? 'bg-[var(--bg-panel)] border-indigo-500 shadow-inner' : 'bg-[var(--bg-badge)] border-transparent hover:border-[var(--border-dim)]'"
                         class="flex items-center gap-3 p-2 theme-rounded-sm border cursor-pointer group transition-all select-none">
                        
                        <!-- 可见性开关 -->
                        <button @click.stop="layer.visible = !layer.visible" class="w-5 text-center shrink-0">
                            <i :class="layer.visible ? 'fa-solid fa-eye text-[var(--text-main)]' : 'fa-solid fa-eye-slash text-[var(--text-dim)] opacity-50'" class="text-xs"></i>
                        </button>
                        
                        <!-- 图层类型图标 -->
                        <div class="w-5 text-center shrink-0">
                            <i v-if="layer.type === 'image'" class="fa-regular fa-image text-[var(--text-dim)] text-xs"></i>
                            <i v-else-if="layer.type === 'region'" class="fa-solid fa-draw-polygon text-emerald-500 text-xs"></i>
                            <i v-else class="fa-solid fa-location-dot text-amber-500 text-xs"></i>
                        </div>

                        <!-- 图层名称 -->
                        <input v-model="layer.name" class="flex-1 bg-transparent text-xs font-bold text-[var(--text-main)] outline-none border-b border-transparent focus:border-[var(--border-dim)]" @click.stop>

                        <!-- 透明度控制 -->
                        <div class="flex items-center gap-1 group/opacity" title="Opacity">
                            <i class="fa-solid fa-circle-half-stroke text-[9px] text-[var(--text-dim)]"></i>
                            <input type="range" v-model.number="layer.opacity" min="0" max="1" step="0.1" class="w-12 h-1 bg-[var(--border-dim)] rounded-lg appearance-none cursor-pointer accent-indigo-500" @click.stop>
                        </div>
                        
                        <!-- 删除与排序 -->
                        <div class="flex gap-1 pl-2 border-l border-[var(--border-dim)] opacity-0 group-hover:opacity-100 transition shrink-0 items-center">
                            <button @click.stop="moveLayer(idx, -1)" class="text-[var(--text-dim)] hover:text-[var(--text-main)] w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-arrow-up text-xs"></i></button>
                            <button @click.stop="moveLayer(idx, 1)" class="text-[var(--text-dim)] hover:text-[var(--text-main)] w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-arrow-down text-xs"></i></button>
                            <button @click.stop="deleteLayer(idx)" class="text-[var(--text-dim)] hover:text-red-400 w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-times text-sm"></i></button>
                        </div>
                    </div>
                    
                    <div v-if="!map_data.layers || map_data.layers.length === 0" class="text-center text-[var(--text-dim)] text-[10px] py-4 italic opacity-50">
                        {{ t('msg_no_layers_created') }}
                    </div>
                </div>
            </div>
        </section>

        <!-- 右侧：指挥台 -->
        <aside role="complementary" aria-label="Command Console" 
            v-show="mobileActiveView === 'console' || isLargeScreen"
            class="w-full h-full lg:w-2/5 bg-[var(--bg-panel)] flex flex-col shrink-0 shadow-[0_0_50px_var(--shadow-color)] z-40 border-l border-[var(--border-dim)] transition-colors duration-300">
            
            <!-- ★★★ 修复后的 Tab 栏容器 ★★★ -->
            <!-- 必须使用 flex w-full shrink-0，确保它只是一条横向的导航栏，不会膨胀 -->
<!-- [修复版] 右侧 Tab 栏：采用 flex-col 优先策略，防止挤压 -->
            <div class="flex border-b border-[var(--border-dim)] bg-[var(--bg-sidebar)] shrink-0">
                
                <!-- 1. 待决 (Staging) -->
                <button @click="tabs.right = 'staging'" 
                        :class="tabs.right === 'staging' ? 'border-indigo-500 text-[var(--text-main)] bg-[var(--bg-panel)]' : 'border-transparent text-[var(--text-dim)] hover:text-[var(--text-main)]'" 
                        class="flex-1 py-2 lg:py-3 border-b-2 lg:border-b-4 font-bold transition text-[10px] lg:text-xs tracking-wide flex flex-col xl:flex-row items-center justify-center gap-1 relative group">
                    <i class="fa-solid fa-layer-group text-sm lg:text-lg mb-0.5 xl:mb-0"></i>
                    <span>{{ t('tab_pending') }}</span>
                    <!-- 计数徽章 -->·
                    <span v-if="pendingEvents.length" class="absolute top-1 right-1 xl:static xl:ml-2 bg-indigo-600 text-white text-[9px] px-1.5 py-0.5 rounded-full leading-none shadow-sm">
                        {{pendingEvents.length}}
                    </span>
                </button>

                <!-- 2. 战斗 (Combat) -->
                <button @click="tabs.right = 'combat'" 
                        :class="tabs.right === 'combat' ? 'border-red-500 text-[var(--text-main)] bg-[var(--bg-panel)]' : 'border-transparent text-[var(--text-dim)] hover:text-[var(--text-main)]'" 
                        class="flex-1 py-2 lg:py-3 border-b-2 lg:border-b-4 font-bold transition text-[10px] lg:text-xs tracking-wide flex flex-col xl:flex-row items-center justify-center gap-1 group">
                    <i class="fa-solid fa-gavel text-sm lg:text-lg mb-0.5 xl:mb-0 group-hover:rotate-12 transition-transform"></i>
                    <span>{{ t('tab_combat') }}</span>
                </button>
                
                <!-- 3. 指令 (Console) -->
                <button @click="tabs.right = 'input'" 
                        :class="tabs.right === 'input' ? 'border-indigo-500 text-[var(--text-main)] bg-[var(--bg-panel)]' : 'border-transparent text-[var(--text-dim)] hover:text-[var(--text-main)]'" 
                        class="flex-1 py-2 lg:py-3 border-b-2 lg:border-b-4 font-bold transition text-[10px] lg:text-xs tracking-wide flex flex-col xl:flex-row items-center justify-center gap-1 group">
                    <i class="fa-solid fa-terminal text-sm lg:text-lg mb-0.5 xl:mb-0"></i>
                    <span>{{ t('tab_console') }}</span>
                </button>

                <!-- 4. 上帝 (God Mode) -->
                <button @click="tabs.right = 'godmode'" 
                        :class="tabs.right === 'godmode' ? 'border-amber-500 text-[var(--text-main)] bg-[var(--bg-panel)]' : 'border-transparent text-[var(--text-dim)] hover:text-[var(--text-main)]'" 
                        class="flex-1 py-2 lg:py-3 border-b-2 lg:border-b-4 font-bold transition text-[10px] lg:text-xs tracking-wide flex flex-col xl:flex-row items-center justify-center gap-1 group">
                    <i class="fa-solid fa-hand-sparkles text-sm lg:text-lg mb-0.5 xl:mb-0 group-hover:text-amber-400 transition-colors"></i>
                    <span>{{ t('tab_godmode') }}</span>
                </button>
            </div>

            <!-- 下面紧接着应该是 <div class="h-[40%] ..."> 不要删除后面的代码 -->
            <div class="h-[40%] lg:h-[30%] min-h-[200px] border-b border-[var(--border-dim)] bg-[var(--bg-header)] overflow-y-auto p-3 lg:p-5 relative">
                <div v-if="tabs.right === 'staging'" class="space-y-3 pb-20"> <!-- 增加底部 padding 防止遮挡 -->
                    
                    <!-- [修改] 增加拖拽属性和事件监听 -->
                    <div v-for="(evt, idx) in pendingEvents" :key="'p-'+idx" 
                         draggable="true"
                         @dragstart="onStagingDragStart(idx, $event)"
                         @dragover.prevent
                         @dragenter.prevent
                         @drop="onStagingDrop(idx)"
                         class="bg-[var(--bg-badge)] border border-[var(--border-highlight)] theme-rounded p-3 relative group transition-all cursor-move hover:border-indigo-500/50 hover:shadow-md"
                         :class="draggedStagingIndex === idx ? 'opacity-50 border-dashed border-indigo-500' : ''">
                        
                        <!-- 侧边颜色条 -->
                        <div class="absolute left-0 top-0 bottom-0 w-1" :style="{ backgroundColor: getFactionColor(evt.factionId) }"></div>
                        
                        <div class="pl-3 pr-8"> <!-- pr-8 留出删除按钮空间 -->
                            <!-- 头部信息 -->
                            <div class="flex justify-between text-[10px] text-[var(--text-dim)] font-bold uppercase mb-1 font-mono-tech select-none">
                                <span><i class="fa-solid fa-grip-lines mr-1 opacity-50 cursor-move"></i> {{ evt.timeStart }} - {{ evt.timeEnd }}</span>
                                <span :style="{ color: getFactionColor(evt.factionId) }">{{ getFactionName(evt.factionId) }}</span>
                            </div>
                            
                            <!-- 摘要 -->
                            <div class="text-sm font-bold text-[var(--text-main)] mb-2 truncate select-none">{{ evt.summary }}</div>
                            
                            <!-- Impacts 预览 -->
                            <div class="flex flex-wrap gap-1 mb-3">
                                <span v-for="imp in evt.impacts" class="text-[9px] px-1.5 py-0.5 theme-rounded-sm border font-mono-tech truncate max-w-[150px]" 
                                      :style="{ borderColor: getImpactColor(imp), color: getImpactColor(imp), backgroundColor: getImpactColor(imp)+'10' }">
                                    {{ imp.targetName }}.{{ imp.attrLabel }} → {{ resolveVal(imp.newValue) }}
                                </span>
                            </div>

                            <!-- ★★★ [新增] 显式操作栏 ★★★ -->
                            <div class="flex justify-end gap-2 border-t border-[var(--border-dim)] pt-2 mt-2">
                                <!-- 1. 载入按钮 (复制到编辑器) -->
                                <button @click.stop="loadFromStaging(idx)" class="px-2 py-1 bg-indigo-600 hover:bg-indigo-500 text-white text-[10px] font-bold theme-rounded-sm transition flex items-center gap-1">
                                    <i class="fa-solid fa-pen-to-square"></i> {{ t('btn_load_copy') }}
                                </button>
                            </div>
                        </div>

                        <!-- 2. 删除按钮 (右上角悬浮) -->
                        <button @click.stop="deleteFromStaging(idx)" class="absolute top-1 right-1 w-6 h-6 flex items-center justify-center text-[var(--text-dim)] hover:text-red-400 transition z-10" :title="t('btn_remove_item')">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>

                    <!-- 空状态保持不变 -->
                    <div v-if="pendingEvents.length === 0" class="h-full flex flex-col items-center justify-center text-[var(--text-dim)] opacity-50 mt-10">
                        <i class="fa-solid fa-inbox text-5xl mb-3"></i>
                        <span class="font-mono-tech uppercase font-bold tracking-widest text-sm">{{ t('msg_empty_queue') }}</span>
                    </div>
                </div>
                <div v-if="tabs.right === 'input'" class="h-full relative overflow-hidden group">
                    <!-- [新增] 背景水印 Logo -->
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none select-none">
                        <!-- [修改] 去掉了 rotate-[-5deg] -->
                        <img src="logo.png" 
                            class="w-64 h-64 object-contain opacity-[0.08] transition-transform duration-700 ease-in-out group-hover:scale-110 group-hover:opacity-[0.12]">
                    </div>

                    <!-- 原输入框 (添加 relative z-10 确保在图片上层) -->
                    <textarea v-model="rawInput" class="relative z-10 w-full h-full bg-transparent border-none outline-none text-[var(--text-main)] font-mono-tech p-4 resize-none text-base leading-relaxed placeholder-opacity-30" :placeholder="t('placeholder_input')"></textarea>
                </div>
                <!-- [新增] 战斗系统面板 -->
                <div v-if="tabs.right === 'combat'" class="h-full flex flex-col p-5 overflow-y-auto relative">
                    <div class="absolute inset-0 bg-red-900/5 pointer-events-none"></div>
                    <div class="text-[10px] text-red-500 font-bold uppercase tracking-widest mb-4"><i class="fa-solid fa-crosshairs mr-1"></i> {{ t('header_combat') }}</div>

                    <!-- 1. 双方选择 -->
                    <div class="flex items-center gap-2 mb-4">
                        <div class="flex-1 bg-[var(--bg-badge)] p-2 theme-rounded-sm border border-red-500/30">
                            <div class="text-[9px] text-[var(--text-dim)] uppercase mb-1">{{ t('lbl_attacker') }}</div>
                            <!-- [修改] text-red-400 改为动态 style -->
                            <select v-model="combatForm.attackerId" 
                                    class="w-full bg-transparent text-sm font-bold outline-none transition-colors duration-300"
                                    :style="{ color: combatForm.attackerId ? getFactionColor(combatForm.attackerId) : '#f87171' }">
                                <option value="" disabled>{{ t('opt_select') }}</option>
                                <option v-for="p in players" :value="p.id">{{ p.name }}</option>
                            </select>
                        </div>
                        <div class="text-[var(--text-dim)] font-black text-lg">VS</div>
                        <div class="flex-1 bg-[var(--bg-badge)] p-2 theme-rounded-sm border border-blue-500/30">
                            <div class="text-[9px] text-[var(--text-dim)] uppercase mb-1">{{ t('lbl_defender') }}</div>
                            <!-- [修改] text-blue-400 改为动态 style -->
                            <select v-model="combatForm.defenderId" 
                                    class="w-full bg-transparent text-sm font-bold outline-none transition-colors duration-300"
                                    :style="{ color: combatForm.defenderId ? getFactionColor(combatForm.defenderId) : '#60a5fa' }">
                                <option value="" disabled>{{ t('opt_select') }}</option>
                                <option v-for="p in players" :value="p.id">{{ p.name }}</option>
                            </select>
                        </div>
                    </div>
                    <!-- 1.5 战斗地点 (新增) -->
                    <div class="mb-4">
                        <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-1"><i class="fa-solid fa-map-pin mr-1"></i> {{ t('label_combat_loc') || 'Location' }}</label>
                        <select v-model="combatForm.locationId" class="w-full input-tech p-2 theme-rounded-sm text-xs font-bold outline-none">
                            <option value="">{{ t('opt_no_loc') }}</option>
                            <optgroup :label="t('optgroup_regions')">
                                <option v-for="r in map_data.regions" :value="r.name">{{ r.name }} ({{ getFactionName(r.ownerId) }})</option>
                            </optgroup>
                            <optgroup :label="t('optgroup_pins')">
                                <option v-for="p in map_data.pins" :value="p.label || p.id">{{ p.label || 'Marker' }}</option>
                            </optgroup>
                        </select>
                    </div>

                <!-- 2. 战斗背景/意图 -->
                    <div class="mb-4">
                        <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-1">{{ t('label_combat_context') }}</label>
                        <textarea v-model="combatForm.context" :placeholder="t('ph_combat_context')" class="w-full h-16 input-tech p-2 theme-rounded-sm text-xs resize-none outline-none"></textarea>
                    </div>

                <!-- 3. 骰子序列系统 (大尺寸动画版) -->
                    <div class="bg-[var(--bg-input)] p-4 theme-rounded-sm border border-[var(--border-dim)] mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <label class="text-[10px] font-bold text-[var(--text-dim)] uppercase">{{ t('label_dice_check') }}</label>
                            <button @click="addCombatDie" class="text-[10px] bg-[var(--bg-badge)] border border-[var(--border-dim)] px-2 py-0.5 theme-rounded-sm hover:text-emerald-400 transition"><i class="fa-solid fa-plus mr-1"></i> {{ t('btn_add_die') }}</button>
                        </div>
                        
                        <!-- 骰子列表 -->
                        <div class="space-y-3 max-h-[250px] overflow-y-auto pr-2">
                            <!-- [修改] 增大整体间距和内边距 (p-3, gap-3) -->
                            <div v-for="(die, idx) in combatForm.dicePool" :key="idx" class="flex items-center gap-3 bg-[var(--bg-deep)] p-3 theme-rounded-sm border border-[var(--border-dim)]">
                                
                                <!-- [修改] 增大图标尺寸 (text-4xl)，并给固定宽度 (w-12) -->
                                <i class="w-12 text-center text-4xl text-[var(--text-dim)] transition-transform duration-300" 
                                :class="[getDieIcon(die.type), isRollingDice ? 'dice-rolling-animation' : '']"></i>
                                
                                <!-- 垂直分割线 -->
                                <div class="w-px h-10 bg-[var(--border-dim)]"></div>
                                
                                <div class="flex-1 flex flex-col gap-2">
                                    <!-- 上排: 意图 -->
                                    <input v-model="die.label" :placeholder="t('ph_die_intent')" class="w-full bg-transparent text-sm font-bold outline-none border-b border-transparent focus:border-[var(--text-dim)] transition placeholder-opacity-50 placeholder-[var(--text-dim)]">
                                    
                                    <!-- 下排: 类型选择 -->
                                    <select v-model="die.type" @change="die.val = null" class="w-full bg-transparent text-[10px] font-mono font-bold outline-none text-[var(--text-dim)]">
                                        <option value="d6">D6 - Standard Cube</option>
                                        <option value="d20">D20 - Icosahedron</option>
                                        <option value="d100">D100 - Percentile</option>
                                    </select>
                                </div>

                                <!-- [修改] 增大结果显示区字体和宽度 (text-4xl, w-16) -->
                                <div class="w-16 text-center font-mono font-black text-4xl" :class="getDiceColorClass(die.val, die.type)">
                                    {{ die.val !== null ? die.val : '-' }}
                                </div>

                                <!-- [修改] 增大删除按钮 -->
                                <button @click="combatForm.dicePool.splice(idx, 1)" class="text-xl text-[var(--text-dim)] hover:text-red-400 px-2 self-start"><i class="fa-solid fa-times"></i></button>
                            </div>
                        </div>

                        <!-- [优化] 仪式感投掷按钮 -->
                        <button @click="rollCombatDice" :disabled="combatForm.dicePool.length === 0" class="w-full mt-4 py-3 bg-gradient-to-r from-indigo-900 to-slate-900 border border-indigo-500/50 theme-rounded-sm hover:from-indigo-800 hover:to-slate-800 transition active:scale-95 flex items-center justify-center gap-3 font-black text-sm uppercase tracking-[0.15em] group shadow-[0_0_15px_rgba(99,102,241,0.2)] text-indigo-100">
                            <i class="fa-solid fa-dice-d20 text-lg group-hover:rotate-180 transition-transform duration-500"></i>
                            {{ t('btn_roll_all') }}
                        </button>
                    </div>

                    <!-- 4. 执行按钮 -->
                    <div class="mt-auto">
                        <button @click="executeCombat" :disabled="isThinking || !combatForm.attackerId || !combatForm.defenderId || combatForm.dicePool.length === 0 || combatForm.dicePool[0].val === null" class="w-full py-3 bg-red-700 hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold text-xs uppercase tracking-widest theme-rounded-sm shadow-lg flex items-center justify-center gap-2 transition">
                            <i v-if="isThinking" class="fa-solid fa-circle-notch fa-spin"></i>
                            <i v-else class="fa-solid fa-gavel"></i>
                            {{ t('btn_judge_combat') }}
                        </button>
                    </div>
                </div>
                <div v-if="tabs.right === 'godmode'" class="h-full flex flex-col p-5 relative">
                    <div class="absolute inset-0 bg-amber-900/5 pointer-events-none"></div>
                    <!-- [新增] 上帝模式专属水印 (金色、发光) -->
                    <div class="absolute -bottom-20 -right-20 pointer-events-none opacity-20 group-hover:opacity-30 transition-opacity duration-500">
                         <!-- 这里的 sepia hue-rotate 是为了把 logo 染成琥珀色/金色 -->
                        <img src="logo.png" class="w-80 h-80 object-contain rotate-[-15deg] sepia saturate-200 hue-rotate-[10deg]">
                    </div>
                    <div class="text-[10px] text-amber-500 font-bold uppercase tracking-widest mb-2"><i class="fa-solid fa-database mr-1"></i> {{ t('header_godmode') }}</div>
                    <p class="text-xs text-[var(--text-dim)] mb-4 leading-relaxed">{{ t('msg_godmode_desc') }}</p>
                    <textarea v-model="godModeInput" class="flex-1 bg-[var(--bg-input)] border border-amber-500/30 theme-rounded-sm p-3 text-sm font-mono text-[var(--text-main)] resize-none outline-none focus:border-amber-500 transition" placeholder="t('ph_godmode')"></textarea>
                    <div class="mt-4 flex justify-end">
                        <button @click="executeGodMode" :disabled="isThinking || !godModeInput.trim()" class="px-6 py-2 bg-amber-600 hover:bg-amber-500 text-white font-bold text-xs uppercase tracking-widest theme-rounded-sm shadow-lg flex items-center gap-2 disabled:opacity-50">
                            <i :class="isThinking ? 'fa-solid fa-circle-notch fa-spin' : 'fa-solid fa-bolt'"></i> {{ t('btn_execute') }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- 右侧面板下半部分：编辑器与底栏 -->
            <div class="flex-1 flex flex-col bg-[var(--bg-panel)] relative overflow-hidden">
                
                <!-- 1. 顶部：AI 按钮栏 -->
                <div class="p-4 bg-[var(--bg-sidebar)] border-b border-[var(--border-dim)] shadow-xl z-20 shrink-0">
                    <div class="flex justify-between items-center mb-2 gap-2">
                        <span class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest flex-1"><i class="fa-solid fa-microchip mr-1"></i> {{ t('ai_core_label') }}</span>
                        <!-- 新增：模式切换 -->
                        <button @click="useGalgamePrompt = !useGalgamePrompt" 
                            :class="useGalgamePrompt ? 'bg-purple-600 border-purple-500 text-white' : 'bg-[var(--bg-badge)] border-[var(--border-dim)] text-[var(--text-dim)]'"
                            class="px-3 py-1.5 theme-rounded-sm border text-[10px] font-bold transition-all duration-300 flex items-center gap-2">
                            <i :class="useGalgamePrompt ? 'fa-solid fa-comments' : 'fa-solid fa-file-lines'"></i>
                            <span>{{ useGalgamePrompt ? 'MODE: GALGAME' : 'MODE: REPORT' }}</span>
                        </button>

                        <!-- 安科模式开关 -->
                        <button @click="generateOptions = !generateOptions" 
                            :class="generateOptions ? 'bg-pink-600 border-pink-500 text-white shadow-[0_0_15px_rgba(219,39,119,0.4)]' : 'bg-[var(--bg-badge)] border-[var(--border-dim)] text-[var(--text-dim)] hover:text-[var(--text-main)]'"
                            class="px-3 py-1.5 theme-rounded-sm border text-[10px] font-bold transition-all duration-300 flex items-center gap-2">
                            <i :class="generateOptions ? 'fa-solid fa-dice text-white' : 'fa-solid fa-dice text-[var(--text-dim)]'"></i>
                            <span>{{ generateOptions ? t('header_anko_on') : t('header_anko_mode') }}</span>
                        </button>
                    </div>
                    <button @click="openContextModal" :disabled="isThinking" class="w-full py-4 theme-rounded-sm bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-500 hover:to-indigo-600 text-white font-bold text-sm tracking-widest shadow-lg shadow-indigo-900/30 transition disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-3">
                        <i :class="isThinking ? 'fa-solid fa-circle-notch fa-spin' : 'fa-solid fa-bolt'"></i>
                        {{ isThinking ? t('status_thinking') : t('btn_ai_deduce') }}
                    </button>
                </div>

                <!-- 2. 中间：滚动输入区域 (关键：flex-1 overflow-y-auto) -->
                <div class="flex-1 flex flex-col overflow-y-auto p-0 min-h-0 relative h-[60%] lg:h-auto">
                    
                    <!-- 行动方 & 时间 -->
                    <div class="p-3 lg:p-5 border-b border-[var(--border-dim)] flex flex-col lg:flex-row gap-2 lg:gap-4 bg-[var(--bg-header)] items-start">
                        <div class="flex-1 space-y-2">
                            <div>
                                <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-1 tracking-wider">{{ t('label_actor') }} (Multi)</label>
                                <div class="w-full input-tech theme-rounded-sm p-2 flex flex-wrap gap-2 min-h-[46px]">
                                    <!-- 1. 已选列表 -->
                                    <div v-for="(fid, idx) in editor.factionIds" :key="idx" 
                                        class="flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-bold border cursor-default bg-[var(--bg-deep)]"
                                        :style="{ color: getFactionColor(fid), borderColor: getFactionColor(fid) }">
                                        <span>{{ getFactionName(fid) }}</span>
                                        <button @click="editor.factionIds.splice(idx, 1); updateEditorPrimary()" class="hover:text-red-500 ml-1"><i class="fa-solid fa-times"></i></button>
                                    </div>

                                    <!-- 2. 添加下拉框 -->
                                    <select @change="addActorToEditor($event)" class="bg-transparent text-[var(--text-dim)] text-xs font-bold outline-none cursor-pointer w-6 flex-1 min-w-[20px] hover:text-[var(--text-main)] transition" title="Add Actor">
                                        <option value="" disabled selected>+</option>
                                        <option value="global">{{ t('option_global') }}</option>
                                        <option v-for="p in players" :value="p.id" :disabled="editor.factionIds.includes(p.id)">{{ p.name }}</option>
                                    </select>
                                </div>
                            </div>
                        </div> <!-- ✅ 补上这个闭合标签 -->

                        <!-- 下面是时间输入框，现在它们会正确排列在右侧了 -->
                        <div class="w-1/4">
                            <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-1 tracking-wider">{{ t('label_start') }}</label>
                            <input v-model="editor.timeStart" class="w-full input-tech theme-rounded-sm p-3 text-sm font-mono-tech text-center outline-none">
                        </div>
                        <div class="w-1/4">
                            <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-1 tracking-wider">{{ t('label_end') }}</label>
                            <input v-model="editor.timeEnd" class="w-full input-tech theme-rounded-sm p-3 text-sm font-mono-tech text-center outline-none">
                        </div>
                    </div>

                    <!-- 摘要 -->
                    <div class="p-3 lg:p-5 border-b border-[var(--border-dim)]">
                        <label class="block text-[10px] font-bold text-emerald-500 uppercase mb-1 lg:mb-2 tracking-widest">{{ t('label_summary') }}</label>
                        <textarea v-model="editor.summary" class="w-full h-16 lg:h-24 input-tech theme-rounded-sm p-2 lg:p-3 text-sm lg:text-lg font-bold text-[var(--text-main)] resize-none outline-none leading-normal" placeholder="..."></textarea>
                    </div>

                    <!-- 状态变更 -->
                    <div class="p-5 border-b border-[var(--border-dim)] bg-[var(--bg-badge)]">
                        <label class="block text-[10px] font-bold text-amber-500 uppercase mb-3 tracking-widest">{{ t('label_impact') }}</label>
                        
                            <!-- Impact 列表显示区 -->
                            <div class="flex flex-wrap gap-3 mb-4">
                                <div v-for="(imp, idx) in editor.impacts" :key="idx" 
                                    class="impact-badge pr-0 overflow-hidden relative" 
                                    :style="{ borderColor: validateImpact(imp).valid ? getImpactColor(imp) : '#ef4444' }"
                                    :title="validateImpact(imp).valid ? '' : validateImpact(imp).msg"> <!-- 鼠标悬停显示错误信息 -->
                                    
                                    <!-- 1. 属性变更 Badge -->
                                    <template v-if="imp.type === 'STAT_CHANGE'">
                                        <template v-if="imp.targetId === 'global'">
                                            <div class="flex items-center gap-2 pr-2 border-r border-slate-500/40">
                                                <i class="fa-solid fa-globe text-slate-400"></i>
                                                <span class="font-bold text-xs text-slate-400">{{ imp.targetName }}</span>
                                            </div>
                                            <div class="font-mono-tech text-xs text-[var(--text-main)] pl-2">
                                                <span class="text-[var(--text-dim)] mr-1">{{ imp.attrLabel }}</span>
                                                <span class="font-bold">{{ resolveVal(imp.oldValue) }} → {{ resolveVal(imp.newValue) }}</span>
                                            </div>
                                        </template>
                                        <template v-else>
                                            <div class="flex items-center gap-2 pr-2 border-r" :style="{ borderColor: getFactionColor(imp.targetId) + '40' }">
                                                <img v-if="isImage(getFactionLogo(imp.targetId))" :src="getFactionLogo(imp.targetId)" class="h-4 w-auto max-w-[24px] object-contain rounded-[1px] border border-white/10">
                                                <i v-else :class="getFactionLogo(imp.targetId)" :style="{ color: getFactionColor(imp.targetId) }"></i>
                                                <span class="font-bold text-xs" :style="{ color: getFactionColor(imp.targetId) }">{{ imp.targetName }}</span>
                                            </div>
                                            <div class="font-mono-tech text-xs text-[var(--text-main)] pl-2">
                                                <span class="text-[var(--text-dim)] mr-1">{{ imp.attrLabel }}</span>
                                                <span class="font-bold">{{ resolveVal(imp.oldValue) }} <i class="fa-solid fa-arrow-right text-[10px] mx-1 opacity-50"></i> {{ resolveVal(imp.newValue) }}</span>
                                            </div>
                                        </template>
                                    </template>
                                
                                    <!-- 其他类型 (略，保持不变) -->
                                    <template v-else-if="imp.type === 'REGION_TRANSFER'">
                                        <i class="fa-solid fa-map-location-dot mr-1 text-indigo-400"></i>
                                        <span class="text-[var(--text-dim)] text-xs">{{ imp.targetName }}</span>
                                        <i class="fa-solid fa-arrow-right text-[10px] mx-1 opacity-50"></i>
                                        <span class="font-bold text-xs" :style="{color: getFactionColor(imp.newValue)}">{{ getFactionName(imp.newValue) }}</span>
                                    </template>
                                    <template v-else-if="imp.type === 'ENTITY_CREATE'">
                                        <i class="fa-solid fa-user-plus mr-1 text-emerald-400"></i>
                                        <span class="font-bold text-xs text-emerald-400 ml-1">{{ imp.data?.name }}</span>
                                    </template>
                                    <template v-else-if="imp.type === 'ENTITY_REMOVE'">
                                        <i class="fa-solid fa-user-minus mr-1 text-red-400"></i>
                                        <span class="font-bold text-xs text-red-400 ml-1">{{ getFactionName(imp.targetId) }}</span>
                                    </template>
                                    <template v-else-if="imp.type === 'PIN_MOVE'">
                                        <i class="fa-solid fa-arrows-up-down-left-right mr-1 text-pink-400"></i>
                                        <span class="font-bold text-xs text-pink-400">{{ imp.targetName }}</span>
                                        <span class="font-mono text-[10px] ml-1 opacity-70">to [{{ imp.newValue }}]</span>
                                    </template>

                                <button @click="removeImpact(idx)" class="ml-2 w-8 self-stretch flex items-center justify-center bg-black/10 hover:bg-red-500/20 text-[var(--text-dim)] hover:text-red-400"><i class="fa-solid fa-times"></i></button>
                            </div>
                        </div>
                        
                        <!-- Impact 编辑器 -->
                        <div class="bg-[var(--bg-badge)] p-2 theme-rounded-sm border border-[var(--border-dim)]">
                            <!-- 类型选择 -->
                            <div class="flex p-1 gap-1 bg-[var(--bg-deep)] theme-rounded-sm border border-[var(--border-dim)] mb-2 overflow-x-auto">
                                <button @click="impactForm.type = 'STAT_CHANGE'" :class="impactForm.type === 'STAT_CHANGE' ? 'bg-indigo-600 text-white' : 'text-[var(--text-dim)] hover:bg-[var(--bg-panel)]'" class="flex-1 py-1 px-2 text-[10px] font-bold theme-rounded-sm transition whitespace-nowrap">{{ t('btn_type_stat') }}</button>
                                <button @click="impactForm.type = 'REGION_TRANSFER'" :class="impactForm.type === 'REGION_TRANSFER' ? 'bg-indigo-600 text-white' : 'text-[var(--text-dim)] hover:bg-[var(--bg-panel)]'" class="flex-1 py-1 px-2 text-[10px] font-bold theme-rounded-sm transition whitespace-nowrap">{{ t('btn_type_region') }}</button>
                                <button @click="impactForm.type = 'ENTITY_CREATE'" :class="impactForm.type === 'ENTITY_CREATE' ? 'bg-emerald-600 text-white' : 'text-[var(--text-dim)] hover:bg-[var(--bg-panel)]'" class="flex-1 py-1 px-2 text-[10px] font-bold theme-rounded-sm transition whitespace-nowrap">{{ t('btn_type_create') }}</button>
                                <button @click="impactForm.type = 'ENTITY_REMOVE'" :class="impactForm.type === 'ENTITY_REMOVE' ? 'bg-red-600 text-white' : 'text-[var(--text-dim)] hover:bg-[var(--bg-panel)]'" class="flex-1 py-1 px-2 text-[10px] font-bold theme-rounded-sm transition whitespace-nowrap">{{ t('btn_type_remove') }}</button>
                                <button @click="impactForm.type = 'PIN_MOVE'" :class="impactForm.type === 'PIN_MOVE' ? 'bg-pink-600 text-white' : 'text-[var(--text-dim)] hover:bg-[var(--bg-panel)]'" class="flex-1 py-1 px-2 text-[10px] font-bold theme-rounded-sm transition whitespace-nowrap">{{ t('btn_type_pin') }}</button>
                            </div>

                            <!-- 条件表单 -->
                            <div class="flex gap-3 items-center">
                                <!-- Form 1: Stat Change -->
                                <template v-if="impactForm.type === 'STAT_CHANGE'">
                                    <select v-model="impactForm.targetId" class="input-tech text-xs p-2 w-1/3 outline-none">
                                        <option value="" disabled>{{ t('ph_target_entity') }}</option>
                                        <option value="global" class="text-amber-500 font-bold">【全局环境】</option>
                                        <option v-for="p in players" :value="p.id">{{ p.name }}</option>
                                    </select>
                                    <select v-model="impactForm.attrKey" class="input-tech text-xs p-2 w-1/4 outline-none">
                                        <option value="" disabled>{{ t('ph_attribute') }}</option>
                                        <template v-if="impactForm.targetId === 'global'">
                                            <option v-for="g in global_vars" :value="g.key">{{ g.key }}</option>
                                        </template>
                                        <template v-else>
                                            <option v-for="field in getFieldsForImpactTarget(impactForm.targetId)" :value="field.key">{{ field.label }}</option>
                                        </template>
                                    </select>
                                    <div class="px-2 text-[10px] text-center text-[var(--text-dim)] font-mono bg-[var(--bg-badge)] theme-rounded-sm h-8 flex items-center justify-center min-w-[40px]">
                                        {{ getAttrValueDisplay(impactForm.targetId, impactForm.attrKey) }} <i class="fa-solid fa-arrow-right ml-1"></i>
                                    </div>
                                    <input v-model="impactForm.newValue" @keyup.enter="addImpact" :placeholder="t('ph_new_value')" class="input-tech text-emerald-400 font-bold font-mono-tech theme-rounded-sm p-2 flex-1 outline-none text-center">
                                </template>
                                
                                <!-- 其他类型表单 (REGION/CREATE/REMOVE/PIN) ... (保持原有代码逻辑) -->
                                <template v-if="impactForm.type === 'REGION_TRANSFER'">
                                    <select v-model="impactForm.targetName" class="input-tech text-xs p-2 w-1/2 outline-none"><option value="" disabled>{{ t('ph_target_region') }}</option><option v-for="reg in map_data.regions" :value="reg.name">{{ reg.name }}</option></select>
                                    <select v-model="impactForm.newValue" class="input-tech text-xs p-2 flex-1 outline-none"><option value="" disabled>{{ t('ph_new_controller') }}</option><option v-for="p in players" :value="p.id">{{ p.name }}</option></select>
                                </template>
                                <template v-if="impactForm.type === 'ENTITY_CREATE'">
                                    <input v-model="impactForm.newValue" :placeholder="t('ph_new_entity_name')" class="input-tech font-bold theme-rounded-sm p-2 flex-1 outline-none">
                                </template>
                                <template v-if="impactForm.type === 'ENTITY_REMOVE'">
                                    <select v-model="impactForm.targetId" class="input-tech text-xs p-2 w-full outline-none"><option value="" disabled>{{ t('ph_entity_remove') }}</option><option v-for="p in players" :value="p.id">{{ p.name }}</option></select>
                                </template>
                                <template v-if="impactForm.type === 'PIN_MOVE'">
                                    <select v-model="impactForm.targetId" class="input-tech text-xs p-2 w-1/2 outline-none"><option value="" disabled>Select Pin</option><option v-for="pin in map_data.pins" :value="pin.id">{{ pin.label || getPinName(pin.linkId) }}</option></select>
                                    <input v-model="impactForm.newValue" placeholder="X,Y" class="input-tech text-xs p-2 w-full font-mono outline-none text-center">
                                </template>
                                
                                <button @click="addImpact" class="h-8 w-10 theme-rounded-sm bg-emerald-600 hover:bg-emerald-500 text-white flex items-center justify-center shrink-0"><i class="fa-solid fa-plus"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- 详细内容 (设置 min-h 防止挤压) -->
                    <div class="p-3 lg:p-5 flex flex-col flex-1 min-h-[200px] lg:min-h-[400px] relative pb-20 lg:pb-20">
                        <label class="block text-[10px] font-bold text-indigo-400 uppercase mb-2 tracking-widest">{{ t('label_details') }}</label>
                        
                        <!-- 内容输入框 -->
                        <textarea v-model="editor.content" class="flex-1 input-tech theme-rounded-sm p-4 text-base font-mono-tech text-[var(--text-main)] resize-none outline-none leading-relaxed h-full min-h-[200px]" :placeholder="t('ph_editor_content')"></textarea>
                        
                        <!-- 安科手动选项 -->
                        <div class="mt-4 pt-4 border-t border-[var(--border-dim)]">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="text-[10px] font-bold text-pink-500 uppercase tracking-widest"><i class="fa-solid fa-list-ul mr-1"></i> {{ t('lbl_manual_options') }}</div>
                                <button @click="addOptionToEditor" class="text-[10px] bg-pink-900/20 text-pink-400 border border-pink-500/30 px-2 py-0.5 theme-rounded-sm hover:bg-pink-600 hover:text-white transition flex items-center gap-1">
                                    <i class="fa-solid fa-plus"></i> {{ t('btn_add') }}
                                </button>
                            </div>
                            <div v-if="editor.options && editor.options.length > 0" class="space-y-2">
                                <div v-for="(opt, oi) in editor.options" :key="oi" class="bg-[var(--bg-badge)] p-2 theme-rounded-sm border border-[var(--border-dim)] flex gap-2 items-start group">
                                    <div class="flex-1 space-y-1">
                                        <input v-model="opt.label" class="w-full bg-transparent text-xs font-bold text-[var(--text-main)] outline-none border-b border-[var(--border-dim)] placeholder-pink-500/30" :placeholder="t('ph_opt_label')">
                                        <input v-model="opt.desc" class="w-full bg-transparent text-xs text-[var(--text-dim)] outline-none placeholder-[var(--text-dim)]/30" :placeholder="t('ph_opt_desc')">
                                    </div>
                                    <button @click="editor.options.splice(oi,1)" class="text-[var(--text-dim)] hover:text-red-400"><i class="fa-solid fa-times"></i></button>
                                </div>
                            </div>
                            <div v-else class="text-[10px] text-[var(--text-dim)] italic opacity-30 py-1 pl-1">{{ t('msg_no_manual_options') }}</div>
                        </div>

                        <!-- ★★★ 之前丢失的 "Add to Pending" 按钮 ★★★ -->
                        <!-- 悬浮在编辑器右下角 -->
                        <div class="absolute bottom-8 right-8 z-20">
                            <button @click="addToStaging" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 theme-rounded-sm shadow-xl font-bold text-sm transition transform active:scale-95 hover:-translate-y-1 flex items-center gap-2">
                                <i class="fa-solid fa-plus"></i> {{ t('btn_add_pending') }}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 3. 底部：Commit 按钮 (关键：shrink-0 z-50) -->
                <!-- ★★★ 之前丢失的 Footer 区域 ★★★ -->
                <div class="bg-[var(--bg-sidebar)] p-5 border-t border-[var(--border-dim)] flex justify-between items-center shadow-[0_-10px_40px_var(--shadow-color)] z-50 shrink-0 relative">
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] text-[var(--text-dim)] font-bold uppercase tracking-widest">{{ t('label_next_turn_b') }}</span>
                        <input v-model="pendingTurnRange" class="bg-[var(--bg-input)] border border-[var(--border-dim)] text-emerald-500 font-mono-tech text-sm font-bold theme-rounded-sm px-2 py-0.5 w-24 outline-none text-center" :placeholder="t('auto')">
                    </div>
                    <button @click="commitTurn" :disabled="pendingEvents.length === 0" class="px-8 py-3 bg-indigo-600 hover:bg-indigo-500 disabled:bg-[var(--bg-input)] disabled:text-[var(--text-dim)] text-white font-bold text-sm tracking-widest uppercase theme-rounded-sm shadow-lg transition transform active:scale-[0.98] flex items-center gap-3">
                        <i class="fa-solid fa-play"></i> {{ t('btn_commit') }}
                    </button>
                </div>

            </div>
        </aside>

    </main>

    <!-- [修复] 底部导航栏：非大屏且键盘未弹出时显示 -->
    <div v-if="!isLargeScreen && !isKeyboardOpen" class="h-14 bg-[var(--bg-header)] border-t border-[var(--border-dim)] flex shrink-0 z-50">
        <button @click="mobileActiveView = 'library'" :class="mobileActiveView==='library' ? 'text-emerald-500' : 'text-[var(--text-dim)]'" class="flex-1 flex flex-col items-center justify-center gap-1 transition-colors">
            <i class="fa-solid fa-book text-lg"></i><span class="text-[10px] font-bold">资料</span>
        </button>
        <button @click="mobileActiveView = 'main'" :class="mobileActiveView==='main' ? 'text-indigo-500' : 'text-[var(--text-dim)]'" class="flex-1 flex flex-col items-center justify-center gap-1 transition-colors">
            <i class="fa-solid fa-map-location-dot text-lg"></i><span class="text-[10px] font-bold">视图</span>
        </button>
        <button @click="mobileActiveView = 'console'" :class="mobileActiveView==='console' ? 'text-amber-500' : 'text-[var(--text-dim)]'" class="flex-1 flex flex-col items-center justify-center gap-1 transition-colors">
            <i class="fa-solid fa-terminal text-lg"></i><span class="text-[10px] font-bold">指令</span>
        </button>
    </div>
    <!-- [新增] 截图模式辅助层 -->
    <div v-if="isScreenshotMode" class="screenshot-backdrop" @mousemove="handleScreenshotHover" @click.stop.prevent="captureScreenshot" @contextmenu.prevent="exitScreenshotMode"></div>
    <div v-if="isScreenshotMode && screenshotRect.w > 0" class="screenshot-overlay" :style="{ top: screenshotRect.y + 'px', left: screenshotRect.x + 'px', width: screenshotRect.w + 'px', height: screenshotRect.h + 'px' }">
        <div class="screenshot-label">SNAP: {{ screenshotTargetName }} (Click to Save)</div>
    </div>
<!-- HIDDEN POSTER CANVAS -->
    <div id="poster-canvas">
        
        <!-- TEMPLATE 1: TERMINAL (完全修复版) -->
        <div v-if="ui.theme !== 'newspaper'" class="poster-terminal" :style="{ borderLeftColor: posterData.color }">
            <div class="bg-texture"></div>
            <i :class="posterData.icon" class="poster-watermark-logo" :style="{ color: posterData.color }"></i>
            
            <div class="poster-header">
                <div class="text-slate-400 font-mono-tech text-3xl font-bold tracking-wider flex items-center">
                    <i class="fa-regular fa-clock mr-4"></i>{{ posterData.timeDisplay }}
                </div>
                <div class="uppercase flex items-center gap-4 text-3xl font-bold tracking-wider whitespace-nowrap" :style="{ color: posterData.color }">
                    <i class="fa-solid fa-tower-broadcast opacity-80"></i> {{ posterData.factionName }}
                </div>
            </div>

            <div class="poster-body">
                <h1 class="leading-tight">{{ posterData.title }}</h1>
                
                <!-- 属性徽章：恢复左右分栏结构 -->
                <div v-if="posterData.badges && posterData.badges.length > 0" class="poster-badge-container">
                    <div v-for="(badge, i) in posterData.badges" :key="i" class="poster-badge" :style="{ borderColor: badge.color }">
                        <div class="poster-badge-left">
                            <i :class="badge.icon" :style="{ color: badge.color }"></i>
                            <span :style="{ color: badge.color }">{{ badge.name }}</span>
                        </div>
                        <div class="poster-badge-right">
                            <span class="text-slate-400 uppercase mr-4 tracking-wider">{{ badge.label }}</span>
                            <i class="fa-solid fa-arrow-right text-slate-600 mr-4 text-sm"></i>
                            <span class="font-bold text-white tracking-wide">{{ badge.val }}</span>
                        </div>
                    </div>
                </div>

                <div class="poster-md md-body" v-html="posterData.content"></div>
            </div>

            <div class="poster-footer">
                <div class="flex items-center gap-4"><i class="fa-solid fa-layer-group text-indigo-500"></i><span>LEVANT 自动化推演</span></div>
                <div class="flex flex-col items-end"><span class="text-slate-500 text-sm mb-1 font-bold">POWERED BY 絜矩 (QQ 2124223354)</span><span class="text-emerald-500 font-bold">LEVANT v1.10</span></div>
            </div>
        </div>

        <!-- TEMPLATE 2: NEWSPAPER (保留所有优化) -->
        <div v-else class="poster-newspaper">
            <div class="paper-grain"></div>
            
            <div class="news-header">
                <div class="brand">NEWS</div>
                <div class="meta">
                    <span>Vol. {{ timeline.length + 1 }}</span>
                    <span>{{ posterData.timeDisplay }}</span>
                    <span>{{ posterData.factionName }}</span>
                </div>
            </div>

            <h1 class="headline">{{ posterData.title }}</h1>

            <div v-if="posterData.badges && posterData.badges.length > 0" class="badges-row">
                 <div v-for="(badge, i) in posterData.badges" :key="i" class="stamp-badge">
                     <i :class="badge.icon"></i>
                     <span>{{ badge.label }}: {{ badge.val }}</span>
                 </div>
            </div>

            <div class="poster-md content-cols" v-html="posterData.content"></div>

            <div style="margin-top: auto; border-top: 1px solid #333; padding-top: 20px; text-align: center; font-family: monospace; font-size: 14px; color: #555;">
                {{ t('poster_footer_text') }} | POWERED BY 絜矩 (QQ 2124223354)
            </div>
        </div>

    </div>

    <!-- Context Assembler Modal (已修复并应用 i18n) -->
    <transition name="fade">
        <div v-if="showContextModal" class="modal-mask">
            <div role="dialog" aria-label="Context Assembler" class="glass-panel theme-rounded w-[900px] h-[90vh] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <!-- Header -->
                <div class="p-5 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center shrink-0">
                    <div>
                        <h3 class="text-xl font-bold text-[var(--text-main)]"><i class="fa-solid fa-layer-group mr-2 text-indigo-400"></i>{{ t('modal_context_title') }}</h3>
                        <p class="text-xs text-[var(--text-dim)] mt-1">{{ t('modal_context_subtitle') }}</p>
                    </div>
                    <button @click="showContextModal = false" class="text-[var(--text-dim)] hover:text-[var(--text-main)] w-10 h-10 flex items-center justify-center text-xl"><i class="fa-solid fa-times"></i></button>
                </div>

                <div class="flex-1 flex overflow-hidden">
                    <!-- 左侧：组装流水线 -->
                    <div class="w-1/2 p-5 bg-[var(--bg-panel)] overflow-y-auto border-r border-[var(--border-dim)]">
                        <!-- System Prompt -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-[var(--text-dim)] uppercase tracking-widest">{{ t('set_sys_prompt') }} (Temp)</label>
                            </div>
                            <textarea v-model="tempSystemPrompt" class="w-full h-24 bg-[var(--bg-badge)] border border-[var(--border-dim)] theme-rounded-sm p-2 text-xs text-[var(--text-main)] font-mono resize-none"></textarea>
                        </div>
                        <!-- 模块列表 (拖拽排序) -->
                        <div class="space-y-4">
                            <div v-for="type in contextConfig.order" :key="type">
                                <!-- [新增] Custom Prompt 模块 -->
                                <div v-if="type === 'custom'" class="border border-pink-500/30 theme-rounded-sm bg-pink-900/10">
                                    <div class="p-2 bg-pink-900/20 border-b border-pink-500/20 flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" v-model="contextConfig.includeCustom" class="accent-pink-500">
                                            <span class="text-xs font-bold text-pink-400 uppercase">★ {{ t('ctx_custom') }}</span>
                                        </div>
                                        <div class="flex gap-2 text-[var(--text-dim)] text-[10px] items-center">
                                            <button @click="moveContextItem('custom', -1)" class="w-8 h-8 flex items-center justify-center bg-black/10 hover:bg-black/30 theme-rounded-sm transition"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('custom', 1)" class="w-8 h-8 flex items-center justify-center bg-black/10 hover:bg-black/30 theme-rounded-sm transition"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                    <div v-if="contextConfig.includeCustom" class="p-2 text-[10px] text-[var(--text-dim)] font-mono truncate">
                                        {{ settings.prompts.custom || '(Empty)' }}
                                    </div>
                                </div>
                                <!-- 🔴 当前指令 -->
                                <div v-if="type === 'current'" class="border border-red-500/30 theme-rounded-sm bg-red-900/10">
                                    <div class="p-2 bg-red-900/20 border-b border-red-500/20 flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" v-model="contextConfig.includeCurrent" class="accent-red-500">
                                            <span class="text-xs font-bold text-red-400 uppercase">🔴 {{ t('ctx_current') }}</span>
                                        </div>
                                        <div class="flex gap-2 text-[var(--text-dim)] text-[10px] items-center">
                                            <button @click="moveContextItem('current', -1)" class="w-8 h-8 flex items-center justify-center bg-black/10 hover:bg-black/30 theme-rounded-sm transition"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('current', 1)" class="w-8 h-8 flex items-center justify-center bg-black/10 hover:bg-black/30 theme-rounded-sm transition"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                    <div v-if="contextConfig.includeCurrent" class="p-2 text-[10px] text-[var(--text-dim)] font-mono space-y-1">
                                        <div v-if="rawInput" class="truncate">CMD: {{ rawInput }}</div>
                                        <div v-if="editor.summary" class="truncate text-[var(--text-main)]">Summary: {{ editor.summary }}</div>
                                    </div>
                                </div>
                                <!-- 全局变量 -->
                                <div v-if="type === 'global'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" v-model="contextConfig.includeGlobal" class="accent-indigo-500">
                                            <span class="text-xs font-bold text-indigo-400 uppercase">{{ t('ctx_global') }}</span>
                                        </div>
                                        <div class="flex gap-2 text-[var(--text-dim)] text-[10px] items-center">
                                            <button @click="moveContextItem('global', -1)" class="w-8 h-8 flex items-center justify-center bg-[var(--bg-panel)] border border-[var(--border-dim)] theme-rounded-sm transition hover:text-[var(--text-main)]"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('global', 1)" class="w-8 h-8 flex items-center justify-center bg-[var(--bg-panel)] border border-[var(--border-dim)] theme-rounded-sm transition hover:text-[var(--text-main)]"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <!-- 规则 -->
                                <div v-if="type === 'rules'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" v-model="contextConfig.includeRules" class="accent-indigo-500">
                                            <span class="text-xs font-bold text-amber-400 uppercase">{{ t('ctx_rules') }}</span>
                                        </div>
                                        <div class="flex gap-2 text-[var(--text-dim)] text-[10px] items-center">
                                            <button @click="moveContextItem('rules', -1)" class="w-8 h-8 flex items-center justify-center bg-[var(--bg-panel)] border border-[var(--border-dim)] theme-rounded-sm transition hover:text-[var(--text-main)]"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('rules', 1)" class="w-8 h-8 flex items-center justify-center bg-[var(--bg-panel)] border border-[var(--border-dim)] theme-rounded-sm transition hover:text-[var(--text-main)]"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Lore -->
                                <div v-if="type === 'lore'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs font-bold text-emerald-400 uppercase">{{ t('ctx_lore') }}</span>
                                        </div>
                                        <div class="flex gap-2 text-[var(--text-dim)] text-[10px] items-center">
                                            <button @click="moveContextItem('lore', -1)" class="w-8 h-8 flex items-center justify-center bg-[var(--bg-panel)] border border-[var(--border-dim)] theme-rounded-sm transition hover:text-[var(--text-main)]"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('lore', 1)" class="w-8 h-8 flex items-center justify-center bg-[var(--bg-panel)] border border-[var(--border-dim)] theme-rounded-sm transition hover:text-[var(--text-main)]"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                    <div class="p-2 space-y-1 max-h-40 overflow-y-auto">
                                        <div v-for="(entry, i) in contextConfig.loreList" :key="i" class="flex items-center gap-2 context-item" :class="{'active': entry.active, 'disabled': !entry.active}">
                                            <input type="checkbox" v-model="entry.active" class="accent-emerald-500">
                                            <span class="text-xs text-[var(--text-main)] truncate flex-1">{{ entry.keys }}</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Players -->
                                <div v-if="type === 'players'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs font-bold text-blue-400 uppercase">{{ t('ctx_entities') }}</span>
                                        </div>
                                        <div class="flex gap-2 text-[var(--text-dim)] text-[10px] items-center">
                                            <button @click="moveContextItem('players', -1)" class="w-8 h-8 flex items-center justify-center bg-[var(--bg-panel)] border border-[var(--border-dim)] theme-rounded-sm transition hover:text-[var(--text-main)]"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('players', 1)" class="w-8 h-8 flex items-center justify-center bg-[var(--bg-panel)] border border-[var(--border-dim)] theme-rounded-sm transition hover:text-[var(--text-main)]"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                    <div class="p-2 space-y-1 max-h-40 overflow-y-auto">
                                        <div v-for="(p, i) in contextConfig.playerList" :key="i" class="flex items-center gap-2 context-item" :class="{'active': p.active, 'disabled': !p.active}">
                                            <input type="checkbox" v-model="p.active" class="accent-blue-500">
                                            <span class="text-xs truncate flex-1 font-bold" :style="{ color: p.color }">{{ p.name }}</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Map Data 模块 -->
                                <div v-if="type === 'map'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" v-model="contextConfig.includeMap" class="accent-pink-500">
                                            <span class="text-xs font-bold text-pink-400 uppercase">{{ t('view_map') }} DATA</span>
                                        </div>
                                        <div class="flex gap-2 text-[var(--text-dim)] text-[10px] items-center">
                                            <button @click="moveContextItem('map', -1)" class="w-8 h-8 flex items-center justify-center bg-[var(--bg-panel)] border border-[var(--border-dim)] theme-rounded-sm transition hover:text-[var(--text-main)]"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('map', 1)" class="w-8 h-8 flex items-center justify-center bg-[var(--bg-panel)] border border-[var(--border-dim)] theme-rounded-sm transition hover:text-[var(--text-main)]"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                    <div v-if="contextConfig.includeMap" class="p-2 space-y-3 max-h-60 overflow-y-auto">
                                        <div v-if="contextConfig.mapRegionList.length > 0">
                                            <div class="text-[9px] font-bold text-[var(--text-dim)] uppercase mb-1 flex justify-between">
                                                <span><i class="fa-solid fa-draw-polygon mr-1"></i>Regions</span>
                                                <span class="opacity-50">{{ contextConfig.mapRegionList.filter(r=>r.active).length }}/{{ contextConfig.mapRegionList.length }}</span>
                                            </div>
                                            <div class="space-y-1">
                                                <div v-for="(reg, i) in contextConfig.mapRegionList" :key="'reg'+i" 
                                                    class="flex items-center gap-2 context-item py-1" 
                                                    :class="{'active': reg.active, 'disabled': !reg.active}">
                                                    <input type="checkbox" v-model="reg.active" class="accent-pink-500">
                                                    <span class="text-xs text-[var(--text-main)] truncate flex-1">{{ reg.name }}</span>
                                                    <span class="text-[9px] px-1 bg-black/20 rounded text-[var(--text-dim)]">{{ getFactionName(reg.ownerId) }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div v-if="contextConfig.mapPinList.length > 0">
                                            <div class="text-[9px] font-bold text-[var(--text-dim)] uppercase mb-1 mt-2 flex justify-between">
                                                <span><i class="fa-solid fa-map-pin mr-1"></i>Pins (POI)</span>
                                                <span class="opacity-50">{{ contextConfig.mapPinList.filter(p=>p.active).length }}/{{ contextConfig.mapPinList.length }}</span>
                                            </div>
                                            <div class="space-y-1">
                                                <div v-for="(pin, i) in contextConfig.mapPinList" :key="'pin'+i" 
                                                    class="flex items-center gap-2 context-item py-1" 
                                                    :class="{'active': pin.active, 'disabled': !pin.active}">
                                                    <input type="checkbox" v-model="pin.active" class="accent-orange-500">
                                                    <span class="text-xs text-[var(--text-main)] truncate flex-1">{{ pin.label || getPinName(pin.linkId) || 'Marker' }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div v-if="contextConfig.mapRegionList.length === 0 && contextConfig.mapPinList.length === 0" class="text-center py-4 opacity-50 text-xs">
                                            (No Map Data)
                                        </div>
                                    </div>
                                </div>
                                <!-- History -->
                                <div v-if="type === 'history'" class="border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-sidebar)]">
                                    <div class="p-2 bg-[var(--bg-header)] border-b border-[var(--border-dim)] flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" v-model="contextConfig.includeHistory" class="accent-indigo-500">
                                            <span class="text-xs font-bold text-[var(--text-main)] uppercase">{{ t('ctx_history') }}</span>
                                        </div>
                                        <div class="flex gap-2 text-[var(--text-dim)] text-[10px] items-center">
                                            <button @click="moveContextItem('history', -1)" class="w-8 h-8 flex items-center justify-center bg-[var(--bg-panel)] border border-[var(--border-dim)] theme-rounded-sm transition hover:text-[var(--text-main)]"><i class="fa-solid fa-arrow-up"></i></button>
                                            <button @click="moveContextItem('history', 1)" class="w-8 h-8 flex items-center justify-center bg-[var(--bg-panel)] border border-[var(--border-dim)] theme-rounded-sm transition hover:text-[var(--text-main)]"><i class="fa-solid fa-arrow-down"></i></button>
                                        </div>
                                    </div>
                                    <div v-if="contextConfig.includeHistory" class="p-4 space-y-4">
                                        <div>
                                            <div class="flex justify-between text-[10px] font-bold text-emerald-500 mb-1 uppercase tracking-wider">
                                                <span>{{ t('ctx_hist_deep') }}</span>
                                                <span>{{ contextConfig.historyDeepDepth }} Turns</span>
                                            </div>
                                            <input type="range" v-model.number="contextConfig.historyDeepDepth" min="0" max="5" class="w-full h-1 bg-[var(--border-dim)] theme-rounded-sm appearance-none cursor-pointer accent-emerald-500">
                                        </div>
                                        <div>
                                            <div class="flex justify-between text-[10px] font-bold text-[var(--text-dim)] mb-1 uppercase tracking-wider">
                                                <span>{{ t('ctx_hist_shallow') }}</span>
                                                <span>{{ contextConfig.historyShallowDepth }} Turns</span>
                                            </div>
                                            <input type="range" v-model.number="contextConfig.historyShallowDepth" min="0" max="20" class="w-full h-1 bg-[var(--border-dim)] theme-rounded-sm appearance-none cursor-pointer">
                                        </div>
                                        <div class="text-[10px] text-[var(--text-dim)] italic border-t border-[var(--border-dim)] pt-2 mt-2">
                                            Total Context: Past {{ contextConfig.historyShallowDepth + contextConfig.historyDeepDepth }} Turns <i class="fa-solid fa-arrow-right mx-1"></i> Present
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧：实时预览 -->
                    <div class="w-1/2 p-5 bg-[var(--bg-header)] flex flex-col">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-[var(--text-dim)] uppercase tracking-widest">{{ t('ctx_preview_label') }}</label>
                            <span class="text-xs font-mono text-indigo-400">{{ finalContextPreview.length }} chars</span>
                        </div>
                        <textarea readonly :value="finalContextPreview" class="flex-1 w-full bg-[var(--bg-deep)] border border-[var(--border-dim)] theme-rounded-sm p-4 text-xs font-mono text-[var(--text-dim)] resize-none outline-none leading-relaxed"></textarea>
                    </div>
                </div>

                <!-- Footer -->
                <div class="p-5 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center shrink-0">
                    <!-- 左侧：提示语 + 图例 -->
                    <div class="flex flex-col">
                        <div class="text-xs text-[var(--text-dim)] mb-1">{{ t('ctx_preview_hint') }}</div>
                        <div class="flex gap-3 text-[10px] font-mono font-bold">
                            <span class="text-emerald-500"><i class="fa-solid fa-eye"></i> Normal</span>
                            <span class="text-amber-500"><i class="fa-solid fa-lock"></i> [LOCK] = Read-Only</span>
                            <span class="text-[var(--text-dim)] decoration-line-through"><i class="fa-solid fa-eye-slash"></i> Hidden (Removed)</span>
                        </div>
                    </div>
                    
                    <!-- 右侧：按钮 -->
                    <button @click="runAiInference" :disabled="isThinking" class="px-8 py-3 theme-rounded-sm bg-emerald-600 hover:bg-emerald-500 text-white font-bold text-sm shadow-lg transition flex items-center gap-2">
                        <i v-if="isThinking" class="fa-solid fa-circle-notch fa-spin"></i>
                        <i v-else class="fa-solid fa-bolt"></i>
                        {{ t('btn_execute') }}
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <!-- Modals (Settings) -->
    <transition name="fade">
        <div v-if="showSettings" class="modal-mask">
            <div role="dialog" aria-label="Settings" class="glass-panel theme-rounded w-[600px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-6 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center">
                    <h2 class="text-xl font-bold"><i class="fa-solid fa-sliders mr-2 text-[var(--text-dim)]"></i> {{ t('settings_title') }}</h2>
                    <button @click="showSettings = false" class="text-[var(--text-dim)] hover:text-[var(--text-main)] w-10 h-10 flex items-center justify-center text-xl"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-8 space-y-8 bg-[var(--bg-panel)] max-h-[70vh] overflow-y-auto">
                    
                    <!-- ★★★ [新增] 新手引导区块 (放在最顶部) ★★★ -->
                    <section class="border-b border-[var(--border-dim)] pb-6 mb-2">
                        <div class="flex items-center gap-4 bg-gradient-to-r from-emerald-900/20 to-transparent p-4 theme-rounded-sm border border-emerald-500/30">
                            <!-- 图标 -->
                            <div class="w-12 h-12 rounded-full bg-emerald-600/20 flex items-center justify-center shrink-0 border border-emerald-500/50">
                                <i class="fa-solid fa-book-open-reader text-2xl text-emerald-400"></i>
                            </div>
                            
                            <!-- 文字 -->
                            <div class="flex-1">
                                <h3 class="text-sm font-bold text-emerald-400 uppercase tracking-wider mb-1">
                                    {{ t('header_welcome_guide') || 'First Time User?' }}
                                </h3>
                                <p class="text-xs text-[var(--text-dim)] leading-relaxed">
                                    {{ t('desc_welcome_guide') || 'Check out the user manual to learn core concepts and how to start.' }}
                                </p>
                            </div>

                            <!-- 按钮 -->
                            <button @click="showHelpModal = true" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold theme-rounded-sm shadow-lg transition flex items-center gap-2 shrink-0">
                                <i class="fa-solid fa-life-ring"></i> {{ t('btn_help_center') }}
                            </button>
                        </div>
                    </section>
                    <!-- UI 设置 -->
                    <section>
                        <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-4 pb-2 border-b border-[var(--border-dim)]">{{ t('settings_ui') }}</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-[var(--text-dim)] mb-2">{{ t('settings_theme') }}</label>
                                <select v-model="ui.theme" class="w-full input-tech theme-rounded-sm p-3 text-sm outline-none">
                                    <option value="terminal">Terminal (Dark)</option>
                                    <option value="newspaper">Newspaper (Light)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-[var(--text-dim)] mb-2">{{ t('settings_lang') }}</label>
                                <select v-model="ui.lang" class="w-full input-tech theme-rounded-sm p-3 text-sm outline-none">
                                    <option value="zh">中文 (Chinese)</option>
                                    <option value="en">English</option>
                                    <option value="ja">日本語 (Japanese)</option>
                                </select>
                            </div>
                        </div>
                    </section>
                    
                    <section>
                        <div class="flex justify-between items-center mb-4 pb-2 border-b border-[var(--border-dim)]">
                            <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-widest">{{ t('header_api_profiles') }}</h3>
                            <button @click="openProfileEditor(null)" class="px-3 py-1 theme-rounded-sm bg-indigo-600 text-white text-[10px] font-bold hover:bg-indigo-500 transition">
                                <i class="fa-solid fa-plus mr-1"></i> {{ t('btn_add_profile') }}
                            </button>
                        </div>

                        <!-- 1. 配置列表 -->
                        <div class="space-y-2 mb-6">
                            <div v-for="(prof, idx) in settings.api_profiles" :key="prof.id" 
                                 @click="selectProfile(prof)"
                                 class="p-3 theme-rounded-sm border transition cursor-pointer flex items-center gap-3 group relative overflow-hidden"
                                 :class="settings.active_profile_id === prof.id ? 'bg-indigo-900/20 border-indigo-500 shadow-[0_0_10px_rgba(99,102,241,0.2)]' : 'bg-[var(--bg-badge)] border-[var(--border-dim)] hover:border-[var(--text-dim)]'">
                                
                                <!-- 选中指示器 -->
                                <div class="w-4 h-4 rounded-full border flex items-center justify-center shrink-0"
                                     :class="settings.active_profile_id === prof.id ? 'border-indigo-400 bg-indigo-400' : 'border-[var(--text-dim)]'">
                                    <i v-if="settings.active_profile_id === prof.id" class="fa-solid fa-check text-[10px] text-white"></i>
                                </div>

                                <!-- 信息 -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm font-bold text-[var(--text-main)] truncate">{{ prof.name }}</span>
                                        <span class="text-[9px] px-1.5 py-0.5 rounded bg-black/30 text-[var(--text-dim)] uppercase tracking-wider border border-[var(--border-dim)]">{{ prof.provider }}</span>
                                    </div>
                                    <div class="text-[10px] text-[var(--text-dim)] truncate font-mono mt-0.5 opacity-70">
                                        {{ prof.model }} · {{ prof.baseUrl || 'Default URL' }}
                                    </div>
                                </div>

                                <!-- 操作按钮 -->
                                <div class="flex gap-2" @click.stop>
                                    <button @click="testUserProfile(prof)" 
                                            class="w-7 h-7 flex items-center justify-center theme-rounded-sm bg-[var(--bg-panel)] border border-[var(--border-dim)] transition relative"
                                            :class="{
                                                'text-[var(--text-dim)] hover:text-[var(--text-main)]': prof.status === 'unknown',
                                                'text-emerald-500 border-emerald-500/30 bg-emerald-900/10': prof.status === 'success',
                                                'text-red-500 border-red-500/30 bg-red-900/10': prof.status === 'error'
                                            }"
                                            :disabled="prof.isTesting"
                                            title="Test Connection">
                                        <!-- 如果正在测试，显示转圈；否则显示钥匙 -->
                                        <i v-if="prof.isTesting" class="fa-solid fa-circle-notch fa-spin text-xs"></i>
                                        <i v-else class="fa-solid fa-key text-xs"></i>
                                        
                                        <!-- 成功时的一个小光点动画 -->
                                        <span v-if="prof.status === 'success'" class="absolute top-1 right-1 w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse"></span>
                                    </button>

                                    <!-- 原有的编辑按钮 -->
                                    <button @click="openProfileEditor(prof)" class="w-7 h-7 flex items-center justify-center theme-rounded-sm bg-[var(--bg-panel)] border border-[var(--border-dim)] text-[var(--text-dim)] hover:text-[var(--text-main)] transition" title="Edit">
                                        <i class="fa-solid fa-pen text-xs"></i>
                                    </button>
                                    <!-- 原有的删除按钮 -->
                                    <button @click="deleteProfile(idx)" class="w-7 h-7 flex items-center justify-center theme-rounded-sm bg-[var(--bg-panel)] border border-[var(--border-dim)] text-[var(--text-dim)] hover:text-red-500 transition" title="Delete">
                                        <i class="fa-solid fa-trash text-xs"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 空状态：新手引导卡片 -->
                            <div v-if="settings.api_profiles.length === 0" class="p-5 border-2 border-dashed border-indigo-500/30 bg-indigo-900/10 theme-rounded-sm text-center">
                                <div class="text-indigo-400 text-3xl mb-3"><i class="fa-solid fa-robot animate-bounce"></i></div>
                                <h4 class="text-sm font-bold text-white mb-2">AI 引擎未初始化</h4>
                                <p class="text-xs text-[var(--text-dim)] mb-4 leading-relaxed">
                                    您需要配置一个“大脑”才能开始推演。<br>
                                    请参考下方的 <strong>API Key 获取指南</strong>。
                                </p>
                                
                                <!-- 快捷操作指引 -->
                                <div class="text-xs text-[var(--text-dim)] bg-black/20 p-2 rounded inline-block text-left">
                                    <div>1. 点击下方 <span class="text-emerald-400 font-bold">Google Gemini</span> 链接获取 Key (免费)</div>
                                    <div class="mt-1">2. 复制 Key，点击右上角 <span class="text-white font-bold bg-indigo-600 px-1 rounded text-[10px]">新建配置</span></div>
                                    <div class="mt-1">3. 粘贴 Key 并保存，点击 <i class="fa-solid fa-key"></i> 测试</div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. 编辑器面板 (内嵌式) -->
                        <transition name="fade">
                            <div v-if="isEditingProfile" class="bg-[var(--bg-badge)] p-4 theme-rounded-sm border border-[var(--border-dim)] mb-6 relative">
                                <div class="text-xs font-bold text-[var(--text-main)] mb-3 pb-2 border-b border-[var(--border-dim)] flex justify-between">
                                    <span>{{ editingProfileData.id ? 'EDIT PROFILE' : 'NEW PROFILE' }}</span>
                                    <!-- 快速预设 -->
                                    <div class="flex gap-1 flex-wrap"> <!-- 增加 flex-wrap 防止溢出 -->
                                        <button v-for="pre in ['Gemini','Claude','DeepSeek','Qwen','OpenAI','SiliconFlow','Others']" 
                                                :key="pre" 
                                                @click="applyPresetToEditor(pre)" 
                                                class="px-2 py-0.5 bg-[var(--bg-panel)] border border-[var(--border-dim)] text-[9px] hover:text-[var(--text-main)] transition theme-rounded-sm">
                                            {{ pre }}
                                        </button>
                                    </div>
                                </div>

                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-[10px] font-bold text-[var(--text-dim)] mb-1 uppercase">{{ t('lbl_profile_name') }} <span class="text-red-500">*</span></label>
                                        <input v-model="editingProfileData.name" placeholder="e.g. My Pro Account" class="w-full input-tech theme-rounded-sm p-2 text-xs outline-none font-bold">
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-[10px] font-bold text-[var(--text-dim)] mb-1 uppercase">{{ t('set_provider') }}</label>
                                            <select v-model="editingProfileData.provider" class="w-full input-tech theme-rounded-sm p-2 text-xs outline-none">
                                                <option value="Gemini">Gemini (Google)</option>
                                                <option value="Claude">Claude (Anthropic)</option>
                                                <option value="OpenAI">OpenAI Compatible</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-[10px] font-bold text-[var(--text-dim)] mb-1 uppercase">{{ t('set_model') }}</label>
                                            <input v-model="editingProfileData.model" class="w-full input-tech theme-rounded-sm p-2 text-xs outline-none font-mono">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-[var(--text-dim)] mb-1 uppercase">{{ t('set_base_url') }}</label>
                                        <input v-model="editingProfileData.baseUrl" placeholder="https://api.openai.com/v1" class="w-full input-tech theme-rounded-sm p-2 text-xs outline-none font-mono">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-[var(--text-dim)] mb-1 uppercase">{{ t('set_key') }}</label>
                                        <input v-model="editingProfileData.key" type="password" class="w-full input-tech theme-rounded-sm p-2 text-xs outline-none">
                                    </div>
                                </div>

                                <div class="flex justify-end gap-2 mt-4 pt-3 border-t border-[var(--border-dim)]">
                                    <button @click="isEditingProfile = false" class="px-3 py-1.5 text-xs font-bold text-[var(--text-dim)] hover:text-[var(--text-main)]">{{ t('btn_cancel') }}</button>
                                    <button @click="saveProfile" class="px-4 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold theme-rounded-sm shadow-md transition">
                                        <i class="fa-solid fa-check mr-1"></i> {{ t('btn_save') }}
                                    </button>
                                </div>
                            </div>
                        <!-- 3. [新增] API 获取指南 -->
                        <div class="mt-4 pt-4 border-t border-[var(--border-dim)]">
                            <div class="flex justify-between items-center mb-3">
                                <div class="text-[10px] font-bold text-[var(--text-dim)] uppercase tracking-widest flex items-center">
                                    <i class="fa-solid fa-link mr-1.5"></i> {{ t('header_api_guide') }}
                                </div>
                                <!-- ★★★ [新增] 教程按钮 ★★★ -->
                                <button @click="showTutorialModal = true" class="px-2 py-1 theme-rounded-sm border border-emerald-500/30 bg-emerald-900/10 text-emerald-500 text-[10px] font-bold hover:bg-emerald-900/30 transition flex items-center gap-1">
                                    <i class="fa-solid fa-book-open"></i> {{ t('btn_open_tutorial') }}
                                </button>
                            </div>
                            <!-- ★★★ [新增] API Key 解释说明框 ★★★ -->
                            <div class="p-2.5 theme-rounded-sm border border-[var(--border-dim)] bg-[var(--bg-badge)] text-xs text-[var(--text-dim)] mb-3 flex gap-2 leading-relaxed">
                                <i class="fa-solid fa-info-circle text-lg text-indigo-400 shrink-0 mt-0.5"></i>
                                <span>{{ t('api_key_explanation') }}</span>
                            </div>
                            <div class="space-y-2">
                                <!-- A. Gemini (高光推荐) -->
                                <a href="https://aistudio.google.com/app/api-keys" target="_blank" class="block p-2.5 theme-rounded-sm border border-emerald-500/30 bg-emerald-900/10 hover:bg-emerald-900/20 transition group text-decoration-none">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm font-bold text-emerald-400 group-hover:text-emerald-300">
                                            <i class="fa-brands fa-google mr-1"></i> Google Gemini
                                        </span>
                                        <i class="fa-solid fa-arrow-up-right-from-square text-[10px] text-emerald-600 group-hover:text-emerald-400"></i>
                                    </div>
                                    <div class="text-xs text-[var(--text-dim)] opacity-80">{{ t('desc_gemini') }}</div>
                                </a>

                                <!-- B. 其他常用 (紧凑网格) -->
                                <div class="grid grid-cols-1 gap-2">
                                    <!-- DeepSeek -->
                                    <a href="https://platform.deepseek.com/api_keys" target="_blank" class="flex flex-col p-2 theme-rounded-sm border border-[var(--border-dim)] bg-[var(--bg-badge)] hover:border-indigo-500/50 hover:bg-[var(--bg-panel)] transition text-decoration-none group">
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs font-bold text-indigo-400"><i class="fa-solid fa-otter mr-1"></i> DeepSeek</span>
                                            <span class="text-[10px] text-[var(--text-dim)] group-hover:text-[var(--text-main)]">platform.deepseek.com</span>
                                        </div>
                                        <div class="text-[10px] text-[var(--text-dim)] mt-0.5">{{ t('desc_deepseek') }}</div>
                                    </a>

                                    <!-- SiliconFlow (硅基流动) -->
                                    <a href="https://cloud.siliconflow.cn/account/ak" target="_blank" class="flex flex-col p-2 theme-rounded-sm border border-[var(--border-dim)] bg-[var(--bg-badge)] hover:border-orange-500/50 hover:bg-[var(--bg-panel)] transition text-decoration-none group">
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs font-bold text-orange-400"><i class="fa-solid fa-microchip mr-1"></i> SiliconFlow</span>
                                            <span class="text-[10px] text-[var(--text-dim)] group-hover:text-[var(--text-main)]">cloud.siliconflow.cn</span>
                                        </div>
                                        <div class="text-[10px] text-[var(--text-dim)] mt-0.5">{{ t('desc_silicon') }}</div>
                                    </a>

                                    <!-- 底部：其他链接一行展示 -->
                                    <div class="flex gap-2 mt-1">
                                        <a href="https://platform.openai.com/api-keys" target="_blank" class="flex-1 text-center py-1.5 border border-[var(--border-dim)] bg-[var(--bg-badge)] hover:text-[var(--text-main)] text-[var(--text-dim)] text-[10px] font-bold theme-rounded-sm transition">
                                            <i class="fa-solid fa-robot mr-1"></i> OpenAI
                                        </a>
                                        <a href="https://console.anthropic.com/settings/keys" target="_blank" class="flex-1 text-center py-1.5 border border-[var(--border-dim)] bg-[var(--bg-badge)] hover:text-[var(--text-main)] text-[var(--text-dim)] text-[10px] font-bold theme-rounded-sm transition">
                                            <i class="fa-solid fa-brain mr-1"></i> Claude
                                        </a>
                                        <a href="https://bailian.console.aliyun.com/?apiKey=1" target="_blank" class="flex-1 text-center py-1.5 border border-[var(--border-dim)] bg-[var(--bg-badge)] hover:text-[var(--text-main)] text-[var(--text-dim)] text-[10px] font-bold theme-rounded-sm transition">
                                            <i class="fa-solid fa-cloud mr-1"></i> Qwen (Aliyun)
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </transition>
                    </section>
                    
                    <!-- 新增代理设置区块 -->
                    <section>
                        <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-4 pb-2 border-b border-[var(--border-dim)]">{{ t('set_proxy') }}</h3>
                        
                        <!-- 1. 开关与输入框 -->
                        <div class="flex items-center gap-4 bg-[var(--bg-badge)] p-3 theme-rounded-sm border border-[var(--border-dim)]">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" v-model="settings.proxy.enabled" id="useProxy" class="accent-indigo-500 w-4 h-4">
                                <label for="useProxy" class="text-sm font-bold cursor-pointer select-none">{{ t('set_enable_proxy') }}</label>
                            </div>
                            <div class="h-6 w-px bg-[var(--border-dim)] mx-2"></div>
                            <div class="flex-1 flex items-center gap-2" :class="{'opacity-50 pointer-events-none': !settings.proxy.enabled}">
                                <label class="text-xs font-mono text-[var(--text-dim)]">127.0.0.1:</label>
                                <input v-model="settings.proxy.port" placeholder="7890" class="w-20 input-tech theme-rounded-sm p-1.5 text-center text-sm font-mono outline-none focus:border-indigo-500 transition">
                            </div>
                        </div>

                        <!-- 2. [新增] 说明提示块 -->
                        <div class="mt-2 p-3 bg-indigo-900/10 border border-indigo-500/20 theme-rounded-sm text-xs text-[var(--text-dim)] space-y-2 leading-relaxed">
                            <!-- 第一条: Why -->
                            <div class="flex gap-2">
                                <i class="fa-solid fa-circle-question text-indigo-400 mt-0.5 text-sm shrink-0"></i>
                                <span>{{ t('proxy_help_why') }}</span>
                            </div>
                            <!-- 第二条: Port -->
                            <div class="flex gap-2">
                                <i class="fa-solid fa-network-wired text-indigo-400 mt-0.5 text-sm shrink-0"></i>
                                <span>{{ t('proxy_help_port') }}</span>
                            </div>
                            <!-- ★★★ [新增] 第三条: TUN 模式 ★★★ -->
                            <div class="flex gap-2 border-t border-indigo-500/10 pt-2 mt-1">
                                <i class="fa-solid fa-shield-halved text-emerald-500 mt-0.5 text-sm shrink-0"></i>
                                <span class="text-emerald-500/80">{{ t('proxy_help_tun') }}</span>
                            </div>
                        </div>
                    </section>

                    <section>
                         <h3 class="text-xs font-bold text-emerald-400 uppercase tracking-widest mb-2 pb-2 border-b border-[var(--border-dim)]">{{ t('set_prompt_config') }}</h3>
                         
                         <!-- 标签切换按钮 -->
                         <div class="flex gap-2 mb-2">
                             <button @click="settingsPromptTab = 'system'" 
                                     :class="settingsPromptTab === 'system' ? 'bg-emerald-600 text-white' : 'bg-[var(--bg-badge)] text-[var(--text-dim)] hover:text-[var(--text-main)]'"
                                     class="px-3 py-1 text-[10px] font-bold theme-rounded-sm transition">
                                 {{ t('tab_prompt_sys') }}
                             </button>
                             <button @click="settingsPromptTab = 'script'" 
                                     :class="settingsPromptTab === 'script' ? 'bg-indigo-600 text-white' : 'bg-[var(--bg-badge)] text-[var(--text-dim)] hover:text-[var(--text-main)]'"
                                     class="px-3 py-1 text-[10px] font-bold theme-rounded-sm transition">
                                 {{ t('tab_prompt_script') }}
                             </button>
                             <button @click="settingsPromptTab = 'god'" 
                                     :class="settingsPromptTab === 'god' ? 'bg-amber-600 text-white' : 'bg-[var(--bg-badge)] text-[var(--text-dim)] hover:text-[var(--text-main)]'"
                                     class="px-3 py-1 text-[10px] font-bold theme-rounded-sm transition">
                                 {{ t('tab_prompt_god') }}
                             </button>
                             <!-- [新增] Galgame 提示词切换按钮 (紫色) -->
                             <button @click="settingsPromptTab = 'galgame'" 
                                     :class="settingsPromptTab === 'galgame' ? 'bg-purple-600 text-white' : 'bg-[var(--bg-badge)] text-[var(--text-dim)] hover:text-[var(--text-main)]'"
                                     class="px-3 py-1 text-[10px] font-bold theme-rounded-sm transition">
                                 {{ t('tab_prompt_galgame') }}
                             </button>
                             <!-- [新增] Custom 按钮 -->
                             <button @click="settingsPromptTab = 'custom'" 
                                     :class="settingsPromptTab === 'custom' ? 'bg-pink-600 text-white' : 'bg-[var(--bg-badge)] text-[var(--text-dim)] hover:text-[var(--text-main)]'"
                                     class="px-3 py-1 text-[10px] font-bold theme-rounded-sm transition">
                                 {{ t('tab_prompt_custom') }}
                             </button>
                         </div>

                         <!-- 1. System Prompt 编辑框 -->
                         <div v-if="settingsPromptTab === 'system'">
                             <div class="text-[10px] text-[var(--text-dim)] mb-1">{{ t('desc_prompt_system') }}</div>
                             <textarea v-model="settings.prompts.system" class="w-full h-64 input-tech theme-rounded-sm p-3 text-xs font-mono resize-none outline-none text-[var(--text-dim)]"></textarea>
                         </div>

                         <!-- 2. Script Generator Prompt 编辑框 -->
                         <div v-if="settingsPromptTab === 'script'">
                             <div class="text-[10px] text-[var(--text-dim)] mb-1">{{ t('desc_prompt_script') }}</div>
                             <textarea v-model="settings.prompts.script_generator" class="w-full h-64 input-tech theme-rounded-sm p-3 text-xs font-mono resize-none outline-none text-[var(--text-dim)]"></textarea>
                         </div>

                         <!-- 3. God Mode Prompt 编辑框 -->
                         <div v-if="settingsPromptTab === 'god'">
                             <div class="text-[10px] text-[var(--text-dim)] mb-1">{{ t('desc_prompt_god') }}</div>
                             <textarea v-model="settings.prompts.god_mode" class="w-full h-64 input-tech theme-rounded-sm p-3 text-xs font-mono resize-none outline-none text-[var(--text-dim)]"></textarea>
                         </div>

                         <!-- [新增] 4. Galgame Prompt 编辑框 -->
                         <div v-if="settingsPromptTab === 'galgame'">
                             <div class="text-[10px] text-[var(--text-dim)] mb-1">{{ t('desc_prompt_galgame') }}</div>
                             <textarea v-model="settings.prompts.galgame" class="w-full h-64 input-tech theme-rounded-sm p-3 text-xs font-mono resize-none outline-none text-[var(--text-dim)]"></textarea>
                         </div>
                         <!-- [新增] 5. Custom Prompt 编辑框 -->
                         <div v-if="settingsPromptTab === 'custom'">
                             <div class="text-[10px] text-[var(--text-dim)] mb-1">{{ t('desc_prompt_custom') }}</div>
                             <textarea v-model="settings.prompts.custom" class="w-full h-64 input-tech theme-rounded-sm p-3 text-xs font-mono resize-none outline-none text-[var(--text-dim)]" placeholder="Enter your custom global instructions here..."></textarea>
                         </div>
                    </section>
                </div>
                <div class="p-6 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-end gap-4"><button @click="showSettings = false" class="px-5 py-2 theme-rounded-sm bg-[var(--bg-badge)] text-[var(--text-dim)] font-bold text-sm hover:text-[var(--text-main)]">{{ t('btn_cancel') }}</button><button @click="saveSettings" class="px-6 py-2 theme-rounded-sm bg-emerald-600 text-white font-bold text-sm shadow-lg hover:bg-emerald-500">{{ t('btn_save') }}</button></div>
            </div>
        </div>
    </transition>
    <!-- Modal: Tutorial -->
    <transition name="fade">
        <div v-if="showTutorialModal" class="modal-mask z-[10000]"> <!-- z-index 调高，覆盖在设置弹窗之上 -->
            <div class="glass-panel theme-rounded w-[800px] max-w-[95vw] h-[85vh] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <!-- 标题栏 -->
                <div class="p-5 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center shrink-0">
                    <h3 class="text-lg font-bold flex items-center gap-2">
                        <i class="fa-brands fa-google text-emerald-500"></i>
                        {{ t('modal_tutorial_title') }}
                    </h3>
                    <button @click="showTutorialModal = false" class="w-8 h-8 flex items-center justify-center hover:text-white transition">
                        <i class="fa-solid fa-times text-lg"></i>
                    </button>
                </div>
                
                <!-- 内容区 (Markdown 渲染) -->
                <div class="flex-1 overflow-y-auto p-8 bg-[var(--bg-panel)] text-sm leading-relaxed">
                    <!-- 使用 md-content 样式类复用之前的 Markdown 样式 -->
                    <div class="md-content" v-html="renderMarkdown(t('tutorial_content'))"></div>
                </div>
                
                <!-- 底部 -->
                <div class="p-4 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-end">
                    <button @click="showTutorialModal = false" class="px-6 py-2 bg-emerald-600 text-white theme-rounded-sm font-bold text-xs shadow-lg hover:bg-emerald-500 transition">
                        我明白了 (Got it)
                    </button>
                </div>
            </div>
        </div>
    </transition>
    <!-- Modals (Faction) -->
    <transition name="fade">
        <div v-if="showFactionModal" class="modal-mask">
            <div role="dialog" aria-label="Edit Entity" class="glass-panel theme-rounded w-[550px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-6 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center">
                    <h3 class="text-xl font-bold">{{ editingFaction.id ? t('modal_edit_entity') : t('modal_new_entity') }}</h3>
                    <button @click="closeFactionModal" class="text-[var(--text-dim)] hover:text-[var(--text-main)] w-10 h-10 flex items-center justify-center text-xl"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-8 overflow-y-auto max-h-[70vh] space-y-6 bg-[var(--bg-panel)]">
                    <div><label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('label_name') }}</label><input v-model="editingFaction.name" class="w-full input-tech p-3 theme-rounded-sm text-lg font-bold outline-none"></div>
                    
                    <!-- [优化] 父级实体选择 (支持层级缩进显示) -->
                    <div>
                        <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('lbl_parent_entity') }}</label>
                        <select v-model="editingFaction.parentId" class="w-full input-tech p-3 theme-rounded-sm text-sm font-mono outline-none">
                            <option value="">{{ t('opt_top_level') }}</option>
                            <!-- 使用 sortedPlayers 可以在下拉框中也保持顺序 -->
                            <option v-for="p in sortedPlayers" :key="p.id" :value="p.id" 
                                    v-show="p.id !== editingFaction.id"
                                    :disabled="p._depth >= 2"> <!-- 可选：限制层级深度防止过深 -->
                                <!--利用非换行空格实现视觉缩进-->
                                {{ '&nbsp;&nbsp;'.repeat(p._depth) + (p._depth > 0 ? '└─ ' : '') + p.name }} 
                            </option>
                        </select>
                        <p class="text-[10px] text-[var(--text-dim)] mt-1">
                            <i class="fa-solid fa-info-circle mr-1"></i>
                        </p>
                    </div>
                    <!-- [新增结束] -->

                    <div>
                        <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('label_icon_color') }}</label>
                        <div class="flex gap-4 items-start">
                            <!-- 左侧：预览与上传 -->
                            <div class="flex flex-col items-center gap-2">
                                <!-- 容器改为 20(宽) x 14(高) 约等于 3:2 旗帜比例 -->
                                <div class="w-20 h-14 theme-rounded-sm border border-[var(--border-dim)] bg-[var(--bg-badge)] flex items-center justify-center overflow-hidden relative group cursor-pointer" :style="{ borderColor: editingFaction.color }">
                                    <img v-if="isImage(editingFaction.logo)" :src="editingFaction.logo" class="w-full h-full object-contain">
                                    <i v-else :class="editingFaction.logo || 'fa-solid fa-users'" class="text-2xl" :style="{ color: editingFaction.color }"></i>
                                    
                                    <!-- 悬浮上传遮罩 -->
                                    <label class="absolute inset-0 bg-black/60 flex items-center justify-center opacity-0 group-hover:opacity-100 transition cursor-pointer text-white text-xs font-bold">
                                        UPLOAD
                                        <input type="file" @change="(e) => handleFactionImageUpload(e, 'logo')" class="hidden" accept="image/*">
                                    </label>
                                </div>
                            </div>

                            <!-- 右侧：手动输入与颜色 -->
                            <div class="flex-1 space-y-2">
                                <input v-model="editingFaction.logo" placeholder="fa-class OR data:image..." class="w-full input-tech p-2 theme-rounded-sm text-xs font-mono outline-none text-[var(--text-dim)] truncate">
                                
                                <div class="flex items-center gap-2 bg-[var(--bg-badge)] p-1 theme-rounded-sm border border-[var(--border-dim)]">
                                    <input type="color" v-model="editingFaction.color" class="h-8 w-8 bg-transparent border-none cursor-pointer">
                                    <input v-model="editingFaction.color" class="w-full bg-transparent text-xs font-mono uppercase outline-none text-[var(--text-dim)]">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div><label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('label_desc') }}</label><textarea v-model="editingFaction.desc" class="w-full h-24 input-tech p-3 theme-rounded-sm text-sm resize-none outline-none"></textarea></div>

                    <!-- [新增] 主角标记开关 -->
                    <div class="flex items-center gap-2 mt-4 p-2 bg-indigo-900/20 border border-indigo-500/30 theme-rounded-sm">
                        <input type="checkbox" v-model="editingFaction.isProtagonist" id="chkProtagonist" class="accent-indigo-500 w-4 h-4">
                        <label for="chkProtagonist" class="text-xs font-bold text-indigo-300 cursor-pointer select-none">
                            <i class="fa-solid fa-user-astronaut mr-1"></i> 设为玩家化身 (Protagonist / POV)
                        </label>
                    </div>
                    <!-- [终极版] 立绘设置区域 (16:9大屏预览 + 缩略图列表) -->
                    <div class="mt-4 pt-4 border-t border-[var(--border-dim)]">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-[var(--text-dim)] uppercase">立绘校准 (Calibration)</label>
                            <div v-if="previewAvatarIndex === -1" class="text-[10px] font-bold text-emerald-500 bg-emerald-900/20 px-2 py-0.5 rounded border border-emerald-500/30">CURRENT: DEFAULT</div>
                            <div v-else class="text-[10px] font-bold text-pink-500 bg-pink-900/20 px-2 py-0.5 rounded border border-pink-500/30">CURRENT: {{ editingFaction.avatars[previewAvatarIndex]?.tag || 'VARIANT' }}</div>
                        </div>

                        <!-- A. 大预览视窗 (强制 16:9) -->
                        <!-- w-full 让它填满弹窗宽度，aspect-video 强制 16:9 比例 -->
                        <div class="w-full aspect-video bg-black/80 border border-[var(--border-dim)] theme-rounded-sm relative overflow-hidden flex items-end justify-center group bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTEwIDBoMTB2MTBIMTB6TTAgMTBoMTB2MTBIMHoiIGZpbGw9IiMzMzMiIGZpbGwtb3BhY2l0eT0iMC4xIi8+PC9zdmc+')] shadow-inner mb-4">
                            
                            <!-- 辅助线: 中心线 -->
                            <div class="absolute left-1/2 top-0 h-full w-px bg-white/20 z-0 pointer-events-none"></div>
                            <!-- 辅助线: 底部文字安全区 (约28%) -->
                            <div class="absolute bottom-0 w-full h-[28%] bg-red-500/5 z-0 pointer-events-none border-t border-red-500/20 flex justify-center items-center">
                                <span class="text-[9px] text-red-500/30 font-mono tracking-widest">TEXT AREA SAFE ZONE</span>
                            </div>

                            <!-- 渲染逻辑: 默认立绘 -->
                            <template v-if="previewAvatarIndex === -1">
                                <img v-if="isImage(editingFaction.avatar)" 
                                     :src="editingFaction.avatar" 
                                     class="w-auto h-full max-w-none object-contain transition-transform duration-100 select-none pointer-events-none"
                                     :style="{ 
                                         transform: `scale(${editingFaction.avatarScale}) translateY(${editingFaction.avatarOffsetY}%)`,
                                         transformOrigin: 'bottom center'
                                     }">
                                <div v-else class="text-[var(--text-dim)] flex flex-col items-center gap-2 mb-8 opacity-50">
                                    <i class="fa-solid fa-image text-4xl"></i>
                                    <span class="text-xs">No Default Image</span>
                                </div>
                            </template>

                            <!-- 渲染逻辑: 差分立绘 -->
                            <template v-else-if="editingFaction.avatars[previewAvatarIndex]">
                                <img :src="editingFaction.avatars[previewAvatarIndex].url" 
                                     class="w-auto h-full max-w-none object-contain transition-transform duration-100 select-none pointer-events-none"
                                     :style="{ 
                                         transform: `scale(${editingFaction.avatars[previewAvatarIndex].scale}) translateY(${editingFaction.avatars[previewAvatarIndex].offsetY}%)`,
                                         transformOrigin: 'bottom center'
                                     }">
                            </template>
                        </div>

                        <!-- B. 控制面板 (Tag + Sliders) -->
                        <div class="bg-[var(--bg-badge)] p-3 theme-rounded-sm border border-[var(--border-dim)] mb-4">
                            
                            <!-- B1. 顶部操作栏 -->
                            <div class="flex justify-between items-center mb-3 pb-2 border-b border-[var(--border-dim)] border-dashed">
                                <!-- Tag 输入框 (仅差分模式) -->
                                <div v-if="previewAvatarIndex !== -1 && editingFaction.avatars[previewAvatarIndex]" class="flex items-center gap-2 flex-1">
                                    <span class="text-[9px] font-bold text-[var(--text-dim)] uppercase">TAG NAME:</span>
                                    <input v-model="editingFaction.avatars[previewAvatarIndex].tag" class="bg-[var(--bg-input)] px-2 py-1 theme-rounded-sm text-xs font-bold text-pink-400 outline-none focus:border-pink-500 border border-transparent transition w-32">
                                </div>
                                <div v-else class="text-xs font-bold text-emerald-500 flex-1"><i class="fa-solid fa-star mr-1"></i> Default State</div>

                                <!-- 操作按钮 -->
                                <div class="flex gap-3">
                                    <label class="cursor-pointer text-[10px] font-bold text-[var(--text-dim)] hover:text-[var(--text-main)] flex items-center gap-1 transition" title="Replace Image">
                                        <i class="fa-solid fa-arrow-right-arrow-left"></i> Replace
                                        <!-- ★★★ 修改点：直接绑定 handleAvatarReplace ★★★ -->
                                        <input type="file" @change="handleAvatarReplace" class="hidden" accept="image/*">
                                    </label>
                                    <button v-if="previewAvatarIndex !== -1" @click="() => { editingFaction.avatars.splice(previewAvatarIndex, 1); previewAvatarIndex = -1; }" class="text-[10px] font-bold text-[var(--text-dim)] hover:text-red-400 flex items-center gap-1 transition">
                                        <i class="fa-solid fa-trash"></i> Delete
                                    </button>
                                    <button v-if="previewAvatarIndex === -1 && editingFaction.avatar" @click="editingFaction.avatar = ''" class="text-[10px] font-bold text-[var(--text-dim)] hover:text-red-400 flex items-center gap-1 transition">
                                        <i class="fa-solid fa-eraser"></i> Clear
                                    </button>
                                </div>
                            </div>

                            <!-- B2. 滑块控制 (数据绑定) -->
                            <div v-if="previewAvatarIndex === -1">
                                <div class="flex gap-4">
                                    <div class="flex-1">
                                        <div class="flex justify-between text-[9px] text-[var(--text-dim)] mb-1 uppercase font-bold"><span>Zoom Scale</span><span class="text-emerald-500">{{ editingFaction.avatarScale?.toFixed(2) }}x</span></div>
                                        <input type="range" v-model.number="editingFaction.avatarScale" min="0.5" max="3.0" step="0.05" class="w-full h-1.5 bg-[var(--border-dim)] rounded-lg appearance-none cursor-pointer accent-emerald-500">
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex justify-between text-[9px] text-[var(--text-dim)] mb-1 uppercase font-bold"><span>Vertical Offset</span><span class="text-emerald-500">{{ editingFaction.avatarOffsetY?.toFixed(0) }}%</span></div>
                                        <input type="range" v-model.number="editingFaction.avatarOffsetY" min="-50" max="50" step="1" class="w-full h-1.5 bg-[var(--border-dim)] rounded-lg appearance-none cursor-pointer accent-emerald-500">
                                    </div>
                                </div>
                            </div>
                            <div v-else-if="editingFaction.avatars[previewAvatarIndex]">
                                <div class="flex gap-4">
                                    <div class="flex-1">
                                        <div class="flex justify-between text-[9px] text-[var(--text-dim)] mb-1 uppercase font-bold"><span>Zoom Scale</span><span class="text-pink-500">{{ editingFaction.avatars[previewAvatarIndex].scale?.toFixed(2) }}x</span></div>
                                        <input type="range" v-model.number="editingFaction.avatars[previewAvatarIndex].scale" min="0.5" max="3.0" step="0.05" class="w-full h-1.5 bg-[var(--border-dim)] rounded-lg appearance-none cursor-pointer accent-pink-500">
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex justify-between text-[9px] text-[var(--text-dim)] mb-1 uppercase font-bold"><span>Vertical Offset</span><span class="text-pink-500">{{ editingFaction.avatars[previewAvatarIndex].offsetY?.toFixed(0) }}%</span></div>
                                        <input type="range" v-model.number="editingFaction.avatars[previewAvatarIndex].offsetY" min="-50" max="50" step="1" class="w-full h-1.5 bg-[var(--border-dim)] rounded-lg appearance-none cursor-pointer accent-pink-500">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- C. 底部缩略图列表 (Selection Strip) -->
                        <div class="flex gap-2 overflow-x-auto pb-2 custom-scrollbar items-center py-2 select-none">
                            
                            <!-- C1. 默认立绘卡片 -->
                            <div @click="previewAvatarIndex = -1" 
                                 class="w-16 h-16 shrink-0 theme-rounded-sm border-2 overflow-hidden cursor-pointer relative group transition-all"
                                 :class="previewAvatarIndex === -1 ? 'border-emerald-500 ring-2 ring-emerald-500/30' : 'border-[var(--border-dim)] opacity-60 hover:opacity-100 hover:border-emerald-500/50'">
                                <img v-if="isImage(editingFaction.avatar)" :src="editingFaction.avatar" class="w-full h-full object-cover">
                                <div v-else class="w-full h-full bg-[var(--bg-deep)] flex items-center justify-center flex-col gap-1">
                                    <i class="fa-solid fa-user text-[var(--text-dim)]"></i>
                                    <span class="text-[8px] text-[var(--text-dim)]">NONE</span>
                                </div>
                                <div class="absolute top-0 right-0 bg-emerald-600 text-white text-[8px] px-1 font-bold rounded-bl-sm">DEF</div>
                            </div>

                            <!-- 分割线 -->
                            <div class="w-px h-10 bg-[var(--border-dim)] mx-1 shrink-0"></div>

                            <!-- C2. 差分列表卡片 -->
                            <div v-for="(av, idx) in editingFaction.avatars" :key="av.id" 
                                 @click="previewAvatarIndex = idx"
                                 class="w-16 h-16 shrink-0 theme-rounded-sm border-2 overflow-hidden cursor-pointer relative group transition-all"
                                 :class="previewAvatarIndex === idx ? 'border-pink-500 ring-2 ring-pink-500/30' : 'border-[var(--border-dim)] opacity-60 hover:opacity-100 hover:border-pink-500/50'">
                                <img :src="av.url" class="w-full h-full object-cover">
                                <div class="absolute bottom-0 w-full bg-black/70 text-[8px] text-white text-center font-bold truncate px-1 py-0.5 backdrop-blur-sm">{{ av.tag }}</div>
                            </div>

                            <!-- C3. 批量添加按钮 -->
                            <label class="w-16 h-16 shrink-0 theme-rounded-sm border-2 border-dashed border-[var(--border-dim)] flex flex-col items-center justify-center cursor-pointer hover:border-indigo-500 hover:text-indigo-400 text-[var(--text-dim)] transition bg-[var(--bg-badge)] hover:bg-[var(--bg-panel)] group">
                                <i class="fa-solid fa-plus text-xl mb-1 group-hover:scale-110 transition-transform"></i>
                                <span class="text-[8px] font-bold uppercase">Add New</span>
                                <input type="file" multiple @change="(e) => handleFactionImageUpload(e, 'add_variant')" class="hidden" accept="image/*">
                            </label>
                        </div>
                    </div>
                    <div class="pt-4 border-t border-[var(--border-dim)]">
                        <div class="flex justify-between items-center mb-4">
                             <label class="block text-xs font-bold text-amber-500 uppercase">{{ t('label_stats') }}</label>
                             <!-- [新增] 实体类型选择器 -->
                             <div class="flex items-center gap-2">
                                 <span class="text-[10px] text-[var(--text-dim)] uppercase">{{ t('lbl_entity_type') }}</span>
                                <select v-model="editingFaction.schemaId" @change="refreshFactionStats" class="bg-[var(--bg-badge)] border border-[var(--border-dim)] text-[10px] theme-rounded-sm p-1 text-[var(--text-main)] outline-none">
                                    <option v-for="rs in rule_sets" :key="rs.id" :value="rs.id">{{ rs.name }}</option>
                                </select>
                             </div>
                        </div>
                        
                        <!-- [修改] 遍历当前实体所选规则集的字段 -->
                        <div class="grid grid-cols-2 gap-4 p-4 bg-[var(--bg-badge)] theme-rounded-sm border border-[var(--border-dim)]">
                            <div v-for="field in getFieldsBySchemaId(editingFaction.schemaId)" :key="field.key">
                                <label class="block text-[10px] text-[var(--text-dim)] font-bold mb-1 flex justify-between">
                                    <span>{{ field.label }} <span class="opacity-30 font-mono">({{ field.key }})</span></span>
                                    <!-- 类型图标提示 -->
                                    <span class="text-[8px] uppercase px-1 rounded" :class="{'bg-blue-900 text-blue-300': field.type==='number', 'bg-gray-700 text-gray-400': field.type!=='number'}">{{ field.type||'STR' }}</span>
                                </label>
                                
                                <!-- 如果是数值型，使用 type="number" -->
                                <!-- 如果是只读型，背景变灰提示 -->
                                <input v-model="editingFaction.stats[field.key]" 
                                    :type="field.type === 'number' ? 'number' : 'text'"
                                    :placeholder="field.visibility === 'readonly' ? 'Auto-Calc (Override allowed)' : ''"
                                    class="w-full input-tech p-2 theme-rounded-sm text-emerald-400 font-mono-tech font-bold text-sm outline-none border-b-2 border-transparent focus:border-amber-500 transition"
                                    :class="{'opacity-70 bg-black/20': field.visibility === 'readonly'}">
                                    
                                <div v-if="field.visibility === 'readonly'" class="text-[8px] text-pink-500 mt-0.5 text-right font-mono">
                                    <i class="fa-solid fa-lock"></i> Calculated: {{ field.formula }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center">
                    <button v-if="editingFaction.id" @click="deleteFaction" class="text-red-500 font-bold text-sm hover:text-red-400"><i class="fa-solid fa-trash mr-2"></i>{{ t('btn_destroy') }}</button><div v-else></div>
                    <div class="flex gap-4"><button @click="closeFactionModal" class="px-5 py-2 theme-rounded-sm bg-[var(--bg-badge)] text-[var(--text-dim)] font-bold text-sm hover:text-[var(--text-main)]">{{ t('btn_cancel') }}</button><button @click="saveFaction" class="px-6 py-2 theme-rounded-sm bg-indigo-600 text-white font-bold text-sm shadow-lg hover:bg-indigo-500">{{ t('btn_confirm') }}</button></div>
                </div>
            </div>
        </div>
    </transition>

<!-- Modals (Save/Load) -->
    <transition name="fade">
        <div v-if="showSaveLoadModal" class="modal-mask">
            <div class="glass-panel theme-rounded w-[550px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <!-- 弹窗标题栏 -->
                <div class="p-6 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center">
                    <h3 class="text-xl font-bold"><i class="fa-solid fa-hard-drive mr-2 text-indigo-400"></i>{{ t('modal_files') }}</h3>
                    <button @click="showSaveLoadModal = false" class="text-[var(--text-dim)] hover:text-[var(--text-main)] w-10 h-10 flex items-center justify-center text-xl"><i class="fa-solid fa-times"></i></button>
                </div>
                
                <!-- 弹窗内容区 -->
                <div class="p-8 bg-[var(--bg-panel)]">
                    
                    <!-- 1. 另存为部分 -->
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-[var(--text-dim)] mb-3">{{ t('label_save_as') }}</label>
                        <div class="flex gap-3">
                            <input v-model="newSaveFilename" @keyup.enter="saveGame(newSaveFilename)" placeholder="Filename..." class="flex-1 input-tech p-3 theme-rounded-sm text-sm font-mono outline-none">
                            <button @click="saveGame(newSaveFilename)" :disabled="!newSaveFilename.trim()" class="px-6 py-2 bg-indigo-600 text-white theme-rounded-sm font-bold text-sm hover:bg-indigo-500 disabled:opacity-50">{{ t('btn_save') }}</button>
                        </div>
                    </div>
                    
                    <!-- 2. ★★★ [新增] 存档上传区域 ★★★ -->
                    <div class="mb-6 p-4 border-2 border-dashed border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-badge)] hover:border-emerald-500/50 transition group">
                        <label class="cursor-pointer flex flex-col items-center justify-center gap-2 w-full h-full">
                            <div class="flex items-center gap-3 text-[var(--text-dim)] group-hover:text-emerald-400 transition">
                                <i class="fa-solid fa-cloud-arrow-up text-xl"></i>
                                <span class="text-xs font-bold uppercase tracking-widest">上传本地存档 (.json)</span>
                            </div>
                            <input type="file" @change="handleSaveUpload" class="hidden" accept=".json">
                        </label>
                    </div>

                    <!-- 3. 本地档案列表部分 -->
                    <div class="border-t border-[var(--border-dim)] pt-6">
                        <label class="block text-sm font-bold text-[var(--text-dim)] mb-3">{{ t('label_local_files') }}</label>
                        <div class="max-h-[40vh] overflow-y-auto space-y-2 pr-2">
                            <div v-for="file in saveFiles" :key="file" class="flex justify-between items-center bg-[var(--bg-badge)] p-3 theme-rounded-sm border border-[var(--border-dim)] hover:border-[var(--text-dim)] group">
                                <span class="font-mono text-sm text-emerald-400 font-bold"><i class="fa-solid fa-file-code mr-3 opacity-50"></i>{{ file }}</span>
                                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                                    <button @click="loadGame(file)" class="px-3 py-1 bg-emerald-700 text-white theme-rounded-sm text-xs font-bold hover:bg-emerald-600">{{ t('btn_load') }}</button>
                                    <button @click="saveGame(file)" class="px-3 py-1 bg-amber-700 text-white theme-rounded-sm text-xs font-bold hover:bg-amber-600">{{ t('btn_overwrite') }}</button>
                                    <button @click="deleteSave(file)" class="px-3 py-1 bg-red-800 text-white theme-rounded-sm text-xs hover:bg-red-700"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                            <div v-if="saveFiles.length===0" class="text-center text-[var(--text-dim)] italic p-4">{{ t('msg_no_files') }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <!-- Modal: Formula Builder -->
    <transition name="fade">
        <div v-if="showFormulaModal" class="modal-mask">
            <div class="glass-panel theme-rounded w-[700px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-4 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center">
                    <h3 class="text-lg font-bold"><i class="fa-solid fa-calculator mr-2 text-pink-500"></i>公式构建器 (Formula Builder)</h3>
                    <button @click="closeFormulaModal" class="w-8 h-8 flex items-center justify-center hover:text-white"><i class="fa-solid fa-times"></i></button>
                </div>
                
                <div class="p-6 bg-[var(--bg-panel)] flex-1 overflow-y-auto">
                    
                    <!-- 1. 可视化预览区 -->
                    <div class="bg-[var(--bg-deep)] p-4 theme-rounded-sm border border-[var(--border-dim)] mb-4 min-h-[60px] flex flex-wrap items-center gap-2">
                        <span v-if="formulaTokens.length === 0" class="text-[var(--text-dim)] text-xs italic">点击下方按钮添加逻辑...</span>
                        
                        <div v-for="(token, idx) in formulaTokens" :key="idx" 
                             @click="removeToken(idx)"
                             class="px-2 py-1 rounded text-xs font-bold font-mono border cursor-pointer transition-all duration-200 hover:scale-105 hover:line-through hover:bg-red-900/50 hover:border-red-500 select-none shadow-sm"
                             :class="getTokenClass(token.type)"
                             :title="'Value: ' + token.value">
                            {{ token.label }}
                        </div>
                    </div>

                    <!-- 2. 操作面板 -->
                    <div class="bg-[var(--bg-badge)] theme-rounded-sm border border-[var(--border-dim)] overflow-hidden">
                        <!-- Tabs -->
                        <div class="flex border-b border-[var(--border-dim)] bg-[var(--bg-sidebar)]">
                            <button v-for="tab in formulaTabs" :key="tab" @click="activeFormulaTab = tab"
                                class="flex-1 py-2 text-xs font-bold transition"
                                :class="activeFormulaTab === tab ? 'bg-[var(--bg-panel)] text-pink-400 border-b-2 border-pink-500' : 'text-[var(--text-dim)] hover:text-[var(--text-main)]'">
                                {{ tab }}
                            </button>
                        </div>

                        <div class="p-4 h-64 overflow-y-auto">
                            <!-- Tab: 基础运算 -->
                            <div v-if="activeFormulaTab === '基础'" class="grid grid-cols-4 gap-2">
                                <button v-for="op in ['+', '-', '*', '/', '(', ')']" @click="addToken('op', op, op)" class="p-3 bg-[var(--bg-deep)] border border-[var(--border-dim)] theme-rounded-sm hover:border-pink-500 font-black text-lg">{{ op }}</button>
                                <div class="col-span-2 flex gap-1">
                                    <input v-model="tempNumber" type="number" placeholder="输入数字" class="w-full input-tech px-2 theme-rounded-sm outline-none text-center">
                                    <button @click="addToken('num', tempNumber, tempNumber)" class="px-3 bg-pink-600 text-white theme-rounded-sm font-bold">Add</button>
                                </div>
                            </div>
                            <!-- Tab: 逻辑运算 (新增) -->
                            <div v-if="activeFormulaTab === '逻辑'" class="space-y-4">
                                <div>
                                    <div class="text-[10px] text-[var(--text-dim)] mb-1">比较运算符：</div>
                                    <div class="grid grid-cols-4 gap-2">
                                        <button v-for="op in ['>', '<', '>=', '<=', '==', '!=']" @click="addToken('op', op, op)" class="p-2 bg-[var(--bg-deep)] border border-[var(--border-dim)] theme-rounded-sm font-mono font-bold text-amber-500 hover:border-amber-500">{{ op }}</button>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-[10px] text-[var(--text-dim)] mb-1">逻辑连接：</div>
                                    <div class="flex gap-2">
                                        <button @click="addToken('op', '并且 (&&)', '&&')" class="flex-1 p-2 bg-[var(--bg-deep)] border border-[var(--border-dim)] theme-rounded-sm text-xs font-bold text-indigo-400">AND (&&)</button>
                                        <button @click="addToken('op', '或者 (||)', '||')" class="flex-1 p-2 bg-[var(--bg-deep)] border border-[var(--border-dim)] theme-rounded-sm text-xs font-bold text-indigo-400">OR (||)</button>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-[10px] text-[var(--text-dim)] mb-1">三元表达式 (If-Else)：</div>
                                    <div class="flex gap-2">
                                        <button @click="addToken('op', '?', '?')" class="w-12 p-2 bg-purple-900/30 border border-purple-500/30 theme-rounded-sm text-purple-400 font-bold">?</button>
                                        <button @click="addToken('op', ':', ':')" class="w-12 p-2 bg-purple-900/30 border border-purple-500/30 theme-rounded-sm text-purple-400 font-bold">:</button>
                                        <div class="text-[10px] text-[var(--text-dim)] self-center ml-2">用法: 条件 ? 真值 : 假值</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab: 数学函数 (新增) -->
                            <div v-if="activeFormulaTab === '函数'" class="space-y-3">
                                <div class="grid grid-cols-2 gap-2">
                                    <button @click="addToken('func', '最大值(Max)', 'Math.max(')" class="p-2 bg-blue-900/20 border border-blue-500/30 text-blue-400 theme-rounded-sm text-xs font-bold">Math.max(</button>
                                    <button @click="addToken('func', '最小值(Min)', 'Math.min(')" class="p-2 bg-blue-900/20 border border-blue-500/30 text-blue-400 theme-rounded-sm text-xs font-bold">Math.min(</button>
                                    <button @click="addToken('func', '向下取整(Floor)', 'Math.floor(')" class="p-2 bg-blue-900/20 border border-blue-500/30 text-blue-400 theme-rounded-sm text-xs font-bold">Math.floor(</button>
                                    <button @click="addToken('func', '四舍五入(Round)', 'Math.round(')" class="p-2 bg-blue-900/20 border border-blue-500/30 text-blue-400 theme-rounded-sm text-xs font-bold">Math.round(</button>
                                    <button @click="addToken('func', '随机数(0-1)', 'Math.random()')" class="p-2 bg-blue-900/20 border border-blue-500/30 text-blue-400 theme-rounded-sm text-xs font-bold">Random()</button>
                                    <button @click="addToken('func', '绝对值(Abs)', 'Math.abs(')" class="p-2 bg-blue-900/20 border border-blue-500/30 text-blue-400 theme-rounded-sm text-xs font-bold">Math.abs(</button>
                                </div>
                                <div class="text-[10px] text-[var(--text-dim)] bg-black/20 p-2 rounded">
                                    <i class="fa-solid fa-circle-info mr-1"></i> 提示：函数以 '(' 结尾，请在添加数值后记得添加 ')' 闭合括号。
                                </div>
                            </div>

                            <!-- Tab: 自身属性 -->
                            <div v-if="activeFormulaTab === '自身'" class="space-y-2">
                                <div class="text-[10px] text-[var(--text-dim)] mb-2">引用当前实体的其他属性：</div>
                                <div class="flex flex-wrap gap-2">
                                    <button v-for="f in getAvailableFields()" :key="f.key" 
                                        @click="addToken('var', f.label, `self.stats['${f.key}']`)"
                                        class="px-3 py-1.5 bg-indigo-900/30 border border-indigo-500/30 text-indigo-300 hover:bg-indigo-600 hover:text-white theme-rounded-sm text-xs font-bold transition">
                                        {{ f.label }}
                                    </button>
                                </div>
                            </div>

                            <!-- Tab: 环境全局 -->
                            <div v-if="activeFormulaTab === '环境'" class="space-y-4">
                                <div>
                                    <div class="text-[10px] text-[var(--text-dim)] mb-1">系统变量：</div>
                                    <button @click="addToken('env', '当前回合', 'turn')" class="px-3 py-1.5 bg-amber-900/30 border border-amber-500/30 text-amber-400 theme-rounded-sm text-xs font-bold mr-2">当前回合数</button>
                                </div>
                                <div>
                                    <div class="text-[10px] text-[var(--text-dim)] mb-1">全局变量 (Global)：</div>
                                    <div class="flex flex-wrap gap-2">
                                        <button v-for="g in global_vars" :key="g.key" 
                                            @click="addToken('env', g.key, `ctx.globals['${g.key}']`)"
                                            class="px-3 py-1.5 bg-emerald-900/30 border border-emerald-500/30 text-emerald-400 hover:bg-emerald-600 hover:text-white theme-rounded-sm text-xs font-bold transition">
                                            {{ g.key }}
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab: 高级聚合 (解决正则问题) -->
                            <div v-if="activeFormulaTab === '高级'" class="space-y-4">
                                <!-- 1. 引用特定实体 -->
                                <div class="bg-[var(--bg-deep)] p-2 theme-rounded-sm border border-[var(--border-dim)]">
                                    <div class="text-[10px] text-[var(--text-dim)] uppercase mb-1">引用特定实体的属性</div>
                                    <div class="flex gap-2">
                                        <select v-model="formulaBuilder.targetEntityId" class="flex-1 input-tech p-1 text-xs">
                                            <option value="" disabled>选择实体...</option>
                                            <option v-for="p in players" :value="p.id">{{ p.name }}</option>
                                        </select>
                                        <select v-model="formulaBuilder.targetStatKey" class="flex-1 input-tech p-1 text-xs">
                                            <option value="" disabled>选择属性...</option>
                                            <option v-for="f in getAllUniqueFields()" :value="f.key">{{ f.label }}</option>
                                        </select>
                                        <button @click="addSpecificEntityToken" class="px-3 bg-blue-600 text-white theme-rounded-sm text-xs">添加</button>
                                    </div>
                                </div>

                                <!-- 2. 区域求和 (傻瓜化) -->
                                <div class="bg-[var(--bg-deep)] p-2 theme-rounded-sm border border-[var(--border-dim)]">
                                    <div class="text-[10px] text-[var(--text-dim)] uppercase mb-1">地块属性求和 (Sum Regions)</div>
                                    <div class="flex gap-2 items-center">
                                        <span class="text-xs">计算</span>
                                        <select v-model="formulaBuilder.aggOwner" class="input-tech p-1 text-xs w-24">
                                            <option value="self">我拥有的</option>
                                            <option value="all">世界所有的</option>
                                        </select>
                                        <span class="text-xs">地块的</span>
                                        <select v-model="formulaBuilder.aggStat" class="flex-1 input-tech p-1 text-xs">
                                            <option value="" disabled>属性...</option>
                                            <option v-for="f in getAllUniqueFields()" :value="f.key">{{ f.label }}</option>
                                        </select>
                                        <span class="text-xs">总和</span>
                                        <button @click="addAggToken" class="px-3 bg-purple-600 text-white theme-rounded-sm text-xs">添加</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 实时预览 & 校验 -->
                    <div class="mt-4 flex flex-col gap-1 bg-black/20 p-2 rounded theme-rounded-sm border"
                         :class="validateFormulaResult.valid ? 'border-emerald-500/30' : 'border-red-500/50'">
                        <div class="flex justify-between items-center text-xs font-mono">
                            <span class="text-[var(--text-dim)]">Code:</span>
                            <span class="truncate ml-2 max-w-[400px]" :class="validateFormulaResult.valid ? 'text-emerald-400' : 'text-red-400'">
                                {{ generateCodeFromTokens() }}
                            </span>
                        </div>
                        <div v-if="!validateFormulaResult.valid" class="text-[10px] text-red-500 font-bold text-right">
                            <i class="fa-solid fa-triangle-exclamation mr-1"></i> {{ validateFormulaResult.msg }}
                        </div>
                    </div>

                </div>
                
                <div class="p-4 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-end gap-2">
                    <button @click="formulaTokens = []" class="px-4 py-2 text-[var(--text-dim)] hover:text-red-400 text-xs font-bold">清空</button>
                    <button @click="saveFormula" 
                            :disabled="!validateFormulaResult.valid"
                            class="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white theme-rounded-sm text-xs font-bold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            保存公式
                    </button>
                </div>
            </div>
        </div>
    </transition>
    <!-- Modals (Script Gen) -->
<!-- Modals (Map Pin Editor) -->
    <transition name="fade">
        <div v-if="showPinModal" class="modal-mask">
            <div role="dialog" aria-label="Map Editor" class="glass-panel theme-rounded w-[450px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <!-- 1. 顶部标题栏 -->
                <div class="p-4 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center shrink-0">
                    <h3 class="text-lg font-bold flex items-center gap-2">
                        <i v-if="editingRegionIndex !== -2" class="fa-solid fa-map text-emerald-500"></i>
                        <i v-else class="fa-solid fa-map-pin text-amber-500"></i>
                        {{ editingRegionIndex !== -2 ? (editingRegionIndex === -1 ? t('map_new_terr') : t('map_edit_terr')) : (editingPinIndex === -1 ? t('map_add_pin') : t('map_edit_pin')) }}
                    </h3>
                    <button @click="showPinModal = false" class="text-[var(--text-dim)] hover:text-[var(--text-main)] transition w-10 h-10 flex items-center justify-center text-lg"><i class="fa-solid fa-times"></i></button>
                </div>
                
                <div class="p-6 bg-[var(--bg-panel)] overflow-y-auto max-h-[75vh] space-y-5">
                    
                    <!-- 分支 A: 地块 (Region) 编辑模式 -->
                    <div v-if="editingRegionIndex !== -2" class="space-y-4">
                        <div class="p-3 bg-[var(--bg-badge)] theme-rounded-sm border border-[var(--border-dim)] relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-2 opacity-10"><i class="fa-solid fa-earth-americas text-4xl"></i></div>
                            <div class="text-[10px] text-emerald-500 font-bold uppercase tracking-widest mb-3 relative z-10">
                                <i class="fa-solid fa-flag mr-1"></i> {{ t('map_geo_title') }}
                            </div>

                            <!-- A1. 地理名称 (Name) -->
                            <div class="mb-3 relative z-10">
                                <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-1">{{ t('label_geo_name') }}</label>
                                <input v-model="pinForm.customLabel" placeholder="e.g. Normandy / 铁血峡谷" 
                                       class="w-full input-tech p-2 theme-rounded-sm text-sm font-bold text-[var(--text-main)] outline-none border-l-4 border-[var(--border-dim)] focus:border-emerald-500 transition">
                                <p class="text-[9px] text-[var(--text-dim)] mt-1 opacity-70">{{ t('hint_geo_name') }}</p>
                            </div>

                            <!-- A2. 当前控制权 (Owner) -->
                            <div class="relative z-10">
                                <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-1">{{ t('label_controller') }}</label>
                                <div class="flex items-center gap-2">
                                    <select v-model="pinForm.selectedId" class="flex-1 input-tech p-2 theme-rounded-sm text-sm font-mono font-bold outline-none border-l-4 transition"
                                            :style="{ borderLeftColor: pinForm.selectedId ? getFactionColor(pinForm.selectedId) : 'var(--border-dim)' }">
                                        <option value="">{{ t('opt_neutral') }}</option>
                                        <option v-for="p in players" :key="p.id" :value="p.id">
                                            {{ p.name }}
                                        </option>
                                    </select>
                                    <div v-if="pinForm.selectedId" class="w-8 h-8 theme-rounded-sm shadow-inner flex items-center justify-center border border-[var(--border-dim)]" :style="{ backgroundColor: getFactionColor(pinForm.selectedId) }">
                                        <i :class="getFactionLogo(pinForm.selectedId)" class="text-white text-xs drop-shadow-md"></i>
                                    </div>
                                </div>
                                <p class="text-[9px] text-[var(--text-dim)] mt-1 opacity-70">{{ t('hint_controller') }}</p>
                            </div>

                            <!-- ★★★ [新增] 地块属性编辑 (复用 Rule Sets) ★★★ -->
                            <div class="p-3 bg-[var(--bg-badge)] theme-rounded-sm border border-[var(--border-dim)] relative z-10 mt-2">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-[10px] font-bold text-[var(--text-dim)] uppercase">REGION STATS</label>
                                    <!-- 选择规则集 -->
                                <select v-model="pinForm.schemaId" @change="refreshPinFormStats" class="bg-transparent text-[10px] text-emerald-500 font-bold outline-none border-b border-emerald-500/30">
                                    <option value="" disabled>Select Type</option>
                                    <option v-for="rs in rule_sets" :key="rs.id" :value="rs.id">{{ rs.name }}</option>
                                </select>
                            </div>

                                <!-- 动态渲染属性输入框 -->
                                <div v-if="pinForm.schemaId" class="grid grid-cols-2 gap-2">
                                    <div v-for="field in getFieldsBySchemaId(pinForm.schemaId)" :key="field.key">
                                        <label class="block text-[9px] text-[var(--text-dim)] mb-0.5">{{ field.label }}</label>
                                        <input v-model="pinForm.stats[field.key]" 
                                            class="w-full bg-[var(--bg-input)] text-xs text-[var(--text-main)] px-2 py-1 theme-rounded-sm border border-[var(--border-dim)] outline-none focus:border-emerald-500">
                                    </div>
                                </div>
                                <div v-else class="text-[9px] text-[var(--text-dim)] italic text-center py-2">
                                    Please assign a Rule Set (e.g. Territory) to edit stats.
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- 分支 B: 普通点 (Pin) 编辑模式 -->
                    <div v-else class="space-y-4">
                        <!-- 模式切换 Tabs -->
                        <div>
                            <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('label_marker_type') }}</label>
                            <div class="flex bg-[var(--bg-badge)] theme-rounded-sm p-1 border border-[var(--border-dim)]">
                                <button @click="pinForm.mode = 'entity'" :class="pinForm.mode === 'entity' ? 'bg-indigo-600 text-white shadow' : 'text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="flex-1 py-1.5 text-xs font-bold theme-rounded-sm transition">{{ t('btn_type_entity') }}</button>
                                <button @click="pinForm.mode = 'lore'" :class="pinForm.mode === 'lore' ? 'bg-emerald-600 text-white shadow' : 'text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="flex-1 py-1.5 text-xs font-bold theme-rounded-sm transition">{{ t('btn_type_lore') }}</button>
                                <button @click="pinForm.mode = 'custom'" :class="pinForm.mode === 'custom' ? 'bg-amber-600 text-white shadow' : 'text-[var(--text-dim)] hover:text-[var(--text-main)]'" class="flex-1 py-1.5 text-xs font-bold theme-rounded-sm transition">{{ t('btn_type_custom') }}</button>
                            </div>
                        </div>

                        <!-- 选项 B1: 实体选择 -->
                        <div v-if="pinForm.mode === 'entity'">
                            <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('label_select_entity') }}</label>
                            <select v-model="pinForm.selectedId" class="w-full input-tech p-2 theme-rounded-sm text-sm font-bold outline-none">
                                <option value="" disabled>{{ t('opt_choose_entity') }}</option>
                                <option v-for="p in players" :key="p.id" :value="p.id">{{ p.name }}</option>
                            </select>
                        </div>

                        <!-- 选项 B2: 资料选择 -->
                        <div v-if="pinForm.mode === 'lore'">
                            <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('label_select_lore') }}</label>
                            <select v-model="pinForm.selectedId" class="w-full input-tech p-2 theme-rounded-sm text-sm font-bold outline-none">
                                <option value="" disabled>{{ t('opt_choose_lore') }}</option>
                                <option v-for="(entry, idx) in lorebook" :key="idx" :value="entry.keys">{{ entry.keys }}</option>
                            </select>
                            <p class="text-[10px] text-[var(--text-dim)] mt-1">{{ t('hint_lore_link') }}</p>
                        </div>

                        <!-- 选项 B3: 自定义 -->
                        <div v-if="pinForm.mode === 'custom'">
                            <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('label_custom_label') }}</label>
                            <input v-model="pinForm.customLabel" placeholder="e.g. Ruined Tower" class="w-full input-tech p-2 theme-rounded-sm text-sm font-bold outline-none" @keyup.enter="saveMapPin">
                        </div>
                    </div>

                    <!-- 通用部分: 外观与坐标微调 -->
                    
                    <!-- 1. 图标与颜色 -->
                    <div class="pt-4 border-t border-[var(--border-dim)]">
                        <div class="flex justify-between items-center mb-2 cursor-pointer group" @click="pinForm.showAppearance = !pinForm.showAppearance">
                             <label class="text-xs font-bold text-[var(--text-dim)] uppercase group-hover:text-[var(--text-main)] transition">
                                {{ t('label_appearance') }} <i class="fa-solid fa-chevron-down text-[10px] ml-1 opacity-50"></i>
                             </label>
                        </div>
                        
                        <div v-show="editingRegionIndex === -2 || pinForm.showAppearance" class="grid grid-cols-2 gap-4 bg-[var(--bg-badge)] p-3 theme-rounded-sm border border-[var(--border-dim)]">
                            <div>
                                <label class="block text-[10px] font-bold text-[var(--text-dim)] mb-1">{{ t('label_icon_class') }}</label>
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 flex items-center justify-center bg-[var(--bg-panel)] theme-rounded-sm border border-[var(--border-dim)] shrink-0">
                                        <i :class="pinForm.icon || 'fa-solid fa-question'" :style="{color: pinForm.color}"></i>
                                    </div>
                                    <input v-model="pinForm.icon" placeholder="fa-..." class="w-full input-tech p-1.5 theme-rounded-sm text-[10px] font-mono outline-none">
                                </div>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-[var(--text-dim)] mb-1">{{ t('label_custom_color') }}</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" v-model="pinForm.color" class="h-8 w-8 bg-transparent border-none cursor-pointer shrink-0">
                                    <input v-model="pinForm.color" class="w-full input-tech p-1.5 theme-rounded-sm text-[10px] font-mono outline-none uppercase">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. 坐标微调 -->
                    <div class="pt-4 border-t border-[var(--border-dim)]">
                        <label class="block text-xs font-bold text-[var(--text-dim)] uppercase mb-2">
                            {{ editingRegionIndex !== -2 ? t('label_pos_region') : t('label_pos_pin') }}
                        </label>
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <label class="text-[9px] text-[var(--text-dim)] font-mono">POS X (%)</label>
                                <div class="flex items-center gap-1">
                                    <input v-if="editingRegionIndex !== -2" type="number" step="0.5" v-model="pinForm.centerX" class="w-full input-tech p-2 theme-rounded-sm text-xs font-mono outline-none text-center">
                                    <input v-else type="number" step="0.5" v-model="pinForm.x" class="w-full input-tech p-2 theme-rounded-sm text-xs font-mono outline-none text-center">
                                </div>
                            </div>
                            <div class="flex-1">
                                <label class="text-[9px] text-[var(--text-dim)] font-mono">POS Y (%)</label>
                                <div class="flex items-center gap-1">
                                    <input v-if="editingRegionIndex !== -2" type="number" step="0.5" v-model="pinForm.centerY" class="w-full input-tech p-2 theme-rounded-sm text-xs font-mono outline-none text-center">
                                    <input v-else type="number" step="0.5" v-model="pinForm.y" class="w-full input-tech p-2 theme-rounded-sm text-xs font-mono outline-none text-center">
                                </div>
                            </div>
                        </div>
                        <p class="text-[9px] text-emerald-500 mt-2 opacity-70">
                            <i class="fa-solid fa-circle-info mr-1"></i>
                            {{ editingRegionIndex !== -2 ? t('hint_pos_region') : t('hint_pos_pin') }}
                        </p>
                    </div>

                </div>

                <!-- 底部按钮 -->
                <div class="p-4 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between shrink-0">
                    <button v-if="editingPinIndex !== -1 || (editingRegionIndex !== -2 && editingRegionIndex !== -1)" 
                            @click="deleteMapPin" 
                            class="text-red-500 hover:text-red-400 text-xs font-bold px-3 py-2 border border-red-900/30 theme-rounded-sm bg-red-900/10 transition">
                        <i class="fa-solid fa-trash mr-1"></i> {{ t('btn_remove') }}
                    </button>
                    <div v-else></div> 

                    <div class="flex gap-2">
                        <button @click="showPinModal = false" class="px-4 py-2 theme-rounded-sm border border-[var(--border-dim)] text-xs font-bold hover:bg-[var(--bg-panel)] transition text-[var(--text-dim)] hover:text-[var(--text-main)]">{{ t('btn_cancel') }}</button>
                        <button @click="saveMapPin" class="px-6 py-2 theme-rounded-sm bg-emerald-600 text-white text-xs font-bold shadow-lg hover:bg-emerald-500 transition">{{ t('btn_confirm') }}</button>
                    </div>
                </div>
            </div>
        </div>
    </transition>
    <transition name="fade">
        <div v-if="showScriptGenModal" class="modal-mask">
            <div class="glass-panel theme-rounded w-[600px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-6 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center"><h3 class="text-xl font-bold">{{ t('modal_script_gen') }}</h3><button @click="showScriptGenModal = false" class="text-[var(--text-dim)] hover:text-[var(--text-main)] w-10 h-10 flex items-center justify-center text-xl"><i class="fa-solid fa-times"></i></button></div>
                <div class="p-8 bg-[var(--bg-panel)] gap-4 flex flex-col max-h-[70vh] overflow-y-auto">
                    <p class="text-sm text-[var(--text-dim)] bg-[var(--bg-badge)] p-4 theme-rounded-sm border border-[var(--border-dim)]">{{ t('msg_script_gen_hint') }}</p>
                    
                    <!-- 文件上传区域 -->
                    <div class="border-2 border-dashed border-[var(--border-dim)] theme-rounded-sm p-4 hover:border-indigo-500/50 transition bg-[var(--bg-badge)]">
                        <label class="cursor-pointer flex flex-col items-center justify-center gap-2">
                            <i class="fa-solid fa-cloud-arrow-up text-2xl text-[var(--text-dim)]"></i>
                            <span class="text-xs font-bold text-[var(--text-dim)] uppercase tracking-wide">{{ t('label_upload_ref') }}</span>
                            <input type="file" multiple @change="handleScriptFiles" class="hidden" accept=".txt,.md,.json,.png,.jpg,.jpeg">
                        </label>
                        <div v-if="scriptAttachments.length > 0" class="mt-3 grid grid-cols-2 gap-2">
                            <div v-for="(file, idx) in scriptAttachments" :key="idx" class="text-[10px] bg-[var(--bg-deep)] p-2 border border-[var(--border-dim)] truncate flex justify-between items-center text-[var(--text-main)]">
                                <span><i :class="file.type.includes('image') ? 'fa-regular fa-image' : 'fa-regular fa-file-lines'" class="mr-1"></i>{{ file.name }}</span>
                                <button @click="scriptAttachments.splice(idx,1)" class="text-red-400 hover:text-red-300"><i class="fa-solid fa-times"></i></button>
                            </div>
                        </div>
                    </div>
                    <!-- [新增] 自定义 Prompt 开关 (原有的) -->
                    <div class="flex items-center gap-2 px-1 mb-2">
                        <input type="checkbox" v-model="scriptGenUseCustom" id="chkScriptCustom" class="accent-pink-500 w-4 h-4">
                        <label for="chkScriptCustom" class="text-xs font-bold text-pink-400 cursor-pointer select-none">{{ t('lbl_use_custom') }}</label>
                    </div>

                    <!-- ★★★ [新增] 高级参数设置面板 ★★★ -->
                    <div class="mb-3 border border-[var(--border-dim)] theme-rounded-sm bg-[var(--bg-deep)] overflow-hidden">
                        <!-- 折叠头 -->
                        <div @click="showScriptGenAdvanced = !showScriptGenAdvanced" 
                             class="p-2 flex justify-between items-center cursor-pointer hover:bg-[var(--bg-header)] transition select-none bg-[var(--bg-badge)]">
                            <span class="text-xs font-bold text-indigo-400 uppercase tracking-wider flex items-center gap-2">
                                <i class="fa-solid fa-sliders"></i> {{ t('lbl_adv_settings') }}
                            </span>
                            <i class="fa-solid text-[var(--text-dim)] text-xs transition-transform duration-300" 
                               :class="showScriptGenAdvanced ? 'rotate-180' : 'rotate-0'"></i> <!-- 这里的图标类名根据实际情况调整，通常是 fa-chevron-down -->
                               <!-- 修正图标 -->
                               <i class="fa-solid fa-chevron-down text-[var(--text-dim)] text-xs transition-transform duration-300" :class="showScriptGenAdvanced ? 'rotate-180' : ''"></i>
                        </div>

                        <!-- 折叠内容 -->
                        <transition name="fade">
                            <div v-if="showScriptGenAdvanced" class="p-4 space-y-4 border-t border-[var(--border-dim)]">
                                <!-- 1. 数量控制 -->
                                <div class="flex gap-4">
                                    <div class="flex-1">
                                        <label class="block text-[10px] text-[var(--text-dim)] font-bold uppercase mb-1">{{ t('lbl_gen_rules_count') }}</label>
                                        <div class="flex items-center gap-2">
                                            <input type="range" v-model.number="scriptGenConfig.rulesCount" min="1" max="5" class="flex-1 h-1 bg-[var(--border-dim)] rounded-lg appearance-none cursor-pointer accent-indigo-500">
                                            <span class="text-sm font-mono font-bold text-indigo-400 w-6 text-center">{{ scriptGenConfig.rulesCount }}</span>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <label class="block text-[10px] text-[var(--text-dim)] font-bold uppercase mb-1">{{ t('lbl_gen_entities_count') }}</label>
                                        <div class="flex items-center gap-2">
                                            <input type="range" v-model.number="scriptGenConfig.entitiesCount" min="2" max="10" class="flex-1 h-1 bg-[var(--border-dim)] rounded-lg appearance-none cursor-pointer accent-indigo-500">
                                            <span class="text-sm font-mono font-bold text-indigo-400 w-6 text-center">{{ scriptGenConfig.entitiesCount }}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- 2. 风格控制 -->
                                <div>
                                    <label class="block text-[10px] text-[var(--text-dim)] font-bold uppercase mb-2">{{ t('lbl_gen_attr_style') }}</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label class="flex items-center gap-2 p-2 theme-rounded-sm border border-[var(--border-dim)] cursor-pointer" :class="scriptGenConfig.attrStyle==='mixed'?'bg-indigo-900/20 border-indigo-500/50':''">
                                            <input type="radio" v-model="scriptGenConfig.attrStyle" value="mixed" class="accent-indigo-500">
                                            <span class="text-xs font-bold">{{ t('opt_style_mixed') }}</span>
                                        </label>
                                        <label class="flex items-center gap-2 p-2 theme-rounded-sm border border-[var(--border-dim)] cursor-pointer" :class="scriptGenConfig.attrStyle==='number'?'bg-indigo-900/20 border-indigo-500/50':''">
                                            <input type="radio" v-model="scriptGenConfig.attrStyle" value="number" class="accent-indigo-500">
                                            <span class="text-xs font-bold">{{ t('opt_style_number') }}</span>
                                        </label>
                                        <label class="flex items-center gap-2 p-2 theme-rounded-sm border border-[var(--border-dim)] cursor-pointer" :class="scriptGenConfig.attrStyle==='letter'?'bg-indigo-900/20 border-indigo-500/50':''">
                                            <input type="radio" v-model="scriptGenConfig.attrStyle" value="letter" class="accent-indigo-500">
                                            <span class="text-xs font-bold">{{ t('opt_style_letter') }}</span>
                                        </label>
                                        <label class="flex items-center gap-2 p-2 theme-rounded-sm border border-[var(--border-dim)] cursor-pointer" :class="scriptGenConfig.attrStyle==='text'?'bg-indigo-900/20 border-indigo-500/50':''">
                                            <input type="radio" v-model="scriptGenConfig.attrStyle" value="text" class="accent-indigo-500">
                                            <span class="text-xs font-bold">{{ t('opt_style_text') }}</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </transition>
                    </div>
                    <textarea v-model="scriptGenPrompt" class="w-full h-32 input-tech p-4 theme-rounded-sm text-base resize-none outline-none" placeholder="t('placeholder_prompt')"></textarea>
                </div>
                <div class="p-6 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-end">
                    <button @click="generateScript" :disabled="isThinking || !scriptGenPrompt.trim()" class="w-full py-4 theme-rounded-sm bg-gradient-to-r from-indigo-600 to-indigo-700 text-white font-bold text-lg tracking-widest shadow-lg hover:from-indigo-500 hover:to-indigo-600 flex justify-center items-center gap-3 disabled:opacity-50"><i :class="isThinking ? 'fa-solid fa-circle-notch fa-spin' : 'fa-solid fa-meteor'"></i> {{ isThinking ? t('status_generating') : t('btn_start_gen') }}</button>
                </div>
            </div>
        </div>
    </transition>
    <!-- ★★★ [新增] 命运投掷全屏仪式层 ★★★ -->
    <transition name="fade">
        <div v-if="showDiceModal" class="fixed inset-0 z-[9999] dice-overlay-backdrop flex flex-col items-center justify-center cursor-pointer select-none" @click="closeDiceModal">
            
            <!-- 顶部提示语 -->
            <div class="absolute top-20 text-center">
                <div class="text-2xl lg:text-4xl font-black text-white tracking-[0.3em] uppercase mb-2 drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">
                    {{ isRollingAnimation ? 'FATE IS ROLLING...' : 'JUDGEMENT DAY' }}
                </div>
                <div class="h-1 w-24 bg-indigo-500 mx-auto rounded-full"></div>
            </div>

            <!-- 骰子展示区 -->
            <div class="flex flex-wrap justify-center items-center gap-8 lg:gap-16 p-10 max-w-6xl">
                <div v-for="(die, idx) in activeDiceList" :key="idx" 
                     class="ceremony-die-container flex flex-col items-center gap-4 transition-all duration-500"
                     :class="[
                        die.isSettled ? (isCritSuccess(die) ? 'crit-success-glow' : (isCritFail(die) ? 'crit-fail-glow' : '')) : '',
                        die.isSettled ? 'opacity-100 scale-100' : 'opacity-80 scale-90'
                     ]"
                     style="width: 140px;">
                    
                    <!-- 骰子图标本体 -->
                    <div class="relative w-32 h-32 flex items-center justify-center">
                        <!-- 动态图标 -->
                        <i :class="[
                                getDieIcon(die.type), 
                                isRollingAnimation ? 'anim-shake-violent' : 'anim-impact'
                           ]" 
                           class="text-8xl transition-colors duration-300">
                        </i>
                        
                        <!-- 结果数值 (悬浮在图标上) -->
                        <div v-if="!isRollingAnimation" class="absolute inset-0 flex items-center justify-center">
                            <span class="text-4xl font-black drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)] font-mono"
                                  :class="isCritSuccess(die) ? 'text-amber-100' : 'text-white'">
                                {{ die.val }}
                            </span>
                        </div>
                    </div>

                    <!-- 底部标签 -->
                    <div class="text-center">
                        <div class="text-xs lg:text-sm font-bold uppercase tracking-widest mb-1" 
                             :class="isRollingAnimation ? 'text-gray-500' : (isCritSuccess(die) ? 'text-amber-400' : 'text-gray-300')">
                            {{ die.label || die.type.toUpperCase() }}
                        </div>
                        
                        <!-- 结果评价文字 -->
                        <div v-if="!isRollingAnimation" class="h-6">
                            <span v-if="isCritSuccess(die)" class="text-xs font-bold text-amber-400 px-2 py-0.5 border border-amber-500 rounded bg-amber-900/30">CRITICAL SUCCESS</span>
                            <span v-else-if="isCritFail(die)" class="text-xs font-bold text-red-500 px-2 py-0.5 border border-red-500 rounded bg-red-900/30">FAILURE</span>
                            <span v-else class="text-xs text-gray-500 font-mono">PASSED</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 底部操作提示 -->
            <div v-if="!isRollingAnimation" class="absolute bottom-20 text-white/30 text-sm font-mono animate-pulse uppercase tracking-widest">
                [ Click anywhere to accept fate ]
            </div>
        </div>
    </transition>
    <audio ref="splashBgm" preload="auto" class="hidden"></audio>
    <!-- Modal: Help Center -->
    <transition name="fade">
        <div v-if="showHelpModal" class="modal-mask z-[9999]">
            <div class="glass-panel theme-rounded w-[900px] max-w-[95vw] h-[85vh] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <!-- 标题 -->
                <div class="p-5 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center shrink-0">
                    <h3 class="text-xl font-bold flex items-center gap-3">
                        <i class="fa-solid fa-life-ring text-emerald-500"></i>
                        {{ t('modal_help_title') }}
                    </h3>
                    <button @click="showHelpModal = false" class="w-10 h-10 flex items-center justify-center hover:text-white text-xl"><i class="fa-solid fa-times"></i></button>
                </div>
                
                <!-- 内容 -->
                <div class="flex-1 overflow-y-auto p-10 bg-[var(--bg-panel)]">
                    <!-- 使用 md-content 样式渲染 Markdown -->
                    <div class="md-content text-base leading-loose" v-html="renderMarkdown(t('help_content'))"></div>
                </div>
                
                <!-- 底部 -->
                <div class="p-5 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-end">
                    <button @click="showHelpModal = false" class="px-8 py-3 bg-indigo-600 text-white theme-rounded-sm font-bold shadow-lg hover:bg-indigo-500 transition">
                        开始创造世界 (Start)
                    </button>
                </div>
            </div>
        </div>
    </transition>
    <!-- Modal: Text Polisher -->
    <transition name="fade">
        <div v-if="showPolishModal" class="modal-mask z-[10000]">
            <div class="glass-panel theme-rounded w-[600px] flex flex-col overflow-hidden text-[var(--text-main)]" @click.stop>
                <div class="p-5 border-b border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-between items-center">
                    <h3 class="text-lg font-bold flex items-center gap-2">
                        <i class="fa-solid fa-feather-pointed text-indigo-400"></i>
                        {{ t('modal_polish_title') }}
                    </h3>
                    <button @click="showPolishModal = false" class="w-8 h-8 flex items-center justify-center hover:text-white"><i class="fa-solid fa-times"></i></button>
                </div>
                
                <div class="p-6 bg-[var(--bg-panel)] flex-1 overflow-y-auto space-y-4">
                    <!-- 1. 参数设置区 -->
                    <div class="grid grid-cols-2 gap-4">
                        <!-- 风格选择 -->
                        <div>
                            <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('lbl_polish_style') }}</label>
                            <select v-model="polishConfig.style" class="w-full input-tech theme-rounded-sm p-2 text-xs outline-none font-bold">
                                <option value="jiangnan">{{ t('style_jiangnan') }}</option>
                                <option value="liu">{{ t('style_liu') }}</option>
                                <option value="jin">{{ t('style_jin') }}</option>
                                <option value="gu">{{ t('style_gu') }}</option>
                                <option value="lovecraft">{{ t('style_lovecraft') }}</option>
                                <option value="scp">{{ t('style_scp') }}</option>
                                <option value="history">{{ t('style_history') }}</option>
                            </select>
                            
                            <!-- [新增] 风格说明预览 (即时反馈) -->
                            <div class="mt-2 p-2 bg-[var(--bg-deep)] border border-[var(--border-dim)] theme-rounded-sm text-[10px] text-[var(--text-dim)] italic">
                                <i class="fa-solid fa-quote-left mr-1"></i> {{ getStyleDescription(polishConfig.style) }}
                            </div>
                        </div>
                        <!-- 字数控制 -->
                        <div>
                            <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('lbl_polish_length') }}</label>
                            <div class="flex items-center gap-2">
                                <input type="range" v-model.number="polishConfig.length" min="50" max="500" step="10" class="flex-1 h-1 bg-[var(--border-dim)] rounded-lg appearance-none cursor-pointer accent-indigo-500">
                                <span class="text-xs font-mono font-bold text-indigo-400 w-8 text-right">{{ polishConfig.length }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- 额外指令 -->
                    <div>
                        <label class="block text-[10px] font-bold text-[var(--text-dim)] uppercase mb-2">{{ t('lbl_polish_custom') }}</label>
                        <input v-model="polishConfig.customInstruction" placeholder="e.g. 增加更多环境描写 / 侧重心理活动..." class="w-full input-tech theme-rounded-sm p-2 text-xs outline-none">
                    </div>

                    <!-- 生成按钮 -->
                    <button @click="executePolish" :disabled="isPolishing" class="w-full py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white theme-rounded-sm font-bold text-xs shadow-md hover:from-indigo-500 hover:to-purple-500 transition flex justify-center items-center gap-2">
                        <i :class="isPolishing ? 'fa-solid fa-circle-notch fa-spin' : 'fa-solid fa-wand-sparkles'"></i>
                        {{ isPolishing ? 'AI Writing...' : t('btn_start_polish') }}
                    </button>

                    <!-- 2. 预览与对比区 -->
                    <div class="grid grid-cols-1 gap-2 mt-2 h-64">
                        <div class="flex flex-col h-full">
                            <label class="text-[10px] font-bold text-[var(--text-dim)] mb-1">DRAFT / RESULT</label>
                            <!-- 直接绑定到临时变量，用户可以手动微调 -->
                            <textarea v-model="polishConfig.draftContent" class="flex-1 input-tech theme-rounded-sm p-3 text-sm leading-relaxed resize-none outline-none font-serif"></textarea>
                        </div>
                    </div>
                </div>

                <div class="p-4 border-t border-[var(--border-dim)] bg-[var(--bg-header)] flex justify-end gap-2">
                    <button @click="showPolishModal = false" class="px-4 py-2 theme-rounded-sm text-[var(--text-dim)] hover:text-[var(--text-main)] text-xs font-bold">{{ t('btn_cancel') }}</button>
                    <button @click="applyPolishResult" class="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white theme-rounded-sm font-bold text-xs shadow-lg transition">
                        {{ t('btn_apply_polish') }}
                    </button>
                </div>
            </div>
        </div>
    </transition>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                APP_VERSION: '1.20', 
                showTutorialModal: false, // [新增]
                showHelpModal: false, // [新增]
                // ★★★ [新增] 撤销重做栈 ★★★
                undoStack: [],
                redoStack: [],
                // ★★★ [新增] 骰子仪式状态 ★★★
                showDiceModal: false,
                isRollingAnimation: false, // 是否处于“摇晃中”
                activeDiceList: [], // 用于弹窗显示的临时骰子数据
                useGalgamePrompt: false,
                // ★★★ [新增/修改] 动态 BGM 变量 ★★★
                currentBgmUrl: '',    // 实际播放地址
                currentBgmName: 'Loading Audio...', // 右下角显示的歌名
                isBgmPlaying: false,  // [新增] 主界面 BGM 播放状态
                showSplash: true, // [新增] 控制启动页显示
                hasInteracted: false, // 默认为 false，表示还在等待用户按键
                vnIsTyping: false,      // [新增] 是否正在打字
                vnFullText: "",         // [新增] 当前句子的完整文本
                vnTypeTimer: null,      // [新增] 打字机定时器
                vnUserInput: "", // [新增] VN模式下的用户输入

                // ★★★ [新增] VN 导演/上下文配置 ★★★
                vnShowSettings: false, // 是否显示导演面板
                vnActiveEntityIds: [], 
                vnPlayerRoleId: '', // [新增] 当前玩家扮演的角色ID (默认为主角，可切换)
                vnContextConfig: {
                    includeCustom: true,   
                    includeStats: true,    
                    includeTags: true,     
                    includeMap: false,
                    // [修改] 独立的历史记忆设置，替代单一的 historyDepth
                    includeHistory: true,
                    historyDeepDepth: 1,   // VN模式专用的深层记忆
                    historyShallowDepth: 5 // VN模式专用的浅层记忆
                },
                
                showFormulaModal: false,
                activeFormulaTab: '基础',
                validateFormulaResult: { valid: true, msg: '' },
                // 新增 '逻辑' 和 '函数'
                formulaTabs: ['基础', '逻辑', '函数', '自身', '环境', '高级'],
                currentEditingField: null, // 当前正在编辑哪个字段对象
                formulaTokens: [], // 存储公式片段: { type: 'var'|'op'|'num'|'func', label: '我的力量', value: "self.stats['str']" }
                tempNumber: 1,
                formulaBuilder: {
                    targetEntityId: '',
                    targetStatKey: '',
                    aggOwner: 'self',
                    aggStat: ''
                },
                
                // [新增] 文本润色/再生成状态
                showPolishModal: false,
                polishingEvent: null, // 当前正在润色的事件引用
                polishConfig: {
                    style: 'epic', // 默认风格
                    length: 100,   // 期望字数
                    customInstruction: '' // 额外指令
                },
                isPolishing: false, // AI 处理中状态

                // ★★★ [新增] VN 模式状态 ★★★
                vnMode: false,          // 是否进入剧场模式
                vnCurrentEvent: null,   // 当前正在播放的事件对象
                vnScript: [],           // 解析后的剧本数组
                vnLineIndex: 0,         // 当前播放到第几行
                vnDisplayedText: "",    // 打字机效果当前显示的文字
                vnTypingTimer: null,    // 打字机计时器
                vnShowOptions: false,   // 是否显示选项层
                dataVersion: 0, // [新增] 全局数据版本号，用于强制刷新地图
                serverConnected: false, isThinking: false, currentSaveFile: 'savegame.json',
                showSettings: false, showFactionModal: false, showSaveLoadModal: false, showScriptGenModal: false, showContextModal: false,
                saveFiles: [], newSaveFilename: '', 
                mapToolMode: 'view',
                // [新增] 安科模式开关
                generateOptions: false,
                previewAvatarIndex: -1, 
                // --- 输入相关 ---
                scriptGenPrompt: '',
                rawInput: '',
                godModeInput: '', // [新增] 上帝模式输入
                scriptAttachments: [], // [新增] 剧本生成附件列表

                // [新增] 剧本生成高级配置
                showScriptGenAdvanced: false,
                scriptGenConfig: {
                    rulesCount: 2,      // 默认生成2套规则
                    entitiesCount: 4,   // 默认生成4个实体
                    attrStyle: 'mixed'  // mixed | number | letter | text
                },
                
                editingFaction: { id: '', name: '', logo: '', stats: {} },
                editingTurnId: null, editingEventId: null,
                tabs: { left: 'players', right: 'input' },
                mobileActiveView: 'main', 
                isLargeScreen: window.innerWidth >= 1024, 
                isKeyboardOpen: false, // [新增] 键盘状态标志
                // [新增] 战斗表单数据
                combatForm: {
                    attackerId: '',
                    defenderId: '',
                    context: '',
                    locationId: '', // [新增] 战斗地点 ID
                    // [新增] 骰子池：默认先给一个 D20
                    dicePool: [
                        { type: 'd20', val: null, label: '' } 
                    ] 
                },
                isRollingDice: false,
                // [新增] 截图模式状态
                isScreenshotMode: false,
                screenshotRect: { x: 0, y: 0, w: 0, h: 0 },
                screenshotTarget: null, // 当前吸附的 DOM 元素
                screenshotTargetName: '', // 显示组件名称
                // [新增] 地图打点模态框状态
                showPinModal: false,
                editingPinIndex: -1, // -1 表示新建，>=0 表示编辑索引
                
                // ★★★ 彩蛋状态 ★★★
                logoClickCount: 0,
                showEasterEgg: false,

                pinForm: {
                    x: 0, y: 0,
                    mode: 'entity', // entity | lore | custom
                    selectedId: '',
                    customLabel: '',
                    icon: '', color: '',
                    schemaId: '',   // ★ 必须显式声明
                    stats: {}       // ★ 必须显式声明
                },
                
                // --- UI Settings ---
                ui: { theme: 'terminal', lang: 'zh' },
                
                // [新增] 用于设置面板切换 Prompt 标签页
                settingsPromptTab: 'system', 
                isLayerManagerOpen: true, 
                // [新增] 剧本生成时的自定义Prompt开关
                scriptGenUseCustom: true, 

                settings: {
                    api: { provider: 'Gemini', baseUrl: '', model: 'gemini-3-flash-preview', key: '' },
                    
                    // [新增] API 配置列表 (存储多套 Key)
                    api_profiles: [], 
                    
                    // [新增] 当前选中的 Profile ID (用于 UI 高亮)
                    active_profile_id: null,

                    proxy: { enabled: true, port: '7890' }, 
                    prompts: {
                        // [新增] 自定义 Prompt 初始化
                        custom: "", 
                        galgame: `你是一个 Galgame/Visual Novel 的剧本生成引擎。
                        【任务】
                        基于当前的“世界上下文”和“用户指令”，推演下一段剧情。
                        请直接返回 JSON 格式的 TimelineEvent。

                        【关键要求：Content 字段结构】
                        "content" 字段**必须**是一个 JSON 字符串（即 Stringified JSON Array），以便前端解析。
                        该数组描述了对话流。格式如下：
                        [
                        { "role": "faction_id_A", "tag": "angry", "text": "你竟敢背叛我！" },
                        { "role": "faction_id_B", "tag": "smile", "text": "这叫战略调整，我的朋友。" },
                        { "role": "narrator", "text": "随着一声枪响，谈判破裂了。" }
                        ]
                        - role: 对应 players 中的 id。如果是旁白，请用 "narrator"。
                        - tag: (可选) 对应立绘的表情变体 (如 "smile", "angry", "sad")。
                        - text: 对话内容或旁白描述。

                        【类型与逻辑注意事项】
                        1. **上下文理解**：上下文中标记为 <Type:Number> 的属性是数值，标记为 <ReadOnly> 的属性不可直接修改。
                        2. **数值变更**：如果你在 'impacts' 中修改好感度或金钱，请确保 newValue 输出为**纯数字**（如 100），严禁加引号。

                        【完整 JSON 示例】
                        {
                        "factionId": "global",
                        "timeStart": "1098年",
                        "timeEnd": "1099年",
                        "summary": "决裂时刻",
                        "content": "[{\\"role\\":\\"p_001\\",\\"tag\\":\\"angry\\",\\"text\\":\\"住手！\\"},{\\"role\\":\\"narrator\\",\\"text\\":\\"一阵爆炸声传来。\\"}]",
                        "impacts": [
                            // 示例：数值型属性变更
                            { "type": "STAT_CHANGE", "targetId": "p_001", "attrKey": "mood", "newValue": 0 }
                        ],
                        "options": [
                            { "label": "反击", "desc": "立即开火" },
                            { "label": "逃跑", "desc": "保存实力" }
                        ]
                        }`,
                        // --- 1. 日常推演 (Daily Deduction) - v3 多层级/多规则版 ---
                        system: `你是一个辅助世界推演的 AI 引擎。
                        【任务】
                        根据“世界上下文”和“用户指令”，推演下一阶段事件并以 JSON 格式输出。

                        【关键：数据类型与权限】
                        输入的上下文格式为：Key: Value <Metadata>
                        1. **类型严格 (Type Strictness)**：
                        - 如果属性标记为 <Type:Number>，你在输出 JSON 时**必须**输出为数字类型（例如 100，而不是 "100"）。
                        - 如果属性标记为 <Type:String>，输出为字符串。
                        2. **只读保护 (ReadOnly)**：
                        - 标记为 <ReadOnly> 或 <Auto-Calc> 的属性是世界法则自动计算的（自变量）。
                        - 你**严禁**在 'impacts' 中直接修改这些只读属性。你只能通过修改其他非只读属性来间接影响它们。
                        3. **数据清洗**：
                        - 输出的 JSON 中，Value **绝对不能**包含 <...> 这样的元数据标记。只输出纯净的值。

                        【核心原则】
                        1. **层级联动**：子实体(Child)的变动会波及父实体(Parent)。
                        2. **JSON 完整性**：确保 JSON 格式极其严谨，括号成对闭合。
                        3. **数据一致性**：oldValue 必须等于当前值。

                        【特殊 Impact 事件类型】
                        A. REGION_TRANSFER: { "targetName": "地块名", "newValue": "新领主ID" }
                        B. ENTITY_CREATE:   { "data": { "name": "...", "parentId": "...", "schemaId": "..." } }
                        C. ENTITY_REMOVE:   { "targetId": "..." }
                        D. PIN_MOVE:        { "targetId": "...", "newValue": "x,y" }
                        E. GLOBAL MOD:      { "type": "STAT_CHANGE", "targetId": "global", ... }

                        【分支选项 (OPTIONS) - 仅在被要求时生成】
                        - **结构必须为对象数组**：[ { "label": "...", "desc": "..." }, ... ]
                        - **字段定义**：
                        * "label": 4-8字短标题 (如"正面强攻")。
                        * "desc": 详细后果预估。
                        - **严禁**使用纯字符串数组！

                        【标准 JSON 响应模板】
                        {
                        "factionId": "行动方ID (如 p_empire)",
                        "timeStart": "时间段开始",
                        "timeEnd": "时间段结束",
                        "summary": "简短标题",
                        "content": "详细剧情描述...",
                        
                        // [可选] 仅在用户明确要求生成选项(Anko模式)时才包含此字段
                        "options": [
                            { "label": "外交斡旋", "desc": "尝试通过谈判解决争端，消耗资金但避免伤亡。" },
                            { "label": "武力镇压", "desc": "调动近卫军进行清洗，虽然高效但会大幅降低稳定度。" },
                            { "label": "静观其变", "desc": "暂时不采取行动，观察局势变化，风险较低。" }
                        ],

                        "impacts": [
                            {
                            "type": "STAT_CHANGE",
                            "targetId": "p_target_id",
                            "attrKey": "stability",
                            "oldValue": "稳固",
                            "newValue": "动荡"
                            },
                            {
                            "type": "REGION_TRANSFER",
                            "targetName": "诺曼底",
                            "newValue": "p_new_owner"
                            }
                        ]
                        }`,

                        // --- 2. 剧本生成 (Script Generator) - v6 类型增强版 (基于 v5) ---
                        script_generator: `你是一个世界设定生成器，严格按照指定的 JSON 结构输出。

                        【任务目标】
                        构建一个具有**深度层级结构**和**多样化实体类型**的世界。

                        【关键指令】
                        1. **多重规则集 (Rule Sets)**：不要只使用一套通用属性。请定义 2-3 套不同的规则集（rule_sets）。例如：
                        - "国家规则" (包含: 稳定度, 经济, 外交立场)
                        - "城市/行省规则" (包含: 治安, 人口, 归属感)
                        - "关键角色规则" (包含: 影响力, 忠诚, 个人战力)
                        - **★ 新增要求**：每个字段定义必须包含 "type" ('string'|'number') 和 "visibility" ('editable'|'readonly')。
                        2. **层级结构 (Hierarchy)**：利用 "parentId" 字段构建树状关系。不要只生成一堆顶级势力。
                        - 例如：创建一个“帝国”作为顶级节点，然后创建几个“行省”或“军团”作为其子节点（parentId 指向帝国）。
                        3. **关联性**：确保每个 player 的 "schemaId" 对应正确的 rule_sets id。
                        4. **数据类型严格**：如果字段定义 type="number"，在生成 stats 时**必须**输出纯数字（如 100），严禁使用字符串（如 "100"）。

                        【输出规则】
                        1. **只输出纯 JSON**：单一、合法的 JSON 对象，无Markdown。
                        2. **严格遵守结构**：参照下方的【JSON 结构范例】。
                        3. **语言与篇幅**：中文描述。Timeline 中的 event content 约 50 字。
                        4. **属性值**：对于 String 类型的属性，优先使用描述性文本（如“动荡(D)”）；对于 Number 类型，必须是数字。

                        【JSON 结构与范例】
                        {
                        "rule_sets": [
                            {
                                "id": "rs_nation",
                                "name": "国家政体",
                                "fields": [
                                    { "key": "gov_type", "label": "政体", "type": "string", "visibility": "editable" },
                                    { "key": "stability", "label": "稳定度", "type": "number", "visibility": "editable" }
                                ]
                            },
                            {
                                "id": "rs_hero",
                                "name": "英雄单位",
                                "fields": [
                                    { "key": "class", "label": "职阶", "type": "string", "visibility": "editable" },
                                    { "key": "loyalty", "label": "忠诚", "type": "string", "visibility": "editable" },
                                    { "key": "power", "label": "战力", "type": "number", "visibility": "editable" }
                                ]
                            }
                        ],
                        "global_vars": [
                            { "key": "当前纪元", "value": "第四纪元", "type": "string", "visibility": "editable" }
                        ],
                        "lorebook": [
                            {
                            "keys": "源石,Originium", 
                            "content": "一种黑色的结晶矿物...",
                            "mode": "auto"
                            }
                        ],
                        "players": [
                            {
                            "id": "p_empire",
                            "name": "乌萨斯帝国",
                            "logo": "fa-solid fa-crown",
                            "color": "#881c1c",
                            "desc": "以军事立国的庞大帝国。",
                            "parentId": "", 
                            "schemaId": "rs_nation",
                            "stats": {
                                "gov_type": "君主专制",
                                "stability": 80 // Number
                            }
                            },
                            {
                            "id": "p_patriot",
                            "name": "爱国者",
                            "logo": "fa-solid fa-shield-halved",
                            "color": "#555555",
                            "desc": "帝国的传奇将领。",
                            "parentId": "p_empire",
                            "schemaId": "rs_hero",
                            "stats": {
                                "class": "重装盾卫",
                                "loyalty": "死忠",
                                "power": 9000 // Number
                            }
                            }
                        ],
                        "timeline": [
                            {
                            "id": 1,
                            "timeRange": "1096年 冬",
                            "events": [
                                {
                                "factionId": "p_empire",
                                "timeStart": "冬初",
                                "timeEnd": "冬末",
                                "summary": "大叛乱的前兆",
                                "content": "（此处生成 50 字左右的详细描述...）",
                                "impacts": [
                                    {
                                    "targetId": "p_patriot",
                                    "targetName": "爱国者",
                                    "attrKey": "loyalty",
                                    "attrLabel": "忠诚",
                                    "newValue": "动摇"
                                    }
                                ]
                                }
                            ]
                            }
                        ]
                        }`,

                        // --- 3. 上帝模式 (God Mode) - v4 类型增强版 (基于 v3) ---
                        god_mode: `你是一个智能数据库管理员，能够理解并执行对 JSON 数据的关联修改。

                        【核心指令】
                        根据用户的自然语言指令，修改当前的 JSON 状态。你必须返回一个包含所有被修改的顶层字段的 JSON 对象。

                        【关键规则：多规则集与层级】
                        1. **修改规则集 (Rule Sets)**：
                           - 用户可能会说“给所有国家增加人口属性”。你需要找到 \`rule_sets\` 中代表“国家”的那个对象，在它的 \`fields\` 中添加新字段。
                           - **★ 新增要求**：当添加新字段时，必须补全 "type" ('string'|'number') 和 "visibility" ('editable'|'readonly')。默认 type='string'。
                           - 如果用户要求创建一种新类型的实体（如“创造一个神器类型”），你需要向 \`rule_sets\` 数组添加一个新对象。
                        2. **数据一致性**：
                           - 当你在规则集中添加了新属性（如 "mana"），请尝试智能地更新所有使用该规则集 ("schemaId") 的实体的 \`stats\`，给它们一个默认值。
                           - **★ 新增要求**：如果 type="number"，默认值必须是纯数字（如 0），严禁加引号。

                        【严重警告：数组完整性】
                        当你修改任何数组（如 \`players\`, \`rule_sets\`）时，**必须返回该数组的完整内容**（包括未修改的项），否则数据会丢失。

                        【输出规则】
                        1. **只输出纯 JSON**。
                        2. 仅返回被修改的顶层字段。

                        【示例】
                        用户指令: "给所有属于'英雄'规则的实体增加'魔法值(mp)'(数值型)，默认为0"
                        正确输出:
                        {
                        "rule_sets": [
                            { 
                                "id": "rs_nation", "name": "国家", "fields": [...] 
                            }, 
                            { 
                                "id": "rs_hero", 
                                "name": "英雄", 
                                "fields": [
                                    { "key": "hp", "label": "生命", "type": "number", "visibility": "editable" },
                                    { "key": "mp", "label": "魔法值", "type": "number", "visibility": "editable" } // ★ 新增字段，带类型
                                ]
                            }
                        ],
                        "players": [
                            { 
                            "id": "p_arthur", 
                            "schemaId": "rs_hero", // 匹配到了规则集
                            "stats": { 
                                "hp": 100, 
                                "mp": 0 // ★ 自动填充默认值，纯数字
                            } 
                            },
                            { 
                            "id": "p_england", 
                            "schemaId": "rs_nation", 
                            "stats": { ... } // 未受影响
                            }
                        ]
                        }`,
                    }
                },
                
                // [新增] API 编辑器临时状态
                isEditingProfile: false,
                editingProfileData: { id: null, name: '', provider: 'Gemini', baseUrl: '', model: '', key: '' },

                // --- i18n Dictionary (完整修复版) ---
                translations: {
                    app_title: { zh: "LEVANT 自动化推演", en: "LEVANT Auto-Deduction", ja: "LEVANT 自動演繹" },
                    status_online: { zh: "系统联机", en: "SYSTEM ONLINE", ja: "システム稼働中" },
                    status_offline: { zh: "离线模式", en: "OFFLINE MODE", ja: "オフライン" },
                    next_turn_label: { zh: "下一回合 / 序列", en: "NEXT TURN / SEQ", ja: "次のターン / シーケンス" },
                    auto: { zh: "自动", en: "AUTO", ja: "自動" },
                    btn_script_gen: { zh: "剧本生成", en: "Script Gen", ja: "シナリオ生成" },
                    btn_files: { zh: "档案管理", en: "Files", ja: "ファイル管理" },
                    
                    // Sidebar Tabs
                    tab_world: { zh: "世界", en: "World", ja: "世界" },
                    tab_entity: { zh: "实体", en: "Entities", ja: "実体" },
                    tab_lore: { zh: "资料", en: "Lore", ja: "資料" },
                    tab_rules: { zh: "规则", en: "Rules", ja: "ルール" },

                    // [新增] 文本润色相关
                    btn_polish_text: { zh: "文本润色/重写", en: "Polish / Rewrite", ja: "文章推敲" },
                    modal_polish_title: { zh: "AI 文本润色大师", en: "AI Text Polisher", ja: "AI 文章推敲" },
                    lbl_polish_style: { zh: "目标风格", en: "Target Style", ja: "目標スタイル" },
                    lbl_polish_length: { zh: "期望字数 (约)", en: "Target Length (Approx)", ja: "文字数 (約)" },
                    lbl_polish_custom: { zh: "额外指令 (可选)", en: "Extra Instructions", ja: "追加指示" },
                    btn_apply_polish: { zh: "应用修改", en: "Apply Changes", ja: "適用" },
                    btn_start_polish: { zh: "开始生成", en: "Generate", ja: "生成開始" },
                    
                    // [修改] 文学风格预设 (更具体)
                    style_jiangnan: { zh: "江南风 (热血/哀伤/长句)", en: "Jiang Nan Style", ja: "江南風" },
                    style_liu: { zh: "刘慈欣风 (硬科幻/冷峻/宏大)", en: "Liu Cixin Style", ja: "劉慈欣風" },
                    style_jin: { zh: "金庸风 (武侠/半文半白)", en: "Jin Yong Style", ja: "金庸風" },
                    style_gu: { zh: "古龙风 (短句/浪子/留白)", en: "Gu Long Style", ja: "古龍風" },
                    style_lovecraft: { zh: "洛夫克拉夫特风 (不可名状/恐怖)", en: "Lovecraftian", ja: "ラヴクラフト風" },
                    style_scp: { zh: "SCP基金会风 (临床腔/档案/黑条)", en: "SCP Foundation Style", ja: "SCP財団風" },
                    style_history: { zh: "史记/资治通鉴风 (文言/史笔)", en: "Historical Records", ja: "史記風" },
                    
                    // Sidebar Content
                    header_global_vars: { zh: "全局变量控制", en: "Global Variables", ja: "グローバル変数" },
                    ph_var_key: { zh: "变量名", en: "Var Name", ja: "変数名" },
                    ph_var_val: { zh: "当前状态", en: "Current Value", ja: "現在値" },
                    btn_add_global: { zh: "添加全局状态", en: "Add Global Var", ja: "グローバル変数を追加" },
                    btn_new_entity: { zh: "注册新实体", en: "New Entity", ja: "新規実体登録" },
                    ph_lore_key: { zh: "关键词...", en: "Keywords...", ja: "キーワード..." },
                    ph_lore_content: { zh: "设定内容...", en: "Content...", ja: "内容..." },
                    btn_mode_on: { zh: "常驻", en: "ALWAYS", ja: "常駐" },
                    btn_mode_auto: { zh: "自动", en: "AUTO", ja: "自動" },
                    btn_mode_off: { zh: "禁用", en: "OFF", ja: "無効" },
                    btn_add_lore: { zh: "新增资料条目", en: "Add Lore Entry", ja: "資料エントリ追加" },
                    header_type_def: { zh: "类型定义", en: "TYPE DEFINITIONS", ja: "型定義" },
                    msg_no_fields: { zh: "(该类型未定义属性字段)", en: "(No fields defined for this type)", ja: "(フィールド未定義)" },
                    lbl_field_label: { zh: "显示名", en: "Label", ja: "表示名" },
                    lbl_field_key: { zh: "键名", en: "Key", ja: "キー" },
                    btn_add_rule: { zh: "添加属性字段", en: "Add Attribute", ja: "属性フィールド追加" },

                    // Timeline & Events
                    view_timeline: { zh: "时间轴情报流", en: "Timeline Stream", ja: "タイムライン" },
                    view_map: { zh: "战术地图", en: "Tactical Map", ja: "戦術地図" },
                    btn_show_all_history: { zh: "显示全部历史", en: "Show All History", ja: "全履歴を表示" },
                    msg_no_events: { zh: "等待情报输入...", en: "Awaiting Intelligence...", ja: "情報入力待ち..." },
                    header_manage_impacts: { zh: "影响管理", en: "Manage Impacts", ja: "影響管理" },
                    header_anko_options: { zh: "安科选项 (决策)", en: "ANKO OPTIONS (DECISIONS)", ja: "安価オプション (決定)" },
                    btn_add: { zh: "添加", en: "Add", ja: "追加" },
                    msg_no_options: { zh: "暂无选项", en: "No options available.", ja: "オプションなし" },
                    lbl_opt_label: { zh: "标题", en: "Label", ja: "ラベル" },
                    ph_opt_label: { zh: "选项标题", en: "Option Label", ja: "オプション名" },
                    lbl_opt_desc: { zh: "描述", en: "Desc", ja: "説明" },
                    ph_opt_desc: { zh: "后果描述...", en: "Consequence...", ja: "結果の説明..." },
                    btn_copy: { zh: "复制", en: "Copy", ja: "コピー" },
                    btn_delete: { zh: "删除", en: "Delete", ja: "削除" },

                    // Impact Editor
                    btn_type_stat: { zh: "属性变更", en: "CHANGE STAT", ja: "ステータス変更" },
                    btn_type_region: { zh: "地块转移", en: "TRANSFER REGION", ja: "領土移譲" },
                    btn_type_create: { zh: "创建实体", en: "CREATE ENTITY", ja: "実体作成" },
                    btn_type_remove: { zh: "移除实体", en: "REMOVE ENTITY", ja: "実体削除" },
                    btn_type_pin: { zh: "移动标记", en: "MOVE PIN", ja: "ピン移動" }, // 之前漏了
                    ph_target_entity: { zh: "目标实体", en: "Target Entity", ja: "対象実体" },
                    ph_attribute: { zh: "属性", en: "Attribute", ja: "属性" },
                    ph_target_region: { zh: "目标区域", en: "Target Region", ja: "対象地域" },
                    ph_new_controller: { zh: "新控制者", en: "New Controller", ja: "新支配者" },
                    ph_new_entity_name: { zh: "新实体名称...", en: "New Entity Name...", ja: "新実体名..." },
                    ph_entity_remove: { zh: "选择要移除的实体", en: "Entity to Remove", ja: "削除する実体" },
                    ph_new_value: { zh: "新值", en: "New Value", ja: "新しい値" },
                    
                    // Map Interface
                    btn_upload_map: { zh: "上传地图", en: "Upload Map", ja: "地図読込" },
                    mode_view: { zh: "浏览", en: "View", ja: "閲覧" },
                    mode_pin: { zh: "标记", en: "Pin", ja: "ピン" },
                    mode_region: { zh: "区域", en: "Region", ja: "領域" },
                    btn_fit: { zh: "适配", en: "Fit", ja: "全体" },
                    btn_export: { zh: "导出", en: "Export", ja: "出力" },
                    btn_import: { zh: "导入", en: "Import", ja: "取込" },
                    btn_img: { zh: "截图", en: "IMG", ja: "画像" },
                    hint_click_pin: { zh: "点击", en: "CLICK", ja: "クリック" },
                    hint_drag: { zh: "拖拽", en: "DRAG", ja: "ドラッグ" },
                    hint_zoom: { zh: "滚轮", en: "WHEEL", ja: "ホイール" },
                    msg_no_map: { zh: "未装载战术地图", en: "No Tactical Map Loaded", ja: "戦術地図なし" },
                    
                    // Layer Manager
                    header_layer_manager: { zh: "图层管理", en: "LAYER MANAGER", ja: "レイヤー管理" },
                    btn_add_layer_map: { zh: "+地图", en: "+Map", ja: "+地図" },
                    btn_add_layer_reg: { zh: "+区域", en: "+Reg", ja: "+領域" },
                    btn_add_layer_pin: { zh: "+标记", en: "+Pin", ja: "+ピン" },
                    msg_no_layers_created: { zh: "暂无图层。请点击上方按钮添加。", en: "No Layers Created. Click buttons above to add one.", ja: "レイヤーなし。上のボタンで追加してください。" },

                    // Right Panel Tabs
                    tab_pending: { zh: "待决", en: "Pending", ja: "保留中" },
                    tab_combat: { zh: "战斗", en: "Combat", ja: "戦闘" },
                    tab_console: { zh: "指令台", en: "Console", ja: "コンソール" },
                    tab_godmode: { zh: "上帝模式", en: "God Mode", ja: "神モード" },
                    msg_empty_queue: { zh: "队列为空", en: "Queue Empty", ja: "キューが空です" },
                    placeholder_input: { zh: "// 输入原始指令...\n例如: #Cortex 试图入侵 #NeoTokyo", en: "// Input raw command...\ne.g., #Cortex attempts to hack #NeoTokyo", ja: "// コマンドを入力...\n例: #Cortex が #NeoTokyo に侵入を試みる" },

                    // Right Panel - Combat
                    header_combat: { zh: "战斗裁决系统 (UCS)", en: "Universal Combat System", ja: "汎用戦闘システム" },
                    lbl_attacker: { zh: "攻击方", en: "Attacker", ja: "攻撃側" },
                    lbl_defender: { zh: "防御方", en: "Defender", ja: "防御側" },
                    opt_select: { zh: "选择...", en: "Select...", ja: "選択..." },
                    lbl_combat_loc: { zh: "战斗地点", en: "Location", ja: "場所" },
                    opt_no_loc: { zh: "-- 无特定地点 --", en: "-- No Specific Location --", ja: "-- 場所指定なし --" },
                    optgroup_regions: { zh: "领土区域", en: "Regions (Territory)", ja: "領土エリア" },
                    optgroup_pins: { zh: "标记点 (POI)", en: "Pins (POI)", ja: "地点 (POI)" },
                    label_combat_context: { zh: "战斗背景 / 战术意图", en: "Context / Intent", ja: "戦闘背景 / 意図" },
                    ph_combat_context: { zh: "例如：争夺桥头堡 / 遭遇战 / 试图刺杀", en: "E.g. Bridgehead skirmish / Encounter / Assassination attempt", ja: "例：橋頭堡の争奪 / 遭遇戦 / 暗殺の試み" },
                    label_dice_check: { zh: "命运检定 (RNG)", en: "Fate Check (RNG)", ja: "運命判定" },
                    btn_add_die: { zh: "添加骰子", en: "Add Die", ja: "ダイス追加" },
                    ph_die_intent: { zh: "检定目的 (如: 命中/伤害)", en: "Check (e.g. Hit/Dmg)", ja: "判定目的 (例: 命中/ダメ)" },
                    btn_roll_all: { zh: "全部投掷", en: "ROLL ALL DICE", ja: "全ロール" },
                    btn_judge_combat: { zh: "AI 裁决战斗结果", en: "AI Judge Combat", ja: "AI 戦闘裁定" },

                    // Right Panel - Godmode & Editor
                    header_godmode: { zh: "全局状态干涉 (上帝模式)", en: "GLOBAL STATE MANIPULATION", ja: "神の操作" },
                    msg_godmode_desc: { zh: "用自然语言直接修改世界状态。例如：“把所有名为‘帝国’的势力的兵力设为0”，“给所有人增加一个‘理智值’属性，默认为100”。", en: "Modify world state with natural language. E.g., 'Set manpower to 0 for all Empire factions', 'Add Sanity stat to everyone, default 100'.", ja: "自然言語で世界の状態を直接変更します。例：「『帝国』という名前の全勢力の兵力を0にする」、「全員に『理性値』属性を追加し、デフォルトを100にする」。" },
                    ph_godmode: { zh: "输入神之指令...", en: "Enter divine command...", ja: "神のコマンドを入力..." },
                    btn_execute: { zh: "执行", en: "EXECUTE", ja: "実行" },

                    ai_core_label: { zh: "AI 智能核心 (Active)", en: "AI CORE (Active)", ja: "AI コア (稼働中)" },
                    header_anko_mode: { zh: "安科模式", en: "ANKO MODE", ja: "安価モード" },
                    header_anko_on: { zh: "安科: 开启", en: "ANKO: ON", ja: "安価: ON" },
                    btn_ai_deduce: { zh: "AI 智能补全 / 推演", en: "AI DEDUCTION / AUTO-COMPLETE", ja: "AI 自動補完 / 演繹" },
                    status_thinking: { zh: "正在进行战术推演...", en: "Calculating Strategy...", ja: "戦術演算中..." },

                    // AI Editor Inputs
                    label_actor: { zh: "行动实体", en: "Actor", ja: "行動主体" },
                    label_start: { zh: "开始", en: "Start", ja: "開始" },
                    label_end: { zh: "结束", en: "End", ja: "終了" },
                    option_ai_auto: { zh: "AI 自动判断", en: "AI Auto-Detect", ja: "AI 自動判定" },
                    option_global: { zh: "全局事件", en: "Global Event", ja: "グローバルイベント" },
                    label_summary: { zh: "标题摘要", en: "Summary", ja: "要約" },
                    label_impact: { zh: "状态变更计算", en: "State Impact Calc", ja: "状態変化計算" },
                    label_details: { zh: "详细情报档案", en: "Detailed Intelligence", ja: "詳細情報アーカイブ" },
                    ph_editor_content: { zh: "// 在此输入剧情内容...", en: "// Enter story content here...", ja: "// ここにストーリーを入力..." },
                    lbl_manual_options: { zh: "手动选项 (MANUAL)", en: "MANUAL OPTIONS", ja: "手動オプション" },
                    msg_no_manual_options: { zh: "(未定义选项，点击'Add'手动创建)", en: "(No options defined. Click 'Add' to create manual choices.)", ja: "(オプション未定義、'Add'で作成)" },
                    btn_add_pending: { zh: "加入待决序列", en: "Add to Pending", ja: "保留リストに追加" },
                    label_next_turn_b: { zh: "下个回合:", en: "Next Turn:", ja: "次ターン:" },
                    btn_commit: { zh: "执行推演 (Commit)", en: "COMMIT TURN", ja: "ターン実行 (Commit)" },

                    // Modals - Context
                    modal_context_title: { zh: "上下文装配与推演", en: "Context Assembler", ja: "コンテキストアセンブラ" },
                    modal_context_subtitle: { zh: "确认 AI 将接收到的“世界切片”以及“当前指令”。", en: "Confirm the 'World Slice' and 'Action' sent to AI.", ja: "AIに送信する「世界スライス」と「現在指令」を確認してください。" },
                    set_sys_prompt: { zh: "系统提示词 (System Prompt)", en: "System Prompt", ja: "システムプロンプト" },
                    ctx_current: { zh: "当前指令与草稿", en: "Current Action", ja: "現在の指令" },
                    ctx_global: { zh: "世界全局变量", en: "Global Vars", ja: "グローバル変数" },
                    ctx_rules: { zh: "属性规则定义", en: "Stat Rules", ja: "属性ルール" },
                    ctx_lore: { zh: "资料设定 (Lore)", en: "Lore Entries", ja: "資料設定" },
                    ctx_entities: { zh: "参与实体", en: "Active Entities", ja: "参加実体" },
                    ctx_history: { zh: "历史记录", en: "History Memory", ja: "履歴メモリ" },
                    ctx_hist_deep: { zh: "深层记忆 (近 - 含详情)", en: "Deep Mem (Recent - Full)", ja: "深層記憶 (詳細)" },
                    ctx_hist_shallow: { zh: "浅层记忆 (远 - 仅摘要)", en: "Shallow Mem (Older - Summary)", ja: "浅層記憶 (要約)" },
                    ctx_preview_label: { zh: "Payload 预览 (AI 可见内容)", en: "Payload Preview (What AI Sees)", ja: "ペイロードプレビュー" },
                    ctx_preview_hint: { zh: "AI 将基于以上预览内容进行生成。", en: "AI will generate based on the preview content.", ja: "AIは上記に基づいて生成します。" },

                    // Modals - Settings
                    settings_title: { zh: "系统配置", en: "System Settings", ja: "システム設定" },
                    settings_ui: { zh: "界面与语言", en: "Interface & Language", ja: "UIと言語" },
                    settings_theme: { zh: "界面风格", en: "Theme", ja: "テーマ" },
                    settings_lang: { zh: "系统语言", en: "Language", ja: "言語" },
                    set_llm_config: { zh: "LLM API 配置", en: "LLM API Configuration", ja: "LLM API 設定" },
                    set_provider: { zh: "服务提供商", en: "Provider Type", ja: "プロバイダー" },
                    set_base_url: { zh: "API 地址 (Base URL)", en: "Base URL", ja: "API URL" },
                    set_model: { zh: "模型名称", en: "Model Name", ja: "モデル名" },
                    set_key: { zh: "API 密钥 (Key)", en: "API Key", ja: "API キー" },
                    set_proxy: { zh: "网络代理 (Proxy)", en: "Network Proxy", ja: "プロキシ" },
                    set_enable_proxy: { zh: "启用本地代理", en: "Enable Local Proxy", ja: "プロキシ有効化" },

                    header_welcome_guide: { zh: "新用户必读？", en: "New to Levant?", ja: "初めての方へ" },
                    desc_welcome_guide: { zh: "建议先阅读《操作手册》，快速了解核心概念、推演流程以及如何开启第一局游戏。", en: "Read the User Manual to learn core concepts and how to start your first game.", ja: "操作マニュアルを読んで、基本概念とゲームの始め方を学びましょう。" },
                    
                    // [新增] 代理帮助文案
                    proxy_help_why: { zh: "何时开启：API 请求超时、无法连接 OpenAI/Google 等海外服务时。", en: "When to enable: API timeouts or unable to connect to OpenAI/Google.", ja: "いつ使う：APIタイムアウトや海外サービスに接続できない場合。" },
                    proxy_help_port: { zh: "端口号(Port)：7890 是常见代理软件(如Clash)的默认端口。如果您的软件使用了不同端口，请在代理软件的“设置”中查找“本地端口(Local Port)”并填入。", en: "Port: 7890 is default for tools like Clash. If different, check 'Local Port' in your proxy app settings.", ja: "ポート：7890は一般的です。異なる場合は、プロキシアプリの設定で「ローカルポート」を確認してください。" },
                    desc_prompt_system: { zh: "用于日常“战术推演”与“智能补全”的核心指令。", en: "Core instruction for daily 'Tactical Deduction' and 'Auto-Complete'.", ja: "日常の「戦術演繹」と「自動補完」のための核心指令。" },
                    desc_prompt_script: { zh: "用于“剧本生成”功能，控制世界观初始化逻辑。", en: "Controls world initialization logic for 'Script Generation'.", ja: "「シナリオ生成」機能用、世界観初期化ロジックを制御。" },
                    desc_prompt_god: { zh: "用于“上帝模式”功能，控制直接修改 JSON 数据的逻辑。", en: "Controls JSON manipulation logic for 'God Mode'.", ja: "「神モード」機能用、JSONデータ直接修正ロジックを制御。" },
                    btn_save: { zh: "保存配置", en: "Save Config", ja: "設定保存" },

                    // [新增] TUN 模式提示
                    proxy_help_tun: { 
                        zh: "进阶技巧 (TUN模式)：如果勾选代理且端口正确仍无法连接，请尝试【取消勾选本地代理】，并在您的 VPN 软件中开启【TUN 模式 / 增强模式】(虚拟网卡接管)。这通常能解决大部分连接问题。", 
                        en: "Advanced (TUN Mode): If connection fails even with correct port, try disabling this proxy setting and enabling 'TUN Mode / Enhanced Mode' in your VPN app.", 
                        ja: "高度なヒント (TUNモード)：ポートが正しくても接続できない場合は、このプロキシ設定を無効にし、VPNアプリで「TUNモード/拡張モード」を有効にしてみてください。" 
                    },

                    // Modals - Faction
                    modal_edit_entity: { zh: "编辑实体档案", en: "Edit Entity", ja: "実体編集" },
                    modal_new_entity: { zh: "注册新实体", en: "Register Entity", ja: "新規実体登録" },
                    label_name: { zh: "名称", en: "Name", ja: "名称" },
                    lbl_parent_entity: { zh: "父级实体 (层级关系)", en: "Parent Entity (Hierarchy)", ja: "親実体 (階層)" },
                    opt_top_level: { zh: "-- 无父级 (顶级势力) --", en: "-- No Parent (Top Level) --", ja: "-- 親なし (トップレベル) --" },
                    label_icon_color: { zh: "图标 & 颜色", en: "Icon & Color", ja: "アイコン & 色" },
                    label_desc: { zh: "描述", en: "Description", ja: "説明" },
                    label_stats: { zh: "属性面板", en: "Stats", ja: "ステータス" },
                    lbl_entity_type: { zh: "实体类型:", en: "Type:", ja: "タイプ:" },
                    msg_no_attrs_for_type: { zh: "该类型未定义属性。", en: "No attributes defined for this type.", ja: "このタイプの属性は未定義です。" },
                    btn_destroy: { zh: "销毁数据", en: "Destroy Data", ja: "データ破棄" },
                    btn_confirm: { zh: "确认", en: "Confirm", ja: "確認" },
                    btn_cancel: { zh: "取消", en: "Cancel", ja: "キャンセル" },

                    // Modals - Save/Load
                    modal_files: { zh: "档案管理", en: "File Management", ja: "ファイル管理" },
                    label_save_as: { zh: "另存为", en: "Save As", ja: "名前を付けて保存" },
                    label_local_files: { zh: "本地档案", en: "Local Files", ja: "ローカルファイル" },
                    btn_load: { zh: "读取", en: "Load", ja: "読込" },
                    btn_overwrite: { zh: "覆盖", en: "Overwrite", ja: "上書" },
                    msg_no_files: { zh: "无存档", en: "No Files", ja: "ファイルなし" },

                    // Modals - Map Editor
                    map_new_terr: { zh: "新建领土 (Region)", en: "New Territory", ja: "新規領土" },
                    map_edit_terr: { zh: "编辑领土 (Region)", en: "Edit Territory", ja: "領土編集" },
                    map_add_pin: { zh: "添加标记 (Pin)", en: "Add Pin", ja: "ピン追加" },
                    map_edit_pin: { zh: "编辑标记 (Pin)", en: "Edit Pin", ja: "ピン編集" },
                    map_geo_title: { zh: "地缘政治设定", en: "Geopolitics", ja: "地政学設定" },
                    label_geo_name: { zh: "地理名称", en: "Region Name", ja: "地域名" },
                    hint_geo_name: { zh: "该地块的永久地理名称。", en: "The permanent name of this land.", ja: "この土地の恒久的な名前。" },
                    label_controller: { zh: "当前控制权", en: "Current Controller", ja: "支配勢力" },
                    opt_neutral: { zh: "-- 中立 / 无主 --", en: "-- Neutral / Unclaimed --", ja: "-- 中立 / 無主 --" },
                    hint_controller: { zh: "颜色将自动跟随控制者。", en: "Color matches the controller automatically.", ja: "色は支配者に追従します。" },
                    label_marker_type: { zh: "标记类型", en: "Marker Type", ja: "マーカー種類" },
                    btn_type_entity: { zh: "实体", en: "Entity", ja: "実体" },
                    btn_type_lore: { zh: "资料", en: "Lore", ja: "資料" },
                    btn_type_custom: { zh: "自定义", en: "Custom", ja: "カスタム" },
                    label_select_entity: { zh: "选择实体", en: "Select Entity", ja: "実体選択" },
                    opt_choose_entity: { zh: "-- 请选择实体 --", en: "-- Choose Entity --", ja: "-- 実体を選択 --" },
                    label_select_lore: { zh: "选择资料条目", en: "Select Lore Entry", ja: "資料エントリ選択" },
                    opt_choose_lore: { zh: "-- 请选择资料 --", en: "-- Choose Lore --", ja: "-- 資料を選択 --" },
                    hint_lore_link: { zh: "链接至资料库。", en: "Links to Lore Library.", ja: "資料データベースへリンク。" },
                    label_custom_label: { zh: "自定义标签", en: "Label Name", ja: "ラベル名" },
                    label_appearance: { zh: "图标与颜色覆盖 (可选)", en: "Icon & Color Override", ja: "アイコンと色のオーバーライド" },
                    label_icon_class: { zh: "图标类名 (FontAwesome)", en: "Icon Class", ja: "アイコンクラス" },
                    label_custom_color: { zh: "自定义颜色", en: "Custom Color", ja: "カスタム色" },
                    label_pos_region: { zh: "标签位置微调 (重心)", en: "Label Position (Centroid)", ja: "ラベル位置 (重心)" },
                    label_pos_pin: { zh: "标记坐标微调", en: "Pin Position", ja: "ピン座標" },
                    hint_pos_region: { zh: "微调地块标签的中心点。", en: "Fine-tune the label center point.", ja: "ラベルの中心点を微調整。" },
                    hint_pos_pin: { zh: "微调标记点的位置。", en: "Fine-tune pin location.", ja: "ピンの位置を微調整。" },
                    btn_remove: { zh: "移除", en: "Remove", ja: "削除" },

                    // Modals - Script Gen
                    modal_script_gen: { zh: "AI 剧本生成", en: "AI Script Generation", ja: "AI シナリオ生成" },
                    msg_script_gen_hint: { zh: "上传设定集、地图图片或描述您想要的世界观。AI 将自动生成实体、属性规则和开场。", en: "Upload lore, maps, or describe your world. AI will generate entities, rules, and intro.", ja: "設定資料、地図をアップロード、または世界観を記述。AIが実体、ルール、オープニングを生成します。" },
                    label_upload_ref: { zh: "上传参考文档 / 图片", en: "Upload Reference Docs / Images", ja: "参考資料/画像をアップロード" },
                    placeholder_prompt: { zh: "提示词 (例如: '一个魔法吞噬灵魂的黑暗奇幻世界...')", en: "Prompt (e.g., 'A grimdark fantasy world...')", ja: "プロンプト (例: '魔法が魂を食らうダークファンタジー世界...')" },
                    status_generating: { zh: "正在构建世界...", en: "Constructing World...", ja: "世界構築中..." },
                    btn_start_gen: { zh: "初始化剧本生成", en: "Initialize Generation", ja: "生成開始" },

                    // Poster
                    poster_footer_text: { zh: "LEVANT 自动化推演 | AUTOMATED REPORT", en: "LEVANT AUTO-DEDUCTION | AUTOMATED REPORT", ja: "LEVANT 自動演繹 | 自動レポート" },
                    // --- Settings: Prompt Config ---
                    set_prompt_config: { zh: "AI 提示词配置", en: "AI Prompt Configuration", ja: "AIプロンプト設定" },
                    tab_prompt_sys: { zh: "核心推演 (System)", en: "System (Deduction)", ja: "システム (演繹)" },
                    tab_prompt_script: { zh: "剧本生成 (Script)", en: "Script Gen", ja: "シナリオ生成" },
                    tab_prompt_god: { zh: "上帝模式 (God)", en: "God Mode", ja: "神モード" },
                    // [新增] Galgame 模式翻译
                    tab_prompt_galgame: { zh: "剧场模式 (VN)", en: "Galgame/VN", ja: "劇場モード" },
                    desc_prompt_galgame: { zh: "用于“剧场模式”，指导AI生成标准化的 JSON 剧本格式 (Array)。", en: "For 'VN Mode', instructs AI to generate standardized JSON script arrays.", ja: "「劇場モード」用、標準化されたJSON脚本配列を生成するよう指示。" },

                    // --- JS Dynamic Strings (用于 JavaScript 逻辑的动态文本) ---
                    dice_crit_success: { zh: "大成功!", en: "CRITICAL SUCCESS!", ja: "大成功！" },
                    dice_crit_fail: { zh: "大失败!", en: "CRITICAL FAILURE!", ja: "大失敗！" },
                    dice_pass: { zh: "成功", en: "Pass", ja: "成功" },
                    dice_fail: { zh: "失败", en: "Fail", ja: "失敗" },
                    
                    layer_new: { zh: "新建图层", en: "New Layer", ja: "新規レイヤー" },
                    layer_map: { zh: "地图底图", en: "Map Layer", ja: "地図レイヤー" },
                    layer_region: { zh: "领土层", en: "Regions", ja: "領域レイヤー" },
                    layer_marker: { zh: "标记层", en: "Markers", ja: "マーカーレイヤー" },
                    
                    opt_new: { zh: "新选项", en: "New Option", ja: "新規オプション" },
                    opt_desc_ph: { zh: "后果描述...", en: "Description...", ja: "結果の説明..." },
                    dec_new: { zh: "新决策", en: "New Decision", ja: "新規決定" },
                    dec_desc_ph: { zh: "潜在后果...", en: "Potential consequences...", ja: "潜在的な結果..." },

                    splash_init: { zh: "[ 按任意键或点击初始化系统 ]", en: "[ PRESS ANY KEY TO INITIALIZE ]", ja: "[ 任意のキーを押して初期化 ]" },

                    // [新增] 剧本生成高级选项
                    lbl_adv_settings: { zh: "高级生成参数", en: "Advanced Settings", ja: "詳細設定" },
                    lbl_gen_rules_count: { zh: "生成规则集数量", en: "Rule Sets Count", ja: "ルールセット数" },
                    lbl_gen_entities_count: { zh: "生成实体数量", en: "Entities Count", ja: "実体数" },
                    lbl_gen_attr_style: { zh: "属性数值风格", en: "Attribute Style", ja: "属性スタイル" },
                    
                    opt_style_mixed: { zh: "智能混搭 (推荐)", en: "Smart Mixed (Recommended)", ja: "スマート混合 (推奨)" },
                    opt_style_number: { zh: "纯数字 (RPG风)", en: "Numbers Only (1-100)", ja: "数値のみ (RPG風)" },
                    opt_style_letter: { zh: "字母评级 (S/A/B)", en: "Letter Grades (S/A/B)", ja: "ランク (S/A/B)" },
                    opt_style_text: { zh: "文字描述 (极高/低)", en: "Text Desc (High/Low)", ja: "テキスト (高/低)" },

                    btn_load_copy: { zh: "载入编辑", en: "Load to Edit", ja: "編集に読込" },
                    btn_remove_item: { zh: "移除条目", en: "Remove Item", ja: "項目削除" },

                    // [新增] Custom Prompt 相关的翻译
                    tab_prompt_custom: { zh: "自定义 (Custom)", en: "Custom Prompt", ja: "カスタム" },
                    desc_prompt_custom: { zh: "全局自定义指令。在推演和剧本生成时，这部分内容会根据您的设置插入到上下文中。", en: "Global custom instructions injected into context.", ja: "グローバルカスタム命令。" },
                    ctx_custom: { zh: "自定义指令 (Custom Prompt)", en: "Custom Prompt", ja: "カスタムプロンプト" },
                    lbl_use_custom: { zh: "启用自定义指令", en: "Enable Custom Prompt", ja: "カスタムプロンプトを有効化" },
                    // [新增翻译] API Profile Manager
                    header_api_profiles: { zh: "API 配置管理", en: "API Profiles", ja: "API設定管理" },

                    // [新增] 首次启动提示
                    msg_setup_api_first: { 
                        zh: "欢迎使用！Levant 需要一个 API Key 才能启动 AI 核心。\n\n请查看设置窗口中的【获取指南】，点击链接申请（推荐 Gemini），然后点击【新建配置】填入即可。", 
                        en: "Welcome! Levant needs an API Key to start.\n\nPlease check the [Get API Keys] guide below, get a key (Gemini recommended), then click [New Profile] to add it.", 
                        ja: "ようこそ！AIコアを起動するにはAPIキーが必要です。\n\n下の【APIキー取得】ガイドを確認し、キーを取得してから（Gemini推奨）、【新規作成】をクリックして入力してください。" 
                    },
                    
                    // [新增] API 获取指南文案
                    header_api_guide: { zh: "API Key 获取指南", en: "Get API Keys", ja: "APIキー取得" },
                    
                    // [新增] API Key 解释
                    api_key_explanation: { 
                        zh: "把 API Key 想象成一个“给程序的专用密码”。当 Levant 需要与 AI 对话时，它会出示此密钥以证明自己有权访问。AI 服务商通过它来识别用户并计算用量（包括免费额度）。请妥善保管，不要泄露！Levant 会将其加密保存在您的本地浏览器中。", 
                        en: "Think of an API Key as a 'special password for programs.' When Levant talks to an AI, it shows this key to prove it has permission. Providers use it to identify you and track usage (including free tiers). Keep it secret! Levant saves it encrypted in your local browser.", 
                        ja: "APIキーは「プログラム専用のパスワード」です。LevantがAIと対話する際に、このキーを提示してアクセス権を証明します。サービス提供者はこれを使用してユーザーを識別し、使用量（無料枠を含む）を計算します。他人には教えないでください！Levantはキーを暗号化してローカルに保存します。" 
                    },
                    
                    // 各家点评 (简练到位)
                    desc_gemini: { zh: "【首选推荐】免费额度大，智商在线，支持识图/读文档。", en: "[Recommended] Generous free tier, smart, supports vision/docs.", ja: "【推奨】無料枠が大きく、賢い。画像/文書認識対応。" },
                    desc_deepseek: { zh: "国产之光，推理能力极强，价格极其亲民。", en: "Top-tier reasoning, extremely low cost.", ja: "推論能力が高く、価格が非常に安い。" },
                    desc_silicon: { zh: "聚合平台，可高速调用 DeepSeek V3/R1、Qwen 等模型。", en: "Aggregator for DeepSeek/Qwen etc. High speed.", ja: "DeepSeek/Qwen等の高速アグリゲーター。" },
                    desc_common: { zh: "行业标杆，能力综合。", en: "Industry Standard.", ja: "業界標準。" },

                    btn_add_profile: { zh: "新建配置", en: "New Profile", ja: "新規作成" },
                    lbl_profile_name: { zh: "配置别名", en: "Profile Name", ja: "プロファイル名" },
                    msg_confirm_delete: { zh: "确定删除此配置吗？", en: "Delete this profile?", ja: "削除しますか？" },
                    lbl_active_profile: { zh: "当前使用", en: "Active", ja: "使用中" },
                    btn_open_tutorial: { zh: "新手必读 (教程)", en: "Beginner's Guide", ja: "初心者ガイド" },
                    modal_tutorial_title: { zh: "Gemini API 获取教程", en: "Gemini API Tutorial", ja: "Gemini API ガイド" },
                    
                    // 教程正文 (Markdown 格式)
                    tutorial_content: { 
                        zh: `
# 从零开始获取 Google Gemini API Key 完整指南

这份指南是为可能不太熟悉流程的小白们准备的，希望能帮助大家顺利地用上免费的 Gemini。

#### **第一步：准备工作与注册谷歌账号**
在开始之前，我们需要一个稳定、可靠的“梯子”(VPN)，并确保其节点位于支持 Gemini API 的国家（如美国、日本、新加坡等）。这是所有后续步骤的基础。

1.  **访问注册页面**：使用浏览器打开 [注册谷歌账号](https://myaccount.google.com) 并访问。
2.  **填写基本信息**：按照页面的提示，填写您的姓名、想要的 Gmail 地址以及密码。
3.  **手机号验证**：Google 通常会要求使用手机号进行验证。这里建议使用非中国大陆的手机号，可以提高账号的稳定性。如果没有的话，也可以先尝试用国内手机号注册。
4.  **完善账号信息**：注册成功后，建议进入账号管理页面，把辅助邮箱、安全问题等信息补充完整。这能增加谷歌对您账号的信任度。

---

#### **第二步：进入 Google AI Studio 并创建项目**
这是获取 API Key 的核心步骤。

**方法一（强烈推荐，超简单！）：直接在AI Studio领取**
这就像是VIP快速通道，专门为获取Gemini这种免费API准备的！

1.  **访问 Google AI Studio**：在浏览器中打开 [Google AI Studio](https://aistudio.google.com)
2.  **登录账号**：使用您刚刚注册好的谷歌账号登录。
3.  **同意服务条款**：首次进入时，Google 会弹出服务条款，请勾选同意并继续。
4.  **获取 API Key**：
    *   登录成功后，在页面的左侧菜单栏中找到并点击 \`Get API key\` (获取 API 密钥) 的选项。
    *   系统会引导您创建一个新的 Google Cloud 项目来存放这个密钥。点击 \`Create API key in new project\` (在新项目中创建 API 密钥) 按钮。
    *   稍等片刻，屏幕上就会弹出一个包含一长串字符的密钥。**这就是您需要的 API Key！**

**方法二（备用，功能更全）：通过Google Cloud平台**
如果第一种方法不知为何失败了，或者您以后想探索更多功能，可以走这条路。

1.  **进入平台**: [Google Cloud](https://console.cloud.google.com/)
2.  **创建项目**: 登录后，在页面上方找到并点击“选择项目” -> “新建项目”，起个名字后创建。
3.  **找到凭据页面**: 在左侧导航菜单（“≡”）里，找到 **“API 和服务” -> “凭据”**。
4.  **创建密钥**: 点击 **“+ 创建凭据” -> “API 密钥”**。

**【❗️特别提醒 ❗️】**
**这个 API Key 只会完整显示这一次！** 请立刻点击旁边的复制按钮，并将它粘贴到安全的地方（如记事本）保存好。一旦关闭这个窗口，您就无法再次看到完整的密钥了。

---

#### **第三步：常见问题与解决方案 (Troubleshooting)**

如果在过程中遇到以下弹窗和错误，可以参考下面的方法解决哦。

*   **问题1：提示 “无法创建API密钥” (Cannot create API key)**
    *   **原因**：这通常是因为您的网络环境或谷歌账号被系统判定为有风险。
    *   **解决方案**：
        1.  更换一个更稳定、干净的“梯子”节点，最好是主流国家（如美国）的节点。
        2.  清空浏览器缓存和 Cookie，或使用浏览器的“无痕模式”重试。
        3.  确保您的谷歌账号信息已经尽可能完善。

*   **问题2：需要填写地址和付款信息 (如让你填写表单)**
    *   **原因**：这是因为 Google Cloud Platform 需要验证您的身份。虽然 Gemini API 目前有免费额度，但这个流程是标准化的。
    *   **解决方案**：
        1.  **国家/地区**：选择您的“梯子”所在的国家，比如 \`United States\`。
        2.  **地址信息**：随便填就可以啦。可以搜索 “美国地址生成器” (US address generator) 这类网站，然后把生成的名字、街道地址、城市、邮政编码等信息复制粘贴进去。
        3.  **付款信息**：通常情况下，只是为了获取免费的 API Key 是不需要绑定信用卡的。如果遇到了强制要求绑卡的页面，说明可能进入了付费服务的流程，建议返回上一步重新检查。
                        `, 
                        en: "Please refer to Chinese version.", 
                        ja: "中国語版を参照してください。" 
                    },
                    // [新增] 帮助中心按钮
                    btn_help_center: { zh: "帮助手册", en: "Help Manual", ja: "ヘルプ" },
                    modal_help_title: { zh: "Levant 操作手册", en: "Levant User Manual", ja: "Levant ユーザーマニュアル" },

                    // [新增] 帮助文档正文 (Markdown)
                    help_content: {
                        zh: `
# Levant 快速入门指南

欢迎指挥官。Levant 是一个基于 AI 的自动化世界推演引擎。在这里，你可以扮演上帝、国王或旁观者，见证历史的流动。

---

### 1. 核心概念 (Core Concepts)

*   **实体 (Entity)**: 世界的基本单位。它可以是一个**国家**、一个**角色**、甚至是一个**概念**（如“大瘟疫”）。
*   **规则集 (Rule Set)**: 定义实体的属性模板。例如“国家”有“国力”，“角色”有“生命值”。
*   **时间轴 (Timeline)**: 历史的记录。每一次“回合提交 (Commit Turn)”，都会将【待决队列】中的事件固化为历史。
*   **AI 核心**: 基于大语言模型（如 Gemini/DeepSeek）的大脑。它负责生成剧情、裁决战斗、以及自动补全你的指令。

---

### 2. 界面概览 (Interface)

*   **左侧 (资料库)**: 
    *   **世界**: 全局变量（如“当前纪元”、“魔法浓度”）。
    *   **实体**: 查看所有角色卡片。点击可编辑属性、立绘。
    *   **资料**: 存放世界观设定（Lorebook）。
    *   **规则**: 定义属性字段（如 HP, STR）。
*   **中间 (视图)**:
    *   **情报流**: 以时间轴形式展示已发生的历史。
    *   **地图**: 可视化战术地图。支持上传底图、绘制领土、标记地点。
*   **右侧 (控制台)**:
    *   **待决 (Pending)**: 下一回合即将发生的事件队列。可拖拽排序。
    *   **指令 (Console)**: 输入自然语言（如“帝国向联邦宣战”），点击 AI 推演生成事件。
    *   **战斗 (Combat)**: 专业的 TRPG 骰子裁决系统。
    *   **上帝 (God Mode)**: 直接修改世界现实（如“删除所有精灵族”）。

---

### 3. 如何开始第一局？ (Quick Start)

**方法 A：从零创造 (推荐)**
1.  点击顶部导航栏的 **[剧本生成]** 按钮。
2.  在弹窗中描述你想要的世界（例如：“一个赛博朋克风格的古代中国”）。
3.  点击生成。AI 会自动为你创建实体、规则和开场剧情。

**方法 B：手动推演**
1.  在右侧 **[指令]** 面板，输入：“主角在一个酒馆醒来，发现身边有一封信。”
2.  点击底部的 **[AI 智能推演]**。
3.  AI 会生成一个事件卡片，展示在下方的编辑器中。
4.  检查无误后，点击 **[加入待决序列]**。
5.  在待决面板确认后，点击最底部的 **[执行推演 (COMMIT)]**。恭喜，历史的第一页写下了！

---

### 4. 进阶技巧 (Advanced)

*   **地图交互**: 在地图模式下，选择“标记”工具，点击地图任意位置可创建据点。你可以把据点链接到某个实体，它的颜色会自动同步。
*   **立绘差分**: 在实体编辑面板，可以上传多张表情差分（如“愤怒”、“大笑”）。在剧场模式中 AI 会自动调用。
*   **剧场模式 (VN Mode)**: 点击时间轴上任意事件右上角的 🎬 图标，可以进入沉浸式文字冒险模式，与角色直接对话互动。
*   **战斗裁决**: 在右侧 [战斗] 面板，选择攻守双方，添加几个 D20 骰子，点击投掷。AI 会根据属性和骰子结果自动写出精彩的战报。

---

### 5. 常见问题 (FAQ)

*   **Q: AI 没反应？**
    *   A: 请检查设置中的 API Key 是否正确，以及是否开启了代理（Proxy）。
*   **Q: 地图怎么是一片黑？**
    *   A: 你需要先在地图工具栏点击 [上传地图] 按钮，上传一张图片作为底图。
*   **Q: 如何保存？**
    *   A: 系统会自动保存到 \`autosave.json\`。你也可以点击顶部的 [档案] 按钮手动导出/导入。
                        `,
                        en: "Please refer to Chinese version.",
                        ja: "中国語版を参照してください。"
                    },
                },

                // [修改] stat_schema 升级为 rule_sets (允许多套规则)
                // 结构示例: [{ id: 'default', name: '通用规则', fields: [{key:'hp', label:'生命'}] }]
                rule_sets: [], 
                activeSchemaId: '', // 当前在左侧栏正在编辑哪一套规则
                
                lorebook: [], players: [], timeline: [], global_vars: [],
                map_data: { layers: [], activeLayerId: '', image: '', pins: [], regions: [] },

                // [新增] 地图交互模式状态
                mapToolMode: 'pin', // 'pin' | 'region'
                isProcessingRegion: false,
                editingRegionIndex: -2, // -2:无, -1:新增, >=0:编辑
                
                // [新增] 地图视图控制状态
                mapView: {
                    scale: 1,      
                    x: 0,          
                    y: 0,          
                    isDragging: false,
                    isMouseDown: false, // ★ 新增：区分按下和拖拽
                    startX: 0,
                    startY: 0,
                    // ★ 新增：徽章大小控制 (默认 1.0)
                    badgeScale: 1.0, 
                    // ★ 新增：显示模式 (full=全显示, icon=仅图标, dot=仅点)
                    displayMode: 'full' 
                },
                showMap: false,
                // [优化] 时间轴分页控制
                timelinePageSize: 10, 
                showAllTimeline: false,
                pendingTurnRange: "", pendingEvents: [],
                // [修改] 增加 options 数组
                editor: { factionId: '', factionIds: [], timeStart: '', timeEnd: '', summary: '', content: '', impacts: [], options: [] },
                impactForm: { type: 'STAT_CHANGE', targetId: '', attrKey: '', newValue: '', targetName: '' },
                editImpactForm: { type: 'STAT_CHANGE', targetId: '', attrKey: '', newValue: '', targetName: '' },
                
                posterData: { title: '', factionName: '', color: '', icon: '', content: '', badges: [], timeDisplay: '' },
                quoteIdx: 0,
                quotes: [ "岁寒，然后知松柏之后凋也", "看看演员 王公 游民 盗贼的心电图", "人生若只如初见，何事秋风悲画扇", "我还想和你谈论宇宙和天空", "西郊有密林，助君出重围", "我一无所有 只有一颗赤子之心", "高树多悲风，海水扬其波", "你方唱罢我登场，反认他乡是故乡", "空山新林归鹧鸪，世间繁华梦一出", "昨夜西风凋碧树，独上高楼，望尽天涯路", "我听见那声音向我严正发问 我为明天尽些什么义务", "六朝何事？只成门户私计！" ],
                
                tempSystemPrompt: "",
                contextConfig: {
                    // [新增] 自定义 Prompt 开关
                    includeCustom: true,
                    
                    // 原有的开关
                    includeGlobal: true, 
                    includeRules: true, 
                    includeHistory: true, 
                    includeCurrent: true,
                    includeMap: true,
                    
                    // [核心记忆变量]
                    historyDeepDepth: 1,
                    historyShallowDepth: 3,
                    
                    // ★★★ [关键修复] 必须把这些空数组加回来！否则报 length undefined 错误 ★★★
                    loreList: [], 
                    playerList: [],
                    mapRegionList: [], 
                    mapPinList: [],

                    // [修改] order 数组，将 'custom' 放在最前面
                    order: ['custom', 'global', 'rules', 'lore', 'players', 'map', 'history', 'current']
                }
            }
        },
        watch: {
            // 1. 监听 UI 主题变化，实时切换 CSS 变量
            'ui.theme': {
                handler(newTheme) {
                    document.body.setAttribute('data-theme', newTheme);
                },
                immediate: true
            },

            // 2. [新增] 监听地图打点表单中的 selectedId 变化
            // 当用户在下拉框选择了一个实体或资料时，自动填充图标和颜色
            'pinForm.selectedId': function(newVal) {
                // 如果是“实体(Entity)”模式
                if (this.pinForm.mode === 'entity' && newVal) {
                    const p = this.players.find(x => x.id === newVal);
                    if (p) {
                        // 自动填入该实体的 Logo 和 颜色
                        this.pinForm.icon = p.logo || 'fa-solid fa-users';
                        this.pinForm.color = p.color || '#ffffff';
                    }
                }
                // 如果是“资料(Lore)”模式
                else if (this.pinForm.mode === 'lore' && newVal) {
                    // 如果当前还是默认图标，或者是空的，就自动填入“书签”图标和绿色
                    // 这样设计是为了防止覆盖用户刚刚手动修改过的自定义图标
                    const currentIcon = this.pinForm.icon;
                    if (!currentIcon || currentIcon === 'fa-solid fa-map-pin' || currentIcon === 'fa-solid fa-users') {
                        this.pinForm.icon = 'fa-solid fa-book-bookmark';
                        this.pinForm.color = '#10b981'; // 资料默认给个翡翠绿
                    }
                }
            },
            
            // 3. [新增] 监听模式切换，重置一下默认值，避免图标残留
            'pinForm.mode': function(newMode) {
                if (newMode === 'custom') {
                    // 切换到自定义模式时，如果当前没有图标，给一个默认的
                    if (!this.pinForm.icon) {
                        this.pinForm.icon = 'fa-solid fa-map-pin';
                        this.pinForm.color = '#f59e0b'; // 琥珀色
                    }
                }
                // 切换到实体模式时，清空 selectedId 以便触发下一次选择监听
                if (newMode === 'entity') {
                   // 这里不需要强制清空 selectedId，保留上次的选择体验可能更好
                   // 但如果想重置，可以在这里写 this.pinForm.selectedId = '';
                }
            }
        },
    async mounted() {
            // --- 1. 界面与媒体初始化 (等待 DOM 就绪) ---
            this.$nextTick(async () => {
                // A. 绑定键盘监听 (用于 Click-to-Start)
                document.addEventListener('keydown', this.initKeyHandler, { once: true });
                
                // B. 初始化黑客帝国背景特效
                if (this.showSplash) {
                    this.initMatrixEffect();
                }

                // C. ★★★ [新增] 获取随机音乐列表 (通过 LevantAPI) ★★★
                this.playRandomMusic(false);
            });

            // --- 2. 核心逻辑：智能版本更新 (保留 Key，强制更新 Prompt) ---
            const storedVersion = localStorage.getItem('levant_version');
            
            if (storedVersion !== this.APP_VERSION) {
                console.info(`[System] Version updated (${storedVersion} -> ${this.APP_VERSION}). Updating prompts...`);
                
                const oldSettingsStr = localStorage.getItem('levant_settings');
                if (oldSettingsStr) {
                    try {
                        const oldSettings = JSON.parse(oldSettingsStr);
                        
                        // 提取旧配置
                        const savedApi = oldSettings.api || {};
                        const savedProxy = oldSettings.proxy || {};
                        
                        // 回填 Key 和 BaseURL 到当前 data (保留用户资产)
                        if(savedApi.key) this.settings.api.key = savedApi.key;
                        if(savedApi.baseUrl) this.settings.api.baseUrl = savedApi.baseUrl;
                        if(savedApi.provider) this.settings.api.provider = savedApi.provider;
                        if(savedApi.model) this.settings.api.model = savedApi.model;
                        if(savedProxy) this.settings.proxy = savedProxy;

                        // 删除旧缓存，并立即保存新配置 (含新 Prompt)
                        localStorage.removeItem('levant_settings');
                        localStorage.setItem('levant_settings', JSON.stringify({
                            api: this.settings.api,
                            proxy: this.settings.proxy,
                            ui: this.ui,
                            prompts: this.settings.prompts
                        }));
                        
                    } catch (e) {
                        localStorage.removeItem('levant_settings'); 
                    }
                }
                
                localStorage.setItem('levant_version', this.APP_VERSION);
            }

            // --- 3. 窗口与输入监听 ---
            window.addEventListener('resize', () => {
                this.isLargeScreen = window.innerWidth >= 1024;
            });
            
            // ★★★ [新增] 键盘快捷键 ★★★
            window.addEventListener('keydown', (e) => {
                // Ctrl+Z (Undo)
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                    e.preventDefault();
                    this.performUndo();
                }
                // Ctrl+Y (Redo)
                if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                    e.preventDefault();
                    this.performRedo();
                }
            });

            // 处理软键盘遮挡
            const handleFocus = () => { if(!this.isLargeScreen) this.isKeyboardOpen = true; };
            const handleBlur = () => { if(!this.isLargeScreen) this.isKeyboardOpen = false; };
            
            document.addEventListener('focusin', (e) => {
                if(['INPUT', 'TEXTAREA'].includes(e.target.tagName)) handleFocus();
            });
            document.addEventListener('focusout', (e) => {
                if(['INPUT', 'TEXTAREA'].includes(e.target.tagName)) handleBlur();
            });

            // --- 4. 加载用户设置 ---
            const savedSettings = localStorage.getItem('levant_settings');
            if (savedSettings) {
                try {
                    const parsed = JSON.parse(savedSettings);
                    if(parsed.api) this.settings.api = { ...this.settings.api, ...parsed.api };
                    if(parsed.proxy) this.settings.proxy = { ...this.settings.proxy, ...parsed.proxy }; 
                    if(parsed.prompts) this.settings.prompts = { ...this.settings.prompts, ...parsed.prompts };
                    if(parsed.ui) this.ui = { ...this.ui, ...parsed.ui };
                    
                    // [新增] 加载保存的 Profiles
                    if(parsed.api_profiles && Array.isArray(parsed.api_profiles)) {
                        this.settings.api_profiles = parsed.api_profiles.map(p => ({
                            ...p,
                            // ★ 强制注入 UI 状态字段 (不保存到本地，每次刷新重置)
                            status: 'unknown', // unknown | success | error
                            isTesting: false
                        }));
                        this.settings.active_profile_id = parsed.active_profile_id || null;
                    } else {
                        // [兼容性迁移] 如果是旧用户，没有 profiles，把当前的 api 设置存为第一个 profile
                        if (this.settings.api.key) {
                            const legacyProfile = {
                                id: Date.now(),
                                name: "Default (Legacy)",
                                ...this.settings.api,
                                status: 'unknown', // ★
                                isTesting: false   // ★
                            };
                            this.settings.api_profiles = [legacyProfile];
                            this.settings.active_profile_id = legacyProfile.id;
                        }
                    }

                } catch(e) { console.error("Failed to load settings", e); }
            }
            // ★★★ [新增] 首次启动/无Key检测 ★★★
            // 逻辑：如果配置列表为空，或者当前选中的配置没有填写 Key
            const hasValidProfile = this.settings.api_profiles.length > 0;
            const hasActiveKey = this.settings.api.key && this.settings.api.key.trim() !== "";

            // 如果没有有效的 Profile，或者有 Profile 但当前没选中有效的 Key
            if (!hasValidProfile || !hasActiveKey) {
                setTimeout(() => {
                    this.showSettings = true; 
                    
                    setTimeout(() => {
                        // [修改] 提示语改得更明确，指向下方指南
                        alert(this.t('msg_setup_api_first'));
                        
                        // [删除] 不要自动打开编辑器了，让用户先看界面
                        // if (this.settings.api_profiles.length === 0) {
                        //    this.openProfileEditor(null);
                        // }
                    }, 300);
                }, 500);
            }
            
            document.body.setAttribute('data-theme', this.ui.theme);

            // --- 5. 加载游戏存档 ---
            await this.loadGame(this.currentSaveFile);
            if (this.map_data.image) {
                // 使用 $nextTick 确保 DOM 里的 Canvas 已经渲染出来
                this.$nextTick(() => this.initMapCanvas(this.map_data.image));
            }
            
            // --- 6. 自动保存与名言轮播 ---
            window.addEventListener('beforeunload', () => { if(this.serverConnected) this.saveGame('autosave.json'); });
            
            setInterval(() => {
                let nextIdx; do { nextIdx = Math.floor(Math.random() * this.quotes.length); } while (nextIdx === this.quoteIdx); 
                this.quoteIdx = nextIdx;
            }, 6000);
        },
        computed: {
            vnCurrentLine() {
                if (!this.vnScript || this.vnScript.length === 0) return null;
                return this.vnScript[this.vnLineIndex];
            },
            // [新增] 获取当前正在编辑的立绘对象 (可能是默认的，也可能是差分里的)
            currentEditingAvatar() {
                if (this.previewAvatarIndex === -1) {
                    // 返回一个代理对象，读写直接映射到 editingFaction 的根属性
                    return {
                        url: this.editingFaction.avatar,
                        scale: this.editingFaction.avatarScale,
                        offsetY: this.editingFaction.avatarOffsetY,
                        isDefault: true
                    };
                } else {
                    const avatars = this.editingFaction.avatars;
                    if (avatars && avatars[this.previewAvatarIndex]) {
                        return avatars[this.previewAvatarIndex];
                    }
                    return null;
                }
            },
            // [优化] 仅渲染可见的时间轴回合，避免后期 DOM 爆炸
            visibleTimeline() {
                if (this.showAllTimeline) return this.timeline;
                // 仅返回最后 N 个回合
                const start = Math.max(0, this.timeline.length - this.timelinePageSize);
                return this.timeline.slice(start);
            },
            // [新增] 树状实体列表：将扁平的 players 转换为带层级信息的列表
            sortedPlayers() {
                const result = [];
                // 1. 建立 ID 到对象的映射，方便查找
                const map = new Map(this.players.map(p => [p.id, { ...p, _depth: 0 }]));
                
                // 2. 递归函数：添加节点及其子节点
                const addNode = (parentId, depth) => {
                    // 找到所有父级ID为 parentId 的实体
                    const children = this.players.filter(p => (p.parentId || '') === parentId);
                    
                    children.forEach(child => {
                        const childObj = map.get(child.id);
                        childObj._depth = depth;
                        result.push(childObj);
                        // 递归查找下一层
                        addNode(child.id, depth + 1);
                    });
                };

                // 3. 从根节点（parentId 为空）开始遍历
                addNode('', 0);
                
                // 4. 处理孤儿节点（以防万一数据错乱，虽不常见但为了健壮性）
                const addedIds = new Set(result.map(r => r.id));
                this.players.forEach(p => {
                    if (!addedIds.has(p.id)) {
                        result.push({ ...p, _depth: 0 }); // 放在最后，视为根节点
                    }
                });

                return result;
            },

            currentAttrValue() {
                if (!this.impactForm.targetId || !this.impactForm.attrKey) return '---';
                const p = this.players.find(x => x.id === this.impactForm.targetId);
                return p ? (p.stats[this.impactForm.attrKey] || 'N/A') : '???';
            },

            finalContextPreview() {
                let preview = "";
                
                // --- 辅助函数：处理属性可见性与格式 ---
                // 改用 methods 中的统一格式化函数，确保预览和实际发送一致
                const formatAttr = (val, visibility, type) => {
                    return this.formatContextAttr(val, visibility, type);
                };

                this.contextConfig.order.forEach(type => {
                    
                    // [新增] 处理 Custom Prompt
                    if (type === 'custom' && this.contextConfig.includeCustom && this.settings.prompts.custom) {
                        preview += `=== [CUSTOM INSTRUCTION] ===\n${this.settings.prompts.custom}\n\n`;
                    }

                    // 1. 全局变量 (原代码)
                    if (type === 'global' && this.contextConfig.includeGlobal) {
                        // 过滤掉 hidden 的变量
                        const visibleGlobals = this.global_vars.filter(g => g.visibility !== 'hidden');
                        
                        if (visibleGlobals.length > 0) {
                            preview += `=== [WORLD: GLOBAL VARS] ===\n`;
                            preview += visibleGlobals.map(g => {
                                // 兼容旧存档：默认 visibility 为 editable
                                const vis = g.visibility || 'editable'; 
                                const valStr = formatAttr(g.value, vis, g.type);
                                // formatAttr 返回 null 说明是 hidden，虽然上面 filter 过了，双重保险
                                return valStr !== null ? `${g.key}: ${valStr}` : null;
                            }).filter(x => x !== null).join('\n');
                            preview += `\n\n`;
                        }
                    }

                    // --- 2. 规则定义 (Rules) ---
                    if (type === 'rules' && this.contextConfig.includeRules) {
                        preview += `=== [WORLD: RULES DEFINITIONS] ===\n`;
                        this.rule_sets.forEach(rs => {
                            // 构造字段定义字符串
                            const fieldsStr = rs.fields.map(f => {
                                const vis = f.visibility || 'editable';
                                // 如果字段定义本身是 hidden，也不告诉 AI 这个字段的存在
                                if (vis === 'hidden') return null;
                                
                                const visMark = vis === 'readonly' ? '(Auto-Calc)' : '';
                                return `${f.key}=${f.label}${visMark}`;
                            }).filter(x => x).join(', '); // 过滤 null
                            
                            if (fieldsStr) {
                                preview += `TYPE [${rs.name}]: ${fieldsStr}\n`;
                            }
                        });
                        preview += `\n`;
                    }

                    // --- 3. 资料设定 (Lore) ---
                    if (type === 'lore') {
                        const activeLore = this.contextConfig.loreList.filter(l => l.active);
                        if (activeLore.length > 0) {
                            preview += `=== [WORLD: LORE] ===\n${activeLore.map(l => `> [${l.keys}]: ${l.content}`).join('\n')}\n\n`;
                        }
                    }

                    // --- 4. 参与实体 (Entities) [核心修改区域] ---
                    if (type === 'players') {
                        const activePlayers = this.contextConfig.playerList.filter(p => p.active);
                        if (activePlayers.length > 0) {
                            preview += `=== [WORLD: ENTITIES] ===\n`;
                            
                            preview += activePlayers.map(pItem => {
                                // 回查原始数据
                                const realP = this.players.find(x => x.id === pItem.id);
                                if (!realP) return "";

                                // A. 查找该实体的规则集
                                const schema = this.rule_sets.find(rs => rs.id === realP.schemaId);
                                const visibleStats = {};

                                // B. 根据规则集过滤属性
                                if (schema) {
                                    schema.fields.forEach(f => {
                                        const rawVal = realP.stats[f.key] !== undefined ? realP.stats[f.key] : '-';
                                        const formatted = formatAttr(rawVal, f.visibility || 'editable', f.type);
                                        
                                        // 只有非 hidden 才加入输出对象
                                        if (formatted !== null) {
                                            visibleStats[f.key] = formatted;
                                        }
                                    });
                                } else {
                                    // 旧存档无规则集，全显
                                    Object.assign(visibleStats, realP.stats);
                                }

                                // C. 立绘表情 Tag 信息
                                let avatarTagsInfo = "";
                                if (this.enableAvatarTags && realP.avatars && realP.avatars.length > 0) {
                                    const tags = realP.avatars.map(a => a.tag).join(", ");
                                    avatarTagsInfo = `\n  [VISUAL] Available Expressions: [${tags}]`;
                                }

                                return `ID:${realP.id} | ${realP.name}\n  Desc: ${realP.desc}\n  Stats: ${JSON.stringify(visibleStats)}${avatarTagsInfo}`;
                            }).join('\n\n');
                            
                            preview += `\n\n`;
                        }
                    }

                    // --- 5. 地图数据 (Map) ---
                    if (type === 'map' && this.contextConfig.includeMap) {
                        const activeRegions = this.contextConfig.mapRegionList.filter(r => r.active);
                        const activePins = this.contextConfig.mapPinList.filter(p => p.active);
                        
                        if (activeRegions.length > 0 || activePins.length > 0) {
                            preview += `=== [TACTICAL MAP DATA] ===\n`;
                            
                            if (activeRegions.length > 0) {
                                preview += "Regions (Control):\n";
                                activeRegions.forEach(reg => {
                                    const realReg = this.map_data.regions.find(r => r.id === reg.id) || reg;
                                    const owner = realReg.ownerId ? this.getFactionName(realReg.ownerId) : "NEUTRAL";
                                    
                                    // 地块属性也应用过滤逻辑
                                    let regStatsStr = "";
                                    if(realReg.schemaId && realReg.stats) {
                                        const rSchema = this.rule_sets.find(rs => rs.id === realReg.schemaId);
                                        if(rSchema) {
                                            const safeRegStats = {};
                                            rSchema.fields.forEach(f => {
                                                const val = formatAttr(realReg.stats[f.key], f.visibility||'editable');
                                                if(val !== null) safeRegStats[f.key] = val;
                                            });
                                            regStatsStr = " " + JSON.stringify(safeRegStats);
                                        }
                                    }
                                    
                                    preview += `- Region "${realReg.name}" (Owner: ${owner})${regStatsStr}\n`;
                                });
                            }
                            
                            if (activePins.length > 0) {
                                preview += "\nPoints of Interest:\n";
                                activePins.forEach(pin => {
                                    const realPin = this.map_data.pins.find(p => p.id === pin.id) || pin;
                                    const label = realPin.label || this.getPinName(realPin.linkId);
                                    preview += `- Pin "${label}" at [${realPin.x.toFixed(0)},${realPin.y.toFixed(0)}]\n`;
                                });
                            }
                            preview += "\n";
                        }
                    }

                    // --- 6. 历史回溯 (History) ---
                    if (type === 'history' && this.contextConfig.includeHistory) {
                        const totalLen = this.timeline.length;
                        const deepLen = this.contextConfig.historyDeepDepth;       // 近期 (详情)
                        const shallowLen = this.contextConfig.historyShallowDepth; // 远期 (摘要)

                        // 计算切片索引 (正序: 远 -> 近)
                        const deepStart = Math.max(0, totalLen - deepLen);
                        const shallowEnd = deepStart;
                        const shallowStart = Math.max(0, shallowEnd - shallowLen);

                        const shallowTurns = this.timeline.slice(shallowStart, shallowEnd);
                        const deepTurns = this.timeline.slice(deepStart);

                        if (shallowTurns.length > 0 || deepTurns.length > 0) {
                            preview += `=== [HISTORY MEMORY] ===\n`;
                            
                            // A. 浅层记忆 (仅摘要)
                            if (shallowTurns.length > 0) {
                                preview += `--- Shallow Memory (Far Context / Summary Only) ---\n`;
                                shallowTurns.forEach(turn => {
                                    preview += `[Turn ${turn.id}] ${turn.timeRange}\n`;
                                    turn.events.forEach(e => {
                                        preview += ` • ${e.summary} (Actor: ${e.factionId})\n`;
                                    });
                                    preview += `\n`;
                                });
                            }

                            // B. 深层记忆 (含完整 Content 和 Impacts)
                            if (deepTurns.length > 0) {
                                preview += `--- Deep Memory (Recent Events / Full Detail) ---\n`;
                                deepTurns.forEach(turn => {
                                    preview += `[Turn ${turn.id}] ${turn.timeRange}\n`;
                                    turn.events.forEach(e => {
                                        preview += ` • ${e.summary} (Actor: ${e.factionId})\n`;
                                        // 注入完整内容
                                        if (e.content) preview += `   Details: ${e.content}\n`;
                                        if (e.impacts && e.impacts.length) {
                                             preview += `   Impacts: ${e.impacts.map(i => `${i.targetName}.${i.attrLabel}: ${i.change || (i.oldValue+'->'+i.newValue)}`).join('; ')}\n`;
                                        }
                                    });
                                    preview += `\n`;
                                });
                            }
                            preview += "\n";
                        }
                    }

                    // --- 7. 当前指令 (Current) ---
                    if (type === 'current' && this.contextConfig.includeCurrent) {
                        preview += `=== [CURRENT INSTRUCTION] ===\n`;
                        if (this.rawInput) preview += `> COMMAND: ${this.rawInput}\n`;
                        if (this.editor.factionId) preview += `> ACTOR_ID: ${this.editor.factionId}\n`;
                        if (this.editor.timeStart) preview += `> TIME: ${this.editor.timeStart} - ${this.editor.timeEnd}\n`;
                        if (this.editor.summary) preview += `> DRAFT_TITLE: ${this.editor.summary}\n`;
                        if (this.editor.content) preview += `> DRAFT_CONTENT: ${this.editor.content}\n`;
                        if (this.editor.impacts.length) {
                            preview += `> PLANNED_IMPACTS: ${JSON.stringify(this.editor.impacts)}\n`;
                        }
                        
                        if (this.generateOptions) {
                            preview += `> MODE: Generate "options" array for player decision.\n`;
                        }
                        preview += `\n`;
                    }
                });
                return preview;
            }
        },
        methods: {
            openPolishModal(event) {
                this.polishingEvent = event;
                // 初始化内容：直接把原文本放进去，方便用户对比或基于原文本修改
                this.polishConfig.draftContent = event.content;
                this.showPolishModal = true;
            },

            getStyleDescription(styleKey) {
                switch(styleKey) {
                    case 'jiangnan': return "示例：虽然是个废柴，但也要像狮子一样去战斗。哪怕结局注定是悲剧，也要把世界点燃给你看。";
                    case 'liu': return "示例：在这个宇宙中，生存是第一要务。巨大的星舰如同墓碑般静默，这里没有温情，只有物理法则的冰冷审判。";
                    case 'jin': return "示例：那汉子使出一招「亢龙有悔」，掌风呼啸，端的是威猛无比。虽是生死相搏，却也透着一股侠者风范。";
                    case 'gu': return "示例：风。冷风。他没有动。因为他知道，动就是死。";
                    case 'lovecraft': return "示例：那是一种无法用人类语言描述的几何结构，散发着来自远古深渊的腥臭，令人的理智在瞬间崩塌。";
                    case 'scp': return "示例：项目等级：Keter。描述：对象表现为[数据删除]。任何接触对象的人员均需进行心理评估。";
                    case 'history': return "示例：初，帝起兵于野，众皆不服。乃设奇谋，大破敌军，遂定天下。史臣曰：此非天命乎？";
                    default: return "选择一种风格以查看描述...";
                }
            },

            // 2. [修改] 执行润色 (使用中文 Prompt)
            async executePolish() {
                if (!this.settings.api.key) return alert("API Key missing");
                
                this.isPolishing = true;
                const originalText = this.polishingEvent.content; 
                
                // 构建具体的风格指令
                let styleInstruction = "";
                switch(this.polishConfig.style) {
                    case 'jiangnan': 
                        styleInstruction = "请模仿中国作家【江南】（代表作《龙族》《九州缥缈录》）的文风。特点：热血中带着哀伤，善用长句和排比，强调少年的孤独与成长，描写细腻且富有张力，喜欢使用“狮子”、“王座”、“孤独”等意象。"; 
                        break;
                    case 'liu': 
                        styleInstruction = "请模仿中国科幻作家【刘慈欣】（代表作《三体》）的文风。特点：冷峻、宏大、硬核，侧重对技术细节和宇宙图景的描写，文字质朴但具有极强的画面感和震撼力，经常从社会学角度审视文明。"; 
                        break;
                    case 'jin': 
                        styleInstruction = "请模仿【金庸】的武侠文风。特点：半文半白，叙事流畅，善于描写动作招式和心理活动，融合历史背景，具有浓厚的中国传统文化底蕴。"; 
                        break;
                    case 'gu': 
                        styleInstruction = "请模仿【古龙】的武侠文风。特点：极短的句子，大量的留白和换行。强调氛围渲染而非具体招式，充满哲理性的对话，主角通常是浪子，带有一种孤独、冷酷的气质。"; 
                        break;
                    case 'lovecraft': 
                        styleInstruction = "请模仿【H.P. 洛夫克拉夫特】（克苏鲁神话）的文风。特点：大量使用形容词（如“不可名状”、“亵渎”），强调人类在未知道具面前的渺小与恐惧，氛围压抑、阴暗、粘稠。"; 
                        break;
                    case 'scp': 
                        styleInstruction = "请模仿【SCP基金会】的文档风格。特点：临床腔，绝对客观冷静，使用“项目”、“对象”、“收容”等术语，适当使用[数据删除]或██来增加神秘感。"; 
                        break;
                    case 'history': 
                        styleInstruction = "请模仿中国古代【二十四史】（如《史记》）的文言文或半文言风格。特点：微言大义，用词精炼，客观记述但暗含褒贬，注重人物列传和历史事件的因果。"; 
                        break;
                }

                const systemPrompt = `你是一位精通多种文学风格的资深编辑。
你的任务是重写用户提供的文本，使其完全符合指定的作家风格。

【重写要求】
1. **核心风格**：${styleInstruction}
2. **篇幅控制**：大约 ${this.polishConfig.length} 字（请尽量贴近此长度）。
3. **额外指令**：${this.polishConfig.customInstruction || "无"}
4. **输出规则**：只返回重写后的正文，不要包含“好的”、“这是重写后的版本”等任何解释性语句。`;

                const payload = {
                    provider: this.settings.api.provider,
                    apiKey: this.settings.api.key,
                    baseUrl: this.settings.api.baseUrl,
                    model: this.settings.api.model,
                    useProxy: this.settings.proxy.enabled,
                    proxyPort: this.settings.proxy.port,
                    systemPrompt: systemPrompt,
                    context: "【原始文本】\n" + originalText,
                    userPrompt: "开始重写。"
                };

                try {
                    const data = await window.LevantAPI.generateAI(payload);
                    this.polishConfig.draftContent = data.result.trim();
                    this.updateCurrentProfileStatus('success');
                } catch (e) {
                    this.updateCurrentProfileStatus('error');
                    alert("Polish Failed: " + e.message);
                } finally {
                    this.isPolishing = false;
                }
            },

            applyPolishResult() {
                if (this.polishingEvent) {
                    this.polishingEvent.content = this.polishConfig.draftContent;
                    this.saveGame('autosave.json');
                }
                this.showPolishModal = false;
            },
            saveAndExitVN() {
                if (this.vnCurrentEvent) {
                    // ★ 将当前演出的完整脚本（包含你的插话和AI的新回应）保存回事件数据
                    // 这样回到时间轴视图，或者生成海报时，内容就是你们互动后的新版本了
                    this.vnCurrentEvent.content = JSON.stringify(this.vnScript);
                    
                    // 自动更新摘要（可选）：标记一下这个事件已经被改写了
                    if (!this.vnCurrentEvent.summary.includes("(Interactive)")) {
                        this.vnCurrentEvent.summary += " (Interactive)";
                    }
                }
                
                this.vnMode = false;
                this.saveGame('autosave.json'); // 物理存盘
            },
            // --- 修改后的 sendVNChat 方法 ---
            async sendVNChat() {
                if (!this.vnUserInput.trim()) return;
                if (this.isThinking) return;

                const text = this.vnUserInput.trim();
                this.vnUserInput = ""; 

                // 1. 查找主角ID
                const roleId = this.vnPlayerRoleId || 'narrator';

                const newLine = { role: roleId, text: text, tag: 'default' };

                // ★★★ 核心修改点开始 ★★★
                
                // 如果当前不是剧本的最后一行，说明用户是在“中途插话”
                if (this.vnLineIndex < this.vnScript.length - 1) {
                    this.vnScript.splice(this.vnLineIndex + 1);
                }

                // ★★★ [新增] 既然剧情变了，原本的选项(options)就不再适用了，清空它以免误导
                if (this.vnCurrentEvent) {
                    this.vnCurrentEvent.options = [];
                    this.vnShowOptions = false; // 确保选项层不遮挡
                }

                // 将用户的话加入剧本末尾
                this.vnScript.push(newLine);
                
                // ★★★ 核心修改点结束 ★★★

                // 移动索引到最新一行（即用户刚才说的话）并播放
                this.vnLineIndex = this.vnScript.length - 1;
                
                // 立即显示用户的话（不用打字机效果，直接显示更爽快）
                this.vnDisplayedText = text; 
                this.vnIsTyping = false; // 停止打字状态

                // 3. 调用 AI 生成回应 (续写新的未来)
                await this.generateVNResponse();
            },

            async generateVNResponse() {
                this.isThinking = true;

                // 1. 构建系统指令 (System Prompt)
                let systemPrompt = `你正处于一个“互动式视觉小说”场景中。
            【当前场景】：${this.vnCurrentEvent.summary}
            【任务】：根据用户的最新发言和上下文，扮演场景中的其他角色进行回应。
            【要求】：
            1. 输出 JSON 数组：[{"role":"id","tag":"expression","text":"..."}]
            2. 生成 1-3 句对话，保持剧情紧凑。`;

                // 注入自定义 Prompt
                if (this.vnContextConfig.includeCustom && this.settings.prompts.custom) {
                    systemPrompt += `\n\n=== 全局设定 ===\n${this.settings.prompts.custom}`;
                }

                // 2. 构建上下文 Payload (Context)
                let contextStr = "";

                // A. 演员表与设定 (The Cast)
                // 获取所有活跃演员 + 主角
                const activeIds = [...new Set([...this.vnActiveEntityIds, ...this.players.filter(p=>p.isProtagonist).map(p=>p.id)])];
                
                contextStr += `=== 🎭 登场角色 (ACTIVE CAST) ===\n`;
                activeIds.forEach(id => {
                    const p = this.players.find(x => x.id === id);
                    if (!p) return;
                    
                    // 基础信息
                    contextStr += `[ID: ${p.id}] ${p.name} (${p.desc})\n`;
                    
                    // 属性 (Stats)
                    if (this.vnContextConfig.includeStats) {
                        contextStr += `  Stats: ${JSON.stringify(p.stats)}\n`;
                    }

                    // ★★★ 关键：立绘差分列表 (Avatar Tags) ★★★
                    // 告诉 LLM 有哪些表情可用，以便它自然切换
                    if (this.vnContextConfig.includeTags && p.avatars && p.avatars.length > 0) {
                        const tags = p.avatars.map(a => a.tag).join(", ");
                        contextStr += `  [Visual Tags Available]: ${tags}\n`;
                    }
                    contextStr += `\n`;
                });

                // B. 前情提要 (History) - [修改] 支持深浅分离的独立设置
                if (this.vnContextConfig.includeHistory) {
                    const totalLen = this.timeline.length;
                    const deepLen = this.vnContextConfig.historyDeepDepth;
                    const shallowLen = this.vnContextConfig.historyShallowDepth;

                    // 计算切片
                    const deepStart = Math.max(0, totalLen - deepLen);
                    const shallowEnd = deepStart;
                    const shallowStart = Math.max(0, shallowEnd - shallowLen);

                    const shallowTurns = this.timeline.slice(shallowStart, shallowEnd);
                    const deepTurns = this.timeline.slice(deepStart);

                    if (shallowTurns.length > 0 || deepTurns.length > 0) {
                        contextStr += `=== 📜 历史记忆 (MEMORY) ===\n`;
                        
                        // 浅层：只带摘要
                        if (shallowTurns.length > 0) {
                            contextStr += `[远期概要]:\n`;
                            shallowTurns.forEach(t => {
                                t.events.forEach(e => contextStr += `- ${e.summary}\n`);
                            });
                        }
                        // 深层：带详细内容
                        if (deepTurns.length > 0) {
                            contextStr += `[近期详情]:\n`;
                            deepTurns.forEach(t => {
                                t.events.forEach(e => {
                                    contextStr += `- ${e.summary}\n`;
                                    if(e.content) contextStr += `  Details: ${e.content.substring(0, 300)}...\n`; // 限制长度防止爆Token
                                });
                            });
                        }
                        contextStr += `\n`;
                    }
                }

                // C. 地图/环境 (Map) - 如果需要
                if (this.vnContextConfig.includeMap) {
                    contextStr += this.buildMapString() + "\n\n";
                }

                // D. 当前剧本流 (Script Flow)
                // 截取最近 N 条，保持短期记忆连贯
                const recentLines = this.vnScript.slice(-20); 
                contextStr += `=== 🎬 当前剧本流 (CURRENT SCRIPT) ===\n${JSON.stringify(recentLines, null, 2)}`;

                // 3. 发送请求
                const payload = {
                    provider: this.settings.api.provider,
                    apiKey: this.settings.api.key,
                    baseUrl: this.settings.api.baseUrl,
                    model: this.settings.api.model,
                    useProxy: this.settings.proxy.enabled,
                    proxyPort: this.settings.proxy.port,
                    
                    systemPrompt: systemPrompt,
                    context: contextStr, 
                    // 显式提示 AI 刚刚发生了什么 (例如加入了新角色)
                    userPrompt: "Based on the script above (especially the last user action), generate the next character reactions."
                };

                try {
                    const data = await window.LevantAPI.generateAI(payload);
                    this.updateCurrentProfileStatus('success'); // ★ Success
                    const match = data.result.match(/\[[\s\S]*\]/);
                    if (match) {
                        const newLines = JSON.parse(match[0]);
                        if (Array.isArray(newLines)) {
                            this.vnScript.push(...newLines);
                            // 此时无需自动播放，等待用户操作
                        }
                    }
                } catch (e) {
                    this.updateCurrentProfileStatus('error'); // ★ Error
                    console.error("VN Gen Error:", e);
                } finally {
                    this.isThinking = false;
                }
            },
            isProtagonist(roleId) {
                if (roleId === 'narrator') return false;
                const p = this.players.find(x => x.id === roleId);
                return p && p.isProtagonist;
            },
            openFormulaModal(field) {
                this.currentEditingField = field;
                this.formulaTokens = [];
                this.activeFormulaTab = '基础';
                this.showFormulaModal = true;
                
                // TODO: 这里可以做一个简单的反向解析器，把现有的 code 转回 tokens
                // 如果无法解析，暂时先清空，或者保留在“原始代码模式”
                // 为了简单起见，这里假设每次打开都是重新构建，或者我们可以只解析简单的
                if (field.formula) {
                    // 简易提示：如果已有公式，提醒用户会覆盖
                    console.log("Editing existing formula:", field.formula);
                }
            },

            closeFormulaModal() {
                this.showFormulaModal = false;
            },

            // 2. 添加积木块
            addToken(type, label, value) {
                this.formulaTokens.push({ type, label, value });
            },

            removeToken(idx) {
                this.formulaTokens.splice(idx, 1);
            },

            // 3. 获取所有可用的字段定义（用于下拉框）
            getAllUniqueFields() {
                const map = new Map();
                this.rule_sets.forEach(rs => {
                    rs.fields.forEach(f => {
                        if (f.type === 'number') map.set(f.key, f);
                    });
                });
                return Array.from(map.values());
            },

            // 4. 获取当前上下文可用的自身字段
            getAvailableFields() {
                // 假设我们正在编辑的是一个 RuleSet 里的字段
                // 这里简单返回所有 number 类型的字段定义
                // 如果能知道当前 editingField 属于哪个 RuleSet 更好，但全局搜索也行
                return this.getAllUniqueFields();
            },

            // 5. 添加特定实体引用
            addSpecificEntityToken() {
                const p = this.players.find(x => x.id === this.formulaBuilder.targetEntityId);
                const fKey = this.formulaBuilder.targetStatKey;
                if (!p || !fKey) return;
                
                // 生成代码： parseFloat(ctx.players.find(p=>p.id=='xxx').stats['yyy']) || 0
                // 注意：我们需要在后端 recalculateState 把 players 放入 ctx
                const code = `(parseFloat(ctx.players.find(p=>p.id==='${p.id}')?.stats['${fKey}']) || 0)`;
                const label = `${p.name}的${fKey}`;
                
                this.addToken('func', label, code);
            },

            // 6. 添加聚合函数 (傻瓜化正则)
            addAggToken() {
                const stat = this.formulaBuilder.aggStat;
                const owner = this.formulaBuilder.aggOwner;
                if (!stat) return;
                
                let code = "";
                let label = "";
                
                if (owner === 'self') {
                    // 利用我们在 recalculateState 里定义的 utils
                    code = `ctx.utils.sumRegionStat(self.id, '${stat}')`;
                    label = `我的地块[${stat}]总和`;
                } else {
                    // 世界所有
                    code = `ctx.map.regions.reduce((sum,r) => sum + (parseFloat(r.stats['${stat}'])||0), 0)`;
                    label = `世界地块[${stat}]总和`;
                }
                
                this.addToken('func', label, code);
            },

            // 7. 生成代码字符串 (含校验状态)
            generateCodeFromTokens() {
                const code = this.formulaTokens.map(t => t.value).join(' ');
                this.validateFormulaResult = this.checkFormulaSyntax(code); // 触发校验
                return code;
            },

            // [新增] 语法校验函数
            checkFormulaSyntax(code) {
                if (!code.trim()) return { valid: true, msg: '' };
                try {
                    // 创建一个虚拟环境进行测试
                    // 模拟 self 和 ctx 对象，防止 undefined 报错
                    const mockSelf = { stats: {}, id: 'test' };
                    // 填充一些虚拟数据以通过运算
                    this.getAllUniqueFields().forEach(f => mockSelf.stats[f.key] = 1);
                    
                    const mockCtx = { 
                        globals: {}, 
                        players: [],
                        map: { regions: [] },
                        utils: { sumRegionStat: () => 1, getOwnedRegions: () => [] },
                        turn: 1 
                    };
                    this.global_vars.forEach(g => mockCtx.globals[g.key] = 1);

                    const func = new Function('self', 'ctx', 'Math', `
                        with(ctx) { return ${code}; }
                    `);
                    func(mockSelf, mockCtx, Math);
                    return { valid: true, msg: 'Syntax Valid' };
                } catch (e) {
                    return { valid: false, msg: e.message };
                }
            },

            // 8. 保存
            saveFormula() {
                if (this.currentEditingField) {
                    this.currentEditingField.formula = this.generateCodeFromTokens();
                    this.saveGame('autosave.json');
                }
                this.closeFormulaModal();
            },

            // 9. 样式辅助
            getTokenClass(type) {
                if (type === 'op') return 'border-gray-500 text-gray-300 bg-gray-800'; // 基础运算符
                if (type === 'num') return 'border-pink-500 text-pink-400 bg-pink-900/20'; // 数字
                if (type === 'var') return 'border-indigo-500 text-indigo-400 bg-indigo-900/20'; // 变量
                if (type === 'env') return 'border-amber-500 text-amber-400 bg-amber-900/20'; // 环境变量
                if (type === 'func') return 'border-blue-500 text-blue-400 bg-blue-900/20'; // 数学函数
                return 'border-gray-600 text-gray-400';
            },
            // --- [新增] 上下文属性格式化 (Type/Tag Generator) ---
            formatContextAttr(val, visibility, type) {
                // 1. Hidden 属性直接不可见
                if (visibility === 'hidden') return null;

                // 2. 构建元数据标签
                let metaParts = [];
                
                // 类型标记
                if (type === 'number') metaParts.push('Type:Number');
                else metaParts.push('Type:String'); // 默认为 String

                // 权限标记
                if (visibility === 'readonly') metaParts.push('ReadOnly/Auto-Calc');

                const metaTag = metaParts.length > 0 ? ` <${metaParts.join(', ')}>` : '';

                // 3. 返回格式化字符串: "100 <Type:Number, ReadOnly/Auto-Calc>"
                return `${val}${metaTag}`;
            },

            // --- [新增] 数据合规性校验 ---
            validateImpact(imp) {
                // 1. 仅校验 STAT_CHANGE 类型，其他类型暂不校验
                if (imp.type !== 'STAT_CHANGE') return { valid: true };

                // 2. 查找目标定义
                let schemaField = null;
                let targetLabel = "";

                if (imp.targetId === 'global') {
                    const gVar = this.global_vars.find(g => g.key === imp.attrKey);
                    if (gVar) {
                        schemaField = gVar; // 全局变量结构类似字段定义
                        targetLabel = "Global Var";
                    }
                } else {
                    const p = this.players.find(x => x.id === imp.targetId);
                    if (p) {
                        const schema = this.rule_sets.find(rs => rs.id === p.schemaId);
                        if (schema) {
                            schemaField = schema.fields.find(f => f.key === imp.attrKey);
                            targetLabel = p.name;
                        }
                    }
                }

                if (!schemaField) {
                    // 如果找不到定义（可能是旧数据或动态字段），默认放行，但给个警告
                    console.warn(`Validation warning: Field definition not found for ${imp.attrKey}`);
                    return { valid: true }; 
                }

                // 3. 校验可见性/只读权限
                // 如果是 readonly，AI 不允许修改 (用户手动操作除外，但这里我们也拦截 AI 生成的结果)
                // 注意：如果是 hidden，AI 根本看不到，理论上不会改，如果改了也是瞎改，必须拦截
                const visibility = schemaField.visibility || 'editable';
                if (visibility !== 'editable') {
                    return { 
                        valid: false, 
                        msg: `[Permission Denied] Property '${imp.attrLabel}' is ${visibility.toUpperCase()}. Modification blocked.` 
                    };
                }

                // 4. 校验数据类型
                const type = schemaField.type || 'string';
                if (type === 'number') {
                    // 尝试解析为数字
                    const val = parseFloat(imp.newValue);
                    if (isNaN(val)) {
                        return { 
                            valid: false, 
                            msg: `[Type Mismatch] Property '${imp.attrLabel}' requires NUMBER, but got "${imp.newValue}".` 
                        };
                    }
                    // 可选：强制转换回数字格式，防止 "100元" 这种混合字符串
                    // imp.newValue = val; 
                }

                return { valid: true };
            },
            // --- 修改后 (增强版) ---
            recalculateState() {
                const turnVal = this.timeline.length > 0 ? this.timeline[this.timeline.length-1].id : 0;
                
                // 1. 构建全知上下文 (World Context)
                // 这里的 context 将被注入到所有公式中
                const context = {
                    globals: {}, // 稍后填充
                    players: this.players,
                    map: this.map_data, // ★ 新增：允许访问地图数据
                    turn: turnVal,
                    
                    // ★ 新增：工具函数，方便用户写公式
                    // 用法示例: utils.sumChildStats('p_empire', 'gold_income')
                    utils: {
                        // 获取某实体控制的所有地块
                        getOwnedRegions: (ownerId) => {
                            if(!this.map_data.regions) return [];
                            return this.map_data.regions.filter(r => r.ownerId === ownerId);
                        },
                        // 计算某实体控制的所有地块的某个属性之和
                        sumRegionStat: (ownerId, statKey) => {
                            const regs = this.map_data.regions.filter(r => r.ownerId === ownerId);
                            return regs.reduce((sum, r) => {
                                const val = parseFloat(r.stats?.[statKey]) || 0;
                                return sum + val;
                            }, 0);
                        }
                    }
                };

                // 填充 globals 字典 (方便引用，如 context.globals['污染度'])
                this.global_vars.forEach(g => {
                    let val = g.value;
                    if (g.type === 'number') val = parseFloat(val) || 0;
                    context.globals[g.key] = val;
                });

                // --- A. 计算全局变量 (Global Vars) ---
                this.global_vars.forEach(g => {
                    if (g.type === 'number' && g.visibility === 'readonly' && g.formula) {
                        try {
                            // 将 context 解构进去，允许用户直接写 globals.xxx 或 map.regions
                            const func = new Function('ctx', 'Math', `
                                with(ctx) { 
                                    try { return ${g.formula}; } catch(e) { return 0; } 
                                }
                            `);
                            
                            let res = func(context, Math);
                            if(isNaN(res)) res = 0;
                            // 保留2位小数
                            g.value = Math.round(res * 100) / 100;
                            
                            // ★ 关键：立即更新 context 中的 globals，以便后续变量可以依赖此变量
                            context.globals[g.key] = g.value; 
                        } catch (e) {
                            console.warn(`Global formula error [${g.key}]:`, e);
                        }
                    }
                });

                // --- B. 计算实体属性 (Entity Stats) ---
                this.players.forEach(player => {
                    const schema = this.rule_sets.find(rs => rs.id === player.schemaId);
                    if (!schema) return;

                    schema.fields.forEach(field => {
                        if (field.type === 'number' && field.visibility === 'readonly' && field.formula) {
                            try {
                                // 准备 self.stats
                                const selfStats = {};
                                schema.fields.forEach(f => {
                                    let val = player.stats[f.key];
                                    if (f.type === 'number') val = parseFloat(val) || 0;
                                    selfStats[f.key] = val;
                                });

                                // 构造 self 对象
                                const selfObj = { stats: selfStats, id: player.id, name: player.name, ...player };

                                const func = new Function('self', 'ctx', 'Math', `
                                    with(ctx) {
                                        try { return ${field.formula}; } catch(e) { return 0; }
                                    }
                                `);
                                
                                let res = func(selfObj, context, Math);
                                
                                if (typeof res === 'number') {
                                    res = Math.round(res * 100) / 100;
                                } else {
                                    res = 0;
                                }
                                
                                player.stats[field.key] = res;
                            } catch (e) {
                                console.warn(`Stat formula error [${player.name}.${field.key}]:`, e);
                            }
                        }
                    });
                });
            // --- C. ★ 新增：计算地块属性 (Region Stats) ---
            if (this.map_data.regions) {
                this.map_data.regions.forEach(reg => {
                    if (!reg.schemaId) return;
                    const schema = this.rule_sets.find(rs => rs.id === reg.schemaId);
                    if (!schema) return;

                    schema.fields.forEach(field => {
                        if (field.type === 'number' && field.visibility === 'readonly' && field.formula) {
                            try {
                                const selfStats = {};
                                schema.fields.forEach(f => {
                                    let val = reg.stats[f.key];
                                    if (f.type === 'number') val = parseFloat(val) || 0;
                                    selfStats[f.key] = val;
                                });

                                // Region 的 self 对象，包含 ownerId 等有用信息
                                const selfObj = { stats: selfStats, id: reg.id, name: reg.name, ownerId: reg.ownerId, ...reg };

                                const func = new Function('self', 'ctx', 'Math', `
                                    with(ctx) {
                                        try { return ${field.formula}; } catch(e) { return 0; }
                                    }
                                `);
                                
                                let res = func(selfObj, context, Math);
                                if (typeof res === 'number') res = Math.round(res * 100) / 100;
                                else res = 0;

                                reg.stats[field.key] = res;
                            } catch (e) {
                                console.warn(`Region formula error [${reg.name}.${field.key}]:`, e);
                            }
                        }
                    });
                });
            }
            },

            // [修复] 核心算法：计算国旗投影 (加入地图长宽比修正，防止拉伸)
            getFlagTransform(reg, layer) {
                const bounds = this.getFactionBounds(layer, reg.ownerId);
                if (!bounds) return { x: 0, y: 0, w: 100, h: 100 };

                // 1. 获取地图的实际物理长宽比 (修正拉伸的关键!)
                // 尝试找到地图底图图片
                let mapRatio = 1.77; // 默认 16:9 兜底
                const mapImg = document.querySelector('#map-capture-target img');
                if (mapImg && mapImg.naturalHeight > 0) {
                    mapRatio = mapImg.naturalWidth / mapImg.naturalHeight;
                }

                // 2. 设定国旗的目标视觉比例 (3:2 = 1.5)
                const flagRatio = 1.5; 
                
                // 3. 计算修正系数
                // 我们在百分比坐标系下计算，必须抵消地图本身的拉伸
                // 公式推导：(W% * MapWidth) / (H% * MapHeight) = FlagRatio
                // => W%/H% * MapRatio = FlagRatio
                // => W%/H% = FlagRatio / MapRatio
                // 这个 ratioCorrection 就是 H% 应该相对于 W% 缩放多少
                const ratioCorrection = mapRatio / flagRatio;

                // 4. 计算疆域的“百分比比例”
                const boundsPercentRatio = bounds.w / bounds.h;

                // 5. 计算虚拟背景板 (单位: %)
                let virtW, virtH;

                // 比较时也要带上修正系数
                if (boundsPercentRatio > (1 / ratioCorrection)) {
                    // 疆域比国旗更扁 -> 宽度对齐
                    virtW = bounds.w;
                    virtH = bounds.w * ratioCorrection; 
                } else {
                    // 疆域比国旗更瘦 -> 高度对齐
                    virtH = bounds.h;
                    virtW = bounds.h / ratioCorrection;
                }

                // 6. 中心对齐
                const boundsCenterX = bounds.x + bounds.w / 2;
                const boundsCenterY = bounds.y + bounds.h / 2;
                
                const virtX = boundsCenterX - virtW / 2;
                const virtY = boundsCenterY - virtH / 2;

                // 7. 映射到局部坐标
                return {
                    x: (virtX - reg.x) / reg.w * 100,
                    y: (virtY - reg.y) / reg.h * 100,
                    w: virtW / reg.w * 100,
                    h: virtH / reg.h * 100
                };
            },
            getFactionBounds(layer, ownerId) {
                // 如果是无主之地，只计算自己，防止无主地块连成一片
                if (!ownerId) return null;

                // 简单的缓存机制 (如果不加缓存，渲染每一帧都会遍历数组，性能会略有损耗，但几百个地块以内问题不大)
                // 这里为了代码简洁，采用实时计算。
                
                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                let found = false;

                // 遍历当前图层的所有地块
                layer.data.forEach(r => {
                    if (r.ownerId === ownerId) {
                        if (r.x < minX) minX = r.x;
                        if (r.y < minY) minY = r.y;
                        // 注意：r.x 是左上角，右下角是 r.x + r.w
                        if (r.x + r.w > maxX) maxX = r.x + r.w;
                        if (r.y + r.h > maxY) maxY = r.y + r.h;
                        found = true;
                    }
                });

                if (!found) return null;

                return {
                    x: minX,
                    y: minY,
                    w: maxX - minX,
                    h: maxY - minY
                };
            },
            // --- [新增] 多行动方编辑器辅助方法 ---
            addActorToEditor(e) {
                const val = e.target.value;
                if (!val) return;
                if (!this.editor.factionIds) this.editor.factionIds = [];
                
                if (!this.editor.factionIds.includes(val)) {
                    this.editor.factionIds.push(val);
                    this.updateEditorPrimary(); // 更新主ID用于兼容
                }
                e.target.value = ""; // 重置选择器
            },
            updateEditorPrimary() {
                // 始终让 factionId 等于数组的第一个，保持旧逻辑兼容（如边框颜色）
                if (this.editor.factionIds && this.editor.factionIds.length > 0) {
                    this.editor.factionId = this.editor.factionIds[0];
                } else {
                    this.editor.factionId = '';
                }
            },
            // ★★★ [新增] 检测内容是否为 JSON 剧本格式 ★★★
            isJsonScript(content) {
                if (!content || typeof content !== 'string') return false;
                // 简单判断：必须以 [ 开头，以 ] 结尾，且看起来像 JSON
                const trimmed = content.trim();
                if (trimmed.startsWith('[') && trimmed.endsWith(']')) {
                    try {
                        // 尝试解析前几个字符确认
                        JSON.parse(trimmed); 
                        return true;
                    } catch (e) {
                        return false; 
                    }
                }
                return false;
            },

            // ★★★ [新增] 解析剧本 JSON ★★★
            parseScript(content) {
                try {
                    return JSON.parse(content);
                } catch (e) {
                    // 兜底：如果解析失败，返回包含错误的单行
                    return [{ role: 'narrator', text: content }];
                }
            },
            // ★★★ [新增] 专门处理立绘替换 (修复默认立绘无法上传的问题) ★★★
            handleAvatarReplace(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (ev) => {
                    const result = ev.target.result;
                    
                    // 判断是替换默认立绘还是差分立绘
                    if (this.previewAvatarIndex === -1) {
                        // 核心修复：强制更新 Vue 的响应式对象
                        this.editingFaction.avatar = result;
                    } else {
                        // 确保对象存在再赋值
                        if (this.editingFaction.avatars && this.editingFaction.avatars[this.previewAvatarIndex]) {
                            this.editingFaction.avatars[this.previewAvatarIndex].url = result;
                        }
                    }
                };
                reader.readAsDataURL(file);
                
                // 清空 Input，允许重复选择同一文件
                e.target.value = '';
            },
            // --- 修改 startVNMode ---
            startVNMode(event) {
                this.vnCurrentEvent = event;
                
                let script = [];
                try {
                    script = JSON.parse(event.content);
                    if (!Array.isArray(script)) throw new Error("Not an array");
                } catch (e) {
                    // 兼容纯文本，自动切分
                    const lines = event.content.split('\n').filter(l => l.trim());
                    script = lines.map(l => ({ role: 'narrator', text: l }));
                }
                
                this.vnScript = script;
                this.vnLineIndex = 0;
                this.vnShowOptions = false;
                this.vnMode = true;
                
                // ★★★ [新增] 初始化活跃演员表 ★★★
                // 默认包含事件中涉及的所有 factionIds
                // 并过滤掉主角（主角默认总是存在的）和 'global'
                this.vnActiveEntityIds = (event.factionIds || [event.factionId])
                    .filter(id => id !== 'global' && !this.isProtagonist(id));

                // [新增] 初始化玩家身份：优先选定 marked as Protagonist 的角色，否则选 narrator
                const protagonist = this.players.find(p => p.isProtagonist);
                this.vnPlayerRoleId = protagonist ? protagonist.id : 'narrator';

                // 开始播放
                this.playTypewriter(this.vnCurrentLine.text);
            },

            // --- 修改 vnNextLine ---
            vnNextLine(e) {
                // ★★★ [新增] 核心修复：如果点击的目标是输入框、按钮或其内部元素，直接终止，不切换下一句
                if (e && e.target) {
                    const tag = e.target.tagName;
                    // 如果点击的是 INPUT, BUTTON, TEXTAREA，或者点击了输入框内部
                    if (['INPUT', 'BUTTON', 'TEXTAREA'].includes(tag) || e.target.closest('input') || e.target.closest('button')) {
                        return; 
                    }
                }

                // 1. 如果正在打字，立即显示全文本 (Skip typing)
                if (this.vnIsTyping) {
                    clearInterval(this.vnTypeTimer);
                    this.vnDisplayedText = this.vnFullText;
                    this.vnIsTyping = false;
                    return;
                }

                // 2. 如果还有下一句，播放下一句
                if (this.vnLineIndex < this.vnScript.length - 1) {
                    this.vnLineIndex++;
                    this.playTypewriter(this.vnCurrentLine.text);
                } else {
                    // ★★★ [修改] 剧本播放完毕后的逻辑 ★★★
                    
                    // 只有当事件确实包含预设选项时，才弹出选项层结束对话
                    if (this.vnCurrentEvent.options && this.vnCurrentEvent.options.length > 0) {
                        this.vnShowOptions = true;
                    } else {
                        // 如果没有选项，说明是“开放式对话”
                        // 此时什么都不做，停留在最后一句画面上
                        // 输入框依然在，用户可以继续输入 sendVNChat 来“续命”
                        console.log("Script ended, waiting for user input...");
                    }
                }
            },

            // --- [新增] 打字机核心逻辑 ---
            playTypewriter(text) {
                this.vnFullText = text;
                this.vnDisplayedText = "";
                this.vnIsTyping = true;
                
                if (this.vnTypeTimer) clearInterval(this.vnTypeTimer);
                
                let i = 0;
                // [修改] 提高打字速度：从 30ms 改为 10ms，提升流畅感
                this.vnTypeTimer = setInterval(() => {
                    if (i < text.length) {
                        this.vnDisplayedText += text.charAt(i);
                        i++;
                    } else {
                        clearInterval(this.vnTypeTimer);
                        this.vnIsTyping = false;
                    }
                }, 1);
            },
            // [新增] 获取立绘的动态样式 (缩放与位移)
            getAvatarStyleObj(id, tag = null) {
                const style = {
                    transformOrigin: 'bottom center', // 关键：从底部中心缩放，符合立绘逻辑
                    transition: 'all 0.3s ease-out'
                };

                if (!id || id === 'global') return style;
                const p = this.players.find(x => x.id === id);
                if (!p) return style;

                let scale = 1.0;
                let offsetY = 0.0;

                // 1. 尝试查找 Tag 对应的差分配置
                if (tag && p.avatars && p.avatars.length > 0) {
                    const variant = p.avatars.find(a => a.tag.toLowerCase() === tag.toLowerCase());
                    if (variant) {
                        // 只有当 variant 真的有 url 时才应用它的配置，否则 fallback 到默认
                        // 但这里假设只要 tag 匹配就用它的配置
                        scale = variant.scale !== undefined ? variant.scale : 1.0;
                        offsetY = variant.offsetY !== undefined ? variant.offsetY : 0.0;
                        
                        style.transform = `scale(${scale}) translateY(${offsetY}%)`;
                        return style;
                    }
                }

                // 2. 使用默认配置
                scale = p.avatarScale !== undefined ? p.avatarScale : 1.0;
                offsetY = p.avatarOffsetY !== undefined ? p.avatarOffsetY : 0.0;

                style.transform = `scale(${scale}) translateY(${offsetY}%)`;
                return style;
            },
            // [修改] 支持传入 tag 获取特定差分立绘
            getFactionAvatar(id, tag = null) {
                if (!id || id === 'global') return null;
                const p = this.players.find(x => x.id === id);
                if (!p) return null;
                
                // 1. 优先尝试匹配 Tag (如果 Tag 存在)
                if (tag && p.avatars && p.avatars.length > 0) {
                    // 不区分大小写查找
                    const variant = p.avatars.find(a => a.tag.toLowerCase() === tag.toLowerCase());
                    if (variant && this.isImage(variant.url)) return variant.url;
                }

                // 2. 默认立绘 fallback
                if (p.avatar && this.isImage(p.avatar)) return p.avatar;
                
                // 3. 如果没有 avatar，但 logo 是图片，勉强用 logo 代替
                if (p.logo && this.isImage(p.logo)) return p.logo;
                
                return null;
            },
            getMapBackground() {
                // 1. 优先查找新版图层系统中的可见 Image 层
                if (this.map_data.layers && this.map_data.layers.length > 0) {
                    // 找第一个可见的、类型为 image 的图层
                    const imgLayer = this.map_data.layers.find(l => l.type === 'image' && l.visible);
                    if (imgLayer && imgLayer.data) return imgLayer.data;
                }
                
                // 2. 兼容旧版数据结构
                if (this.map_data.image) return this.map_data.image;

                // 3. 都没有，返回 null (前端会处理显示默认 logo 或黑色)
                return null;
            },
            // ★★★ [新增] 统一的启动页点击处理器 ★★★
            handleSplashClick() {
                if (!this.hasInteracted) {
                    // 第一次点击：只执行初始化（出Logo，播音乐）
                    this.initInteraction();
                } else {
                    // 第二次点击：只有在 Logo 出来后，点击才进入 App
                    this.enterApp();
                }
            },
            // ★★★ 彩蛋逻辑 ★★★
            handleLogoClick() {
                this.logoClickCount++;
                if (this.logoClickCount >= 5) {
                    this.showEasterEgg = true;
                    this.logoClickCount = 0;
                    window.addEventListener('keydown', this.closeEasterEgg);
                }
            },
            
            // [修改] 关闭逻辑
            closeEasterEgg() {
                if (this.showEasterEgg) {
                    // 这里直接关闭，配合 CSS 的 transition 可能会有点硬，但因为是 v-if，直接消失也行。
                    // 如果你想做淡出动画，需要更复杂的逻辑，这里为了代码简洁直接关闭即可。
                    this.showEasterEgg = false;
                    window.removeEventListener('keydown', this.closeEasterEgg);
                }
            },

            initInteraction() {
                if (this.hasInteracted) return;
                this.hasInteracted = true; // 状态变更
                
                // 播放音乐逻辑 (保持不变)
                const audio = this.$refs.splashBgm;
                if (audio) {
                    audio.volume = 0;
                    audio.play().then(() => {
                        let vol = 0;
                        const fadeTw = setInterval(() => {
                            if (!this.showSplash) { clearInterval(fadeTw); return; }
                            if (vol < 0.95) {
                                vol += 0.05;
                                audio.volume = vol;
                            } else {
                                audio.volume = 1;
                                clearInterval(fadeTw);
                            }
                        }, 100);
                    }).catch(e => console.warn("Audio play failed:", e));
                }

                // 移除只用一次的键盘监听 (点击监听由 v-on:click 托管，不需要手动移除)
                document.removeEventListener('keydown', this.initKeyHandler);
            },

            // 专门处理键盘按下
            initKeyHandler(e) {
                this.initInteraction();
            },

// [修改] 启动黑客帝国数据流特效 (流星雨版)
            initMatrixEffect() {
                const canvas = this.$refs.matrixCanvas;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');

                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                const chars = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブヅプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                const charArray = chars.split('');

                // ★★★ 彩蛋流星群 ★★★
                const easterEggs = ['LEVANT', 'EASTERN','DONGFANG'];
                const activeSpecialCols = {}; 

                const fontSize = 14;
                const columns = Math.floor(canvas.width / fontSize); 
                
                const drops = [];
                for (let x = 0; x < columns; x++) {
                    drops[x] = Math.random() * -100; 
                }

                const draw = () => {
                    // 拖尾层稍微变淡一点 (0.05 -> 0.08)，让流星划过后的黑色背景恢复得稍微快一点，突出高亮
                    ctx.fillStyle = 'rgba(2, 6, 23, 0.08)'; 
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    ctx.font = fontSize + 'px monospace';

                    for (let i = 0; i < drops.length; i++) {
                        let text = '';

                        // --- A. 正在输出高亮词汇 (流星本体) ---
                        if (activeSpecialCols[i]) {
                            const state = activeSpecialCols[i];
                            text = state.word[state.charIndex];
                            
                            // ★★★ 流星样式 ★★★
                            ctx.fillStyle = '#FFFFFF';   // 纯白核心
                            ctx.shadowColor = '#FFFFFF'; // 白色光晕
                            ctx.shadowBlur = 15;         // 光晕增强，像星星一样闪烁
                            ctx.font = 'bold ' + (fontSize + 3) + 'px monospace'; // 字号加大，更显眼

                            state.charIndex++;
                            if (state.charIndex >= state.word.length) {
                                delete activeSpecialCols[i];
                            }
                        } 
                        // --- B. 普通背景流 ---
                        else {
                            // ★★★ 概率调整 ★★★
                            // 0.999 (0.1%) -> 0.96 (4%)
                            // 意味着每列每帧有4%的概率变成流星，屏幕上会非常热闹
                            // 同时限制生成高度在屏幕上半部分，保证词汇能完整落下
                            if (Math.random() > 0.99 && drops[i] * fontSize < canvas.height * 0.7) {
                                const word = easterEggs[Math.floor(Math.random() * easterEggs.length)];
                                activeSpecialCols[i] = { word: word, charIndex: 1 };
                                text = word[0]; 
                                
                                // 流星头部的样式
                                ctx.fillStyle = '#FFFFFF';
                                ctx.shadowColor = '#FFFFFF';
                                ctx.shadowBlur = 15;
                                ctx.font = 'bold ' + (fontSize + 3) + 'px monospace';
                            } else {
                                // 普通乱码
                                text = charArray[Math.floor(Math.random() * charArray.length)];
                                
                                // 背景字稍微暗一点，衬托流星
                                const isCyan = Math.random() > 0.5;
                                ctx.fillStyle = isCyan ? 'rgba(34, 211, 238, 0.5)' : 'rgba(232, 121, 249, 0.5)'; 
                                ctx.shadowBlur = 0; 
                                ctx.font = fontSize + 'px monospace';
                            }
                        }

                        ctx.fillText(text, i * fontSize, drops[i] * fontSize);

                        if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                            drops[i] = 0;
                            if (activeSpecialCols[i]) delete activeSpecialCols[i]; 
                        }

                        drops[i]++;
                    }
                };

                this.matrixInterval = setInterval(draw, 33);
                
                window.addEventListener('resize', () => {
                     if(!this.showSplash) return;
                     canvas.width = window.innerWidth;
                     canvas.height = window.innerHeight;
                });
            },

            async playRandomMusic(autoPlay = false) {
                try {
                    const data = await window.LevantAPI.getMusicList();
                    const files = data.files;

                    if (files && files.length > 0) {
                        // 防重逻辑
                        const lastPlayed = localStorage.getItem('last_bgm_file');
                        let pool = files;
                        if (files.length > 1 && lastPlayed) {
                            pool = files.filter(f => f !== lastPlayed);
                        }

                        const randomFile = pool[Math.floor(Math.random() * pool.length)];
                        localStorage.setItem('last_bgm_file', randomFile);
                        
                        const finalUrl = `sounds/${encodeURIComponent(randomFile)}?v=${Date.now()}`;
                        this.currentBgmName = randomFile.replace(/\.(mp3|wav|ogg|flac)$/i, '');
                        
                        const audio = this.$refs.splashBgm;
                        if (audio) {
                            audio.src = finalUrl;
                            audio.load();
                            if (autoPlay) {
                                audio.volume = 0.4; // 默认音量
                                audio.play().catch(e => console.warn("Auto play blocked:", e));
                                this.isBgmPlaying = true;
                            }
                        }
                    } else {
                        this.currentBgmName = "NO AUDIO FILES";
                    }
                } catch (e) {
                    console.warn("[System] Failed to load music:", e);
                    this.currentBgmName = "AUDIO OFFLINE";
                }
            },

            // ★★★ [新增] 主界面音乐开关 ★★★
            toggleMainBgm() {
                const audio = this.$refs.splashBgm;
                if (!audio) return;

                if (this.isBgmPlaying) {
                    // 关闭
                    audio.pause();
                    this.isBgmPlaying = false;
                } else {
                    // 开启
                    audio.volume = 0.4; // 恢复音量
                    audio.play().then(() => {
                        this.isBgmPlaying = true;
                    }).catch(e => {
                        console.error("Play failed:", e);
                        // 如果因为资源过期等原因播放失败，尝试重新加载一首
                        this.playRandomMusic(true);
                    });
                }
            },

            // ★★★ [新增] 切歌 ★★★
            changeBgm() {
                this.playRandomMusic(true);
            },

            // 2. [修改] 进入应用时，停止动画以节省性能
            enterApp() {
                // 1. 界面飞出
                this.showSplash = false; 

                if (this.matrixInterval) {
                    clearInterval(this.matrixInterval);
                    this.matrixInterval = null;
                }

                // 2. 音频淡出 (进入主界面后默认是关闭音乐的)
                const audio = this.$refs.splashBgm;
                if (audio && !audio.paused) {
                    // 标记状态为关闭
                    this.isBgmPlaying = false;
                    
                    const fadeOut = setInterval(() => {
                        if (audio.volume > 0.05) {
                            audio.volume -= 0.05;
                        } else {
                            audio.volume = 0;
                            audio.pause();
                            // 注意：这里不要重置 currentTime，也不要清空 src，方便用户点击按钮时直接继续播放或切歌
                            clearInterval(fadeOut);
                        }
                    }, 50); 
                }
            },
            // [新增] 添加选项到右侧编辑器
            addOptionToEditor() {
                if (!this.editor.options) this.editor.options = [];
                this.editor.options.push({ 
                    label: this.t('opt_new'), 
                    desc: this.t('opt_desc_ph') 
                });
            },

            // [新增] 添加选项到时间轴事件
            addOptionToEvent(event) {
                if (!event.options) event.options = [];
                // 确保是对象结构
                event.options.push({ 
                    label: this.t('dec_new'), 
                    desc: this.t('dec_desc_ph') 
                });
            },

            // --- 新增工具方法 ---
            createImpactObject(form) {
                const type = form.type || 'STAT_CHANGE';
                let newImpact = { type };

                if (type === 'STAT_CHANGE') {
                    if (!form.targetId || !form.attrKey || form.newValue === '') return null;
                    
                    // 全局变量处理
                    if (form.targetId === 'global') {
                        Object.assign(newImpact, {
                            targetId: 'global',
                            targetName: 'Global',
                            attrKey: form.attrKey,
                            attrLabel: form.attrKey,
                            oldValue: this.getAttrValueDisplay('global', form.attrKey),
                            newValue: form.newValue
                        });
                    } else {
                        // 实体处理
                        const t = this.players.find(p => p.id === form.targetId);
                        if (!t) return null;
                        
                        // ★ 修复：不再依赖 this.stat_schema，而是通过 getSchemaLabel 全局查找
                        const label = this.getSchemaLabel(form.attrKey, t.schemaId);
                        
                        Object.assign(newImpact, {
                            targetId: t.id,
                            targetName: t.name,
                            attrKey: form.attrKey,
                            attrLabel: label,
                            oldValue: t.stats[form.attrKey] || '-',
                            newValue: form.newValue
                        });
                    }
                } 
                else if (type === 'REGION_TRANSFER') {
                    if (!form.targetName || !form.newValue) return null;
                    Object.assign(newImpact, { targetName: form.targetName, newValue: form.newValue });
                }
                else if (type === 'ENTITY_CREATE') {
                    if (!form.newValue.trim()) return null;
                    Object.assign(newImpact, { data: { name: form.newValue.trim() } });
                }
                else if (type === 'ENTITY_REMOVE') {
                    if (!form.targetId) return null;
                    Object.assign(newImpact, { targetId: form.targetId });
                }
                else if (type === 'PIN_MOVE') {
                    if (!form.targetId || !form.newValue) return null;
                    const pin = this.map_data.pins.find(p => p.id === form.targetId);
                    const oldCoords = pin ? `${pin.x.toFixed(1)},${pin.y.toFixed(1)}` : '?,?';
                    Object.assign(newImpact, {
                        targetId: form.targetId,
                        targetName: pin ? (pin.label || this.getPinName(pin.linkId)) : 'Unknown Pin',
                        oldValue: oldCoords,
                        newValue: form.newValue
                    });
                }
                return newImpact;
            },
// --- [新增] 智能截图系统 ---
            
            toggleScreenshotMode() {
                this.isScreenshotMode = !this.isScreenshotMode;
                if (!this.isScreenshotMode) {
                    this.screenshotRect = { x:0, y:0, w:0, h:0 };
                    this.screenshotTarget = null;
                }
            },

            exitScreenshotMode() {
                this.isScreenshotMode = false;
            },

            // 核心逻辑：智能查找“值得截图”的父级容器
            handleScreenshotHover(e) {
                const elements = document.elementsFromPoint(e.clientX, e.clientY);
                
                // 1. 找到第一个不是“截图辅助层”的元素
                const el = elements.find(node => 
                    node.nodeType === 1 && 
                    !node.classList.contains('screenshot-backdrop') &&
                    !node.classList.contains('screenshot-overlay') &&
                    !node.classList.contains('screenshot-label')
                );

                if (!el) return;

                // 2. [关键修改] 特殊处理地图区域
                // 如果鼠标下的元素属于地图视口（或者是视口本身），直接强制锁定为视口容器
                // 这样无论地图放大多少倍，我们只截取“窗口”看到的部分
                const mapViewport = el.closest('.map-viewport');
                if (mapViewport) {
                    this.screenshotTarget = mapViewport;
                    this.screenshotTargetName = "Tactical_Map_View";
                    
                    const rect = mapViewport.getBoundingClientRect();
                    this.screenshotRect = {
                        x: rect.left,
                        y: rect.top,
                        w: rect.width,
                        h: rect.height
                    };
                    return; // 地图处理完毕，直接返回
                }

                // 3. 常规组件吸附逻辑 (处理非地图区域)
                const targetSelectors = [
                    '.info-card',          // 实体卡片
                    '.impact-badge',       // 状态胶囊
                    '.glass-panel',        // 弹窗
                    'aside',               // 侧边栏
                    'header',              // 顶栏
                    'section[role="main"]',// 中间主视图 (如果没选中地图视口，可能会选中这个)
                    '.poster-terminal',    
                    '.poster-newspaper'
                ];

                let target = el.closest(targetSelectors.join(','));

                // 兜底逻辑
                if (!target) {
                    // 排除大背景，防止误触
                    if (el.id === 'app' || el.tagName === 'BODY' || el.tagName === 'HTML' || el.classList.contains('app-texture')) {
                        this.screenshotRect = { x:0, y:0, w:0, h:0 };
                        this.screenshotTarget = null;
                        return;
                    }
                    target = el; 
                }

                this.screenshotTarget = target;
                
                // 获取显示名称
                let name = target.className;
                if (typeof name === 'string') name = name.split(' ')[0];
                else name = target.tagName.toLowerCase();
                
                if (target.getAttribute('aria-label')) name = target.getAttribute('aria-label');
                this.screenshotTargetName = name || 'Element';

                // 计算位置
                const rect = target.getBoundingClientRect();
                this.screenshotRect = {
                    x: rect.left,
                    y: rect.top,
                    w: rect.width,
                    h: rect.height
                };
            },

            async captureScreenshot() {
                if (!this.screenshotTarget) {
                    alert("错误：未选中任何区域。");
                    return;
                }

                const rect = { ...this.screenshotRect };
                const fileNameLabel = this.screenshotTargetName || "Capture";

                // 1. 暂时隐藏截图框
                this.isScreenshotMode = false;
                await this.$nextTick();

                try {
                    // 获取 DPR (Retina屏幕支持)
                    const dpr = window.devicePixelRatio || 1;
                    
                    // 计算屏幕物理分辨率
                    const screenW = window.screen.width * dpr;
                    const screenH = window.screen.height * dpr;

                    // 2. 唤起屏幕共享 (参数调优版)
                    const stream = await navigator.mediaDevices.getDisplayMedia({
                        video: {
                            displaySurface: "browser",
                            // 【优化】去掉鼠标光标 (需选择"当前标签页")
                            cursor: "never", 
                            
                            // 【优化】请求最大物理分辨率
                            width: { ideal: screenW, max: 8192 }, 
                            height: { ideal: screenH, max: 8192 },
                            
                            // 【优化】强制低帧率，告诉编码器我们要的是画质而不是流畅度
                            frameRate: { ideal: 1, max: 15 }, 
                            
                            resizeMode: "none"
                        },
                        audio: false,
                        preferCurrentTab: true
                    });

                    // 3. 视频预热
                    const video = document.createElement("video");
                    video.style.position = "fixed";
                    video.style.top = "-9999px";
                    video.style.left = "-9999px";
                    // 确保 video 元素本身也是物理像素大小，防止浏览器内部缩放
                    video.style.width = window.innerWidth + "px";
                    video.style.height = window.innerHeight + "px";
                    document.body.appendChild(video);

                    video.srcObject = stream;
                    await video.play();

                    // 【强制等待】等待画面变清晰 (视频流刚开始几帧通常很糊，主要是关键帧未到)
                    await new Promise(resolve => setTimeout(resolve, 800));

                    // 4. 计算精准坐标 (消除亚像素模糊)
                    // 视频实际分辨率
                    const videoW = video.videoWidth;
                    // CSS 视口分辨率
                    const viewportW = window.innerWidth;
                    // 真实的缩放因子
                    const scaleFactor = videoW / viewportW;

                    // 【关键优化】所有坐标强制取整 (Math.round)，避免半像素渲染导致的模糊
                    const sX = Math.round(rect.x * scaleFactor);
                    const sY = Math.round(rect.y * scaleFactor);
                    const sW = Math.round(rect.w * scaleFactor);
                    const sH = Math.round(rect.h * scaleFactor);

                    // 5. 绘图
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");

                    canvas.width = sW;
                    canvas.height = sH;

                    // 关闭平滑 (在 1:1 像素映射时，关闭平滑反而更锐利)
                    ctx.imageSmoothingEnabled = false;

                    // 【可选黑科技】应用 SVG 锐化滤镜补偿视频压缩模糊
                    // 如果觉得画面太“硬”，可以注释掉下面这行
                    ctx.filter = 'contrast(1.05) saturate(1.05)'; 

                    ctx.drawImage(
                        video,
                        sX, sY, sW, sH,  // 源坐标 (物理像素)
                        0, 0, canvas.width, canvas.height // 目标坐标
                    );

                    // 6. 清理
                    stream.getTracks().forEach(track => track.stop());
                    document.body.removeChild(video);

                    // 7. 下载
                    const link = document.createElement('a');
                    link.download = `Crystal_Snap_${fileNameLabel}_${Date.now()}.png`;
                    link.href = canvas.toDataURL("image/png");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                } catch (e) {
                    console.error(e);
                    if (e.name !== 'NotAllowedError') {
                        alert("截图异常: " + e.message);
                    }
                } finally {
                    document.body.style.cursor = 'default';
                    this.isScreenshotMode = true;
                }
            },
            // [新增] 切换地图标记显示模式
            cycleMapDisplayMode() {
                // 在数组中增加了 'flag' 模式
                const modes = ['full', 'icon', 'dot', 'flag'];
                const idx = modes.indexOf(this.mapView.displayMode);
                this.mapView.displayMode = modes[(idx + 1) % modes.length];
            },

            // [新增] 统一获取坐标 (兼容 Mouse 和 Touch)
            getClientPos(e) {
                if (e.touches && e.touches.length > 0) {
                    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
                return { x: e.clientX, y: e.clientY };
            },
            // [新增] 辅助 Impact 表单：根据选中的目标ID，返回其可用的属性字段列表
            getFieldsForImpactTarget(targetId) {
                if (!targetId || targetId === 'global') return []; // Global 单独处理
                const p = this.players.find(x => x.id === targetId);
                if (!p) return [];
                return this.getFieldsBySchemaId(p.schemaId);
            },
            getImpactColor(imp) {
            const type = imp.type || 'STAT_CHANGE';
            switch(type) {
                case 'STAT_CHANGE': return this.getFactionColor(imp.targetId);
                case 'REGION_TRANSFER': return '#6366f1'; // Indigo
                case 'ENTITY_CREATE': return '#10b981';   // Emerald
                case 'ENTITY_REMOVE': return '#ef4444';   // Red
                default: return '#64748b';
            }
        },
            getAttrValueDisplay(tid, key) {
                if (!tid || !key) return '---';
                if (tid === 'global') {
                    const g = this.global_vars.find(x => x.key === key);
                    return g ? g.value : '???';
                } else {
                    const p = this.players.find(x => x.id === tid);
                    return p ? (p.stats[key] || 'N/A') : '???';
                }
            },

            getFinalPinIcon(pin) {
                // 1. 如果 Pin 本身有自定义图标，优先使用
                if (pin.icon) return pin.icon;
                
                // 2. 如果没有自定义，且关联了实体，使用实体的 Logo
                if (pin.type === 'entity' || (!pin.type && pin.linkId)) {
                    const p = this.players.find(x => x.id === pin.linkId);
                    if (p && p.logo) return p.logo;
                }
                
                // 3. 默认图标 (区分资料点和普通点)
                if (pin.type === 'lore') return 'fa-solid fa-book-bookmark';
                return 'fa-solid fa-map-pin';
            },

            getFinalPinColor(pin) {
                // 1. 优先使用 Pin 自定义颜色
                if (pin.color) return pin.color;
                
                // 2. 使用实体颜色
                if (pin.type === 'entity' || (!pin.type && pin.linkId)) {
                    const p = this.players.find(x => x.id === pin.linkId);
                    if (p && p.color) return p.color;
                }
                
                // 3. 默认颜色
                if (pin.type === 'lore') return '#10b981'; // Emerald
                return '#f59e0b'; // Amber
            },


            // 1. 上传图片 (上传后自动重置视图，并初始化 Canvas)
            handleMapUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    // 查找当前激活的 Image 层，如果没有，创建一个新的
                    let targetLayer = this.getActiveLayer();
                    if (!targetLayer || targetLayer.type !== 'image') {
                        targetLayer = this.map_data.layers.find(l => l.type === 'image');
                    }
                    
                    if (!targetLayer) {
                        this.addLayer('image');
                        targetLayer = this.map_data.layers[this.map_data.layers.length - 1]; // addLayer 是 push
                    } else if (targetLayer.type !== 'image') {
                         this.addLayer('image');
                         targetLayer = this.map_data.layers[this.map_data.layers.length - 1]; 
                    }

                    // 更新图层数据
                    targetLayer.data = e.target.result;
                    targetLayer.name = file.name || "Map Layer";
                    
                    // 切换到该图层
                    this.map_data.activeLayerId = targetLayer.id;
                    
                    this.resetMapView();
                    this.saveGame('autosave.json');
                    
                    // [修复] 重新扫描底图并更新分析画布
                    this.$nextTick(() => this.initMapCanvas());
                };
                reader.readAsDataURL(file);
            },
            
            // [新增] Canvas 初始化辅助函数
            initMapCanvas() {
                const canvas = document.getElementById('map-analysis-canvas');
                if(!canvas) return;
                
                // 1. 寻找用于分析的底图
                // 优先找名为 "Base Map" 的，或者第一个 type 为 image 的可见图层
                let baseLayer = this.map_data.layers.find(l => l.type === 'image' && l.visible);
                
                if (!baseLayer || !baseLayer.data) {
                    console.warn("No visible base map layer found for analysis.");
                    return; 
                }

                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                // 关键：允许跨域，虽然一般是 base64
                img.crossOrigin = "Anonymous"; 
                
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    console.log("Analysis Canvas updated with layer:", baseLayer.name);
                };
                
                img.src = baseLayer.data;
            },

            // 2. 重置视图 (Fit Width)
            resetMapView() {
                this.mapView = { scale: 1, x: 0, y: 0, isDragging: false, startX: 0, startY: 0, badgeScale: 1.0, displayMode: 'full' };
            },

            // 3. 鼠标滚轮 (缩放)
            onMapWheel(e) {
                // [修复] 只要有图层或者是处于地图模式，就允许缩放，不再检查 map_data.image
                if (!this.showMap && this.map_data.layers.length === 0) return;
                
                const zoomIntensity = 0.1;
                const direction = e.deltaY > 0 ? -1 : 1;
                let newScale = this.mapView.scale + (direction * zoomIntensity);

                // 限制缩放范围 (0.1x ~ 10x)
                newScale = Math.min(Math.max(0.1, newScale), 10);
                
                this.mapView.scale = newScale;
            },
            // [升级] 导出地图配置 (包含依赖的规则集)
            exportMapConfig() {
                // [修复] 检查图层数量而不是 image
                if (!this.map_data.layers || this.map_data.layers.length === 0) return alert("No map layers to export.");
                
                // 1. 扫描地图中用到的规则集 ID
                const usedSchemaIds = new Set();
                
                // 遍历所有图层寻找引用
                this.map_data.layers.forEach(layer => {
                    if (layer.type === 'region' && Array.isArray(layer.data)) {
                        layer.data.forEach(reg => {
                            if (reg.schemaId) usedSchemaIds.add(reg.schemaId);
                        });
                    }
                });

                // 2. 提取对应的规则集对象
                const dependencies = this.rule_sets.filter(rs => usedSchemaIds.has(rs.id));

                // 3. 构造完整的数据包 (Package)
                const exportPackage = {
                    meta: {
                        version: this.APP_VERSION,
                        type: 'Levant_Map_Package',
                        exportedAt: Date.now()
                    },
                    map_data: this.map_data,
                    // ★★★ 关键：携带规则集 ★★★
                    embedded_rules: dependencies
                };
                
                // 4. 执行导出
                const dataStr = JSON.stringify(exportPackage, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `MapPackage_${Date.now()}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
            },

// [终极版] 导入地图配置 (支持 V1/V2 格式兼容 + 规则集解包 + 属性字段自动补全)
            handleMapConfigImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const jsonRaw = JSON.parse(e.target.result);
                        
                        // --- 1. 格式识别与解包 ---
                        let newMapData = null;
                        let newRules = [];
                        let isPackage = false;

                        // Case A: 新版地图包 (包含规则集)
                        if (jsonRaw.type === 'Levant_Map_Package' && jsonRaw.map_data) {
                            newMapData = jsonRaw.map_data;
                            newRules = jsonRaw.embedded_rules || [];
                            isPackage = true;
                        } 
                        // Case B: 普通地图文件 (V1 或 V1.5)
                        else {
                            newMapData = jsonRaw;
                        }

                        // --- 2. 有效性预检查 ---
                        const hasNewStructure = newMapData.layers && Array.isArray(newMapData.layers);
                        const hasOldStructure = newMapData.image || (newMapData.regions && Array.isArray(newMapData.regions)) || (newMapData.pins && Array.isArray(newMapData.pins));

                        if (!hasNewStructure && !hasOldStructure) {
                            throw new Error("无法识别的地图文件格式 (缺少 layers 或 image 数据)。");
                        }

                        // --- 3. 用户确认 ---
                        const confirmMsg = isPackage 
                            ? "检测到完整地图包。\n导入将覆盖当前地图，并合并附带的属性规则集。\n确定继续？" 
                            : "导入地图将覆盖当前地图数据。\n确定继续？";

                        if (confirm(confirmMsg)) {
                            
                            // --- 4. 规则集 (Rule Sets) 智能合并 ---
                            let rulesAddedCount = 0;
                            if (newRules.length > 0) {
                                if (!this.rule_sets) this.rule_sets = [];
                                newRules.forEach(rule => {
                                    const exists = this.rule_sets.some(r => r.id === rule.id);
                                    if (!exists) {
                                        this.rule_sets.push(rule);
                                        rulesAddedCount++;
                                    } else {
                                        console.log(`[Import] Rule Set '${rule.name}' (${rule.id}) already exists. Skipping.`);
                                    }
                                });
                            }

                            // --- 5. 地图数据覆盖 ---
                            this.map_data = { layers: [], activeLayerId: '', image: '', pins: [], regions: [] };
                            const importedMap = JSON.parse(JSON.stringify(newMapData));

                            // --- 6. 数据结构迁移 (Migration V1 -> V2) ---
                            // ★★★ 核心修改：在迁移时注入 stats 和 schemaId ★★★
                            if (!importedMap.layers || importedMap.layers.length === 0) {
                                console.info("[Import] Detected Legacy Map V1. Migrating to Layer System...");
                                const migratedLayers = [];
                                const timestamp = Date.now();

                                if (importedMap.image) {
                                    migratedLayers.push({
                                        id: 'layer_bg_' + timestamp, type: 'image', name: 'Base Map (Imported)',
                                        visible: true, opacity: 1.0, data: importedMap.image
                                    });
                                }

                                if (importedMap.regions && importedMap.regions.length > 0) {
                                    // ★ 数据清洗：强制补全属性字段
                                    const cleanRegions = importedMap.regions.map(r => ({
                                        ...r,
                                        schemaId: r.schemaId || '',
                                        stats: r.stats || {}
                                    }));
                                    
                                    migratedLayers.push({
                                        id: 'layer_reg_' + timestamp, type: 'region', name: 'Territories (Imported)',
                                        visible: true, opacity: 1.0, data: cleanRegions
                                    });
                                }

                                if (importedMap.pins && importedMap.pins.length > 0) {
                                    migratedLayers.push({
                                        id: 'layer_pin_' + timestamp, type: 'marker', name: 'Markers (Imported)',
                                        visible: true, opacity: 1.0, data: importedMap.pins
                                    });
                                }
                                this.map_data.layers = migratedLayers;
                            } else {
                                // --- 7. 新版格式清洗 (Sanitization) ---
                                // 即使是新版格式，也要防止 stats 字段丢失
                                importedMap.layers.forEach(layer => {
                                    if (layer.type === 'region' && Array.isArray(layer.data)) {
                                        layer.data = layer.data.map(r => ({
                                            ...r,
                                            schemaId: r.schemaId || '',
                                            stats: r.stats || {}
                                        }));
                                    }
                                });
                                this.map_data.layers = importedMap.layers;
                            }

                            // --- 8. 状态修正 ---
                            if (this.map_data.layers.length > 0) {
                                const isValidActive = importedMap.activeLayerId && this.map_data.layers.some(l => l.id === importedMap.activeLayerId);
                                this.map_data.activeLayerId = isValidActive ? importedMap.activeLayerId : this.map_data.layers[0].id;
                            } else {
                                this.map_data.activeLayerId = '';
                            }

                            // --- 9. 收尾工作 ---
                            this.resetMapView();
                            this.saveGame('autosave.json'); // ★ 此时保存，旧地图数据已被自动更新为新结构
                            
                            this.$nextTick(() => { this.initMapCanvas(); });
                            
                            let msg = "地图导入成功！";
                            if (rulesAddedCount > 0) msg += `\n已载入 ${rulesAddedCount} 个配套属性规则。`;
                            alert(msg);
                        }
                    } catch (err) {
                        console.error("[Import Error]", err);
                        alert("地图导入失败: " + err.message);
                    }
                    event.target.value = '';
                };
                reader.readAsText(file);
            },
            // [新增] 导出为 PNG 图片
            async exportMapImage() {
                // [修复] 检查图层数量而不是 image
                if (!this.map_data.layers || this.map_data.layers.length === 0) return alert("No map layers loaded.");

                // 1. 获取地图的核心变换层
                const element = document.getElementById('map-capture-target');
                if (!element) {
                    alert("Error: Map element not found (ID: map-capture-target missing).");
                    return;
                }

                // 2. 保存当前视图状态
                const oldView = { ...this.mapView };
                const oldCursor = document.body.style.cursor;

                // 3. 提示用户并在后台调整视图
                document.body.style.cursor = 'wait';
                
                // 重置视图以截取全图
                this.mapView = { scale: 1, x: 0, y: 0, isDragging: false, badgeScale: oldView.badgeScale, displayMode: oldView.displayMode };
                
                await this.$nextTick();
                await new Promise(resolve => setTimeout(resolve, 300));

                try {
                    // 4. 执行截图
                    const canvas = await html2canvas(element, {
                        backgroundColor: null, // 透明背景
                        scale: 2,              // 2倍采样
                        useCORS: true,         
                        logging: false,
                        ignoreElements: (el) => el.classList.contains('pointer-events-none') && el.tagName === 'DIV' && el.innerHTML === '' 
                    });

                    // 5. 触发下载
                    const link = document.createElement('a');
                    link.download = `Tactical_Map_${Date.now()}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    
                } catch (e) {
                    console.error(e);
                    alert("Image export failed: " + e.message);
                } finally {
                    // 6. 恢复视图
                    this.mapView = oldView;
                    document.body.style.cursor = oldCursor;
                }
            },
            // 4. 按下/触摸开始
            onMapMouseDown(e) {
                if (e.type === 'mousedown' && e.button !== 0) return;

                // ★ 仅标记鼠标已按下，暂不开启拖拽优化
                this.mapView.isMouseDown = true;
                this.mapView.isDragging = false; 
                
                const pos = this.getClientPos(e);

                // 记录初始点击位置 (用于计算位移)
                this.dragOrigin = { x: pos.x, y: pos.y };
                
                // 记录地图当前的偏移基准
                this.mapView.startX = pos.x - this.mapView.x;
                this.mapView.startY = pos.y - this.mapView.y;
                
                // 注意：这里先不要改 cursor 为 grabbing，等真的动了再改
            },
            // 5. 移动/拖拽中
            onMapMouseMove(e) {
                // 如果没按下，直接退出
                if (!this.mapView.isMouseDown) return;
                
                const pos = this.getClientPos(e);

                // ★ 如果尚未进入拖拽模式，计算移动距离
                if (!this.mapView.isDragging) {
                    const dist = Math.sqrt(
                        Math.pow(pos.x - this.dragOrigin.x, 2) + 
                        Math.pow(pos.y - this.dragOrigin.y, 2)
                    );
                    
                    // ★ 只有移动超过 5px 才视为拖拽，激活性能优化
                    if (dist > 5) {
                        this.mapView.isDragging = true;
                        document.body.style.cursor = 'grabbing';
                    } else {
                        // 移动太小，视为手抖，不更新地图位置
                        return;
                    }
                }

                // 只要 isDragging 为 true，就执行位移并阻止默认行为
                if (this.mapView.isDragging) {
                    if(e.cancelable) e.preventDefault(); 
                    this.mapView.x = pos.x - this.mapView.startX;
                    this.mapView.y = pos.y - this.mapView.startY;
                }
            },

            // 6. 抬起/触摸结束
            onMapMouseUp(e) {
                // 只要鼠标松开，就重置所有状态
                this.mapView.isMouseDown = false;
                
                // 如果之前处于拖拽状态，说明是拖拽结束
                if (this.mapView.isDragging) {
                    this.mapView.isDragging = false;
                    document.body.style.cursor = 'default';
                    // 拖拽结束不需要触发 handleAddPinClick，因为那是点击背景添加点的逻辑
                    return; 
                }

                // ★ 如果 isDragging 为 false，说明移动距离极小 (<5px)
                // 此时 CSS 的 pointer-events: none 没有生效，
                // 如果用户点击的是地块 (Region)，地块自身的 @click.stop 会正常触发。
                // 如果用户点击的是背景，下面的逻辑会触发背景点击（添加点）。

                let endX, endY;
                if (e.changedTouches && e.changedTouches.length > 0) {
                    endX = e.changedTouches[0].clientX;
                    endY = e.changedTouches[0].clientY;
                } else {
                    endX = e.clientX;
                    endY = e.clientY;
                }
                
                // 调用背景点击逻辑 (handleAddPinClick 内部会判断是否点击了空白处)
                const mockEvent = {
                    currentTarget: e.currentTarget,
                    clientX: endX,
                    clientY: endY,
                    target: e.target
                };
                
                // 只有当点击的是背景容器本身时才触发添加点
                // (注意：Region 的 click 有 .stop 修饰符，所以这里通常处理的是穿透的点击)
                this.handleAddPinClick(mockEvent);
            },

            // 7. 处理添加点的逻辑 (也就是之前的 onMapBackgroundClick)
            // 注意：这里需要根据当前的 scale 和 translate 反推回 % 坐标
// 7. 处理点击逻辑：根据模式分流 (添加点 OR 添加区域)
            handleAddPinClick(e) {
                if (this.mapToolMode === 'view') return;

                const transformLayer = e.currentTarget.querySelector('.origin-top-left');
                if (!transformLayer) return;

                const rect = transformLayer.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;

                // 计算百分比
                const xPct = (clickX / rect.width) * 100;
                const yPct = (clickY / rect.height) * 100;
                if (xPct < 0 || xPct > 100 || yPct < 0 || yPct > 100) return;

                if (this.mapToolMode === 'pin') {
                    // --- 原有点模式 ---
                    this.editingPinIndex = -1;
                    this.editingRegionIndex = -2; // 确保不冲突
                    this.pinForm = {
                        x: xPct, y: yPct,
                        mode: 'entity', selectedId: '', customLabel: '', 
                        icon: 'fa-solid fa-map-pin', color: '#ffffff'
                    };
                    this.showPinModal = true;
                } else if (this.mapToolMode === 'region') {
                    // ★★★ [优化] 视觉精准判定 (Pixel Perfect Detection) ★★★
                    // 抛弃方形包围盒计算，直接询问浏览器：鼠标当前悬停在哪个元素上？
                    // 配合 HTML 中的 pointer-events 设置，这会自动忽略透明区域，只命中实际形状。
                    
                    const elements = document.elementsFromPoint(e.clientX, e.clientY);
                    
                    // 在光标下的所有元素中，寻找属于“当前激活图层”的地块
                    const hitEl = elements.find(el => {
                        // 向上查找包含 data-rid 的容器
                        const target = el.closest('.region-hit-target');
                        // 确保点击的是当前激活图层 (activeLayer) 中的元素
                        return target && target.dataset.lid === activeLayer.id;
                    });

                    let hitIndex = -1;
                    if (hitEl) {
                        // 如果找到了，通过 DOM 上的 data-rid 反查数据索引
                        const target = hitEl.closest('.region-hit-target');
                        const rid = target.dataset.rid;
                        hitIndex = activeLayer.data.findIndex(r => r.id === rid);
                    }

                    // --- 下面的逻辑完全保持不变 (这是你强调绝对不能丢弃的逻辑) ---
                    if (hitIndex !== -1) {
                        console.log("Clicked existing region (Visual Hit), switching to EDIT mode.");
                        // 命中既有地块！直接复用点击逻辑进入“编辑模式”
                        this.onRegionClick(activeLayer.data[hitIndex], hitIndex, activeLayer);
                        return; // ★ 关键：阻止后续的泛洪生成代码执行
                    }

                    // --- 如果没点中任何旧地块，才执行泛洪生成新地块 ---
                    
                    const canvas = document.getElementById('map-analysis-canvas');
                    // 换算坐标
                    const rawX = Math.floor((clickX / rect.width) * canvas.width);
                    const rawY = Math.floor((clickY / rect.height) * canvas.height);
                    
                    this.createRegionFromPoint(rawX, rawY);
                }
            },
            onMapBackgroundClick(e) {
                // 直接调用处理添加点的逻辑
                this.handleAddPinClick(e);
            },
            // [新增] 泛洪算法生成地块
            createRegionFromPoint(startX, startY) {
                if (this.isProcessingRegion) return;
                
                const canvas = document.getElementById('map-analysis-canvas');
                // [新增] 检查 Canvas 是否有数据
                if(!canvas || canvas.width === 0) {
                    // 尝试最后一次初始化
                    this.initMapCanvas();
                    // 如果还是不行，提示用户
                    if (!canvas || canvas.width === 0) return alert("Analysis canvas is empty. Please verify you have a visible 'Image' layer.");
                }

                this.isProcessingRegion = true;
                document.body.style.cursor = 'wait';

                try {
                    const canvas = document.getElementById('map-analysis-canvas');
                    const ctx = canvas.getContext('2d');
                    const width = canvas.width;
                    const height = canvas.height;
                    
                    // 获取全图像素数据
                    const imageData = ctx.getImageData(0, 0, width, height);
                    const data = imageData.data;

                    // 获取点击点的颜色
                    const startPos = (startY * width + startX) * 4;
                    const startColor = [data[startPos], data[startPos+1], data[startPos+2], data[startPos+3]];

                    // 颜色容差 (40)
                    const tolerance = 40; 
                    const match = (pos) => {
                        const r = data[pos], g = data[pos+1], b = data[pos+2];
                        return Math.abs(r - startColor[0]) < tolerance &&
                               Math.abs(g - startColor[1]) < tolerance &&
                               Math.abs(b - startColor[2]) < tolerance; 
                    };

                    // BFS 泛洪 (优化：使用单层整数栈减少GC压力)
                    // 将坐标 x,y 编码为单一整数 index = y * width + x
                    const stack = [startY * width + startX]; 
                    const visited = new Uint8Array(width * height);
                    const regionPixels = []; 
                    
                    let minX = width, maxX = 0, minY = height, maxY = 0;
                    
                    visited[startY * width + startX] = 1;

                    // 预先定义方向数组，避免循环内创建对象
                    const dx = [1, -1, 0, 0];
                    const dy = [0, 0, 1, -1];

                    while (stack.length) {
                        const idx = stack.pop();
                        const x = idx % width;
                        const y = (idx / width) | 0; // 取整
                        
                        regionPixels.push(x, y);
                        
                        // 只需要比较当前点，不需要每次循环都比较
                        if (x < minX) minX = x;
                        if (x > maxX) maxX = x;
                        if (y < minY) minY = y;
                        if (y > maxY) maxY = y;

                        for (let i = 0; i < 4; i++) {
                            const nx = x + dx[i];
                            const ny = y + dy[i];

                            if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                                const nIdx = ny * width + nx;
                                if (!visited[nIdx]) {
                                    if (match(nIdx * 4)) {
                                        visited[nIdx] = 1;
                                        stack.push(nIdx);
                                    }
                                }
                            }
                        }
                    }

                    if (regionPixels.length < 50) {
                        alert("Area too small!");
                        return;
                    }

                    // 生成掩码图片
                    const regionW = maxX - minX + 1;
                    const regionH = maxY - minY + 1;
                    const maskCanvas = document.createElement('canvas');
                    maskCanvas.width = regionW;
                    maskCanvas.height = regionH;
                    const maskCtx = maskCanvas.getContext('2d');
                    const maskImgData = maskCtx.createImageData(regionW, regionH);
                    
                    for (let i = 0; i < regionPixels.length; i += 2) {
                        const px = regionPixels[i] - minX;
                        const py = regionPixels[i+1] - minY;
                        const idx = (py * regionW + px) * 4;
                        
                        // 改为白色 (255, 255, 255)，为了兼容 SVG Mask
                        maskImgData.data[idx] = 255;   // R
                        maskImgData.data[idx+1] = 255; // G
                        maskImgData.data[idx+2] = 255; // B
                        maskImgData.data[idx+3] = 255; // A (完全不透明)
                    }
                    maskCtx.putImageData(maskImgData, 0, 0);

                    // 计算重心
                    let sumX = 0, sumY = 0;
                    let pixelCount = 0;
                    
                    for (let i = 0; i < regionPixels.length; i += 2) {
                        sumX += regionPixels[i];
                        sumY += regionPixels[i+1];
                        pixelCount++;
                    }
                    
                    // 计算相对于原图宽高的百分比
                    const centerX = (sumX / pixelCount / width) * 100;
                    const centerY = (sumY / pixelCount / height) * 100;

                    // 打开编辑框
                    this.editingRegionIndex = -1; // 标记新增 Region
                    this.editingPinIndex = -2;    // 关闭 Pin 模式
                    this.pinForm = {
                        // Region 特有
                        x: (minX / width) * 100,
                        y: (minY / height) * 100,
                        w: (regionW / width) * 100,
                        h: (regionH / height) * 100,
                        maskData: maskCanvas.toDataURL(),
                        centerX: centerX,
                        centerY: centerY,
                        
                        // 通用
                        mode: 'entity', selectedId: '', customLabel: 'New Region',
                        icon: 'fa-solid fa-flag', color: '#ffffff'
                    };
                    this.showPinModal = true;

                } catch (e) {
                    console.error(e);
                    alert("Region detection failed.");
                } finally {
                    this.isProcessingRegion = false;
                    document.body.style.cursor = 'default';
                }
            },

// --- [修复] 点击地块 (解决 v-memo 导致的旧数据缓存问题) ---
            onRegionClick(reg, idx, layer) {
                this.map_data.activeLayerId = layer.id;
                this.editingRegionIndex = idx;
                this.editingPinIndex = -2; 
                
                // ★★★ [这就是问题所在] ★★★
                // 因为 v-memo 锁住了视图，传进来的 'reg' 是还没保存时的“旧快照”。
                // 必须无视它，直接通过索引去 layer.data 里拿刚才保存进去的“最新数据”：
                const freshReg = layer.data[idx]; 
                
                // 回填表单 (全部使用 freshReg)
                this.pinForm = {
                    ...freshReg, 
                    customLabel: freshReg.name,   
                    selectedId: freshReg.ownerId, 
                    icon: freshReg.icon || 'fa-solid fa-mountain', 
                    color: freshReg.color,
                    
                    // 现在这里能读到你刚保存的数据了
                    schemaId: freshReg.schemaId || '', 
                    stats: freshReg.stats ? JSON.parse(JSON.stringify(freshReg.stats)) : {}
                };
                
                if (this.pinForm.schemaId) {
                    this.refreshPinFormStats(); 
                }
                
                this.showPinModal = true;
            },

            // --- [同步修复] 点击标记点 (同样存在缓存问题) ---
            onPinClick(pin, idx, layer) {
                this.map_data.activeLayerId = layer.id;
                this.editingPinIndex = idx;
                this.editingRegionIndex = -2; 
                
                // 同样，无视传进来的 pin，去拿最新的
                const freshPin = layer.data[idx];

                let mode = freshPin.type || 'custom';
                if (!freshPin.type) {
                     if (this.players.some(p => p.id === freshPin.linkId)) mode = 'entity';
                     else if (freshPin.linkId) mode = 'lore';
                     else mode = 'custom';
                }

                this.pinForm = {
                    x: freshPin.x, y: freshPin.y,
                    mode: mode,
                    selectedId: freshPin.linkId || '',
                    customLabel: freshPin.label || '',
                    icon: freshPin.icon || this.getFinalPinIcon(freshPin),
                    color: freshPin.color || this.getFinalPinColor(freshPin),
                    // 补全属性读取
                    schemaId: freshPin.schemaId || '', 
                    stats: freshPin.stats ? JSON.parse(JSON.stringify(freshPin.stats)) : {}
                };
                
                // 如果是 Pin，也尝试刷新一下输入框（如果有规则的话）
                if (this.pinForm.schemaId) {
                    this.refreshPinFormStats(); 
                }

                this.showPinModal = true;
            },
            // [核心修复] 地图编辑：切换规则时，强制初始化属性对象
            refreshPinFormStats() {
                if (!this.pinForm.schemaId) return;
                if (!this.pinForm.stats) this.pinForm.stats = {};
                const fields = this.getFieldsBySchemaId(this.pinForm.schemaId);
                fields.forEach(f => {
                    if (this.pinForm.stats[f.key] === undefined) {
                        this.pinForm.stats[f.key] = '-';
                    }
                });
            },
            // [核心修复] 保存地图标记/区域 (强制包含 schemaId 和 stats)
            saveMapPin() {
                const activeLayer = this.getActiveLayer();
                if (!activeLayer) return alert("Please select a layer in Layer Manager first!");
                this.recordSnapshot(); // ★ [新增]

                let nameOrLabel = this.pinForm.customLabel || "Unnamed";
                let idRef = this.pinForm.selectedId || "";

                if (this.pinForm.mode === 'entity' && this.editingRegionIndex === -2) {
                    const p = this.players.find(x => x.id === this.pinForm.selectedId);
                    nameOrLabel = p ? p.name : "Unknown";
                } else if (this.pinForm.mode === 'lore' && this.editingRegionIndex === -2) {
                    nameOrLabel = this.pinForm.selectedId;
                }

                const baseData = {
                    icon: this.pinForm.icon,
                    color: this.pinForm.color
                };

                // --- 保存分支 ---
                if (this.editingRegionIndex !== -2) {
                    // === Region (地块) 保存逻辑 ===
                    let targetLayer = activeLayer;
                    
                    // 智能图层定位
                    if (targetLayer.type !== 'region') {
                        targetLayer = this.map_data.layers.find(l => l.type === 'region');
                        if (!targetLayer) {
                            if(confirm("Current layer is NOT a Region Layer. Create new?")) {
                                this.addLayer('region');
                                targetLayer = this.map_data.layers[this.map_data.layers.length - 1];
                            } else {
                                return;
                            }
                        }
                        this.map_data.activeLayerId = targetLayer.id;
                    }

                    const regionData = {
                        ...baseData,
                        id: this.editingRegionIndex === -1 ? 'reg_' + Date.now() : targetLayer.data[this.editingRegionIndex].id,
                        type: 'territory',
                        name: this.pinForm.customLabel || "Region", 
                        ownerId: this.pinForm.selectedId,           
                        
                        // 几何数据
                        x: this.pinForm.x, y: this.pinForm.y,
                        w: this.pinForm.w, h: this.pinForm.h,
                        maskData: this.pinForm.maskData,
                        centerX: this.pinForm.centerX, centerY: this.pinForm.centerY,

                        // ★★★★★ [关键修复] 必须显式保存这两个字段！ ★★★★★
                        schemaId: this.pinForm.schemaId || '', 
                        stats: JSON.parse(JSON.stringify(this.pinForm.stats || {})) 
                    };

                    if (this.editingRegionIndex === -1) targetLayer.data.push(regionData);
                    else targetLayer.data[this.editingRegionIndex] = regionData;
                    
                    this.editingRegionIndex = -2; 
                } else {
                    // === Pin (标记点) 保存逻辑 ===
                    if (activeLayer.type !== 'marker') return alert("Current layer is NOT a Marker Layer!");

                    const pinData = {
                        ...baseData,
                        id: this.editingPinIndex === -1 ? 'pin_' + Date.now() : activeLayer.data[this.editingPinIndex].id,
                        type: this.pinForm.mode,
                        label: nameOrLabel,
                        linkId: idRef,
                        x: this.pinForm.x,
                        y: this.pinForm.y,

                        // ★★★ [同步修复] 给 Pin 也加上保存逻辑，防止以后出同样问题 ★★★
                        schemaId: this.pinForm.schemaId || '',
                        stats: JSON.parse(JSON.stringify(this.pinForm.stats || {}))
                    };
                    if (this.editingPinIndex === -1) activeLayer.data.push(pinData);
                    else activeLayer.data[this.editingPinIndex] = pinData;
                }
                this.dataVersion++;
                this.saveGame('autosave.json');
                this.showPinModal = false;
            },
            // --- [新增] 图层管理方法 ---
            addLayer(type) {
                const id = 'layer_' + type + '_' + Date.now();
                let data = null;
                let name = this.t('layer_new');
                
                if (type === 'image') { data = ''; name = this.t('layer_map'); }
                else if (type === 'region') { data = []; name = this.t('layer_region'); }
                else if (type === 'marker') { data = []; name = this.t('layer_marker'); }
                
                // 如果是 Image 层，建议放到最底下(unshift)；其他建议放到最上面(push)
                // 这里为了逻辑简单，统一 push 到数组末尾（显示在最上层），用户可手动调整
                this.map_data.layers.push({ id, type, name, visible: true, opacity: 1, data });
                
                this.map_data.activeLayerId = id;
                if (type === 'image') {
                    // 这里 alert 也可以优化，但为了代码简洁暂时保留或替换为 t('msg_image_layer_hint')
                    alert("Image Layer created. Click 'Upload Map' to set image.");
                }
                this.saveGame('autosave.json');
            },
            deleteLayer(idx) {
                if (confirm("Delete this layer? All data in it will be lost.")) {
                    this.map_data.layers.splice(idx, 1);
                    if (this.map_data.layers.length > 0) this.map_data.activeLayerId = this.map_data.layers[0].id;
                    else this.map_data.activeLayerId = '';
                    this.saveGame('autosave.json');
                }
            },
            moveLayer(idx, dir) {
                const target = idx + dir;
                if (target >= 0 && target < this.map_data.layers.length) {
                    const temp = this.map_data.layers[idx];
                    this.map_data.layers[idx] = this.map_data.layers[target];
                    this.map_data.layers[target] = temp;
                }
            },
            getActiveLayer() {
                return this.map_data.layers.find(l => l.id === this.map_data.activeLayerId);
            },
            deleteMapPin() {
                const activeLayer = this.getActiveLayer();
                if (!activeLayer) return;

                if(confirm("Remove this item?")) {
                    this.recordSnapshot(); // ★ [新增]
                    if (this.editingRegionIndex !== -2 && this.editingRegionIndex !== -1) {
                         // 删除 Region
                         if (activeLayer.type === 'region') activeLayer.data.splice(this.editingRegionIndex, 1);
                    } else if (this.editingPinIndex !== -1) {
                         // 删除 Pin
                         if (activeLayer.type === 'marker') activeLayer.data.splice(this.editingPinIndex, 1);
                    }
                    this.saveGame('autosave.json');
                    this.showPinModal = false;
                    this.editingRegionIndex = -2;
                }
            },

            getPinColor(linkId) {
                if (!linkId) return '#fbbf24'; // default amber
                return this.getFactionColor(linkId);
            },
            
            getPinName(linkId) {
                if (!linkId) return 'Marker';
                return this.getFactionName(linkId);
            },

            // 构建层级树字符串，供 AI 使用
            buildHierarchyString() {
                const roots = this.players.filter(p => !p.parentId);
                let output = "";
                
                const printNode = (p, depth) => {
                    const indent = "  ".repeat(depth);
                    
                    // 清洗 stats，防止属性中混入 Base64 图片
                    const safeStats = { ...p.stats };
                    for (const key in safeStats) {
                        const val = safeStats[key];
                        // 如果值是字符串且过长，判定为非文本数据，进行截断
                        if (typeof val === 'string' && val.length > 200) {
                            safeStats[key] = "[LONG_DATA_OMITTED]";
                        }
                    }
                    const statsStr = JSON.stringify(safeStats);

                    output += `${indent}- [${p.name}] (ID: ${p.id}) ${statsStr}\n`;
                    
                    // 查找子节点
                    const children = this.players.filter(child => child.parentId === p.id);
                    children.forEach(c => printNode(c, depth + 1));
                };

                roots.forEach(r => printNode(r, 0));
                return output;
            },

            // 构建地图描述字符串，供 AI 使用
            buildMapString() {
                if ((!this.map_data.regions || this.map_data.regions.length === 0) && (!this.map_data.pins || this.map_data.pins.length === 0)) return "No tactical map data defined.";
                
                let output = "=== TACTICAL MAP STATUS (Geopolitics) ===\n";
                
                // 1. 输出地块控制权信息
                if (this.map_data.regions && this.map_data.regions.length > 0) {
                    output += "Regions (Territory Control):\n";
                    this.map_data.regions.forEach(reg => {
                        const ownerName = reg.ownerId ? this.getFactionName(reg.ownerId) : "NEUTRAL/UNCLAIMED";
                        output += `- Region "${reg.name}" is controlled by [${ownerName}] (ID: ${reg.ownerId || 'None'}).\n`;
                    });
                }
                
                // 2. 输出关键点信息
                if (this.map_data.pins && this.map_data.pins.length > 0) {
                    output += "\nKey Locations (Points of Interest):\n";
                    this.map_data.pins.forEach(pin => {
                        const name = pin.label || this.getPinName(pin.linkId);
                        output += `- POI "${name}" at [${pin.x.toFixed(1)}%, ${pin.y.toFixed(1)}%]. Type: ${pin.type}.\n`;
                    });
                }
                
                output += "Note: Map coordinates are 0-100% relative.\n";
                return output;
            },
            // --- [新增] API Profile 管理逻辑 ---
            
            // 1. 打开编辑器
            openProfileEditor(profile) {
                if (profile) {
                    // 编辑模式：深拷贝数据
                    this.editingProfileData = JSON.parse(JSON.stringify(profile));
                } else {
                    // 新建模式：重置为空
                    this.editingProfileData = { 
                        id: null, 
                        name: 'New Profile', 
                        provider: 'OpenAI', 
                        baseUrl: '', 
                        model: '', 
                        key: '' 
                    };
                }
                this.isEditingProfile = true;
            },

            // 2. 保存配置 (新建或更新)
            saveProfile() {
                const data = this.editingProfileData;
                if (!data.name || !data.key) return alert("Name and API Key are required!");

                if (data.id) {
                    // 更新现有
                    const idx = this.settings.api_profiles.findIndex(p => p.id === data.id);
                    if (idx !== -1) {
                        this.settings.api_profiles[idx] = data;
                        // 如果更新的是当前选中的，实时同步到 active api
                        if (this.settings.active_profile_id === data.id) {
                            this.selectProfile(data);
                        }
                    }
                } else {
                    // 新建
                    data.id = Date.now();
                    this.settings.api_profiles.push(data);
                    // 如果是第一个，自动选中
                    if (this.settings.api_profiles.length === 1) {
                        this.selectProfile(data);
                    }
                }
                
                // 保存到 localStorage
                // [修改] 传入 true，表示静默保存，不要关闭大弹窗
                this.saveSettings(true); 
                this.isEditingProfile = false;
            },
            // 3. 选中/激活配置
            selectProfile(profile) {
                this.settings.active_profile_id = profile.id;
                // ★ 关键：将选中的配置复制到 settings.api，供系统调用
                this.settings.api = {
                    provider: profile.provider,
                    baseUrl: profile.baseUrl,
                    model: profile.model,
                    key: profile.key
                };
                // 立即保存状态，防止刷新丢失选中项
                this.saveSettings(true);
            },

            // 4. 删除配置
            deleteProfile(idx) {
                if (!confirm(this.t('msg_confirm_delete'))) return;
                
                const deletedId = this.settings.api_profiles[idx].id;
                this.settings.api_profiles.splice(idx, 1);
                
                // 如果删除了当前选中的，重置状态
                if (this.settings.active_profile_id === deletedId) {
                    this.settings.active_profile_id = null;
                    // 可选：清空当前的 settings.api，或者自动选中下一个
                    if (this.settings.api_profiles.length > 0) {
                        this.selectProfile(this.settings.api_profiles[0]);
                    }
                }
                this.saveSettings(true);
            },
            // --- [新增] API 测试与状态同步逻辑 ---

            // 1. 主动测试某个配置 (点击小钥匙)
            async testUserProfile(profile) {
                if (!profile.key) return alert("API Key is missing!");
                
                profile.isTesting = true;
                profile.status = 'unknown';

                // 构造极简请求
                const payload = {
                    provider: profile.provider,
                    baseUrl: profile.baseUrl,
                    apiKey: profile.key,
                    model: profile.model,
                    useProxy: this.settings.proxy.enabled,
                    proxyPort: this.settings.proxy.port,
                    systemPrompt: "You are a connection tester.",
                    context: "Test",
                    userPrompt: "Reply 'OK' if you receive this."
                };

                try {
                    // 调用后端/Native API
                    await window.LevantAPI.generateAI(payload);
                    profile.status = 'success';
                } catch (e) {
                    console.warn("API Test Failed:", e);
                    profile.status = 'error';
                    // 可选：显示具体错误
                    // alert("Connection Failed:\n" + e.message);
                } finally {
                    profile.isTesting = false;
                    // 如果这个正好是当前激活的配置，触发保存（虽然 status 不存，但保持逻辑一致性）
                    if (this.settings.active_profile_id === profile.id) {
                        this.saveSettings(true); // [修改] 静默保存
                    }
                }
            },

            // 2. 全局状态更新钩子 (供上帝模式/推演等调用)
            updateCurrentProfileStatus(status) { // status: 'success' | 'error'
                const activeId = this.settings.active_profile_id;
                if (!activeId) return;

                const profile = this.settings.api_profiles.find(p => p.id === activeId);
                if (profile) {
                    profile.status = status;
                }
            },
            // 5. 编辑器内的快速预设 (完整版)
            applyPresetToEditor(type) {
                // 通用重置
                this.editingProfileData.key = ''; 

                if (type === 'Gemini') {
                    this.editingProfileData.provider = 'Gemini';
                    this.editingProfileData.baseUrl = '';
                    this.editingProfileData.model = 'gemini-3-flash-preview';
                    this.editingProfileData.name = 'Google Gemini';
                } else if (type === 'Claude') {
                    this.editingProfileData.provider = 'Claude';
                    this.editingProfileData.baseUrl = '';
                    this.editingProfileData.model = 'claude-3-5-sonnet-20240620';
                    this.editingProfileData.name = 'Anthropic Claude';
                } else if (type === 'DeepSeek') {
                    this.editingProfileData.provider = 'OpenAI';
                    this.editingProfileData.baseUrl = 'https://api.deepseek.com';
                    this.editingProfileData.model = 'deepseek-chat';
                    this.editingProfileData.name = 'DeepSeek V3';
                } else if (type === 'Qwen') {
                    // [补全] 通义千问
                    this.editingProfileData.provider = 'OpenAI';
                    this.editingProfileData.baseUrl = 'https://dashscope.aliyuncs.com/compatible-mode/v1';
                    this.editingProfileData.model = 'qwen-plus';
                    this.editingProfileData.name = 'Alibaba Qwen';
                } else if (type === 'OpenAI') {
                    this.editingProfileData.provider = 'OpenAI';
                    this.editingProfileData.baseUrl = 'https://api.openai.com/v1';
                    this.editingProfileData.model = 'gpt-4o';
                    this.editingProfileData.name = 'OpenAI GPT-4o';
                } else if (type === 'SiliconFlow') {
                    // [补全] 硅基流动
                    this.editingProfileData.provider = 'OpenAI';
                    this.editingProfileData.baseUrl = 'https://api.siliconflow.cn/v1';
                    this.editingProfileData.model = 'deepseek-ai/DeepSeek-V3';
                    this.editingProfileData.name = 'SiliconFlow DS';
                } else if (type === 'Others') {
                    // [补全] 自定义
                    this.editingProfileData.provider = 'OpenAI'; // 默认走兼容协议
                    this.editingProfileData.baseUrl = ''; 
                    this.editingProfileData.model = ''; 
                    this.editingProfileData.name = 'Custom Server';
                }
            },
            applyPreset(type) {
                if (type === 'Gemini') {
                    this.settings.api.provider = 'Gemini';
                    this.settings.api.baseUrl = ''; 
                    this.settings.api.model = 'gemini-3-flash-preview';
                } else if (type === 'Claude') {
                    this.settings.api.provider = 'Claude';
                    this.settings.api.baseUrl = ''; // Claude 不需要 BaseURL (除非用代理，但通常直接连)
                    this.settings.api.model = 'claude-sonnet-4-5-20250929';
                } else if (type === 'DeepSeek') {
                    this.settings.api.provider = 'OpenAI';
                    this.settings.api.baseUrl = 'https://api.deepseek.com';
                    this.settings.api.model = 'deepseek-chat';
                } else if (type === 'Qwen') {
                    this.settings.api.provider = 'OpenAI';
                    this.settings.api.baseUrl = 'https://dashscope.aliyuncs.com/compatible-mode/v1';
                    this.settings.api.model = 'qwen-plus';
                } else if (type === 'OpenAI') {
                    this.settings.api.provider = 'OpenAI';
                    this.settings.api.baseUrl = 'https://api.openai.com/v1';
                    this.settings.api.model = 'gpt-4o';
                } else if (type === 'SiliconFlow') {
                    this.settings.api.provider = 'OpenAI';
                    this.settings.api.baseUrl = 'https://api.siliconflow.cn/v1';
                    this.settings.api.model = 'deepseek-ai/DeepSeek-V3';
                } else if (type === 'Others') {
                    this.settings.api.provider = 'Others';
                    this.settings.api.baseUrl = ''; // 用户自填
                    this.settings.api.model = ''; // 用户自填
                }
            },
            t(key) {
                if (!this.translations[key]) return key;
                return this.translations[key][this.ui.lang] || this.translations[key]['zh'];
            },
            // [修改] Markdown 渲染：强制新窗口打开链接，防止覆盖当前页面
            renderMarkdown(text) { 
                if (!text) return '';
                
                // 1. 先让 marked 使用默认渲染器生成标准 HTML
                // 这样能保证内容绝对正确，不会出现 undefined
                let rawHtml = marked.parse(text);
                
                // 2. 使用浏览器原生 DOM 解析器来处理链接属性
                // 这种方式比正则替换更安全，比修改 renderer 更稳定
                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(rawHtml, 'text/html');
                    
                    // 找到所有链接，强制添加 target="_blank"
                    const links = doc.querySelectorAll('a');
                    links.forEach(a => {
                        a.setAttribute('target', '_blank');
                        a.setAttribute('rel', 'noopener noreferrer');
                        // 这样配合之前的 CSS，颜色和点击行为就都对了
                    });
                    
                    // 返回处理后的 HTML
                    return doc.body.innerHTML;
                } catch (e) {
                    // 兜底：万一 DOMParser 在某些极端环境下不可用
                    return rawHtml.replace(/<a href=/g, '<a target="_blank" rel="noopener noreferrer" href=');
                }
            },
            getFactionColor(id) { 
                if(!id || id === 'global') return '#94a3b8'; 
                const p = this.players.find(x => x.id === id); 
                return p ? p.color : '#6366f1'; 
            },
            getFactionName(id) { 
                if (id === 'global') return this.t('option_global'); 
                if (!id) return 'Unknown';
                const p = this.players.find(x => x.id === id); 
                return p ? p.name : 'Unknown'; 
            },
            getFactionLogo(id) { 
                if (id === 'global') return 'fa-solid fa-globe'; 
                if (!id) return 'fa-solid fa-users';
                const p = this.players.find(x => x.id === id); 
                return p && p.logo ? p.logo : 'fa-solid fa-users'; 
            },
            getSchemaLabel(key) { const s = this.stat_schema.find(x => x.key === key); return s ? s.label : key; },
            // [新增] 获取指定规则集的所有字段
            getFieldsBySchemaId(sid) {
                const schema = this.rule_sets.find(r => r.id === sid);
                return schema ? schema.fields : [];
            },
            // [新增] 获取当前正在编辑的规则集字段
            getActiveSchemaFields() {
                return this.getFieldsBySchemaId(this.activeSchemaId);
            },
            // [修改] 根据 key 查找 label (需要遍历所有规则集，或者指定规则集)
            getSchemaLabel(key, schemaId = null) {
                // 1. 如果指定了 schemaId，精准查找
                if (schemaId) {
                    const schema = this.rule_sets.find(r => r.id === schemaId);
                    if (schema) {
                        const field = schema.fields.find(f => f.key === key);
                        if (field) return field.label;
                    }
                }
                // 2. 全局查找 (用于 Impact 显示等上下文不明确的情况)
                for (const rs of this.rule_sets) {
                    const field = rs.fields.find(f => f.key === key);
                    if (field) return field.label;
                }
                return key; // 找不到则返回 key 本身
            },
            // [新增] 添加新规则集
            addNewRuleSet() {
                const name = prompt("New Rule Set Name (e.g. 'Character', 'Nation')");
                if (!name) return;
                const newId = 'rs_' + Date.now();
                this.rule_sets.push({ id: newId, name: name, fields: [] });
                this.activeSchemaId = newId;
                this.saveGame('autosave.json');
            },
            // [新增] 删除规则集
            deleteActiveRuleSet() {
                if (this.rule_sets.length <= 1) return alert("Must keep at least one rule set.");
                if (!confirm("Delete this rule set? Entities using it will lose stat definitions.")) return;
                const idx = this.rule_sets.findIndex(r => r.id === this.activeSchemaId);
                this.rule_sets.splice(idx, 1);
                this.activeSchemaId = this.rule_sets[0].id;
                this.saveGame('autosave.json');
            },
            // [新增] 判断是否为图片 (Base64 或 URL)
            isImage(str) { return str && (str.startsWith('data:image') || str.startsWith('http') || str.includes('.png') || str.includes('.jpg')); },
            // [新增] 智能解析值：如果是实体ID则显示名称，否则显示原值
            resolveVal(val) {
                if (!val || typeof val !== 'string') return val;
                // 尝试在 players 列表里找
                const p = this.players.find(x => x.id === val);
                if (p) return p.name;
                // 如果是 global，显示对应文本
                if (val === 'global') return this.t('option_global');
                return val;
            },
            
            // [新增] 处理实体头像上传
            // [修改] 支持 field 为 'add_variant' 时推入数组
            handleFactionImageUpload(event, field) {
                const files = event.target.files;
                if (!files || files.length === 0) return;

                // 遍历所有选中的文件
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        if (field === 'add_variant') {
                            if (!this.editingFaction.avatars) this.editingFaction.avatars = [];
                            
                            // [关键修复] 增加 Math.random() 防止 ID 冲突导致列表显示不全
                            // 使用文件名作为默认 Tag，方便识别
                            const safeName = file.name.split('.')[0].replace(/[^a-zA-Z0-9_\u4e00-\u9fa5]/g, '').substring(0, 10);
                            
                            this.editingFaction.avatars.push({
                                id: 'av_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                tag: safeName || 'tag_' + (this.editingFaction.avatars.length + 1), 
                                url: e.target.result,
                                scale: 1.0,
                                offsetY: 0.0
                            });
                            this.$nextTick(() => {
                                this.previewAvatarIndex = this.editingFaction.avatars.length - 1;
                            });
                        } else {
                            // 默认立绘 (只取第一个，或者覆盖)
                            this.editingFaction[field] = e.target.result;
                        }
                    };
                    reader.readAsDataURL(file);
                }
                
                // 清空 input 允许重复选择相同文件
                event.target.value = '';
            },
            formatTimeSpan(event) { if (!event.timeStart) return "Time ?"; if (!event.timeEnd || event.timeStart === event.timeEnd) return event.timeStart; return `${event.timeStart} - ${event.timeEnd}`; },
            getRegionColor(reg) {
                // 1. 最高优先级：如果有 ownerId，直接跟随势力的主题色
                // 这样当你把地块划给某个势力时，它会自动变成那个势力的颜色
                if (reg.ownerId) {
                    const p = this.players.find(x => x.id === reg.ownerId);
                    if (p && p.color) return p.color;
                }
                
                // 2. 次优先级：如果地块自己定义了 override 颜色，使用之
                // (用于那些确实需要特殊标记的无主地块，比如污染区、特殊地形)
                if (reg.color && reg.color !== '#ffffff') return reg.color;
                
                // 3. 兜底：默认无主颜色 (slate-500)
                return '#64748b';
            },

            getRegionOwnerLogo(reg) {
                if (reg.ownerId) {
                    const p = this.players.find(x => x.id === reg.ownerId);
                    if (p && p.logo) return p.logo;
                }
                return reg.icon || 'fa-solid fa-mountain';
            },

            async exportAsImage(type, data) {
                this.posterData = { title: '', factionName: '', color: '', icon: '', content: '', badges: [], timeDisplay: '' };
                const currentTurnTime = this.timeline.length > 0 ? this.timeline[this.timeline.length-1].timeRange : 'Current';
                if (type === 'faction') {
                    this.posterData.title = data.name;
                    this.posterData.factionName = "ENTITY FILE";
                    this.posterData.color = data.color;
                    this.posterData.icon = data.logo;
                    this.posterData.content = this.renderMarkdown(data.desc);
                    this.posterData.timeDisplay = currentTurnTime;
                    for(let key in data.stats) {
                        this.posterData.badges.push({ name: data.name, icon: data.logo, color: data.color, label: this.getSchemaLabel(key), val: data.stats[key] });
                    }
                } else if (type === 'event') {
                    this.posterData.title = data.summary;
                    this.posterData.factionName = this.getFactionName(data.factionId);
                    this.posterData.color = this.getFactionColor(data.factionId);
                    this.posterData.icon = this.getFactionLogo(data.factionId);
                    this.posterData.content = this.renderMarkdown(data.content);
                    this.posterData.timeDisplay = this.formatTimeSpan(data);
                    if(data.impacts) {
                        data.impacts.forEach(imp => {
                            // ★ 核心修复：手动拼接数值变化字符串
                            const changeString = `${imp.oldValue} → ${imp.newValue}`;
                            
                            this.posterData.badges.push({
                                name: imp.targetName,
                                icon: this.getFactionLogo(imp.targetId),
                                color: this.getFactionColor(imp.targetId),
                                label: imp.attrLabel,
                                val: changeString // ★ 使用拼接好的字符串
                            });
                        });
                    }
                } else if (type === 'lore') {
                    this.posterData.title = data.keys;
                    this.posterData.factionName = "LORE DATABASE";
                    this.posterData.color = "#10b981";
                    this.posterData.icon = "fa-solid fa-database";
                    this.posterData.content = this.renderMarkdown(data.content);
                    this.posterData.timeDisplay = currentTurnTime;
                } else if (type === 'rules') {
                    this.posterData.title = "SYSTEM RULES";
                    this.posterData.factionName = "CORE";
                    this.posterData.color = "#f59e0b";
                    this.posterData.icon = "fa-solid fa-sliders";
                    this.posterData.timeDisplay = currentTurnTime;
                    let content = "Current Rules:\n\n";
                    data.forEach(d => content += `- **${d.label}** [${d.key}]\n`);
                    this.posterData.content = this.renderMarkdown(content);
                }
                await this.$nextTick();
                const element = document.getElementById('poster-canvas');
                await new Promise(resolve => setTimeout(resolve, 100));
                try {
                    const canvas = await html2canvas(element, { backgroundColor: null, scale: 2, useCORS: true, logging: false });
                    const link = document.createElement('a');
                    link.download = `Levant_${type}_${Date.now()}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                } catch (e) { alert("Error generating image"); }
            },

            async openSaveLoadModal() {
                try {
                    // ★★★ 修改点：加上 window. 前缀 ★★★
                    const data = await window.LevantAPI.getSaves();
                    this.saveFiles = data.files;
                    this.showSaveLoadModal = true;
                } catch (e) { 
                    console.error(e);
                    alert("Failed to fetch saves: " + e.message); 
                }
            },
            async loadGame(filename) {
                if (!filename) return;
                try {
                    // ★★★ 修改点：加上 window. 前缀 ★★★
                    const data = await window.LevantAPI.loadGame(filename);
                    
                    this.applyState(data);
                    this.$nextTick(() => {
                        this.initMapCanvas();
                    });

                    this.currentSaveFile = filename;
                    this.showSaveLoadModal = false;
                } catch (e) { 
                    console.error("Load Error:", e);
                    // ★★★ 修改点：加上 window. 前缀 ★★★
                    if (!window.IS_APP_MODE) this.serverConnected = false; 
                }
            },
            // [优化] 简单的防抖保存包装器
            debouncedSave(filename) {
                if (this.saveTimeout) clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(() => {
                    this.saveGame(filename);
                }, 1000); // 延迟 1 秒保存
            },

            async saveGame(filename) {
                // 如果是防抖触发的，清除计时器句柄
                if (this.saveTimeout) { 
                    clearTimeout(this.saveTimeout); 
                    this.saveTimeout = null; 
                }
                
                if (!filename || !filename.trim()) return;
                if (!filename.endsWith('.json')) filename += '.json';
                
                try {
                    const stateData = { 
                        rule_sets: this.rule_sets,
                        lorebook: this.lorebook, 
                        players: this.players, 
                        timeline: this.timeline, 
                        global_vars: this.global_vars, 
                        currentTurnPending: this.pendingEvents,
                        map_data: this.map_data 
                    };
                    
                    // 使用 LevantAPI
                    
                    await window.LevantAPI.saveGame(filename, stateData);
                    
                    this.currentSaveFile = filename;
                    // ★★★ 修改点：加上 window. 前缀 ★★★
                    if (!window.IS_APP_MODE) this.serverConnected = true;
                    if (this.showSaveLoadModal) { this.showSaveLoadModal = false; this.newSaveFilename = ''; }
                } catch (e) { 
                    console.error(e);
                    alert("Save Failed:\n" + e.message);
                }
            },
            async deleteSave(filename) {
                if (!confirm(`Delete "${filename}"?`)) return;
                try { 
                    // ★★★ 修改点：加上 window. 前缀 ★★★
                    await window.LevantAPI.deleteSave(filename); 
                    this.openSaveLoadModal(); 
                } catch (e) { alert("Delete failed: " + e.message); }
            },

            // --- ★★★ [新增] 存档上传逻辑 ★★★ ---
            handleSaveUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const content = JSON.parse(e.target.result);
                        // 简单的格式校验
                        if (!content.timeline && !content.players) {
                            throw new Error("Invalid Save File Format");
                        }
                        
                        // 使用文件名作为存档名，保存到系统
                        let filename = file.name;
                        // 调用现有的保存逻辑 (这会写入文件系统/后端)
                        // 注意：这里我们不需要 recordSnapshot，因为只是上传文件，没有改变当前状态
                        // 如果你想上传后立即加载，可以调用 this.loadGame(filename)
                        
                        await window.LevantAPI.saveGame(filename, content);
                        alert(`Save file "${filename}" uploaded successfully!`);
                        
                        // 刷新列表
                        this.openSaveLoadModal();
                        
                    } catch (err) {
                        alert("Upload Failed: " + err.message);
                    }
                    event.target.value = ''; // 重置 input
                };
                reader.readAsText(file);
            },

            // --- ★★★ [新增] 撤销 / 重做 系统 ★★★ ---
            
            // 记录快照 (在每次修改数据前调用)
            recordSnapshot() {
                // 构建当前状态的深拷贝
                const snapshot = JSON.stringify({
                    rule_sets: this.rule_sets,
                    lorebook: this.lorebook,
                    players: this.players,
                    timeline: this.timeline,
                    global_vars: this.global_vars,
                    // currentTurnPending: this.pendingEvents, // 待决事件通常不计入撤销，或者看你需要
                    map_data: this.map_data
                });

                this.undoStack.push(snapshot);
                
                // 限制栈大小 (例如 30 步)
                if (this.undoStack.length > 30) {
                    this.undoStack.shift();
                }
                
                // 发生新动作时，清空重做栈
                this.redoStack = [];
            },

            performUndo() {
                if (this.undoStack.length === 0) return;

                // 1. 保存当前状态到 Redo 栈
                const currentSnapshot = JSON.stringify({
                    rule_sets: this.rule_sets,
                    lorebook: this.lorebook,
                    players: this.players,
                    timeline: this.timeline,
                    global_vars: this.global_vars,
                    map_data: this.map_data
                });
                this.redoStack.push(currentSnapshot);

                // 2. 取出 Undo 栈顶
                const prevJson = this.undoStack.pop();
                const prevState = JSON.parse(prevJson);

                // 3. 应用状态
                this.applyState(prevState);
            },

            performRedo() {
                if (this.redoStack.length === 0) return;

                // 1. 保存当前状态到 Undo 栈
                const currentSnapshot = JSON.stringify({
                    rule_sets: this.rule_sets,
                    lorebook: this.lorebook,
                    players: this.players,
                    timeline: this.timeline,
                    global_vars: this.global_vars,
                    map_data: this.map_data
                });
                this.undoStack.push(currentSnapshot);

                // 2. 取出 Redo 栈顶
                const nextJson = this.redoStack.pop();
                const nextState = JSON.parse(nextJson);

                // 3. 应用状态
                this.applyState(nextState);
            },
// [核心修复] 应用存档状态 (全方位兼容旧版数据，强制补全地块属性)
            applyState(data) {
                // 深拷贝防止引用污染
                const state = JSON.parse(JSON.stringify(data));
                
                // --- 1. 规则集 (Rule Sets) 迁移 ---
                if (state.rule_sets && Array.isArray(state.rule_sets)) {
                    this.rule_sets = state.rule_sets;
                } else {
                    console.info("[Load] Migrating legacy schema to Rule Sets...");
                    const legacySchema = state.stat_schema || state.schema || [];
                    this.rule_sets = [{
                        id: 'default', name: '通用规则 (Default)', fields: legacySchema
                    }];
                }

                // --- 2. 激活规则集 ID 校验 ---
                const hasRules = this.rule_sets.length > 0;
                const isValidId = this.activeSchemaId && this.rule_sets.some(r => r.id === this.activeSchemaId);
                if (!isValidId) {
                    this.activeSchemaId = hasRules ? this.rule_sets[0].id : '';
                }

                // --- 3. 基础数据加载 ---
                this.lorebook = state.lorebook || [];
                this.global_vars = state.global_vars || [];
                this.pendingEvents = state.currentTurnPending || [];

                // --- 4. 实体 (Players) 数据清洗 ---
                this.players = (state.players || []).map(p => {
                    if (p.avatar === undefined) p.avatar = "";
                    if (p.avatarScale === undefined) p.avatarScale = 1.0;
                    if (p.avatarOffsetY === undefined) p.avatarOffsetY = 0.0;
                    
                    // ★★★ [新增] 补全主角标记 ★★★
                    if (p.isProtagonist === undefined) p.isProtagonist = false;

                    if (!p.schemaId) p.schemaId = hasRules ? this.rule_sets[0].id : 'default';
                    if (!p.stats) p.stats = {};
                    return p;
                });

                // --- 5. 时间轴 (Timeline) 数据清洗 ---
                this.timeline = (state.timeline || []).map(turn => {
                    if(turn.events) {
                        turn.events.forEach(e => {
                            if (!e.factionIds) e.factionIds = e.factionId ? [e.factionId] : [];
                            if (!e.factionId && e.factionIds.length > 0) e.factionId = e.factionIds[0];
                        });
                    }
                    return turn;
                });

                // --- 6. 地图数据 (Map Data) 强力迁移与清洗 ---
                const loadedMap = state.map_data || { layers: [] };
                
                // 判断是否为旧版散装格式
                const isLegacyMap = (!loadedMap.layers || loadedMap.layers.length === 0) && 
                                    (loadedMap.image || (loadedMap.regions && loadedMap.regions.length > 0));

                if (isLegacyMap) {
                    console.info("[Load] Migrating legacy Map Data to Layer System...");
                    const newLayers = [];
                    const ts = Date.now();

                    if (loadedMap.image) {
                        newLayers.push({ 
                            id: 'layer_bg_' + ts, type: 'image', name: 'Base Map', 
                            visible: true, opacity: 1.0, data: loadedMap.image 
                        });
                    }
                    if (loadedMap.regions && loadedMap.regions.length > 0) {
                        // ★ 数据清洗：旧存档中的地块也要补全 stats
                        const cleanRegions = loadedMap.regions.map(r => ({
                            ...r,
                            schemaId: r.schemaId || '',
                            stats: r.stats || {}
                        }));

                        newLayers.push({ 
                            id: 'layer_reg_' + ts, type: 'region', name: 'Territories', 
                            visible: true, opacity: 1.0, data: cleanRegions 
                        });
                    }
                    if (loadedMap.pins && loadedMap.pins.length > 0) {
                        newLayers.push({ 
                            id: 'layer_pin_' + ts, type: 'marker', name: 'Markers', 
                            visible: true, opacity: 1.0, data: loadedMap.pins 
                        });
                    }

                    this.map_data = {
                        layers: newLayers,
                        activeLayerId: newLayers.length > 0 ? newLayers[0].id : ''
                    };
                } else {
                    // 新版格式，同样进行二次清洗，确保万无一失
                    if (!loadedMap.layers) loadedMap.layers = [];
                    
                    loadedMap.layers.forEach(layer => {
                        if (layer.type === 'region' && Array.isArray(layer.data)) {
                            layer.data = layer.data.map(r => ({
                                ...r,
                                schemaId: r.schemaId || '',
                                stats: r.stats || {}
                            }));
                        }
                    });

                    this.map_data = loadedMap;
                    
                    if (!this.map_data.activeLayerId && this.map_data.layers.length > 0) {
                        this.map_data.activeLayerId = this.map_data.layers[0].id;
                    }
                }

                // --- 7. 系统状态恢复 ---
                this.serverConnected = true;
                // [新增] 修复旧存档数据结构 & 执行计算
                this.recalculateState(); 
                this.$nextTick(() => { this.initMapCanvas(); });
            },
            
            addGlobalVar() {
                this.global_vars.push({ key: 'New Var', value: 'Value' });
                this.saveGame('autosave.json');
            },

            openContextModal() {
                if (!this.settings.api.key) return alert("Please set API Key in settings.");
                
                const rawInputText = this.rawInput.trim(); 
                const editorDraft = this.editor.summary;
                
                // 1. 基础校验
                if (!rawInputText && !editorDraft) return alert("Please input command or summary! (请输入指令或摘要)");

                // [修改] 根据模式动态加载系统提示词到临时编辑区
                if (this.useGalgamePrompt) {
                    this.tempSystemPrompt = this.settings.prompts.galgame;
                } else {
                    this.tempSystemPrompt = this.settings.prompts.system;
                }
                
                const inputText = (rawInputText + " " + editorDraft).toLowerCase();

                // 2. 准备资料库
                this.contextConfig.loreList = (this.lorebook || []).map(entry => {
                    let isActive = false;
                    if (entry.mode === 'on') isActive = true;
                    else if (entry.mode === 'auto') {
                        const keysStr = entry.keys || "";
                        const keywords = keysStr.split(/[,，]/).map(k => k.trim().toLowerCase()).filter(k => k);
                        isActive = keywords.some(k => inputText.includes(k));
                    }
                    return { ...entry, active: isActive, originalMode: entry.mode };
                });

                // 3. 准备实体列表
                this.contextConfig.playerList = (this.players || []).map(p => ({ 
                    id: p.id, name: p.name, logo: p.logo, color: p.color, active: true 
                }));

                // --- [关键修复点 A]：聚合图层数据 ---
                let allRegions = [];
                let allPins = [];

                // 优先从图层读取
                if (this.map_data.layers && this.map_data.layers.length > 0) {
                    this.map_data.layers.forEach(layer => {
                        if (layer.visible && Array.isArray(layer.data)) {
                            if (layer.type === 'region') allRegions = allRegions.concat(layer.data);
                            if (layer.type === 'marker') allPins = allPins.concat(layer.data);
                        }
                    });
                } else {
                    // 兼容旧数据
                    allRegions = this.map_data.regions || [];
                    allPins = this.map_data.pins || [];
                }

                // 映射到 contextConfig
                this.contextConfig.mapRegionList = allRegions.map(r => ({ ...r, active: true }));
                this.contextConfig.mapPinList = allPins.map(p => ({ 
                    id: p.id, label: p.label, linkId: p.linkId, type: p.type, x: p.x, y: p.y, active: true 
                }));

                // 4. 打开弹窗
                this.showContextModal = true;
            },

            moveContextItem(type, direction) {
                const idx = this.contextConfig.order.indexOf(type);
                if (idx < 0) return;
                const newIdx = idx + direction;
                if (newIdx >= 0 && newIdx < this.contextConfig.order.length) {
                    const temp = this.contextConfig.order[newIdx];
                    this.contextConfig.order[newIdx] = this.contextConfig.order[idx];
                    this.contextConfig.order[idx] = temp;
                }
            },

            // --- 修改后的文件处理逻辑 ---
            async handleScriptFiles(event) {
                const files = event.target.files;
                if (!files.length) return;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        // readAsDataURL 读取的结果格式永远是: "data:应用类型;base64,纯Base64编码..."
                        const rawData = e.target.result; 
                        
                        // 提取逗号后面的纯 Base64 部分
                        // 这样做可以保证发给后端的 data 字段是纯净的 Base64 字符串
                        let base64Data = "";
                        if (rawData.includes(',')) {
                            base64Data = rawData.split(',')[1];
                        } else {
                            base64Data = rawData;
                        }

                        let payload = { 
                            name: file.name, 
                            // 有些浏览器识别不出 docx 的 type，这里给个兜底，后端主要靠文件名后缀判断
                            type: file.type || 'application/octet-stream', 
                            data: base64Data 
                        };
                        
                        this.scriptAttachments.push(payload);
                    };
                    
                    // ★★★ 核心修改 ★★★
                    // 不管是图片、PDF 还是 Word，统统用 readAsDataURL 读取
                    // 这样能保证二进制数据完整转为 Base64，不会丢失任何字节
                    reader.readAsDataURL(file);
                }
                
                // 清空 input，允许重复选择同一文件
                event.target.value = '';
            },
            // [修改] 点击选项后的处理逻辑
            selectOption(event, optData) {
                let decisionText = "";
                if (typeof optData === 'object') {
                    // 严格取 label，并附带 desc 给 AI 做上下文
                    decisionText = `${optData.label} (${optData.desc})`;
                } else {
                    decisionText = optData;
                }
                
                this.rawInput = `[Decision] ${this.getFactionName(event.factionId)} chose: ${decisionText}`;
                
                // 2. 切换到指令 Tab
                this.tabs.right = 'input';
                
                // 3. 自动打开上下文组装窗口 (或者你可以直接调用 runAiInference，但打开窗口更安全)
                this.openContextModal();

                // 4. 可选：为了方便，自动把“当前指令”勾选上（如果之前没勾的话）
                this.contextConfig.includeCurrent = true;
            },
            // --- ★ 核心智能 JSON 解析引擎 v10.0 (清洗 + 补全) ★ ---
            smartJSONParse(jsonStr) {
                if (!jsonStr) throw new Error("Empty JSON string");

                // 【阶段一】提取核心内容
                // 寻找第一个 { 或 [，和最后一个 } 或 ]
                const firstOpen = jsonStr.search(/[\{\[]/);
                const lastClose = Math.max(jsonStr.lastIndexOf('}'), jsonStr.lastIndexOf(']'));
                
                if (firstOpen === -1) throw new Error("No JSON object found.");
                
                // 如果找到了闭合符，截取中间；如果没找到(严重截断)，则取到最后
                let cleanStr = lastClose > firstOpen 
                    ? jsonStr.substring(firstOpen, lastClose + 1) 
                    : jsonStr.substring(firstOpen);

                // 【阶段二】本地字符清洗 (解决 "name": “银狐” 问题)
                // 逻辑：将所有非标准引号替换为转义的双引号，让 JSON.parse 认为它是字符串内容
                // 注意：这可能误伤，但在报错的情况下值得一试
                // 我们只替换那些明显会导致语法错误的中文引号
                const sanitizedStr = cleanStr
                    .replace(/“/g, '\\"') // 左中文引号 -> 转义引号
                    .replace(/”/g, '\\"'); // 右中文引号 -> 转义引号

                // 尝试直接解析清洗后的字符串
                try {
                    return JSON.parse(sanitizedStr);
                } catch (e) {
                    // 如果清洗后还是不行，进入阶段三
                }

                // 【阶段三】强力栈补全 (解决截断问题)
                // 这是一个简化版的流式解析器，用于计算缺少的闭合括号
                let stack = [];
                let inString = false;
                let isEscaped = false;
                let resultStr = "";

                // 使用原始 cleanStr (未清洗的)，避免正则破坏结构
                for (let i = 0; i < cleanStr.length; i++) {
                    const char = cleanStr[i];
                    
                    if (inString) {
                        if (char === '\\' && !isEscaped) {
                            isEscaped = true;
                        } else if (char === '"' && !isEscaped) {
                            inString = false;
                        } else {
                            isEscaped = false;
                        }
                    } else {
                        if (char === '"') {
                            inString = true;
                        } else if (char === '{') {
                            stack.push('}');
                        } else if (char === '[') {
                            stack.push(']');
                        } else if (char === '}' || char === ']') {
                            // 简单的栈匹配
                            if (stack.length > 0) {
                                const expected = stack[stack.length - 1];
                                if (char === expected) stack.pop();
                            }
                        }
                    }
                    resultStr += char;
                }

                // 补全所有未闭合的字符串和括号
                if (inString) resultStr += '"';
                while (stack.length > 0) {
                    resultStr += stack.pop();
                }

                console.log("[SmartParse] Reconstructed JSON end:", resultStr.slice(-50));
                return JSON.parse(resultStr);
            },
            // --- [新增] AI JSON 修复辅助函数 ---
            async repairJsonWithAi(malformedStr, errorMsg) {
                const originalStatus = this.isThinking;
                this.isThinking = true; 
                
                // 【核心修改】直接使用完整字符串，不做任何截断
                console.warn(`[Auto-Repair] Fixing JSON... Error: ${errorMsg}`);
                
                const payload = {
                    provider: this.settings.api.provider,
                    apiKey: this.settings.api.key,
                    baseUrl: this.settings.api.baseUrl,
                    model: this.settings.api.model,
                    useProxy: this.settings.proxy.enabled,
                    proxyPort: this.settings.proxy.port,
                    
                    systemPrompt: "You are a specialized JSON syntax repair engine. Your task is to fix syntax errors (especially smart quotes like “”), missing brackets, or truncated data. \n\nCRITICAL OUTPUT RULE: Output ONLY the full, valid, raw JSON string. Do NOT use markdown code blocks. Do NOT truncate the data.",
                    
                    context: `Parser Error: ${errorMsg}`,
                    // 发送完整数据
                    userPrompt: `Repair this data into valid JSON (Do not cut off content):\n\n${malformedStr}`
                };

                try {
                    const data = await window.LevantAPI.generateAI(payload);
                    
                    const match = data.result.match(/\{[\s\S]*\}/);
                    const cleanResult = match ? match[0] : data.result;

                    return JSON.parse(cleanResult);
                } catch (e) {
                    console.error("[Auto-Repair] Fatal Error:", e);
                    throw new Error("AI Repair Failed.");
                } finally {
                    this.isThinking = originalStatus;
                }
            },
            // --- 核心推演 (修改后支持 baseUrl 和 Attachments 接口) ---
            async runAiInference() {
                this.isThinking = true;
                
                // --- 构建单体上下文 (严格遵循 contextConfig.order 顺序) ---
                let contextPayload = "";
                
                this.contextConfig.order.forEach(type => {
                    // [新增] 处理 Custom Prompt
                    if (type === 'custom' && this.contextConfig.includeCustom && this.settings.prompts.custom) {
                        contextPayload += `=== [CUSTOM INSTRUCTION] ===\n${this.settings.prompts.custom}\n\n`;
                    }
                    // 1. 全局变量
                    if (type === 'global' && this.contextConfig.includeGlobal) {
                        const visibleGlobals = this.global_vars.filter(g => g.visibility !== 'hidden');
                        contextPayload += `=== [WORLD: GLOBAL VARS] ===\n${visibleGlobals.map(g => {
                            // 调用 formatContextAttr，确保全局变量也有类型提示
                            const fmt = this.formatContextAttr(g.value, g.visibility, g.type);
                            return fmt ? `${g.key}: ${fmt}` : null;
                        }).filter(x=>x).join('\n')}\n\n`;
                    }
                    
                    if (type === 'rules' && this.contextConfig.includeRules) {
                        contextPayload += `=== [WORLD: RULES DEFINITIONS] ===\n`;
                        // 遍历所有规则集发送给 AI
                        this.rule_sets.forEach(rs => {
                            const fieldsStr = rs.fields.map(f => `${f.key}=${f.label}`).join(', ');
                            contextPayload += `TYPE [${rs.name}]: ${fieldsStr}\n`;
                        });
                        contextPayload += `\n`;
                    }
                    
                    // 3. 资料设定
                    if (type === 'lore') {
                        const activeLore = this.contextConfig.loreList.filter(l => l.active);
                        if (activeLore.length > 0) {
                            contextPayload += `=== [WORLD: LORE] ===\n${activeLore.map(l => `> [${l.keys}]: ${l.content}`).join('\n')}\n\n`;
                        }
                    }
                    
                    // 4. 参与实体
                    if (type === 'players') {
                        const activePlayers = this.contextConfig.playerList.filter(p => p.active);
                        if (activePlayers.length > 0) {
                            contextPayload += `=== [WORLD: ENTITIES] ===\n${activePlayers.map(p => {
                                const realP = this.players.find(x => x.id === p.id);
                                const schema = this.rule_sets.find(rs => rs.id === realP.schemaId);
                                
                                const visibleStats = {};
                                if (schema) {
                                    schema.fields.forEach(f => {
                                        // ★ 核心修改：调用 formatContextAttr 注入类型和权限标签
                                        // 注意：这里我们传入 f.type 和 f.visibility
                                        const valStr = this.formatContextAttr(realP.stats[f.key], f.visibility||'editable', f.type||'string');
                                        
                                        if (valStr !== null) {
                                            visibleStats[f.key] = valStr; // 存入带标签的字符串，让 AI 可见
                                        }
                                    });
                                } else {
                                    // 兼容旧模式 (无规则集时默认全部可见，视为 String)
                                    for(let k in realP.stats) {
                                        visibleStats[k] = this.formatContextAttr(realP.stats[k], 'editable', 'string');
                                    }
                                }
                                
                                // [新增] ★ 如果开关开启，且有差分立绘，则注入 Tags
                                let avatarTagsInfo = "";
                                if (this.enableAvatarTags && realP.avatars && realP.avatars.length > 0) {
                                    const tags = realP.avatars.map(a => a.tag).join(", ");
                                    avatarTagsInfo = `\n  [VISUAL] Available Expressions: [${tags}]`;
                                }

                                // 注意：JSON.stringify 会把带标签的字符串转义，这正是我们想要的
                                // 例如: "gold": "5000 <Type:Number>"
                                return `ID:${realP.id} | ${realP.name}\n  Desc: ${realP.desc}\n  Stats: ${JSON.stringify(visibleStats, null, 2)}${avatarTagsInfo}`;
                            }).join('\n\n')}\n\n`;
                        }
                    }

                    // 5. 地图数据 (Map) - 适配筛选列表
                    if (type === 'map' && this.contextConfig.includeMap) {
                        const activeRegions = this.contextConfig.mapRegionList.filter(r => r.active);
                        const activePins = this.contextConfig.mapPinList.filter(p => p.active);
                        
                        if (activeRegions.length > 0 || activePins.length > 0) {
                            contextPayload += `=== [TACTICAL MAP DATA] ===\n`;
                            
                            if (activeRegions.length > 0) {
                                contextPayload += "Regions (Control):\n";
                                activeRegions.forEach(reg => {
                                    // 必须回查原始数据以获取最新状态
                                    const realReg = this.map_data.regions.find(r => r.id === reg.id) || reg;
                                    const owner = realReg.ownerId ? this.getFactionName(realReg.ownerId) : "NEUTRAL";
                                    contextPayload += `- Region "${realReg.name}" (Owner: ${owner})\n`;
                                });
                            }
                            
                            if (activePins.length > 0) {
                                contextPayload += "\nPoints of Interest:\n";
                                activePins.forEach(pin => {
                                    const realPin = this.map_data.pins.find(p => p.id === pin.id) || pin;
                                    const label = realPin.label || this.getPinName(realPin.linkId);
                                    contextPayload += `- Pin "${label}" at [${realPin.x.toFixed(0)},${realPin.y.toFixed(0)}]\n`;
                                });
                            }
                            contextPayload += "\n";
                        }
                    }

                    // 6. 历史回溯 (History) - 正序 + 深浅分离
                    if (type === 'history' && this.contextConfig.includeHistory) {
                        const totalLen = this.timeline.length;
                        const deepLen = this.contextConfig.historyDeepDepth;       // 近期 (详情)
                        const shallowLen = this.contextConfig.historyShallowDepth; // 远期 (摘要)

                        // 计算切片索引 (正序: 远 -> 近)
                        const deepStart = Math.max(0, totalLen - deepLen);
                        const shallowEnd = deepStart;
                        const shallowStart = Math.max(0, shallowEnd - shallowLen);

                        const shallowTurns = this.timeline.slice(shallowStart, shallowEnd);
                        const deepTurns = this.timeline.slice(deepStart);

                        if (shallowTurns.length > 0 || deepTurns.length > 0) {
                            contextPayload += `=== [HISTORY MEMORY] ===\n`;
                            
                            // A. 浅层记忆 (仅摘要)
                            if (shallowTurns.length > 0) {
                                contextPayload += `--- Shallow Memory (Far Context / Summary Only) ---\n`;
                                shallowTurns.forEach(turn => {
                                    contextPayload += `[Turn ${turn.id}] ${turn.timeRange}\n`;
                                    turn.events.forEach(e => {
                                        contextPayload += ` • ${e.summary} (Actor: ${e.factionId})\n`;
                                    });
                                    contextPayload += `\n`;
                                });
                            }

                            // B. 深层记忆 (含完整 Content 和 Impacts)
                            if (deepTurns.length > 0) {
                                contextPayload += `--- Deep Memory (Recent Events / Full Detail) ---\n`;
                                deepTurns.forEach(turn => {
                                    contextPayload += `[Turn ${turn.id}] ${turn.timeRange}\n`;
                                    turn.events.forEach(e => {
                                        contextPayload += ` • ${e.summary} (Actor: ${e.factionId})\n`;
                                        // 注入完整内容，不截断
                                        if (e.content) contextPayload += `   Details: ${e.content}\n`;
                                        if (e.impacts && e.impacts.length) {
                                             contextPayload += `   Impacts: ${e.impacts.map(i => `${i.targetName}.${i.attrLabel}: ${i.change || (i.oldValue+'->'+i.newValue)}`).join('; ')}\n`;
                                        }
                                    });
                                    contextPayload += `\n`;
                                });
                            }
                            contextPayload += "\n";
                        }
                    }

                    // 7. 当前指令 (Current)
                    if (type === 'current' && this.contextConfig.includeCurrent) {
                        contextPayload += `=== [CURRENT INSTRUCTION] ===\n`;
                        if (this.rawInput) contextPayload += `> COMMAND: ${this.rawInput}\n`;
                        if (this.editor.factionId) contextPayload += `> ACTOR_ID: ${this.editor.factionId}\n`;
                        if (this.editor.timeStart) contextPayload += `> TIME: ${this.editor.timeStart} - ${this.editor.timeEnd}\n`;
                        if (this.editor.summary) contextPayload += `> DRAFT_TITLE: ${this.editor.summary}\n`;
                        if (this.editor.content) contextPayload += `> DRAFT_CONTENT: ${this.editor.content}\n`;
                        if (this.editor.impacts.length) {
                            contextPayload += `> PLANNED_IMPACTS: ${JSON.stringify(this.editor.impacts)}\n`;
                        }
                        
                        // 安科模式开关 (保持不变)
                        if (this.generateOptions) {
                            contextPayload += `> MODE: Generate "options" array for player decision.\n`;
                        }
                        contextPayload += `\n`;
                    }
                });
                let chosenSystemPrompt = this.settings.prompts.system; // 默认
                if (this.useGalgamePrompt) { // 需要在 data 中定义这个变量
                    chosenSystemPrompt = this.settings.prompts.galgame;
                }
                // --- 组装 API 请求 ---
                const payload = { 
                    provider: this.settings.api.provider, 
                    apiKey: this.settings.api.key, 
                    baseUrl: this.settings.api.baseUrl,
                    model: this.settings.api.model, 
                    useProxy: this.settings.proxy.enabled, 
                    proxyPort: this.settings.proxy.port,
                    
                    systemPrompt: chosenSystemPrompt, 
                    
                    // 核心修改：所有信息都放在 context 里，history 留空以避免后端重复插入
                    context: contextPayload,    
                    history: "",    
                    
                    // userPrompt 仅作为最后的触发器
                    userPrompt: "Analyze context and generate the next turn JSON event." 
                };

                try {
                    const data = await window.LevantAPI.generateAI(payload);
                    
                    // 1. 提取 JSON 字符串
                    const match = data.result.match(/\{[\s\S]*\}/);
                    let jsonStr = match ? match[0] : data.result;
                    
                    // 2. 尝试解析 (优先用 smartJSONParse，失败求助 AI)
                    let parsed;
                    try {
                        if (!match) throw new Error("AI did not return a valid JSON object.");
                        parsed = this.smartJSONParse(jsonStr); 
                    } catch (parseErr) {
                        console.warn("[Inference] Parse failed, invoking AI Repair...", parseErr);
                        // 调用修复，若再次失败则抛出异常由外层 catch 捕获
                        parsed = await this.repairJsonWithAi(jsonStr, parseErr.message);
                        console.log("[Inference] AI Repair Successful!");
                    }

                    // --- 下面是原有的赋值逻辑 (保持不变，parsed 变量已在上方定义) ---
                    
                    this.editor.content = parsed.content || ""; 
                    this.editor.summary = parsed.summary || ""; 
                    this.editor.factionId = parsed.factionId || this.editor.factionId; 
                    this.editor.timeStart = parsed.timeStart || ""; 
                    this.editor.timeEnd = parsed.timeEnd || "";
                    
                    // 处理选项
                    if (parsed.options && Array.isArray(parsed.options)) {
                        this.editor.options = parsed.options;
                    }
                    
                     if(parsed.impacts && Array.isArray(parsed.impacts)) {
                        this.editor.impacts = []; 
                        parsed.impacts.forEach(imp => {
                            
                            // --- ★ 智能类型推断 (Duck Typing) & 标准化 ★ ---
                            let normalizedType = 'UNKNOWN';

                            // 规则1: 只要有 attrKey，就一定是属性变更
                            if (imp.attrKey) {
                                normalizedType = 'STAT_CHANGE';
                            }
                            // 规则2: 只要有 targetName 且没有 attrKey，大概率是地块转移
                            else if (imp.targetName && !imp.attrKey) {
                                normalizedType = 'REGION_TRANSFER';
                            }
                            // 规则3: 只要有 data 对象，就是创建实体
                            else if (imp.data && typeof imp.data === 'object') {
                                normalizedType = 'ENTITY_CREATE';
                            }
                            // 规则4: 只有 targetId，意图不明确，可能是移除
                            else if (imp.targetId && Object.keys(imp).length <= 2) {
                                normalizedType = 'ENTITY_REMOVE';
                            }
                            // ... 未来可以扩展更多规则

                            // 如果无法推断，则信任 AI 的原始 type (如果存在)
                            if (normalizedType === 'UNKNOWN' && imp.type) {
                                normalizedType = imp.type;
                            }
                            
                            imp.type = normalizedType; // ★ 强制覆盖 type

                            // --- ★ 标准化后的数据填充 ★ ---
                            
                            // 填充 STAT_CHANGE 类型
                            if (imp.type === 'STAT_CHANGE') {
                                // 兼容全局变量，AI 可能返回 "GLOBAL"，"Global" 等
                                if (imp.targetId && imp.targetId.toLowerCase() === 'global') {
                                    imp.targetId = 'global';
                                    imp.targetName = 'Global';
                                    imp.attrLabel = imp.attrKey; // 全局变量 key 就是 label
                                } else {
                                    const p = this.players.find(x => x.id === imp.targetId);
                                    imp.targetName = p ? p.name : 'Unknown';
                                    // 注意：这里需要遍历所有 rule_sets 来查找 label
                                    imp.attrLabel = this.getSchemaLabel(imp.attrKey, p ? p.schemaId : null);
                                }
                            }
                            
                            // 填充 oldValue (所有类型都可能需要)
                            if (imp.oldValue === undefined) imp.oldValue = "?";

                            this.editor.impacts.push(imp); 
                        });
                    }
                    // ★★★ [新增] 标记为成功 ★★★
                    this.updateCurrentProfileStatus('success'); 

                    this.showContextModal = false;
                } catch (e) { 
                    // ★★★ [新增] 标记为失败 ★★★
                    this.updateCurrentProfileStatus('error');
                    alert("AI Error: " + e.message); 
                } 
                finally { this.isThinking = false; }
            },
            
            addImpact() {
                const impact = this.createImpactObject(this.impactForm);
                if (impact) {
                    this.editor.impacts.push(impact);
                    // 重置表单
                    this.impactForm.targetId = '';
                    this.impactForm.attrKey = '';
                    this.impactForm.newValue = '';
                    this.impactForm.targetName = '';
                }
            },
            removeImpact(idx) { this.editor.impacts.splice(idx, 1); },
            
            // --- 修改后的 addToStaging ---
            addToStaging() { 
                if (!this.editor.summary) return alert("Summary is required!"); 
                
                // 1. 确保有行动方数据
                if (!this.editor.factionIds || this.editor.factionIds.length === 0) {
                    if (this.editor.factionId) this.editor.factionIds = [this.editor.factionId];
                    else this.editor.factionIds = ['global'];
                }
                this.updateEditorPrimary();

                // --- [新增] 2. 执行合规性校验 ---
                const validationErrors = [];
                
                if (this.editor.impacts && this.editor.impacts.length > 0) {
                    this.editor.impacts.forEach((imp, idx) => {
                        const result = this.validateImpact(imp);
                        if (!result.valid) {
                            validationErrors.push(`#${idx + 1} (${imp.attrLabel}): ${result.msg}`);
                        }
                    });
                }

                // --- [新增] 3. 如果有错误，拦截并提示 ---
                if (validationErrors.length > 0) {
                    alert(`Cannot add to Pending Queue due to validation errors:\n\n${validationErrors.join('\n')}\n\nPlease manually correct the values in the editor below.`);
                    return; // ★ 拦截！
                }

                // 4. 校验通过，正常加入
                this.pendingEvents.push(JSON.parse(JSON.stringify({ 
                    ...this.editor, 
                    factionIds: this.editor.factionIds,
                    factionId: this.editor.factionId || this.editor.factionIds[0] || 'global', 
                    timeStart: this.editor.timeStart || '?', 
                    timeEnd: this.editor.timeEnd || '?', 
                    content: this.editor.content || this.editor.summary, 
                    isOpen: false 
                }))); 
                
                // 清空编辑器
                this.editor.summary = ""; 
                this.editor.content = ""; 
                this.editor.impacts = []; 
                this.editor.options = []; 
                this.editor.factionId = "";
                this.editor.factionIds = []; 
                this.editor.timeStart = ""; 
                this.editor.timeEnd = ""; 
                this.tabs.right = 'staging'; 
                this.saveGame('autosave.json'); 
            },

            loadFromStaging(i) { 
                // 提示用户这会覆盖当前编辑器内容
                if (this.editor.summary && !confirm("Editor is not empty. Overwrite with selected event?")) return;

                // 深拷贝数据到编辑器
                Object.assign(this.editor, JSON.parse(JSON.stringify(this.pendingEvents[i])));
                
                // 切换到输入 Tab
                this.tabs.right = 'input'; 
                
                // ★ 注意：这里不再调用 splice 删除原条目，防止误操作丢失
                // 用户如果修改满意了，可以生成新条目，然后手动删除旧条目
            },

            // 2. [新增] 显式删除
            deleteFromStaging(i) {
                this.pendingEvents.splice(i, 1);
                this.saveGame('autosave.json');
            },

            // --- [新增] 拖拽排序逻辑 ---
            
            onStagingDragStart(idx, event) {
                this.draggedStagingIndex = idx;
                // 设置拖拽效果，Firefox 需要
                event.dataTransfer.effectAllowed = 'move';
                event.dataTransfer.dropEffect = 'move';
            },

            onStagingDrop(targetIdx) {
                if (this.draggedStagingIndex === null || this.draggedStagingIndex === targetIdx) return;

                // 移动数组元素
                const itemToMove = this.pendingEvents[this.draggedStagingIndex];
                this.pendingEvents.splice(this.draggedStagingIndex, 1); // 先移除
                this.pendingEvents.splice(targetIdx, 0, itemToMove);    // 再插入到新位置

                this.draggedStagingIndex = null;
                this.saveGame('autosave.json'); // 排序后自动保存
            },
            commitTurn() {
                if(this.pendingEvents.length === 0) return;
                this.recordSnapshot(); // ★ [新增]
                
                const numericIds = this.timeline.map(t => parseInt(t.id, 10)).filter(id => !isNaN(id));
                const maxId = numericIds.length > 0 ? Math.max(...numericIds) : 0;
                const range = this.pendingTurnRange || `Turn ${maxId + 1}`;
                
                const newEvents = JSON.parse(JSON.stringify(this.pendingEvents));
                
                // === 核心：遍历所有事件和 impact，应用世界变更 ===
                newEvents.forEach(evt => {
                    if (!evt.impacts) return;
                    
                    evt.impacts.forEach(imp => {
                        // 默认 impact 类型为 'STAT_CHANGE' 以兼容旧数据
                        const type = imp.type || 'STAT_CHANGE';

                        switch (type) {
                            case 'STAT_CHANGE':
                                // [修改] 增加对全局变量的判断
                                if (imp.targetId === 'global') {
                                    // 在全局变量数组中查找 key
                                    const gVar = this.global_vars.find(g => g.key === imp.attrKey);
                                    if (gVar) {
                                        gVar.value = imp.newValue; // 更新全局变量的值
                                    }
                                } else {
                                    // 原有的逻辑：更新实体属性
                                    const player = this.players.find(p => p.id === imp.targetId);
                                    if (player && imp.newValue !== undefined) { 
                                        player.stats[imp.attrKey] = imp.newValue; 
                                    }
                                }
                                break;
                            
                            case 'REGION_TRANSFER':
                                // 2. 地块控制权转移
                                // imp.targetName = region name, imp.newValue = new owner ID
                                const region = this.map_data.regions.find(r => r.name === imp.targetName);
                                if (region) {
                                    region.ownerId = imp.newValue;
                                } else {
                                    console.warn(`Region Transfer failed: Region '${imp.targetName}' not found.`);
                                }
                                break;

                            case 'ENTITY_CREATE':
                                // 3. 新建实体
                                // imp.data 包含新实体的信息
                                if (imp.data && imp.data.name) {
                                    const newEntity = {
                                        id: 'p' + Date.now() + Math.random().toString(16).slice(2),
                                        name: imp.data.name,
                                        logo: imp.data.logo || 'fa-solid fa-question',
                                        color: imp.data.color || '#cccccc',
                                        desc: imp.data.desc || '',
                                        stats: {}
                                    };
                                    this.rule_sets.forEach(rs => {
                                        rs.fields.forEach(s => {
                                            newEntity.stats[s.key] = (imp.data.stats && imp.data.stats[s.key]) ? imp.data.stats[s.key] : '-';
                                        });
                                    });
                                    this.players.push(newEntity);
                                }
                                break;

                            case 'ENTITY_REMOVE':
                                // 4. 移除实体
                                // imp.targetId = entity ID to remove
                                const index = this.players.findIndex(p => p.id === imp.targetId);
                                if (index !== -1) {
                                    this.players.splice(index, 1);
                                }
                                break;
                            case 'PIN_MOVE':
                                // 5. 移动标记 [新增]
                                // imp.targetId = pin ID, imp.newValue = "x,y"
                                const pinToMove = this.map_data.pins.find(p => p.id === imp.targetId);
                                if (pinToMove && imp.newValue) {
                                    const parts = imp.newValue.split(/[,\s]+/); // 支持逗号或空格分隔
                                    if (parts.length >= 2) {
                                        const nx = parseFloat(parts[0]);
                                        const ny = parseFloat(parts[1]);
                                        if (!isNaN(nx) && !isNaN(ny)) {
                                            pinToMove.x = nx;
                                            pinToMove.y = ny;
                                        }
                                    }
                                }
                                break;
                        }
                    });
                });

                this.timeline.push({ id: maxId + 1, timeRange: range, events: newEvents });
                this.pendingEvents = []; 
                this.pendingTurnRange = ""; 
                this.saveGame('autosave.json');
                this.$nextTick(() => { 
                    const el = document.getElementById('timeline-scroll'); 
                    if(el) el.scrollTop = el.scrollHeight; 
                });
            },
            deleteTurn(tIdx) { if (confirm(`Delete Turn?`)) { this.recordSnapshot(); this.timeline.splice(tIdx, 1); this.saveGame('autosave.json'); } },
            toggleEventOpen(event) { if(!this.editingEventId && !this.editingTurnId) event.isOpen = !event.isOpen; },
            isEditingEvent(t, e) { return this.editingEventId === `${t}-${e}`; },
            
            enableEventEdit(t, e) { 
                this.editingEventId = `${t}-${e}`; 
                this.editingTurnId = null;
                // 重置表单，默认类型为 STAT_CHANGE
                this.editImpactForm = { type: 'STAT_CHANGE', targetId: '', attrKey: '', newValue: '', targetName: '' };
            },
            
            // 新增：向历史事件添加 Impact
            addEventImpact(event) {
                const impact = this.createImpactObject(this.editImpactForm);
                if (impact) {
                    if (!event.impacts) event.impacts = [];
                    event.impacts.push(impact);
                    // 重置表单
                    this.editImpactForm.targetId = '';
                    this.editImpactForm.attrKey = '';
                    this.editImpactForm.newValue = '';
                    this.editImpactForm.targetName = '';
                }
            },
            
            // 新增：从历史事件移除 Impact
            removeEventImpact(event, idx) {
                event.impacts.splice(idx, 1);
            },

            saveTurnEdit() { this.editingTurnId = null; this.saveGame('autosave.json'); },
            saveEventEdit() { this.editingEventId = null; this.saveGame('autosave.json'); },
            deleteEvent(t,e) { if(confirm("Delete Event?")) { this.timeline[t].events.splice(e,1); this.saveGame('autosave.json'); } },
            saveSettings(isSilent = false) { 
                const toSave = { 
                    api: this.settings.api,
                    api_profiles: this.settings.api_profiles,
                    active_profile_id: this.settings.active_profile_id,
                    proxy: this.settings.proxy, 
                    prompts: this.settings.prompts, 
                    ui: this.ui 
                }; 
                localStorage.setItem('levant_settings', JSON.stringify(toSave));
                
                // 如果传入的参数是 true，则是静默保存（不关闭窗口，不弹窗）
                // 按钮点击时传入的是 Event 对象，不等于 true，所以会执行下面的关闭逻辑
                if (isSilent !== true) {
                    this.showSettings = false; 
                    alert("Settings Saved!"); 
                }
            },
            addLoreEntry() { this.lorebook.unshift({ keys: '', content: '', mode: 'auto' }); },
            cycleLoreMode(e) { const m=['on','auto','off']; e.mode = m[(m.indexOf(e.mode)+1)%3]; this.saveGame('autosave.json') },
            addSchemaField() { 
                const l=prompt("Label Name (e.g. 'Health', 'GDP')"); 
                if(l) { 
                    const k=prompt("Key (English, e.g. 'hp', 'gdp')"); 
                    if(k) { 
                        // 添加到当前规则集
                        this.getActiveSchemaFields().push({label:l, key:k}); 
                        // 初始化所有使用该规则集的实体
                        this.players.filter(p => p.schemaId === this.activeSchemaId).forEach(p => { 
                            if(!p.stats[k]) p.stats[k] = '-'; 
                        }); 
                        this.saveGame('autosave.json'); 
                    } 
                } 
            },
            copyToClipboard(t) { navigator.clipboard.writeText(t); },
            openFactionModal(p) { 
                this.previewAvatarIndex = -1; 
                if(p) { 
                    this.editingFaction = JSON.parse(JSON.stringify(p)); 
                    
                    // ★★★ [新增] 编辑已有角色时，确保字段存在 ★★★
                    if (this.editingFaction.isProtagonist === undefined) {
                        this.editingFaction.isProtagonist = false;
                    }
                    // [兼容性] 补全视觉参数
                    if (this.editingFaction.avatarScale === undefined) this.editingFaction.avatarScale = 1.0;
                    if (this.editingFaction.avatarOffsetY === undefined) this.editingFaction.avatarOffsetY = 0.0;
                    // 补全差分列表中的参数
                    if (this.editingFaction.avatars) {
                        this.editingFaction.avatars.forEach(av => {
                            if (av.scale === undefined) av.scale = 1.0;
                            if (av.offsetY === undefined) av.offsetY = 0.0;
                        });
                    }

                    // 确保有 schemaId
                    if(!this.editingFaction.schemaId) this.editingFaction.schemaId = this.rule_sets[0]?.id || 'default';
                } else { 
                    // 新建实体
                    this.editingFaction = {
                        id:'', name:'', 
                        logo: 'fa-solid fa-users', 
                        isProtagonist: false,
                        avatar: '', 
                        avatarScale: 1.0,   // [新增]
                        avatarOffsetY: 0.0, // [新增]
                        avatars: [], 
                        color:'#ffffff', desc:'', 
                        parentId: '', 
                        schemaId: this.activeSchemaId || (this.rule_sets[0]?.id || 'default'), 
                        stats:{}
                    };
                    // 预填空值
                    this.getFieldsBySchemaId(this.editingFaction.schemaId).forEach(s => this.editingFaction.stats[s.key]='-'); 
                } 
                this.showFactionModal = true; 
            },
            closeFactionModal() { this.showFactionModal = false; },
            saveFaction() { if(!this.editingFaction.name) return; this.recordSnapshot(); if(this.editingFaction.id) { const i = this.players.findIndex(p => p.id === this.editingFaction.id); if(i !== -1) this.players[i] = JSON.parse(JSON.stringify(this.editingFaction)); } else { this.editingFaction.id = 'p'+Date.now(); this.players.push(JSON.parse(JSON.stringify(this.editingFaction))); } this.dataVersion++; this.closeFactionModal(); this.saveGame('autosave.json'); },
            deleteFaction() { const i = this.players.findIndex(p => p.id === this.editingFaction.id); if(i !== -1 && confirm("Destroy Entity?")) { this.recordSnapshot(); this.players.splice(i,1); this.closeFactionModal(); this.saveGame('autosave.json'); } },
            openScriptGenModal() { this.scriptGenPrompt = ''; this.scriptAttachments = []; this.showScriptGenModal = true; },
            // [新增] 切换实体类型时，自动补全属性字段
            refreshFactionStats() {
                if (!this.editingFaction.schemaId) return;
                
                // 获取当前规则集的所有字段定义
                const fields = this.getFieldsBySchemaId(this.editingFaction.schemaId);
                
                // 确保 stats 对象存在
                if (!this.editingFaction.stats) this.editingFaction.stats = {};
                
                // 遍历字段，如果当前 stats 里没有这个 key，就初始化为 '-'
                fields.forEach(f => {
                    if (this.editingFaction.stats[f.key] === undefined) {
                        this.editingFaction.stats[f.key] = '-';
                    }
                });
            },
            // --- 查找并替换 methods 中的 generateScript ---

            async generateScript() {
                if (!this.settings.api.key) return alert("API Key missing");
                if (!confirm("确定覆盖当前进度？")) return;
                this.recordSnapshot(); 
                this.isThinking = true;

                // --- 1. [新增] 动态构建高级约束指令 ---
                // 这些指令会强制 AI 覆盖默认行为
                let constraintPrompt = `\n\n【GENERATION CONSTRAINTS (MUST FOLLOW)】\n`;
                
                // A. 数量约束
                constraintPrompt += `1. Structure: You MUST generate exactly ${this.scriptGenConfig.rulesCount} distinct 'rule_sets' and exactly ${this.scriptGenConfig.entitiesCount} distinct 'players'.\n`;
                
                // B. 风格约束
                const style = this.scriptGenConfig.attrStyle;
                if (style === 'number') {
                    constraintPrompt += `2. Attribute Style: All stats in 'rule_sets' MUST be of type 'number'. Values in 'players.stats' MUST be pure integers (e.g., 100, 50).\n`;
                } else if (style === 'letter') {
                    constraintPrompt += `2. Attribute Style: All stats in 'rule_sets' MUST be of type 'string'. Values in 'players.stats' MUST use Letter Grades (e.g., "S", "A+", "B", "C").\n`;
                } else if (style === 'text') {
                    constraintPrompt += `2. Attribute Style: All stats in 'rule_sets' MUST be of type 'string'. Values in 'players.stats' MUST use descriptive text (e.g., "High", "Weak", "Stable", "Chaos").\n`;
                } else {
                    constraintPrompt += `2. Attribute Style: Mix 'number' and 'string' types appropriately based on the attribute nature (e.g., HP is number, Rank is string).\n`;
                }

                // --- 2. 构建 System Prompt ---
                let finalSystemPrompt = this.settings.prompts.script_generator;
                
                // 注入自定义 Prompt (如果开启)
                if (this.scriptGenUseCustom && this.settings.prompts.custom) {
                    finalSystemPrompt = this.settings.prompts.custom + "\n\n" + finalSystemPrompt;
                }
                
                // 注入高级约束 (放在最后以加强权重)
                finalSystemPrompt += constraintPrompt;

                // --- 3. 发送请求 (后续代码保持不变) ---
                const payload = { 
                    provider: this.settings.api.provider, 
                    apiKey: this.settings.api.key, 
                    baseUrl: this.settings.api.baseUrl, 
                    model: this.settings.api.model, 
                    useProxy: this.settings.proxy.enabled, 
                    proxyPort: this.settings.proxy.port, 
                    
                    systemPrompt: finalSystemPrompt, // 使用带约束的 Prompt
                    
                    context: `Req: "${this.scriptGenPrompt}"`, 
                    userPrompt: "Generate JSON strictly following the constraints.",
                    attachments: this.scriptAttachments 
                };

                    try {
                        const data = await window.LevantAPI.generateAI(payload);
                        
                        // ★★★ [新增] 标记为成功 ★★★
                        this.updateCurrentProfileStatus('success');
                        
                        // 1. 尝试提取 JSON 字符串
                        const match = data.result.match(/\{[\s\S]*\}/);
                        let jsonStr = match ? match[0] : data.result;
                        
                        let newState;

                        // 2. 尝试解析，如果失败则通过 AI 修复
                        try {
                            // 优先尝试你的智能解析器 (或者直接 JSON.parse)
                            newState = JSON.parse(jsonStr);
                        } catch (parseErr) {
                            console.warn("Initial Parse Failed, invoking AI Repair...", parseErr);
                            // ★★★ 核心修改：调用 AI 修复 ★★★
                            // 如果修复失败，repairJsonWithAi 会抛出异常，跳到外层 catch
                            newState = await this.repairJsonWithAi(jsonStr, parseErr.message);
                            console.log("AI Repair Successful!");
                        }
                    // --- ★★★ 核心后处理逻辑开始 ★★★ ---
                    if (newState.timeline && newState.players) {
                        // 1. 创建一个玩家初始状态的快速查找表 (Map)
                        const playerStatsMap = new Map();
                        newState.players.forEach(p => playerStatsMap.set(p.id, p.stats));

                        // 2. 遍历 timeline 中的所有事件和 impact
                        newState.timeline.forEach(turn => {
                            turn.events?.forEach(event => {
                                event.impacts?.forEach(impact => {
                                    const initialStats = playerStatsMap.get(impact.targetId);
                                    
                                    // 3. 如果找到了对应的玩家和初始状态
                                    if (initialStats) {
                                        // 4. 将初始状态值赋给 oldValue
                                        impact.oldValue = initialStats[impact.attrKey] ?? "?";
                                    } else {
                                        // 如果没找到，则设为 '?'
                                        impact.oldValue = "?";
                                    }

                                    // 5. 确保 newValue 存在，防止 AI 遗漏
                                    if (impact.newValue === undefined) {
                                        impact.newValue = "?";
                                    }
                                });
                            });
                        });
                    }
                    // --- ★★★ 核心后处理逻辑结束 ★★★ ---


                    // (保留之前的 lorebook 容错处理)
                    if (newState.lorebook) {
                        newState.lorebook.forEach(entry => {
                            if (!entry.keys) {
                                entry.keys = entry.title || entry.key || entry.name || "未命名条目";
                            }
                            delete entry.title;
                        });
                    }

                    // (保留之前的 attrLabel 容错处理)
                    if(newState.timeline) {
                        const labelMap = {};
                        // 修正后
                        if(newState.rule_sets) {
                            newState.rule_sets.forEach(rs => {
                                rs.fields.forEach(f => labelMap[f.key] = f.label);
                            });
                        }
                        
                        newState.timeline.forEach(t => {
                            if(t.events) t.events.forEach(e => {
                                if(e.impacts) e.impacts.forEach(i => {
                                    if(!i.attrLabel && labelMap[i.attrKey]) i.attrLabel = labelMap[i.attrKey];
                                });
                            });
                        });
                    }

                    if (!newState.map_data) {
                        newState.map_data = JSON.parse(JSON.stringify(this.map_data));
                    }

                    this.applyState(newState);
                    this.showScriptGenModal = false;
                    this.scriptAttachments = []; 
                    this.scriptGenPrompt = '';
                } catch(e) { 
                    // ★★★ [新增] 标记为失败 ★★★
                    this.updateCurrentProfileStatus('error');
                    alert("Gen Failed: " + e.message); 
                } finally { this.isThinking = false; }
            },

            // --- [新增] 战斗系统相关方法 ---

            // [重写] 启动充满仪式感的投掷
            rollCombatDice() {
                if (this.combatForm.dicePool.length === 0) return;
                
                // 1. 初始化弹窗数据
                // 深拷贝当前的骰子池，并给每个骰子加状态
                this.activeDiceList = this.combatForm.dicePool.map(d => ({
                    ...d,
                    val: null, // 还没出结果
                    isSettled: false // 还没落地
                }));

                this.showDiceModal = true;
                this.isRollingAnimation = true;

                // 2. 播放音效 (如果有的话)
                // const audio = new Audio('sounds/dice_shake.mp3'); audio.play();

                // 3. 摇晃阶段 (持续 1.5 秒)
                // 在这个阶段，我们可以在后台生成最终结果，或者让界面上的数字乱跳
                // 这里我们使用纯 CSS 动画震动，不需要 JS 频繁更新数字，性能更好

                setTimeout(() => {
                    this.settleDice();
                }, 1500); // 摇晃 1.5秒
            },

            // [新增] 骰子落地结算
            settleDice() {
                this.isRollingAnimation = false;
                
                // 1. 生成真实结果
                this.activeDiceList.forEach(d => {
                    const max = parseInt(d.type.substring(1));
                    d.val = Math.floor(Math.random() * max) + 1;
                    d.isSettled = true;
                });

                // 2. 播放落地音效 (如果有)
                // const audio = new Audio('sounds/dice_land.mp3'); audio.play();
            },

            // [新增] 关闭弹窗并回填数据
            closeDiceModal() {
                // 只有当动画结束(落地后)才能关闭
                if (this.isRollingAnimation) return;

                // 将结果回填到右侧栏的表单中
                this.combatForm.dicePool = JSON.parse(JSON.stringify(this.activeDiceList));
                
                this.showDiceModal = false;
            },

            // [新增] 辅助判断大成功
            isCritSuccess(die) {
                if (!die.val) return false;
                const max = parseInt(die.type.substring(1));
                // D20 的 20，D100 的 1-5 (根据规则) 或者 >= 95，这里简单判定最大值
                // 或者比例 > 0.95
                return die.val === max || (die.val / max) >= 0.95;
            },

            // [新增] 辅助判断大失败
            isCritFail(die) {
                if (!die.val) return false;
                // 1 或者 比例 < 0.05
                const max = parseInt(die.type.substring(1));
                return die.val === 1 || (die.val / max) <= 0.05;
            },

            getDiceColorClass(val, type) {
                const max = parseInt(type.substring(1));
                const ratio = val / max;
                if (ratio >= 0.95 || val === max) return 'text-amber-400'; // 大成功
                if (ratio <= 0.05 || val === 1) return 'text-red-500';   // 大失败
                if (ratio >= 0.6) return 'text-emerald-400';             // 成功
                return 'text-[var(--text-dim)]';                         // 普通/失败
            },

            getDiceText(val, type) {
                const max = parseInt(type.substring(1));
                const ratio = val / max;
                if (val === max) return this.t('dice_crit_success');
                if (val === 1) return this.t('dice_crit_fail');
                if (ratio >= 0.5) return this.t('dice_pass');
                return this.t('dice_fail');
            },
            addCombatDie() {
                this.combatForm.dicePool.push({ type: 'd20', val: null, label: '' });
            },
            getDieIcon(type) {
                switch(type) {
                    case 'd6': return 'fa-solid fa-dice-d6';
                    case 'd100': return 'fa-solid fa-dice'; // D100没有专用图标，用一个通用的
                    case 'd20':
                    default: return 'fa-solid fa-dice-d20';
                }
            },

            async executeCombat() {
                if (!this.settings.api.key) return alert("API Key missing");
                
                // 1. 准备数据
                const attacker = this.players.find(p => p.id === this.combatForm.attackerId);
                const defender = this.players.find(p => p.id === this.combatForm.defenderId);
                
                // --- 处理地点 ---
                let locStr = "未知/无特定地点";
                if (this.combatForm.locationId) {
                    const reg = this.map_data.regions.find(r => r.name === this.combatForm.locationId);
                    if (reg) {
                        const owner = this.getFactionName(reg.ownerId);
                        locStr = `[领土] ${reg.name} (控制方: ${owner}, ID: ${reg.ownerId})`;
                    } else {
                        const pin = this.map_data.pins.find(p => (p.label === this.combatForm.locationId || p.id === this.combatForm.locationId));
                        if (pin) locStr = `[标记点/设施] ${pin.label || "未命名点"}`;
                    }
                }

                // --- 处理骰子序列 ---
                let diceAnalysis = this.combatForm.dicePool.map((d, i) => {
                    const max = parseInt(d.type.substring(1));
                    const desc = this.getDiceText(d.val, d.type);
                    const label = d.label ? `[${d.label}]` : `[第 ${i+1} 轮判定]`;
                    return `${i+1}. ${label}: 结果 ${d.val} (骰子 ${d.type}, 满分 ${max}) -> 判定: ${desc}`;
                }).join('\n   ');

                // --- ★ 新增：格式化攻守双方 Stats (带类型标签) ---
                const formatEntityStats = (entity) => {
                    const schema = this.rule_sets.find(rs => rs.id === entity.schemaId);
                    const visibleStats = {};
                    if (schema) {
                        schema.fields.forEach(f => {
                            // 调用通用的格式化函数
                            const valStr = this.formatContextAttr(entity.stats[f.key], f.visibility||'editable', f.type||'string');
                            if (valStr !== null) visibleStats[f.key] = valStr;
                        });
                    } else {
                        for(let k in entity.stats) visibleStats[k] = entity.stats[k];
                    }
                    return JSON.stringify(visibleStats, null, 2);
                };

                const attackerStatsStr = formatEntityStats(attacker);
                const defenderStatsStr = formatEntityStats(defender);

                // --- 3. 组装终极 Prompt (v2 类型增强版) ---
                const systemPrompt = `你是一个严谨的 TRPG 战斗裁判与世界模拟引擎。你的任务是根据输入数据推演战斗结果。

            【核心裁决逻辑】
            1. **属性对抗**：对比攻守双方 Stats。强者通常胜出，但需结合骰子修正。
               - 注意 Stats 中的 <Type:Number> 标签，这些是可量化的数值。
               - 标记为 <ReadOnly> 的属性不可直接修改。
            2. **地点环境 (Location)**：
               - 当前地点为: ${locStr}。
               - 如果地点控制者与某一方一致，该方享有主场优势。
            3. **骰子序列叙事 (Dice Sequence)**：
               - 用户提供了一组骰子结果，这是**绝对客观事实**，必须在战报中体现。
            4. **层级波及**：
               - 如果一方是子实体，受损严重时，须考虑对其父实体造成连带影响。

            【非常重要：JSON 输出格式】
            必须只返回一个 JSON 对象，严格遵守 TimelineEvent 结构。
            **数值修改规则**：impacts 中的 newValue 必须根据上下文中的 <Type> 标签输出正确类型（Number 输出纯数字，String 输出字符串）。

            {
            "summary": "简短且具有冲击力的标题",
            "content": "详细的战报（>150字）。请结合地点环境和骰子结果编写...",
            "impacts": [
                {
                "type": "STAT_CHANGE",
                "targetId": "${attacker.id}",
                "attrKey": "manpower",  
                "oldValue": "...",
                "newValue": 9500 // ★ 纯数字 (如果原属性是 Number)
                },
                {
                "type": "STAT_CHANGE",
                "targetId": "${defender.id}",
                "attrKey": "stability",
                "oldValue": "...",
                "newValue": 60 // ★ 纯数字
                },
                {
                "type": "REGION_TRANSFER",  // 仅在战斗意图是“攻占”且攻击方大胜时生成
                "targetName": "${this.combatForm.locationId}", 
                "newValue": "${attacker.id}"
                }
            ]
            }

            【输入数据】
            [战斗背景]: ${this.combatForm.context || "遭遇战"}
            [战斗地点]: ${locStr}

            [攻击方]: ${attacker.name} (ID: ${attacker.id})
            - Parent: ${attacker.parentId || "None"}
            - Desc: ${attacker.desc}
            - Stats: ${attackerStatsStr}

            [防御方]: ${defender.name} (ID: ${defender.id})
            - Parent: ${defender.parentId || "None"}
            - Desc: ${defender.desc}
            - Stats: ${defenderStatsStr}

            [命运骰子序列]:
            ${diceAnalysis}`;

                this.isThinking = true;

                const payload = {
                    provider: this.settings.api.provider,
                    apiKey: this.settings.api.key,
                    baseUrl: this.settings.api.baseUrl,
                    model: this.settings.api.model,
                    useProxy: this.settings.proxy.enabled,
                    proxyPort: this.settings.proxy.port,
                    systemPrompt: systemPrompt,
                    context: "Combat Simulation",
                    userPrompt: "Generate the JSON result based on the dice sequence and environment."
                };

                try {
                    const data = await window.LevantAPI.generateAI(payload);
                    
                    // ★★★ [新增] 标记为成功 ★★★
                    this.updateCurrentProfileStatus('success');
                    const match = data.result.match(/\{[\s\S]*\}/);
                    if (!match) throw new Error("Invalid JSON returned by AI");
                    
                    const combatEvent = JSON.parse(match[0]);
                    
                    // 自动补全
                    combatEvent.factionId = attacker.id;
                    combatEvent.timeStart = "Combat";
                    combatEvent.timeEnd = "End";
                    
                    // 填入编辑器
                    this.editor.factionId = combatEvent.factionId;
                    this.editor.summary = combatEvent.summary;
                    this.editor.content = combatEvent.content;
                    
                    // 解析 Impacts 确保格式正确
                    this.editor.impacts = [];
                    if (combatEvent.impacts) {
                        combatEvent.impacts.forEach(imp => {
                            if (!imp.oldValue) imp.oldValue = "?";
                            if (!imp.type) imp.type = "STAT_CHANGE";
                            
                            // 自动修复 Label
                            if (imp.type === 'STAT_CHANGE') {
                                imp.attrLabel = this.getSchemaLabel(imp.attrKey);
                                imp.targetName = this.getFactionName(imp.targetId);
                            } else if (imp.type === 'REGION_TRANSFER') {
                                imp.targetName = imp.targetName || "Region";
                                imp.attrLabel = "Control"; 
                            }
                            
                            this.editor.impacts.push(imp);
                        });
                    }
                    
                    this.tabs.right = 'input'; 
                    
                } catch (e) {
                    // ★★★ [新增] 标记为失败 ★★★
                    this.updateCurrentProfileStatus('error');
                    alert("Combat Judge Error: " + e.message);
                } finally {
                    this.isThinking = false;
                }
            },
            async executeGodMode() {
                if (!this.settings.api.key) return alert("API Key missing");
                this.isThinking = true;

                // --- 1. 定义智能清洗函数 (发送前：把图片变短) ---
                const sanitizeForAI = (obj) => {
                    if (!obj) return obj;
                    if (Array.isArray(obj)) return obj.map(sanitizeForAI);
                    if (typeof obj === 'object') {
                        const clone = {};
                        for (const key in obj) {
                            const val = obj[key];
                            // 判定：如果是图片Base64或超长文本，替换为占位符
                            if (typeof val === 'string' && (this.isImage(val) || val.length > 500)) {
                                clone[key] = "<KEEP_ORIGINAL_DATA>"; 
                            } else {
                                clone[key] = sanitizeForAI(val);
                            }
                        }
                        return clone;
                    }
                    return obj;
                };

                // --- 2. 准备上下文 (应用清洗) ---
                // 聚合地图数据以便 AI 理解
                let allRegions = [];
                let allPins = [];
                if (this.map_data.layers && this.map_data.layers.length > 0) {
                    this.map_data.layers.forEach(layer => {
                        if (Array.isArray(layer.data)) {
                            if (layer.type === 'region') allRegions = allRegions.concat(layer.data);
                            if (layer.type === 'marker') allPins = allPins.concat(layer.data);
                        }
                    });
                } else {
                    allRegions = this.map_data.regions || [];
                    allPins = this.map_data.pins || [];
                }

                const rawSlice = {
                    rule_sets: this.rule_sets,
                    global_vars: this.global_vars,
                    players: this.players,
                    map_data: { regions: allRegions, pins: allPins }
                };
                
                // 执行清洗
                const safeContextSlice = sanitizeForAI(rawSlice);

                // --- 3. 构造 Prompt (关键：告诉 AI 只返回修改的部分) ---
                const payload = {
                    provider: this.settings.api.provider,
                    apiKey: this.settings.api.key,
                    baseUrl: this.settings.api.baseUrl,
                    model: this.settings.api.model,
                    useProxy: this.settings.proxy.enabled,
                    proxyPort: this.settings.proxy.port,
                    
                    // 我们动态注入一段系统指令，强制 AI 采用增量返回模式
                    systemPrompt: this.settings.prompts.god_mode + 
                        "\n\n【IMPORTANT OUTPUT RULE】\n" +
                        "1. You act like a 'Git Merge' tool. \n" +
                        "2. Return ONLY the objects that you modified or added. \n" +
                        "3. Do NOT return the full list if you didn't change everything. \n" +
                        "4. I will merge your output into the existing state by ID. Omitted items will be kept as is.",
                    
                    context: JSON.stringify(safeContextSlice),
                    userPrompt: `INSTRUCTION: ${this.godModeInput}`
                };

                try {
                    const data = await window.LevantAPI.generateAI(payload);

                    // 解析 JSON
                    const match = data.result.match(/\{[\s\S]*\}/);
                    let jsonStr = match ? match[0] : data.result;
                    let changes;
                    try {
                        if (!match) throw new Error("Invalid JSON returned by AI");
                        changes = JSON.parse(jsonStr);
                    } catch (parseErr) {
                        console.warn("[GodMode] Parse failed, invoking AI Repair...", parseErr);
                        changes = await this.repairJsonWithAi(jsonStr, parseErr.message);
                    }

                    this.recordSnapshot(); // 记录撤销点

                    // --- 4. Git 风格智能合并逻辑 (Deep Merge & Restore) ---

                    // 辅助函数：合并单个实体对象
                    // target: 原始对象 (引用), source: AI返回的对象
                    const mergeEntity = (target, source) => {
                        for (const key in source) {
                            const val = source[key];
                            
                            // A. 图片保护逻辑：如果 AI 返回了占位符或空，不要覆盖原始图片
                            if (['logo', 'avatar', 'maskData'].includes(key) || (key === 'avatars')) {
                                if (val === "<KEEP_ORIGINAL_DATA>" || !val) {
                                    continue; // 跳过赋值，保留原样
                                }
                                // 特殊处理 avatars 数组内的图片
                                if (key === 'avatars' && Array.isArray(val) && Array.isArray(target.avatars)) {
                                    // 简单的做法：直接采用 AI 的结构，但把图片 URL 还原回去
                                    target.avatars = val.map(vItem => {
                                        const oldItem = target.avatars.find(old => old.id === vItem.id);
                                        if (oldItem && (vItem.url === "<KEEP_ORIGINAL_DATA>" || !vItem.url)) {
                                            vItem.url = oldItem.url;
                                        }
                                        return vItem;
                                    });
                                    continue;
                                }
                            }

                            // B. Stats 属性合并 (深度合并)
                            if (key === 'stats' && typeof val === 'object' && target.stats) {
                                // 混合新旧属性：旧的保留，新的覆盖
                                target.stats = { ...target.stats, ...val };
                                continue;
                            }

                            // C. 普通属性直接覆盖
                            target[key] = val;
                        }
                    };

                    // === A. 处理 Players (实体) ===
                    if (changes.players && Array.isArray(changes.players)) {
                        changes.players.forEach(aiPlayer => {
                            // 1. 尝试按 ID 查找现有实体
                            const existingPlayer = this.players.find(p => p.id === aiPlayer.id);
                            
                            if (existingPlayer) {
                                // [MODIFIED] 找到了 -> 执行合并 (Modify)
                                console.log(`[GodMode] Merging Player: ${existingPlayer.name}`);
                                mergeEntity(existingPlayer, aiPlayer);
                            } else {
                                // [NEW] 没找到 -> 视为新增 (Add)
                                // 新增时要注意，如果 AI 返回了占位符图片(理论上不应该，因为是新造的)，给个默认值
                                if (aiPlayer.logo === "<KEEP_ORIGINAL_DATA>") aiPlayer.logo = "fa-solid fa-user";
                                console.log(`[GodMode] Adding New Player: ${aiPlayer.name}`);
                                this.players.push(aiPlayer);
                            }
                        });
                        // [KEEP] 没在 changes.players 里的实体，自动保留，不做任何操作
                    }

                    // === B. 处理 Map Regions (地块) ===
                    if (changes.map_data && Array.isArray(changes.map_data.regions)) {
                        // 地块分散在图层里，需要全局搜索
                        changes.map_data.regions.forEach(aiReg => {
                            let found = false;
                            // 遍历所有图层寻找 ID 匹配的地块
                            for (const layer of this.map_data.layers) {
                                if (layer.type === 'region' && Array.isArray(layer.data)) {
                                    const existingReg = layer.data.find(r => r.id === aiReg.id);
                                    if (existingReg) {
                                        // [MODIFIED] 找到了 -> 合并
                                        console.log(`[GodMode] Merging Region: ${existingReg.name}`);
                                        mergeEntity(existingReg, aiReg);
                                        found = true;
                                        break; 
                                    }
                                }
                            }
                            if (!found) {
                                // [NEW] 没找到 -> 这里稍微复杂，因为不知道加到哪个图层
                                // 策略：加到第一个 Region 图层，或者新建一个
                                console.log(`[GodMode] Adding New Region: ${aiReg.name}`);
                                let targetLayer = this.map_data.layers.find(l => l.type === 'region');
                                if (!targetLayer) {
                                    this.addLayer('region');
                                    targetLayer = this.map_data.layers[this.map_data.layers.length - 1];
                                }
                                // 确保必要的几何数据存在，否则给默认值
                                if(!aiReg.x) { aiReg.x=50; aiReg.y=50; aiReg.w=10; aiReg.h=10; }
                                targetLayer.data.push(aiReg);
                            }
                        });
                    }

                    // === C. 处理规则集 (Rule Sets) ===
                    if (changes.rule_sets && Array.isArray(changes.rule_sets)) {
                        changes.rule_sets.forEach(aiRs => {
                            const existingRs = this.rule_sets.find(r => r.id === aiRs.id);
                            if (existingRs) {
                                // 规则集通常包含 fields 数组，这里建议直接替换 fields 列表，或者做更深度的合并
                                // 为了简单且安全，属性名(name)覆盖，字段列表(fields)如果 AI 给了就覆盖
                                existingRs.name = aiRs.name || existingRs.name;
                                if (aiRs.fields) {
                                    // 这里可以选择合并字段，但通常规则定义是整体性的，覆盖可能更符合意图
                                    // 但为了保险，我们可以合并:
                                    aiRs.fields.forEach(newF => {
                                        const oldF = existingRs.fields.find(f => f.key === newF.key);
                                        if (oldF) Object.assign(oldF, newF);
                                        else existingRs.fields.push(newF);
                                    });
                                }
                            } else {
                                this.rule_sets.push(aiRs);
                            }
                        });
                    }

                    // === D. 全局变量 (Global Vars) ===
                    // 全局变量是个数组，且没有唯一ID (key即ID)，处理类似
                    if (changes.global_vars && Array.isArray(changes.global_vars)) {
                        changes.global_vars.forEach(aiG => {
                            const existingG = this.global_vars.find(g => g.key === aiG.key);
                            if (existingG) {
                                Object.assign(existingG, aiG); // 合并值、类型等
                            } else {
                                this.global_vars.push(aiG);
                            }
                        });
                    }
                    // ★★★ [新增] 标记为成功 ★★★
                    this.updateCurrentProfileStatus('success');

                    this.godModeInput = '';
                    this.saveGame('autosave.json');
                    alert("World Reality Rewritten (Merge Success).");

                } catch(e) {
                    // ★★★ [新增] 标记为失败 ★★★
                    this.updateCurrentProfileStatus('error');
                    console.error(e);
                    alert("God Mode Failed: " + e.message);
                } finally {
                    this.isThinking = false;
                }
            },
        }
    }).mount('#app');
</script>
</body>
</html>